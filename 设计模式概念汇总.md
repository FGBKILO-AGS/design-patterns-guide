# 设计模式完整概念汇总

## 第一部分：基础理论概念

### 1. 设计模式基本概念

#### 1.1 核心定义

##### 设计模式 (Design Pattern)
- **GoF原定义**：*"设计模式是在特定环境下人们解决某类重复出现问题的一套成功或有效的解决方案。"*
- **扩展定义**：在特定环境下，为解决某一通用软件设计问题提供的一套定制的解决方案
- **本质**：可复用的面向对象软件设计经验

#### 基础例子：日常生活中的模式
```
建筑设计模式：
- 问题：如何设计一个既美观又实用的房屋入口？
- 解决方案：门廊模式 - 在主入口前设置一个有顶棚的过渡空间
- 效果：提供遮风挡雨的缓冲区，增加建筑美感

软件设计模式：
- 问题：如何确保一个类只有一个实例？
- 解决方案：单例模式 - 控制类的实例化过程
- 效果：节省内存，保证全局唯一性
```

#### 进阶例子：企业级应用中的模式思维
```java
// 传统方式 - 没有模式思维
public class OrderProcessor {
    public void processOrder(Order order) {
        // 验证订单
        if (order.getItems().isEmpty()) {
            throw new IllegalArgumentException("订单不能为空");
        }
        
        // 计算价格
        double total = 0;
        for (OrderItem item : order.getItems()) {
            total += item.getPrice() * item.getQuantity();
        }
        
        // 发送邮件
        EmailService emailService = new EmailService();
        emailService.sendOrderConfirmation(order.getCustomerEmail(), order);
        
        // 更新库存
        InventoryService inventoryService = new InventoryService();
        inventoryService.updateStock(order.getItems());
        
        // 记录日志
        System.out.println("订单处理完成: " + order.getId());
    }
}

// 使用模式思维重构
public class OrderProcessor {
    private List<OrderValidator> validators;
    private PricingStrategy pricingStrategy;
    private List<OrderEventListener> eventListeners;
    
    public OrderProcessor() {
        // 责任链模式 - 验证器链
        this.validators = Arrays.asList(
            new EmptyOrderValidator(),
            new CustomerValidator(),
            new InventoryValidator()
        );
        
        // 策略模式 - 定价策略
        this.pricingStrategy = new StandardPricingStrategy();
        
        // 观察者模式 - 事件监听器
        this.eventListeners = Arrays.asList(
            new EmailNotificationListener(),
            new InventoryUpdateListener(),
            new LoggingListener()
        );
    }
    
    public void processOrder(Order order) {
        // 使用责任链验证
        for (OrderValidator validator : validators) {
            validator.validate(order);
        }
        
        // 使用策略计算价格
        double total = pricingStrategy.calculateTotal(order);
        order.setTotal(total);
        
        // 使用观察者通知各个服务
        OrderProcessedEvent event = new OrderProcessedEvent(order);
        eventListeners.forEach(listener -> listener.onOrderProcessed(event));
    }
}
```

##### 模式语言 (Pattern Language)
- **Alexander原定义**：*"每个模式描述了一个在我们周围不断重复发生的问题，以及该问题的解决方案的核心。"*
- **软件领域定义**：描述设计问题、解决方案和效果的标准化语言
- **作用**：为设计者提供共同的词汇和交流方式

##### 可复用性 (Reusability)
- **定义**：模式可以在不同的软件系统中重复使用
- **层次**：设计复用比代码复用更高层次
- **价值**：避免重新发明轮子，提高开发效率

##### 最佳实践 (Best Practice)
- **定义**：经过验证的、优秀的设计经验总结
- **特征**：经过时间检验，被广泛认可和应用
- **来源**：专家经验的结晶和总结

#### 1.2 模式要素
- **模式名称**：简洁描述设计问题、解决方案和效果的词汇
- **问题**：描述何时使用该模式，包括设计问题和问题的前因后果
- **解决方案**：描述设计的组成成分、关系、职责和协作方式
- **效果**：使用模式的结果和权衡，包括对灵活性、扩展性的影响

#### 1.3 模式分类
- **创建型模式**：处理对象创建机制，将对象的创建和使用分离
- **结构型模式**：处理对象和类的组合，形成更大的结构
- **行为型模式**：处理对象间的通信和职责分配

### 2. UML建模概念

#### 2.1 类图概念
- **类**：具有相同属性和方法的对象集合的抽象
- **属性**：类的数据成员，描述对象的状态
- **方法**：类的函数成员，描述对象的行为
- **访问修饰符**：控制类成员的可见性（public、private、protected、package）
- **静态成员**：属于类而不是实例的成员
- **抽象类**：不能实例化的类，通常包含抽象方法
- **接口**：定义类必须实现的方法契约

#### 2.2 类间关系概念
- **继承/泛化**：子类继承父类的属性和方法，is-a关系
- **实现**：类实现接口定义的方法契约
- **依赖**：一个类使用另一个类，临时性的uses-a关系
- **关联**：类之间的结构化关系，长期性的has-a关系
- **聚合**：整体-部分关系，部分可以独立于整体存在
- **组合**：强整体-部分关系，部分不能独立于整体存在
- **多重性**：关系中对象的数量约束

#### 2.3 动态图概念
- **时序图**：按时间顺序显示对象间的交互
- **协作图**：强调对象间的组织结构和消息传递
- **状态图**：描述对象在生命周期内的状态变化
- **活动图**：描述系统的工作流程和业务过程

### 3. 面向对象设计原则概念

#### 3.1 SOLID原则
- **单一职责原则(SRP)**：一个类应该只有一个引起变化的原因
- **开放-封闭原则(OCP)**：对扩展开放，对修改封闭
- **里氏替换原则(LSP)**：子类对象应该能够替换父类对象
- **接口隔离原则(ISP)**：客户端不应该依赖不需要的接口
- **依赖倒置原则(DIP)**：依赖于抽象，而不是具体实现

#### 3.2 其他重要原则
- **迪米特法则(LoD)**：一个对象应该对其他对象有最少的了解
- **合成/聚合复用原则(CARP)**：优先使用组合而不是继承来实现复用

## 第二部分：创建型模式概念

### 1. 单例模式 (Singleton)

#### 核心概念
- **单例**：确保一个类只有一个实例，并提供全局访问点
- **实例控制**：控制类的实例化过程
- **全局访问**：提供访问唯一实例的全局方法
- **延迟初始化**：在需要时才创建实例

#### 基础例子：简单的配置管理器
```java
// 饿汉式单例 - 最简单的实现
public class ConfigManager {
    // 类加载时就创建实例
    private static final ConfigManager INSTANCE = new ConfigManager();
    private Properties config;
    
    // 私有构造函数，防止外部实例化
    private ConfigManager() {
        config = new Properties();
        loadConfig();
    }
    
    // 提供全局访问点
    public static ConfigManager getInstance() {
        return INSTANCE;
    }
    
    private void loadConfig() {
        // 加载配置文件
        config.setProperty("database.url", "jdbc:mysql://localhost:3306/mydb");
        config.setProperty("database.username", "root");
        config.setProperty("cache.size", "1000");
    }
    
    public String getProperty(String key) {
        return config.getProperty(key);
    }
    
    public void setProperty(String key, String value) {
        config.setProperty(key, value);
    }
}

// 使用示例
public class Application {
    public static void main(String[] args) {
        // 获取配置管理器实例
        ConfigManager config1 = ConfigManager.getInstance();
        ConfigManager config2 = ConfigManager.getInstance();
        
        // 验证是同一个实例
        System.out.println("是否为同一实例: " + (config1 == config2)); // true
        
        // 使用配置
        String dbUrl = config1.getProperty("database.url");
        System.out.println("数据库URL: " + dbUrl);
        
        // 修改配置
        config1.setProperty("app.name", "MyApplication");
        String appName = config2.getProperty("app.name");
        System.out.println("应用名称: " + appName); // MyApplication
    }
}
```

#### 进阶例子：线程安全的数据库连接池
```java
import java.sql.*;
import java.util.concurrent.BlockingQueue;
import java.util.concurrent.LinkedBlockingQueue;
import java.util.concurrent.atomic.AtomicInteger;

// 双重检查锁定的懒汉式单例
public class DatabaseConnectionPool {
    // 使用volatile确保多线程环境下的可见性
    private static volatile DatabaseConnectionPool instance;
    
    private final BlockingQueue<Connection> connectionPool;
    private final AtomicInteger currentConnections;
    private final int maxConnections;
    private final String jdbcUrl;
    private final String username;
    private final String password;
    
    // 私有构造函数
    private DatabaseConnectionPool() {
        this.maxConnections = 10;
        this.currentConnections = new AtomicInteger(0);
        this.connectionPool = new LinkedBlockingQueue<>(maxConnections);
        this.jdbcUrl = "jdbc:mysql://localhost:3306/mydb";
        this.username = "root";
        this.password = "password";
        
        // 初始化连接池
        initializePool();
    }
    
    // 双重检查锁定获取实例
    public static DatabaseConnectionPool getInstance() {
        if (instance == null) {
            synchronized (DatabaseConnectionPool.class) {
                if (instance == null) {
                    instance = new DatabaseConnectionPool();
                }
            }
        }
        return instance;
    }
    
    private void initializePool() {
        try {
            // 预创建一些连接
            for (int i = 0; i < 3; i++) {
                Connection conn = createConnection();
                if (conn != null) {
                    connectionPool.offer(conn);
                    currentConnections.incrementAndGet();
                }
            }
        } catch (SQLException e) {
            System.err.println("初始化连接池失败: " + e.getMessage());
        }
    }
    
    private Connection createConnection() throws SQLException {
        return DriverManager.getConnection(jdbcUrl, username, password);
    }
    
    // 获取连接
    public Connection getConnection() throws SQLException, InterruptedException {
        Connection conn = connectionPool.poll();
        
        if (conn == null && currentConnections.get() < maxConnections) {
            // 如果池中没有连接且未达到最大连接数，创建新连接
            synchronized (this) {
                if (currentConnections.get() < maxConnections) {
                    conn = createConnection();
                    currentConnections.incrementAndGet();
                }
            }
        }
        
        if (conn == null) {
            // 等待可用连接
            conn = connectionPool.take();
        }
        
        return conn;
    }
    
    // 归还连接
    public void returnConnection(Connection conn) {
        if (conn != null) {
            try {
                if (!conn.isClosed()) {
                    connectionPool.offer(conn);
                } else {
                    currentConnections.decrementAndGet();
                }
            } catch (SQLException e) {
                System.err.println("检查连接状态失败: " + e.getMessage());
                currentConnections.decrementAndGet();
            }
        }
    }
    
    // 关闭连接池
    public void shutdown() {
        while (!connectionPool.isEmpty()) {
            try {
                Connection conn = connectionPool.poll();
                if (conn != null && !conn.isClosed()) {
                    conn.close();
                }
            } catch (SQLException e) {
                System.err.println("关闭连接失败: " + e.getMessage());
            }
        }
        currentConnections.set(0);
    }
    
    // 获取连接池状态
    public String getPoolStatus() {
        return String.format("连接池状态 - 当前连接数: %d, 可用连接数: %d, 最大连接数: %d",
                currentConnections.get(), connectionPool.size(), maxConnections);
    }
    
    // 防止序列化破坏单例
    private Object readResolve() {
        return getInstance();
    }
}

// 静态内部类实现（推荐方式）
public class LogManager {
    // 静态内部类，只有在被引用时才会加载
    private static class LogManagerHolder {
        private static final LogManager INSTANCE = new LogManager();
    }
    
    private final String logLevel;
    private final String logFormat;
    
    private LogManager() {
        this.logLevel = "INFO";
        this.logFormat = "[%s] %s - %s";
    }
    
    public static LogManager getInstance() {
        return LogManagerHolder.INSTANCE;
    }
    
    public void log(String level, String message) {
        String timestamp = java.time.LocalDateTime.now().toString();
        String formattedMessage = String.format(logFormat, timestamp, level, message);
        System.out.println(formattedMessage);
    }
    
    public void info(String message) {
        log("INFO", message);
    }
    
    public void error(String message) {
        log("ERROR", message);
    }
    
    public void debug(String message) {
        if ("DEBUG".equals(logLevel)) {
            log("DEBUG", message);
        }
    }
}

// 枚举实现（最安全的方式）
public enum CacheManager {
    INSTANCE;
    
    private final Map<String, Object> cache;
    
    CacheManager() {
        this.cache = new ConcurrentHashMap<>();
    }
    
    public void put(String key, Object value) {
        cache.put(key, value);
    }
    
    public Object get(String key) {
        return cache.get(key);
    }
    
    public void remove(String key) {
        cache.remove(key);
    }
    
    public void clear() {
        cache.clear();
    }
    
    public int size() {
        return cache.size();
    }
}

// 多线程测试示例
public class SingletonTest {
    public static void main(String[] args) throws InterruptedException {
        // 测试数据库连接池单例
        testDatabaseConnectionPool();
        
        // 测试日志管理器单例
        testLogManager();
        
        // 测试缓存管理器单例
        testCacheManager();
    }
    
    private static void testDatabaseConnectionPool() throws InterruptedException {
        System.out.println("=== 测试数据库连接池单例 ===");
        
        // 创建多个线程同时获取实例
        Thread[] threads = new Thread[5];
        DatabaseConnectionPool[] instances = new DatabaseConnectionPool[5];
        
        for (int i = 0; i < 5; i++) {
            final int index = i;
            threads[i] = new Thread(() -> {
                instances[index] = DatabaseConnectionPool.getInstance();
                System.out.println("线程 " + index + " 获取实例: " + instances[index].hashCode());
            });
        }
        
        // 启动所有线程
        for (Thread thread : threads) {
            thread.start();
        }
        
        // 等待所有线程完成
        for (Thread thread : threads) {
            thread.join();
        }
        
        // 验证所有实例是否相同
        boolean allSame = true;
        for (int i = 1; i < instances.length; i++) {
            if (instances[i] != instances[0]) {
                allSame = false;
                break;
            }
        }
        
        System.out.println("所有实例是否相同: " + allSame);
        System.out.println(instances[0].getPoolStatus());
        System.out.println();
    }
    
    private static void testLogManager() {
        System.out.println("=== 测试日志管理器单例 ===");
        
        LogManager logger1 = LogManager.getInstance();
        LogManager logger2 = LogManager.getInstance();
        
        System.out.println("是否为同一实例: " + (logger1 == logger2));
        
        logger1.info("这是一条信息日志");
        logger2.error("这是一条错误日志");
        logger1.debug("这是一条调试日志");
        System.out.println();
    }
    
    private static void testCacheManager() {
        System.out.println("=== 测试缓存管理器单例 ===");
        
        CacheManager cache1 = CacheManager.INSTANCE;
        CacheManager cache2 = CacheManager.INSTANCE;
        
        System.out.println("是否为同一实例: " + (cache1 == cache2));
        
        cache1.put("user:1", "张三");
        cache1.put("user:2", "李四");
        
        System.out.println("缓存大小: " + cache2.size());
        System.out.println("用户1: " + cache2.get("user:1"));
        System.out.println("用户2: " + cache2.get("user:2"));
        System.out.println();
    }
}
```

#### 实现概念
- **饿汉式**：类加载时就创建实例
- **懒汉式**：第一次使用时才创建实例
- **双重检查锁定**：线程安全的懒汉式实现
- **静态内部类**：利用类加载机制保证线程安全
- **枚举实现**：最简洁的单例实现方式

#### 相关概念
- **线程安全**：多线程环境下的正确性
- **序列化安全**：序列化后不破坏单例特性
- **反射安全**：防止通过反射创建多个实例

### 2. 工厂方法模式 (Factory Method)

#### 核心概念
- **工厂方法**：定义创建对象的接口，让子类决定实例化哪个类
- **产品**：工厂创建的对象
- **创建者**：包含工厂方法的类
- **延迟实例化**：将对象创建延迟到子类

#### 基础例子：图形绘制工厂
```java
// 产品接口
interface Shape {
    void draw();
}

// 具体产品
class Circle implements Shape {
    @Override
    public void draw() {
        System.out.println("绘制圆形");
    }
}

class Rectangle implements Shape {
    @Override
    public void draw() {
        System.out.println("绘制矩形");
    }
}

// 抽象工厂
abstract class ShapeFactory {
    // 工厂方法
    public abstract Shape createShape();
    
    // 模板方法
    public void drawShape() {
        Shape shape = createShape();
        shape.draw();
    }
}

// 具体工厂
class CircleFactory extends ShapeFactory {
    @Override
    public Shape createShape() {
        return new Circle();
    }
}

class RectangleFactory extends ShapeFactory {
    @Override
    public Shape createShape() {
        return new Rectangle();
    }
}

// 使用示例
public class FactoryMethodExample {
    public static void main(String[] args) {
        ShapeFactory circleFactory = new CircleFactory();
        circleFactory.drawShape(); // 输出: 绘制圆形
        
        ShapeFactory rectangleFactory = new RectangleFactory();
        rectangleFactory.drawShape(); // 输出: 绘制矩形
    }
}
```

#### 进阶例子：数据库连接工厂系统
```java
// 数据库连接接口
interface DatabaseConnection {
    void connect();
    void executeQuery(String sql);
    void close();
    String getConnectionInfo();
}

// MySQL连接实现
class MySQLConnection implements DatabaseConnection {
    private String host;
    private int port;
    private String database;
    
    public MySQLConnection(String host, int port, String database) {
        this.host = host;
        this.port = port;
        this.database = database;
    }
    
    @Override
    public void connect() {
        System.out.println("连接到MySQL数据库: " + getConnectionInfo());
    }
    
    @Override
    public void executeQuery(String sql) {
        System.out.println("在MySQL中执行查询: " + sql);
    }
    
    @Override
    public void close() {
        System.out.println("关闭MySQL连接");
    }
    
    @Override
    public String getConnectionInfo() {
        return String.format("mysql://%s:%d/%s", host, port, database);
    }
}

// PostgreSQL连接实现
class PostgreSQLConnection implements DatabaseConnection {
    private String host;
    private int port;
    private String database;
    
    public PostgreSQLConnection(String host, int port, String database) {
        this.host = host;
        this.port = port;
        this.database = database;
    }
    
    @Override
    public void connect() {
        System.out.println("连接到PostgreSQL数据库: " + getConnectionInfo());
    }
    
    @Override
    public void executeQuery(String sql) {
        System.out.println("在PostgreSQL中执行查询: " + sql);
    }
    
    @Override
    public void close() {
        System.out.println("关闭PostgreSQL连接");
    }
    
    @Override
    public String getConnectionInfo() {
        return String.format("postgresql://%s:%d/%s", host, port, database);
    }
}

// 抽象数据库工厂
abstract class DatabaseFactory {
    // 工厂方法 - 由子类实现
    public abstract DatabaseConnection createConnection();
    
    // 模板方法 - 定义标准的数据库操作流程
    public void performDatabaseOperation(String sql) {
        DatabaseConnection connection = null;
        try {
            connection = createConnection();
            connection.connect();
            connection.executeQuery(sql);
        } catch (Exception e) {
            System.err.println("数据库操作失败: " + e.getMessage());
        } finally {
            if (connection != null) {
                connection.close();
            }
        }
    }
    
    // 批量操作
    public void performBatchOperations(String[] sqlStatements) {
        DatabaseConnection connection = null;
        try {
            connection = createConnection();
            connection.connect();
            System.out.println("开始批量操作...");
            for (String sql : sqlStatements) {
                connection.executeQuery(sql);
            }
            System.out.println("批量操作完成");
        } catch (Exception e) {
            System.err.println("批量操作失败: " + e.getMessage());
        } finally {
            if (connection != null) {
                connection.close();
            }
        }
    }
}

// MySQL工厂
class MySQLFactory extends DatabaseFactory {
    private String host;
    private int port;
    private String database;
    
    public MySQLFactory(String host, int port, String database) {
        this.host = host;
        this.port = port;
        this.database = database;
    }
    
    @Override
    public DatabaseConnection createConnection() {
        return new MySQLConnection(host, port, database);
    }
}

// PostgreSQL工厂
class PostgreSQLFactory extends DatabaseFactory {
    private String host;
    private int port;
    private String database;
    
    public PostgreSQLFactory(String host, int port, String database) {
        this.host = host;
        this.port = port;
        this.database = database;
    }
    
    @Override
    public DatabaseConnection createConnection() {
        return new PostgreSQLConnection(host, port, database);
    }
}

// 数据库工厂管理器
class DatabaseFactoryManager {
    private static final Map<String, DatabaseFactory> factories = new HashMap<>();
    
    public static void registerFactory(String type, DatabaseFactory factory) {
        factories.put(type.toLowerCase(), factory);
    }
    
    public static DatabaseFactory getFactory(String type) {
        DatabaseFactory factory = factories.get(type.toLowerCase());
        if (factory == null) {
            throw new IllegalArgumentException("不支持的数据库类型: " + type);
        }
        return factory;
    }
    
    public static Set<String> getSupportedTypes() {
        return factories.keySet();
    }
}

// 使用示例
public class DatabaseFactoryExample {
    public static void main(String[] args) {
        // 注册工厂
        DatabaseFactoryManager.registerFactory("mysql", 
            new MySQLFactory("localhost", 3306, "testdb"));
        DatabaseFactoryManager.registerFactory("postgresql", 
            new PostgreSQLFactory("localhost", 5432, "testdb"));
        
        // 使用MySQL
        DatabaseFactory mysqlFactory = DatabaseFactoryManager.getFactory("mysql");
        mysqlFactory.performDatabaseOperation("SELECT * FROM users");
        
        // 使用PostgreSQL
        DatabaseFactory postgresFactory = DatabaseFactoryManager.getFactory("postgresql");
        String[] batchSql = {
            "INSERT INTO users (name, email) VALUES ('张三', 'zhangsan@example.com')",
            "INSERT INTO users (name, email) VALUES ('李四', 'lisi@example.com')",
            "UPDATE users SET status = 'active' WHERE id > 0"
        };
        postgresFactory.performBatchOperations(batchSql);
        
        // 显示支持的数据库类型
        System.out.println("支持的数据库类型: " + 
            DatabaseFactoryManager.getSupportedTypes());
    }
}
```

**工厂方法模式的关键特点：**
1. **延迟决策**: 将对象创建的决策推迟到子类
2. **符合开放-封闭原则**: 新增产品类型只需添加新的工厂类
3. **消除耦合**: 客户端代码不依赖具体的产品类
4. **模板方法结合**: 工厂类可以定义创建对象后的标准操作流程

#### 参与者概念
- **抽象产品**：定义产品的接口
- **具体产品**：实现产品接口的具体类
- **抽象创建者**：声明工厂方法的抽象类
- **具体创建者**：实现工厂方法的具体类

#### 相关概念
- **简单工厂**：用一个类来创建所有产品
- **参数化工厂**：根据参数决定创建哪种产品
- **泛型工厂**：使用泛型的工厂实现

### 3. 抽象工厂模式 (Abstract Factory)

#### 核心概念
- **抽象工厂**：提供创建一系列相关对象的接口
- **产品族**：一组相关的产品对象
- **产品等级结构**：产品的继承层次
- **产品一致性**：确保创建的产品属于同一族

#### 基础例子：GUI组件工厂
```java
// 抽象产品 - 按钮
interface Button {
    void paint();
    void click();
}

// 抽象产品 - 文本框
interface TextField {
    void paint();
    void setText(String text);
    String getText();
}

// Windows风格的具体产品
class WindowsButton implements Button {
    @Override
    public void paint() {
        System.out.println("绘制Windows风格按钮");
    }
    
    @Override
    public void click() {
        System.out.println("Windows按钮被点击");
    }
}

class WindowsTextField implements TextField {
    private String text = "";
    
    @Override
    public void paint() {
        System.out.println("绘制Windows风格文本框");
    }
    
    @Override
    public void setText(String text) {
        this.text = text;
        System.out.println("Windows文本框设置文本: " + text);
    }
    
    @Override
    public String getText() {
        return text;
    }
}

// Mac风格的具体产品
class MacButton implements Button {
    @Override
    public void paint() {
        System.out.println("绘制Mac风格按钮");
    }
    
    @Override
    public void click() {
        System.out.println("Mac按钮被点击");
    }
}

class MacTextField implements TextField {
    private String text = "";
    
    @Override
    public void paint() {
        System.out.println("绘制Mac风格文本框");
    }
    
    @Override
    public void setText(String text) {
        this.text = text;
        System.out.println("Mac文本框设置文本: " + text);
    }
    
    @Override
    public String getText() {
        return text;
    }
}

// 抽象工厂
interface GUIFactory {
    Button createButton();
    TextField createTextField();
}

// 具体工厂
class WindowsFactory implements GUIFactory {
    @Override
    public Button createButton() {
        return new WindowsButton();
    }
    
    @Override
    public TextField createTextField() {
        return new WindowsTextField();
    }
}

class MacFactory implements GUIFactory {
    @Override
    public Button createButton() {
        return new MacButton();
    }
    
    @Override
    public TextField createTextField() {
        return new MacTextField();
    }
}

// 客户端代码
class Application {
    private Button button;
    private TextField textField;
    
    public Application(GUIFactory factory) {
        button = factory.createButton();
        textField = factory.createTextField();
    }
    
    public void paint() {
        button.paint();
        textField.paint();
    }
    
    public void interact() {
        textField.setText("Hello World");
        button.click();
        System.out.println("文本框内容: " + textField.getText());
    }
}

// 使用示例
public class AbstractFactoryExample {
    public static void main(String[] args) {
        // 根据操作系统选择工厂
        String osName = System.getProperty("os.name").toLowerCase();
        GUIFactory factory;
        
        if (osName.contains("windows")) {
            factory = new WindowsFactory();
            System.out.println("使用Windows风格界面");
        } else {
            factory = new MacFactory();
            System.out.println("使用Mac风格界面");
        }
        
        Application app = new Application(factory);
        app.paint();
        app.interact();
    }
}
```

#### 进阶例子：跨平台数据库访问工厂
```java
// 抽象产品 - 数据库连接
interface DatabaseConnection {
    void connect();
    void disconnect();
    boolean isConnected();
}

// 抽象产品 - 查询执行器
interface QueryExecutor {
    ResultSet executeQuery(String sql);
    int executeUpdate(String sql);
    void executeBatch(String[] sqls);
}

// 抽象产品 - 事务管理器
interface TransactionManager {
    void beginTransaction();
    void commit();
    void rollback();
    boolean isInTransaction();
}

// MySQL产品族
class MySQLConnection implements DatabaseConnection {
    private boolean connected = false;
    private String connectionString;
    
    public MySQLConnection(String host, int port, String database) {
        this.connectionString = String.format("mysql://%s:%d/%s", host, port, database);
    }
    
    @Override
    public void connect() {
        connected = true;
        System.out.println("连接到MySQL: " + connectionString);
    }
    
    @Override
    public void disconnect() {
        connected = false;
        System.out.println("断开MySQL连接");
    }
    
    @Override
    public boolean isConnected() {
        return connected;
    }
}

class MySQLQueryExecutor implements QueryExecutor {
    private DatabaseConnection connection;
    
    public MySQLQueryExecutor(DatabaseConnection connection) {
        this.connection = connection;
    }
    
    @Override
    public ResultSet executeQuery(String sql) {
        if (!connection.isConnected()) {
            throw new IllegalStateException("数据库未连接");
        }
        System.out.println("MySQL执行查询: " + sql);
        return new MockResultSet("MySQL查询结果");
    }
    
    @Override
    public int executeUpdate(String sql) {
        if (!connection.isConnected()) {
            throw new IllegalStateException("数据库未连接");
        }
        System.out.println("MySQL执行更新: " + sql);
        return 1; // 模拟影响行数
    }
    
    @Override
    public void executeBatch(String[] sqls) {
        if (!connection.isConnected()) {
            throw new IllegalStateException("数据库未连接");
        }
        System.out.println("MySQL执行批量操作:");
        for (String sql : sqls) {
            System.out.println("  - " + sql);
        }
    }
}

class MySQLTransactionManager implements TransactionManager {
    private boolean inTransaction = false;
    private DatabaseConnection connection;
    
    public MySQLTransactionManager(DatabaseConnection connection) {
        this.connection = connection;
    }
    
    @Override
    public void beginTransaction() {
        if (!connection.isConnected()) {
            throw new IllegalStateException("数据库未连接");
        }
        inTransaction = true;
        System.out.println("MySQL开始事务");
    }
    
    @Override
    public void commit() {
        if (!inTransaction) {
            throw new IllegalStateException("没有活动事务");
        }
        inTransaction = false;
        System.out.println("MySQL提交事务");
    }
    
    @Override
    public void rollback() {
        if (!inTransaction) {
            throw new IllegalStateException("没有活动事务");
        }
        inTransaction = false;
        System.out.println("MySQL回滚事务");
    }
    
    @Override
    public boolean isInTransaction() {
        return inTransaction;
    }
}

// PostgreSQL产品族
class PostgreSQLConnection implements DatabaseConnection {
    private boolean connected = false;
    private String connectionString;
    
    public PostgreSQLConnection(String host, int port, String database) {
        this.connectionString = String.format("postgresql://%s:%d/%s", host, port, database);
    }
    
    @Override
    public void connect() {
        connected = true;
        System.out.println("连接到PostgreSQL: " + connectionString);
    }
    
    @Override
    public void disconnect() {
        connected = false;
        System.out.println("断开PostgreSQL连接");
    }
    
    @Override
    public boolean isConnected() {
        return connected;
    }
}

class PostgreSQLQueryExecutor implements QueryExecutor {
    private DatabaseConnection connection;
    
    public PostgreSQLQueryExecutor(DatabaseConnection connection) {
        this.connection = connection;
    }
    
    @Override
    public ResultSet executeQuery(String sql) {
        if (!connection.isConnected()) {
            throw new IllegalStateException("数据库未连接");
        }
        System.out.println("PostgreSQL执行查询: " + sql);
        return new MockResultSet("PostgreSQL查询结果");
    }
    
    @Override
    public int executeUpdate(String sql) {
        if (!connection.isConnected()) {
            throw new IllegalStateException("数据库未连接");
        }
        System.out.println("PostgreSQL执行更新: " + sql);
        return 1;
    }
    
    @Override
    public void executeBatch(String[] sqls) {
        if (!connection.isConnected()) {
            throw new IllegalStateException("数据库未连接");
        }
        System.out.println("PostgreSQL执行批量操作:");
        for (String sql : sqls) {
            System.out.println("  - " + sql);
        }
    }
}

class PostgreSQLTransactionManager implements TransactionManager {
    private boolean inTransaction = false;
    private DatabaseConnection connection;
    
    public PostgreSQLTransactionManager(DatabaseConnection connection) {
        this.connection = connection;
    }
    
    @Override
    public void beginTransaction() {
        if (!connection.isConnected()) {
            throw new IllegalStateException("数据库未连接");
        }
        inTransaction = true;
        System.out.println("PostgreSQL开始事务");
    }
    
    @Override
    public void commit() {
        if (!inTransaction) {
            throw new IllegalStateException("没有活动事务");
        }
        inTransaction = false;
        System.out.println("PostgreSQL提交事务");
    }
    
    @Override
    public void rollback() {
        if (!inTransaction) {
            throw new IllegalStateException("没有活动事务");
        }
        inTransaction = false;
        System.out.println("PostgreSQL回滚事务");
    }
    
    @Override
    public boolean isInTransaction() {
        return inTransaction;
    }
}

// 抽象工厂
interface DatabaseFactory {
    DatabaseConnection createConnection();
    QueryExecutor createQueryExecutor(DatabaseConnection connection);
    TransactionManager createTransactionManager(DatabaseConnection connection);
}

// 具体工厂
class MySQLFactory implements DatabaseFactory {
    private String host;
    private int port;
    private String database;
    
    public MySQLFactory(String host, int port, String database) {
        this.host = host;
        this.port = port;
        this.database = database;
    }
    
    @Override
    public DatabaseConnection createConnection() {
        return new MySQLConnection(host, port, database);
    }
    
    @Override
    public QueryExecutor createQueryExecutor(DatabaseConnection connection) {
        return new MySQLQueryExecutor(connection);
    }
    
    @Override
    public TransactionManager createTransactionManager(DatabaseConnection connection) {
        return new MySQLTransactionManager(connection);
    }
}

class PostgreSQLFactory implements DatabaseFactory {
    private String host;
    private int port;
    private String database;
    
    public PostgreSQLFactory(String host, int port, String database) {
        this.host = host;
        this.port = port;
        this.database = database;
    }
    
    @Override
    public DatabaseConnection createConnection() {
        return new PostgreSQLConnection(host, port, database);
    }
    
    @Override
    public QueryExecutor createQueryExecutor(DatabaseConnection connection) {
        return new PostgreSQLQueryExecutor(connection);
    }
    
    @Override
    public TransactionManager createTransactionManager(DatabaseConnection connection) {
        return new PostgreSQLTransactionManager(connection);
    }
}

// 数据访问层
class DataAccessLayer {
    private DatabaseConnection connection;
    private QueryExecutor queryExecutor;
    private TransactionManager transactionManager;
    
    public DataAccessLayer(DatabaseFactory factory) {
        this.connection = factory.createConnection();
        this.queryExecutor = factory.createQueryExecutor(connection);
        this.transactionManager = factory.createTransactionManager(connection);
    }
    
    public void initialize() {
        connection.connect();
    }
    
    public void performComplexOperation() {
        try {
            transactionManager.beginTransaction();
            
            // 执行多个数据库操作
            queryExecutor.executeUpdate("INSERT INTO users (name, email) VALUES ('张三', 'zhangsan@example.com')");
            queryExecutor.executeUpdate("INSERT INTO orders (user_id, amount) VALUES (1, 100.00)");
            
            String[] batchSql = {
                "UPDATE users SET last_login = NOW() WHERE id = 1",
                "INSERT INTO user_logs (user_id, action) VALUES (1, 'login')"
            };
            queryExecutor.executeBatch(batchSql);
            
            transactionManager.commit();
            System.out.println("复杂操作执行成功");
            
        } catch (Exception e) {
            if (transactionManager.isInTransaction()) {
                transactionManager.rollback();
            }
            System.err.println("操作失败，已回滚: " + e.getMessage());
        }
    }
    
    public void queryData() {
        ResultSet result = queryExecutor.executeQuery("SELECT * FROM users WHERE active = 1");
        System.out.println("查询结果: " + result.getData());
    }
    
    public void cleanup() {
        if (connection.isConnected()) {
            connection.disconnect();
        }
    }
}

// 模拟结果集
class MockResultSet implements ResultSet {
    private String data;
    
    public MockResultSet(String data) {
        this.data = data;
    }
    
    public String getData() {
        return data;
    }
}

interface ResultSet {
    String getData();
}

// 使用示例
public class DatabaseAbstractFactoryExample {
    public static void main(String[] args) {
        // 根据配置选择数据库类型
        String dbType = "mysql"; // 可以从配置文件读取
        
        DatabaseFactory factory;
        if ("mysql".equals(dbType)) {
            factory = new MySQLFactory("localhost", 3306, "testdb");
            System.out.println("=== 使用MySQL数据库 ===");
        } else {
            factory = new PostgreSQLFactory("localhost", 5432, "testdb");
            System.out.println("=== 使用PostgreSQL数据库 ===");
        }
        
        DataAccessLayer dal = new DataAccessLayer(factory);
        
        try {
            dal.initialize();
            dal.queryData();
            dal.performComplexOperation();
        } finally {
            dal.cleanup();
        }
        
        System.out.println("\n=== 切换到另一个数据库 ===");
        
        // 切换到另一个数据库
        DatabaseFactory anotherFactory = new PostgreSQLFactory("localhost", 5432, "testdb");
        DataAccessLayer anotherDal = new DataAccessLayer(anotherFactory);
        
        try {
            anotherDal.initialize();
            anotherDal.queryData();
            anotherDal.performComplexOperation();
        } finally {
            anotherDal.cleanup();
        }
    }
}
```

**抽象工厂模式的关键特点：**
1. **产品族一致性**: 确保创建的产品属于同一个产品族
2. **易于切换产品族**: 只需要更换具体工厂就可以切换整个产品族
3. **符合开放-封闭原则**: 新增产品族只需添加新的具体工厂
4. **产品之间的约束**: 可以在工厂中定义产品之间的约束关系

#### 参与者概念
- **抽象工厂**：声明创建产品族的接口
- **具体工厂**：实现创建具体产品族的方法
- **抽象产品**：声明产品的接口
- **具体产品**：实现产品接口的具体类

### 4. 建造者模式 (Builder)

#### 核心概念
- **建造者**：负责构造复杂对象的各个部分
- **指挥者**：控制构造过程
- **产品**：被构造的复杂对象
- **分步构造**：逐步构建复杂对象

#### 基础例子：电脑组装建造者
```java
// 产品类 - 电脑
class Computer {
    private String cpu;
    private String memory;
    private String storage;
    private String graphics;
    private String motherboard;
    private String powerSupply;
    private boolean hasWifi;
    private boolean hasBluetooth;
    
    // 私有构造函数，只能通过建造者创建
    private Computer() {}
    
    // Getter方法
    public String getCpu() { return cpu; }
    public String getMemory() { return memory; }
    public String getStorage() { return storage; }
    public String getGraphics() { return graphics; }
    public String getMotherboard() { return motherboard; }
    public String getPowerSupply() { return powerSupply; }
    public boolean hasWifi() { return hasWifi; }
    public boolean hasBluetooth() { return hasBluetooth; }
    
    @Override
    public String toString() {
        return String.format(
            "电脑配置:\n" +
            "CPU: %s\n" +
            "内存: %s\n" +
            "存储: %s\n" +
            "显卡: %s\n" +
            "主板: %s\n" +
            "电源: %s\n" +
            "WiFi: %s\n" +
            "蓝牙: %s",
            cpu, memory, storage, graphics, motherboard, powerSupply,
            hasWifi ? "是" : "否", hasBluetooth ? "是" : "否"
        );
    }
    
    // 静态内部类建造者
    public static class Builder {
        private Computer computer;
        
        public Builder() {
            computer = new Computer();
        }
        
        public Builder cpu(String cpu) {
            computer.cpu = cpu;
            return this;
        }
        
        public Builder memory(String memory) {
            computer.memory = memory;
            return this;
        }
        
        public Builder storage(String storage) {
            computer.storage = storage;
            return this;
        }
        
        public Builder graphics(String graphics) {
            computer.graphics = graphics;
            return this;
        }
        
        public Builder motherboard(String motherboard) {
            computer.motherboard = motherboard;
            return this;
        }
        
        public Builder powerSupply(String powerSupply) {
            computer.powerSupply = powerSupply;
            return this;
        }
        
        public Builder wifi(boolean hasWifi) {
            computer.hasWifi = hasWifi;
            return this;
        }
        
        public Builder bluetooth(boolean hasBluetooth) {
            computer.hasBluetooth = hasBluetooth;
            return this;
        }
        
        public Computer build() {
            // 验证必需的组件
            if (computer.cpu == null || computer.memory == null || computer.storage == null) {
                throw new IllegalStateException("CPU、内存和存储是必需的组件");
            }
            
            // 设置默认值
            if (computer.graphics == null) {
                computer.graphics = "集成显卡";
            }
            if (computer.motherboard == null) {
                computer.motherboard = "标准主板";
            }
            if (computer.powerSupply == null) {
                computer.powerSupply = "500W电源";
            }
            
            return computer;
        }
    }
}

// 使用示例
public class ComputerBuilderExample {
    public static void main(String[] args) {
        // 构建游戏电脑
        Computer gamingComputer = new Computer.Builder()
            .cpu("Intel i7-12700K")
            .memory("32GB DDR4")
            .storage("1TB NVMe SSD")
            .graphics("RTX 4070")
            .motherboard("Z690 主板")
            .powerSupply("750W 80+ Gold")
            .wifi(true)
            .bluetooth(true)
            .build();
        
        System.out.println("=== 游戏电脑 ===");
        System.out.println(gamingComputer);
        
        // 构建办公电脑
        Computer officeComputer = new Computer.Builder()
            .cpu("Intel i5-12400")
            .memory("16GB DDR4")
            .storage("512GB SSD")
            .wifi(true)
            .build();
        
        System.out.println("\n=== 办公电脑 ===");
        System.out.println(officeComputer);
    }
}
```

#### 进阶例子：HTTP请求建造者系统
```java
import java.util.*;
import java.util.concurrent.TimeUnit;

// 复杂产品 - HTTP请求
class HttpRequest {
    private String url;
    private String method;
    private Map<String, String> headers;
    private Map<String, String> queryParams;
    private String body;
    private int timeout;
    private int retryCount;
    private boolean followRedirects;
    private String userAgent;
    private Map<String, String> cookies;
    private String contentType;
    private String authorization;
    
    // 私有构造函数
    private HttpRequest() {
        this.headers = new HashMap<>();
        this.queryParams = new HashMap<>();
        this.cookies = new HashMap<>();
    }
    
    // Getter方法
    public String getUrl() { return url; }
    public String getMethod() { return method; }
    public Map<String, String> getHeaders() { return new HashMap<>(headers); }
    public Map<String, String> getQueryParams() { return new HashMap<>(queryParams); }
    public String getBody() { return body; }
    public int getTimeout() { return timeout; }
    public int getRetryCount() { return retryCount; }
    public boolean isFollowRedirects() { return followRedirects; }
    public String getUserAgent() { return userAgent; }
    public Map<String, String> getCookies() { return new HashMap<>(cookies); }
    public String getContentType() { return contentType; }
    public String getAuthorization() { return authorization; }
    
    // 执行请求的模拟方法
    public HttpResponse execute() {
        System.out.println("执行HTTP请求:");
        System.out.println("URL: " + getFullUrl());
        System.out.println("方法: " + method);
        System.out.println("请求头: " + headers);
        if (body != null) {
            System.out.println("请求体: " + body);
        }
        System.out.println("超时时间: " + timeout + "ms");
        System.out.println("重试次数: " + retryCount);
        
        // 模拟响应
        return new HttpResponse(200, "请求成功", "响应内容");
    }
    
    private String getFullUrl() {
        if (queryParams.isEmpty()) {
            return url;
        }
        
        StringBuilder fullUrl = new StringBuilder(url);
        fullUrl.append("?");
        
        boolean first = true;
        for (Map.Entry<String, String> param : queryParams.entrySet()) {
            if (!first) {
                fullUrl.append("&");
            }
            fullUrl.append(param.getKey()).append("=").append(param.getValue());
            first = false;
        }
        
        return fullUrl.toString();
    }
    
    // 建造者类
    public static class Builder {
        private HttpRequest request;
        
        public Builder(String url) {
            request = new HttpRequest();
            request.url = url;
            request.method = "GET"; // 默认方法
            request.timeout = 5000; // 默认超时5秒
            request.retryCount = 0; // 默认不重试
            request.followRedirects = true; // 默认跟随重定向
            request.userAgent = "HttpClient/1.0"; // 默认User-Agent
        }
        
        public Builder method(String method) {
            request.method = method.toUpperCase();
            return this;
        }
        
        public Builder get() {
            return method("GET");
        }
        
        public Builder post() {
            return method("POST");
        }
        
        public Builder put() {
            return method("PUT");
        }
        
        public Builder delete() {
            return method("DELETE");
        }
        
        public Builder header(String name, String value) {
            request.headers.put(name, value);
            return this;
        }
        
        public Builder headers(Map<String, String> headers) {
            request.headers.putAll(headers);
            return this;
        }
        
        public Builder queryParam(String name, String value) {
            request.queryParams.put(name, value);
            return this;
        }
        
        public Builder queryParams(Map<String, String> params) {
            request.queryParams.putAll(params);
            return this;
        }
        
        public Builder body(String body) {
            request.body = body;
            return this;
        }
        
        public Builder jsonBody(String json) {
            request.body = json;
            request.contentType = "application/json";
            request.headers.put("Content-Type", "application/json");
            return this;
        }
        
        public Builder formBody(Map<String, String> formData) {
            StringBuilder body = new StringBuilder();
            boolean first = true;
            for (Map.Entry<String, String> entry : formData.entrySet()) {
                if (!first) {
                    body.append("&");
                }
                body.append(entry.getKey()).append("=").append(entry.getValue());
                first = false;
            }
            request.body = body.toString();
            request.contentType = "application/x-www-form-urlencoded";
            request.headers.put("Content-Type", "application/x-www-form-urlencoded");
            return this;
        }
        
        public Builder timeout(int timeout, TimeUnit unit) {
            request.timeout = (int) unit.toMillis(timeout);
            return this;
        }
        
        public Builder timeout(int timeoutMs) {
            request.timeout = timeoutMs;
            return this;
        }
        
        public Builder retry(int retryCount) {
            request.retryCount = retryCount;
            return this;
        }
        
        public Builder followRedirects(boolean follow) {
            request.followRedirects = follow;
            return this;
        }
        
        public Builder userAgent(String userAgent) {
            request.userAgent = userAgent;
            request.headers.put("User-Agent", userAgent);
            return this;
        }
        
        public Builder cookie(String name, String value) {
            request.cookies.put(name, value);
            return this;
        }
        
        public Builder cookies(Map<String, String> cookies) {
            request.cookies.putAll(cookies);
            return this;
        }
        
        public Builder basicAuth(String username, String password) {
            String credentials = username + ":" + password;
            String encoded = Base64.getEncoder().encodeToString(credentials.getBytes());
            request.authorization = "Basic " + encoded;
            request.headers.put("Authorization", request.authorization);
            return this;
        }
        
        public Builder bearerToken(String token) {
            request.authorization = "Bearer " + token;
            request.headers.put("Authorization", request.authorization);
            return this;
        }
        
        public HttpRequest build() {
            // 验证必需的字段
            if (request.url == null || request.url.trim().isEmpty()) {
                throw new IllegalStateException("URL不能为空");
            }
            
            // 设置Cookie头
            if (!request.cookies.isEmpty()) {
                StringBuilder cookieHeader = new StringBuilder();
                boolean first = true;
                for (Map.Entry<String, String> cookie : request.cookies.entrySet()) {
                    if (!first) {
                        cookieHeader.append("; ");
                    }
                    cookieHeader.append(cookie.getKey()).append("=").append(cookie.getValue());
                    first = false;
                }
                request.headers.put("Cookie", cookieHeader.toString());
            }
            
            return request;
        }
    }
}

// HTTP响应类
class HttpResponse {
    private int statusCode;
    private String statusMessage;
    private String body;
    
    public HttpResponse(int statusCode, String statusMessage, String body) {
        this.statusCode = statusCode;
        this.statusMessage = statusMessage;
        this.body = body;
    }
    
    public int getStatusCode() { return statusCode; }
    public String getStatusMessage() { return statusMessage; }
    public String getBody() { return body; }
    
    @Override
    public String toString() {
        return String.format("HTTP %d %s\n%s", statusCode, statusMessage, body);
    }
}

// 传统建造者模式实现（使用指挥者）
abstract class HttpRequestBuilder {
    protected HttpRequest request;
    
    public HttpRequestBuilder() {
        request = new HttpRequest();
    }
    
    public abstract void buildMethod();
    public abstract void buildHeaders();
    public abstract void buildBody();
    public abstract void buildTimeout();
    
    public HttpRequest getResult() {
        return request;
    }
}

class ApiRequestBuilder extends HttpRequestBuilder {
    private String apiKey;
    private String endpoint;
    
    public ApiRequestBuilder(String endpoint, String apiKey) {
        super();
        this.endpoint = endpoint;
        this.apiKey = apiKey;
    }
    
    @Override
    public void buildMethod() {
        // API请求通常使用POST
        request = new HttpRequest.Builder(endpoint).post().build();
    }
    
    @Override
    public void buildHeaders() {
        request = new HttpRequest.Builder(endpoint)
            .post()
            .header("X-API-Key", apiKey)
            .header("Accept", "application/json")
            .build();
    }
    
    @Override
    public void buildBody() {
        request = new HttpRequest.Builder(endpoint)
            .post()
            .header("X-API-Key", apiKey)
            .header("Accept", "application/json")
            .jsonBody("{\"action\": \"getData\"}")
            .build();
    }
    
    @Override
    public void buildTimeout() {
        request = new HttpRequest.Builder(endpoint)
            .post()
            .header("X-API-Key", apiKey)
            .header("Accept", "application/json")
            .jsonBody("{\"action\": \"getData\"}")
            .timeout(10, TimeUnit.SECONDS)
            .retry(3)
            .build();
    }
}

// 指挥者
class HttpRequestDirector {
    public HttpRequest constructApiRequest(HttpRequestBuilder builder) {
        builder.buildMethod();
        builder.buildHeaders();
        builder.buildBody();
        builder.buildTimeout();
        return builder.getResult();
    }
}

// 使用示例
public class HttpRequestBuilderExample {
    public static void main(String[] args) {
        System.out.println("=== 链式建造者示例 ===");
        
        // 构建GET请求
        HttpRequest getRequest = new HttpRequest.Builder("https://api.example.com/users")
            .get()
            .queryParam("page", "1")
            .queryParam("limit", "10")
            .header("Accept", "application/json")
            .userAgent("MyApp/1.0")
            .timeout(5, TimeUnit.SECONDS)
            .build();
        
        HttpResponse getResponse = getRequest.execute();
        System.out.println("GET响应: " + getResponse);
        
        System.out.println("\n=== POST请求示例 ===");
        
        // 构建POST请求
        Map<String, String> formData = new HashMap<>();
        formData.put("username", "john");
        formData.put("password", "secret");
        
        HttpRequest postRequest = new HttpRequest.Builder("https://api.example.com/login")
            .post()
            .formBody(formData)
            .timeout(10000)
            .retry(2)
            .build();
        
        HttpResponse postResponse = postRequest.execute();
        System.out.println("POST响应: " + postResponse);
        
        System.out.println("\n=== 复杂API请求示例 ===");
        
        // 构建复杂的API请求
        HttpRequest apiRequest = new HttpRequest.Builder("https://api.example.com/data")
            .post()
            .jsonBody("{\"query\": \"SELECT * FROM users\", \"limit\": 100}")
            .bearerToken("eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...")
            .header("X-Request-ID", UUID.randomUUID().toString())
            .cookie("session", "abc123")
            .cookie("preferences", "theme=dark")
            .timeout(30, TimeUnit.SECONDS)
            .retry(3)
            .followRedirects(false)
            .userAgent("DataAnalyzer/2.1")
            .build();
        
        HttpResponse apiResponse = apiRequest.execute();
        System.out.println("API响应: " + apiResponse);
        
        System.out.println("\n=== 传统建造者模式示例 ===");
        
        // 使用传统建造者模式
        HttpRequestDirector director = new HttpRequestDirector();
        ApiRequestBuilder builder = new ApiRequestBuilder("https://api.example.com/endpoint", "api-key-123");
        
        HttpRequest directorRequest = director.constructApiRequest(builder);
        HttpResponse directorResponse = directorRequest.execute();
        System.out.println("指挥者构建的请求响应: " + directorResponse);
    }
}
```

**建造者模式的关键特点：**
1. **分步构造**: 可以分步骤构造复杂对象
2. **参数验证**: 在build()方法中进行参数验证
3. **不可变对象**: 构造完成后对象通常是不可变的
4. **链式调用**: 支持流畅的链式调用语法
5. **默认值处理**: 可以为可选参数提供合理的默认值

#### 实现概念
- **传统建造者**：使用指挥者控制构造过程
- **链式建造者**：支持方法链式调用
- **静态内部类建造者**：常见的Java实现方式
- **注解驱动建造者**：通过注解自动生成建造者

### 5. 原型模式 (Prototype)

#### 核心概念
- **原型**：用于创建对象的样板
- **克隆**：通过复制现有对象创建新对象
- **原型管理器**：管理原型对象的注册表

#### 基础例子：图形对象克隆
```java
// 抽象原型
abstract class Shape implements Cloneable {
    protected String id;
    protected String type;
    protected int x, y;
    protected String color;
    
    public Shape() {}
    
    public Shape(Shape source) {
        if (source != null) {
            this.id = source.id;
            this.type = source.type;
            this.x = source.x;
            this.y = source.y;
            this.color = source.color;
        }
    }
    
    // 抽象克隆方法
    public abstract Shape clone();
    
    // 抽象绘制方法
    public abstract void draw();
    
    // Getter和Setter方法
    public String getId() { return id; }
    public void setId(String id) { this.id = id; }
    public String getType() { return type; }
    public void setType(String type) { this.type = type; }
    public int getX() { return x; }
    public void setX(int x) { this.x = x; }
    public int getY() { return y; }
    public void setY(int y) { this.y = y; }
    public String getColor() { return color; }
    public void setColor(String color) { this.color = color; }
    
    @Override
    public String toString() {
        return String.format("%s[id=%s, position=(%d,%d), color=%s]", 
                           type, id, x, y, color);
    }
}

// 具体原型 - 圆形
class Circle extends Shape {
    private int radius;
    
    public Circle() {
        this.type = "Circle";
    }
    
    public Circle(Circle source) {
        super(source);
        if (source != null) {
            this.radius = source.radius;
        }
    }
    
    @Override
    public Shape clone() {
        return new Circle(this);
    }
    
    @Override
    public void draw() {
        System.out.println("绘制圆形: " + this + ", 半径=" + radius);
    }
    
    public int getRadius() { return radius; }
    public void setRadius(int radius) { this.radius = radius; }
}

// 具体原型 - 矩形
class Rectangle extends Shape {
    private int width, height;
    
    public Rectangle() {
        this.type = "Rectangle";
    }
    
    public Rectangle(Rectangle source) {
        super(source);
        if (source != null) {
            this.width = source.width;
            this.height = source.height;
        }
    }
    
    @Override
    public Shape clone() {
        return new Rectangle(this);
    }
    
    @Override
    public void draw() {
        System.out.println("绘制矩形: " + this + ", 尺寸=" + width + "x" + height);
    }
    
    public int getWidth() { return width; }
    public void setWidth(int width) { this.width = width; }
    public int getHeight() { return height; }
    public void setHeight(int height) { this.height = height; }
}

// 原型管理器
class ShapeCache {
    private static Map<String, Shape> shapeMap = new HashMap<>();
    
    public static Shape getShape(String shapeId) {
        Shape cachedShape = shapeMap.get(shapeId);
        return cachedShape != null ? cachedShape.clone() : null;
    }
    
    public static void loadCache() {
        Circle circle = new Circle();
        circle.setId("1");
        circle.setX(10);
        circle.setY(20);
        circle.setColor("红色");
        circle.setRadius(5);
        shapeMap.put(circle.getId(), circle);
        
        Rectangle rectangle = new Rectangle();
        rectangle.setId("2");
        rectangle.setX(30);
        rectangle.setY(40);
        rectangle.setColor("蓝色");
        rectangle.setWidth(15);
        rectangle.setHeight(10);
        shapeMap.put(rectangle.getId(), rectangle);
        
        System.out.println("原型缓存已加载");
    }
    
    public static void addShape(String id, Shape shape) {
        shapeMap.put(id, shape);
    }
    
    public static Set<String> getAvailableShapes() {
        return shapeMap.keySet();
    }
}

// 使用示例
public class PrototypeExample {
    public static void main(String[] args) {
        // 加载原型缓存
        ShapeCache.loadCache();
        
        System.out.println("可用的原型: " + ShapeCache.getAvailableShapes());
        
        // 克隆圆形
        Shape clonedCircle1 = ShapeCache.getShape("1");
        clonedCircle1.draw();
        
        Shape clonedCircle2 = ShapeCache.getShape("1");
        clonedCircle2.setColor("绿色");
        clonedCircle2.setX(50);
        clonedCircle2.draw();
        
        // 克隆矩形
        Shape clonedRectangle = ShapeCache.getShape("2");
        clonedRectangle.draw();
        
        // 验证克隆的独立性
        System.out.println("\n验证克隆独立性:");
        System.out.println("原始圆形颜色: " + ShapeCache.getShape("1").getColor());
        System.out.println("修改后的圆形颜色: " + clonedCircle2.getColor());
    }
}
```

#### 进阶例子：文档模板克隆系统
```java
import java.io.*;
import java.util.*;
import java.util.concurrent.ConcurrentHashMap;

// 复杂对象 - 文档
class Document implements Cloneable, Serializable {
    private static final long serialVersionUID = 1L;
    
    private String title;
    private String content;
    private List<String> tags;
    private Map<String, Object> metadata;
    private List<Attachment> attachments;
    private DocumentStyle style;
    private Date createdDate;
    private Date modifiedDate;
    
    public Document() {
        this.tags = new ArrayList<>();
        this.metadata = new HashMap<>();
        this.attachments = new ArrayList<>();
        this.createdDate = new Date();
        this.modifiedDate = new Date();
    }
    
    // 拷贝构造函数 - 深拷贝
    public Document(Document source) {
        if (source != null) {
            this.title = source.title;
            this.content = source.content;
            
            // 深拷贝集合
            this.tags = new ArrayList<>(source.tags);
            this.metadata = new HashMap<>(source.metadata);
            
            // 深拷贝附件列表
            this.attachments = new ArrayList<>();
            for (Attachment attachment : source.attachments) {
                this.attachments.add(new Attachment(attachment));
            }
            
            // 深拷贝样式
            this.style = source.style != null ? new DocumentStyle(source.style) : null;
            
            // 拷贝日期
            this.createdDate = new Date(source.createdDate.getTime());
            this.modifiedDate = new Date();
        }
    }
    
    // 浅拷贝
    @Override
    public Document clone() {
        try {
            Document cloned = (Document) super.clone();
            cloned.modifiedDate = new Date();
            return cloned;
        } catch (CloneNotSupportedException e) {
            throw new RuntimeException("克隆失败", e);
        }
    }
    
    // 深拷贝
    public Document deepClone() {
        return new Document(this);
    }
    
    // 序列化深拷贝
    public Document serializationClone() {
        try {
            ByteArrayOutputStream bos = new ByteArrayOutputStream();
            ObjectOutputStream oos = new ObjectOutputStream(bos);
            oos.writeObject(this);
            oos.close();
            
            ByteArrayInputStream bis = new ByteArrayInputStream(bos.toByteArray());
            ObjectInputStream ois = new ObjectInputStream(bis);
            Document cloned = (Document) ois.readObject();
            ois.close();
            
            cloned.modifiedDate = new Date();
            return cloned;
        } catch (IOException | ClassNotFoundException e) {
            throw new RuntimeException("序列化克隆失败", e);
        }
    }
    
    // Getter和Setter方法
    public String getTitle() { return title; }
    public void setTitle(String title) { 
        this.title = title; 
        this.modifiedDate = new Date();
    }
    
    public String getContent() { return content; }
    public void setContent(String content) { 
        this.content = content; 
        this.modifiedDate = new Date();
    }
    
    public List<String> getTags() { return tags; }
    public void addTag(String tag) { 
        this.tags.add(tag); 
        this.modifiedDate = new Date();
    }
    
    public Map<String, Object> getMetadata() { return metadata; }
    public void setMetadata(String key, Object value) { 
        this.metadata.put(key, value); 
        this.modifiedDate = new Date();
    }
    
    public List<Attachment> getAttachments() { return attachments; }
    public void addAttachment(Attachment attachment) { 
        this.attachments.add(attachment); 
        this.modifiedDate = new Date();
    }
    
    public DocumentStyle getStyle() { return style; }
    public void setStyle(DocumentStyle style) { 
        this.style = style; 
        this.modifiedDate = new Date();
    }
    
    public Date getCreatedDate() { return createdDate; }
    public Date getModifiedDate() { return modifiedDate; }
    
    @Override
    public String toString() {
        return String.format("Document[title='%s', tags=%s, attachments=%d, created=%s, modified=%s]",
                           title, tags, attachments.size(), createdDate, modifiedDate);
    }
}

// 附件类
class Attachment implements Serializable {
    private static final long serialVersionUID = 1L;
    
    private String filename;
    private String contentType;
    private long size;
    private byte[] data;
    
    public Attachment(String filename, String contentType, byte[] data) {
        this.filename = filename;
        this.contentType = contentType;
        this.data = data != null ? data.clone() : null;
        this.size = data != null ? data.length : 0;
    }
    
    public Attachment(Attachment source) {
        if (source != null) {
            this.filename = source.filename;
            this.contentType = source.contentType;
            this.size = source.size;
            this.data = source.data != null ? source.data.clone() : null;
        }
    }
    
    // Getter方法
    public String getFilename() { return filename; }
    public String getContentType() { return contentType; }
    public long getSize() { return size; }
    public byte[] getData() { return data != null ? data.clone() : null; }
    
    @Override
    public String toString() {
        return String.format("Attachment[filename='%s', type='%s', size=%d]", 
                           filename, contentType, size);
    }
}

// 文档样式类
class DocumentStyle implements Serializable {
    private static final long serialVersionUID = 1L;
    
    private String fontFamily;
    private int fontSize;
    private String fontColor;
    private String backgroundColor;
    private int lineSpacing;
    private String alignment;
    
    public DocumentStyle() {
        this.fontFamily = "Arial";
        this.fontSize = 12;
        this.fontColor = "#000000";
        this.backgroundColor = "#FFFFFF";
        this.lineSpacing = 1;
        this.alignment = "left";
    }
    
    public DocumentStyle(DocumentStyle source) {
        if (source != null) {
            this.fontFamily = source.fontFamily;
            this.fontSize = source.fontSize;
            this.fontColor = source.fontColor;
            this.backgroundColor = source.backgroundColor;
            this.lineSpacing = source.lineSpacing;
            this.alignment = source.alignment;
        }
    }
    
    // Getter和Setter方法
    public String getFontFamily() { return fontFamily; }
    public void setFontFamily(String fontFamily) { this.fontFamily = fontFamily; }
    public int getFontSize() { return fontSize; }
    public void setFontSize(int fontSize) { this.fontSize = fontSize; }
    public String getFontColor() { return fontColor; }
    public void setFontColor(String fontColor) { this.fontColor = fontColor; }
    public String getBackgroundColor() { return backgroundColor; }
    public void setBackgroundColor(String backgroundColor) { this.backgroundColor = backgroundColor; }
    public int getLineSpacing() { return lineSpacing; }
    public void setLineSpacing(int lineSpacing) { this.lineSpacing = lineSpacing; }
    public String getAlignment() { return alignment; }
    public void setAlignment(String alignment) { this.alignment = alignment; }
    
    @Override
    public String toString() {
        return String.format("Style[font=%s %dpx, color=%s, bg=%s, align=%s]",
                           fontFamily, fontSize, fontColor, backgroundColor, alignment);
    }
}

// 文档模板管理器
class DocumentTemplateManager {
    private static final Map<String, Document> templates = new ConcurrentHashMap<>();
    private static final Map<String, Integer> usageCount = new ConcurrentHashMap<>();
    
    static {
        initializeTemplates();
    }
    
    private static void initializeTemplates() {
        // 创建报告模板
        Document reportTemplate = new Document();
        reportTemplate.setTitle("月度报告模板");
        reportTemplate.setContent("# 月度报告\n\n## 概述\n\n## 详细内容\n\n## 结论");
        reportTemplate.addTag("报告");
        reportTemplate.addTag("模板");
        reportTemplate.setMetadata("category", "business");
        reportTemplate.setMetadata("version", "1.0");
        
        DocumentStyle reportStyle = new DocumentStyle();
        reportStyle.setFontFamily("Times New Roman");
        reportStyle.setFontSize(14);
        reportStyle.setLineSpacing(2);
        reportTemplate.setStyle(reportStyle);
        
        templates.put("report", reportTemplate);
        
        // 创建邮件模板
        Document emailTemplate = new Document();
        emailTemplate.setTitle("邮件模板");
        emailTemplate.setContent("尊敬的 [客户姓名]，\n\n感谢您的咨询...\n\n此致\n敬礼");
        emailTemplate.addTag("邮件");
        emailTemplate.addTag("客服");
        emailTemplate.setMetadata("category", "communication");
        emailTemplate.setMetadata("priority", "normal");
        
        DocumentStyle emailStyle = new DocumentStyle();
        emailStyle.setFontFamily("Arial");
        emailStyle.setFontSize(12);
        emailTemplate.setStyle(emailStyle);
        
        templates.put("email", emailTemplate);
        
        // 创建合同模板
        Document contractTemplate = new Document();
        contractTemplate.setTitle("服务合同模板");
        contractTemplate.setContent("服务合同\n\n甲方：[公司名称]\n乙方：[客户名称]\n\n合同条款：\n1. ...\n2. ...");
        contractTemplate.addTag("合同");
        contractTemplate.addTag("法律");
        contractTemplate.setMetadata("category", "legal");
        contractTemplate.setMetadata("requires_review", true);
        
        // 添加附件
        byte[] sampleData = "合同附件示例内容".getBytes();
        contractTemplate.addAttachment(new Attachment("contract_terms.txt", "text/plain", sampleData));
        
        DocumentStyle contractStyle = new DocumentStyle();
        contractStyle.setFontFamily("SimSun");
        contractStyle.setFontSize(12);
        contractStyle.setLineSpacing(2);
        contractTemplate.setStyle(contractStyle);
        
        templates.put("contract", contractTemplate);
        
        System.out.println("文档模板已初始化: " + templates.keySet());
    }
    
    public static Document getTemplate(String templateName) {
        Document template = templates.get(templateName);
        if (template == null) {
            throw new IllegalArgumentException("模板不存在: " + templateName);
        }
        
        // 记录使用次数
        usageCount.merge(templateName, 1, Integer::sum);
        
        return template.deepClone();
    }
    
    public static Document getTemplateByClone(String templateName) {
        Document template = templates.get(templateName);
        if (template == null) {
            throw new IllegalArgumentException("模板不存在: " + templateName);
        }
        
        usageCount.merge(templateName, 1, Integer::sum);
        return template.clone(); // 浅拷贝
    }
    
    public static Document getTemplateBySerialization(String templateName) {
        Document template = templates.get(templateName);
        if (template == null) {
            throw new IllegalArgumentException("模板不存在: " + templateName);
        }
        
        usageCount.merge(templateName, 1, Integer::sum);
        return template.serializationClone(); // 序列化深拷贝
    }
    
    public static void addTemplate(String name, Document template) {
        templates.put(name, template);
        usageCount.put(name, 0);
    }
    
    public static Set<String> getAvailableTemplates() {
        return templates.keySet();
    }
    
    public static Map<String, Integer> getUsageStatistics() {
        return new HashMap<>(usageCount);
    }
    
    public static void printTemplateInfo(String templateName) {
        Document template = templates.get(templateName);
        if (template != null) {
            System.out.println("模板信息: " + template);
            System.out.println("样式: " + template.getStyle());
            System.out.println("附件: " + template.getAttachments());
            System.out.println("使用次数: " + usageCount.getOrDefault(templateName, 0));
        }
    }
}

// 使用示例
public class DocumentPrototypeExample {
    public static void main(String[] args) {
        System.out.println("=== 文档模板克隆系统 ===");
        System.out.println("可用模板: " + DocumentTemplateManager.getAvailableTemplates());
        
        // 使用深拷贝创建文档
        System.out.println("\n--- 深拷贝示例 ---");
        Document report1 = DocumentTemplateManager.getTemplate("report");
        report1.setTitle("2024年1月销售报告");
        report1.setContent(report1.getContent().replace("[月份]", "1月"));
        report1.addTag("销售");
        report1.setMetadata("month", "2024-01");
        
        Document report2 = DocumentTemplateManager.getTemplate("report");
        report2.setTitle("2024年2月销售报告");
        report2.setContent(report2.getContent().replace("[月份]", "2月"));
        report2.addTag("销售");
        report2.setMetadata("month", "2024-02");
        
        System.out.println("报告1: " + report1);
        System.out.println("报告2: " + report2);
        
        // 使用浅拷贝创建文档
        System.out.println("\n--- 浅拷贝示例 ---");
        Document email1 = DocumentTemplateManager.getTemplateByClone("email");
        email1.setTitle("客户咨询回复");
        email1.addTag("客服回复");
        
        Document email2 = DocumentTemplateManager.getTemplateByClone("email");
        email2.setTitle("产品介绍邮件");
        
        System.out.println("邮件1: " + email1);
        System.out.println("邮件2: " + email2);
        
        // 验证浅拷贝的共享问题
        System.out.println("邮件1标签: " + email1.getTags());
        System.out.println("邮件2标签: " + email2.getTags());
        
        // 使用序列化克隆
        System.out.println("\n--- 序列化克隆示例 ---");
        Document contract1 = DocumentTemplateManager.getTemplateBySerialization("contract");
        contract1.setTitle("软件开发服务合同");
        contract1.setContent(contract1.getContent().replace("[公司名称]", "科技有限公司"));
        contract1.setContent(contract1.getContent().replace("[客户名称]", "ABC公司"));
        
        System.out.println("合同1: " + contract1);
        System.out.println("合同1附件: " + contract1.getAttachments());
        
        // 性能测试
        System.out.println("\n--- 性能测试 ---");
        long startTime, endTime;
        int iterations = 1000;
        
        // 测试深拷贝性能
        startTime = System.currentTimeMillis();
        for (int i = 0; i < iterations; i++) {
            Document doc = DocumentTemplateManager.getTemplate("contract");
        }
        endTime = System.currentTimeMillis();
        System.out.println("深拷贝 " + iterations + " 次耗时: " + (endTime - startTime) + "ms");
        
        // 测试浅拷贝性能
        startTime = System.currentTimeMillis();
        for (int i = 0; i < iterations; i++) {
            Document doc = DocumentTemplateManager.getTemplateByClone("contract");
        }
        endTime = System.currentTimeMillis();
        System.out.println("浅拷贝 " + iterations + " 次耗时: " + (endTime - startTime) + "ms");
        
        // 测试序列化克隆性能
        startTime = System.currentTimeMillis();
        for (int i = 0; i < iterations; i++) {
            Document doc = DocumentTemplateManager.getTemplateBySerialization("contract");
        }
        endTime = System.currentTimeMillis();
        System.out.println("序列化克隆 " + iterations + " 次耗时: " + (endTime - startTime) + "ms");
        
        // 显示使用统计
        System.out.println("\n--- 使用统计 ---");
        Map<String, Integer> stats = DocumentTemplateManager.getUsageStatistics();
        stats.forEach((template, count) -> 
            System.out.println(template + ": " + count + " 次"));
        
        // 显示模板详细信息
        System.out.println("\n--- 模板详细信息 ---");
        DocumentTemplateManager.printTemplateInfo("contract");
    }
}
```

**原型模式的关键特点：**
1. **避免重复创建**: 通过克隆避免重复的初始化过程
2. **运行时配置**: 可以在运行时动态添加和删除原型
3. **减少子类**: 避免为每种产品创建工厂子类
4. **性能优化**: 克隆通常比new操作更快
5. **深浅拷贝选择**: 根据需要选择合适的拷贝方式

#### 克隆概念
- **浅拷贝**：只复制对象的基本类型字段
- **深拷贝**：递归复制对象的所有字段
- **序列化克隆**：通过序列化实现深拷贝
- **手动克隆**：自定义克隆逻辑

## 第三部分：结构型模式概念

### 1. 适配器模式 (Adapter)

#### 核心概念
- **适配器**：将一个接口转换成客户期望的另一个接口
- **目标接口**：客户端期望的接口
- **适配者**：需要被适配的现有类
- **接口转换**：不兼容接口的转换

#### 基础例子：音频播放器适配器
```java
// 目标接口 - 客户端期望的接口
interface MediaPlayer {
    void play(String audioType, String fileName);
}

// 适配者接口 - 高级媒体播放器
interface AdvancedMediaPlayer {
    void playVlc(String fileName);
    void playMp4(String fileName);
}

// 具体适配者 - VLC播放器
class VlcPlayer implements AdvancedMediaPlayer {
    @Override
    public void playVlc(String fileName) {
        System.out.println("播放VLC文件: " + fileName);
    }
    
    @Override
    public void playMp4(String fileName) {
        // VLC播放器不支持MP4
    }
}

// 具体适配者 - MP4播放器
class Mp4Player implements AdvancedMediaPlayer {
    @Override
    public void playVlc(String fileName) {
        // MP4播放器不支持VLC
    }
    
    @Override
    public void playMp4(String fileName) {
        System.out.println("播放MP4文件: " + fileName);
    }
}

// 适配器类 - 对象适配器
class MediaAdapter implements MediaPlayer {
    private AdvancedMediaPlayer advancedPlayer;
    
    public MediaAdapter(String audioType) {
        if ("vlc".equalsIgnoreCase(audioType)) {
            advancedPlayer = new VlcPlayer();
        } else if ("mp4".equalsIgnoreCase(audioType)) {
            advancedPlayer = new Mp4Player();
        }
    }
    
    @Override
    public void play(String audioType, String fileName) {
        if ("vlc".equalsIgnoreCase(audioType)) {
            advancedPlayer.playVlc(fileName);
        } else if ("mp4".equalsIgnoreCase(audioType)) {
            advancedPlayer.playMp4(fileName);
        }
    }
}

// 具体目标类 - 音频播放器
class AudioPlayer implements MediaPlayer {
    private MediaAdapter mediaAdapter;
    
    @Override
    public void play(String audioType, String fileName) {
        // 内置支持MP3格式
        if ("mp3".equalsIgnoreCase(audioType)) {
            System.out.println("播放MP3文件: " + fileName);
        }
        // 使用适配器支持其他格式
        else if ("vlc".equalsIgnoreCase(audioType) || "mp4".equalsIgnoreCase(audioType)) {
            mediaAdapter = new MediaAdapter(audioType);
            mediaAdapter.play(audioType, fileName);
        } else {
            System.out.println("不支持的音频格式: " + audioType);
        }
    }
}

// 使用示例
public class AdapterExample {
    public static void main(String[] args) {
        AudioPlayer audioPlayer = new AudioPlayer();
        
        audioPlayer.play("mp3", "beyond_the_horizon.mp3");
        audioPlayer.play("mp4", "alone.mp4");
        audioPlayer.play("vlc", "far_far_away.vlc");
        audioPlayer.play("avi", "mind_me.avi");
    }
}
```

#### 进阶例子：第三方支付系统适配器
```java
// 目标接口 - 统一支付接口
interface PaymentProcessor {
    PaymentResult processPayment(PaymentRequest request);
    PaymentResult refund(String transactionId, double amount);
    PaymentStatus queryPaymentStatus(String transactionId);
}

// 支付请求
class PaymentRequest {
    private String orderId;
    private double amount;
    private String currency;
    private String description;
    private Map<String, String> customerInfo;
    
    public PaymentRequest(String orderId, double amount, String currency, String description) {
        this.orderId = orderId;
        this.amount = amount;
        this.currency = currency;
        this.description = description;
        this.customerInfo = new HashMap<>();
    }
    
    // Getter和Setter方法
    public String getOrderId() { return orderId; }
    public double getAmount() { return amount; }
    public String getCurrency() { return currency; }
    public String getDescription() { return description; }
    public Map<String, String> getCustomerInfo() { return customerInfo; }
    public void setCustomerInfo(String key, String value) { customerInfo.put(key, value); }
}

// 支付结果
class PaymentResult {
    private boolean success;
    private String transactionId;
    private String message;
    private String errorCode;
    private Date timestamp;
    
    public PaymentResult(boolean success, String transactionId, String message) {
        this.success = success;
        this.transactionId = transactionId;
        this.message = message;
        this.timestamp = new Date();
    }
    
    // Getter方法
    public boolean isSuccess() { return success; }
    public String getTransactionId() { return transactionId; }
    public String getMessage() { return message; }
    public String getErrorCode() { return errorCode; }
    public void setErrorCode(String errorCode) { this.errorCode = errorCode; }
    public Date getTimestamp() { return timestamp; }
    
    @Override
    public String toString() {
        return String.format("PaymentResult[success=%s, transactionId=%s, message=%s, timestamp=%s]",
                           success, transactionId, message, timestamp);
    }
}

// 支付状态枚举
enum PaymentStatus {
    PENDING, SUCCESS, FAILED, CANCELLED, REFUNDED
}

// 第三方支付系统1 - 支付宝（适配者）
class AlipaySDK {
    public AlipayResponse pay(AlipayRequest request) {
        System.out.println("调用支付宝支付接口");
        System.out.println("订单号: " + request.getOutTradeNo());
        System.out.println("金额: " + request.getTotalAmount() + " " + request.getCurrency());
        
        // 模拟支付处理
        String tradeNo = "ALIPAY_" + System.currentTimeMillis();
        return new AlipayResponse("10000", "Success", tradeNo);
    }
    
    public AlipayRefundResponse refund(String tradeNo, double amount) {
        System.out.println("调用支付宝退款接口");
        System.out.println("交易号: " + tradeNo + ", 退款金额: " + amount);
        
        String refundNo = "REFUND_" + System.currentTimeMillis();
        return new AlipayRefundResponse("10000", "Success", refundNo);
    }
    
    public AlipayQueryResponse queryTrade(String tradeNo) {
        System.out.println("查询支付宝交易状态: " + tradeNo);
        return new AlipayQueryResponse("10000", "TRADE_SUCCESS", tradeNo);
    }
}

// 支付宝请求对象
class AlipayRequest {
    private String outTradeNo;
    private String totalAmount;
    private String currency;
    private String subject;
    
    public AlipayRequest(String outTradeNo, String totalAmount, String currency, String subject) {
        this.outTradeNo = outTradeNo;
        this.totalAmount = totalAmount;
        this.currency = currency;
        this.subject = subject;
    }
    
    public String getOutTradeNo() { return outTradeNo; }
    public String getTotalAmount() { return totalAmount; }
    public String getCurrency() { return currency; }
    public String getSubject() { return subject; }
}

// 支付宝响应对象
class AlipayResponse {
    private String code;
    private String msg;
    private String tradeNo;
    
    public AlipayResponse(String code, String msg, String tradeNo) {
        this.code = code;
        this.msg = msg;
        this.tradeNo = tradeNo;
    }
    
    public String getCode() { return code; }
    public String getMsg() { return msg; }
    public String getTradeNo() { return tradeNo; }
    public boolean isSuccess() { return "10000".equals(code); }
}

class AlipayRefundResponse {
    private String code;
    private String msg;
    private String refundNo;
    
    public AlipayRefundResponse(String code, String msg, String refundNo) {
        this.code = code;
        this.msg = msg;
        this.refundNo = refundNo;
    }
    
    public String getCode() { return code; }
    public String getMsg() { return msg; }
    public String getRefundNo() { return refundNo; }
    public boolean isSuccess() { return "10000".equals(code); }
}

class AlipayQueryResponse {
    private String code;
    private String tradeStatus;
    private String tradeNo;
    
    public AlipayQueryResponse(String code, String tradeStatus, String tradeNo) {
        this.code = code;
        this.tradeStatus = tradeStatus;
        this.tradeNo = tradeNo;
    }
    
    public String getCode() { return code; }
    public String getTradeStatus() { return tradeStatus; }
    public String getTradeNo() { return tradeNo; }
}

// 第三方支付系统2 - 微信支付（适配者）
class WechatPaySDK {
    public WechatPayResponse unifiedOrder(WechatPayRequest request) {
        System.out.println("调用微信支付统一下单接口");
        System.out.println("商户订单号: " + request.getOutTradeNo());
        System.out.println("金额: " + request.getTotalFee() + " 分");
        
        String prepayId = "WECHAT_" + System.currentTimeMillis();
        return new WechatPayResponse("SUCCESS", "OK", prepayId);
    }
    
    public WechatRefundResponse refund(String transactionId, int refundFee) {
        System.out.println("调用微信支付退款接口");
        System.out.println("交易号: " + transactionId + ", 退款金额: " + refundFee + " 分");
        
        String refundId = "WX_REFUND_" + System.currentTimeMillis();
        return new WechatRefundResponse("SUCCESS", "OK", refundId);
    }
    
    public WechatQueryResponse orderQuery(String transactionId) {
        System.out.println("查询微信支付订单状态: " + transactionId);
        return new WechatQueryResponse("SUCCESS", "SUCCESS", transactionId);
    }
}

// 微信支付请求对象
class WechatPayRequest {
    private String outTradeNo;
    private int totalFee; // 微信支付金额以分为单位
    private String body;
    
    public WechatPayRequest(String outTradeNo, int totalFee, String body) {
        this.outTradeNo = outTradeNo;
        this.totalFee = totalFee;
        this.body = body;
    }
    
    public String getOutTradeNo() { return outTradeNo; }
    public int getTotalFee() { return totalFee; }
    public String getBody() { return body; }
}

// 微信支付响应对象
class WechatPayResponse {
    private String returnCode;
    private String returnMsg;
    private String prepayId;
    
    public WechatPayResponse(String returnCode, String returnMsg, String prepayId) {
        this.returnCode = returnCode;
        this.returnMsg = returnMsg;
        this.prepayId = prepayId;
    }
    
    public String getReturnCode() { return returnCode; }
    public String getReturnMsg() { return returnMsg; }
    public String getPrepayId() { return prepayId; }
    public boolean isSuccess() { return "SUCCESS".equals(returnCode); }
}

class WechatRefundResponse {
    private String returnCode;
    private String returnMsg;
    private String refundId;
    
    public WechatRefundResponse(String returnCode, String returnMsg, String refundId) {
        this.returnCode = returnCode;
        this.returnMsg = returnMsg;
        this.refundId = refundId;
    }
    
    public String getReturnCode() { return returnCode; }
    public String getReturnMsg() { return returnMsg; }
    public String getRefundId() { return refundId; }
    public boolean isSuccess() { return "SUCCESS".equals(returnCode); }
}

class WechatQueryResponse {
    private String returnCode;
    private String tradeState;
    private String transactionId;
    
    public WechatQueryResponse(String returnCode, String tradeState, String transactionId) {
        this.returnCode = returnCode;
        this.tradeState = tradeState;
        this.transactionId = transactionId;
    }
    
    public String getReturnCode() { return returnCode; }
    public String getTradeState() { return tradeState; }
    public String getTransactionId() { return transactionId; }
}

// 支付宝适配器
class AlipayAdapter implements PaymentProcessor {
    private AlipaySDK alipaySDK;
    
    public AlipayAdapter() {
        this.alipaySDK = new AlipaySDK();
    }
    
    @Override
    public PaymentResult processPayment(PaymentRequest request) {
        try {
            // 转换请求格式
            AlipayRequest alipayRequest = new AlipayRequest(
                request.getOrderId(),
                String.valueOf(request.getAmount()),
                request.getCurrency(),
                request.getDescription()
            );
            
            // 调用支付宝接口
            AlipayResponse response = alipaySDK.pay(alipayRequest);
            
            // 转换响应格式
            if (response.isSuccess()) {
                return new PaymentResult(true, response.getTradeNo(), "支付成功");
            } else {
                PaymentResult result = new PaymentResult(false, null, response.getMsg());
                result.setErrorCode(response.getCode());
                return result;
            }
        } catch (Exception e) {
            return new PaymentResult(false, null, "支付失败: " + e.getMessage());
        }
    }
    
    @Override
    public PaymentResult refund(String transactionId, double amount) {
        try {
            AlipayRefundResponse response = alipaySDK.refund(transactionId, amount);
            
            if (response.isSuccess()) {
                return new PaymentResult(true, response.getRefundNo(), "退款成功");
            } else {
                PaymentResult result = new PaymentResult(false, null, response.getMsg());
                result.setErrorCode(response.getCode());
                return result;
            }
        } catch (Exception e) {
            return new PaymentResult(false, null, "退款失败: " + e.getMessage());
        }
    }
    
    @Override
    public PaymentStatus queryPaymentStatus(String transactionId) {
        try {
            AlipayQueryResponse response = alipaySDK.queryTrade(transactionId);
            
            switch (response.getTradeStatus()) {
                case "TRADE_SUCCESS":
                    return PaymentStatus.SUCCESS;
                case "TRADE_CLOSED":
                    return PaymentStatus.CANCELLED;
                case "WAIT_BUYER_PAY":
                    return PaymentStatus.PENDING;
                default:
                    return PaymentStatus.FAILED;
            }
        } catch (Exception e) {
            return PaymentStatus.FAILED;
        }
    }
}

// 微信支付适配器
class WechatPayAdapter implements PaymentProcessor {
    private WechatPaySDK wechatPaySDK;
    
    public WechatPayAdapter() {
        this.wechatPaySDK = new WechatPaySDK();
    }
    
    @Override
    public PaymentResult processPayment(PaymentRequest request) {
        try {
            // 转换请求格式（微信支付金额以分为单位）
            WechatPayRequest wechatRequest = new WechatPayRequest(
                request.getOrderId(),
                (int) (request.getAmount() * 100), // 转换为分
                request.getDescription()
            );
            
            // 调用微信支付接口
            WechatPayResponse response = wechatPaySDK.unifiedOrder(wechatRequest);
            
            // 转换响应格式
            if (response.isSuccess()) {
                return new PaymentResult(true, response.getPrepayId(), "支付成功");
            } else {
                return new PaymentResult(false, null, response.getReturnMsg());
            }
        } catch (Exception e) {
            return new PaymentResult(false, null, "支付失败: " + e.getMessage());
        }
    }
    
    @Override
    public PaymentResult refund(String transactionId, double amount) {
        try {
            // 微信退款金额以分为单位
            WechatRefundResponse response = wechatPaySDK.refund(transactionId, (int) (amount * 100));
            
            if (response.isSuccess()) {
                return new PaymentResult(true, response.getRefundId(), "退款成功");
            } else {
                return new PaymentResult(false, null, response.getReturnMsg());
            }
        } catch (Exception e) {
            return new PaymentResult(false, null, "退款失败: " + e.getMessage());
        }
    }
    
    @Override
    public PaymentStatus queryPaymentStatus(String transactionId) {
        try {
            WechatQueryResponse response = wechatPaySDK.orderQuery(transactionId);
            
            switch (response.getTradeState()) {
                case "SUCCESS":
                    return PaymentStatus.SUCCESS;
                case "CLOSED":
                    return PaymentStatus.CANCELLED;
                case "USERPAYING":
                    return PaymentStatus.PENDING;
                case "REFUND":
                    return PaymentStatus.REFUNDED;
                default:
                    return PaymentStatus.FAILED;
            }
        } catch (Exception e) {
            return PaymentStatus.FAILED;
        }
    }
}

// 支付处理器工厂
class PaymentProcessorFactory {
    public static PaymentProcessor createProcessor(String paymentType) {
        switch (paymentType.toLowerCase()) {
            case "alipay":
                return new AlipayAdapter();
            case "wechat":
                return new WechatPayAdapter();
            default:
                throw new IllegalArgumentException("不支持的支付类型: " + paymentType);
        }
    }
}

// 统一支付服务
class PaymentService {
    private Map<String, PaymentProcessor> processors;
    
    public PaymentService() {
        processors = new HashMap<>();
        processors.put("alipay", new AlipayAdapter());
        processors.put("wechat", new WechatPayAdapter());
    }
    
    public PaymentResult processPayment(String paymentType, PaymentRequest request) {
        PaymentProcessor processor = processors.get(paymentType.toLowerCase());
        if (processor == null) {
            return new PaymentResult(false, null, "不支持的支付方式: " + paymentType);
        }
        
        System.out.println("使用 " + paymentType + " 处理支付");
        return processor.processPayment(request);
    }
    
    public PaymentResult refund(String paymentType, String transactionId, double amount) {
        PaymentProcessor processor = processors.get(paymentType.toLowerCase());
        if (processor == null) {
            return new PaymentResult(false, null, "不支持的支付方式: " + paymentType);
        }
        
        System.out.println("使用 " + paymentType + " 处理退款");
        return processor.refund(transactionId, amount);
    }
    
    public PaymentStatus queryStatus(String paymentType, String transactionId) {
        PaymentProcessor processor = processors.get(paymentType.toLowerCase());
        if (processor == null) {
            return PaymentStatus.FAILED;
        }
        
        return processor.queryPaymentStatus(transactionId);
    }
}

// 使用示例
public class PaymentAdapterExample {
    public static void main(String[] args) {
        PaymentService paymentService = new PaymentService();
        
        // 创建支付请求
        PaymentRequest request = new PaymentRequest("ORDER_001", 99.99, "CNY", "购买商品");
        request.setCustomerInfo("userId", "12345");
        request.setCustomerInfo("email", "user@example.com");
        
        System.out.println("=== 支付宝支付测试 ===");
        PaymentResult alipayResult = paymentService.processPayment("alipay", request);
        System.out.println("支付结果: " + alipayResult);
        
        if (alipayResult.isSuccess()) {
            PaymentStatus status = paymentService.queryStatus("alipay", alipayResult.getTransactionId());
            System.out.println("支付状态: " + status);
            
            // 测试退款
            PaymentResult refundResult = paymentService.refund("alipay", alipayResult.getTransactionId(), 50.0);
            System.out.println("退款结果: " + refundResult);
        }
        
        System.out.println("\n=== 微信支付测试 ===");
        PaymentRequest wechatRequest = new PaymentRequest("ORDER_002", 199.99, "CNY", "购买VIP会员");
        PaymentResult wechatResult = paymentService.processPayment("wechat", wechatRequest);
        System.out.println("支付结果: " + wechatResult);
        
        if (wechatResult.isSuccess()) {
            PaymentStatus status = paymentService.queryStatus("wechat", wechatResult.getTransactionId());
            System.out.println("支付状态: " + status);
        }
        
        System.out.println("\n=== 不支持的支付方式测试 ===");
        PaymentResult unsupportedResult = paymentService.processPayment("paypal", request);
        System.out.println("支付结果: " + unsupportedResult);
    }
}
```

**适配器模式的关键特点：**
1. **接口转换**: 将不兼容的接口转换为客户端期望的接口
2. **代码复用**: 可以复用现有的类而不需要修改其源代码
3. **解耦**: 客户端与第三方库解耦，便于切换不同的实现
4. **统一接口**: 为不同的第三方服务提供统一的调用接口
5. **易于扩展**: 新增第三方服务只需要添加新的适配器

#### 实现概念
- **类适配器**：通过继承实现适配
- **对象适配器**：通过组合实现适配
- **双向适配器**：支持双向转换的适配器
- **缺省适配器**：提供接口默认实现的适配器

### 2. 桥接模式 (Bridge)

#### 核心概念
- **桥接**：将抽象与实现分离，使它们可以独立变化
- **抽象**：定义抽象接口
- **实现**：定义实现接口
- **分离变化**：将两个独立变化的维度分离

#### 基础例子：图形绘制系统
```java
// 实现接口 - 绘制API
interface DrawingAPI {
    void drawCircle(double x, double y, double radius);
    void drawRectangle(double x, double y, double width, double height);
    void setColor(String color);
}

// 具体实现 - Windows绘制API
class WindowsDrawingAPI implements DrawingAPI {
    @Override
    public void drawCircle(double x, double y, double radius) {
        System.out.printf("Windows API: 在坐标(%.1f, %.1f)绘制半径为%.1f的圆形%n", x, y, radius);
    }
    
    @Override
    public void drawRectangle(double x, double y, double width, double height) {
        System.out.printf("Windows API: 在坐标(%.1f, %.1f)绘制%.1fx%.1f的矩形%n", x, y, width, height);
    }
    
    @Override
    public void setColor(String color) {
        System.out.println("Windows API: 设置颜色为 " + color);
    }
}

// 具体实现 - Linux绘制API
class LinuxDrawingAPI implements DrawingAPI {
    @Override
    public void drawCircle(double x, double y, double radius) {
        System.out.printf("Linux API: 在坐标(%.1f, %.1f)绘制半径为%.1f的圆形%n", x, y, radius);
    }
    
    @Override
    public void drawRectangle(double x, double y, double width, double height) {
        System.out.printf("Linux API: 在坐标(%.1f, %.1f)绘制%.1fx%.1f的矩形%n", x, y, width, height);
    }
    
    @Override
    public void setColor(String color) {
        System.out.println("Linux API: 设置颜色为 " + color);
    }
}

// 抽象类 - 形状
abstract class Shape {
    protected DrawingAPI drawingAPI;
    protected String color = "黑色";
    
    protected Shape(DrawingAPI drawingAPI) {
        this.drawingAPI = drawingAPI;
    }
    
    public abstract void draw();
    public abstract void resize(double factor);
    
    public void setColor(String color) {
        this.color = color;
        drawingAPI.setColor(color);
    }
}

// 扩展抽象类 - 圆形
class Circle extends Shape {
    private double x, y, radius;
    
    public Circle(double x, double y, double radius, DrawingAPI drawingAPI) {
        super(drawingAPI);
        this.x = x;
        this.y = y;
        this.radius = radius;
    }
    
    @Override
    public void draw() {
        drawingAPI.setColor(color);
        drawingAPI.drawCircle(x, y, radius);
    }
    
    @Override
    public void resize(double factor) {
        radius *= factor;
        System.out.printf("圆形大小调整为原来的%.1f倍，新半径: %.1f%n", factor, radius);
    }
    
    public void move(double newX, double newY) {
        this.x = newX;
        this.y = newY;
        System.out.printf("圆形移动到新位置: (%.1f, %.1f)%n", x, y);
    }
}

// 扩展抽象类 - 矩形
class Rectangle extends Shape {
    private double x, y, width, height;
    
    public Rectangle(double x, double y, double width, double height, DrawingAPI drawingAPI) {
        super(drawingAPI);
        this.x = x;
        this.y = y;
        this.width = width;
        this.height = height;
    }
    
    @Override
    public void draw() {
        drawingAPI.setColor(color);
        drawingAPI.drawRectangle(x, y, width, height);
    }
    
    @Override
    public void resize(double factor) {
        width *= factor;
        height *= factor;
        System.out.printf("矩形大小调整为原来的%.1f倍，新尺寸: %.1fx%.1f%n", factor, width, height);
    }
    
    public void move(double newX, double newY) {
        this.x = newX;
        this.y = newY;
        System.out.printf("矩形移动到新位置: (%.1f, %.1f)%n", x, y);
    }
}

// 使用示例
public class BridgeExample {
    public static void main(String[] args) {
        // 使用Windows API绘制图形
        System.out.println("=== 使用Windows API ===");
        DrawingAPI windowsAPI = new WindowsDrawingAPI();
        
        Shape circle1 = new Circle(10, 10, 5, windowsAPI);
        circle1.setColor("红色");
        circle1.draw();
        circle1.resize(1.5);
        circle1.draw();
        
        Shape rectangle1 = new Rectangle(20, 20, 10, 8, windowsAPI);
        rectangle1.setColor("蓝色");
        rectangle1.draw();
        
        // 使用Linux API绘制图形
        System.out.println("\n=== 使用Linux API ===");
        DrawingAPI linuxAPI = new LinuxDrawingAPI();
        
        Shape circle2 = new Circle(15, 15, 7, linuxAPI);
        circle2.setColor("绿色");
        circle2.draw();
        
        Shape rectangle2 = new Rectangle(30, 30, 12, 6, linuxAPI);
        rectangle2.setColor("黄色");
        rectangle2.draw();
        rectangle2.resize(0.8);
        rectangle2.draw();
    }
}
```

#### 进阶例子：消息发送系统
```java
// 实现接口 - 消息发送器
interface MessageSender {
    void sendMessage(String message, String recipient);
    boolean isAvailable();
    void configure(Map<String, String> config);
    String getProviderName();
}

// 具体实现 - 邮件发送器
class EmailSender implements MessageSender {
    private String smtpServer;
    private int port;
    private String username;
    private String password;
    private boolean isConfigured = false;
    
    @Override
    public void sendMessage(String message, String recipient) {
        if (!isConfigured) {
            throw new IllegalStateException("邮件发送器未配置");
        }
        System.out.printf("通过邮件发送消息到 %s:%n", recipient);
        System.out.printf("SMTP服务器: %s:%d%n", smtpServer, port);
        System.out.printf("消息内容: %s%n", message);
        System.out.println("邮件发送成功");
    }
    
    @Override
    public boolean isAvailable() {
        return isConfigured && smtpServer != null && !smtpServer.isEmpty();
    }
    
    @Override
    public void configure(Map<String, String> config) {
        this.smtpServer = config.get("smtp.server");
        this.port = Integer.parseInt(config.getOrDefault("smtp.port", "587"));
        this.username = config.get("smtp.username");
        this.password = config.get("smtp.password");
        this.isConfigured = true;
        System.out.println("邮件发送器配置完成");
    }
    
    @Override
    public String getProviderName() {
        return "Email";
    }
}

// 具体实现 - 短信发送器
class SMSSender implements MessageSender {
    private String apiKey;
    private String apiSecret;
    private String serviceUrl;
    private boolean isConfigured = false;
    
    @Override
    public void sendMessage(String message, String recipient) {
        if (!isConfigured) {
            throw new IllegalStateException("短信发送器未配置");
        }
        System.out.printf("通过短信发送消息到 %s:%n", recipient);
        System.out.printf("服务URL: %s%n", serviceUrl);
        System.out.printf("消息内容: %s%n", message);
        System.out.println("短信发送成功");
    }
    
    @Override
    public boolean isAvailable() {
        return isConfigured && apiKey != null && !apiKey.isEmpty();
    }
    
    @Override
    public void configure(Map<String, String> config) {
        this.apiKey = config.get("sms.api.key");
        this.apiSecret = config.get("sms.api.secret");
        this.serviceUrl = config.get("sms.service.url");
        this.isConfigured = true;
        System.out.println("短信发送器配置完成");
    }
    
    @Override
    public String getProviderName() {
        return "SMS";
    }
}

// 具体实现 - 微信发送器
class WeChatSender implements MessageSender {
    private String appId;
    private String appSecret;
    private String accessToken;
    private boolean isConfigured = false;
    
    @Override
    public void sendMessage(String message, String recipient) {
        if (!isConfigured) {
            throw new IllegalStateException("微信发送器未配置");
        }
        System.out.printf("通过微信发送消息到 %s:%n", recipient);
        System.out.printf("AppId: %s%n", appId);
        System.out.printf("消息内容: %s%n", message);
        System.out.println("微信消息发送成功");
    }
    
    @Override
    public boolean isAvailable() {
        return isConfigured && appId != null && !appId.isEmpty();
    }
    
    @Override
    public void configure(Map<String, String> config) {
        this.appId = config.get("wechat.app.id");
        this.appSecret = config.get("wechat.app.secret");
        this.accessToken = config.get("wechat.access.token");
        this.isConfigured = true;
        System.out.println("微信发送器配置完成");
    }
    
    @Override
    public String getProviderName() {
        return "WeChat";
    }
}

// 抽象类 - 消息
abstract class Message {
    protected MessageSender messageSender;
    protected String content;
    protected String sender;
    protected Date timestamp;
    protected MessagePriority priority;
    
    public Message(MessageSender messageSender) {
        this.messageSender = messageSender;
        this.timestamp = new Date();
        this.priority = MessagePriority.NORMAL;
    }
    
    public abstract void send(String recipient);
    public abstract String formatMessage();
    
    // 通用方法
    public void setContent(String content) {
        this.content = content;
    }
    
    public void setSender(String sender) {
        this.sender = sender;
    }
    
    public void setPriority(MessagePriority priority) {
        this.priority = priority;
    }
    
    public String getProviderName() {
        return messageSender.getProviderName();
    }
    
    public boolean isProviderAvailable() {
        return messageSender.isAvailable();
    }
    
    protected String getPriorityPrefix() {
        switch (priority) {
            case HIGH: return "[紧急] ";
            case LOW: return "[普通] ";
            default: return "";
        }
    }
}

// 消息优先级枚举
enum MessagePriority {
    HIGH, NORMAL, LOW
}

// 扩展抽象类 - 通知消息
class NotificationMessage extends Message {
    private String title;
    private String category;
    
    public NotificationMessage(MessageSender messageSender) {
        super(messageSender);
        this.category = "系统通知";
    }
    
    @Override
    public void send(String recipient) {
        if (!messageSender.isAvailable()) {
            throw new IllegalStateException("消息发送器不可用: " + messageSender.getProviderName());
        }
        
        String formattedMessage = formatMessage();
        System.out.printf("发送通知消息 [%s]:%n", category);
        messageSender.sendMessage(formattedMessage, recipient);
    }
    
    @Override
    public String formatMessage() {
        StringBuilder sb = new StringBuilder();
        sb.append(getPriorityPrefix());
        if (title != null) {
            sb.append("标题: ").append(title).append("\n");
        }
        sb.append("内容: ").append(content).append("\n");
        sb.append("发送时间: ").append(timestamp).append("\n");
        if (sender != null) {
            sb.append("发送者: ").append(sender);
        }
        return sb.toString();
    }
    
    public void setTitle(String title) {
        this.title = title;
    }
    
    public void setCategory(String category) {
        this.category = category;
    }
}

// 扩展抽象类 - 营销消息
class MarketingMessage extends Message {
    private String campaignId;
    private String productName;
    private double discountRate;
    private Date expiryDate;
    
    public MarketingMessage(MessageSender messageSender) {
        super(messageSender);
    }
    
    @Override
    public void send(String recipient) {
        if (!messageSender.isAvailable()) {
            throw new IllegalStateException("消息发送器不可用: " + messageSender.getProviderName());
        }
        
        String formattedMessage = formatMessage();
        System.out.printf("发送营销消息 [活动ID: %s]:%n", campaignId);
        messageSender.sendMessage(formattedMessage, recipient);
    }
    
    @Override
    public String formatMessage() {
        StringBuilder sb = new StringBuilder();
        sb.append(getPriorityPrefix());
        sb.append("🎉 特惠活动通知 🎉\n");
        if (productName != null) {
            sb.append("产品: ").append(productName).append("\n");
        }
        if (discountRate > 0) {
            sb.append("折扣: ").append(String.format("%.0f%%", discountRate * 100)).append(" OFF\n");
        }
        sb.append("详情: ").append(content).append("\n");
        if (expiryDate != null) {
            sb.append("有效期至: ").append(expiryDate).append("\n");
        }
        sb.append("活动ID: ").append(campaignId);
        return sb.toString();
    }
    
    public void setCampaignId(String campaignId) {
        this.campaignId = campaignId;
    }
    
    public void setProductName(String productName) {
        this.productName = productName;
    }
    
    public void setDiscountRate(double discountRate) {
        this.discountRate = discountRate;
    }
    
    public void setExpiryDate(Date expiryDate) {
        this.expiryDate = expiryDate;
    }
}

// 扩展抽象类 - 警报消息
class AlertMessage extends Message {
    private AlertLevel alertLevel;
    private String systemName;
    private String errorCode;
    
    public AlertMessage(MessageSender messageSender) {
        super(messageSender);
        this.alertLevel = AlertLevel.WARNING;
        this.priority = MessagePriority.HIGH; // 警报消息默认高优先级
    }
    
    @Override
    public void send(String recipient) {
        if (!messageSender.isAvailable()) {
            throw new IllegalStateException("消息发送器不可用: " + messageSender.getProviderName());
        }
        
        String formattedMessage = formatMessage();
        System.out.printf("发送警报消息 [%s级别]:%n", alertLevel);
        messageSender.sendMessage(formattedMessage, recipient);
    }
    
    @Override
    public String formatMessage() {
        StringBuilder sb = new StringBuilder();
        sb.append(getAlertPrefix()).append(getPriorityPrefix());
        sb.append("系统警报\n");
        sb.append("级别: ").append(alertLevel).append("\n");
        if (systemName != null) {
            sb.append("系统: ").append(systemName).append("\n");
        }
        if (errorCode != null) {
            sb.append("错误代码: ").append(errorCode).append("\n");
        }
        sb.append("详情: ").append(content).append("\n");
        sb.append("时间: ").append(timestamp);
        return sb.toString();
    }
    
    private String getAlertPrefix() {
        switch (alertLevel) {
            case CRITICAL: return "🚨 [严重] ";
            case ERROR: return "❌ [错误] ";
            case WARNING: return "⚠️ [警告] ";
            default: return "ℹ️ [信息] ";
        }
    }
    
    public void setAlertLevel(AlertLevel alertLevel) {
        this.alertLevel = alertLevel;
    }
    
    public void setSystemName(String systemName) {
        this.systemName = systemName;
    }
    
    public void setErrorCode(String errorCode) {
        this.errorCode = errorCode;
    }
}

// 警报级别枚举
enum AlertLevel {
    INFO, WARNING, ERROR, CRITICAL
}

// 消息发送器工厂
class MessageSenderFactory {
    public static MessageSender createEmailSender() {
        EmailSender sender = new EmailSender();
        Map<String, String> config = new HashMap<>();
        config.put("smtp.server", "smtp.gmail.com");
        config.put("smtp.port", "587");
        config.put("smtp.username", "user@gmail.com");
        config.put("smtp.password", "password");
        sender.configure(config);
        return sender;
    }
    
    public static MessageSender createSMSSender() {
        SMSSender sender = new SMSSender();
        Map<String, String> config = new HashMap<>();
        config.put("sms.api.key", "your-api-key");
        config.put("sms.api.secret", "your-api-secret");
        config.put("sms.service.url", "https://api.sms-service.com");
        sender.configure(config);
        return sender;
    }
    
    public static MessageSender createWeChatSender() {
        WeChatSender sender = new WeChatSender();
        Map<String, String> config = new HashMap<>();
        config.put("wechat.app.id", "your-app-id");
        config.put("wechat.app.secret", "your-app-secret");
        config.put("wechat.access.token", "your-access-token");
        sender.configure(config);
        return sender;
    }
}

// 使用示例
public class MessageBridgeExample {
    public static void main(String[] args) {
        System.out.println("=== 桥接模式消息发送系统 ===");
        
        // 创建不同的消息发送器
        MessageSender emailSender = MessageSenderFactory.createEmailSender();
        MessageSender smsSender = MessageSenderFactory.createSMSSender();
        MessageSender wechatSender = MessageSenderFactory.createWeChatSender();
        
        // 发送通知消息
        System.out.println("\n--- 发送通知消息 ---");
        NotificationMessage notification = new NotificationMessage(emailSender);
        notification.setTitle("系统维护通知");
        notification.setContent("系统将于今晚22:00-24:00进行维护，期间服务可能中断。");
        notification.setSender("系统管理员");
        notification.setPriority(MessagePriority.HIGH);
        notification.send("user@example.com");
        
        // 使用不同发送器发送相同通知
        NotificationMessage smsNotification = new NotificationMessage(smsSender);
        smsNotification.setTitle("系统维护通知");
        smsNotification.setContent("系统维护中，请稍后访问。");
        smsNotification.setPriority(MessagePriority.HIGH);
        smsNotification.send("13800138000");
        
        // 发送营销消息
        System.out.println("\n--- 发送营销消息 ---");
        MarketingMessage marketing = new MarketingMessage(wechatSender);
        marketing.setCampaignId("SUMMER2024");
        marketing.setProductName("夏季新品");
        marketing.setDiscountRate(0.3);
        marketing.setExpiryDate(new Date(System.currentTimeMillis() + 7 * 24 * 60 * 60 * 1000L));
        marketing.setContent("夏季新品大促销，全场7折优惠，限时7天！");
        marketing.setPriority(MessagePriority.NORMAL);
        marketing.send("wechat_user_123");
        
        // 发送警报消息
        System.out.println("\n--- 发送警报消息 ---");
        AlertMessage alert = new AlertMessage(emailSender);
        alert.setAlertLevel(AlertLevel.CRITICAL);
        alert.setSystemName("订单处理系统");
        alert.setErrorCode("SYS_001");
        alert.setContent("数据库连接失败，订单处理服务已停止");
        alert.setSender("监控系统");
        alert.send("admin@example.com");
        
        // 演示桥接模式的灵活性 - 运行时切换实现
        System.out.println("\n--- 运行时切换发送器 ---");
        List<MessageSender> senders = Arrays.asList(emailSender, smsSender, wechatSender);
        
        NotificationMessage flexibleNotification = new NotificationMessage(emailSender);
        flexibleNotification.setTitle("多渠道通知测试");
        flexibleNotification.setContent("这是一条测试消息，将通过不同渠道发送");
        
        for (MessageSender sender : senders) {
            // 运行时切换实现
            flexibleNotification = new NotificationMessage(sender);
            flexibleNotification.setTitle("多渠道通知测试");
            flexibleNotification.setContent("通过 " + sender.getProviderName() + " 发送的测试消息");
            
            String recipient = getRecipientForSender(sender);
            flexibleNotification.send(recipient);
        }
    }
    
    private static String getRecipientForSender(MessageSender sender) {
        switch (sender.getProviderName()) {
            case "Email": return "test@example.com";
            case "SMS": return "13800138000";
            case "WeChat": return "wechat_test_user";
            default: return "unknown";
        }
    }
}
```

**桥接模式的关键特点：**
1. **分离抽象和实现**: 抽象和实现可以独立变化
2. **运行时绑定**: 可以在运行时选择具体的实现
3. **避免永久绑定**: 抽象和实现之间没有永久的绑定关系
4. **扩展性好**: 可以独立扩展抽象层次和实现层次
5. **隐藏实现细节**: 客户端代码不需要了解具体的实现细节

#### 参与者概念
- **抽象类**：定义抽象接口，维护实现对象的引用
- **扩展抽象类**：扩展抽象接口
- **实现接口**：定义实现类的接口
- **具体实现类**：实现具体的实现接口

### 3. 组合模式 (Composite)

#### 核心概念
- **组合**：将对象组合成树形结构表示部分-整体层次
- **组件**：组合中对象的统一接口
- **叶子**：组合中的叶子节点
- **容器**：组合中的容器节点
- **递归结构**：树形结构的递归特性

#### 基础例子：文件系统结构
```java
// 组件接口 - 文件系统组件
abstract class FileSystemComponent {
    protected String name;
    
    public FileSystemComponent(String name) {
        this.name = name;
    }
    
    public String getName() {
        return name;
    }
    
    // 公共操作
    public abstract void display(int depth);
    public abstract long getSize();
    
    // 容器操作 - 默认抛出异常，只有容器类重写
    public void add(FileSystemComponent component) {
        throw new UnsupportedOperationException("不支持添加操作");
    }
    
    public void remove(FileSystemComponent component) {
        throw new UnsupportedOperationException("不支持删除操作");
    }
    
    public FileSystemComponent getChild(int index) {
        throw new UnsupportedOperationException("不支持获取子组件操作");
    }
    
    protected String getIndent(int depth) {
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < depth; i++) {
            sb.append("  ");
        }
        return sb.toString();
    }
}

// 叶子组件 - 文件
class File extends FileSystemComponent {
    private long size;
    private String extension;
    
    public File(String name, long size) {
        super(name);
        this.size = size;
        this.extension = getFileExtension(name);
    }
    
    @Override
    public void display(int depth) {
        System.out.printf("%s📄 %s (%d bytes)%n", getIndent(depth), name, size);
    }
    
    @Override
    public long getSize() {
        return size;
    }
    
    public String getExtension() {
        return extension;
    }
    
    private String getFileExtension(String fileName) {
        int lastDot = fileName.lastIndexOf('.');
        return lastDot > 0 ? fileName.substring(lastDot + 1) : "";
    }
}

// 容器组件 - 目录
class Directory extends FileSystemComponent {
    private List<FileSystemComponent> children;
    
    public Directory(String name) {
        super(name);
        this.children = new ArrayList<>();
    }
    
    @Override
    public void add(FileSystemComponent component) {
        children.add(component);
    }
    
    @Override
    public void remove(FileSystemComponent component) {
        children.remove(component);
    }
    
    @Override
    public FileSystemComponent getChild(int index) {
        if (index >= 0 && index < children.size()) {
            return children.get(index);
        }
        throw new IndexOutOfBoundsException("索引超出范围: " + index);
    }
    
    @Override
    public void display(int depth) {
        System.out.printf("%s📁 %s/ (%d items, %d bytes total)%n", 
                         getIndent(depth), name, children.size(), getSize());
        
        // 递归显示子组件
        for (FileSystemComponent child : children) {
            child.display(depth + 1);
        }
    }
    
    @Override
    public long getSize() {
        long totalSize = 0;
        for (FileSystemComponent child : children) {
            totalSize += child.getSize();
        }
        return totalSize;
    }
    
    public int getChildCount() {
        return children.size();
    }
    
    public List<FileSystemComponent> getChildren() {
        return new ArrayList<>(children);
    }
    
    // 查找文件
    public List<File> findFiles(String extension) {
        List<File> result = new ArrayList<>();
        findFilesRecursive(extension, result);
        return result;
    }
    
    private void findFilesRecursive(String extension, List<File> result) {
        for (FileSystemComponent child : children) {
            if (child instanceof File) {
                File file = (File) child;
                if (extension == null || extension.equals(file.getExtension())) {
                    result.add(file);
                }
            } else if (child instanceof Directory) {
                ((Directory) child).findFilesRecursive(extension, result);
            }
        }
    }
}

// 使用示例
public class CompositeExample {
    public static void main(String[] args) {
        // 创建根目录
        Directory root = new Directory("root");
        
        // 创建子目录
        Directory documents = new Directory("Documents");
        Directory pictures = new Directory("Pictures");
        Directory music = new Directory("Music");
        
        // 创建文件
        File readme = new File("README.txt", 1024);
        File config = new File("config.json", 512);
        
        File photo1 = new File("vacation.jpg", 2048000);
        File photo2 = new File("family.png", 1536000);
        
        File song1 = new File("favorite.mp3", 4096000);
        File song2 = new File("classical.wav", 8192000);
        
        // 构建文件系统树
        root.add(readme);
        root.add(config);
        root.add(documents);
        root.add(pictures);
        root.add(music);
        
        documents.add(new File("report.docx", 256000));
        documents.add(new File("presentation.pptx", 512000));
        
        pictures.add(photo1);
        pictures.add(photo2);
        
        music.add(song1);
        music.add(song2);
        
        // 显示文件系统结构
        System.out.println("=== 文件系统结构 ===");
        root.display(0);
        
        // 查找特定类型的文件
        System.out.println("\n=== 查找图片文件 ===");
        List<File> imageFiles = root.findFiles("jpg");
        imageFiles.addAll(root.findFiles("png"));
        
        for (File file : imageFiles) {
            System.out.println("找到图片: " + file.getName() + " (" + file.getSize() + " bytes)");
        }
        
        // 统计信息
        System.out.println("\n=== 统计信息 ===");
        System.out.println("总大小: " + root.getSize() + " bytes");
        System.out.println("Documents目录大小: " + documents.getSize() + " bytes");
        System.out.println("Pictures目录大小: " + pictures.getSize() + " bytes");
        System.out.println("Music目录大小: " + music.getSize() + " bytes");
    }
}
```

#### 进阶例子：企业组织架构系统
```java
import java.util.*;
import java.util.stream.Collectors;

// 组件接口 - 组织单元
abstract class OrganizationUnit {
    protected String name;
    protected String code;
    protected String description;
    protected Date createdDate;
    protected boolean active;
    
    public OrganizationUnit(String name, String code, String description) {
        this.name = name;
        this.code = code;
        this.description = description;
        this.createdDate = new Date();
        this.active = true;
    }
    
    // 公共方法
    public abstract void display(int depth);
    public abstract int getEmployeeCount();
    public abstract double getTotalSalary();
    public abstract List<Employee> getAllEmployees();
    public abstract void accept(OrganizationVisitor visitor);
    
    // 容器方法 - 默认实现
    public void add(OrganizationUnit unit) {
        throw new UnsupportedOperationException("不支持添加子单元");
    }
    
    public void remove(OrganizationUnit unit) {
        throw new UnsupportedOperationException("不支持删除子单元");
    }
    
    public List<OrganizationUnit> getChildren() {
        return Collections.emptyList();
    }
    
    public OrganizationUnit findByCode(String code) {
        return this.code.equals(code) ? this : null;
    }
    
    // Getter方法
    public String getName() { return name; }
    public String getCode() { return code; }
    public String getDescription() { return description; }
    public Date getCreatedDate() { return createdDate; }
    public boolean isActive() { return active; }
    public void setActive(boolean active) { this.active = active; }
    
    protected String getIndent(int depth) {
        return "  ".repeat(depth);
    }
}

// 叶子组件 - 员工
class Employee extends OrganizationUnit {
    private String position;
    private double salary;
    private String email;
    private String phone;
    private EmployeeLevel level;
    private Date hireDate;
    private Employee manager;
    
    public Employee(String name, String code, String position, double salary) {
        super(name, code, "员工: " + name);
        this.position = position;
        this.salary = salary;
        this.level = EmployeeLevel.JUNIOR;
        this.hireDate = new Date();
    }
    
    @Override
    public void display(int depth) {
        String status = active ? "在职" : "离职";
        System.out.printf("%s👤 %s (%s) - %s - ¥%.2f - %s%n", 
                         getIndent(depth), name, code, position, salary, status);
    }
    
    @Override
    public int getEmployeeCount() {
        return active ? 1 : 0;
    }
    
    @Override
    public double getTotalSalary() {
        return active ? salary : 0;
    }
    
    @Override
    public List<Employee> getAllEmployees() {
        return active ? Arrays.asList(this) : Collections.emptyList();
    }
    
    @Override
    public void accept(OrganizationVisitor visitor) {
        visitor.visitEmployee(this);
    }
    
    // Getter和Setter方法
    public String getPosition() { return position; }
    public void setPosition(String position) { this.position = position; }
    public double getSalary() { return salary; }
    public void setSalary(double salary) { this.salary = salary; }
    public String getEmail() { return email; }
    public void setEmail(String email) { this.email = email; }
    public String getPhone() { return phone; }
    public void setPhone(String phone) { this.phone = phone; }
    public EmployeeLevel getLevel() { return level; }
    public void setLevel(EmployeeLevel level) { this.level = level; }
    public Date getHireDate() { return hireDate; }
    public Employee getManager() { return manager; }
    public void setManager(Employee manager) { this.manager = manager; }
}

// 员工级别枚举
enum EmployeeLevel {
    INTERN("实习生"), JUNIOR("初级"), SENIOR("高级"), LEAD("主管"), MANAGER("经理"), DIRECTOR("总监");
    
    private String displayName;
    
    EmployeeLevel(String displayName) {
        this.displayName = displayName;
    }
    
    public String getDisplayName() {
        return displayName;
    }
}

// 容器组件 - 部门
class Department extends OrganizationUnit {
    private List<OrganizationUnit> children;
    private Employee manager;
    private String location;
    private double budget;
    private DepartmentType type;
    
    public Department(String name, String code, String description, DepartmentType type) {
        super(name, code, description);
        this.children = new ArrayList<>();
        this.type = type;
        this.budget = 0.0;
    }
    
    @Override
    public void add(OrganizationUnit unit) {
        children.add(unit);
    }
    
    @Override
    public void remove(OrganizationUnit unit) {
        children.remove(unit);
    }
    
    @Override
    public List<OrganizationUnit> getChildren() {
        return new ArrayList<>(children);
    }
    
    @Override
    public OrganizationUnit findByCode(String code) {
        if (this.code.equals(code)) {
            return this;
        }
        
        for (OrganizationUnit child : children) {
            OrganizationUnit found = child.findByCode(code);
            if (found != null) {
                return found;
            }
        }
        return null;
    }
    
    @Override
    public void display(int depth) {
        String managerInfo = manager != null ? " (负责人: " + manager.getName() + ")" : "";
        System.out.printf("%s🏢 %s (%s) - %s - %d个子单元 - 预算: ¥%.2f%s%n", 
                         getIndent(depth), name, code, type.getDisplayName(), 
                         children.size(), budget, managerInfo);
        
        // 递归显示子单元
        for (OrganizationUnit child : children) {
            child.display(depth + 1);
        }
    }
    
    @Override
    public int getEmployeeCount() {
        if (!active) return 0;
        
        int count = 0;
        for (OrganizationUnit child : children) {
            count += child.getEmployeeCount();
        }
        return count;
    }
    
    @Override
    public double getTotalSalary() {
        if (!active) return 0;
        
        double total = 0;
        for (OrganizationUnit child : children) {
            total += child.getTotalSalary();
        }
        return total;
    }
    
    @Override
    public List<Employee> getAllEmployees() {
        if (!active) return Collections.emptyList();
        
        List<Employee> allEmployees = new ArrayList<>();
        for (OrganizationUnit child : children) {
            allEmployees.addAll(child.getAllEmployees());
        }
        return allEmployees;
    }
    
    @Override
    public void accept(OrganizationVisitor visitor) {
        visitor.visitDepartment(this);
        for (OrganizationUnit child : children) {
            child.accept(visitor);
        }
    }
    
    // 部门特有方法
    public List<Employee> getEmployeesByLevel(EmployeeLevel level) {
        return getAllEmployees().stream()
                .filter(emp -> emp.getLevel() == level)
                .collect(Collectors.toList());
    }
    
    public List<Employee> getEmployeesByPosition(String position) {
        return getAllEmployees().stream()
                .filter(emp -> emp.getPosition().contains(position))
                .collect(Collectors.toList());
    }
    
    public double getAverageSalary() {
        List<Employee> employees = getAllEmployees();
        if (employees.isEmpty()) return 0;
        
        return employees.stream()
                .mapToDouble(Employee::getSalary)
                .average()
                .orElse(0);
    }
    
    // Getter和Setter方法
    public Employee getManager() { return manager; }
    public void setManager(Employee manager) { this.manager = manager; }
    public String getLocation() { return location; }
    public void setLocation(String location) { this.location = location; }
    public double getBudget() { return budget; }
    public void setBudget(double budget) { this.budget = budget; }
    public DepartmentType getType() { return type; }
}

// 部门类型枚举
enum DepartmentType {
    HEADQUARTERS("总部"), BRANCH("分公司"), DIVISION("事业部"), 
    DEPARTMENT("部门"), TEAM("团队"), PROJECT_GROUP("项目组");
    
    private String displayName;
    
    DepartmentType(String displayName) {
        this.displayName = displayName;
    }
    
    public String getDisplayName() {
        return displayName;
    }
}

// 访问者接口 - 用于遍历组织结构
interface OrganizationVisitor {
    void visitEmployee(Employee employee);
    void visitDepartment(Department department);
}

// 具体访问者 - 统计访问者
class StatisticsVisitor implements OrganizationVisitor {
    private int totalEmployees = 0;
    private int totalDepartments = 0;
    private double totalSalary = 0;
    private Map<EmployeeLevel, Integer> levelCount = new HashMap<>();
    private Map<DepartmentType, Integer> departmentTypeCount = new HashMap<>();
    
    @Override
    public void visitEmployee(Employee employee) {
        if (employee.isActive()) {
            totalEmployees++;
            totalSalary += employee.getSalary();
            levelCount.merge(employee.getLevel(), 1, Integer::sum);
        }
    }
    
    @Override
    public void visitDepartment(Department department) {
        if (department.isActive()) {
            totalDepartments++;
            departmentTypeCount.merge(department.getType(), 1, Integer::sum);
        }
    }
    
    public void printStatistics() {
        System.out.println("=== 组织统计信息 ===");
        System.out.println("总员工数: " + totalEmployees);
        System.out.println("总部门数: " + totalDepartments);
        System.out.printf("总薪资: ¥%.2f%n", totalSalary);
        System.out.printf("平均薪资: ¥%.2f%n", totalEmployees > 0 ? totalSalary / totalEmployees : 0);
        
        System.out.println("\n员工级别分布:");
        levelCount.forEach((level, count) -> 
            System.out.println("  " + level.getDisplayName() + ": " + count + "人"));
        
        System.out.println("\n部门类型分布:");
        departmentTypeCount.forEach((type, count) -> 
            System.out.println("  " + type.getDisplayName() + ": " + count + "个"));
    }
}

// 具体访问者 - 报告生成器
class ReportVisitor implements OrganizationVisitor {
    private StringBuilder report = new StringBuilder();
    private int depth = 0;
    
    @Override
    public void visitEmployee(Employee employee) {
        report.append("  ".repeat(depth))
              .append("员工: ").append(employee.getName())
              .append(" (").append(employee.getPosition()).append(")")
              .append(" - ¥").append(employee.getSalary())
              .append("\n");
    }
    
    @Override
    public void visitDepartment(Department department) {
        report.append("  ".repeat(depth))
              .append("部门: ").append(department.getName())
              .append(" (").append(department.getCode()).append(")")
              .append(" - ").append(department.getType().getDisplayName())
              .append("\n");
        depth++;
        
        // 访问完子节点后恢复深度
        // 注意：这里简化处理，实际应该在访问完所有子节点后恢复
    }
    
    public String getReport() {
        return report.toString();
    }
}

// 使用示例
public class OrganizationCompositeExample {
    public static void main(String[] args) {
        // 创建公司组织架构
        Department company = new Department("科技有限公司", "COMP001", "一家创新的科技公司", DepartmentType.HEADQUARTERS);
        company.setBudget(10000000);
        
        // 创建一级部门
        Department techDept = new Department("技术部", "TECH001", "负责产品研发", DepartmentType.DEPARTMENT);
        Department salesDept = new Department("销售部", "SALES001", "负责市场销售", DepartmentType.DEPARTMENT);
        Department hrDept = new Department("人力资源部", "HR001", "负责人力资源管理", DepartmentType.DEPARTMENT);
        
        // 创建技术部子部门
        Department devTeam = new Department("开发团队", "DEV001", "软件开发团队", DepartmentType.TEAM);
        Department qaTeam = new Department("测试团队", "QA001", "质量保证团队", DepartmentType.TEAM);
        
        // 创建员工
        Employee ceo = new Employee("张总", "CEO001", "首席执行官", 50000);
        ceo.setLevel(EmployeeLevel.DIRECTOR);
        
        Employee techManager = new Employee("李经理", "TM001", "技术经理", 25000);
        techManager.setLevel(EmployeeLevel.MANAGER);
        
        Employee dev1 = new Employee("王开发", "DEV001", "高级开发工程师", 15000);
        dev1.setLevel(EmployeeLevel.SENIOR);
        
        Employee dev2 = new Employee("赵开发", "DEV002", "初级开发工程师", 8000);
        dev2.setLevel(EmployeeLevel.JUNIOR);
        
        Employee qa1 = new Employee("钱测试", "QA001", "测试工程师", 12000);
        qa1.setLevel(EmployeeLevel.SENIOR);
        
        Employee sales1 = new Employee("孙销售", "SALES001", "销售经理", 18000);
        sales1.setLevel(EmployeeLevel.MANAGER);
        
        Employee hr1 = new Employee("周人事", "HR001", "人事专员", 10000);
        hr1.setLevel(EmployeeLevel.JUNIOR);
        
        // 构建组织架构树
        company.add(ceo);
        company.add(techDept);
        company.add(salesDept);
        company.add(hrDept);
        
        techDept.add(techManager);
        techDept.add(devTeam);
        techDept.add(qaTeam);
        techDept.setManager(techManager);
        
        devTeam.add(dev1);
        devTeam.add(dev2);
        
        qaTeam.add(qa1);
        
        salesDept.add(sales1);
        salesDept.setManager(sales1);
        
        hrDept.add(hr1);
        
        // 显示组织架构
        System.out.println("=== 公司组织架构 ===");
        company.display(0);
        
        // 统计信息
        System.out.println("\n=== 基本统计 ===");
        System.out.println("总员工数: " + company.getEmployeeCount());
        System.out.printf("总薪资支出: ¥%.2f%n", company.getTotalSalary());
        System.out.printf("技术部员工数: %d%n", techDept.getEmployeeCount());
        System.out.printf("技术部平均薪资: ¥%.2f%n", techDept.getAverageSalary());
        
        // 查找功能
        System.out.println("\n=== 查找功能 ===");
        OrganizationUnit found = company.findByCode("DEV001");
        if (found != null) {
            System.out.println("找到单元: " + found.getName() + " (" + found.getCode() + ")");
        }
        
        // 按级别查找员工
        List<Employee> managers = techDept.getEmployeesByLevel(EmployeeLevel.MANAGER);
        System.out.println("技术部经理级别员工:");
        managers.forEach(emp -> System.out.println("  " + emp.getName() + " - " + emp.getPosition()));
        
        // 按职位查找员工
        List<Employee> developers = company.getAllEmployees().stream()
                .filter(emp -> emp.getPosition().contains("开发"))
                .collect(Collectors.toList());
        System.out.println("所有开发人员:");
        developers.forEach(emp -> System.out.println("  " + emp.getName() + " - " + emp.getPosition()));
        
        // 使用访问者模式进行统计
        System.out.println("\n=== 访问者模式统计 ===");
        StatisticsVisitor statsVisitor = new StatisticsVisitor();
        company.accept(statsVisitor);
        statsVisitor.printStatistics();
        
        // 生成报告
        System.out.println("\n=== 组织架构报告 ===");
        ReportVisitor reportVisitor = new ReportVisitor();
        company.accept(reportVisitor);
        System.out.println(reportVisitor.getReport());
        
        // 演示动态修改
        System.out.println("\n=== 动态修改演示 ===");
        
        // 添加新员工
        Employee newDev = new Employee("新开发", "DEV003", "中级开发工程师", 12000);
        newDev.setLevel(EmployeeLevel.SENIOR);
        devTeam.add(newDev);
        
        // 员工离职
        dev2.setActive(false);
        
        System.out.println("修改后的开发团队:");
        devTeam.display(0);
        
        System.out.println("修改后技术部统计:");
        System.out.println("员工数: " + techDept.getEmployeeCount());
        System.out.printf("总薪资: ¥%.2f%n", techDept.getTotalSalary());
    }
}
```

**组合模式的关键特点：**
1. **统一接口**: 叶子和容器对象实现相同的接口
2. **递归结构**: 支持任意深度的树形结构
3. **透明性**: 客户端可以一致地处理叶子和容器对象
4. **灵活性**: 可以动态地添加、删除和修改树形结构
5. **简化客户端**: 客户端不需要区分叶子和容器对象

#### 实现概念
- **透明方式**：组件接口包含所有子组件管理方法
- **安全方式**：组件接口只包含公共方法
- **树形遍历**：遍历组合结构的方法

### 4. 装饰器模式 (Decorator)

#### 核心概念
- **装饰器**：动态地给对象添加额外的职责
- **组件**：定义对象的接口
- **装饰**：在不改变接口的前提下扩展功能
- **装饰链**：多个装饰器的组合

#### 基础例子：咖啡订购系统
```java
// 组件接口 - 饮品
interface Beverage {
    String getDescription();
    double getCost();
}

// 具体组件 - 基础咖啡
class Espresso implements Beverage {
    @Override
    public String getDescription() {
        return "浓缩咖啡";
    }
    
    @Override
    public double getCost() {
        return 15.0;
    }
}

class HouseBlend implements Beverage {
    @Override
    public String getDescription() {
        return "综合咖啡";
    }
    
    @Override
    public double getCost() {
        return 12.0;
    }
}

class DarkRoast implements Beverage {
    @Override
    public String getDescription() {
        return "深度烘焙咖啡";
    }
    
    @Override
    public double getCost() {
        return 18.0;
    }
}

// 抽象装饰器
abstract class CondimentDecorator implements Beverage {
    protected Beverage beverage;
    
    public CondimentDecorator(Beverage beverage) {
        this.beverage = beverage;
    }
    
    @Override
    public abstract String getDescription();
}

// 具体装饰器 - 牛奶
class Milk extends CondimentDecorator {
    public Milk(Beverage beverage) {
        super(beverage);
    }
    
    @Override
    public String getDescription() {
        return beverage.getDescription() + " + 牛奶";
    }
    
    @Override
    public double getCost() {
        return beverage.getCost() + 3.0;
    }
}

// 具体装饰器 - 豆浆
class Soy extends CondimentDecorator {
    public Soy(Beverage beverage) {
        super(beverage);
    }
    
    @Override
    public String getDescription() {
        return beverage.getDescription() + " + 豆浆";
    }
    
    @Override
    public double getCost() {
        return beverage.getCost() + 4.0;
    }
}

// 具体装饰器 - 摩卡
class Mocha extends CondimentDecorator {
    public Mocha(Beverage beverage) {
        super(beverage);
    }
    
    @Override
    public String getDescription() {
        return beverage.getDescription() + " + 摩卡";
    }
    
    @Override
    public double getCost() {
        return beverage.getCost() + 5.0;
    }
}

// 具体装饰器 - 奶泡
class Whip extends CondimentDecorator {
    public Whip(Beverage beverage) {
        super(beverage);
    }
    
    @Override
    public String getDescription() {
        return beverage.getDescription() + " + 奶泡";
    }
    
    @Override
    public double getCost() {
        return beverage.getCost() + 2.0;
    }
}

// 使用示例
public class DecoratorExample {
    public static void main(String[] args) {
        // 订购一杯浓缩咖啡
        Beverage beverage1 = new Espresso();
        System.out.println(beverage1.getDescription() + " ¥" + beverage1.getCost());
        
        // 订购一杯深度烘焙咖啡，加牛奶和摩卡
        Beverage beverage2 = new DarkRoast();
        beverage2 = new Milk(beverage2);
        beverage2 = new Mocha(beverage2);
        System.out.println(beverage2.getDescription() + " ¥" + beverage2.getCost());
        
        // 订购一杯综合咖啡，加豆浆、摩卡和奶泡
        Beverage beverage3 = new HouseBlend();
        beverage3 = new Soy(beverage3);
        beverage3 = new Mocha(beverage3);
        beverage3 = new Whip(beverage3);
        System.out.println(beverage3.getDescription() + " ¥" + beverage3.getCost());
        
        // 订购一杯浓缩咖啡，加双份摩卡
        Beverage beverage4 = new Espresso();
        beverage4 = new Mocha(beverage4);
        beverage4 = new Mocha(beverage4); // 双份摩卡
        beverage4 = new Whip(beverage4);
        System.out.println(beverage4.getDescription() + " ¥" + beverage4.getCost());
    }
}
```

#### 进阶例子：数据处理管道系统
```java
import java.util.*;
import java.util.function.Function;
import java.util.stream.Collectors;

// 组件接口 - 数据处理器
interface DataProcessor<T> {
    T process(T data);
    String getProcessorName();
    Map<String, Object> getMetrics();
}

// 具体组件 - 基础数据处理器
class BaseDataProcessor implements DataProcessor<String> {
    private long processCount = 0;
    private long totalProcessTime = 0;
    
    @Override
    public String process(String data) {
        long startTime = System.nanoTime();
        processCount++;
        
        // 基础处理：去除首尾空格
        String result = data != null ? data.trim() : "";
        
        long endTime = System.nanoTime();
        totalProcessTime += (endTime - startTime);
        
        return result;
    }
    
    @Override
    public String getProcessorName() {
        return "基础数据处理器";
    }
    
    @Override
    public Map<String, Object> getMetrics() {
        Map<String, Object> metrics = new HashMap<>();
        metrics.put("processCount", processCount);
        metrics.put("averageProcessTime", processCount > 0 ? totalProcessTime / processCount : 0);
        return metrics;
    }
}

// 抽象装饰器
abstract class DataProcessorDecorator implements DataProcessor<String> {
    protected DataProcessor<String> processor;
    protected long processCount = 0;
    protected long totalProcessTime = 0;
    
    public DataProcessorDecorator(DataProcessor<String> processor) {
        this.processor = processor;
    }
    
    @Override
    public String process(String data) {
        long startTime = System.nanoTime();
        processCount++;
        
        // 先调用被装饰对象的处理方法
        String result = processor.process(data);
        
        // 然后进行装饰处理
        result = doDecorate(result);
        
        long endTime = System.nanoTime();
        totalProcessTime += (endTime - startTime);
        
        return result;
    }
    
    protected abstract String doDecorate(String data);
    
    @Override
    public Map<String, Object> getMetrics() {
        Map<String, Object> metrics = new HashMap<>(processor.getMetrics());
        metrics.put(getProcessorName() + "_processCount", processCount);
        metrics.put(getProcessorName() + "_averageProcessTime", 
                   processCount > 0 ? totalProcessTime / processCount : 0);
        return metrics;
    }
}

// 具体装饰器 - 大小写转换装饰器
class CaseConverterDecorator extends DataProcessorDecorator {
    private CaseType caseType;
    
    public enum CaseType {
        UPPER, LOWER, TITLE
    }
    
    public CaseConverterDecorator(DataProcessor<String> processor, CaseType caseType) {
        super(processor);
        this.caseType = caseType;
    }
    
    @Override
    protected String doDecorate(String data) {
        if (data == null || data.isEmpty()) {
            return data;
        }
        
        switch (caseType) {
            case UPPER:
                return data.toUpperCase();
            case LOWER:
                return data.toLowerCase();
            case TITLE:
                return Arrays.stream(data.split("\\s+"))
                        .map(word -> word.substring(0, 1).toUpperCase() + 
                                   word.substring(1).toLowerCase())
                        .collect(Collectors.joining(" "));
            default:
                return data;
        }
    }
    
    @Override
    public String getProcessorName() {
        return "大小写转换装饰器(" + caseType + ")";
    }
}

// 具体装饰器 - 数据验证装饰器
class ValidationDecorator extends DataProcessorDecorator {
    private List<Function<String, Boolean>> validators;
    private String defaultValue;
    
    public ValidationDecorator(DataProcessor<String> processor, String defaultValue) {
        super(processor);
        this.validators = new ArrayList<>();
        this.defaultValue = defaultValue;
    }
    
    public ValidationDecorator addValidator(Function<String, Boolean> validator) {
        validators.add(validator);
        return this;
    }
    
    @Override
    protected String doDecorate(String data) {
        // 验证数据
        for (Function<String, Boolean> validator : validators) {
            if (!validator.apply(data)) {
                System.out.println("数据验证失败，使用默认值: " + defaultValue);
                return defaultValue;
            }
        }
        return data;
    }
    
    @Override
    public String getProcessorName() {
        return "数据验证装饰器";
    }
}

// 具体装饰器 - 数据清洗装饰器
class DataCleaningDecorator extends DataProcessorDecorator {
    private boolean removeSpecialChars;
    private boolean removeNumbers;
    private boolean removeExtraSpaces;
    
    public DataCleaningDecorator(DataProcessor<String> processor) {
        super(processor);
        this.removeSpecialChars = false;
        this.removeNumbers = false;
        this.removeExtraSpaces = true;
    }
    
    public DataCleaningDecorator removeSpecialChars(boolean remove) {
        this.removeSpecialChars = remove;
        return this;
    }
    
    public DataCleaningDecorator removeNumbers(boolean remove) {
        this.removeNumbers = remove;
        return this;
    }
    
    public DataCleaningDecorator removeExtraSpaces(boolean remove) {
        this.removeExtraSpaces = remove;
        return this;
    }
    
    @Override
    protected String doDecorate(String data) {
        if (data == null || data.isEmpty()) {
            return data;
        }
        
        String result = data;
        
        if (removeSpecialChars) {
            result = result.replaceAll("[^a-zA-Z0-9\\s]", "");
        }
        
        if (removeNumbers) {
            result = result.replaceAll("\\d", "");
        }
        
        if (removeExtraSpaces) {
            result = result.replaceAll("\\s+", " ");
        }
        
        return result;
    }
    
    @Override
    public String getProcessorName() {
        return "数据清洗装饰器";
    }
}

// 具体装饰器 - 日志记录装饰器
class LoggingDecorator extends DataProcessorDecorator {
    private String logLevel;
    private boolean logInput;
    private boolean logOutput;
    private boolean logProcessTime;
    
    public LoggingDecorator(DataProcessor<String> processor, String logLevel) {
        super(processor);
        this.logLevel = logLevel;
        this.logInput = true;
        this.logOutput = true;
        this.logProcessTime = true;
    }
    
    public LoggingDecorator setLogInput(boolean logInput) {
        this.logInput = logInput;
        return this;
    }
    
    public LoggingDecorator setLogOutput(boolean logOutput) {
        this.logOutput = logOutput;
        return this;
    }
    
    public LoggingDecorator setLogProcessTime(boolean logProcessTime) {
        this.logProcessTime = logProcessTime;
        return this;
    }
    
    @Override
    public String process(String data) {
        long startTime = System.nanoTime();
        
        if (logInput) {
            System.out.printf("[%s] 输入数据: '%s'%n", logLevel, data);
        }
        
        String result = super.process(data);
        
        long endTime = System.nanoTime();
        long processTime = endTime - startTime;
        
        if (logOutput) {
            System.out.printf("[%s] 输出数据: '%s'%n", logLevel, result);
        }
        
        if (logProcessTime) {
            System.out.printf("[%s] 处理时间: %d ns%n", logLevel, processTime);
        }
        
        return result;
    }
    
    @Override
    protected String doDecorate(String data) {
        // 日志装饰器不修改数据，只记录日志
        return data;
    }
    
    @Override
    public String getProcessorName() {
        return "日志记录装饰器(" + logLevel + ")";
    }
}

// 具体装饰器 - 缓存装饰器
class CacheDecorator extends DataProcessorDecorator {
    private Map<String, String> cache;
    private int maxCacheSize;
    private long cacheHits = 0;
    private long cacheMisses = 0;
    
    public CacheDecorator(DataProcessor<String> processor, int maxCacheSize) {
        super(processor);
        this.cache = new LinkedHashMap<String, String>(maxCacheSize + 1, 0.75f, true) {
            @Override
            protected boolean removeEldestEntry(Map.Entry<String, String> eldest) {
                return size() > maxCacheSize;
            }
        };
        this.maxCacheSize = maxCacheSize;
    }
    
    @Override
    public String process(String data) {
        // 检查缓存
        if (cache.containsKey(data)) {
            cacheHits++;
            System.out.println("缓存命中: " + data);
            return cache.get(data);
        }
        
        // 缓存未命中，调用实际处理
        cacheMisses++;
        String result = super.process(data);
        
        // 将结果放入缓存
        cache.put(data, result);
        
        return result;
    }
    
    @Override
    protected String doDecorate(String data) {
        // 缓存装饰器不修改数据
        return data;
    }
    
    @Override
    public String getProcessorName() {
        return "缓存装饰器";
    }
    
    @Override
    public Map<String, Object> getMetrics() {
        Map<String, Object> metrics = super.getMetrics();
        metrics.put("cacheHits", cacheHits);
        metrics.put("cacheMisses", cacheMisses);
        metrics.put("cacheHitRate", (cacheHits + cacheMisses) > 0 ? 
                   (double) cacheHits / (cacheHits + cacheMisses) : 0);
        metrics.put("cacheSize", cache.size());
        return metrics;
    }
    
    public void clearCache() {
        cache.clear();
        cacheHits = 0;
        cacheMisses = 0;
    }
}

// 数据处理管道构建器
class DataProcessingPipelineBuilder {
    private DataProcessor<String> processor;
    
    public DataProcessingPipelineBuilder(DataProcessor<String> baseProcessor) {
        this.processor = baseProcessor;
    }
    
    public DataProcessingPipelineBuilder addValidation(String defaultValue) {
        processor = new ValidationDecorator(processor, defaultValue);
        return this;
    }
    
    public DataProcessingPipelineBuilder addValidation(String defaultValue, 
                                                      Function<String, Boolean> validator) {
        ValidationDecorator validationDecorator = new ValidationDecorator(processor, defaultValue);
        validationDecorator.addValidator(validator);
        processor = validationDecorator;
        return this;
    }
    
    public DataProcessingPipelineBuilder addCleaning() {
        processor = new DataCleaningDecorator(processor);
        return this;
    }
    
    public DataProcessingPipelineBuilder addCleaning(boolean removeSpecialChars, 
                                                    boolean removeNumbers, 
                                                    boolean removeExtraSpaces) {
        DataCleaningDecorator cleaningDecorator = new DataCleaningDecorator(processor);
        cleaningDecorator.removeSpecialChars(removeSpecialChars)
                        .removeNumbers(removeNumbers)
                        .removeExtraSpaces(removeExtraSpaces);
        processor = cleaningDecorator;
        return this;
    }
    
    public DataProcessingPipelineBuilder addCaseConversion(CaseConverterDecorator.CaseType caseType) {
        processor = new CaseConverterDecorator(processor, caseType);
        return this;
    }
    
    public DataProcessingPipelineBuilder addLogging(String logLevel) {
        processor = new LoggingDecorator(processor, logLevel);
        return this;
    }
    
    public DataProcessingPipelineBuilder addCache(int maxCacheSize) {
        processor = new CacheDecorator(processor, maxCacheSize);
        return this;
    }
    
    public DataProcessor<String> build() {
        return processor;
    }
}

// 使用示例
public class DataProcessorDecoratorExample {
    public static void main(String[] args) {
        System.out.println("=== 数据处理管道装饰器系统 ===");
        
        // 创建基础处理器
        DataProcessor<String> baseProcessor = new BaseDataProcessor();
        
        // 构建复杂的数据处理管道
        DataProcessor<String> pipeline = new DataProcessingPipelineBuilder(baseProcessor)
                .addValidation("默认值", data -> data != null && !data.isEmpty())
                .addCleaning(true, false, true) // 移除特殊字符，保留数字，移除多余空格
                .addCaseConversion(CaseConverterDecorator.CaseType.TITLE)
                .addCache(10)
                .addLogging("INFO")
                .build();
        
        // 测试数据
        String[] testData = {
            "  hello world!!!  ",
            "JAVA programming123",
            "  design   patterns  ",
            "",
            null,
            "hello world!!!", // 重复数据，测试缓存
            "python@#$%programming",
            "software   ENGINEERING"
        };
        
        System.out.println("\n--- 处理测试数据 ---");
        for (String data : testData) {
            try {
                String result = pipeline.process(data);
                System.out.printf("原始: '%s' -> 结果: '%s'%n", data, result);
                System.out.println();
            } catch (Exception e) {
                System.err.println("处理数据时出错: " + e.getMessage());
            }
        }
        
        // 显示处理器指标
        System.out.println("--- 处理器指标 ---");
        Map<String, Object> metrics = pipeline.getMetrics();
        metrics.forEach((key, value) -> 
            System.out.println(key + ": " + value));
        
        // 演示不同的装饰器组合
        System.out.println("\n=== 不同装饰器组合演示 ===");
        
        // 简单的大小写转换管道
        DataProcessor<String> simplePipeline = new DataProcessingPipelineBuilder(new BaseDataProcessor())
                .addCaseConversion(CaseConverterDecorator.CaseType.UPPER)
                .build();
        
        System.out.println("简单管道处理: " + simplePipeline.process("Hello World"));
        
        // 数据清洗管道
        DataProcessor<String> cleaningPipeline = new DataProcessingPipelineBuilder(new BaseDataProcessor())
                .addCleaning(true, true, true) // 移除特殊字符和数字
                .addCaseConversion(CaseConverterDecorator.CaseType.LOWER)
                .build();
        
        System.out.println("清洗管道处理: " + cleaningPipeline.process("Hello123 World!@#"));
        
        // 带验证的管道
        DataProcessor<String> validationPipeline = new DataProcessingPipelineBuilder(new BaseDataProcessor())
                .addValidation("无效数据", data -> data != null && data.length() > 3)
                .addCaseConversion(CaseConverterDecorator.CaseType.TITLE)
                .build();
        
        System.out.println("验证管道处理短数据: " + validationPipeline.process("Hi"));
        System.out.println("验证管道处理长数据: " + validationPipeline.process("Hello World"));
        
        // 演示装饰器的动态组合
        System.out.println("\n=== 动态装饰器组合 ===");
        DataProcessor<String> dynamicProcessor = new BaseDataProcessor();
        
        // 动态添加装饰器
        dynamicProcessor = new CaseConverterDecorator(dynamicProcessor, CaseConverterDecorator.CaseType.UPPER);
        System.out.println("添加大写转换: " + dynamicProcessor.process("hello"));
        
        dynamicProcessor = new DataCleaningDecorator(dynamicProcessor).removeSpecialChars(true);
        System.out.println("添加数据清洗: " + dynamicProcessor.process("hello@#$world"));
        
        dynamicProcessor = new LoggingDecorator(dynamicProcessor, "DEBUG");
        System.out.println("添加日志记录:");
        dynamicProcessor.process("final test");
    }
}
```

**装饰器模式的关键特点：**
1. **动态扩展**: 可以在运行时动态地给对象添加新功能
2. **组合优于继承**: 通过组合而不是继承来扩展功能
3. **透明性**: 装饰后的对象与原对象具有相同的接口
4. **灵活性**: 可以任意组合多个装饰器
5. **单一职责**: 每个装饰器只负责一种功能的扩展

#### 参与者概念
- **组件接口**：定义对象的接口
- **具体组件**：实现组件接口的基本对象
- **装饰器**：维护组件引用并实现组件接口
- **具体装饰器**：实现具体的装饰功能

### 5. 外观模式 (Facade)

#### 核心概念
- **外观**：为子系统提供统一的高层接口
- **子系统**：实现具体功能的类集合
- **简化接口**：隐藏子系统的复杂性
- **解耦**：客户端与子系统的解耦

#### 基础例子：家庭影院系统
```java
// 子系统类 - 音响设备
class Amplifier {
    private String description;
    
    public Amplifier(String description) {
        this.description = description;
    }
    
    public void on() {
        System.out.println(description + " 开启");
    }
    
    public void off() {
        System.out.println(description + " 关闭");
    }
    
    public void setVolume(int volume) {
        System.out.println(description + " 音量设置为 " + volume);
    }
    
    public void setStereoSound() {
        System.out.println(description + " 设置为立体声模式");
    }
}

// 子系统类 - DVD播放器
class DvdPlayer {
    private String description;
    
    public DvdPlayer(String description) {
        this.description = description;
    }
    
    public void on() {
        System.out.println(description + " 开启");
    }
    
    public void off() {
        System.out.println(description + " 关闭");
    }
    
    public void play(String movie) {
        System.out.println(description + " 播放电影: " + movie);
    }
    
    public void stop() {
        System.out.println(description + " 停止播放");
    }
    
    public void eject() {
        System.out.println(description + " 弹出光盘");
    }
}

// 子系统类 - 投影仪
class Projector {
    private String description;
    
    public Projector(String description) {
        this.description = description;
    }
    
    public void on() {
        System.out.println(description + " 开启");
    }
    
    public void off() {
        System.out.println(description + " 关闭");
    }
    
    public void wideScreenMode() {
        System.out.println(description + " 设置为宽屏模式");
    }
    
    public void tvMode() {
        System.out.println(description + " 设置为TV模式");
    }
}

// 子系统类 - 屏幕
class Screen {
    private String description;
    
    public Screen(String description) {
        this.description = description;
    }
    
    public void up() {
        System.out.println(description + " 升起");
    }
    
    public void down() {
        System.out.println(description + " 降下");
    }
}

// 子系统类 - 灯光
class TheaterLights {
    private String description;
    
    public TheaterLights(String description) {
        this.description = description;
    }
    
    public void on() {
        System.out.println(description + " 开启");
    }
    
    public void off() {
        System.out.println(description + " 关闭");
    }
    
    public void dim(int level) {
        System.out.println(description + " 调暗至 " + level + "%");
    }
}

// 子系统类 - 爆米花机
class PopcornPopper {
    private String description;
    
    public PopcornPopper(String description) {
        this.description = description;
    }
    
    public void on() {
        System.out.println(description + " 开启");
    }
    
    public void off() {
        System.out.println(description + " 关闭");
    }
    
    public void pop() {
        System.out.println(description + " 开始制作爆米花");
    }
}

// 外观类 - 家庭影院外观
class HomeTheaterFacade {
    private Amplifier amp;
    private DvdPlayer dvd;
    private Projector projector;
    private Screen screen;
    private TheaterLights lights;
    private PopcornPopper popper;
    
    public HomeTheaterFacade(Amplifier amp, DvdPlayer dvd, Projector projector,
                           Screen screen, TheaterLights lights, PopcornPopper popper) {
        this.amp = amp;
        this.dvd = dvd;
        this.projector = projector;
        this.screen = screen;
        this.lights = lights;
        this.popper = popper;
    }
    
    // 简化的接口 - 观看电影
    public void watchMovie(String movie) {
        System.out.println("准备观看电影...");
        
        popper.on();
        popper.pop();
        lights.dim(10);
        screen.down();
        projector.on();
        projector.wideScreenMode();
        amp.on();
        amp.setVolume(5);
        amp.setStereoSound();
        dvd.on();
        dvd.play(movie);
        
        System.out.println("电影开始，请享受观影时光！");
    }
    
    // 简化的接口 - 结束观影
    public void endMovie() {
        System.out.println("关闭影院系统...");
        
        popper.off();
        lights.on();
        screen.up();
        projector.off();
        amp.off();
        dvd.stop();
        dvd.eject();
        dvd.off();
        
        System.out.println("影院系统已关闭");
    }
    
    // 简化的接口 - 听音乐
    public void listenToMusic(String album) {
        System.out.println("准备播放音乐...");
        
        lights.on();
        amp.on();
        amp.setVolume(8);
        amp.setStereoSound();
        dvd.on();
        dvd.play(album);
        
        System.out.println("音乐开始播放！");
    }
    
    // 简化的接口 - 关闭音乐
    public void endMusic() {
        System.out.println("关闭音乐系统...");
        
        amp.off();
        dvd.stop();
        dvd.eject();
        dvd.off();
        
        System.out.println("音乐系统已关闭");
    }
}

// 使用示例
public class FacadeExample {
    public static void main(String[] args) {
        // 创建子系统组件
        Amplifier amp = new Amplifier("顶级功放");
        DvdPlayer dvd = new DvdPlayer("顶级DVD播放器");
        Projector projector = new Projector("顶级投影仪");
        Screen screen = new Screen("投影屏幕");
        TheaterLights lights = new TheaterLights("影院灯光");
        PopcornPopper popper = new PopcornPopper("爆米花机");
        
        // 创建外观
        HomeTheaterFacade homeTheater = new HomeTheaterFacade(
            amp, dvd, projector, screen, lights, popper);
        
        // 使用简化的接口
        System.out.println("=== 观看电影 ===");
        homeTheater.watchMovie("阿凡达");
        
        System.out.println("\n=== 结束观影 ===");
        homeTheater.endMovie();
        
        System.out.println("\n=== 听音乐 ===");
        homeTheater.listenToMusic("古典音乐精选");
        
        System.out.println("\n=== 关闭音乐 ===");
        homeTheater.endMusic();
    }
}
```

#### 进阶例子：企业级支付处理系统
```java
import java.math.BigDecimal;
import java.util.*;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.ExecutionException;

// 支付结果枚举
enum PaymentStatus {
    SUCCESS, FAILED, PENDING, CANCELLED, REFUNDED
}

// 支付方式枚举
enum PaymentMethod {
    CREDIT_CARD, DEBIT_CARD, PAYPAL, ALIPAY, WECHAT_PAY, BANK_TRANSFER
}

// 支付请求类
class PaymentRequest {
    private String orderId;
    private BigDecimal amount;
    private String currency;
    private PaymentMethod paymentMethod;
    private Map<String, String> customerInfo;
    private Map<String, String> metadata;
    
    public PaymentRequest(String orderId, BigDecimal amount, String currency, PaymentMethod paymentMethod) {
        this.orderId = orderId;
        this.amount = amount;
        this.currency = currency;
        this.paymentMethod = paymentMethod;
        this.customerInfo = new HashMap<>();
        this.metadata = new HashMap<>();
    }
    
    // Getter和Setter方法
    public String getOrderId() { return orderId; }
    public BigDecimal getAmount() { return amount; }
    public String getCurrency() { return currency; }
    public PaymentMethod getPaymentMethod() { return paymentMethod; }
    public Map<String, String> getCustomerInfo() { return customerInfo; }
    public Map<String, String> getMetadata() { return metadata; }
    
    public void addCustomerInfo(String key, String value) {
        customerInfo.put(key, value);
    }
    
    public void addMetadata(String key, String value) {
        metadata.put(key, value);
    }
}

// 支付响应类
class PaymentResponse {
    private String transactionId;
    private PaymentStatus status;
    private String message;
    private BigDecimal processedAmount;
    private Date processedTime;
    private Map<String, String> additionalInfo;
    
    public PaymentResponse(String transactionId, PaymentStatus status, String message) {
        this.transactionId = transactionId;
        this.status = status;
        this.message = message;
        this.processedTime = new Date();
        this.additionalInfo = new HashMap<>();
    }
    
    // Getter和Setter方法
    public String getTransactionId() { return transactionId; }
    public PaymentStatus getStatus() { return status; }
    public String getMessage() { return message; }
    public BigDecimal getProcessedAmount() { return processedAmount; }
    public void setProcessedAmount(BigDecimal processedAmount) { this.processedAmount = processedAmount; }
    public Date getProcessedTime() { return processedTime; }
    public Map<String, String> getAdditionalInfo() { return additionalInfo; }
    
    public void addAdditionalInfo(String key, String value) {
        additionalInfo.put(key, value);
    }
}

// 子系统 - 风险评估服务
class RiskAssessmentService {
    public boolean assessRisk(PaymentRequest request) {
        System.out.println("执行风险评估 - 订单: " + request.getOrderId());
        
        // 模拟风险评估逻辑
        BigDecimal amount = request.getAmount();
        if (amount.compareTo(new BigDecimal("10000")) > 0) {
            System.out.println("高风险交易 - 金额过大: " + amount);
            return false;
        }
        
        // 检查客户信息
        String customerEmail = request.getCustomerInfo().get("email");
        if (customerEmail == null || !customerEmail.contains("@")) {
            System.out.println("风险警告 - 客户邮箱无效");
            return false;
        }
        
        System.out.println("风险评估通过");
        return true;
    }
    
    public double calculateRiskScore(PaymentRequest request) {
        // 模拟风险评分计算
        double score = 0.1; // 基础风险分
        
        if (request.getAmount().compareTo(new BigDecimal("1000")) > 0) {
            score += 0.2;
        }
        
        if (request.getPaymentMethod() == PaymentMethod.CREDIT_CARD) {
            score += 0.1;
        }
        
        return Math.min(score, 1.0);
    }
}

// 子系统 - 支付网关服务
class PaymentGatewayService {
    private Map<PaymentMethod, String> gatewayUrls;
    
    public PaymentGatewayService() {
        gatewayUrls = new HashMap<>();
        gatewayUrls.put(PaymentMethod.CREDIT_CARD, "https://creditcard-gateway.com");
        gatewayUrls.put(PaymentMethod.PAYPAL, "https://paypal-gateway.com");
        gatewayUrls.put(PaymentMethod.ALIPAY, "https://alipay-gateway.com");
        gatewayUrls.put(PaymentMethod.WECHAT_PAY, "https://wechatpay-gateway.com");
    }
    
    public PaymentResponse processPayment(PaymentRequest request) {
        System.out.println("处理支付 - 网关: " + request.getPaymentMethod());
        
        String gatewayUrl = gatewayUrls.get(request.getPaymentMethod());
        if (gatewayUrl == null) {
            return new PaymentResponse(null, PaymentStatus.FAILED, "不支持的支付方式");
        }
        
        // 模拟网关处理
        try {
            Thread.sleep(1000); // 模拟网络延迟
            
            // 模拟支付处理结果
            String transactionId = "TXN_" + System.currentTimeMillis();
            PaymentResponse response = new PaymentResponse(transactionId, PaymentStatus.SUCCESS, "支付成功");
            response.setProcessedAmount(request.getAmount());
            response.addAdditionalInfo("gateway", gatewayUrl);
            response.addAdditionalInfo("paymentMethod", request.getPaymentMethod().toString());
            
            System.out.println("支付处理成功 - 交易ID: " + transactionId);
            return response;
            
        } catch (InterruptedException e) {
            return new PaymentResponse(null, PaymentStatus.FAILED, "支付处理超时");
        }
    }
    
    public PaymentResponse refundPayment(String transactionId, BigDecimal amount) {
        System.out.println("处理退款 - 交易ID: " + transactionId + ", 金额: " + amount);
        
        // 模拟退款处理
        String refundId = "REF_" + System.currentTimeMillis();
        PaymentResponse response = new PaymentResponse(refundId, PaymentStatus.REFUNDED, "退款成功");
        response.setProcessedAmount(amount);
        
        return response;
    }
}

// 子系统 - 通知服务
class NotificationService {
    public void sendPaymentNotification(PaymentRequest request, PaymentResponse response) {
        System.out.println("发送支付通知:");
        System.out.println("  收件人: " + request.getCustomerInfo().get("email"));
        System.out.println("  订单号: " + request.getOrderId());
        System.out.println("  交易状态: " + response.getStatus());
        System.out.println("  交易金额: " + response.getProcessedAmount());
        
        // 模拟发送邮件
        if (response.getStatus() == PaymentStatus.SUCCESS) {
            System.out.println("✅ 支付成功通知已发送");
        } else {
            System.out.println("❌ 支付失败通知已发送");
        }
    }
    
    public void sendSMSNotification(String phoneNumber, String message) {
        System.out.println("发送短信通知到 " + phoneNumber + ": " + message);
    }
    
    public void sendWebhookNotification(String webhookUrl, PaymentResponse response) {
        System.out.println("发送Webhook通知到 " + webhookUrl);
        System.out.println("通知内容: " + response.getTransactionId() + " - " + response.getStatus());
    }
}

// 子系统 - 审计日志服务
class AuditLogService {
    private List<String> auditLogs;
    
    public AuditLogService() {
        this.auditLogs = new ArrayList<>();
    }
    
    public void logPaymentAttempt(PaymentRequest request) {
        String logEntry = String.format("[%s] 支付尝试 - 订单: %s, 金额: %s, 支付方式: %s",
                new Date(), request.getOrderId(), request.getAmount(), request.getPaymentMethod());
        auditLogs.add(logEntry);
        System.out.println("审计日志: " + logEntry);
    }
    
    public void logPaymentResult(PaymentResponse response) {
        String logEntry = String.format("[%s] 支付结果 - 交易ID: %s, 状态: %s",
                new Date(), response.getTransactionId(), response.getStatus());
        auditLogs.add(logEntry);
        System.out.println("审计日志: " + logEntry);
    }
    
    public void logRiskAssessment(String orderId, boolean passed, double riskScore) {
        String logEntry = String.format("[%s] 风险评估 - 订单: %s, 通过: %s, 风险分: %.2f",
                new Date(), orderId, passed, riskScore);
        auditLogs.add(logEntry);
        System.out.println("审计日志: " + logEntry);
    }
    
    public List<String> getAuditLogs() {
        return new ArrayList<>(auditLogs);
    }
}

// 子系统 - 数据库服务
class DatabaseService {
    private Map<String, PaymentRequest> paymentRequests;
    private Map<String, PaymentResponse> paymentResponses;
    
    public DatabaseService() {
        this.paymentRequests = new HashMap<>();
        this.paymentResponses = new HashMap<>();
    }
    
    public void savePaymentRequest(PaymentRequest request) {
        paymentRequests.put(request.getOrderId(), request);
        System.out.println("支付请求已保存到数据库 - 订单: " + request.getOrderId());
    }
    
    public void savePaymentResponse(String orderId, PaymentResponse response) {
        paymentResponses.put(orderId, response);
        System.out.println("支付响应已保存到数据库 - 订单: " + orderId);
    }
    
    public PaymentRequest getPaymentRequest(String orderId) {
        return paymentRequests.get(orderId);
    }
    
    public PaymentResponse getPaymentResponse(String orderId) {
        return paymentResponses.get(orderId);
    }
    
    public void updatePaymentStatus(String orderId, PaymentStatus status) {
        PaymentResponse response = paymentResponses.get(orderId);
        if (response != null) {
            // 在实际实现中，这里会更新数据库记录
            System.out.println("更新支付状态 - 订单: " + orderId + ", 状态: " + status);
        }
    }
}

// 外观类 - 支付处理外观
class PaymentProcessingFacade {
    private RiskAssessmentService riskService;
    private PaymentGatewayService gatewayService;
    private NotificationService notificationService;
    private AuditLogService auditService;
    private DatabaseService databaseService;
    
    public PaymentProcessingFacade() {
        this.riskService = new RiskAssessmentService();
        this.gatewayService = new PaymentGatewayService();
        this.notificationService = new NotificationService();
        this.auditService = new AuditLogService();
        this.databaseService = new DatabaseService();
    }
    
    // 简化的接口 - 处理支付
    public PaymentResponse processPayment(PaymentRequest request) {
        System.out.println("=== 开始处理支付 ===");
        
        try {
            // 1. 记录审计日志
            auditService.logPaymentAttempt(request);
            
            // 2. 保存支付请求
            databaseService.savePaymentRequest(request);
            
            // 3. 风险评估
            boolean riskPassed = riskService.assessRisk(request);
            double riskScore = riskService.calculateRiskScore(request);
            auditService.logRiskAssessment(request.getOrderId(), riskPassed, riskScore);
            
            if (!riskPassed) {
                PaymentResponse failedResponse = new PaymentResponse(
                    null, PaymentStatus.FAILED, "风险评估未通过");
                
                // 保存失败响应
                databaseService.savePaymentResponse(request.getOrderId(), failedResponse);
                auditService.logPaymentResult(failedResponse);
                
                // 发送失败通知
                notificationService.sendPaymentNotification(request, failedResponse);
                
                return failedResponse;
            }
            
            // 4. 处理支付
            PaymentResponse response = gatewayService.processPayment(request);
            
            // 5. 保存支付响应
            databaseService.savePaymentResponse(request.getOrderId(), response);
            auditService.logPaymentResult(response);
            
            // 6. 发送通知
            notificationService.sendPaymentNotification(request, response);
            
            // 7. 如果有webhook URL，发送webhook通知
            String webhookUrl = request.getMetadata().get("webhookUrl");
            if (webhookUrl != null) {
                notificationService.sendWebhookNotification(webhookUrl, response);
            }
            
            // 8. 如果有手机号，发送短信通知
            String phoneNumber = request.getCustomerInfo().get("phone");
            if (phoneNumber != null && response.getStatus() == PaymentStatus.SUCCESS) {
                notificationService.sendSMSNotification(phoneNumber, 
                    "您的订单 " + request.getOrderId() + " 支付成功，金额: " + response.getProcessedAmount());
            }
            
            System.out.println("=== 支付处理完成 ===");
            return response;
            
        } catch (Exception e) {
            System.err.println("支付处理异常: " + e.getMessage());
            PaymentResponse errorResponse = new PaymentResponse(
                null, PaymentStatus.FAILED, "系统异常: " + e.getMessage());
            
            auditService.logPaymentResult(errorResponse);
            return errorResponse;
        }
    }
    
    // 简化的接口 - 处理退款
    public PaymentResponse processRefund(String orderId, BigDecimal refundAmount) {
        System.out.println("=== 开始处理退款 ===");
        
        try {
            // 1. 获取原始支付记录
            PaymentRequest originalRequest = databaseService.getPaymentRequest(orderId);
            PaymentResponse originalResponse = databaseService.getPaymentResponse(orderId);
            
            if (originalRequest == null || originalResponse == null) {
                return new PaymentResponse(null, PaymentStatus.FAILED, "找不到原始支付记录");
            }
            
            if (originalResponse.getStatus() != PaymentStatus.SUCCESS) {
                return new PaymentResponse(null, PaymentStatus.FAILED, "原始支付未成功，无法退款");
            }
            
            // 2. 验证退款金额
            if (refundAmount.compareTo(originalResponse.getProcessedAmount()) > 0) {
                return new PaymentResponse(null, PaymentStatus.FAILED, "退款金额超过原始支付金额");
            }
            
            // 3. 处理退款
            PaymentResponse refundResponse = gatewayService.refundPayment(
                originalResponse.getTransactionId(), refundAmount);
            
            // 4. 更新数据库状态
            databaseService.updatePaymentStatus(orderId, PaymentStatus.REFUNDED);
            
            // 5. 记录审计日志
            auditService.logPaymentResult(refundResponse);
            
            // 6. 发送退款通知
            notificationService.sendPaymentNotification(originalRequest, refundResponse);
            
            System.out.println("=== 退款处理完成 ===");
            return refundResponse;
            
        } catch (Exception e) {
            System.err.println("退款处理异常: " + e.getMessage());
            return new PaymentResponse(null, PaymentStatus.FAILED, "退款处理异常: " + e.getMessage());
        }
    }
    
    // 简化的接口 - 查询支付状态
    public PaymentResponse queryPaymentStatus(String orderId) {
        System.out.println("查询支付状态 - 订单: " + orderId);
        
        PaymentResponse response = databaseService.getPaymentResponse(orderId);
        if (response == null) {
            return new PaymentResponse(null, PaymentStatus.FAILED, "找不到支付记录");
        }
        
        return response;
    }
    
    // 简化的接口 - 获取审计日志
    public List<String> getAuditLogs() {
        return auditService.getAuditLogs();
    }
    
    // 简化的接口 - 批量处理支付
    public List<PaymentResponse> batchProcessPayments(List<PaymentRequest> requests) {
        System.out.println("=== 开始批量处理支付 ===");
        List<PaymentResponse> responses = new ArrayList<>();
        
        for (PaymentRequest request : requests) {
            try {
                PaymentResponse response = processPayment(request);
                responses.add(response);
                
                // 批量处理时添加短暂延迟，避免过快请求
                Thread.sleep(100);
                
            } catch (Exception e) {
                PaymentResponse errorResponse = new PaymentResponse(
                    null, PaymentStatus.FAILED, "批量处理异常: " + e.getMessage());
                responses.add(errorResponse);
            }
        }
        
        System.out.println("=== 批量处理完成 ===");
        return responses;
    }
}

// 使用示例
public class PaymentFacadeExample {
    public static void main(String[] args) {
        // 创建支付处理外观
        PaymentProcessingFacade paymentFacade = new PaymentProcessingFacade();
        
        // 创建支付请求
        PaymentRequest request1 = new PaymentRequest(
            "ORDER_001", new BigDecimal("299.99"), "CNY", PaymentMethod.ALIPAY);
        request1.addCustomerInfo("email", "customer@example.com");
        request1.addCustomerInfo("phone", "13800138000");
        request1.addMetadata("webhookUrl", "https://merchant.com/webhook");
        
        // 处理支付
        System.out.println("=== 处理单笔支付 ===");
        PaymentResponse response1 = paymentFacade.processPayment(request1);
        System.out.println("支付结果: " + response1.getStatus() + " - " + response1.getMessage());
        
        // 查询支付状态
        System.out.println("\n=== 查询支付状态 ===");
        PaymentResponse statusResponse = paymentFacade.queryPaymentStatus("ORDER_001");
        System.out.println("支付状态: " + statusResponse.getStatus());
        
        // 处理退款
        if (response1.getStatus() == PaymentStatus.SUCCESS) {
            System.out.println("\n=== 处理退款 ===");
            PaymentResponse refundResponse = paymentFacade.processRefund(
                "ORDER_001", new BigDecimal("100.00"));
            System.out.println("退款结果: " + refundResponse.getStatus() + " - " + refundResponse.getMessage());
        }
        
        // 批量处理支付
        System.out.println("\n=== 批量处理支付 ===");
        List<PaymentRequest> batchRequests = Arrays.asList(
            createPaymentRequest("ORDER_002", "199.99", PaymentMethod.WECHAT_PAY),
            createPaymentRequest("ORDER_003", "399.99", PaymentMethod.CREDIT_CARD),
            createPaymentRequest("ORDER_004", "99.99", PaymentMethod.PAYPAL)
        );
        
        List<PaymentResponse> batchResponses = paymentFacade.batchProcessPayments(batchRequests);
        
        System.out.println("批量处理结果:");
        for (int i = 0; i < batchResponses.size(); i++) {
            PaymentResponse response = batchResponses.get(i);
            System.out.printf("  订单 %d: %s - %s%n", 
                i + 1, response.getStatus(), response.getMessage());
        }
        
        // 显示审计日志
        System.out.println("\n=== 审计日志 ===");
        List<String> auditLogs = paymentFacade.getAuditLogs();
        auditLogs.forEach(System.out::println);
    }
    
    private static PaymentRequest createPaymentRequest(String orderId, String amount, PaymentMethod method) {
        PaymentRequest request = new PaymentRequest(
            orderId, new BigDecimal(amount), "CNY", method);
        request.addCustomerInfo("email", "batch@example.com");
        request.addCustomerInfo("phone", "13900139000");
        return request;
    }
}
```

**外观模式的关键特点：**
1. **简化接口**: 为复杂的子系统提供简单统一的接口
2. **降低耦合**: 客户端与子系统之间的耦合度降低
3. **更好的分层**: 定义了子系统中每层的入口点
4. **不限制功能**: 客户端仍可以直接访问子系统类
5. **易于使用**: 大多数客户端只需要使用外观接口

#### 实现概念
- **简单外观**：提供简单的统一接口
- **复杂外观**：提供多个层次的接口
- **抽象外观**：定义外观的抽象接口
# 设计模式完整概念汇总

## 第一部分：基础理论概念

### 1. 设计模式基本概念

#### 1.1 核心定义

##### 设计模式 (Design Pattern)
- **GoF原定义**：*"设计模式是在特定环境下人们解决某类重复出现问题的一套成功或有效的解决方案。"*
- **扩展定义**：在特定环境下，为解决某一通用软件设计问题提供的一套定制的解决方案
- **本质**：可复用的面向对象软件设计经验

#### 基础例子：日常生活中的模式
```
建筑设计模式：
- 问题：如何设计一个既美观又实用的房屋入口？
- 解决方案：门廊模式 - 在主入口前设置一个有顶棚的过渡空间
- 效果：提供遮风挡雨的缓冲区，增加建筑美感

软件设计模式：
- 问题：如何确保一个类只有一个实例？
- 解决方案：单例模式 - 控制类的实例化过程
- 效果：节省内存，保证全局唯一性
```

#### 进阶例子：企业级应用中的模式思维
```java
// 传统方式 - 没有模式思维
public class OrderProcessor {
    public void processOrder(Order order) {
        // 验证订单
        if (order.getItems().isEmpty()) {
            throw new IllegalArgumentException("订单不能为空");
        }
        
        // 计算价格
        double total = 0;
        for (OrderItem item : order.getItems()) {
            total += item.getPrice() * item.getQuantity();
        }
        
        // 发送邮件
        EmailService emailService = new EmailService();
        emailService.sendOrderConfirmation(order.getCustomerEmail(), order);
        
        // 更新库存
        InventoryService inventoryService = new InventoryService();
        inventoryService.updateStock(order.getItems());
        
        // 记录日志
        System.out.println("订单处理完成: " + order.getId());
    }
}

// 使用模式思维重构
public class OrderProcessor {
    private List<OrderValidator> validators;
    private PricingStrategy pricingStrategy;
    private List<OrderEventListener> eventListeners;
    
    public OrderProcessor() {
        // 责任链模式 - 验证器链
        this.validators = Arrays.asList(
            new EmptyOrderValidator(),
            new CustomerValidator(),
            new InventoryValidator()
        );
        
        // 策略模式 - 定价策略
        this.pricingStrategy = new StandardPricingStrategy();
        
        // 观察者模式 - 事件监听器
        this.eventListeners = Arrays.asList(
            new EmailNotificationListener(),
            new InventoryUpdateListener(),
            new LoggingListener()
        );
    }
    
    public void processOrder(Order order) {
        // 使用责任链验证
        for (OrderValidator validator : validators) {
            validator.validate(order);
        }
        
        // 使用策略计算价格
        double total = pricingStrategy.calculateTotal(order);
        order.setTotal(total);
        
        // 使用观察者通知各个服务
        OrderProcessedEvent event = new OrderProcessedEvent(order);
        eventListeners.forEach(listener -> listener.onOrderProcessed(event));
    }
}
```

##### 模式语言 (Pattern Language)
- **Alexander原定义**：*"每个模式描述了一个在我们周围不断重复发生的问题，以及该问题的解决方案的核心。"*
- **软件领域定义**：描述设计问题、解决方案和效果的标准化语言
- **作用**：为设计者提供共同的词汇和交流方式

##### 可复用性 (Reusability)
- **定义**：模式可以在不同的软件系统中重复使用
- **层次**：设计复用比代码复用更高层次
- **价值**：避免重新发明轮子，提高开发效率

##### 最佳实践 (Best Practice)
- **定义**：经过验证的、优秀的设计经验总结
- **特征**：经过时间检验，被广泛认可和应用
- **来源**：专家经验的结晶和总结

#### 1.2 模式要素
- **模式名称**：简洁描述设计问题、解决方案和效果的词汇
- **问题**：描述何时使用该模式，包括设计问题和问题的前因后果
- **解决方案**：描述设计的组成成分、关系、职责和协作方式
- **效果**：使用模式的结果和权衡，包括对灵活性、扩展性的影响

#### 1.3 模式分类
- **创建型模式**：处理对象创建机制，将对象的创建和使用分离
- **结构型模式**：处理对象和类的组合，形成更大的结构
- **行为型模式**：处理对象间的通信和职责分配

### 2. UML建模概念

#### 2.1 类图概念
- **类**：具有相同属性和方法的对象集合的抽象
- **属性**：类的数据成员，描述对象的状态
- **方法**：类的函数成员，描述对象的行为
- **访问修饰符**：控制类成员的可见性（public、private、protected、package）
- **静态成员**：属于类而不是实例的成员
- **抽象类**：不能实例化的类，通常包含抽象方法
- **接口**：定义类必须实现的方法契约

#### 2.2 类间关系概念
- **继承/泛化**：子类继承父类的属性和方法，is-a关系
- **实现**：类实现接口定义的方法契约
- **依赖**：一个类使用另一个类，临时性的uses-a关系
- **关联**：类之间的结构化关系，长期性的has-a关系
- **聚合**：整体-部分关系，部分可以独立于整体存在
- **组合**：强整体-部分关系，部分不能独立于整体存在
- **多重性**：关系中对象的数量约束

#### 2.3 动态图概念
- **时序图**：按时间顺序显示对象间的交互
- **协作图**：强调对象间的组织结构和消息传递
- **状态图**：描述对象在生命周期内的状态变化
- **活动图**：描述系统的工作流程和业务过程

### 3. 面向对象设计原则概念

#### 3.1 SOLID原则
- **单一职责原则(SRP)**：一个类应该只有一个引起变化的原因
- **开放-封闭原则(OCP)**：对扩展开放，对修改封闭
- **里氏替换原则(LSP)**：子类对象应该能够替换父类对象
- **接口隔离原则(ISP)**：客户端不应该依赖不需要的接口
- **依赖倒置原则(DIP)**：依赖于抽象，而不是具体实现

#### 3.2 其他重要原则
- **迪米特法则(LoD)**：一个对象应该对其他对象有最少的了解
- **合成/聚合复用原则(CARP)**：优先使用组合而不是继承来实现复用

## 第二部分：创建型模式概念

### 1. 单例模式 (Singleton)

#### 核心概念
- **单例**：确保一个类只有一个实例，并提供全局访问点
- **实例控制**：控制类的实例化过程
- **全局访问**：提供访问唯一实例的全局方法
- **延迟初始化**：在需要时才创建实例

#### 基础例子：简单的配置管理器
```java
// 饿汉式单例 - 最简单的实现
public class ConfigManager {
    // 类加载时就创建实例
    private static final ConfigManager INSTANCE = new ConfigManager();
    private Properties config;
    
    // 私有构造函数，防止外部实例化
    private ConfigManager() {
        config = new Properties();
        loadConfig();
    }
    
    // 提供全局访问点
    public static ConfigManager getInstance() {
        return INSTANCE;
    }
    
    private void loadConfig() {
        // 加载配置文件
        config.setProperty("database.url", "jdbc:mysql://localhost:3306/mydb");
        config.setProperty("database.username", "root");
        config.setProperty("cache.size", "1000");
    }
    
    public String getProperty(String key) {
        return config.getProperty(key);
    }
    
    public void setProperty(String key, String value) {
        config.setProperty(key, value);
    }
}

// 使用示例
public class Application {
    public static void main(String[] args) {
        // 获取配置管理器实例
        ConfigManager config1 = ConfigManager.getInstance();
        ConfigManager config2 = ConfigManager.getInstance();
        
        // 验证是同一个实例
        System.out.println("是否为同一实例: " + (config1 == config2)); // true
        
        // 使用配置
        String dbUrl = config1.getProperty("database.url");
        System.out.println("数据库URL: " + dbUrl);
        
        // 修改配置
        config1.setProperty("app.name", "MyApplication");
        String appName = config2.getProperty("app.name");
        System.out.println("应用名称: " + appName); // MyApplication
    }
}
```

#### 进阶例子：线程安全的数据库连接池
```java
import java.sql.*;
import java.util.concurrent.BlockingQueue;
import java.util.concurrent.LinkedBlockingQueue;
import java.util.concurrent.atomic.AtomicInteger;

// 双重检查锁定的懒汉式单例
public class DatabaseConnectionPool {
    // 使用volatile确保多线程环境下的可见性
    private static volatile DatabaseConnectionPool instance;
    
    private final BlockingQueue<Connection> connectionPool;
    private final AtomicInteger currentConnections;
    private final int maxConnections;
    private final String jdbcUrl;
    private final String username;
    private final String password;
    
    // 私有构造函数
    private DatabaseConnectionPool() {
        this.maxConnections = 10;
        this.currentConnections = new AtomicInteger(0);
        this.connectionPool = new LinkedBlockingQueue<>(maxConnections);
        this.jdbcUrl = "jdbc:mysql://localhost:3306/mydb";
        this.username = "root";
        this.password = "password";
        
        // 初始化连接池
        initializePool();
    }
    
    // 双重检查锁定获取实例
    public static DatabaseConnectionPool getInstance() {
        if (instance == null) {
            synchronized (DatabaseConnectionPool.class) {
                if (instance == null) {
                    instance = new DatabaseConnectionPool();
                }
            }
        }
        return instance;
    }
    
    private void initializePool() {
        try {
            // 预创建一些连接
            for (int i = 0; i < 3; i++) {
                Connection conn = createConnection();
                if (conn != null) {
                    connectionPool.offer(conn);
                    currentConnections.incrementAndGet();
                }
            }
        } catch (SQLException e) {
            System.err.println("初始化连接池失败: " + e.getMessage());
        }
    }
    
    private Connection createConnection() throws SQLException {
        return DriverManager.getConnection(jdbcUrl, username, password);
    }
    
    // 获取连接
    public Connection getConnection() throws SQLException, InterruptedException {
        Connection conn = connectionPool.poll();
        
        if (conn == null && currentConnections.get() < maxConnections) {
            // 如果池中没有连接且未达到最大连接数，创建新连接
            synchronized (this) {
                if (currentConnections.get() < maxConnections) {
                    conn = createConnection();
                    currentConnections.incrementAndGet();
                }
            }
        }
        
        if (conn == null) {
            // 等待可用连接
            conn = connectionPool.take();
        }
        
        return conn;
    }
    
    // 归还连接
    public void returnConnection(Connection conn) {
        if (conn != null) {
            try {
                if (!conn.isClosed()) {
                    connectionPool.offer(conn);
                } else {
                    currentConnections.decrementAndGet();
                }
            } catch (SQLException e) {
                System.err.println("检查连接状态失败: " + e.getMessage());
                currentConnections.decrementAndGet();
            }
        }
    }
    
    // 关闭连接池
    public void shutdown() {
        while (!connectionPool.isEmpty()) {
            try {
                Connection conn = connectionPool.poll();
                if (conn != null && !conn.isClosed()) {
                    conn.close();
                }
            } catch (SQLException e) {
                System.err.println("关闭连接失败: " + e.getMessage());
            }
        }
        currentConnections.set(0);
    }
    
    // 获取连接池状态
    public String getPoolStatus() {
        return String.format("连接池状态 - 当前连接数: %d, 可用连接数: %d, 最大连接数: %d",
                currentConnections.get(), connectionPool.size(), maxConnections);
    }
    
    // 防止序列化破坏单例
    private Object readResolve() {
        return getInstance();
    }
}

// 静态内部类实现（推荐方式）
public class LogManager {
    // 静态内部类，只有在被引用时才会加载
    private static class LogManagerHolder {
        private static final LogManager INSTANCE = new LogManager();
    }
    
    private final String logLevel;
    private final String logFormat;
    
    private LogManager() {
        this.logLevel = "INFO";
        this.logFormat = "[%s] %s - %s";
    }
    
    public static LogManager getInstance() {
        return LogManagerHolder.INSTANCE;
    }
    
    public void log(String level, String message) {
        String timestamp = java.time.LocalDateTime.now().toString();
        String formattedMessage = String.format(logFormat, timestamp, level, message);
        System.out.println(formattedMessage);
    }
    
    public void info(String message) {
        log("INFO", message);
    }
    
    public void error(String message) {
        log("ERROR", message);
    }
    
    public void debug(String message) {
        if ("DEBUG".equals(logLevel)) {
            log("DEBUG", message);
        }
    }
}

// 枚举实现（最安全的方式）
public enum CacheManager {
    INSTANCE;
    
    private final Map<String, Object> cache;
    
    CacheManager() {
        this.cache = new ConcurrentHashMap<>();
    }
    
    public void put(String key, Object value) {
        cache.put(key, value);
    }
    
    public Object get(String key) {
        return cache.get(key);
    }
    
    public void remove(String key) {
        cache.remove(key);
    }
    
    public void clear() {
        cache.clear();
    }
    
    public int size() {
        return cache.size();
    }
}

// 多线程测试示例
public class SingletonTest {
    public static void main(String[] args) throws InterruptedException {
        // 测试数据库连接池单例
        testDatabaseConnectionPool();
        
        // 测试日志管理器单例
        testLogManager();
        
        // 测试缓存管理器单例
        testCacheManager();
    }
    
    private static void testDatabaseConnectionPool() throws InterruptedException {
        System.out.println("=== 测试数据库连接池单例 ===");
        
        // 创建多个线程同时获取实例
        Thread[] threads = new Thread[5];
        DatabaseConnectionPool[] instances = new DatabaseConnectionPool[5];
        
        for (int i = 0; i < 5; i++) {
            final int index = i;
            threads[i] = new Thread(() -> {
                instances[index] = DatabaseConnectionPool.getInstance();
                System.out.println("线程 " + index + " 获取实例: " + instances[index].hashCode());
            });
        }
        
        // 启动所有线程
        for (Thread thread : threads) {
            thread.start();
        }
        
        // 等待所有线程完成
        for (Thread thread : threads) {
            thread.join();
        }
        
        // 验证所有实例是否相同
        boolean allSame = true;
        for (int i = 1; i < instances.length; i++) {
            if (instances[i] != instances[0]) {
                allSame = false;
                break;
            }
        }
        
        System.out.println("所有实例是否相同: " + allSame);
        System.out.println(instances[0].getPoolStatus());
        System.out.println();
    }
    
    private static void testLogManager() {
        System.out.println("=== 测试日志管理器单例 ===");
        
        LogManager logger1 = LogManager.getInstance();
        LogManager logger2 = LogManager.getInstance();
        
        System.out.println("是否为同一实例: " + (logger1 == logger2));
        
        logger1.info("这是一条信息日志");
        logger2.error("这是一条错误日志");
        logger1.debug("这是一条调试日志");
        System.out.println();
    }
    
    private static void testCacheManager() {
        System.out.println("=== 测试缓存管理器单例 ===");
        
        CacheManager cache1 = CacheManager.INSTANCE;
        CacheManager cache2 = CacheManager.INSTANCE;
        
        System.out.println("是否为同一实例: " + (cache1 == cache2));
        
        cache1.put("user:1", "张三");
        cache1.put("user:2", "李四");
        
        System.out.println("缓存大小: " + cache2.size());
        System.out.println("用户1: " + cache2.get("user:1"));
        System.out.println("用户2: " + cache2.get("user:2"));
        System.out.println();
    }
}
```

#### 实现概念
- **饿汉式**：类加载时就创建实例
- **懒汉式**：第一次使用时才创建实例
- **双重检查锁定**：线程安全的懒汉式实现
- **静态内部类**：利用类加载机制保证线程安全
- **枚举实现**：最简洁的单例实现方式

#### 相关概念
- **线程安全**：多线程环境下的正确性
- **序列化安全**：序列化后不破坏单例特性
- **反射安全**：防止通过反射创建多个实例

### 2. 工厂方法模式 (Factory Method)

#### 核心概念
- **工厂方法**：定义创建对象的接口，让子类决定实例化哪个类
- **产品**：工厂创建的对象
- **创建者**：包含工厂方法的类
- **延迟实例化**：将对象创建延迟到子类

#### 基础例子：图形绘制工厂
```java
// 产品接口
interface Shape {
    void draw();
}

// 具体产品
class Circle implements Shape {
    @Override
    public void draw() {
        System.out.println("绘制圆形");
    }
}

class Rectangle implements Shape {
    @Override
    public void draw() {
        System.out.println("绘制矩形");
    }
}

// 抽象工厂
abstract class ShapeFactory {
    // 工厂方法
    public abstract Shape createShape();
    
    // 模板方法
    public void drawShape() {
        Shape shape = createShape();
        shape.draw();
    }
}

// 具体工厂
class CircleFactory extends ShapeFactory {
    @Override
    public Shape createShape() {
        return new Circle();
    }
}

class RectangleFactory extends ShapeFactory {
    @Override
    public Shape createShape() {
        return new Rectangle();
    }
}

// 使用示例
public class FactoryMethodExample {
    public static void main(String[] args) {
        ShapeFactory circleFactory = new CircleFactory();
        circleFactory.drawShape(); // 输出: 绘制圆形
        
        ShapeFactory rectangleFactory = new RectangleFactory();
        rectangleFactory.drawShape(); // 输出: 绘制矩形
    }
}
```

#### 进阶例子：数据库连接工厂系统
```java
// 数据库连接接口
interface DatabaseConnection {
    void connect();
    void executeQuery(String sql);
    void close();
    String getConnectionInfo();
}

// MySQL连接实现
class MySQLConnection implements DatabaseConnection {
    private String host;
    private int port;
    private String database;
    
    public MySQLConnection(String host, int port, String database) {
        this.host = host;
        this.port = port;
        this.database = database;
    }
    
    @Override
    public void connect() {
        System.out.println("连接到MySQL数据库: " + getConnectionInfo());
    }
    
    @Override
    public void executeQuery(String sql) {
        System.out.println("在MySQL中执行查询: " + sql);
    }
    
    @Override
    public void close() {
        System.out.println("关闭MySQL连接");
    }
    
    @Override
    public String getConnectionInfo() {
        return String.format("mysql://%s:%d/%s", host, port, database);
    }
}

// PostgreSQL连接实现
class PostgreSQLConnection implements DatabaseConnection {
    private String host;
    private int port;
    private String database;
    
    public PostgreSQLConnection(String host, int port, String database) {
        this.host = host;
        this.port = port;
        this.database = database;
    }
    
    @Override
    public void connect() {
        System.out.println("连接到PostgreSQL数据库: " + getConnectionInfo());
    }
    
    @Override
    public void executeQuery(String sql) {
        System.out.println("在PostgreSQL中执行查询: " + sql);
    }
    
    @Override
    public void close() {
        System.out.println("关闭PostgreSQL连接");
    }
    
    @Override
    public String getConnectionInfo() {
        return String.format("postgresql://%s:%d/%s", host, port, database);
    }
}

// 抽象数据库工厂
abstract class DatabaseFactory {
    // 工厂方法 - 由子类实现
    public abstract DatabaseConnection createConnection();
    
    // 模板方法 - 定义标准的数据库操作流程
    public void performDatabaseOperation(String sql) {
        DatabaseConnection connection = null;
        try {
            connection = createConnection();
            connection.connect();
            connection.executeQuery(sql);
        } catch (Exception e) {
            System.err.println("数据库操作失败: " + e.getMessage());
        } finally {
            if (connection != null) {
                connection.close();
            }
        }
    }
    
    // 批量操作
    public void performBatchOperations(String[] sqlStatements) {
        DatabaseConnection connection = null;
        try {
            connection = createConnection();
            connection.connect();
            System.out.println("开始批量操作...");
            for (String sql : sqlStatements) {
                connection.executeQuery(sql);
            }
            System.out.println("批量操作完成");
        } catch (Exception e) {
            System.err.println("批量操作失败: " + e.getMessage());
        } finally {
            if (connection != null) {
                connection.close();
            }
        }
    }
}

// MySQL工厂
class MySQLFactory extends DatabaseFactory {
    private String host;
    private int port;
    private String database;
    
    public MySQLFactory(String host, int port, String database) {
        this.host = host;
        this.port = port;
        this.database = database;
    }
    
    @Override
    public DatabaseConnection createConnection() {
        return new MySQLConnection(host, port, database);
    }
}

// PostgreSQL工厂
class PostgreSQLFactory extends DatabaseFactory {
    private String host;
    private int port;
    private String database;
    
    public PostgreSQLFactory(String host, int port, String database) {
        this.host = host;
        this.port = port;
        this.database = database;
    }
    
    @Override
    public DatabaseConnection createConnection() {
        return new PostgreSQLConnection(host, port, database);
    }
}

// 数据库工厂管理器
class DatabaseFactoryManager {
    private static final Map<String, DatabaseFactory> factories = new HashMap<>();
    
    public static void registerFactory(String type, DatabaseFactory factory) {
        factories.put(type.toLowerCase(), factory);
    }
    
    public static DatabaseFactory getFactory(String type) {
        DatabaseFactory factory = factories.get(type.toLowerCase());
        if (factory == null) {
            throw new IllegalArgumentException("不支持的数据库类型: " + type);
        }
        return factory;
    }
    
    public static Set<String> getSupportedTypes() {
        return factories.keySet();
    }
}

// 使用示例
public class DatabaseFactoryExample {
    public static void main(String[] args) {
        // 注册工厂
        DatabaseFactoryManager.registerFactory("mysql", 
            new MySQLFactory("localhost", 3306, "testdb"));
        DatabaseFactoryManager.registerFactory("postgresql", 
            new PostgreSQLFactory("localhost", 5432, "testdb"));
        
        // 使用MySQL
        DatabaseFactory mysqlFactory = DatabaseFactoryManager.getFactory("mysql");
        mysqlFactory.performDatabaseOperation("SELECT * FROM users");
        
        // 使用PostgreSQL
        DatabaseFactory postgresFactory = DatabaseFactoryManager.getFactory("postgresql");
        String[] batchSql = {
            "INSERT INTO users (name, email) VALUES ('张三', 'zhangsan@example.com')",
            "INSERT INTO users (name, email) VALUES ('李四', 'lisi@example.com')",
            "UPDATE users SET status = 'active' WHERE id > 0"
        };
        postgresFactory.performBatchOperations(batchSql);
        
        // 显示支持的数据库类型
        System.out.println("支持的数据库类型: " + 
            DatabaseFactoryManager.getSupportedTypes());
    }
}
```

**工厂方法模式的关键特点：**
1. **延迟决策**: 将对象创建的决策推迟到子类
2. **符合开放-封闭原则**: 新增产品类型只需添加新的工厂类
3. **消除耦合**: 客户端代码不依赖具体的产品类
4. **模板方法结合**: 工厂类可以定义创建对象后的标准操作流程

#### 参与者概念
- **抽象产品**：定义产品的接口
- **具体产品**：实现产品接口的具体类
- **抽象创建者**：声明工厂方法的抽象类
- **具体创建者**：实现工厂方法的具体类

#### 相关概念
- **简单工厂**：用一个类来创建所有产品
- **参数化工厂**：根据参数决定创建哪种产品
- **泛型工厂**：使用泛型的工厂实现

### 3. 抽象工厂模式 (Abstract Factory)

#### 核心概念
- **抽象工厂**：提供创建一系列相关对象的接口
- **产品族**：一组相关的产品对象
- **产品等级结构**：产品的继承层次
- **产品一致性**：确保创建的产品属于同一族

#### 基础例子：GUI组件工厂
```java
// 抽象产品 - 按钮
interface Button {
    void paint();
    void click();
}

// 抽象产品 - 文本框
interface TextField {
    void paint();
    void setText(String text);
    String getText();
}

// Windows风格的具体产品
class WindowsButton implements Button {
    @Override
    public void paint() {
        System.out.println("绘制Windows风格按钮");
    }
    
    @Override
    public void click() {
        System.out.println("Windows按钮被点击");
    }
}

class WindowsTextField implements TextField {
    private String text = "";
    
    @Override
    public void paint() {
        System.out.println("绘制Windows风格文本框");
    }
    
    @Override
    public void setText(String text) {
        this.text = text;
        System.out.println("Windows文本框设置文本: " + text);
    }
    
    @Override
    public String getText() {
        return text;
    }
}

// Mac风格的具体产品
class MacButton implements Button {
    @Override
    public void paint() {
        System.out.println("绘制Mac风格按钮");
    }
    
    @Override
    public void click() {
        System.out.println("Mac按钮被点击");
    }
}

class MacTextField implements TextField {
    private String text = "";
    
    @Override
    public void paint() {
        System.out.println("绘制Mac风格文本框");
    }
    
    @Override
    public void setText(String text) {
        this.text = text;
        System.out.println("Mac文本框设置文本: " + text);
    }
    
    @Override
    public String getText() {
        return text;
    }
}

// 抽象工厂
interface GUIFactory {
    Button createButton();
    TextField createTextField();
}

// 具体工厂
class WindowsFactory implements GUIFactory {
    @Override
    public Button createButton() {
        return new WindowsButton();
    }
    
    @Override
    public TextField createTextField() {
        return new WindowsTextField();
    }
}

class MacFactory implements GUIFactory {
    @Override
    public Button createButton() {
        return new MacButton();
    }
    
    @Override
    public TextField createTextField() {
        return new MacTextField();
    }
}

// 客户端代码
class Application {
    private Button button;
    private TextField textField;
    
    public Application(GUIFactory factory) {
        button = factory.createButton();
        textField = factory.createTextField();
    }
    
    public void paint() {
        button.paint();
        textField.paint();
    }
    
    public void interact() {
        textField.setText("Hello World");
        button.click();
        System.out.println("文本框内容: " + textField.getText());
    }
}

// 使用示例
public class AbstractFactoryExample {
    public static void main(String[] args) {
        // 根据操作系统选择工厂
        String osName = System.getProperty("os.name").toLowerCase();
        GUIFactory factory;
        
        if (osName.contains("windows")) {
            factory = new WindowsFactory();
            System.out.println("使用Windows风格界面");
        } else {
            factory = new MacFactory();
            System.out.println("使用Mac风格界面");
        }
        
        Application app = new Application(factory);
        app.paint();
        app.interact();
    }
}
```

#### 进阶例子：跨平台数据库访问工厂
```java
// 抽象产品 - 数据库连接
interface DatabaseConnection {
    void connect();
    void disconnect();
    boolean isConnected();
}

// 抽象产品 - 查询执行器
interface QueryExecutor {
    ResultSet executeQuery(String sql);
    int executeUpdate(String sql);
    void executeBatch(String[] sqls);
}

// 抽象产品 - 事务管理器
interface TransactionManager {
    void beginTransaction();
    void commit();
    void rollback();
    boolean isInTransaction();
}

// MySQL产品族
class MySQLConnection implements DatabaseConnection {
    private boolean connected = false;
    private String connectionString;
    
    public MySQLConnection(String host, int port, String database) {
        this.connectionString = String.format("mysql://%s:%d/%s", host, port, database);
    }
    
    @Override
    public void connect() {
        connected = true;
        System.out.println("连接到MySQL: " + connectionString);
    }
    
    @Override
    public void disconnect() {
        connected = false;
        System.out.println("断开MySQL连接");
    }
    
    @Override
    public boolean isConnected() {
        return connected;
    }
}

class MySQLQueryExecutor implements QueryExecutor {
    private DatabaseConnection connection;
    
    public MySQLQueryExecutor(DatabaseConnection connection) {
        this.connection = connection;
    }
    
    @Override
    public ResultSet executeQuery(String sql) {
        if (!connection.isConnected()) {
            throw new IllegalStateException("数据库未连接");
        }
        System.out.println("MySQL执行查询: " + sql);
        return new MockResultSet("MySQL查询结果");
    }
    
    @Override
    public int executeUpdate(String sql) {
        if (!connection.isConnected()) {
            throw new IllegalStateException("数据库未连接");
        }
        System.out.println("MySQL执行更新: " + sql);
        return 1; // 模拟影响行数
    }
    
    @Override
    public void executeBatch(String[] sqls) {
        if (!connection.isConnected()) {
            throw new IllegalStateException("数据库未连接");
        }
        System.out.println("MySQL执行批量操作:");
        for (String sql : sqls) {
            System.out.println("  - " + sql);
        }
    }
}

class MySQLTransactionManager implements TransactionManager {
    private boolean inTransaction = false;
    private DatabaseConnection connection;
    
    public MySQLTransactionManager(DatabaseConnection connection) {
        this.connection = connection;
    }
    
    @Override
    public void beginTransaction() {
        if (!connection.isConnected()) {
            throw new IllegalStateException("数据库未连接");
        }
        inTransaction = true;
        System.out.println("MySQL开始事务");
    }
    
    @Override
    public void commit() {
        if (!inTransaction) {
            throw new IllegalStateException("没有活动事务");
        }
        inTransaction = false;
        System.out.println("MySQL提交事务");
    }
    
    @Override
    public void rollback() {
        if (!inTransaction) {
            throw new IllegalStateException("没有活动事务");
        }
        inTransaction = false;
        System.out.println("MySQL回滚事务");
    }
    
    @Override
    public boolean isInTransaction() {
        return inTransaction;
    }
}

// PostgreSQL产品族
class PostgreSQLConnection implements DatabaseConnection {
    private boolean connected = false;
    private String connectionString;
    
    public PostgreSQLConnection(String host, int port, String database) {
        this.connectionString = String.format("postgresql://%s:%d/%s", host, port, database);
    }
    
    @Override
    public void connect() {
        connected = true;
        System.out.println("连接到PostgreSQL: " + connectionString);
    }
    
    @Override
    public void disconnect() {
        connected = false;
        System.out.println("断开PostgreSQL连接");
    }
    
    @Override
    public boolean isConnected() {
        return connected;
    }
}

class PostgreSQLQueryExecutor implements QueryExecutor {
    private DatabaseConnection connection;
    
    public PostgreSQLQueryExecutor(DatabaseConnection connection) {
        this.connection = connection;
    }
    
    @Override
    public ResultSet executeQuery(String sql) {
        if (!connection.isConnected()) {
            throw new IllegalStateException("数据库未连接");
        }
        System.out.println("PostgreSQL执行查询: " + sql);
        return new MockResultSet("PostgreSQL查询结果");
    }
    
    @Override
    public int executeUpdate(String sql) {
        if (!connection.isConnected()) {
            throw new IllegalStateException("数据库未连接");
        }
        System.out.println("PostgreSQL执行更新: " + sql);
        return 1;
    }
    
    @Override
    public void executeBatch(String[] sqls) {
        if (!connection.isConnected()) {
            throw new IllegalStateException("数据库未连接");
        }
        System.out.println("PostgreSQL执行批量操作:");
        for (String sql : sqls) {
            System.out.println("  - " + sql);
        }
    }
}

class PostgreSQLTransactionManager implements TransactionManager {
    private boolean inTransaction = false;
    private DatabaseConnection connection;
    
    public PostgreSQLTransactionManager(DatabaseConnection connection) {
        this.connection = connection;
    }
    
    @Override
    public void beginTransaction() {
        if (!connection.isConnected()) {
            throw new IllegalStateException("数据库未连接");
        }
        inTransaction = true;
        System.out.println("PostgreSQL开始事务");
    }
    
    @Override
    public void commit() {
        if (!inTransaction) {
            throw new IllegalStateException("没有活动事务");
        }
        inTransaction = false;
        System.out.println("PostgreSQL提交事务");
    }
    
    @Override
    public void rollback() {
        if (!inTransaction) {
            throw new IllegalStateException("没有活动事务");
        }
        inTransaction = false;
        System.out.println("PostgreSQL回滚事务");
    }
    
    @Override
    public boolean isInTransaction() {
        return inTransaction;
    }
}

// 抽象工厂
interface DatabaseFactory {
    DatabaseConnection createConnection();
    QueryExecutor createQueryExecutor(DatabaseConnection connection);
    TransactionManager createTransactionManager(DatabaseConnection connection);
}

// 具体工厂
class MySQLFactory implements DatabaseFactory {
    private String host;
    private int port;
    private String database;
    
    public MySQLFactory(String host, int port, String database) {
        this.host = host;
        this.port = port;
        this.database = database;
    }
    
    @Override
    public DatabaseConnection createConnection() {
        return new MySQLConnection(host, port, database);
    }
    
    @Override
    public QueryExecutor createQueryExecutor(DatabaseConnection connection) {
        return new MySQLQueryExecutor(connection);
    }
    
    @Override
    public TransactionManager createTransactionManager(DatabaseConnection connection) {
        return new MySQLTransactionManager(connection);
    }
}

class PostgreSQLFactory implements DatabaseFactory {
    private String host;
    private int port;
    private String database;
    
    public PostgreSQLFactory(String host, int port, String database) {
        this.host = host;
        this.port = port;
        this.database = database;
    }
    
    @Override
    public DatabaseConnection createConnection() {
        return new PostgreSQLConnection(host, port, database);
    }
    
    @Override
    public QueryExecutor createQueryExecutor(DatabaseConnection connection) {
        return new PostgreSQLQueryExecutor(connection);
    }
    
    @Override
    public TransactionManager createTransactionManager(DatabaseConnection connection) {
        return new PostgreSQLTransactionManager(connection);
    }
}

// 数据访问层
class DataAccessLayer {
    private DatabaseConnection connection;
    private QueryExecutor queryExecutor;
    private TransactionManager transactionManager;
    
    public DataAccessLayer(DatabaseFactory factory) {
        this.connection = factory.createConnection();
        this.queryExecutor = factory.createQueryExecutor(connection);
        this.transactionManager = factory.createTransactionManager(connection);
    }
    
    public void initialize() {
        connection.connect();
    }
    
    public void performComplexOperation() {
        try {
            transactionManager.beginTransaction();
            
            // 执行多个数据库操作
            queryExecutor.executeUpdate("INSERT INTO users (name, email) VALUES ('张三', 'zhangsan@example.com')");
            queryExecutor.executeUpdate("INSERT INTO orders (user_id, amount) VALUES (1, 100.00)");
            
            String[] batchSql = {
                "UPDATE users SET last_login = NOW() WHERE id = 1",
                "INSERT INTO user_logs (user_id, action) VALUES (1, 'login')"
            };
            queryExecutor.executeBatch(batchSql);
            
            transactionManager.commit();
            System.out.println("复杂操作执行成功");
            
        } catch (Exception e) {
            if (transactionManager.isInTransaction()) {
                transactionManager.rollback();
            }
            System.err.println("操作失败，已回滚: " + e.getMessage());
        }
    }
    
    public void queryData() {
        ResultSet result = queryExecutor.executeQuery("SELECT * FROM users WHERE active = 1");
        System.out.println("查询结果: " + result.getData());
    }
    
    public void cleanup() {
        if (connection.isConnected()) {
            connection.disconnect();
        }
    }
}

// 模拟结果集
class MockResultSet implements ResultSet {
    private String data;
    
    public MockResultSet(String data) {
        this.data = data;
    }
    
    public String getData() {
        return data;
    }
}

interface ResultSet {
    String getData();
}

// 使用示例
public class DatabaseAbstractFactoryExample {
    public static void main(String[] args) {
        // 根据配置选择数据库类型
        String dbType = "mysql"; // 可以从配置文件读取
        
        DatabaseFactory factory;
        if ("mysql".equals(dbType)) {
            factory = new MySQLFactory("localhost", 3306, "testdb");
            System.out.println("=== 使用MySQL数据库 ===");
        } else {
            factory = new PostgreSQLFactory("localhost", 5432, "testdb");
            System.out.println("=== 使用PostgreSQL数据库 ===");
        }
        
        DataAccessLayer dal = new DataAccessLayer(factory);
        
        try {
            dal.initialize();
            dal.queryData();
            dal.performComplexOperation();
        } finally {
            dal.cleanup();
        }
        
        System.out.println("\n=== 切换到另一个数据库 ===");
        
        // 切换到另一个数据库
        DatabaseFactory anotherFactory = new PostgreSQLFactory("localhost", 5432, "testdb");
        DataAccessLayer anotherDal = new DataAccessLayer(anotherFactory);
        
        try {
            anotherDal.initialize();
            anotherDal.queryData();
            anotherDal.performComplexOperation();
        } finally {
            anotherDal.cleanup();
        }
    }
}
```

**抽象工厂模式的关键特点：**
1. **产品族一致性**: 确保创建的产品属于同一个产品族
2. **易于切换产品族**: 只需要更换具体工厂就可以切换整个产品族
3. **符合开放-封闭原则**: 新增产品族只需添加新的具体工厂
4. **产品之间的约束**: 可以在工厂中定义产品之间的约束关系

#### 参与者概念
- **抽象工厂**：声明创建产品族的接口
- **具体工厂**：实现创建具体产品族的方法
- **抽象产品**：声明产品的接口
- **具体产品**：实现产品接口的具体类

### 4. 建造者模式 (Builder)

#### 核心概念
- **建造者**：负责构造复杂对象的各个部分
- **指挥者**：控制构造过程
- **产品**：被构造的复杂对象
- **分步构造**：逐步构建复杂对象

#### 基础例子：电脑组装建造者
```java
// 产品类 - 电脑
class Computer {
    private String cpu;
    private String memory;
    private String storage;
    private String graphics;
    private String motherboard;
    private String powerSupply;
    private boolean hasWifi;
    private boolean hasBluetooth;
    
    // 私有构造函数，只能通过建造者创建
    private Computer() {}
    
    // Getter方法
    public String getCpu() { return cpu; }
    public String getMemory() { return memory; }
    public String getStorage() { return storage; }
    public String getGraphics() { return graphics; }
    public String getMotherboard() { return motherboard; }
    public String getPowerSupply() { return powerSupply; }
    public boolean hasWifi() { return hasWifi; }
    public boolean hasBluetooth() { return hasBluetooth; }
    
    @Override
    public String toString() {
        return String.format(
            "电脑配置:\n" +
            "CPU: %s\n" +
            "内存: %s\n" +
            "存储: %s\n" +
            "显卡: %s\n" +
            "主板: %s\n" +
            "电源: %s\n" +
            "WiFi: %s\n" +
            "蓝牙: %s",
            cpu, memory, storage, graphics, motherboard, powerSupply,
            hasWifi ? "是" : "否", hasBluetooth ? "是" : "否"
        );
    }
    
    // 静态内部类建造者
    public static class Builder {
        private Computer computer;
        
        public Builder() {
            computer = new Computer();
        }
        
        public Builder cpu(String cpu) {
            computer.cpu = cpu;
            return this;
        }
        
        public Builder memory(String memory) {
            computer.memory = memory;
            return this;
        }
        
        public Builder storage(String storage) {
            computer.storage = storage;
            return this;
        }
        
        public Builder graphics(String graphics) {
            computer.graphics = graphics;
            return this;
        }
        
        public Builder motherboard(String motherboard) {
            computer.motherboard = motherboard;
            return this;
        }
        
        public Builder powerSupply(String powerSupply) {
            computer.powerSupply = powerSupply;
            return this;
        }
        
        public Builder wifi(boolean hasWifi) {
            computer.hasWifi = hasWifi;
            return this;
        }
        
        public Builder bluetooth(boolean hasBluetooth) {
            computer.hasBluetooth = hasBluetooth;
            return this;
        }
        
        public Computer build() {
            // 验证必需的组件
            if (computer.cpu == null || computer.memory == null || computer.storage == null) {
                throw new IllegalStateException("CPU、内存和存储是必需的组件");
            }
            
            // 设置默认值
            if (computer.graphics == null) {
                computer.graphics = "集成显卡";
            }
            if (computer.motherboard == null) {
                computer.motherboard = "标准主板";
            }
            if (computer.powerSupply == null) {
                computer.powerSupply = "500W电源";
            }
            
            return computer;
        }
    }
}

// 使用示例
public class ComputerBuilderExample {
    public static void main(String[] args) {
        // 构建游戏电脑
        Computer gamingComputer = new Computer.Builder()
            .cpu("Intel i7-12700K")
            .memory("32GB DDR4")
            .storage("1TB NVMe SSD")
            .graphics("RTX 4070")
            .motherboard("Z690 主板")
            .powerSupply("750W 80+ Gold")
            .wifi(true)
            .bluetooth(true)
            .build();
        
        System.out.println("=== 游戏电脑 ===");
        System.out.println(gamingComputer);
        
        // 构建办公电脑
        Computer officeComputer = new Computer.Builder()
            .cpu("Intel i5-12400")
            .memory("16GB DDR4")
            .storage("512GB SSD")
            .wifi(true)
            .build();
        
        System.out.println("\n=== 办公电脑 ===");
        System.out.println(officeComputer);
    }
}
```

#### 进阶例子：HTTP请求建造者系统
```java
import java.util.*;
import java.util.concurrent.TimeUnit;

// 复杂产品 - HTTP请求
class HttpRequest {
    private String url;
    private String method;
    private Map<String, String> headers;
    private Map<String, String> queryParams;
    private String body;
    private int timeout;
    private int retryCount;
    private boolean followRedirects;
    private String userAgent;
    private Map<String, String> cookies;
    private String contentType;
    private String authorization;
    
    // 私有构造函数
    private HttpRequest() {
        this.headers = new HashMap<>();
        this.queryParams = new HashMap<>();
        this.cookies = new HashMap<>();
    }
    
    // Getter方法
    public String getUrl() { return url; }
    public String getMethod() { return method; }
    public Map<String, String> getHeaders() { return new HashMap<>(headers); }
    public Map<String, String> getQueryParams() { return new HashMap<>(queryParams); }
    public String getBody() { return body; }
    public int getTimeout() { return timeout; }
    public int getRetryCount() { return retryCount; }
    public boolean isFollowRedirects() { return followRedirects; }
    public String getUserAgent() { return userAgent; }
    public Map<String, String> getCookies() { return new HashMap<>(cookies); }
    public String getContentType() { return contentType; }
    public String getAuthorization() { return authorization; }
    
    // 执行请求的模拟方法
    public HttpResponse execute() {
        System.out.println("执行HTTP请求:");
        System.out.println("URL: " + getFullUrl());
        System.out.println("方法: " + method);
        System.out.println("请求头: " + headers);
        if (body != null) {
            System.out.println("请求体: " + body);
        }
        System.out.println("超时时间: " + timeout + "ms");
        System.out.println("重试次数: " + retryCount);
        
        // 模拟响应
        return new HttpResponse(200, "请求成功", "响应内容");
    }
    
    private String getFullUrl() {
        if (queryParams.isEmpty()) {
            return url;
        }
        
        StringBuilder fullUrl = new StringBuilder(url);
        fullUrl.append("?");
        
        boolean first = true;
        for (Map.Entry<String, String> param : queryParams.entrySet()) {
            if (!first) {
                fullUrl.append("&");
            }
            fullUrl.append(param.getKey()).append("=").append(param.getValue());
            first = false;
        }
        
        return fullUrl.toString();
    }
    
    // 建造者类
    public static class Builder {
        private HttpRequest request;
        
        public Builder(String url) {
            request = new HttpRequest();
            request.url = url;
            request.method = "GET"; // 默认方法
            request.timeout = 5000; // 默认超时5秒
            request.retryCount = 0; // 默认不重试
            request.followRedirects = true; // 默认跟随重定向
            request.userAgent = "HttpClient/1.0"; // 默认User-Agent
        }
        
        public Builder method(String method) {
            request.method = method.toUpperCase();
            return this;
        }
        
        public Builder get() {
            return method("GET");
        }
        
        public Builder post() {
            return method("POST");
        }
        
        public Builder put() {
            return method("PUT");
        }
        
        public Builder delete() {
            return method("DELETE");
        }
        
        public Builder header(String name, String value) {
            request.headers.put(name, value);
            return this;
        }
        
        public Builder headers(Map<String, String> headers) {
            request.headers.putAll(headers);
            return this;
        }
        
        public Builder queryParam(String name, String value) {
            request.queryParams.put(name, value);
            return this;
        }
        
        public Builder queryParams(Map<String, String> params) {
            request.queryParams.putAll(params);
            return this;
        }
        
        public Builder body(String body) {
            request.body = body;
            return this;
        }
        
        public Builder jsonBody(String json) {
            request.body = json;
            request.contentType = "application/json";
            request.headers.put("Content-Type", "application/json");
            return this;
        }
        
        public Builder formBody(Map<String, String> formData) {
            StringBuilder body = new StringBuilder();
            boolean first = true;
            for (Map.Entry<String, String> entry : formData.entrySet()) {
                if (!first) {
                    body.append("&");
                }
                body.append(entry.getKey()).append("=").append(entry.getValue());
                first = false;
            }
            request.body = body.toString();
            request.contentType = "application/x-www-form-urlencoded";
            request.headers.put("Content-Type", "application/x-www-form-urlencoded");
            return this;
        }
        
        public Builder timeout(int timeout, TimeUnit unit) {
            request.timeout = (int) unit.toMillis(timeout);
            return this;
        }
        
        public Builder timeout(int timeoutMs) {
            request.timeout = timeoutMs;
            return this;
        }
        
        public Builder retry(int retryCount) {
            request.retryCount = retryCount;
            return this;
        }
        
        public Builder followRedirects(boolean follow) {
            request.followRedirects = follow;
            return this;
        }
        
        public Builder userAgent(String userAgent) {
            request.userAgent = userAgent;
            request.headers.put("User-Agent", userAgent);
            return this;
        }
        
        public Builder cookie(String name, String value) {
            request.cookies.put(name, value);
            return this;
        }
        
        public Builder cookies(Map<String, String> cookies) {
            request.cookies.putAll(cookies);
            return this;
        }
        
        public Builder basicAuth(String username, String password) {
            String credentials = username + ":" + password;
            String encoded = Base64.getEncoder().encodeToString(credentials.getBytes());
            request.authorization = "Basic " + encoded;
            request.headers.put("Authorization", request.authorization);
            return this;
        }
        
        public Builder bearerToken(String token) {
            request.authorization = "Bearer " + token;
            request.headers.put("Authorization", request.authorization);
            return this;
        }
        
        public HttpRequest build() {
            // 验证必需的字段
            if (request.url == null || request.url.trim().isEmpty()) {
                throw new IllegalStateException("URL不能为空");
            }
            
            // 设置Cookie头
            if (!request.cookies.isEmpty()) {
                StringBuilder cookieHeader = new StringBuilder();
                boolean first = true;
                for (Map.Entry<String, String> cookie : request.cookies.entrySet()) {
                    if (!first) {
                        cookieHeader.append("; ");
                    }
                    cookieHeader.append(cookie.getKey()).append("=").append(cookie.getValue());
                    first = false;
                }
                request.headers.put("Cookie", cookieHeader.toString());
            }
            
            return request;
        }
    }
}

// HTTP响应类
class HttpResponse {
    private int statusCode;
    private String statusMessage;
    private String body;
    
    public HttpResponse(int statusCode, String statusMessage, String body) {
        this.statusCode = statusCode;
        this.statusMessage = statusMessage;
        this.body = body;
    }
    
    public int getStatusCode() { return statusCode; }
    public String getStatusMessage() { return statusMessage; }
    public String getBody() { return body; }
    
    @Override
    public String toString() {
        return String.format("HTTP %d %s\n%s", statusCode, statusMessage, body);
    }
}

// 传统建造者模式实现（使用指挥者）
abstract class HttpRequestBuilder {
    protected HttpRequest request;
    
    public HttpRequestBuilder() {
        request = new HttpRequest();
    }
    
    public abstract void buildMethod();
    public abstract void buildHeaders();
    public abstract void buildBody();
    public abstract void buildTimeout();
    
    public HttpRequest getResult() {
        return request;
    }
}

class ApiRequestBuilder extends HttpRequestBuilder {
    private String apiKey;
    private String endpoint;
    
    public ApiRequestBuilder(String endpoint, String apiKey) {
        super();
        this.endpoint = endpoint;
        this.apiKey = apiKey;
    }
    
    @Override
    public void buildMethod() {
        // API请求通常使用POST
        request = new HttpRequest.Builder(endpoint).post().build();
    }
    
    @Override
    public void buildHeaders() {
        request = new HttpRequest.Builder(endpoint)
            .post()
            .header("X-API-Key", apiKey)
            .header("Accept", "application/json")
            .build();
    }
    
    @Override
    public void buildBody() {
        request = new HttpRequest.Builder(endpoint)
            .post()
            .header("X-API-Key", apiKey)
            .header("Accept", "application/json")
            .jsonBody("{\"action\": \"getData\"}")
            .build();
    }
    
    @Override
    public void buildTimeout() {
        request = new HttpRequest.Builder(endpoint)
            .post()
            .header("X-API-Key", apiKey)
            .header("Accept", "application/json")
            .jsonBody("{\"action\": \"getData\"}")
            .timeout(10, TimeUnit.SECONDS)
            .retry(3)
            .build();
    }
}

// 指挥者
class HttpRequestDirector {
    public HttpRequest constructApiRequest(HttpRequestBuilder builder) {
        builder.buildMethod();
        builder.buildHeaders();
        builder.buildBody();
        builder.buildTimeout();
        return builder.getResult();
    }
}

// 使用示例
public class HttpRequestBuilderExample {
    public static void main(String[] args) {
        System.out.println("=== 链式建造者示例 ===");
        
        // 构建GET请求
        HttpRequest getRequest = new HttpRequest.Builder("https://api.example.com/users")
            .get()
            .queryParam("page", "1")
            .queryParam("limit", "10")
            .header("Accept", "application/json")
            .userAgent("MyApp/1.0")
            .timeout(5, TimeUnit.SECONDS)
            .build();
        
        HttpResponse getResponse = getRequest.execute();
        System.out.println("GET响应: " + getResponse);
        
        System.out.println("\n=== POST请求示例 ===");
        
        // 构建POST请求
        Map<String, String> formData = new HashMap<>();
        formData.put("username", "john");
        formData.put("password", "secret");
        
        HttpRequest postRequest = new HttpRequest.Builder("https://api.example.com/login")
            .post()
            .formBody(formData)
            .timeout(10000)
            .retry(2)
            .build();
        
        HttpResponse postResponse = postRequest.execute();
        System.out.println("POST响应: " + postResponse);
        
        System.out.println("\n=== 复杂API请求示例 ===");
        
        // 构建复杂的API请求
        HttpRequest apiRequest = new HttpRequest.Builder("https://api.example.com/data")
            .post()
            .jsonBody("{\"query\": \"SELECT * FROM users\", \"limit\": 100}")
            .bearerToken("eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...")
            .header("X-Request-ID", UUID.randomUUID().toString())
            .cookie("session", "abc123")
            .cookie("preferences", "theme=dark")
            .timeout(30, TimeUnit.SECONDS)
            .retry(3)
            .followRedirects(false)
            .userAgent("DataAnalyzer/2.1")
            .build();
        
        HttpResponse apiResponse = apiRequest.execute();
        System.out.println("API响应: " + apiResponse);
        
        System.out.println("\n=== 传统建造者模式示例 ===");
        
        // 使用传统建造者模式
        HttpRequestDirector director = new HttpRequestDirector();
        ApiRequestBuilder builder = new ApiRequestBuilder("https://api.example.com/endpoint", "api-key-123");
        
        HttpRequest directorRequest = director.constructApiRequest(builder);
        HttpResponse directorResponse = directorRequest.execute();
        System.out.println("指挥者构建的请求响应: " + directorResponse);
    }
}
```

**建造者模式的关键特点：**
1. **分步构造**: 可以分步骤构造复杂对象
2. **参数验证**: 在build()方法中进行参数验证
3. **不可变对象**: 构造完成后对象通常是不可变的
4. **链式调用**: 支持流畅的链式调用语法
5. **默认值处理**: 可以为可选参数提供合理的默认值

#### 实现概念
- **传统建造者**：使用指挥者控制构造过程
- **链式建造者**：支持方法链式调用
- **静态内部类建造者**：常见的Java实现方式
- **注解驱动建造者**：通过注解自动生成建造者

### 5. 原型模式 (Prototype)

#### 核心概念
- **原型**：用于创建对象的样板
- **克隆**：通过复制现有对象创建新对象
- **原型管理器**：管理原型对象的注册表

#### 基础例子：图形对象克隆
```java
// 抽象原型
abstract class Shape implements Cloneable {
    protected String id;
    protected String type;
    protected int x, y;
    protected String color;
    
    public Shape() {}
    
    public Shape(Shape source) {
        if (source != null) {
            this.id = source.id;
            this.type = source.type;
            this.x = source.x;
            this.y = source.y;
            this.color = source.color;
        }
    }
    
    // 抽象克隆方法
    public abstract Shape clone();
    
    // 抽象绘制方法
    public abstract void draw();
    
    // Getter和Setter方法
    public String getId() { return id; }
    public void setId(String id) { this.id = id; }
    public String getType() { return type; }
    public void setType(String type) { this.type = type; }
    public int getX() { return x; }
    public void setX(int x) { this.x = x; }
    public int getY() { return y; }
    public void setY(int y) { this.y = y; }
    public String getColor() { return color; }
    public void setColor(String color) { this.color = color; }
    
    @Override
    public String toString() {
        return String.format("%s[id=%s, position=(%d,%d), color=%s]", 
                           type, id, x, y, color);
    }
}

// 具体原型 - 圆形
class Circle extends Shape {
    private int radius;
    
    public Circle() {
        this.type = "Circle";
    }
    
    public Circle(Circle source) {
        super(source);
        if (source != null) {
            this.radius = source.radius;
        }
    }
    
    @Override
    public Shape clone() {
        return new Circle(this);
    }
    
    @Override
    public void draw() {
        System.out.println("绘制圆形: " + this + ", 半径=" + radius);
    }
    
    public int getRadius() { return radius; }
    public void setRadius(int radius) { this.radius = radius; }
}

// 具体原型 - 矩形
class Rectangle extends Shape {
    private int width, height;
    
    public Rectangle() {
        this.type = "Rectangle";
    }
    
    public Rectangle(Rectangle source) {
        super(source);
        if (source != null) {
            this.width = source.width;
            this.height = source.height;
        }
    }
    
    @Override
    public Shape clone() {
        return new Rectangle(this);
    }
    
    @Override
    public void draw() {
        System.out.println("绘制矩形: " + this + ", 尺寸=" + width + "x" + height);
    }
    
    public int getWidth() { return width; }
    public void setWidth(int width) { this.width = width; }
    public int getHeight() { return height; }
    public void setHeight(int height) { this.height = height; }
}

// 原型管理器
class ShapeCache {
    private static Map<String, Shape> shapeMap = new HashMap<>();
    
    public static Shape getShape(String shapeId) {
        Shape cachedShape = shapeMap.get(shapeId);
        return cachedShape != null ? cachedShape.clone() : null;
    }
    
    public static void loadCache() {
        Circle circle = new Circle();
        circle.setId("1");
        circle.setX(10);
        circle.setY(20);
        circle.setColor("红色");
        circle.setRadius(5);
        shapeMap.put(circle.getId(), circle);
        
        Rectangle rectangle = new Rectangle();
        rectangle.setId("2");
        rectangle.setX(30);
        rectangle.setY(40);
        rectangle.setColor("蓝色");
        rectangle.setWidth(15);
        rectangle.setHeight(10);
        shapeMap.put(rectangle.getId(), rectangle);
        
        System.out.println("原型缓存已加载");
    }
    
    public static void addShape(String id, Shape shape) {
        shapeMap.put(id, shape);
    }
    
    public static Set<String> getAvailableShapes() {
        return shapeMap.keySet();
    }
}

// 使用示例
public class PrototypeExample {
    public static void main(String[] args) {
        // 加载原型缓存
        ShapeCache.loadCache();
        
        System.out.println("可用的原型: " + ShapeCache.getAvailableShapes());
        
        // 克隆圆形
        Shape clonedCircle1 = ShapeCache.getShape("1");
        clonedCircle1.draw();
        
        Shape clonedCircle2 = ShapeCache.getShape("1");
        clonedCircle2.setColor("绿色");
        clonedCircle2.setX(50);
        clonedCircle2.draw();
        
        // 克隆矩形
        Shape clonedRectangle = ShapeCache.getShape("2");
        clonedRectangle.draw();
        
        // 验证克隆的独立性
        System.out.println("\n验证克隆独立性:");
        System.out.println("原始圆形颜色: " + ShapeCache.getShape("1").getColor());
        System.out.println("修改后的圆形颜色: " + clonedCircle2.getColor());
    }
}
```

#### 进阶例子：文档模板克隆系统
```java
import java.io.*;
import java.util.*;
import java.util.concurrent.ConcurrentHashMap;

// 复杂对象 - 文档
class Document implements Cloneable, Serializable {
    private static final long serialVersionUID = 1L;
    
    private String title;
    private String content;
    private List<String> tags;
    private Map<String, Object> metadata;
    private List<Attachment> attachments;
    private DocumentStyle style;
    private Date createdDate;
    private Date modifiedDate;
    
    public Document() {
        this.tags = new ArrayList<>();
        this.metadata = new HashMap<>();
        this.attachments = new ArrayList<>();
        this.createdDate = new Date();
        this.modifiedDate = new Date();
    }
    
    // 拷贝构造函数 - 深拷贝
    public Document(Document source) {
        if (source != null) {
            this.title = source.title;
            this.content = source.content;
            
            // 深拷贝集合
            this.tags = new ArrayList<>(source.tags);
            this.metadata = new HashMap<>(source.metadata);
            
            // 深拷贝附件列表
            this.attachments = new ArrayList<>();
            for (Attachment attachment : source.attachments) {
                this.attachments.add(new Attachment(attachment));
            }
            
            // 深拷贝样式
            this.style = source.style != null ? new DocumentStyle(source.style) : null;
            
            // 拷贝日期
            this.createdDate = new Date(source.createdDate.getTime());
            this.modifiedDate = new Date();
        }
    }
    
    // 浅拷贝
    @Override
    public Document clone() {
        try {
            Document cloned = (Document) super.clone();
            cloned.modifiedDate = new Date();
            return cloned;
        } catch (CloneNotSupportedException e) {
            throw new RuntimeException("克隆失败", e);
        }
    }
    
    // 深拷贝
    public Document deepClone() {
        return new Document(this);
    }
    
    // 序列化深拷贝
    public Document serializationClone() {
        try {
            ByteArrayOutputStream bos = new ByteArrayOutputStream();
            ObjectOutputStream oos = new ObjectOutputStream(bos);
            oos.writeObject(this);
            oos.close();
            
            ByteArrayInputStream bis = new ByteArrayInputStream(bos.toByteArray());
            ObjectInputStream ois = new ObjectInputStream(bis);
            Document cloned = (Document) ois.readObject();
            ois.close();
            
            cloned.modifiedDate = new Date();
            return cloned;
        } catch (IOException | ClassNotFoundException e) {
            throw new RuntimeException("序列化克隆失败", e);
        }
    }
    
    // Getter和Setter方法
    public String getTitle() { return title; }
    public void setTitle(String title) { 
        this.title = title; 
        this.modifiedDate = new Date();
    }
    
    public String getContent() { return content; }
    public void setContent(String content) { 
        this.content = content; 
        this.modifiedDate = new Date();
    }
    
    public List<String> getTags() { return tags; }
    public void addTag(String tag) { 
        this.tags.add(tag); 
        this.modifiedDate = new Date();
    }
    
    public Map<String, Object> getMetadata() { return metadata; }
    public void setMetadata(String key, Object value) { 
        this.metadata.put(key, value); 
        this.modifiedDate = new Date();
    }
    
    public List<Attachment> getAttachments() { return attachments; }
    public void addAttachment(Attachment attachment) { 
        this.attachments.add(attachment); 
        this.modifiedDate = new Date();
    }
    
    public DocumentStyle getStyle() { return style; }
    public void setStyle(DocumentStyle style) { 
        this.style = style; 
        this.modifiedDate = new Date();
    }
    
    public Date getCreatedDate() { return createdDate; }
    public Date getModifiedDate() { return modifiedDate; }
    
    @Override
    public String toString() {
        return String.format("Document[title='%s', tags=%s, attachments=%d, created=%s, modified=%s]",
                           title, tags, attachments.size(), createdDate, modifiedDate);
    }
}

// 附件类
class Attachment implements Serializable {
    private static final long serialVersionUID = 1L;
    
    private String filename;
    private String contentType;
    private long size;
    private byte[] data;
    
    public Attachment(String filename, String contentType, byte[] data) {
        this.filename = filename;
        this.contentType = contentType;
        this.data = data != null ? data.clone() : null;
        this.size = data != null ? data.length : 0;
    }
    
    public Attachment(Attachment source) {
        if (source != null) {
            this.filename = source.filename;
            this.contentType = source.contentType;
            this.size = source.size;
            this.data = source.data != null ? source.data.clone() : null;
        }
    }
    
    // Getter方法
    public String getFilename() { return filename; }
    public String getContentType() { return contentType; }
    public long getSize() { return size; }
    public byte[] getData() { return data != null ? data.clone() : null; }
    
    @Override
    public String toString() {
        return String.format("Attachment[filename='%s', type='%s', size=%d]", 
                           filename, contentType, size);
    }
}

// 文档样式类
class DocumentStyle implements Serializable {
    private static final long serialVersionUID = 1L;
    
    private String fontFamily;
    private int fontSize;
    private String fontColor;
    private String backgroundColor;
    private int lineSpacing;
    private String alignment;
    
    public DocumentStyle() {
        this.fontFamily = "Arial";
        this.fontSize = 12;
        this.fontColor = "#000000";
        this.backgroundColor = "#FFFFFF";
        this.lineSpacing = 1;
        this.alignment = "left";
    }
    
    public DocumentStyle(DocumentStyle source) {
        if (source != null) {
            this.fontFamily = source.fontFamily;
            this.fontSize = source.fontSize;
            this.fontColor = source.fontColor;
            this.backgroundColor = source.backgroundColor;
            this.lineSpacing = source.lineSpacing;
            this.alignment = source.alignment;
        }
    }
    
    // Getter和Setter方法
    public String getFontFamily() { return fontFamily; }
    public void setFontFamily(String fontFamily) { this.fontFamily = fontFamily; }
    public int getFontSize() { return fontSize; }
    public void setFontSize(int fontSize) { this.fontSize = fontSize; }
    public String getFontColor() { return fontColor; }
    public void setFontColor(String fontColor) { this.fontColor = fontColor; }
    public String getBackgroundColor() { return backgroundColor; }
    public void setBackgroundColor(String backgroundColor) { this.backgroundColor = backgroundColor; }
    public int getLineSpacing() { return lineSpacing; }
    public void setLineSpacing(int lineSpacing) { this.lineSpacing = lineSpacing; }
    public String getAlignment() { return alignment; }
    public void setAlignment(String alignment) { this.alignment = alignment; }
    
    @Override
    public String toString() {
        return String.format("Style[font=%s %dpx, color=%s, bg=%s, align=%s]",
                           fontFamily, fontSize, fontColor, backgroundColor, alignment);
    }
}

// 文档模板管理器
class DocumentTemplateManager {
    private static final Map<String, Document> templates = new ConcurrentHashMap<>();
    private static final Map<String, Integer> usageCount = new ConcurrentHashMap<>();
    
    static {
        initializeTemplates();
    }
    
    private static void initializeTemplates() {
        // 创建报告模板
        Document reportTemplate = new Document();
        reportTemplate.setTitle("月度报告模板");
        reportTemplate.setContent("# 月度报告\n\n## 概述\n\n## 详细内容\n\n## 结论");
        reportTemplate.addTag("报告");
        reportTemplate.addTag("模板");
        reportTemplate.setMetadata("category", "business");
        reportTemplate.setMetadata("version", "1.0");
        
        DocumentStyle reportStyle = new DocumentStyle();
        reportStyle.setFontFamily("Times New Roman");
        reportStyle.setFontSize(14);
        reportStyle.setLineSpacing(2);
        reportTemplate.setStyle(reportStyle);
        
        templates.put("report", reportTemplate);
        
        // 创建邮件模板
        Document emailTemplate = new Document();
        emailTemplate.setTitle("邮件模板");
        emailTemplate.setContent("尊敬的 [客户姓名]，\n\n感谢您的咨询...\n\n此致\n敬礼");
        emailTemplate.addTag("邮件");
        emailTemplate.addTag("客服");
        emailTemplate.setMetadata("category", "communication");
        emailTemplate.setMetadata("priority", "normal");
        
        DocumentStyle emailStyle = new DocumentStyle();
        emailStyle.setFontFamily("Arial");
        emailStyle.setFontSize(12);
        emailTemplate.setStyle(emailStyle);
        
        templates.put("email", emailTemplate);
        
        // 创建合同模板
        Document contractTemplate = new Document();
        contractTemplate.setTitle("服务合同模板");
        contractTemplate.setContent("服务合同\n\n甲方：[公司名称]\n乙方：[客户名称]\n\n合同条款：\n1. ...\n2. ...");
        contractTemplate.addTag("合同");
        contractTemplate.addTag("法律");
        contractTemplate.setMetadata("category", "legal");
        contractTemplate.setMetadata("requires_review", true);
        
        // 添加附件
        byte[] sampleData = "合同附件示例内容".getBytes();
        contractTemplate.addAttachment(new Attachment("contract_terms.txt", "text/plain", sampleData));
        
        DocumentStyle contractStyle = new DocumentStyle();
        contractStyle.setFontFamily("SimSun");
        contractStyle.setFontSize(12);
        contractStyle.setLineSpacing(2);
        contractTemplate.setStyle(contractStyle);
        
        templates.put("contract", contractTemplate);
        
        System.out.println("文档模板已初始化: " + templates.keySet());
    }
    
    public static Document getTemplate(String templateName) {
        Document template = templates.get(templateName);
        if (template == null) {
            throw new IllegalArgumentException("模板不存在: " + templateName);
        }
        
        // 记录使用次数
        usageCount.merge(templateName, 1, Integer::sum);
        
        return template.deepClone();
    }
    
    public static Document getTemplateByClone(String templateName) {
        Document template = templates.get(templateName);
        if (template == null) {
            throw new IllegalArgumentException("模板不存在: " + templateName);
        }
        
        usageCount.merge(templateName, 1, Integer::sum);
        return template.clone(); // 浅拷贝
    }
    
    public static Document getTemplateBySerialization(String templateName) {
        Document template = templates.get(templateName);
        if (template == null) {
            throw new IllegalArgumentException("模板不存在: " + templateName);
        }
        
        usageCount.merge(templateName, 1, Integer::sum);
        return template.serializationClone(); // 序列化深拷贝
    }
    
    public static void addTemplate(String name, Document template) {
        templates.put(name, template);
        usageCount.put(name, 0);
    }
    
    public static Set<String> getAvailableTemplates() {
        return templates.keySet();
    }
    
    public static Map<String, Integer> getUsageStatistics() {
        return new HashMap<>(usageCount);
    }
    
    public static void printTemplateInfo(String templateName) {
        Document template = templates.get(templateName);
        if (template != null) {
            System.out.println("模板信息: " + template);
            System.out.println("样式: " + template.getStyle());
            System.out.println("附件: " + template.getAttachments());
            System.out.println("使用次数: " + usageCount.getOrDefault(templateName, 0));
        }
    }
}

// 使用示例
public class DocumentPrototypeExample {
    public static void main(String[] args) {
        System.out.println("=== 文档模板克隆系统 ===");
        System.out.println("可用模板: " + DocumentTemplateManager.getAvailableTemplates());
        
        // 使用深拷贝创建文档
        System.out.println("\n--- 深拷贝示例 ---");
        Document report1 = DocumentTemplateManager.getTemplate("report");
        report1.setTitle("2024年1月销售报告");
        report1.setContent(report1.getContent().replace("[月份]", "1月"));
        report1.addTag("销售");
        report1.setMetadata("month", "2024-01");
        
        Document report2 = DocumentTemplateManager.getTemplate("report");
        report2.setTitle("2024年2月销售报告");
        report2.setContent(report2.getContent().replace("[月份]", "2月"));
        report2.addTag("销售");
        report2.setMetadata("month", "2024-02");
        
        System.out.println("报告1: " + report1);
        System.out.println("报告2: " + report2);
        
        // 使用浅拷贝创建文档
        System.out.println("\n--- 浅拷贝示例 ---");
        Document email1 = DocumentTemplateManager.getTemplateByClone("email");
        email1.setTitle("客户咨询回复");
        email1.addTag("客服回复");
        
        Document email2 = DocumentTemplateManager.getTemplateByClone("email");
        email2.setTitle("产品介绍邮件");
        
        System.out.println("邮件1: " + email1);
        System.out.println("邮件2: " + email2);
        
        // 验证浅拷贝的共享问题
        System.out.println("邮件1标签: " + email1.getTags());
        System.out.println("邮件2标签: " + email2.getTags());
        
        // 使用序列化克隆
        System.out.println("\n--- 序列化克隆示例 ---");
        Document contract1 = DocumentTemplateManager.getTemplateBySerialization("contract");
        contract1.setTitle("软件开发服务合同");
        contract1.setContent(contract1.getContent().replace("[公司名称]", "科技有限公司"));
        contract1.setContent(contract1.getContent().replace("[客户名称]", "ABC公司"));
        
        System.out.println("合同1: " + contract1);
        System.out.println("合同1附件: " + contract1.getAttachments());
        
        // 性能测试
        System.out.println("\n--- 性能测试 ---");
        long startTime, endTime;
        int iterations = 1000;
        
        // 测试深拷贝性能
        startTime = System.currentTimeMillis();
        for (int i = 0; i < iterations; i++) {
            Document doc = DocumentTemplateManager.getTemplate("contract");
        }
        endTime = System.currentTimeMillis();
        System.out.println("深拷贝 " + iterations + " 次耗时: " + (endTime - startTime) + "ms");
        
        // 测试浅拷贝性能
        startTime = System.currentTimeMillis();
        for (int i = 0; i < iterations; i++) {
            Document doc = DocumentTemplateManager.getTemplateByClone("contract");
        }
        endTime = System.currentTimeMillis();
        System.out.println("浅拷贝 " + iterations + " 次耗时: " + (endTime - startTime) + "ms");
        
        // 测试序列化克隆性能
        startTime = System.currentTimeMillis();
        for (int i = 0; i < iterations; i++) {
            Document doc = DocumentTemplateManager.getTemplateBySerialization("contract");
        }
        endTime = System.currentTimeMillis();
        System.out.println("序列化克隆 " + iterations + " 次耗时: " + (endTime - startTime) + "ms");
        
        // 显示使用统计
        System.out.println("\n--- 使用统计 ---");
        Map<String, Integer> stats = DocumentTemplateManager.getUsageStatistics();
        stats.forEach((template, count) -> 
            System.out.println(template + ": " + count + " 次"));
        
        // 显示模板详细信息
        System.out.println("\n--- 模板详细信息 ---");
        DocumentTemplateManager.printTemplateInfo("contract");
    }
}
```

**原型模式的关键特点：**
1. **避免重复创建**: 通过克隆避免重复的初始化过程
2. **运行时配置**: 可以在运行时动态添加和删除原型
3. **减少子类**: 避免为每种产品创建工厂子类
4. **性能优化**: 克隆通常比new操作更快
5. **深浅拷贝选择**: 根据需要选择合适的拷贝方式

#### 克隆概念
- **浅拷贝**：只复制对象的基本类型字段
- **深拷贝**：递归复制对象的所有字段
- **序列化克隆**：通过序列化实现深拷贝
- **手动克隆**：自定义克隆逻辑

## 第三部分：结构型模式概念

### 1. 适配器模式 (Adapter)

#### 核心概念
- **适配器**：将一个接口转换成客户期望的另一个接口
- **目标接口**：客户端期望的接口
- **适配者**：需要被适配的现有类
- **接口转换**：不兼容接口的转换

#### 基础例子：音频播放器适配器
```java
// 目标接口 - 客户端期望的接口
interface MediaPlayer {
    void play(String audioType, String fileName);
}

// 适配者接口 - 高级媒体播放器
interface AdvancedMediaPlayer {
    void playVlc(String fileName);
    void playMp4(String fileName);
}

// 具体适配者 - VLC播放器
class VlcPlayer implements AdvancedMediaPlayer {
    @Override
    public void playVlc(String fileName) {
        System.out.println("播放VLC文件: " + fileName);
    }
    
    @Override
    public void playMp4(String fileName) {
        // VLC播放器不支持MP4
    }
}

// 具体适配者 - MP4播放器
class Mp4Player implements AdvancedMediaPlayer {
    @Override
    public void playVlc(String fileName) {
        // MP4播放器不支持VLC
    }
    
    @Override
    public void playMp4(String fileName) {
        System.out.println("播放MP4文件: " + fileName);
    }
}

// 适配器类 - 对象适配器
class MediaAdapter implements MediaPlayer {
    private AdvancedMediaPlayer advancedPlayer;
    
    public MediaAdapter(String audioType) {
        if ("vlc".equalsIgnoreCase(audioType)) {
            advancedPlayer = new VlcPlayer();
        } else if ("mp4".equalsIgnoreCase(audioType)) {
            advancedPlayer = new Mp4Player();
        }
    }
    
    @Override
    public void play(String audioType, String fileName) {
        if ("vlc".equalsIgnoreCase(audioType)) {
            advancedPlayer.playVlc(fileName);
        } else if ("mp4".equalsIgnoreCase(audioType)) {
            advancedPlayer.playMp4(fileName);
        }
    }
}

// 具体目标类 - 音频播放器
class AudioPlayer implements MediaPlayer {
    private MediaAdapter mediaAdapter;
    
    @Override
    public void play(String audioType, String fileName) {
        // 内置支持MP3格式
        if ("mp3".equalsIgnoreCase(audioType)) {
            System.out.println("播放MP3文件: " + fileName);
        }
        // 使用适配器支持其他格式
        else if ("vlc".equalsIgnoreCase(audioType) || "mp4".equalsIgnoreCase(audioType)) {
            mediaAdapter = new MediaAdapter(audioType);
            mediaAdapter.play(audioType, fileName);
        } else {
            System.out.println("不支持的音频格式: " + audioType);
        }
    }
}

// 使用示例
public class AdapterExample {
    public static void main(String[] args) {
        AudioPlayer audioPlayer = new AudioPlayer();
        
        audioPlayer.play("mp3", "beyond_the_horizon.mp3");
        audioPlayer.play("mp4", "alone.mp4");
        audioPlayer.play("vlc", "far_far_away.vlc");
        audioPlayer.play("avi", "mind_me.avi");
    }
}
```

#### 进阶例子：第三方支付系统适配器
```java
// 目标接口 - 统一支付接口
interface PaymentProcessor {
    PaymentResult processPayment(PaymentRequest request);
    PaymentResult refund(String transactionId, double amount);
    PaymentStatus queryPaymentStatus(String transactionId);
}

// 支付请求
class PaymentRequest {
    private String orderId;
    private double amount;
    private String currency;
    private String description;
    private Map<String, String> customerInfo;
    
    public PaymentRequest(String orderId, double amount, String currency, String description) {
        this.orderId = orderId;
        this.amount = amount;
        this.currency = currency;
        this.description = description;
        this.customerInfo = new HashMap<>();
    }
    
    // Getter和Setter方法
    public String getOrderId() { return orderId; }
    public double getAmount() { return amount; }
    public String getCurrency() { return currency; }
    public String getDescription() { return description; }
    public Map<String, String> getCustomerInfo() { return customerInfo; }
    public void setCustomerInfo(String key, String value) { customerInfo.put(key, value); }
}

// 支付结果
class PaymentResult {
    private boolean success;
    private String transactionId;
    private String message;
    private String errorCode;
    private Date timestamp;
    
    public PaymentResult(boolean success, String transactionId, String message) {
        this.success = success;
        this.transactionId = transactionId;
        this.message = message;
        this.timestamp = new Date();
    }
    
    // Getter方法
    public boolean isSuccess() { return success; }
    public String getTransactionId() { return transactionId; }
    public String getMessage() { return message; }
    public String getErrorCode() { return errorCode; }
    public void setErrorCode(String errorCode) { this.errorCode = errorCode; }
    public Date getTimestamp() { return timestamp; }
    
    @Override
    public String toString() {
        return String.format("PaymentResult[success=%s, transactionId=%s, message=%s, timestamp=%s]",
                           success, transactionId, message, timestamp);
    }
}

// 支付状态枚举
enum PaymentStatus {
    PENDING, SUCCESS, FAILED, CANCELLED, REFUNDED
}

// 第三方支付系统1 - 支付宝（适配者）
class AlipaySDK {
    public AlipayResponse pay(AlipayRequest request) {
        System.out.println("调用支付宝支付接口");
        System.out.println("订单号: " + request.getOutTradeNo());
        System.out.println("金额: " + request.getTotalAmount() + " " + request.getCurrency());
        
        // 模拟支付处理
        String tradeNo = "ALIPAY_" + System.currentTimeMillis();
        return new AlipayResponse("10000", "Success", tradeNo);
    }
    
    public AlipayRefundResponse refund(String tradeNo, double amount) {
        System.out.println("调用支付宝退款接口");
        System.out.println("交易号: " + tradeNo + ", 退款金额: " + amount);
        
        String refundNo = "REFUND_" + System.currentTimeMillis();
        return new AlipayRefundResponse("10000", "Success", refundNo);
    }
    
    public AlipayQueryResponse queryTrade(String tradeNo) {
        System.out.println("查询支付宝交易状态: " + tradeNo);
        return new AlipayQueryResponse("10000", "TRADE_SUCCESS", tradeNo);
    }
}

// 支付宝请求对象
class AlipayRequest {
    private String outTradeNo;
    private String totalAmount;
    private String currency;
    private String subject;
    
    public AlipayRequest(String outTradeNo, String totalAmount, String currency, String subject) {
        this.outTradeNo = outTradeNo;
        this.totalAmount = totalAmount;
        this.currency = currency;
        this.subject = subject;
    }
    
    public String getOutTradeNo() { return outTradeNo; }
    public String getTotalAmount() { return totalAmount; }
    public String getCurrency() { return currency; }
    public String getSubject() { return subject; }
}

// 支付宝响应对象
class AlipayResponse {
    private String code;
    private String msg;
    private String tradeNo;
    
    public AlipayResponse(String code, String msg, String tradeNo) {
        this.code = code;
        this.msg = msg;
        this.tradeNo = tradeNo;
    }
    
    public String getCode() { return code; }
    public String getMsg() { return msg; }
    public String getTradeNo() { return tradeNo; }
    public boolean isSuccess() { return "10000".equals(code); }
}

class AlipayRefundResponse {
    private String code;
    private String msg;
    private String refundNo;
    
    public AlipayRefundResponse(String code, String msg, String refundNo) {
        this.code = code;
        this.msg = msg;
        this.refundNo = refundNo;
    }
    
    public String getCode() { return code; }
    public String getMsg() { return msg; }
    public String getRefundNo() { return refundNo; }
    public boolean isSuccess() { return "10000".equals(code); }
}

class AlipayQueryResponse {
    private String code;
    private String tradeStatus;
    private String tradeNo;
    
    public AlipayQueryResponse(String code, String tradeStatus, String tradeNo) {
        this.code = code;
        this.tradeStatus = tradeStatus;
        this.tradeNo = tradeNo;
    }
    
    public String getCode() { return code; }
    public String getTradeStatus() { return tradeStatus; }
    public String getTradeNo() { return tradeNo; }
}

// 第三方支付系统2 - 微信支付（适配者）
class WechatPaySDK {
    public WechatPayResponse unifiedOrder(WechatPayRequest request) {
        System.out.println("调用微信支付统一下单接口");
        System.out.println("商户订单号: " + request.getOutTradeNo());
        System.out.println("金额: " + request.getTotalFee() + " 分");
        
        String prepayId = "WECHAT_" + System.currentTimeMillis();
        return new WechatPayResponse("SUCCESS", "OK", prepayId);
    }
    
    public WechatRefundResponse refund(String transactionId, int refundFee) {
        System.out.println("调用微信支付退款接口");
        System.out.println("交易号: " + transactionId + ", 退款金额: " + refundFee + " 分");
        
        String refundId = "WX_REFUND_" + System.currentTimeMillis();
        return new WechatRefundResponse("SUCCESS", "OK", refundId);
    }
    
    public WechatQueryResponse orderQuery(String transactionId) {
        System.out.println("查询微信支付订单状态: " + transactionId);
        return new WechatQueryResponse("SUCCESS", "SUCCESS", transactionId);
    }
}

// 微信支付请求对象
class WechatPayRequest {
    private String outTradeNo;
    private int totalFee; // 微信支付金额以分为单位
    private String body;
    
    public WechatPayRequest(String outTradeNo, int totalFee, String body) {
        this.outTradeNo = outTradeNo;
        this.totalFee = totalFee;
        this.body = body;
    }
    
    public String getOutTradeNo() { return outTradeNo; }
    public int getTotalFee() { return totalFee; }
    public String getBody() { return body; }
}

// 微信支付响应对象
class WechatPayResponse {
    private String returnCode;
    private String returnMsg;
    private String prepayId;
    
    public WechatPayResponse(String returnCode, String returnMsg, String prepayId) {
        this.returnCode = returnCode;
        this.returnMsg = returnMsg;
        this.prepayId = prepayId;
    }
    
    public String getReturnCode() { return returnCode; }
    public String getReturnMsg() { return returnMsg; }
    public String getPrepayId() { return prepayId; }
    public boolean isSuccess() { return "SUCCESS".equals(returnCode); }
}

class WechatRefundResponse {
    private String returnCode;
    private String returnMsg;
    private String refundId;
    
    public WechatRefundResponse(String returnCode, String returnMsg, String refundId) {
        this.returnCode = returnCode;
        this.returnMsg = returnMsg;
        this.refundId = refundId;
    }
    
    public String getReturnCode() { return returnCode; }
    public String getReturnMsg() { return returnMsg; }
    public String getRefundId() { return refundId; }
    public boolean isSuccess() { return "SUCCESS".equals(returnCode); }
}

class WechatQueryResponse {
    private String returnCode;
    private String tradeState;
    private String transactionId;
    
    public WechatQueryResponse(String returnCode, String tradeState, String transactionId) {
        this.returnCode = returnCode;
        this.tradeState = tradeState;
        this.transactionId = transactionId;
    }
    
    public String getReturnCode() { return returnCode; }
    public String getTradeState() { return tradeState; }
    public String getTransactionId() { return transactionId; }
}

// 支付宝适配器
class AlipayAdapter implements PaymentProcessor {
    private AlipaySDK alipaySDK;
    
    public AlipayAdapter() {
        this.alipaySDK = new AlipaySDK();
    }
    
    @Override
    public PaymentResult processPayment(PaymentRequest request) {
        try {
            // 转换请求格式
            AlipayRequest alipayRequest = new AlipayRequest(
                request.getOrderId(),
                String.valueOf(request.getAmount()),
                request.getCurrency(),
                request.getDescription()
            );
            
            // 调用支付宝接口
            AlipayResponse response = alipaySDK.pay(alipayRequest);
            
            // 转换响应格式
            if (response.isSuccess()) {
                return new PaymentResult(true, response.getTradeNo(), "支付成功");
            } else {
                PaymentResult result = new PaymentResult(false, null, response.getMsg());
                result.setErrorCode(response.getCode());
                return result;
            }
        } catch (Exception e) {
            return new PaymentResult(false, null, "支付失败: " + e.getMessage());
        }
    }
    
    @Override
    public PaymentResult refund(String transactionId, double amount) {
        try {
            AlipayRefundResponse response = alipaySDK.refund(transactionId, amount);
            
            if (response.isSuccess()) {
                return new PaymentResult(true, response.getRefundNo(), "退款成功");
            } else {
                PaymentResult result = new PaymentResult(false, null, response.getMsg());
                result.setErrorCode(response.getCode());
                return result;
            }
        } catch (Exception e) {
            return new PaymentResult(false, null, "退款失败: " + e.getMessage());
        }
    }
    
    @Override
    public PaymentStatus queryPaymentStatus(String transactionId) {
        try {
            AlipayQueryResponse response = alipaySDK.queryTrade(transactionId);
            
            switch (response.getTradeStatus()) {
                case "TRADE_SUCCESS":
                    return PaymentStatus.SUCCESS;
                case "TRADE_CLOSED":
                    return PaymentStatus.CANCELLED;
                case "WAIT_BUYER_PAY":
                    return PaymentStatus.PENDING;
                default:
                    return PaymentStatus.FAILED;
            }
        } catch (Exception e) {
            return PaymentStatus.FAILED;
        }
    }
}

// 微信支付适配器
class WechatPayAdapter implements PaymentProcessor {
    private WechatPaySDK wechatPaySDK;
    
    public WechatPayAdapter() {
        this.wechatPaySDK = new WechatPaySDK();
    }
    
    @Override
    public PaymentResult processPayment(PaymentRequest request) {
        try {
            // 转换请求格式（微信支付金额以分为单位）
            WechatPayRequest wechatRequest = new WechatPayRequest(
                request.getOrderId(),
                (int) (request.getAmount() * 100), // 转换为分
                request.getDescription()
            );
            
            // 调用微信支付接口
            WechatPayResponse response = wechatPaySDK.unifiedOrder(wechatRequest);
            
            // 转换响应格式
            if (response.isSuccess()) {
                return new PaymentResult(true, response.getPrepayId(), "支付成功");
            } else {
                return new PaymentResult(false, null, response.getReturnMsg());
            }
        } catch (Exception e) {
            return new PaymentResult(false, null, "支付失败: " + e.getMessage());
        }
    }
    
    @Override
    public PaymentResult refund(String transactionId, double amount) {
        try {
            // 微信退款金额以分为单位
            WechatRefundResponse response = wechatPaySDK.refund(transactionId, (int) (amount * 100));
            
            if (response.isSuccess()) {
                return new PaymentResult(true, response.getRefundId(), "退款成功");
            } else {
                return new PaymentResult(false, null, response.getReturnMsg());
            }
        } catch (Exception e) {
            return new PaymentResult(false, null, "退款失败: " + e.getMessage());
        }
    }
    
    @Override
    public PaymentStatus queryPaymentStatus(String transactionId) {
        try {
            WechatQueryResponse response = wechatPaySDK.orderQuery(transactionId);
            
            switch (response.getTradeState()) {
                case "SUCCESS":
                    return PaymentStatus.SUCCESS;
                case "CLOSED":
                    return PaymentStatus.CANCELLED;
                case "USERPAYING":
                    return PaymentStatus.PENDING;
                case "REFUND":
                    return PaymentStatus.REFUNDED;
                default:
                    return PaymentStatus.FAILED;
            }
        } catch (Exception e) {
            return PaymentStatus.FAILED;
        }
    }
}

// 支付处理器工厂
class PaymentProcessorFactory {
    public static PaymentProcessor createProcessor(String paymentType) {
        switch (paymentType.toLowerCase()) {
            case "alipay":
                return new AlipayAdapter();
            case "wechat":
                return new WechatPayAdapter();
            default:
                throw new IllegalArgumentException("不支持的支付类型: " + paymentType);
        }
    }
}

// 统一支付服务
class PaymentService {
    private Map<String, PaymentProcessor> processors;
    
    public PaymentService() {
        processors = new HashMap<>();
        processors.put("alipay", new AlipayAdapter());
        processors.put("wechat", new WechatPayAdapter());
    }
    
    public PaymentResult processPayment(String paymentType, PaymentRequest request) {
        PaymentProcessor processor = processors.get(paymentType.toLowerCase());
        if (processor == null) {
            return new PaymentResult(false, null, "不支持的支付方式: " + paymentType);
        }
        
        System.out.println("使用 " + paymentType + " 处理支付");
        return processor.processPayment(request);
    }
    
    public PaymentResult refund(String paymentType, String transactionId, double amount) {
        PaymentProcessor processor = processors.get(paymentType.toLowerCase());
        if (processor == null) {
            return new PaymentResult(false, null, "不支持的支付方式: " + paymentType);
        }
        
        System.out.println("使用 " + paymentType + " 处理退款");
        return processor.refund(transactionId, amount);
    }
    
    public PaymentStatus queryStatus(String paymentType, String transactionId) {
        PaymentProcessor processor = processors.get(paymentType.toLowerCase());
        if (processor == null) {
            return PaymentStatus.FAILED;
        }
        
        return processor.queryPaymentStatus(transactionId);
    }
}

// 使用示例
public class PaymentAdapterExample {
    public static void main(String[] args) {
        PaymentService paymentService = new PaymentService();
        
        // 创建支付请求
        PaymentRequest request = new PaymentRequest("ORDER_001", 99.99, "CNY", "购买商品");
        request.setCustomerInfo("userId", "12345");
        request.setCustomerInfo("email", "user@example.com");
        
        System.out.println("=== 支付宝支付测试 ===");
        PaymentResult alipayResult = paymentService.processPayment("alipay", request);
        System.out.println("支付结果: " + alipayResult);
        
        if (alipayResult.isSuccess()) {
            PaymentStatus status = paymentService.queryStatus("alipay", alipayResult.getTransactionId());
            System.out.println("支付状态: " + status);
            
            // 测试退款
            PaymentResult refundResult = paymentService.refund("alipay", alipayResult.getTransactionId(), 50.0);
            System.out.println("退款结果: " + refundResult);
        }
        
        System.out.println("\n=== 微信支付测试 ===");
        PaymentRequest wechatRequest = new PaymentRequest("ORDER_002", 199.99, "CNY", "购买VIP会员");
        PaymentResult wechatResult = paymentService.processPayment("wechat", wechatRequest);
        System.out.println("支付结果: " + wechatResult);
        
        if (wechatResult.isSuccess()) {
            PaymentStatus status = paymentService.queryStatus("wechat", wechatResult.getTransactionId());
            System.out.println("支付状态: " + status);
        }
        
        System.out.println("\n=== 不支持的支付方式测试 ===");
        PaymentResult unsupportedResult = paymentService.processPayment("paypal", request);
        System.out.println("支付结果: " + unsupportedResult);
    }
}
```

**适配器模式的关键特点：**
1. **接口转换**: 将不兼容的接口转换为客户端期望的接口
2. **代码复用**: 可以复用现有的类而不需要修改其源代码
3. **解耦**: 客户端与第三方库解耦，便于切换不同的实现
4. **统一接口**: 为不同的第三方服务提供统一的调用接口
5. **易于扩展**: 新增第三方服务只需要添加新的适配器

#### 实现概念
- **类适配器**：通过继承实现适配
- **对象适配器**：通过组合实现适配
- **双向适配器**：支持双向转换的适配器
- **缺省适配器**：提供接口默认实现的适配器

### 2. 桥接模式 (Bridge)

#### 核心概念
- **桥接**：将抽象与实现分离，使它们可以独立变化
- **抽象**：定义抽象接口
- **实现**：定义实现接口
- **分离变化**：将两个独立变化的维度分离

#### 基础例子：图形绘制系统
```java
// 实现接口 - 绘制API
interface DrawingAPI {
    void drawCircle(double x, double y, double radius);
    void drawRectangle(double x, double y, double width, double height);
    void setColor(String color);
}

// 具体实现 - Windows绘制API
class WindowsDrawingAPI implements DrawingAPI {
    @Override
    public void drawCircle(double x, double y, double radius) {
        System.out.printf("Windows API: 在坐标(%.1f, %.1f)绘制半径为%.1f的圆形%n", x, y, radius);
    }
    
    @Override
    public void drawRectangle(double x, double y, double width, double height) {
        System.out.printf("Windows API: 在坐标(%.1f, %.1f)绘制%.1fx%.1f的矩形%n", x, y, width, height);
    }
    
    @Override
    public void setColor(String color) {
        System.out.println("Windows API: 设置颜色为 " + color);
    }
}

// 具体实现 - Linux绘制API
class LinuxDrawingAPI implements DrawingAPI {
    @Override
    public void drawCircle(double x, double y, double radius) {
        System.out.printf("Linux API: 在坐标(%.1f, %.1f)绘制半径为%.1f的圆形%n", x, y, radius);
    }
    
    @Override
    public void drawRectangle(double x, double y, double width, double height) {
        System.out.printf("Linux API: 在坐标(%.1f, %.1f)绘制%.1fx%.1f的矩形%n", x, y, width, height);
    }
    
    @Override
    public void setColor(String color) {
        System.out.println("Linux API: 设置颜色为 " + color);
    }
}

// 抽象类 - 形状
abstract class Shape {
    protected DrawingAPI drawingAPI;
    protected String color = "黑色";
    
    protected Shape(DrawingAPI drawingAPI) {
        this.drawingAPI = drawingAPI;
    }
    
    public abstract void draw();
    public abstract void resize(double factor);
    
    public void setColor(String color) {
        this.color = color;
        drawingAPI.setColor(color);
    }
}

// 扩展抽象类 - 圆形
class Circle extends Shape {
    private double x, y, radius;
    
    public Circle(double x, double y, double radius, DrawingAPI drawingAPI) {
        super(drawingAPI);
        this.x = x;
        this.y = y;
        this.radius = radius;
    }
    
    @Override
    public void draw() {
        drawingAPI.setColor(color);
        drawingAPI.drawCircle(x, y, radius);
    }
    
    @Override
    public void resize(double factor) {
        radius *= factor;
        System.out.printf("圆形大小调整为原来的%.1f倍，新半径: %.1f%n", factor, radius);
    }
    
    public void move(double newX, double newY) {
        this.x = newX;
        this.y = newY;
        System.out.printf("圆形移动到新位置: (%.1f, %.1f)%n", x, y);
    }
}

// 扩展抽象类 - 矩形
class Rectangle extends Shape {
    private double x, y, width, height;
    
    public Rectangle(double x, double y, double width, double height, DrawingAPI drawingAPI) {
        super(drawingAPI);
        this.x = x;
        this.y = y;
        this.width = width;
        this.height = height;
    }
    
    @Override
    public void draw() {
        drawingAPI.setColor(color);
        drawingAPI.drawRectangle(x, y, width, height);
    }
    
    @Override
    public void resize(double factor) {
        width *= factor;
        height *= factor;
        System.out.printf("矩形大小调整为原来的%.1f倍，新尺寸: %.1fx%.1f%n", factor, width, height);
    }
    
    public void move(double newX, double newY) {
        this.x = newX;
        this.y = newY;
        System.out.printf("矩形移动到新位置: (%.1f, %.1f)%n", x, y);
    }
}

// 使用示例
public class BridgeExample {
    public static void main(String[] args) {
        // 使用Windows API绘制图形
        System.out.println("=== 使用Windows API ===");
        DrawingAPI windowsAPI = new WindowsDrawingAPI();
        
        Shape circle1 = new Circle(10, 10, 5, windowsAPI);
        circle1.setColor("红色");
        circle1.draw();
        circle1.resize(1.5);
        circle1.draw();
        
        Shape rectangle1 = new Rectangle(20, 20, 10, 8, windowsAPI);
        rectangle1.setColor("蓝色");
        rectangle1.draw();
        
        // 使用Linux API绘制图形
        System.out.println("\n=== 使用Linux API ===");
        DrawingAPI linuxAPI = new LinuxDrawingAPI();
        
        Shape circle2 = new Circle(15, 15, 7, linuxAPI);
        circle2.setColor("绿色");
        circle2.draw();
        
        Shape rectangle2 = new Rectangle(30, 30, 12, 6, linuxAPI);
        rectangle2.setColor("黄色");
        rectangle2.draw();
        rectangle2.resize(0.8);
        rectangle2.draw();
    }
}
```

#### 进阶例子：消息发送系统
```java
// 实现接口 - 消息发送器
interface MessageSender {
    void sendMessage(String message, String recipient);
    boolean isAvailable();
    void configure(Map<String, String> config);
    String getProviderName();
}

// 具体实现 - 邮件发送器
class EmailSender implements MessageSender {
    private String smtpServer;
    private int port;
    private String username;
    private String password;
    private boolean isConfigured = false;
    
    @Override
    public void sendMessage(String message, String recipient) {
        if (!isConfigured) {
            throw new IllegalStateException("邮件发送器未配置");
        }
        System.out.printf("通过邮件发送消息到 %s:%n", recipient);
        System.out.printf("SMTP服务器: %s:%d%n", smtpServer, port);
        System.out.printf("消息内容: %s%n", message);
        System.out.println("邮件发送成功");
    }
    
    @Override
    public boolean isAvailable() {
        return isConfigured && smtpServer != null && !smtpServer.isEmpty();
    }
    
    @Override
    public void configure(Map<String, String> config) {
        this.smtpServer = config.get("smtp.server");
        this.port = Integer.parseInt(config.getOrDefault("smtp.port", "587"));
        this.username = config.get("smtp.username");
        this.password = config.get("smtp.password");
        this.isConfigured = true;
        System.out.println("邮件发送器配置完成");
    }
    
    @Override
    public String getProviderName() {
        return "Email";
    }
}

// 具体实现 - 短信发送器
class SMSSender implements MessageSender {
    private String apiKey;
    private String apiSecret;
    private String serviceUrl;
    private boolean isConfigured = false;
    
    @Override
    public void sendMessage(String message, String recipient) {
        if (!isConfigured) {
            throw new IllegalStateException("短信发送器未配置");
        }
        System.out.printf("通过短信发送消息到 %s:%n", recipient);
        System.out.printf("服务URL: %s%n", serviceUrl);
        System.out.printf("消息内容: %s%n", message);
        System.out.println("短信发送成功");
    }
    
    @Override
    public boolean isAvailable() {
        return isConfigured && apiKey != null && !apiKey.isEmpty();
    }
    
    @Override
    public void configure(Map<String, String> config) {
        this.apiKey = config.get("sms.api.key");
        this.apiSecret = config.get("sms.api.secret");
        this.serviceUrl = config.get("sms.service.url");
        this.isConfigured = true;
        System.out.println("短信发送器配置完成");
    }
    
    @Override
    public String getProviderName() {
        return "SMS";
    }
}

// 具体实现 - 微信发送器
class WeChatSender implements MessageSender {
    private String appId;
    private String appSecret;
    private String accessToken;
    private boolean isConfigured = false;
    
    @Override
    public void sendMessage(String message, String recipient) {
        if (!isConfigured) {
            throw new IllegalStateException("微信发送器未配置");
        }
        System.out.printf("通过微信发送消息到 %s:%n", recipient);
        System.out.printf("AppId: %s%n", appId);
        System.out.printf("消息内容: %s%n", message);
        System.out.println("微信消息发送成功");
    }
    
    @Override
    public boolean isAvailable() {
        return isConfigured && appId != null && !appId.isEmpty();
    }
    
    @Override
    public void configure(Map<String, String> config) {
        this.appId = config.get("wechat.app.id");
        this.appSecret = config.get("wechat.app.secret");
        this.accessToken = config.get("wechat.access.token");
        this.isConfigured = true;
        System.out.println("微信发送器配置完成");
    }
    
    @Override
    public String getProviderName() {
        return "WeChat";
    }
}

// 抽象类 - 消息
abstract class Message {
    protected MessageSender messageSender;
    protected String content;
    protected String sender;
    protected Date timestamp;
    protected MessagePriority priority;
    
    public Message(MessageSender messageSender) {
        this.messageSender = messageSender;
        this.timestamp = new Date();
        this.priority = MessagePriority.NORMAL;
    }
    
    public abstract void send(String recipient);
    public abstract String formatMessage();
    
    // 通用方法
    public void setContent(String content) {
        this.content = content;
    }
    
    public void setSender(String sender) {
        this.sender = sender;
    }
    
    public void setPriority(MessagePriority priority) {
        this.priority = priority;
    }
    
    public String getProviderName() {
        return messageSender.getProviderName();
    }
    
    public boolean isProviderAvailable() {
        return messageSender.isAvailable();
    }
    
    protected String getPriorityPrefix() {
        switch (priority) {
            case HIGH: return "[紧急] ";
            case LOW: return "[普通] ";
            default: return "";
        }
    }
}

// 消息优先级枚举
enum MessagePriority {
    HIGH, NORMAL, LOW
}

// 扩展抽象类 - 通知消息
class NotificationMessage extends Message {
    private String title;
    private String category;
    
    public NotificationMessage(MessageSender messageSender) {
        super(messageSender);
        this.category = "系统通知";
    }
    
    @Override
    public void send(String recipient) {
        if (!messageSender.isAvailable()) {
            throw new IllegalStateException("消息发送器不可用: " + messageSender.getProviderName());
        }
        
        String formattedMessage = formatMessage();
        System.out.printf("发送通知消息 [%s]:%n", category);
        messageSender.sendMessage(formattedMessage, recipient);
    }
    
    @Override
    public String formatMessage() {
        StringBuilder sb = new StringBuilder();
        sb.append(getPriorityPrefix());
        if (title != null) {
            sb.append("标题: ").append(title).append("\n");
        }
        sb.append("内容: ").append(content).append("\n");
        sb.append("发送时间: ").append(timestamp).append("\n");
        if (sender != null) {
            sb.append("发送者: ").append(sender);
        }
        return sb.toString();
    }
    
    public void setTitle(String title) {
        this.title = title;
    }
    
    public void setCategory(String category) {
        this.category = category;
    }
}

// 扩展抽象类 - 营销消息
class MarketingMessage extends Message {
    private String campaignId;
    private String productName;
    private double discountRate;
    private Date expiryDate;
    
    public MarketingMessage(MessageSender messageSender) {
        super(messageSender);
    }
    
    @Override
    public void send(String recipient) {
        if (!messageSender.isAvailable()) {
            throw new IllegalStateException("消息发送器不可用: " + messageSender.getProviderName());
        }
        
        String formattedMessage = formatMessage();
        System.out.printf("发送营销消息 [活动ID: %s]:%n", campaignId);
        messageSender.sendMessage(formattedMessage, recipient);
    }
    
    @Override
    public String formatMessage() {
        StringBuilder sb = new StringBuilder();
        sb.append(getPriorityPrefix());
        sb.append("🎉 特惠活动通知 🎉\n");
        if (productName != null) {
            sb.append("产品: ").append(productName).append("\n");
        }
        if (discountRate > 0) {
            sb.append("折扣: ").append(String.format("%.0f%%", discountRate * 100)).append(" OFF\n");
        }
        sb.append("详情: ").append(content).append("\n");
        if (expiryDate != null) {
            sb.append("有效期至: ").append(expiryDate).append("\n");
        }
        sb.append("活动ID: ").append(campaignId);
        return sb.toString();
    }
    
    public void setCampaignId(String campaignId) {
        this.campaignId = campaignId;
    }
    
    public void setProductName(String productName) {
        this.productName = productName;
    }
    
    public void setDiscountRate(double discountRate) {
        this.discountRate = discountRate;
    }
    
    public void setExpiryDate(Date expiryDate) {
        this.expiryDate = expiryDate;
    }
}

// 扩展抽象类 - 警报消息
class AlertMessage extends Message {
    private AlertLevel alertLevel;
    private String systemName;
    private String errorCode;
    
    public AlertMessage(MessageSender messageSender) {
        super(messageSender);
        this.alertLevel = AlertLevel.WARNING;
        this.priority = MessagePriority.HIGH; // 警报消息默认高优先级
    }
    
    @Override
    public void send(String recipient) {
        if (!messageSender.isAvailable()) {
            throw new IllegalStateException("消息发送器不可用: " + messageSender.getProviderName());
        }
        
        String formattedMessage = formatMessage();
        System.out.printf("发送警报消息 [%s级别]:%n", alertLevel);
        messageSender.sendMessage(formattedMessage, recipient);
    }
    
    @Override
    public String formatMessage() {
        StringBuilder sb = new StringBuilder();
        sb.append(getAlertPrefix()).append(getPriorityPrefix());
        sb.append("系统警报\n");
        sb.append("级别: ").append(alertLevel).append("\n");
        if (systemName != null) {
            sb.append("系统: ").append(systemName).append("\n");
        }
        if (errorCode != null) {
            sb.append("错误代码: ").append(errorCode).append("\n");
        }
        sb.append("详情: ").append(content).append("\n");
        sb.append("时间: ").append(timestamp);
        return sb.toString();
    }
    
    private String getAlertPrefix() {
        switch (alertLevel) {
            case CRITICAL: return "🚨 [严重] ";
            case ERROR: return "❌ [错误] ";
            case WARNING: return "⚠️ [警告] ";
            default: return "ℹ️ [信息] ";
        }
    }
    
    public void setAlertLevel(AlertLevel alertLevel) {
        this.alertLevel = alertLevel;
    }
    
    public void setSystemName(String systemName) {
        this.systemName = systemName;
    }
    
    public void setErrorCode(String errorCode) {
        this.errorCode = errorCode;
    }
}

// 警报级别枚举
enum AlertLevel {
    INFO, WARNING, ERROR, CRITICAL
}

// 消息发送器工厂
class MessageSenderFactory {
    public static MessageSender createEmailSender() {
        EmailSender sender = new EmailSender();
        Map<String, String> config = new HashMap<>();
        config.put("smtp.server", "smtp.gmail.com");
        config.put("smtp.port", "587");
        config.put("smtp.username", "user@gmail.com");
        config.put("smtp.password", "password");
        sender.configure(config);
        return sender;
    }
    
    public static MessageSender createSMSSender() {
        SMSSender sender = new SMSSender();
        Map<String, String> config = new HashMap<>();
        config.put("sms.api.key", "your-api-key");
        config.put("sms.api.secret", "your-api-secret");
        config.put("sms.service.url", "https://api.sms-service.com");
        sender.configure(config);
        return sender;
    }
    
    public static MessageSender createWeChatSender() {
        WeChatSender sender = new WeChatSender();
        Map<String, String> config = new HashMap<>();
        config.put("wechat.app.id", "your-app-id");
        config.put("wechat.app.secret", "your-app-secret");
        config.put("wechat.access.token", "your-access-token");
        sender.configure(config);
        return sender;
    }
}

// 使用示例
public class MessageBridgeExample {
    public static void main(String[] args) {
        System.out.println("=== 桥接模式消息发送系统 ===");
        
        // 创建不同的消息发送器
        MessageSender emailSender = MessageSenderFactory.createEmailSender();
        MessageSender smsSender = MessageSenderFactory.createSMSSender();
        MessageSender wechatSender = MessageSenderFactory.createWeChatSender();
        
        // 发送通知消息
        System.out.println("\n--- 发送通知消息 ---");
        NotificationMessage notification = new NotificationMessage(emailSender);
        notification.setTitle("系统维护通知");
        notification.setContent("系统将于今晚22:00-24:00进行维护，期间服务可能中断。");
        notification.setSender("系统管理员");
        notification.setPriority(MessagePriority.HIGH);
        notification.send("user@example.com");
        
        // 使用不同发送器发送相同通知
        NotificationMessage smsNotification = new NotificationMessage(smsSender);
        smsNotification.setTitle("系统维护通知");
        smsNotification.setContent("系统维护中，请稍后访问。");
        smsNotification.setPriority(MessagePriority.HIGH);
        smsNotification.send("13800138000");
        
        // 发送营销消息
        System.out.println("\n--- 发送营销消息 ---");
        MarketingMessage marketing = new MarketingMessage(wechatSender);
        marketing.setCampaignId("SUMMER2024");
        marketing.setProductName("夏季新品");
        marketing.setDiscountRate(0.3);
        marketing.setExpiryDate(new Date(System.currentTimeMillis() + 7 * 24 * 60 * 60 * 1000L));
        marketing.setContent("夏季新品大促销，全场7折优惠，限时7天！");
        marketing.setPriority(MessagePriority.NORMAL);
        marketing.send("wechat_user_123");
        
        // 发送警报消息
        System.out.println("\n--- 发送警报消息 ---");
        AlertMessage alert = new AlertMessage(emailSender);
        alert.setAlertLevel(AlertLevel.CRITICAL);
        alert.setSystemName("订单处理系统");
        alert.setErrorCode("SYS_001");
        alert.setContent("数据库连接失败，订单处理服务已停止");
        alert.setSender("监控系统");
        alert.send("admin@example.com");
        
        // 演示桥接模式的灵活性 - 运行时切换实现
        System.out.println("\n--- 运行时切换发送器 ---");
        List<MessageSender> senders = Arrays.asList(emailSender, smsSender, wechatSender);
        
        NotificationMessage flexibleNotification = new NotificationMessage(emailSender);
        flexibleNotification.setTitle("多渠道通知测试");
        flexibleNotification.setContent("这是一条测试消息，将通过不同渠道发送");
        
        for (MessageSender sender : senders) {
            // 运行时切换实现
            flexibleNotification = new NotificationMessage(sender);
            flexibleNotification.setTitle("多渠道通知测试");
            flexibleNotification.setContent("通过 " + sender.getProviderName() + " 发送的测试消息");
            
            String recipient = getRecipientForSender(sender);
            flexibleNotification.send(recipient);
        }
    }
    
    private static String getRecipientForSender(MessageSender sender) {
        switch (sender.getProviderName()) {
            case "Email": return "test@example.com";
            case "SMS": return "13800138000";
            case "WeChat": return "wechat_test_user";
            default: return "unknown";
        }
    }
}
```

**桥接模式的关键特点：**
1. **分离抽象和实现**: 抽象和实现可以独立变化
2. **运行时绑定**: 可以在运行时选择具体的实现
3. **避免永久绑定**: 抽象和实现之间没有永久的绑定关系
4. **扩展性好**: 可以独立扩展抽象层次和实现层次
5. **隐藏实现细节**: 客户端代码不需要了解具体的实现细节

#### 参与者概念
- **抽象类**：定义抽象接口，维护实现对象的引用
- **扩展抽象类**：扩展抽象接口
- **实现接口**：定义实现类的接口
- **具体实现类**：实现具体的实现接口

### 3. 组合模式 (Composite)

#### 核心概念
- **组合**：将对象组合成树形结构表示部分-整体层次
- **组件**：组合中对象的统一接口
- **叶子**：组合中的叶子节点
- **容器**：组合中的容器节点
- **递归结构**：树形结构的递归特性

#### 基础例子：文件系统结构
```java
// 组件接口 - 文件系统组件
abstract class FileSystemComponent {
    protected String name;
    
    public FileSystemComponent(String name) {
        this.name = name;
    }
    
    public String getName() {
        return name;
    }
    
    // 公共操作
    public abstract void display(int depth);
    public abstract long getSize();
    
    // 容器操作 - 默认抛出异常，只有容器类重写
    public void add(FileSystemComponent component) {
        throw new UnsupportedOperationException("不支持添加操作");
    }
    
    public void remove(FileSystemComponent component) {
        throw new UnsupportedOperationException("不支持删除操作");
    }
    
    public FileSystemComponent getChild(int index) {
        throw new UnsupportedOperationException("不支持获取子组件操作");
    }
    
    protected String getIndent(int depth) {
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < depth; i++) {
            sb.append("  ");
        }
        return sb.toString();
    }
}

// 叶子组件 - 文件
class File extends FileSystemComponent {
    private long size;
    private String extension;
    
    public File(String name, long size) {
        super(name);
        this.size = size;
        this.extension = getFileExtension(name);
    }
    
    @Override
    public void display(int depth) {
        System.out.printf("%s📄 %s (%d bytes)%n", getIndent(depth), name, size);
    }
    
    @Override
    public long getSize() {
        return size;
    }
    
    public String getExtension() {
        return extension;
    }
    
    private String getFileExtension(String fileName) {
        int lastDot = fileName.lastIndexOf('.');
        return lastDot > 0 ? fileName.substring(lastDot + 1) : "";
    }
}

// 容器组件 - 目录
class Directory extends FileSystemComponent {
    private List<FileSystemComponent> children;
    
    public Directory(String name) {
        super(name);
        this.children = new ArrayList<>();
    }
    
    @Override
    public void add(FileSystemComponent component) {
        children.add(component);
    }
    
    @Override
    public void remove(FileSystemComponent component) {
        children.remove(component);
    }
    
    @Override
    public FileSystemComponent getChild(int index) {
        if (index >= 0 && index < children.size()) {
            return children.get(index);
        }
        throw new IndexOutOfBoundsException("索引超出范围: " + index);
    }
    
    @Override
    public void display(int depth) {
        System.out.printf("%s📁 %s/ (%d items, %d bytes total)%n", 
                         getIndent(depth), name, children.size(), getSize());
        
        // 递归显示子组件
        for (FileSystemComponent child : children) {
            child.display(depth + 1);
        }
    }
    
    @Override
    public long getSize() {
        long totalSize = 0;
        for (FileSystemComponent child : children) {
            totalSize += child.getSize();
        }
        return totalSize;
    }
    
    public int getChildCount() {
        return children.size();
    }
    
    public List<FileSystemComponent> getChildren() {
        return new ArrayList<>(children);
    }
    
    // 查找文件
    public List<File> findFiles(String extension) {
        List<File> result = new ArrayList<>();
        findFilesRecursive(extension, result);
        return result;
    }
    
    private void findFilesRecursive(String extension, List<File> result) {
        for (FileSystemComponent child : children) {
            if (child instanceof File) {
                File file = (File) child;
                if (extension == null || extension.equals(file.getExtension())) {
                    result.add(file);
                }
            } else if (child instanceof Directory) {
                ((Directory) child).findFilesRecursive(extension, result);
            }
        }
    }
}

// 使用示例
public class CompositeExample {
    public static void main(String[] args) {
        // 创建根目录
        Directory root = new Directory("root");
        
        // 创建子目录
        Directory documents = new Directory("Documents");
        Directory pictures = new Directory("Pictures");
        Directory music = new Directory("Music");
        
        // 创建文件
        File readme = new File("README.txt", 1024);
        File config = new File("config.json", 512);
        
        File photo1 = new File("vacation.jpg", 2048000);
        File photo2 = new File("family.png", 1536000);
        
        File song1 = new File("favorite.mp3", 4096000);
        File song2 = new File("classical.wav", 8192000);
        
        // 构建文件系统树
        root.add(readme);
        root.add(config);
        root.add(documents);
        root.add(pictures);
        root.add(music);
        
        documents.add(new File("report.docx", 256000));
        documents.add(new File("presentation.pptx", 512000));
        
        pictures.add(photo1);
        pictures.add(photo2);
        
        music.add(song1);
        music.add(song2);
        
        // 显示文件系统结构
        System.out.println("=== 文件系统结构 ===");
        root.display(0);
        
        // 查找特定类型的文件
        System.out.println("\n=== 查找图片文件 ===");
        List<File> imageFiles = root.findFiles("jpg");
        imageFiles.addAll(root.findFiles("png"));
        
        for (File file : imageFiles) {
            System.out.println("找到图片: " + file.getName() + " (" + file.getSize() + " bytes)");
        }
        
        // 统计信息
        System.out.println("\n=== 统计信息 ===");
        System.out.println("总大小: " + root.getSize() + " bytes");
        System.out.println("Documents目录大小: " + documents.getSize() + " bytes");
        System.out.println("Pictures目录大小: " + pictures.getSize() + " bytes");
        System.out.println("Music目录大小: " + music.getSize() + " bytes");
    }
}
```

#### 进阶例子：企业组织架构系统
```java
import java.util.*;
import java.util.stream.Collectors;

// 组件接口 - 组织单元
abstract class OrganizationUnit {
    protected String name;
    protected String code;
    protected String description;
    protected Date createdDate;
    protected boolean active;
    
    public OrganizationUnit(String name, String code, String description) {
        this.name = name;
        this.code = code;
        this.description = description;
        this.createdDate = new Date();
        this.active = true;
    }
    
    // 公共方法
    public abstract void display(int depth);
    public abstract int getEmployeeCount();
    public abstract double getTotalSalary();
    public abstract List<Employee> getAllEmployees();
    public abstract void accept(OrganizationVisitor visitor);
    
    // 容器方法 - 默认实现
    public void add(OrganizationUnit unit) {
        throw new UnsupportedOperationException("不支持添加子单元");
    }
    
    public void remove(OrganizationUnit unit) {
        throw new UnsupportedOperationException("不支持删除子单元");
    }
    
    public List<OrganizationUnit> getChildren() {
        return Collections.emptyList();
    }
    
    public OrganizationUnit findByCode(String code) {
        return this.code.equals(code) ? this : null;
    }
    
    // Getter方法
    public String getName() { return name; }
    public String getCode() { return code; }
    public String getDescription() { return description; }
    public Date getCreatedDate() { return createdDate; }
    public boolean isActive() { return active; }
    public void setActive(boolean active) { this.active = active; }
    
    protected String getIndent(int depth) {
        return "  ".repeat(depth);
    }
}

// 叶子组件 - 员工
class Employee extends OrganizationUnit {
    private String position;
    private double salary;
    private String email;
    private String phone;
    private EmployeeLevel level;
    private Date hireDate;
    private Employee manager;
    
    public Employee(String name, String code, String position, double salary) {
        super(name, code, "员工: " + name);
        this.position = position;
        this.salary = salary;
        this.level = EmployeeLevel.JUNIOR;
        this.hireDate = new Date();
    }
    
    @Override
    public void display(int depth) {
        String status = active ? "在职" : "离职";
        System.out.printf("%s👤 %s (%s) - %s - ¥%.2f - %s%n", 
                         getIndent(depth), name, code, position, salary, status);
    }
    
    @Override
    public int getEmployeeCount() {
        return active ? 1 : 0;
    }
    
    @Override
    public double getTotalSalary() {
        return active ? salary : 0;
    }
    
    @Override
    public List<Employee> getAllEmployees() {
        return active ? Arrays.asList(this) : Collections.emptyList();
    }
    
    @Override
    public void accept(OrganizationVisitor visitor) {
        visitor.visitEmployee(this);
    }
    
    // Getter和Setter方法
    public String getPosition() { return position; }
    public void setPosition(String position) { this.position = position; }
    public double getSalary() { return salary; }
    public void setSalary(double salary) { this.salary = salary; }
    public String getEmail() { return email; }
    public void setEmail(String email) { this.email = email; }
    public String getPhone() { return phone; }
    public void setPhone(String phone) { this.phone = phone; }
    public EmployeeLevel getLevel() { return level; }
    public void setLevel(EmployeeLevel level) { this.level = level; }
    public Date getHireDate() { return hireDate; }
    public Employee getManager() { return manager; }
    public void setManager(Employee manager) { this.manager = manager; }
}

// 员工级别枚举
enum EmployeeLevel {
    INTERN("实习生"), JUNIOR("初级"), SENIOR("高级"), LEAD("主管"), MANAGER("经理"), DIRECTOR("总监");
    
    private String displayName;
    
    EmployeeLevel(String displayName) {
        this.displayName = displayName;
    }
    
    public String getDisplayName() {
        return displayName;
    }
}

// 容器组件 - 部门
class Department extends OrganizationUnit {
    private List<OrganizationUnit> children;
    private Employee manager;
    private String location;
    private double budget;
    private DepartmentType type;
    
    public Department(String name, String code, String description, DepartmentType type) {
        super(name, code, description);
        this.children = new ArrayList<>();
        this.type = type;
        this.budget = 0.0;
    }
    
    @Override
    public void add(OrganizationUnit unit) {
        children.add(unit);
    }
    
    @Override
    public void remove(OrganizationUnit unit) {
        children.remove(unit);
    }
    
    @Override
    public List<OrganizationUnit> getChildren() {
        return new ArrayList<>(children);
    }
    
    @Override
    public OrganizationUnit findByCode(String code) {
        if (this.code.equals(code)) {
            return this;
        }
        
        for (OrganizationUnit child : children) {
            OrganizationUnit found = child.findByCode(code);
            if (found != null) {
                return found;
            }
        }
        return null;
    }
    
    @Override
    public void display(int depth) {
        String managerInfo = manager != null ? " (负责人: " + manager.getName() + ")" : "";
        System.out.printf("%s🏢 %s (%s) - %s - %d个子单元 - 预算: ¥%.2f%s%n", 
                         getIndent(depth), name, code, type.getDisplayName(), 
                         children.size(), budget, managerInfo);
        
        // 递归显示子单元
        for (OrganizationUnit child : children) {
            child.display(depth + 1);
        }
    }
    
    @Override
    public int getEmployeeCount() {
        if (!active) return 0;
        
        int count = 0;
        for (OrganizationUnit child : children) {
            count += child.getEmployeeCount();
        }
        return count;
    }
    
    @Override
    public double getTotalSalary() {
        if (!active) return 0;
        
        double total = 0;
        for (OrganizationUnit child : children) {
            total += child.getTotalSalary();
        }
        return total;
    }
    
    @Override
    public List<Employee> getAllEmployees() {
        if (!active) return Collections.emptyList();
        
        List<Employee> allEmployees = new ArrayList<>();
        for (OrganizationUnit child : children) {
            allEmployees.addAll(child.getAllEmployees());
        }
        return allEmployees;
    }
    
    @Override
    public void accept(OrganizationVisitor visitor) {
        visitor.visitDepartment(this);
        for (OrganizationUnit child : children) {
            child.accept(visitor);
        }
    }
    
    // 部门特有方法
    public List<Employee> getEmployeesByLevel(EmployeeLevel level) {
        return getAllEmployees().stream()
                .filter(emp -> emp.getLevel() == level)
                .collect(Collectors.toList());
    }
    
    public List<Employee> getEmployeesByPosition(String position) {
        return getAllEmployees().stream()
                .filter(emp -> emp.getPosition().contains(position))
                .collect(Collectors.toList());
    }
    
    public double getAverageSalary() {
        List<Employee> employees = getAllEmployees();
        if (employees.isEmpty()) return 0;
        
        return employees.stream()
                .mapToDouble(Employee::getSalary)
                .average()
                .orElse(0);
    }
    
    // Getter和Setter方法
    public Employee getManager() { return manager; }
    public void setManager(Employee manager) { this.manager = manager; }
    public String getLocation() { return location; }
    public void setLocation(String location) { this.location = location; }
    public double getBudget() { return budget; }
    public void setBudget(double budget) { this.budget = budget; }
    public DepartmentType getType() { return type; }
}

// 部门类型枚举
enum DepartmentType {
    HEADQUARTERS("总部"), BRANCH("分公司"), DIVISION("事业部"), 
    DEPARTMENT("部门"), TEAM("团队"), PROJECT_GROUP("项目组");
    
    private String displayName;
    
    DepartmentType(String displayName) {
        this.displayName = displayName;
    }
    
    public String getDisplayName() {
        return displayName;
    }
}

// 访问者接口 - 用于遍历组织结构
interface OrganizationVisitor {
    void visitEmployee(Employee employee);
    void visitDepartment(Department department);
}

// 具体访问者 - 统计访问者
class StatisticsVisitor implements OrganizationVisitor {
    private int totalEmployees = 0;
    private int totalDepartments = 0;
    private double totalSalary = 0;
    private Map<EmployeeLevel, Integer> levelCount = new HashMap<>();
    private Map<DepartmentType, Integer> departmentTypeCount = new HashMap<>();
    
    @Override
    public void visitEmployee(Employee employee) {
        if (employee.isActive()) {
            totalEmployees++;
            totalSalary += employee.getSalary();
            levelCount.merge(employee.getLevel(), 1, Integer::sum);
        }
    }
    
    @Override
    public void visitDepartment(Department department) {
        if (department.isActive()) {
            totalDepartments++;
            departmentTypeCount.merge(department.getType(), 1, Integer::sum);
        }
    }
    
    public void printStatistics() {
        System.out.println("=== 组织统计信息 ===");
        System.out.println("总员工数: " + totalEmployees);
        System.out.println("总部门数: " + totalDepartments);
        System.out.printf("总薪资: ¥%.2f%n", totalSalary);
        System.out.printf("平均薪资: ¥%.2f%n", totalEmployees > 0 ? totalSalary / totalEmployees : 0);
        
        System.out.println("\n员工级别分布:");
        levelCount.forEach((level, count) -> 
            System.out.println("  " + level.getDisplayName() + ": " + count + "人"));
        
        System.out.println("\n部门类型分布:");
        departmentTypeCount.forEach((type, count) -> 
            System.out.println("  " + type.getDisplayName() + ": " + count + "个"));
    }
}

// 具体访问者 - 报告生成器
class ReportVisitor implements OrganizationVisitor {
    private StringBuilder report = new StringBuilder();
    private int depth = 0;
    
    @Override
    public void visitEmployee(Employee employee) {
        report.append("  ".repeat(depth))
              .append("员工: ").append(employee.getName())
              .append(" (").append(employee.getPosition()).append(")")
              .append(" - ¥").append(employee.getSalary())
              .append("\n");
    }
    
    @Override
    public void visitDepartment(Department department) {
        report.append("  ".repeat(depth))
              .append("部门: ").append(department.getName())
              .append(" (").append(department.getCode()).append(")")
              .append(" - ").append(department.getType().getDisplayName())
              .append("\n");
        depth++;
        
        // 访问完子节点后恢复深度
        // 注意：这里简化处理，实际应该在访问完所有子节点后恢复
    }
    
    public String getReport() {
        return report.toString();
    }
}

// 使用示例
public class OrganizationCompositeExample {
    public static void main(String[] args) {
        // 创建公司组织架构
        Department company = new Department("科技有限公司", "COMP001", "一家创新的科技公司", DepartmentType.HEADQUARTERS);
        company.setBudget(10000000);
        
        // 创建一级部门
        Department techDept = new Department("技术部", "TECH001", "负责产品研发", DepartmentType.DEPARTMENT);
        Department salesDept = new Department("销售部", "SALES001", "负责市场销售", DepartmentType.DEPARTMENT);
        Department hrDept = new Department("人力资源部", "HR001", "负责人力资源管理", DepartmentType.DEPARTMENT);
        
        // 创建技术部子部门
        Department devTeam = new Department("开发团队", "DEV001", "软件开发团队", DepartmentType.TEAM);
        Department qaTeam = new Department("测试团队", "QA001", "质量保证团队", DepartmentType.TEAM);
        
        // 创建员工
        Employee ceo = new Employee("张总", "CEO001", "首席执行官", 50000);
        ceo.setLevel(EmployeeLevel.DIRECTOR);
        
        Employee techManager = new Employee("李经理", "TM001", "技术经理", 25000);
        techManager.setLevel(EmployeeLevel.MANAGER);
        
        Employee dev1 = new Employee("王开发", "DEV001", "高级开发工程师", 15000);
        dev1.setLevel(EmployeeLevel.SENIOR);
        
        Employee dev2 = new Employee("赵开发", "DEV002", "初级开发工程师", 8000);
        dev2.setLevel(EmployeeLevel.JUNIOR);
        
        Employee qa1 = new Employee("钱测试", "QA001", "测试工程师", 12000);
        qa1.setLevel(EmployeeLevel.SENIOR);
        
        Employee sales1 = new Employee("孙销售", "SALES001", "销售经理", 18000);
        sales1.setLevel(EmployeeLevel.MANAGER);
        
        Employee hr1 = new Employee("周人事", "HR001", "人事专员", 10000);
        hr1.setLevel(EmployeeLevel.JUNIOR);
        
        // 构建组织架构树
        company.add(ceo);
        company.add(techDept);
        company.add(salesDept);
        company.add(hrDept);
        
        techDept.add(techManager);
        techDept.add(devTeam);
        techDept.add(qaTeam);
        techDept.setManager(techManager);
        
        devTeam.add(dev1);
        devTeam.add(dev2);
        
        qaTeam.add(qa1);
        
        salesDept.add(sales1);
        salesDept.setManager(sales1);
        
        hrDept.add(hr1);
        
        // 显示组织架构
        System.out.println("=== 公司组织架构 ===");
        company.display(0);
        
        // 统计信息
        System.out.println("\n=== 基本统计 ===");
        System.out.println("总员工数: " + company.getEmployeeCount());
        System.out.printf("总薪资支出: ¥%.2f%n", company.getTotalSalary());
        System.out.printf("技术部员工数: %d%n", techDept.getEmployeeCount());
        System.out.printf("技术部平均薪资: ¥%.2f%n", techDept.getAverageSalary());
        
        // 查找功能
        System.out.println("\n=== 查找功能 ===");
        OrganizationUnit found = company.findByCode("DEV001");
        if (found != null) {
            System.out.println("找到单元: " + found.getName() + " (" + found.getCode() + ")");
        }
        
        // 按级别查找员工
        List<Employee> managers = techDept.getEmployeesByLevel(EmployeeLevel.MANAGER);
        System.out.println("技术部经理级别员工:");
        managers.forEach(emp -> System.out.println("  " + emp.getName() + " - " + emp.getPosition()));
        
        // 按职位查找员工
        List<Employee> developers = company.getAllEmployees().stream()
                .filter(emp -> emp.getPosition().contains("开发"))
                .collect(Collectors.toList());
        System.out.println("所有开发人员:");
        developers.forEach(emp -> System.out.println("  " + emp.getName() + " - " + emp.getPosition()));
        
        // 使用访问者模式进行统计
        System.out.println("\n=== 访问者模式统计 ===");
        StatisticsVisitor statsVisitor = new StatisticsVisitor();
        company.accept(statsVisitor);
        statsVisitor.printStatistics();
        
        // 生成报告
        System.out.println("\n=== 组织架构报告 ===");
        ReportVisitor reportVisitor = new ReportVisitor();
        company.accept(reportVisitor);
        System.out.println(reportVisitor.getReport());
        
        // 演示动态修改
        System.out.println("\n=== 动态修改演示 ===");
        
        // 添加新员工
        Employee newDev = new Employee("新开发", "DEV003", "中级开发工程师", 12000);
        newDev.setLevel(EmployeeLevel.SENIOR);
        devTeam.add(newDev);
        
        // 员工离职
        dev2.setActive(false);
        
        System.out.println("修改后的开发团队:");
        devTeam.display(0);
        
        System.out.println("修改后技术部统计:");
        System.out.println("员工数: " + techDept.getEmployeeCount());
        System.out.printf("总薪资: ¥%.2f%n", techDept.getTotalSalary());
    }
}
```

**组合模式的关键特点：**
1. **统一接口**: 叶子和容器对象实现相同的接口
2. **递归结构**: 支持任意深度的树形结构
3. **透明性**: 客户端可以一致地处理叶子和容器对象
4. **灵活性**: 可以动态地添加、删除和修改树形结构
5. **简化客户端**: 客户端不需要区分叶子和容器对象

#### 实现概念
- **透明方式**：组件接口包含所有子组件管理方法
- **安全方式**：组件接口只包含公共方法
- **树形遍历**：遍历组合结构的方法

### 4. 装饰器模式 (Decorator)

#### 核心概念
- **装饰器**：动态地给对象添加额外的职责
- **组件**：定义对象的接口
- **装饰**：在不改变接口的前提下扩展功能
- **装饰链**：多个装饰器的组合

#### 基础例子：咖啡订购系统
```java
// 组件接口 - 饮品
interface Beverage {
    String getDescription();
    double getCost();
}

// 具体组件 - 基础咖啡
class Espresso implements Beverage {
    @Override
    public String getDescription() {
        return "浓缩咖啡";
    }
    
    @Override
    public double getCost() {
        return 15.0;
    }
}

class HouseBlend implements Beverage {
    @Override
    public String getDescription() {
        return "综合咖啡";
    }
    
    @Override
    public double getCost() {
        return 12.0;
    }
}

class DarkRoast implements Beverage {
    @Override
    public String getDescription() {
        return "深度烘焙咖啡";
    }
    
    @Override
    public double getCost() {
        return 18.0;
    }
}

// 抽象装饰器
abstract class CondimentDecorator implements Beverage {
    protected Beverage beverage;
    
    public CondimentDecorator(Beverage beverage) {
        this.beverage = beverage;
    }
    
    @Override
    public abstract String getDescription();
}

// 具体装饰器 - 牛奶
class Milk extends CondimentDecorator {
    public Milk(Beverage beverage) {
        super(beverage);
    }
    
    @Override
    public String getDescription() {
        return beverage.getDescription() + " + 牛奶";
    }
    
    @Override
    public double getCost() {
        return beverage.getCost() + 3.0;
    }
}

// 具体装饰器 - 豆浆
class Soy extends CondimentDecorator {
    public Soy(Beverage beverage) {
        super(beverage);
    }
    
    @Override
    public String getDescription() {
        return beverage.getDescription() + " + 豆浆";
    }
    
    @Override
    public double getCost() {
        return beverage.getCost() + 4.0;
    }
}

// 具体装饰器 - 摩卡
class Mocha extends CondimentDecorator {
    public Mocha(Beverage beverage) {
        super(beverage);
    }
    
    @Override
    public String getDescription() {
        return beverage.getDescription() + " + 摩卡";
    }
    
    @Override
    public double getCost() {
        return beverage.getCost() + 5.0;
    }
}

// 具体装饰器 - 奶泡
class Whip extends CondimentDecorator {
    public Whip(Beverage beverage) {
        super(beverage);
    }
    
    @Override
    public String getDescription() {
        return beverage.getDescription() + " + 奶泡";
    }
    
    @Override
    public double getCost() {
        return beverage.getCost() + 2.0;
    }
}

// 使用示例
public class DecoratorExample {
    public static void main(String[] args) {
        // 订购一杯浓缩咖啡
        Beverage beverage1 = new Espresso();
        System.out.println(beverage1.getDescription() + " ¥" + beverage1.getCost());
        
        // 订购一杯深度烘焙咖啡，加牛奶和摩卡
        Beverage beverage2 = new DarkRoast();
        beverage2 = new Milk(beverage2);
        beverage2 = new Mocha(beverage2);
        System.out.println(beverage2.getDescription() + " ¥" + beverage2.getCost());
        
        // 订购一杯综合咖啡，加豆浆、摩卡和奶泡
        Beverage beverage3 = new HouseBlend();
        beverage3 = new Soy(beverage3);
        beverage3 = new Mocha(beverage3);
        beverage3 = new Whip(beverage3);
        System.out.println(beverage3.getDescription() + " ¥" + beverage3.getCost());
        
        // 订购一杯浓缩咖啡，加双份摩卡
        Beverage beverage4 = new Espresso();
        beverage4 = new Mocha(beverage4);
        beverage4 = new Mocha(beverage4); // 双份摩卡
        beverage4 = new Whip(beverage4);
        System.out.println(beverage4.getDescription() + " ¥" + beverage4.getCost());
    }
}
```

#### 进阶例子：数据处理管道系统
```java
import java.util.*;
import java.util.function.Function;
import java.util.stream.Collectors;

// 组件接口 - 数据处理器
interface DataProcessor<T> {
    T process(T data);
    String getProcessorName();
    Map<String, Object> getMetrics();
}

// 具体组件 - 基础数据处理器
class BaseDataProcessor implements DataProcessor<String> {
    private long processCount = 0;
    private long totalProcessTime = 0;
    
    @Override
    public String process(String data) {
        long startTime = System.nanoTime();
        processCount++;
        
        // 基础处理：去除首尾空格
        String result = data != null ? data.trim() : "";
        
        long endTime = System.nanoTime();
        totalProcessTime += (endTime - startTime);
        
        return result;
    }
    
    @Override
    public String getProcessorName() {
        return "基础数据处理器";
    }
    
    @Override
    public Map<String, Object> getMetrics() {
        Map<String, Object> metrics = new HashMap<>();
        metrics.put("processCount", processCount);
        metrics.put("averageProcessTime", processCount > 0 ? totalProcessTime / processCount : 0);
        return metrics;
    }
}

// 抽象装饰器
abstract class DataProcessorDecorator implements DataProcessor<String> {
    protected DataProcessor<String> processor;
    protected long processCount = 0;
    protected long totalProcessTime = 0;
    
    public DataProcessorDecorator(DataProcessor<String> processor) {
        this.processor = processor;
    }
    
    @Override
    public String process(String data) {
        long startTime = System.nanoTime();
        processCount++;
        
        // 先调用被装饰对象的处理方法
        String result = processor.process(data);
        
        // 然后进行装饰处理
        result = doDecorate(result);
        
        long endTime = System.nanoTime();
        totalProcessTime += (endTime - startTime);
        
        return result;
    }
    
    protected abstract String doDecorate(String data);
    
    @Override
    public Map<String, Object> getMetrics() {
        Map<String, Object> metrics = new HashMap<>(processor.getMetrics());
        metrics.put(getProcessorName() + "_processCount", processCount);
        metrics.put(getProcessorName() + "_averageProcessTime", 
                   processCount > 0 ? totalProcessTime / processCount : 0);
        return metrics;
    }
}

// 具体装饰器 - 大小写转换装饰器
class CaseConverterDecorator extends DataProcessorDecorator {
    private CaseType caseType;
    
    public enum CaseType {
        UPPER, LOWER, TITLE
    }
    
    public CaseConverterDecorator(DataProcessor<String> processor, CaseType caseType) {
        super(processor);
        this.caseType = caseType;
    }
    
    @Override
    protected String doDecorate(String data) {
        if (data == null || data.isEmpty()) {
            return data;
        }
        
        switch (caseType) {
            case UPPER:
                return data.toUpperCase();
            case LOWER:
                return data.toLowerCase();
            case TITLE:
                return Arrays.stream(data.split("\\s+"))
                        .map(word -> word.substring(0, 1).toUpperCase() + 
                                   word.substring(1).toLowerCase())
                        .collect(Collectors.joining(" "));
            default:
                return data;
        }
    }
    
    @Override
    public String getProcessorName() {
        return "大小写转换装饰器(" + caseType + ")";
    }
}

// 具体装饰器 - 数据验证装饰器
class ValidationDecorator extends DataProcessorDecorator {
    private List<Function<String, Boolean>> validators;
    private String defaultValue;
    
    public ValidationDecorator(DataProcessor<String> processor, String defaultValue) {
        super(processor);
        this.validators = new ArrayList<>();
        this.defaultValue = defaultValue;
    }
    
    public ValidationDecorator addValidator(Function<String, Boolean> validator) {
        validators.add(validator);
        return this;
    }
    
    @Override
    protected String doDecorate(String data) {
        // 验证数据
        for (Function<String, Boolean> validator : validators) {
            if (!validator.apply(data)) {
                System.out.println("数据验证失败，使用默认值: " + defaultValue);
                return defaultValue;
            }
        }
        return data;
    }
    
    @Override
    public String getProcessorName() {
        return "数据验证装饰器";
    }
}

// 具体装饰器 - 数据清洗装饰器
class DataCleaningDecorator extends DataProcessorDecorator {
    private boolean removeSpecialChars;
    private boolean removeNumbers;
    private boolean removeExtraSpaces;
    
    public DataCleaningDecorator(DataProcessor<String> processor) {
        super(processor);
        this.removeSpecialChars = false;
        this.removeNumbers = false;
        this.removeExtraSpaces = true;
    }
    
    public DataCleaningDecorator removeSpecialChars(boolean remove) {
        this.removeSpecialChars = remove;
        return this;
    }
    
    public DataCleaningDecorator removeNumbers(boolean remove) {
        this.removeNumbers = remove;
        return this;
    }
    
    public DataCleaningDecorator removeExtraSpaces(boolean remove) {
        this.removeExtraSpaces = remove;
        return this;
    }
    
    @Override
    protected String doDecorate(String data) {
        if (data == null || data.isEmpty()) {
            return data;
        }
        
        String result = data;
        
        if (removeSpecialChars) {
            result = result.replaceAll("[^a-zA-Z0-9\\s]", "");
        }
        
        if (removeNumbers) {
            result = result.replaceAll("\\d", "");
        }
        
        if (removeExtraSpaces) {
            result = result.replaceAll("\\s+", " ");
        }
        
        return result;
    }
    
    @Override
    public String getProcessorName() {
        return "数据清洗装饰器";
    }
}

// 具体装饰器 - 日志记录装饰器
class LoggingDecorator extends DataProcessorDecorator {
    private String logLevel;
    private boolean logInput;
    private boolean logOutput;
    private boolean logProcessTime;
    
    public LoggingDecorator(DataProcessor<String> processor, String logLevel) {
        super(processor);
        this.logLevel = logLevel;
        this.logInput = true;
        this.logOutput = true;
        this.logProcessTime = true;
    }
    
    public LoggingDecorator setLogInput(boolean logInput) {
        this.logInput = logInput;
        return this;
    }
    
    public LoggingDecorator setLogOutput(boolean logOutput) {
        this.logOutput = logOutput;
        return this;
    }
    
    public LoggingDecorator setLogProcessTime(boolean logProcessTime) {
        this.logProcessTime = logProcessTime;
        return this;
    }
    
    @Override
    public String process(String data) {
        long startTime = System.nanoTime();
        
        if (logInput) {
            System.out.printf("[%s] 输入数据: '%s'%n", logLevel, data);
        }
        
        String result = super.process(data);
        
        long endTime = System.nanoTime();
        long processTime = endTime - startTime;
        
        if (logOutput) {
            System.out.printf("[%s] 输出数据: '%s'%n", logLevel, result);
        }
        
        if (logProcessTime) {
            System.out.printf("[%s] 处理时间: %d ns%n", logLevel, processTime);
        }
        
        return result;
    }
    
    @Override
    protected String doDecorate(String data) {
        // 日志装饰器不修改数据，只记录日志
        return data;
    }
    
    @Override
    public String getProcessorName() {
        return "日志记录装饰器(" + logLevel + ")";
    }
}

// 具体装饰器 - 缓存装饰器
class CacheDecorator extends DataProcessorDecorator {
    private Map<String, String> cache;
    private int maxCacheSize;
    private long cacheHits = 0;
    private long cacheMisses = 0;
    
    public CacheDecorator(DataProcessor<String> processor, int maxCacheSize) {
        super(processor);
        this.cache = new LinkedHashMap<String, String>(maxCacheSize + 1, 0.75f, true) {
            @Override
            protected boolean removeEldestEntry(Map.Entry<String, String> eldest) {
                return size() > maxCacheSize;
            }
        };
        this.maxCacheSize = maxCacheSize;
    }
    
    @Override
    public String process(String data) {
        // 检查缓存
        if (cache.containsKey(data)) {
            cacheHits++;
            System.out.println("缓存命中: " + data);
            return cache.get(data);
        }
        
        // 缓存未命中，调用实际处理
        cacheMisses++;
        String result = super.process(data);
        
        // 将结果放入缓存
        cache.put(data, result);
        
        return result;
    }
    
    @Override
    protected String doDecorate(String data) {
        // 缓存装饰器不修改数据
        return data;
    }
    
    @Override
    public String getProcessorName() {
        return "缓存装饰器";
    }
    
    @Override
    public Map<String, Object> getMetrics() {
        Map<String, Object> metrics = super.getMetrics();
        metrics.put("cacheHits", cacheHits);
        metrics.put("cacheMisses", cacheMisses);
        metrics.put("cacheHitRate", (cacheHits + cacheMisses) > 0 ? 
                   (double) cacheHits / (cacheHits + cacheMisses) : 0);
        metrics.put("cacheSize", cache.size());
        return metrics;
    }
    
    public void clearCache() {
        cache.clear();
        cacheHits = 0;
        cacheMisses = 0;
    }
}

// 数据处理管道构建器
class DataProcessingPipelineBuilder {
    private DataProcessor<String> processor;
    
    public DataProcessingPipelineBuilder(DataProcessor<String> baseProcessor) {
        this.processor = baseProcessor;
    }
    
    public DataProcessingPipelineBuilder addValidation(String defaultValue) {
        processor = new ValidationDecorator(processor, defaultValue);
        return this;
    }
    
    public DataProcessingPipelineBuilder addValidation(String defaultValue, 
                                                      Function<String, Boolean> validator) {
        ValidationDecorator validationDecorator = new ValidationDecorator(processor, defaultValue);
        validationDecorator.addValidator(validator);
        processor = validationDecorator;
        return this;
    }
    
    public DataProcessingPipelineBuilder addCleaning() {
        processor = new DataCleaningDecorator(processor);
        return this;
    }
    
    public DataProcessingPipelineBuilder addCleaning(boolean removeSpecialChars, 
                                                    boolean removeNumbers, 
                                                    boolean removeExtraSpaces) {
        DataCleaningDecorator cleaningDecorator = new DataCleaningDecorator(processor);
        cleaningDecorator.removeSpecialChars(removeSpecialChars)
                        .removeNumbers(removeNumbers)
                        .removeExtraSpaces(removeExtraSpaces);
        processor = cleaningDecorator;
        return this;
    }
    
    public DataProcessingPipelineBuilder addCaseConversion(CaseConverterDecorator.CaseType caseType) {
        processor = new CaseConverterDecorator(processor, caseType);
        return this;
    }
    
    public DataProcessingPipelineBuilder addLogging(String logLevel) {
        processor = new LoggingDecorator(processor, logLevel);
        return this;
    }
    
    public DataProcessingPipelineBuilder addCache(int maxCacheSize) {
        processor = new CacheDecorator(processor, maxCacheSize);
        return this;
    }
    
    public DataProcessor<String> build() {
        return processor;
    }
}

// 使用示例
public class DataProcessorDecoratorExample {
    public static void main(String[] args) {
        System.out.println("=== 数据处理管道装饰器系统 ===");
        
        // 创建基础处理器
        DataProcessor<String> baseProcessor = new BaseDataProcessor();
        
        // 构建复杂的数据处理管道
        DataProcessor<String> pipeline = new DataProcessingPipelineBuilder(baseProcessor)
                .addValidation("默认值", data -> data != null && !data.isEmpty())
                .addCleaning(true, false, true) // 移除特殊字符，保留数字，移除多余空格
                .addCaseConversion(CaseConverterDecorator.CaseType.TITLE)
                .addCache(10)
                .addLogging("INFO")
                .build();
        
        // 测试数据
        String[] testData = {
            "  hello world!!!  ",
            "JAVA programming123",
            "  design   patterns  ",
            "",
            null,
            "hello world!!!", // 重复数据，测试缓存
            "python@#$%programming",
            "software   ENGINEERING"
        };
        
        System.out.println("\n--- 处理测试数据 ---");
        for (String data : testData) {
            try {
                String result = pipeline.process(data);
                System.out.printf("原始: '%s' -> 结果: '%s'%n", data, result);
                System.out.println();
            } catch (Exception e) {
                System.err.println("处理数据时出错: " + e.getMessage());
            }
        }
        
        // 显示处理器指标
        System.out.println("--- 处理器指标 ---");
        Map<String, Object> metrics = pipeline.getMetrics();
        metrics.forEach((key, value) -> 
            System.out.println(key + ": " + value));
        
        // 演示不同的装饰器组合
        System.out.println("\n=== 不同装饰器组合演示 ===");
        
        // 简单的大小写转换管道
        DataProcessor<String> simplePipeline = new DataProcessingPipelineBuilder(new BaseDataProcessor())
                .addCaseConversion(CaseConverterDecorator.CaseType.UPPER)
                .build();
        
        System.out.println("简单管道处理: " + simplePipeline.process("Hello World"));
        
        // 数据清洗管道
        DataProcessor<String> cleaningPipeline = new DataProcessingPipelineBuilder(new BaseDataProcessor())
                .addCleaning(true, true, true) // 移除特殊字符和数字
                .addCaseConversion(CaseConverterDecorator.CaseType.LOWER)
                .build();
        
        System.out.println("清洗管道处理: " + cleaningPipeline.process("Hello123 World!@#"));
        
        // 带验证的管道
        DataProcessor<String> validationPipeline = new DataProcessingPipelineBuilder(new BaseDataProcessor())
                .addValidation("无效数据", data -> data != null && data.length() > 3)
                .addCaseConversion(CaseConverterDecorator.CaseType.TITLE)
                .build();
        
        System.out.println("验证管道处理短数据: " + validationPipeline.process("Hi"));
        System.out.println("验证管道处理长数据: " + validationPipeline.process("Hello World"));
        
        // 演示装饰器的动态组合
        System.out.println("\n=== 动态装饰器组合 ===");
        DataProcessor<String> dynamicProcessor = new BaseDataProcessor();
        
        // 动态添加装饰器
        dynamicProcessor = new CaseConverterDecorator(dynamicProcessor, CaseConverterDecorator.CaseType.UPPER);
        System.out.println("添加大写转换: " + dynamicProcessor.process("hello"));
        
        dynamicProcessor = new DataCleaningDecorator(dynamicProcessor).removeSpecialChars(true);
        System.out.println("添加数据清洗: " + dynamicProcessor.process("hello@#$world"));
        
        dynamicProcessor = new LoggingDecorator(dynamicProcessor, "DEBUG");
        System.out.println("添加日志记录:");
        dynamicProcessor.process("final test");
    }
}
```

**装饰器模式的关键特点：**
1. **动态扩展**: 可以在运行时动态地给对象添加新功能
2. **组合优于继承**: 通过组合而不是继承来扩展功能
3. **透明性**: 装饰后的对象与原对象具有相同的接口
4. **灵活性**: 可以任意组合多个装饰器
5. **单一职责**: 每个装饰器只负责一种功能的扩展

#### 参与者概念
- **组件接口**：定义对象的接口
- **具体组件**：实现组件接口的基本对象
- **装饰器**：维护组件引用并实现组件接口
- **具体装饰器**：实现具体的装饰功能

### 5. 外观模式 (Facade)

#### 核心概念
- **外观**：为子系统提供统一的高层接口
- **子系统**：实现具体功能的类集合
- **简化接口**：隐藏子系统的复杂性
- **解耦**：客户端与子系统的解耦

#### 实现概念
- **简单外观**：提供简单的统一接口
- **复杂外观**：提供多个层次的接口
- **抽象外观**：定义外观的抽象接口

### 6. 享元模式 (Flyweight)

**定义**：运用共享技术有效地支持大量细粒度的对象。

**GoF原定义**："Use sharing to support large numbers of fine-grained objects efficiently."

**核心思想**
- 将对象的状态分为内部状态（可共享）和外部状态（不可共享）
- 通过共享内部状态相同的对象来减少内存使用
- 外部状态由客户端维护并在需要时传递给享元对象

**基础例子：文本编辑器字符渲染系统**

```java
// 享元接口
interface CharacterFlyweight {
    void display(int row, int col, String color);
}

// 具体享元类 - 字符
class Character implements CharacterFlyweight {
    private char symbol; // 内部状态（可共享）
    
    public Character(char symbol) {
        this.symbol = symbol;
    }
    
    @Override
    public void display(int row, int col, String color) {
        // 外部状态：位置(row, col)和颜色(color)
        System.out.println("显示字符 '" + symbol + "' 在位置(" + 
                          row + "," + col + ") 颜色:" + color);
    }
}

// 享元工厂
class CharacterFactory {
    private static Map<java.lang.Character, CharacterFlyweight> characters = new HashMap<>();
    
    public static CharacterFlyweight getCharacter(char symbol) {
        CharacterFlyweight character = characters.get(symbol);
        if (character == null) {
            character = new Character(symbol);
            characters.put(symbol, character);
            System.out.println("创建新字符享元: " + symbol);
        }
        return character;
    }
    
    public static int getCreatedCharactersCount() {
        return characters.size();
    }
}

// 客户端使用
public class TextEditor {
    public static void main(String[] args) {
        String text = "HELLO WORLD";
        
        // 渲染文本
        for (int i = 0; i < text.length(); i++) {
            char c = text.charAt(i);
            if (c != ' ') {
                CharacterFlyweight character = CharacterFactory.getCharacter(c);
                character.display(0, i, "黑色");
            }
        }
        
        System.out.println("总共创建了 " + CharacterFactory.getCreatedCharactersCount() + 
                          " 个字符享元对象");
        // 输出：总共创建了 7 个字符享元对象（H,E,L,O,W,R,D）
        // 而不是 10 个（因为L重复了3次）
    }
}
```

**进阶例子：游戏粒子系统**

```java
// 粒子类型枚举
enum ParticleType {
    FIRE, WATER, EARTH, AIR
}

// 享元接口
interface ParticleFlyweight {
    void render(double x, double y, double velocity, String color);
    void move(double deltaTime);
}

// 具体享元类 - 粒子
class Particle implements ParticleFlyweight {
    private ParticleType type;        // 内部状态
    private String texture;           // 内部状态
    private double mass;              // 内部状态
    private double baseSpeed;         // 内部状态
    
    public Particle(ParticleType type) {
        this.type = type;
        // 根据类型设置内部状态
        switch (type) {
            case FIRE:
                this.texture = "fire_texture.png";
                this.mass = 0.1;
                this.baseSpeed = 5.0;
                break;
            case WATER:
                this.texture = "water_texture.png";
                this.mass = 1.0;
                this.baseSpeed = 3.0;
                break;
            case EARTH:
                this.texture = "earth_texture.png";
                this.mass = 2.0;
                this.baseSpeed = 1.0;
                break;
            case AIR:
                this.texture = "air_texture.png";
                this.mass = 0.05;
                this.baseSpeed = 8.0;
                break;
        }
    }
    
    @Override
    public void render(double x, double y, double velocity, String color) {
        // 外部状态：位置(x,y)、速度(velocity)、颜色(color)
        System.out.printf("渲染%s粒子 位置:(%.1f,%.1f) 速度:%.1f 颜色:%s 纹理:%s%n",
                         type, x, y, velocity, color, texture);
    }
    
    @Override
    public void move(double deltaTime) {
        // 基于内部状态的移动逻辑
        System.out.printf("%s粒子移动 质量:%.2f 基础速度:%.1f%n", 
                         type, mass, baseSpeed);
    }
}

// 享元工厂
class ParticleFactory {
    private static Map<ParticleType, ParticleFlyweight> particles = new HashMap<>();
    
    public static ParticleFlyweight getParticle(ParticleType type) {
        ParticleFlyweight particle = particles.get(type);
        if (particle == null) {
            particle = new Particle(type);
            particles.put(type, particle);
            System.out.println("创建新粒子享元: " + type);
        }
        return particle;
    }
    
    public static void printStats() {
        System.out.println("享元对象统计:");
        particles.forEach((type, particle) -> 
            System.out.println("- " + type + " 粒子享元"));
    }
}

// 粒子上下文 - 存储外部状态
class ParticleContext {
    private double x, y;              // 外部状态：位置
    private double velocityX, velocityY; // 外部状态：速度
    private String color;             // 外部状态：颜色
    private ParticleFlyweight particle; // 享元引用
    
    public ParticleContext(double x, double y, double vx, double vy, 
                          String color, ParticleType type) {
        this.x = x;
        this.y = y;
        this.velocityX = vx;
        this.velocityY = vy;
        this.color = color;
        this.particle = ParticleFactory.getParticle(type);
    }
    
    public void render() {
        double velocity = Math.sqrt(velocityX * velocityX + velocityY * velocityY);
        particle.render(x, y, velocity, color);
    }
    
    public void update(double deltaTime) {
        x += velocityX * deltaTime;
        y += velocityY * deltaTime;
        particle.move(deltaTime);
    }
}

// 粒子系统管理器
class ParticleSystem {
    private List<ParticleContext> particles = new ArrayList<>();
    
    public void addParticle(double x, double y, double vx, double vy, 
                           String color, ParticleType type) {
        particles.add(new ParticleContext(x, y, vx, vy, color, type));
    }
    
    public void update(double deltaTime) {
        for (ParticleContext particle : particles) {
            particle.update(deltaTime);
        }
    }
    
    public void render() {
        for (ParticleContext particle : particles) {
            particle.render();
        }
    }
    
    public int getParticleCount() {
        return particles.size();
    }
}

// 游戏演示
public class GameDemo {
    public static void main(String[] args) {
        ParticleSystem system = new ParticleSystem();
        
        // 创建大量粒子
        for (int i = 0; i < 1000; i++) {
            double x = Math.random() * 800;
            double y = Math.random() * 600;
            double vx = (Math.random() - 0.5) * 10;
            double vy = (Math.random() - 0.5) * 10;
            
            ParticleType type = ParticleType.values()[(int)(Math.random() * 4)];
            String color = "RGB(" + (int)(Math.random() * 255) + "," + 
                          (int)(Math.random() * 255) + "," + (int)(Math.random() * 255) + ")";
            
            system.addParticle(x, y, vx, vy, color, type);
        }
        
        System.out.println("创建了 " + system.getParticleCount() + " 个粒子实例");
        ParticleFactory.printStats();
        
        // 模拟游戏循环
        system.render();
        system.update(0.016); // 60 FPS
        
        System.out.println("\n享元模式优势:");
        System.out.println("- 1000个粒子实例只需要4个享元对象");
        System.out.println("- 大大减少了内存使用");
        System.out.println("- 提高了系统性能");
    }
}
```

**模式优势**
- **内存效率**：通过共享减少对象数量，节省内存
- **性能提升**：减少对象创建和垃圾回收的开销
- **可扩展性**：支持大量细粒度对象的高效管理

**适用场景**
- 需要创建大量相似对象的系统
- 对象的大部分状态可以外部化
- 可以用较少的共享对象替代大量对象
- 应用程序不依赖于对象标识（对象可以被共享）

#### 核心概念
- **享元**：通过共享技术支持大量细粒度对象
- **内部状态**：可以共享的状态信息
- **外部状态**：不可共享的状态信息
- **享元工厂**：管理享元对象的创建和共享

#### 参与者概念
- **享元接口**：定义享元对象的接口
- **具体享元**：实现享元接口的可共享对象
- **非共享享元**：不需要共享的享元对象
- **享元工厂**：创建和管理享元对象

### 7. 代理模式 (Proxy)

**定义**：为其他对象提供一种代理以控制对这个对象的访问。

**GoF原定义**："Provide a surrogate or placeholder for another object to control access to it."

**核心思想**
- 通过代理对象控制对目标对象的访问
- 代理对象与目标对象实现相同的接口
- 可以在访问前后添加额外的处理逻辑
- 支持延迟加载、访问控制、缓存等功能

**基础例子：图片加载代理**

```java
// 图片接口
interface Image {
    void display();
}

// 真实图片类
class RealImage implements Image {
    private String filename;
    
    public RealImage(String filename) {
        this.filename = filename;
        loadFromDisk();
    }
    
    private void loadFromDisk() {
        System.out.println("正在从磁盘加载图片: " + filename);
        // 模拟耗时的加载过程
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
    
    @Override
    public void display() {
        System.out.println("显示图片: " + filename);
    }
}

// 图片代理类
class ImageProxy implements Image {
    private String filename;
    private RealImage realImage;
    
    public ImageProxy(String filename) {
        this.filename = filename;
    }
    
    @Override
    public void display() {
        // 延迟加载：只有在真正需要显示时才创建真实对象
        if (realImage == null) {
            realImage = new RealImage(filename);
        }
        realImage.display();
    }
}

// 客户端使用
public class ImageViewer {
    public static void main(String[] args) {
        System.out.println("=== 创建图片代理（不会立即加载）===");
        Image image1 = new ImageProxy("photo1.jpg");
        Image image2 = new ImageProxy("photo2.jpg");
        
        System.out.println("\n=== 第一次显示图片（会触发加载）===");
        image1.display();
        
        System.out.println("\n=== 第二次显示同一图片（不会重新加载）===");
        image1.display();
        
        System.out.println("\n=== 显示另一张图片===");
        image2.display();
    }
}
```

**进阶例子：企业级缓存代理系统**

```java
// 数据访问接口
interface DataService {
    String getData(String key);
    void setData(String key, String value);
    boolean deleteData(String key);
}

// 真实数据服务（模拟数据库访问）
class DatabaseService implements DataService {
    private Map<String, String> database = new HashMap<>();
    
    @Override
    public String getData(String key) {
        // 模拟数据库查询延迟
        simulateDelay(100);
        String value = database.get(key);
        System.out.println("从数据库获取数据: " + key + " = " + value);
        return value;
    }
    
    @Override
    public void setData(String key, String value) {
        simulateDelay(150);
        database.put(key, value);
        System.out.println("数据已保存到数据库: " + key + " = " + value);
    }
    
    @Override
    public boolean deleteData(String key) {
        simulateDelay(120);
        boolean existed = database.containsKey(key);
        database.remove(key);
        System.out.println("从数据库删除数据: " + key + " (存在: " + existed + ")");
        return existed;
    }
    
    private void simulateDelay(int ms) {
        try {
            Thread.sleep(ms);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
}

// 缓存代理类
class CachedDataServiceProxy implements DataService {
    private DataService realService;
    private Map<String, String> cache = new HashMap<>();
    private Map<String, Long> cacheTimestamps = new HashMap<>();
    private final long CACHE_EXPIRY_TIME = 5000; // 5秒缓存过期时间
    private int cacheHits = 0;
    private int cacheMisses = 0;
    
    public CachedDataServiceProxy(DataService realService) {
        this.realService = realService;
    }
    
    @Override
    public String getData(String key) {
        // 检查缓存是否存在且未过期
        if (isCacheValid(key)) {
            cacheHits++;
            String cachedValue = cache.get(key);
            System.out.println("缓存命中: " + key + " = " + cachedValue);
            return cachedValue;
        }
        
        // 缓存未命中，从真实服务获取数据
        cacheMisses++;
        String value = realService.getData(key);
        
        // 将数据放入缓存
        if (value != null) {
            cache.put(key, value);
            cacheTimestamps.put(key, System.currentTimeMillis());
            System.out.println("数据已缓存: " + key);
        }
        
        return value;
    }
    
    @Override
    public void setData(String key, String value) {
        // 更新真实服务
        realService.setData(key, value);
        
        // 更新缓存
        cache.put(key, value);
        cacheTimestamps.put(key, System.currentTimeMillis());
        System.out.println("缓存已更新: " + key);
    }
    
    @Override
    public boolean deleteData(String key) {
        // 从真实服务删除
        boolean result = realService.deleteData(key);
        
        // 从缓存中移除
        cache.remove(key);
        cacheTimestamps.remove(key);
        System.out.println("缓存已清除: " + key);
        
        return result;
    }
    
    private boolean isCacheValid(String key) {
        if (!cache.containsKey(key)) {
            return false;
        }
        
        long timestamp = cacheTimestamps.get(key);
        long currentTime = System.currentTimeMillis();
        return (currentTime - timestamp) < CACHE_EXPIRY_TIME;
    }
    
    public void printCacheStats() {
        System.out.println("\n=== 缓存统计 ===");
        System.out.println("缓存命中: " + cacheHits);
        System.out.println("缓存未命中: " + cacheMisses);
        System.out.println("命中率: " + 
            (cacheHits + cacheMisses > 0 ? 
             String.format("%.2f%%", (double)cacheHits / (cacheHits + cacheMisses) * 100) : 
             "0%"));
        System.out.println("当前缓存大小: " + cache.size());
    }
    
    public void clearExpiredCache() {
        long currentTime = System.currentTimeMillis();
        List<String> expiredKeys = new ArrayList<>();
        
        for (Map.Entry<String, Long> entry : cacheTimestamps.entrySet()) {
            if (currentTime - entry.getValue() >= CACHE_EXPIRY_TIME) {
                expiredKeys.add(entry.getKey());
            }
        }
        
        for (String key : expiredKeys) {
            cache.remove(key);
            cacheTimestamps.remove(key);
        }
        
        if (!expiredKeys.isEmpty()) {
            System.out.println("清理过期缓存: " + expiredKeys);
        }
    }
}

// 访问控制代理
class SecureDataServiceProxy implements DataService {
    private DataService realService;
    private String currentUser;
    private Set<String> authorizedUsers;
    
    public SecureDataServiceProxy(DataService realService, String currentUser) {
        this.realService = realService;
        this.currentUser = currentUser;
        this.authorizedUsers = Set.of("admin", "user1", "user2");
    }
    
    @Override
    public String getData(String key) {
        if (!isAuthorized()) {
            throw new SecurityException("用户 " + currentUser + " 无权访问数据");
        }
        System.out.println("访问控制通过，用户: " + currentUser);
        return realService.getData(key);
    }
    
    @Override
    public void setData(String key, String value) {
        if (!isAuthorized()) {
            throw new SecurityException("用户 " + currentUser + " 无权修改数据");
        }
        if (!currentUser.equals("admin") && key.startsWith("system_")) {
            throw new SecurityException("普通用户无权修改系统数据");
        }
        System.out.println("写入权限检查通过，用户: " + currentUser);
        realService.setData(key, value);
    }
    
    @Override
    public boolean deleteData(String key) {
        if (!currentUser.equals("admin")) {
            throw new SecurityException("只有管理员可以删除数据");
        }
        System.out.println("删除权限检查通过，管理员: " + currentUser);
        return realService.deleteData(key);
    }
    
    private boolean isAuthorized() {
        return authorizedUsers.contains(currentUser);
    }
}

// 演示多层代理
public class EnterpriseDataSystemDemo {
    public static void main(String[] args) {
        // 创建真实服务
        DataService database = new DatabaseService();
        
        // 添加缓存代理
        CachedDataServiceProxy cachedService = new CachedDataServiceProxy(database);
        
        // 添加安全代理
        DataService secureService = new SecureDataServiceProxy(cachedService, "admin");
        
        System.out.println("=== 企业级数据访问系统演示 ===\n");
        
        // 第一次访问（缓存未命中）
        System.out.println("1. 首次访问数据:");
        secureService.setData("user_profile", "John Doe Profile");
        String data1 = secureService.getData("user_profile");
        
        System.out.println("\n2. 再次访问相同数据（缓存命中）:");
        String data2 = secureService.getData("user_profile");
        
        System.out.println("\n3. 访问不存在的数据:");
        String data3 = secureService.getData("non_existent");
        
        System.out.println("\n4. 删除数据:");
        secureService.deleteData("user_profile");
        
        // 显示缓存统计
        cachedService.printCacheStats();
        
        System.out.println("\n=== 测试访问控制 ===");
        try {
            DataService userService = new SecureDataServiceProxy(cachedService, "unauthorized_user");
            userService.getData("test");
        } catch (SecurityException e) {
            System.out.println("安全异常: " + e.getMessage());
        }
        
        System.out.println("\n=== 代理模式优势 ===");
        System.out.println("- 透明性: 客户端无需知道代理的存在");
        System.out.println("- 可组合: 多个代理可以链式组合");
        System.out.println("- 功能增强: 添加缓存、安全、日志等功能");
        System.out.println("- 延迟加载: 提高系统启动性能");
    }
}
```

**代理模式的类型**
1. **虚拟代理**：延迟创建开销大的对象
2. **保护代理**：控制对原始对象的访问权限
3. **远程代理**：为远程对象提供本地代表
4. **智能引用代理**：提供比普通指针更多的功能

**模式优势**
- **访问控制**：可以控制对目标对象的访问
- **延迟加载**：只在需要时才创建目标对象
- **缓存功能**：可以缓存目标对象的结果
- **透明性**：客户端无需知道代理的存在

**适用场景**
- 需要延迟加载重量级对象
- 需要控制对对象的访问权限
- 需要为对象访问添加额外功能（缓存、日志等）
- 需要在网络上访问远程对象

#### 核心概念
- **代理**：为其他对象提供代理以控制对这个对象的访问
- **真实主题**：代理所代表的真实对象
- **代理控制**：控制对真实对象的访问

#### 代理类型概念
- **远程代理**：为远程对象提供本地代表
- **虚拟代理**：延迟创建开销大的对象
- **保护代理**：控制对原始对象的访问权限
- **智能引用代理**：提供比简单指针更多的功能
- **缓存代理**：为开销大的运算结果提供暂时存储

#### 实现概念
- **静态代理**：编译时确定代理关系
- **动态代理**：运行时动态创建代理对象
- **JDK动态代理**：基于接口的动态代理
- **CGLIB代理**：基于继承的动态代理

## 第四部分：行为型模式概念

### 1. 责任链模式 (Chain of Responsibility)

**定义**：使多个对象都有机会处理请求，从而避免请求的发送者和接收者之间的耦合关系。将这些对象连成一条链，并沿着这条链传递该请求，直到有一个对象处理它为止。

**GoF原定义**："Avoid coupling the sender of a request to its receiver by giving more than one object a chance to handle the request. Chain the receiving objects and pass the request along the chain until an object handles it."

**核心思想**
- 将请求的发送者和接收者解耦
- 多个对象都有机会处理请求
- 请求沿着链传递直到被处理
- 动态组织和分配责任

**基础例子：请假审批系统**

```java
// 请假请求类
class LeaveRequest {
    private String employeeName;
    private int days;
    private String reason;
    
    public LeaveRequest(String employeeName, int days, String reason) {
        this.employeeName = employeeName;
        this.days = days;
        this.reason = reason;
    }
    
    // Getters
    public String getEmployeeName() { return employeeName; }
    public int getDays() { return days; }
    public String getReason() { return reason; }
}

// 抽象审批者
abstract class Approver {
    protected Approver nextApprover;
    protected String name;
    
    public Approver(String name) {
        this.name = name;
    }
    
    public void setNextApprover(Approver nextApprover) {
        this.nextApprover = nextApprover;
    }
    
    public abstract void handleRequest(LeaveRequest request);
}

// 主管 - 可以批准1-3天的请假
class Supervisor extends Approver {
    public Supervisor(String name) {
        super(name);
    }
    
    @Override
    public void handleRequest(LeaveRequest request) {
        if (request.getDays() <= 3) {
            System.out.println("主管 " + name + " 批准了 " + request.getEmployeeName() + 
                             " 的 " + request.getDays() + " 天请假申请");
        } else if (nextApprover != null) {
            System.out.println("主管 " + name + " 无权批准，转交上级处理");
            nextApprover.handleRequest(request);
        } else {
            System.out.println("没有合适的审批者处理此请求");
        }
    }
}

// 经理 - 可以批准1-7天的请假
class Manager extends Approver {
    public Manager(String name) {
        super(name);
    }
    
    @Override
    public void handleRequest(LeaveRequest request) {
        if (request.getDays() <= 7) {
            System.out.println("经理 " + name + " 批准了 " + request.getEmployeeName() + 
                             " 的 " + request.getDays() + " 天请假申请");
        } else if (nextApprover != null) {
            System.out.println("经理 " + name + " 无权批准，转交上级处理");
            nextApprover.handleRequest(request);
        } else {
            System.out.println("没有合适的审批者处理此请求");
        }
    }
}

// 总监 - 可以批准1-15天的请假
class Director extends Approver {
    public Director(String name) {
        super(name);
    }
    
    @Override
    public void handleRequest(LeaveRequest request) {
        if (request.getDays() <= 15) {
            System.out.println("总监 " + name + " 批准了 " + request.getEmployeeName() + 
                             " 的 " + request.getDays() + " 天请假申请");
        } else if (nextApprover != null) {
            System.out.println("总监 " + name + " 无权批准，转交上级处理");
            nextApprover.handleRequest(request);
        } else {
            System.out.println("请假天数过多，无法批准");
        }
    }
}

// 客户端使用
public class LeaveApprovalDemo {
    public static void main(String[] args) {
        // 创建审批链
        Approver supervisor = new Supervisor("张主管");
        Approver manager = new Manager("李经理");
        Approver director = new Director("王总监");
        
        // 设置责任链
        supervisor.setNextApprover(manager);
        manager.setNextApprover(director);
        
        // 测试不同的请假申请
        System.out.println("=== 请假审批系统演示 ===\n");
        
        LeaveRequest request1 = new LeaveRequest("小明", 2, "生病");
        System.out.println("处理请求: " + request1.getEmployeeName() + " 请假 " + request1.getDays() + " 天");
        supervisor.handleRequest(request1);
        
        System.out.println();
        LeaveRequest request2 = new LeaveRequest("小红", 5, "旅游");
        System.out.println("处理请求: " + request2.getEmployeeName() + " 请假 " + request2.getDays() + " 天");
        supervisor.handleRequest(request2);
        
        System.out.println();
        LeaveRequest request3 = new LeaveRequest("小李", 10, "家事");
        System.out.println("处理请求: " + request3.getEmployeeName() + " 请假 " + request3.getDays() + " 天");
        supervisor.handleRequest(request3);
        
        System.out.println();
        LeaveRequest request4 = new LeaveRequest("小王", 20, "长期休假");
        System.out.println("处理请求: " + request4.getEmployeeName() + " 请假 " + request4.getDays() + " 天");
        supervisor.handleRequest(request4);
    }
}
```

**进阶例子：企业级日志处理系统**

```java
// 日志级别枚举
enum LogLevel {
    DEBUG(1), INFO(2), WARN(3), ERROR(4), FATAL(5);
    
    private final int level;
    
    LogLevel(int level) {
        this.level = level;
    }
    
    public int getLevel() {
        return level;
    }
}

// 日志消息类
class LogMessage {
    private LogLevel level;
    private String message;
    private String timestamp;
    private String source;
    private Exception exception;
    
    public LogMessage(LogLevel level, String message, String source) {
        this.level = level;
        this.message = message;
        this.source = source;
        this.timestamp = java.time.LocalDateTime.now().toString();
    }
    
    public LogMessage(LogLevel level, String message, String source, Exception exception) {
        this(level, message, source);
        this.exception = exception;
    }
    
    // Getters
    public LogLevel getLevel() { return level; }
    public String getMessage() { return message; }
    public String getTimestamp() { return timestamp; }
    public String getSource() { return source; }
    public Exception getException() { return exception; }
    
    @Override
    public String toString() {
        return String.format("[%s] %s - %s: %s", 
                           timestamp, level, source, message);
    }
}

// 抽象日志处理器
abstract class LogHandler {
    protected LogHandler nextHandler;
    protected LogLevel handlerLevel;
    protected String handlerName;
    
    public LogHandler(LogLevel level, String name) {
        this.handlerLevel = level;
        this.handlerName = name;
    }
    
    public void setNextHandler(LogHandler nextHandler) {
        this.nextHandler = nextHandler;
    }
    
    public void handle(LogMessage message) {
        if (canHandle(message)) {
            writeLog(message);
        }
        
        // 继续传递给下一个处理器（可以有多个处理器同时处理）
        if (nextHandler != null) {
            nextHandler.handle(message);
        }
    }
    
    protected boolean canHandle(LogMessage message) {
        return message.getLevel().getLevel() >= handlerLevel.getLevel();
    }
    
    protected abstract void writeLog(LogMessage message);
}

// 控制台日志处理器
class ConsoleLogHandler extends LogHandler {
    public ConsoleLogHandler(LogLevel level) {
        super(level, "Console Handler");
    }
    
    @Override
    protected void writeLog(LogMessage message) {
        System.out.println("控制台输出: " + message);
        if (message.getException() != null) {
            System.out.println("异常信息: " + message.getException().getMessage());
        }
    }
}

// 文件日志处理器
class FileLogHandler extends LogHandler {
    private String filename;
    
    public FileLogHandler(LogLevel level, String filename) {
        super(level, "File Handler");
        this.filename = filename;
    }
    
    @Override
    protected void writeLog(LogMessage message) {
        System.out.println("写入文件 " + filename + ": " + message);
        // 实际实现中会写入文件
    }
}

// 邮件日志处理器
class EmailLogHandler extends LogHandler {
    private String emailAddress;
    
    public EmailLogHandler(LogLevel level, String emailAddress) {
        super(level, "Email Handler");
        this.emailAddress = emailAddress;
    }
    
    @Override
    protected void writeLog(LogMessage message) {
        System.out.println("发送邮件到 " + emailAddress + ": " + message);
        // 实际实现中会发送邮件
    }
}

// 数据库日志处理器
class DatabaseLogHandler extends LogHandler {
    private String tableName;
    
    public DatabaseLogHandler(LogLevel level, String tableName) {
        super(level, "Database Handler");
        this.tableName = tableName;
    }
    
    @Override
    protected void writeLog(LogMessage message) {
        System.out.println("保存到数据库表 " + tableName + ": " + message);
        // 实际实现中会保存到数据库
    }
}

// 短信通知处理器
class SMSLogHandler extends LogHandler {
    private String phoneNumber;
    
    public SMSLogHandler(LogLevel level, String phoneNumber) {
        super(level, "SMS Handler");
        this.phoneNumber = phoneNumber;
    }
    
    @Override
    protected void writeLog(LogMessage message) {
        System.out.println("发送短信到 " + phoneNumber + ": " + 
                          message.getLevel() + " - " + message.getMessage());
    }
}

// 日志管理器
class LogManager {
    private LogHandler handlerChain;
    
    public void setHandlerChain(LogHandler handlerChain) {
        this.handlerChain = handlerChain;
    }
    
    public void log(LogLevel level, String message, String source) {
        LogMessage logMessage = new LogMessage(level, message, source);
        if (handlerChain != null) {
            handlerChain.handle(logMessage);
        }
    }
    
    public void log(LogLevel level, String message, String source, Exception exception) {
        LogMessage logMessage = new LogMessage(level, message, source, exception);
        if (handlerChain != null) {
            handlerChain.handle(logMessage);
        }
    }
}

// 企业级日志系统演示
public class EnterpriseLogSystemDemo {
    public static void main(String[] args) {
        // 创建不同级别的日志处理器
        LogHandler consoleHandler = new ConsoleLogHandler(LogLevel.DEBUG);
        LogHandler fileHandler = new FileLogHandler(LogLevel.INFO, "application.log");
        LogHandler databaseHandler = new DatabaseLogHandler(LogLevel.WARN, "log_table");
        LogHandler emailHandler = new EmailLogHandler(LogLevel.ERROR, "admin@company.com");
        LogHandler smsHandler = new SMSLogHandler(LogLevel.FATAL, "13800138000");
        
        // 构建责任链
        consoleHandler.setNextHandler(fileHandler);
        fileHandler.setNextHandler(databaseHandler);
        databaseHandler.setNextHandler(emailHandler);
        emailHandler.setNextHandler(smsHandler);
        
        // 创建日志管理器
        LogManager logManager = new LogManager();
        logManager.setHandlerChain(consoleHandler);
        
        System.out.println("=== 企业级日志处理系统演示 ===\n");
        
        // 测试不同级别的日志
        System.out.println("1. DEBUG级别日志:");
        logManager.log(LogLevel.DEBUG, "调试信息：用户登录流程开始", "UserService");
        
        System.out.println("\n2. INFO级别日志:");
        logManager.log(LogLevel.INFO, "用户登录成功", "AuthService");
        
        System.out.println("\n3. WARN级别日志:");
        logManager.log(LogLevel.WARN, "数据库连接池使用率达到80%", "DatabasePool");
        
        System.out.println("\n4. ERROR级别日志:");
        logManager.log(LogLevel.ERROR, "支付处理失败", "PaymentService", 
                      new RuntimeException("网络连接超时"));
        
        System.out.println("\n5. FATAL级别日志:");
        logManager.log(LogLevel.FATAL, "系统内存不足，服务即将停止", "SystemMonitor");
        
        System.out.println("\n=== 责任链模式优势 ===");
        System.out.println("- 解耦: 发送者不需要知道具体的处理者");
        System.out.println("- 灵活性: 可以动态添加或删除处理器");
        System.out.println("- 可扩展: 容易添加新的处理器类型");
        System.out.println("- 多重处理: 一个请求可以被多个处理器处理");
    }
}
```

**模式优势**
- **降低耦合度**：请求发送者和接收者之间没有直接关系
- **增强灵活性**：可以动态地增加或删除责任链中的处理者
- **简化对象**：对象不需要知道链的结构
- **增强扩展性**：增加新的请求处理类很方便

**适用场景**
- 有多个对象可以处理同一个请求，具体哪个对象处理该请求在运行时确定
- 在不明确指定接收者的情况下，向多个对象中的一个提交一个请求
- 可动态指定一组对象处理请求

#### 核心概念
- **责任链**：将请求的发送者和接收者解耦
- **处理者**：处理请求的对象
- **请求传递**：沿着链传递请求直到有对象处理它
- **动态链**：可以动态改变链的结构

#### 实现概念
- **纯的责任链**：请求只能被一个处理者处理
- **不纯的责任链**：请求可以被多个处理者处理
- **链的构建**：如何构建和管理责任链

### 2. 命令模式 (Command)

**定义**：将一个请求封装为一个对象，从而使你可用不同的请求对客户进行参数化；对请求排队或记录请求日志，以及支持可撤销的操作。

**GoF原定义**："Encapsulate a request as an object, thereby letting you parameterize clients with different requests, queue or log requests, and support undoable operations."

**核心思想**
- 将请求封装成对象，使请求的调用者和接收者解耦
- 支持请求的排队、记录和撤销操作
- 可以组合命令来创建宏命令
- 支持事务性操作和日志记录

**基础例子：遥控器控制系统**

```java
// 命令接口
interface Command {
    void execute();
    void undo();
}

// 接收者 - 电灯
class Light {
    private String location;
    private boolean isOn = false;
    
    public Light(String location) {
        this.location = location;
    }
    
    public void on() {
        isOn = true;
        System.out.println(location + "的灯已打开");
    }
    
    public void off() {
        isOn = false;
        System.out.println(location + "的灯已关闭");
    }
    
    public boolean isOn() {
        return isOn;
    }
}

// 接收者 - 风扇
class Fan {
    private String location;
    private int speed = 0; // 0=关闭, 1=低速, 2=中速, 3=高速
    
    public Fan(String location) {
        this.location = location;
    }
    
    public void high() {
        speed = 3;
        System.out.println(location + "的风扇设置为高速");
    }
    
    public void medium() {
        speed = 2;
        System.out.println(location + "的风扇设置为中速");
    }
    
    public void low() {
        speed = 1;
        System.out.println(location + "的风扇设置为低速");
    }
    
    public void off() {
        speed = 0;
        System.out.println(location + "的风扇已关闭");
    }
    
    public int getSpeed() {
        return speed;
    }
}

// 具体命令 - 开灯命令
class LightOnCommand implements Command {
    private Light light;
    
    public LightOnCommand(Light light) {
        this.light = light;
    }
    
    @Override
    public void execute() {
        light.on();
    }
    
    @Override
    public void undo() {
        light.off();
    }
}

// 具体命令 - 关灯命令
class LightOffCommand implements Command {
    private Light light;
    
    public LightOffCommand(Light light) {
        this.light = light;
    }
    
    @Override
    public void execute() {
        light.off();
    }
    
    @Override
    public void undo() {
        light.on();
    }
}

// 具体命令 - 风扇高速命令
class FanHighCommand implements Command {
    private Fan fan;
    private int prevSpeed;
    
    public FanHighCommand(Fan fan) {
        this.fan = fan;
    }
    
    @Override
    public void execute() {
        prevSpeed = fan.getSpeed();
        fan.high();
    }
    
    @Override
    public void undo() {
        switch (prevSpeed) {
            case 0: fan.off(); break;
            case 1: fan.low(); break;
            case 2: fan.medium(); break;
            case 3: fan.high(); break;
        }
    }
}

// 空命令（空对象模式）
class NoCommand implements Command {
    @Override
    public void execute() {
        // 什么都不做
    }
    
    @Override
    public void undo() {
        // 什么都不做
    }
}

// 调用者 - 遥控器
class RemoteControl {
    private Command[] onCommands;
    private Command[] offCommands;
    private Command undoCommand;
    
    public RemoteControl() {
        onCommands = new Command[7];
        offCommands = new Command[7];
        
        Command noCommand = new NoCommand();
        for (int i = 0; i < 7; i++) {
            onCommands[i] = noCommand;
            offCommands[i] = noCommand;
        }
        undoCommand = noCommand;
    }
    
    public void setCommand(int slot, Command onCommand, Command offCommand) {
        onCommands[slot] = onCommand;
        offCommands[slot] = offCommand;
    }
    
    public void onButtonPressed(int slot) {
        onCommands[slot].execute();
        undoCommand = onCommands[slot];
    }
    
    public void offButtonPressed(int slot) {
        offCommands[slot].execute();
        undoCommand = offCommands[slot];
    }
    
    public void undoButtonPressed() {
        undoCommand.undo();
    }
    
    public String toString() {
        StringBuilder sb = new StringBuilder();
        sb.append("\n------ 遥控器 ------\n");
        for (int i = 0; i < onCommands.length; i++) {
            sb.append("[插槽 " + i + "] " + onCommands[i].getClass().getSimpleName() + 
                     "    " + offCommands[i].getClass().getSimpleName() + "\n");
        }
        return sb.toString();
    }
}

// 客户端使用
public class RemoteControlDemo {
    public static void main(String[] args) {
        RemoteControl remote = new RemoteControl();
        
        // 创建设备
        Light livingRoomLight = new Light("客厅");
        Light kitchenLight = new Light("厨房");
        Fan ceilingFan = new Fan("客厅");
        
        // 创建命令
        LightOnCommand livingRoomLightOn = new LightOnCommand(livingRoomLight);
        LightOffCommand livingRoomLightOff = new LightOffCommand(livingRoomLight);
        LightOnCommand kitchenLightOn = new LightOnCommand(kitchenLight);
        LightOffCommand kitchenLightOff = new LightOffCommand(kitchenLight);
        FanHighCommand ceilingFanHigh = new FanHighCommand(ceilingFan);
        
        // 设置遥控器
        remote.setCommand(0, livingRoomLightOn, livingRoomLightOff);
        remote.setCommand(1, kitchenLightOn, kitchenLightOff);
        remote.setCommand(2, ceilingFanHigh, new NoCommand());
        
        System.out.println(remote);
        
        System.out.println("=== 遥控器测试 ===");
        remote.onButtonPressed(0);
        remote.offButtonPressed(0);
        remote.undoButtonPressed();
        
        remote.onButtonPressed(1);
        remote.undoButtonPressed();
        
        remote.onButtonPressed(2);
        remote.undoButtonPressed();
    }
}
```

**进阶例子：企业级文档编辑器命令系统**

```java
// 文档类
class Document {
    private StringBuilder content;
    private String filename;
    
    public Document(String filename) {
        this.filename = filename;
        this.content = new StringBuilder();
    }
    
    public void insertText(int position, String text) {
        content.insert(position, text);
        System.out.println("在位置 " + position + " 插入文本: \"" + text + "\"");
    }
    
    public String deleteText(int position, int length) {
        String deletedText = content.substring(position, position + length);
        content.delete(position, position + length);
        System.out.println("从位置 " + position + " 删除 " + length + " 个字符: \"" + deletedText + "\"");
        return deletedText;
    }
    
    public void replaceText(int position, int length, String newText) {
        content.replace(position, position + length, newText);
        System.out.println("替换位置 " + position + " 的文本为: \"" + newText + "\"");
    }
    
    public String getContent() {
        return content.toString();
    }
    
    public int getLength() {
        return content.length();
    }
    
    public String getFilename() {
        return filename;
    }
    
    public void save() {
        System.out.println("文档 \"" + filename + "\" 已保存");
    }
    
    public void print() {
        System.out.println("打印文档 \"" + filename + "\"");
    }
}

// 抽象命令接口
interface DocumentCommand {
    void execute();
    void undo();
    String getDescription();
    long getTimestamp();
}

// 抽象文档命令基类
abstract class AbstractDocumentCommand implements DocumentCommand {
    protected Document document;
    protected long timestamp;
    
    public AbstractDocumentCommand(Document document) {
        this.document = document;
        this.timestamp = System.currentTimeMillis();
    }
    
    @Override
    public long getTimestamp() {
        return timestamp;
    }
}

// 插入文本命令
class InsertTextCommand extends AbstractDocumentCommand {
    private int position;
    private String text;
    
    public InsertTextCommand(Document document, int position, String text) {
        super(document);
        this.position = position;
        this.text = text;
    }
    
    @Override
    public void execute() {
        document.insertText(position, text);
    }
    
    @Override
    public void undo() {
        document.deleteText(position, text.length());
    }
    
    @Override
    public String getDescription() {
        return "插入文本: \"" + text + "\" 在位置 " + position;
    }
}

// 删除文本命令
class DeleteTextCommand extends AbstractDocumentCommand {
    private int position;
    private int length;
    private String deletedText;
    
    public DeleteTextCommand(Document document, int position, int length) {
        super(document);
        this.position = position;
        this.length = length;
    }
    
    @Override
    public void execute() {
        deletedText = document.deleteText(position, length);
    }
    
    @Override
    public void undo() {
        document.insertText(position, deletedText);
    }
    
    @Override
    public String getDescription() {
        return "删除 " + length + " 个字符从位置 " + position;
    }
}

// 替换文本命令
class ReplaceTextCommand extends AbstractDocumentCommand {
    private int position;
    private int length;
    private String newText;
    private String oldText;
    
    public ReplaceTextCommand(Document document, int position, int length, String newText) {
        super(document);
        this.position = position;
        this.length = length;
        this.newText = newText;
    }
    
    @Override
    public void execute() {
        oldText = document.getContent().substring(position, position + length);
        document.replaceText(position, length, newText);
    }
    
    @Override
    public void undo() {
        document.replaceText(position, newText.length(), oldText);
    }
    
    @Override
    public String getDescription() {
        return "替换文本: \"" + oldText + "\" -> \"" + newText + "\" 在位置 " + position;
    }
}

// 保存文档命令
class SaveDocumentCommand extends AbstractDocumentCommand {
    public SaveDocumentCommand(Document document) {
        super(document);
    }
    
    @Override
    public void execute() {
        document.save();
    }
    
    @Override
    public void undo() {
        System.out.println("无法撤销保存操作");
    }
    
    @Override
    public String getDescription() {
        return "保存文档";
    }
}

// 宏命令 - 组合多个命令
class MacroCommand implements DocumentCommand {
    private List<DocumentCommand> commands;
    private String description;
    private long timestamp;
    
    public MacroCommand(String description) {
        this.commands = new ArrayList<>();
        this.description = description;
        this.timestamp = System.currentTimeMillis();
    }
    
    public void addCommand(DocumentCommand command) {
        commands.add(command);
    }
    
    @Override
    public void execute() {
        System.out.println("执行宏命令: " + description);
        for (DocumentCommand command : commands) {
            command.execute();
        }
    }
    
    @Override
    public void undo() {
        System.out.println("撤销宏命令: " + description);
        // 逆序撤销
        for (int i = commands.size() - 1; i >= 0; i--) {
            commands.get(i).undo();
        }
    }
    
    @Override
    public String getDescription() {
        return "宏命令: " + description + " (包含 " + commands.size() + " 个子命令)";
    }
    
    @Override
    public long getTimestamp() {
        return timestamp;
    }
}

// 命令历史管理器
class CommandHistory {
    private Stack<DocumentCommand> undoStack;
    private Stack<DocumentCommand> redoStack;
    private int maxHistorySize;
    
    public CommandHistory(int maxHistorySize) {
        this.undoStack = new Stack<>();
        this.redoStack = new Stack<>();
        this.maxHistorySize = maxHistorySize;
    }
    
    public void executeCommand(DocumentCommand command) {
        command.execute();
        undoStack.push(command);
        redoStack.clear(); // 执行新命令后清空重做栈
        
        // 限制历史记录大小
        if (undoStack.size() > maxHistorySize) {
            undoStack.remove(0);
        }
        
        System.out.println("命令已执行: " + command.getDescription());
    }
    
    public void undo() {
        if (!undoStack.isEmpty()) {
            DocumentCommand command = undoStack.pop();
            command.undo();
            redoStack.push(command);
            System.out.println("已撤销: " + command.getDescription());
        } else {
            System.out.println("没有可撤销的操作");
        }
    }
    
    public void redo() {
        if (!redoStack.isEmpty()) {
            DocumentCommand command = redoStack.pop();
            command.execute();
            undoStack.push(command);
            System.out.println("已重做: " + command.getDescription());
        } else {
            System.out.println("没有可重做的操作");
        }
    }
    
    public void printHistory() {
        System.out.println("\n=== 命令历史 ===");
        System.out.println("撤销栈 (共 " + undoStack.size() + " 个命令):");
        for (int i = undoStack.size() - 1; i >= 0; i--) {
            DocumentCommand cmd = undoStack.get(i);
            System.out.println("  " + (i + 1) + ". " + cmd.getDescription());
        }
        
        System.out.println("重做栈 (共 " + redoStack.size() + " 个命令):");
        for (int i = redoStack.size() - 1; i >= 0; i--) {
            DocumentCommand cmd = redoStack.get(i);
            System.out.println("  " + (i + 1) + ". " + cmd.getDescription());
        }
    }
    
    public boolean canUndo() {
        return !undoStack.isEmpty();
    }
    
    public boolean canRedo() {
        return !redoStack.isEmpty();
    }
}

// 文档编辑器
class DocumentEditor {
    private Document document;
    private CommandHistory history;
    
    public DocumentEditor(String filename) {
        this.document = new Document(filename);
        this.history = new CommandHistory(50); // 最多保存50个命令
    }
    
    public void insertText(int position, String text) {
        DocumentCommand command = new InsertTextCommand(document, position, text);
        history.executeCommand(command);
    }
    
    public void deleteText(int position, int length) {
        DocumentCommand command = new DeleteTextCommand(document, position, length);
        history.executeCommand(command);
    }
    
    public void replaceText(int position, int length, String newText) {
        DocumentCommand command = new ReplaceTextCommand(document, position, length, newText);
        history.executeCommand(command);
    }
    
    public void save() {
        DocumentCommand command = new SaveDocumentCommand(document);
        history.executeCommand(command);
    }
    
    public void executeMacro(MacroCommand macro) {
        history.executeCommand(macro);
    }
    
    public void undo() {
        history.undo();
    }
    
    public void redo() {
        history.redo();
    }
    
    public void printDocument() {
        System.out.println("\n=== 文档内容 ===");
        System.out.println("文件名: " + document.getFilename());
        System.out.println("内容: \"" + document.getContent() + "\"");
        System.out.println("长度: " + document.getLength() + " 字符");
    }
    
    public void printHistory() {
        history.printHistory();
    }
    
    public Document getDocument() {
        return document;
    }
}

// 企业级文档编辑器演示
public class EnterpriseDocumentEditorDemo {
    public static void main(String[] args) {
        DocumentEditor editor = new DocumentEditor("企业报告.docx");
        
        System.out.println("=== 企业级文档编辑器演示 ===\n");
        
        // 基本编辑操作
        editor.insertText(0, "企业年度报告");
        editor.printDocument();
        
        editor.insertText(6, "\n\n第一章：概述\n");
        editor.insertText(editor.getDocument().getLength(), "本章介绍企业基本情况。");
        editor.printDocument();
        
        // 创建宏命令 - 添加新章节
        MacroCommand addChapterMacro = new MacroCommand("添加第二章");
        addChapterMacro.addCommand(new InsertTextCommand(editor.getDocument(), 
                                  editor.getDocument().getLength(), "\n\n第二章：财务状况\n"));
        addChapterMacro.addCommand(new InsertTextCommand(editor.getDocument(), 
                                  editor.getDocument().getLength(), "本章分析企业财务数据。"));
        addChapterMacro.addCommand(new InsertTextCommand(editor.getDocument(), 
                                  editor.getDocument().getLength(), "\n\n详细的财务分析如下："));
        
        System.out.println("\n执行宏命令:");
        editor.executeMacro(addChapterMacro);
        editor.printDocument();
        
        // 文本替换
        System.out.println("\n替换文本:");
        editor.replaceText(0, 6, "2023年度企业");
        editor.printDocument();
        
        // 撤销和重做操作
        System.out.println("\n=== 撤销重做测试 ===");
        editor.printHistory();
        
        System.out.println("\n撤销最后一个操作:");
        editor.undo();
        editor.printDocument();
        
        System.out.println("\n撤销宏命令:");
        editor.undo();
        editor.printDocument();
        
        System.out.println("\n重做宏命令:");
        editor.redo();
        editor.printDocument();
        
        // 保存文档
        System.out.println("\n保存文档:");
        editor.save();
        
        editor.printHistory();
        
        System.out.println("\n=== 命令模式优势 ===");
        System.out.println("- 解耦: 调用者和接收者完全解耦");
        System.out.println("- 可撤销: 支持撤销和重做操作");
        System.out.println("- 可组合: 支持宏命令和批处理");
        System.out.println("- 可记录: 支持命令日志和历史记录");
        System.out.println("- 可排队: 支持命令队列和延迟执行");
    }
}
```

**模式优势**
- **解耦合**：调用者和接收者之间没有直接依赖关系
- **可撤销**：支持撤销和重做操作
- **可扩展**：容易添加新的命令类型
- **可组合**：可以将简单命令组合成复杂的宏命令
- **可记录**：支持日志记录和事务处理

**适用场景**
- 需要将请求调用者和请求接收者解耦的场合
- 需要支持撤销操作的场合
- 需要支持事务处理的场合
- 需要将请求排队、记录日志或支持批处理的场合

#### 核心概念
- **命令**：将请求封装成对象
- **接收者**：执行命令的对象
- **调用者**：发出命令的对象
- **命令队列**：存储命令的队列

#### 参与者概念
- **命令接口**：定义执行命令的接口
- **具体命令**：实现命令接口的具体类
- **接收者**：知道如何实施与执行请求相关的操作
- **调用者**：要求命令执行请求

#### 高级概念
- **宏命令**：组合多个命令的复合命令
- **撤销操作**：支持命令的撤销和重做
- **命令日志**：记录命令执行历史

### 3. 解释器模式 (Interpreter)

**定义**：给定一个语言，定义它的文法的一种表示，并定义一个解释器，这个解释器使用该表示来解释语言中的句子。

**GoF原定义**："Given a language, define a representation for its grammar along with an interpreter that uses the representation to interpret sentences in the language."

**核心思想**
- 为特定类型的问题构建一个简单的语言解释器
- 将每个语法规则表示为一个类
- 使用组合模式构建抽象语法树
- 通过递归调用解释方法来执行解释

**基础例子：简单数学表达式解释器**

```java
// 抽象表达式
abstract class Expression {
    public abstract int interpret();
}

// 终结符表达式 - 数字
class NumberExpression extends Expression {
    private int number;
    
    public NumberExpression(int number) {
        this.number = number;
    }
    
    @Override
    public int interpret() {
        return number;
    }
    
    @Override
    public String toString() {
        return String.valueOf(number);
    }
}

// 非终结符表达式 - 加法
class AddExpression extends Expression {
    private Expression left;
    private Expression right;
    
    public AddExpression(Expression left, Expression right) {
        this.left = left;
        this.right = right;
    }
    
    @Override
    public int interpret() {
        return left.interpret() + right.interpret();
    }
    
    @Override
    public String toString() {
        return "(" + left + " + " + right + ")";
    }
}

// 非终结符表达式 - 减法
class SubtractExpression extends Expression {
    private Expression left;
    private Expression right;
    
    public SubtractExpression(Expression left, Expression right) {
        this.left = left;
        this.right = right;
    }
    
    @Override
    public int interpret() {
        return left.interpret() - right.interpret();
    }
    
    @Override
    public String toString() {
        return "(" + left + " - " + right + ")";
    }
}

// 非终结符表达式 - 乘法
class MultiplyExpression extends Expression {
    private Expression left;
    private Expression right;
    
    public MultiplyExpression(Expression left, Expression right) {
        this.left = left;
        this.right = right;
    }
    
    @Override
    public int interpret() {
        return left.interpret() * right.interpret();
    }
    
    @Override
    public String toString() {
        return "(" + left + " * " + right + ")";
    }
}

// 表达式解析器
class ExpressionParser {
    public Expression parse(String expression) {
        // 简化的解析逻辑，实际应用中需要更复杂的词法和语法分析
        String[] tokens = expression.split(" ");
        return parseTokens(tokens, 0).expression;
    }
    
    private ParseResult parseTokens(String[] tokens, int index) {
        if (index >= tokens.length) {
            throw new IllegalArgumentException("意外的表达式结束");
        }
        
        String token = tokens[index];
        
        // 解析数字
        if (isNumber(token)) {
            return new ParseResult(new NumberExpression(Integer.parseInt(token)), index + 1);
        }
        
        // 解析括号表达式
        if (token.equals("(")) {
            ParseResult leftResult = parseTokens(tokens, index + 1);
            
            if (leftResult.nextIndex >= tokens.length) {
                throw new IllegalArgumentException("缺少操作符");
            }
            
            String operator = tokens[leftResult.nextIndex];
            ParseResult rightResult = parseTokens(tokens, leftResult.nextIndex + 1);
            
            if (rightResult.nextIndex >= tokens.length || !tokens[rightResult.nextIndex].equals(")")) {
                throw new IllegalArgumentException("缺少右括号");
            }
            
            Expression result;
            switch (operator) {
                case "+":
                    result = new AddExpression(leftResult.expression, rightResult.expression);
                    break;
                case "-":
                    result = new SubtractExpression(leftResult.expression, rightResult.expression);
                    break;
                case "*":
                    result = new MultiplyExpression(leftResult.expression, rightResult.expression);
                    break;
                default:
                    throw new IllegalArgumentException("未知操作符: " + operator);
            }
            
            return new ParseResult(result, rightResult.nextIndex + 1);
        }
        
        throw new IllegalArgumentException("无法解析的标记: " + token);
    }
    
    private boolean isNumber(String token) {
        try {
            Integer.parseInt(token);
            return true;
        } catch (NumberFormatException e) {
            return false;
        }
    }
    
    private static class ParseResult {
        Expression expression;
        int nextIndex;
        
        ParseResult(Expression expression, int nextIndex) {
            this.expression = expression;
            this.nextIndex = nextIndex;
        }
    }
}

// 客户端使用
public class MathExpressionDemo {
    public static void main(String[] args) {
        ExpressionParser parser = new ExpressionParser();
        
        System.out.println("=== 简单数学表达式解释器演示 ===\n");
        
        // 测试表达式
        String[] expressions = {
            "( 3 + 5 )",
            "( 10 - 4 )",
            "( 6 * 7 )",
            "( ( 2 + 3 ) * 4 )",
            "( 10 - ( 3 + 2 ) )"
        };
        
        for (String expr : expressions) {
            try {
                Expression expression = parser.parse(expr);
                int result = expression.interpret();
                System.out.println("表达式: " + expr);
                System.out.println("解析为: " + expression);
                System.out.println("结果: " + result);
                System.out.println();
            } catch (Exception e) {
                System.out.println("解析错误: " + expr + " - " + e.getMessage());
            }
        }
    }
}
```

**进阶例子：企业级规则引擎解释器**

```java
// 上下文环境
class Context {
    private Map<String, Object> variables = new HashMap<>();
    
    public void setVariable(String name, Object value) {
        variables.put(name, value);
    }
    
    public Object getVariable(String name) {
        return variables.get(name);
    }
    
    public boolean hasVariable(String name) {
        return variables.containsKey(name);
    }
    
    public void printVariables() {
        System.out.println("上下文变量:");
        variables.forEach((key, value) -> 
            System.out.println("  " + key + " = " + value));
    }
}

// 抽象规则表达式
abstract class RuleExpression {
    public abstract boolean evaluate(Context context);
    public abstract String toString();
}

// 变量表达式
class VariableExpression extends RuleExpression {
    private String variableName;
    
    public VariableExpression(String variableName) {
        this.variableName = variableName;
    }
    
    @Override
    public boolean evaluate(Context context) {
        Object value = context.getVariable(variableName);
        if (value instanceof Boolean) {
            return (Boolean) value;
        }
        return value != null;
    }
    
    @Override
    public String toString() {
        return variableName;
    }
}

// 常量表达式
class ConstantExpression extends RuleExpression {
    private boolean value;
    
    public ConstantExpression(boolean value) {
        this.value = value;
    }
    
    @Override
    public boolean evaluate(Context context) {
        return value;
    }
    
    @Override
    public String toString() {
        return String.valueOf(value);
    }
}

// 比较表达式
class ComparisonExpression extends RuleExpression {
    private String variableName;
    private String operator;
    private Object expectedValue;
    
    public ComparisonExpression(String variableName, String operator, Object expectedValue) {
        this.variableName = variableName;
        this.operator = operator;
        this.expectedValue = expectedValue;
    }
    
    @Override
    public boolean evaluate(Context context) {
        Object actualValue = context.getVariable(variableName);
        if (actualValue == null) {
            return false;
        }
        
        switch (operator) {
            case "==":
                return actualValue.equals(expectedValue);
            case "!=":
                return !actualValue.equals(expectedValue);
            case ">":
                return compareNumbers(actualValue, expectedValue) > 0;
            case "<":
                return compareNumbers(actualValue, expectedValue) < 0;
            case ">=":
                return compareNumbers(actualValue, expectedValue) >= 0;
            case "<=":
                return compareNumbers(actualValue, expectedValue) <= 0;
            case "contains":
                return actualValue.toString().contains(expectedValue.toString());
            default:
                throw new IllegalArgumentException("不支持的操作符: " + operator);
        }
    }
    
    private int compareNumbers(Object actual, Object expected) {
        if (actual instanceof Number && expected instanceof Number) {
            double actualNum = ((Number) actual).doubleValue();
            double expectedNum = ((Number) expected).doubleValue();
            return Double.compare(actualNum, expectedNum);
        }
        throw new IllegalArgumentException("无法比较非数字类型");
    }
    
    @Override
    public String toString() {
        return variableName + " " + operator + " " + expectedValue;
    }
}

// AND表达式
class AndExpression extends RuleExpression {
    private RuleExpression left;
    private RuleExpression right;
    
    public AndExpression(RuleExpression left, RuleExpression right) {
        this.left = left;
        this.right = right;
    }
    
    @Override
    public boolean evaluate(Context context) {
        return left.evaluate(context) && right.evaluate(context);
    }
    
    @Override
    public String toString() {
        return "(" + left + " AND " + right + ")";
    }
}

// OR表达式
class OrExpression extends RuleExpression {
    private RuleExpression left;
    private RuleExpression right;
    
    public OrExpression(RuleExpression left, RuleExpression right) {
        this.left = left;
        this.right = right;
    }
    
    @Override
    public boolean evaluate(Context context) {
        return left.evaluate(context) || right.evaluate(context);
    }
    
    @Override
    public String toString() {
        return "(" + left + " OR " + right + ")";
    }
}

// NOT表达式
class NotExpression extends RuleExpression {
    private RuleExpression expression;
    
    public NotExpression(RuleExpression expression) {
        this.expression = expression;
    }
    
    @Override
    public boolean evaluate(Context context) {
        return !expression.evaluate(context);
    }
    
    @Override
    public String toString() {
        return "NOT(" + expression + ")";
    }
}

// 业务规则
class BusinessRule {
    private String name;
    private RuleExpression condition;
    private String action;
    private int priority;
    
    public BusinessRule(String name, RuleExpression condition, String action, int priority) {
        this.name = name;
        this.condition = condition;
        this.action = action;
        this.priority = priority;
    }
    
    public boolean evaluate(Context context) {
        return condition.evaluate(context);
    }
    
    public void execute() {
        System.out.println("执行规则: " + name + " -> " + action);
    }
    
    // Getters
    public String getName() { return name; }
    public String getAction() { return action; }
    public int getPriority() { return priority; }
    
    @Override
    public String toString() {
        return "规则[" + name + "]: IF " + condition + " THEN " + action + " (优先级:" + priority + ")";
    }
}

// 规则引擎
class RuleEngine {
    private List<BusinessRule> rules = new ArrayList<>();
    
    public void addRule(BusinessRule rule) {
        rules.add(rule);
        // 按优先级排序（优先级高的先执行）
        rules.sort((r1, r2) -> Integer.compare(r2.getPriority(), r1.getPriority()));
    }
    
    public void executeRules(Context context) {
        System.out.println("=== 规则引擎执行 ===");
        context.printVariables();
        System.out.println();
        
        List<BusinessRule> firedRules = new ArrayList<>();
        
        for (BusinessRule rule : rules) {
            System.out.println("评估规则: " + rule.getName());
            System.out.println("条件: " + rule.toString());
            
            if (rule.evaluate(context)) {
                System.out.println("✓ 规则匹配，执行动作");
                rule.execute();
                firedRules.add(rule);
            } else {
                System.out.println("✗ 规则不匹配");
            }
            System.out.println();
        }
        
        System.out.println("总共触发了 " + firedRules.size() + " 个规则");
    }
    
    public void printAllRules() {
        System.out.println("=== 所有业务规则 ===");
        for (int i = 0; i < rules.size(); i++) {
            System.out.println((i + 1) + ". " + rules.get(i));
        }
    }
}

// 规则构建器
class RuleBuilder {
    public static BusinessRule createCustomerDiscountRule() {
        // 规则: 如果客户是VIP且订单金额>1000，则给予10%折扣
        RuleExpression vipCondition = new ComparisonExpression("customerType", "==", "VIP");
        RuleExpression amountCondition = new ComparisonExpression("orderAmount", ">", 1000.0);
        RuleExpression condition = new AndExpression(vipCondition, amountCondition);
        
        return new BusinessRule("VIP客户折扣规则", condition, "给予10%折扣", 10);
    }
    
    public static BusinessRule createFreeShippingRule() {
        // 规则: 如果订单金额>500或客户是VIP，则免费配送
        RuleExpression amountCondition = new ComparisonExpression("orderAmount", ">", 500.0);
        RuleExpression vipCondition = new ComparisonExpression("customerType", "==", "VIP");
        RuleExpression condition = new OrExpression(amountCondition, vipCondition);
        
        return new BusinessRule("免费配送规则", condition, "免费配送", 8);
    }
    
    public static BusinessRule createLowStockAlertRule() {
        // 规则: 如果库存<10且不是预订商品，则发送库存警告
        RuleExpression stockCondition = new ComparisonExpression("stock", "<", 10);
        RuleExpression preorderCondition = new ComparisonExpression("isPreorder", "==", false);
        RuleExpression condition = new AndExpression(stockCondition, preorderCondition);
        
        return new BusinessRule("低库存警告规则", condition, "发送库存警告邮件", 15);
    }
    
    public static BusinessRule createNewCustomerWelcomeRule() {
        // 规则: 如果是新客户且不是企业客户，则发送欢迎邮件
        RuleExpression newCustomerCondition = new ComparisonExpression("isNewCustomer", "==", true);
        RuleExpression enterpriseCondition = new ComparisonExpression("customerType", "!=", "Enterprise");
        RuleExpression condition = new AndExpression(newCustomerCondition, enterpriseCondition);
        
        return new BusinessRule("新客户欢迎规则", condition, "发送欢迎邮件和优惠券", 5);
    }
}

// 企业级规则引擎演示
public class EnterpriseRuleEngineDemo {
    public static void main(String[] args) {
        // 创建规则引擎
        RuleEngine ruleEngine = new RuleEngine();
        
        // 添加业务规则
        ruleEngine.addRule(RuleBuilder.createCustomerDiscountRule());
        ruleEngine.addRule(RuleBuilder.createFreeShippingRule());
        ruleEngine.addRule(RuleBuilder.createLowStockAlertRule());
        ruleEngine.addRule(RuleBuilder.createNewCustomerWelcomeRule());
        
        System.out.println("=== 企业级规则引擎演示 ===\n");
        ruleEngine.printAllRules();
        System.out.println();
        
        // 测试场景1: VIP客户大额订单
        System.out.println("场景1: VIP客户大额订单");
        Context context1 = new Context();
        context1.setVariable("customerType", "VIP");
        context1.setVariable("orderAmount", 1500.0);
        context1.setVariable("stock", 50);
        context1.setVariable("isPreorder", false);
        context1.setVariable("isNewCustomer", false);
        
        ruleEngine.executeRules(context1);
        
        // 测试场景2: 新普通客户小额订单
        System.out.println("\n" + "=".repeat(50));
        System.out.println("场景2: 新普通客户小额订单");
        Context context2 = new Context();
        context2.setVariable("customerType", "Regular");
        context2.setVariable("orderAmount", 300.0);
        context2.setVariable("stock", 5);
        context2.setVariable("isPreorder", false);
        context2.setVariable("isNewCustomer", true);
        
        ruleEngine.executeRules(context2);
        
        // 测试场景3: 企业客户预订商品
        System.out.println("\n" + "=".repeat(50));
        System.out.println("场景3: 企业客户预订商品");
        Context context3 = new Context();
        context3.setVariable("customerType", "Enterprise");
        context3.setVariable("orderAmount", 800.0);
        context3.setVariable("stock", 3);
        context3.setVariable("isPreorder", true);
        context3.setVariable("isNewCustomer", true);
        
        ruleEngine.executeRules(context3);
        
        System.out.println("\n=== 解释器模式优势 ===");
        System.out.println("- 易于扩展: 容易添加新的语法规则");
        System.out.println("- 易于实现: 每个语法规则对应一个类");
        System.out.println("- 灵活性: 可以动态组合复杂的规则");
        System.out.println("- 可维护: 规则逻辑清晰分离");
    }
}
```

**模式优势**
- **易于扩展**：容易添加新的语法规则和表达式类型
- **易于实现**：每个语法规则对应一个类，实现简单
- **灵活组合**：可以通过组合模式构建复杂的表达式
- **职责分离**：语法分析和解释执行分离

**适用场景**
- 需要解释执行特定语言或表达式的场合
- 语法相对简单且稳定的领域特定语言
- 需要构建规则引擎或配置解析器
- 需要支持动态表达式计算的系统

**注意事项**
- 复杂语法会导致类层次结构庞大
- 性能可能不如直接编程实现
- 适合语法简单的场景，复杂语法建议使用专门的解析器生成工具

#### 核心概念
- **解释器**：为语言定义文法表示，并定义解释器解释语言中的句子
- **抽象语法树**：表示语言语法结构的树
- **文法规则**：定义语言的语法规则
- **上下文**：包含解释器之外的全局信息

#### 参与者概念
- **抽象表达式**：声明抽象的解释操作
- **终结符表达式**：实现文法中终结符相关的解释操作
- **非终结符表达式**：实现文法中非终结符相关的解释操作
- **环境**：包含解释器之外的全局信息

### 4. 迭代器模式 (Iterator)

**定义**：提供一种方法顺序访问一个聚合对象中各个元素，而又不需暴露该对象的内部表示。

**GoF原定义**："Provide a way to access the elements of an aggregate object sequentially without exposing its underlying representation."

**核心思想**
- 将遍历算法从聚合对象中分离出来
- 提供统一的遍历接口，隐藏内部实现细节
- 支持多种遍历方式和并发遍历
- 简化聚合对象的接口

**基础例子：书籍集合迭代器**

```java
// 迭代器接口
interface Iterator<T> {
    boolean hasNext();
    T next();
    void remove();
}

// 聚合接口
interface Aggregate<T> {
    Iterator<T> createIterator();
}

// 书籍类
class Book {
    private String title;
    private String author;
    private String isbn;
    
    public Book(String title, String author, String isbn) {
        this.title = title;
        this.author = author;
        this.isbn = isbn;
    }
    
    // Getters
    public String getTitle() { return title; }
    public String getAuthor() { return author; }
    public String getIsbn() { return isbn; }
    
    @Override
    public String toString() {
        return "《" + title + "》 - " + author + " (ISBN: " + isbn + ")";
    }
}

// 书籍集合
class BookCollection implements Aggregate<Book> {
    private List<Book> books;
    
    public BookCollection() {
        this.books = new ArrayList<>();
    }
    
    public void addBook(Book book) {
        books.add(book);
    }
    
    public void removeBook(Book book) {
        books.remove(book);
    }
    
    public int size() {
        return books.size();
    }
    
    @Override
    public Iterator<Book> createIterator() {
        return new BookIterator();
    }
    
    // 内部迭代器实现
    private class BookIterator implements Iterator<Book> {
        private int currentIndex = 0;
        
        @Override
        public boolean hasNext() {
            return currentIndex < books.size();
        }
        
        @Override
        public Book next() {
            if (!hasNext()) {
                throw new NoSuchElementException("没有更多书籍");
            }
            return books.get(currentIndex++);
        }
        
        @Override
        public void remove() {
            if (currentIndex <= 0) {
                throw new IllegalStateException("无法删除，请先调用next()");
            }
            books.remove(--currentIndex);
        }
    }
}

// 客户端使用
public class BookCollectionDemo {
    public static void main(String[] args) {
        // 创建书籍集合
        BookCollection library = new BookCollection();
        library.addBook(new Book("设计模式", "GoF", "978-0201633610"));
        library.addBook(new Book("重构", "Martin Fowler", "978-0201485677"));
        library.addBook(new Book("代码大全", "Steve McConnell", "978-0735619678"));
        library.addBook(new Book("程序员修炼之道", "Andrew Hunt", "978-0201616224"));
        
        System.out.println("=== 书籍集合迭代器演示 ===\n");
        System.out.println("图书馆共有 " + library.size() + " 本书:\n");
        
        // 使用迭代器遍历
        Iterator<Book> iterator = library.createIterator();
        int index = 1;
        while (iterator.hasNext()) {
            Book book = iterator.next();
            System.out.println(index++ + ". " + book);
        }
        
        System.out.println("\n删除第2本书后:");
        iterator = library.createIterator();
        iterator.next(); // 跳过第一本
        iterator.next(); // 到第二本
        iterator.remove(); // 删除第二本
        
        iterator = library.createIterator();
        index = 1;
        while (iterator.hasNext()) {
            Book book = iterator.next();
            System.out.println(index++ + ". " + book);
        }
    }
}
```

**进阶例子：企业级数据访问迭代器系统**

```java
// 通用迭代器接口
interface DataIterator<T> {
    boolean hasNext();
    T next();
    void remove();
    void reset();
    int getCurrentPosition();
    int getTotalCount();
}

// 员工实体类
class Employee {
    private int id;
    private String name;
    private String department;
    private double salary;
    private Date hireDate;
    
    public Employee(int id, String name, String department, double salary, Date hireDate) {
        this.id = id;
        this.name = name;
        this.department = department;
        this.salary = salary;
        this.hireDate = hireDate;
    }
    
    // Getters
    public int getId() { return id; }
    public String getName() { return name; }
    public String getDepartment() { return department; }
    public double getSalary() { return salary; }
    public Date getHireDate() { return hireDate; }
    
    @Override
    public String toString() {
        return String.format("Employee[%d] %s - %s (薪资: %.2f)", 
                           id, name, department, salary);
    }
}

// 抽象数据源
abstract class DataSource<T> {
    public abstract DataIterator<T> createIterator();
    public abstract DataIterator<T> createIterator(String filterCriteria);
    public abstract int getTotalCount();
}

// 内存数据源
class MemoryDataSource extends DataSource<Employee> {
    private List<Employee> employees;
    
    public MemoryDataSource() {
        this.employees = new ArrayList<>();
        initializeData();
    }
    
    private void initializeData() {
        employees.add(new Employee(1, "张三", "技术部", 8000, new Date()));
        employees.add(new Employee(2, "李四", "销售部", 6000, new Date()));
        employees.add(new Employee(3, "王五", "技术部", 9000, new Date()));
        employees.add(new Employee(4, "赵六", "人事部", 5500, new Date()));
        employees.add(new Employee(5, "钱七", "技术部", 7500, new Date()));
        employees.add(new Employee(6, "孙八", "销售部", 6500, new Date()));
    }
    
    @Override
    public DataIterator<Employee> createIterator() {
        return new MemoryIterator(employees);
    }
    
    @Override
    public DataIterator<Employee> createIterator(String filterCriteria) {
        List<Employee> filteredEmployees = employees.stream()
            .filter(emp -> emp.getDepartment().contains(filterCriteria) || 
                          emp.getName().contains(filterCriteria))
            .collect(Collectors.toList());
        return new MemoryIterator(filteredEmployees);
    }
    
    @Override
    public int getTotalCount() {
        return employees.size();
    }
    
    // 内存迭代器实现
    private class MemoryIterator implements DataIterator<Employee> {
        private List<Employee> data;
        private int currentIndex = 0;
        
        public MemoryIterator(List<Employee> data) {
            this.data = new ArrayList<>(data); // 创建副本避免并发修改
        }
        
        @Override
        public boolean hasNext() {
            return currentIndex < data.size();
        }
        
        @Override
        public Employee next() {
            if (!hasNext()) {
                throw new NoSuchElementException("没有更多数据");
            }
            return data.get(currentIndex++);
        }
        
        @Override
        public void remove() {
            if (currentIndex <= 0) {
                throw new IllegalStateException("无法删除，请先调用next()");
            }
            data.remove(--currentIndex);
        }
        
        @Override
        public void reset() {
            currentIndex = 0;
        }
        
        @Override
        public int getCurrentPosition() {
            return currentIndex;
        }
        
        @Override
        public int getTotalCount() {
            return data.size();
        }
    }
}

// 数据库数据源（模拟）
class DatabaseDataSource extends DataSource<Employee> {
    private int pageSize = 2; // 每页2条记录，模拟分页
    private List<Employee> allData; // 模拟数据库中的所有数据
    
    public DatabaseDataSource() {
        // 模拟数据库中的大量数据
        this.allData = new ArrayList<>();
        for (int i = 1; i <= 10; i++) {
            allData.add(new Employee(i, "员工" + i, 
                       i % 3 == 0 ? "技术部" : (i % 2 == 0 ? "销售部" : "人事部"), 
                       5000 + i * 500, new Date()));
        }
    }
    
    @Override
    public DataIterator<Employee> createIterator() {
        return new DatabaseIterator(null);
    }
    
    @Override
    public DataIterator<Employee> createIterator(String filterCriteria) {
        return new DatabaseIterator(filterCriteria);
    }
    
    @Override
    public int getTotalCount() {
        return allData.size();
    }
    
    // 模拟数据库查询
    private List<Employee> queryDatabase(int offset, int limit, String filter) {
        System.out.println("执行数据库查询: OFFSET=" + offset + ", LIMIT=" + limit + 
                          (filter != null ? ", FILTER=" + filter : ""));
        
        // 模拟网络延迟
        try {
            Thread.sleep(100);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
        
        Stream<Employee> stream = allData.stream();
        if (filter != null) {
            stream = stream.filter(emp -> emp.getDepartment().contains(filter) || 
                                         emp.getName().contains(filter));
        }
        
        return stream.skip(offset).limit(limit).collect(Collectors.toList());
    }
    
    // 数据库迭代器实现（支持懒加载）
    private class DatabaseIterator implements DataIterator<Employee> {
        private String filterCriteria;
        private List<Employee> currentPage;
        private int currentPageIndex = 0;
        private int currentItemIndex = 0;
        private int totalProcessed = 0;
        private boolean hasMorePages = true;
        
        public DatabaseIterator(String filterCriteria) {
            this.filterCriteria = filterCriteria;
            loadNextPage();
        }
        
        private void loadNextPage() {
            if (!hasMorePages) return;
            
            currentPage = queryDatabase(currentPageIndex * pageSize, pageSize, filterCriteria);
            currentItemIndex = 0;
            
            if (currentPage.size() < pageSize) {
                hasMorePages = false;
            }
            currentPageIndex++;
        }
        
        @Override
        public boolean hasNext() {
            if (currentPage == null || currentPage.isEmpty()) {
                return false;
            }
            
            if (currentItemIndex >= currentPage.size()) {
                if (hasMorePages) {
                    loadNextPage();
                    return hasNext();
                }
                return false;
            }
            
            return true;
        }
        
        @Override
        public Employee next() {
            if (!hasNext()) {
                throw new NoSuchElementException("没有更多数据");
            }
            
            Employee employee = currentPage.get(currentItemIndex++);
            totalProcessed++;
            return employee;
        }
        
        @Override
        public void remove() {
            throw new UnsupportedOperationException("数据库迭代器不支持删除操作");
        }
        
        @Override
        public void reset() {
            currentPageIndex = 0;
            currentItemIndex = 0;
            totalProcessed = 0;
            hasMorePages = true;
            loadNextPage();
        }
        
        @Override
        public int getCurrentPosition() {
            return totalProcessed;
        }
        
        @Override
        public int getTotalCount() {
            // 在实际应用中，这里会执行COUNT查询
            return (int) allData.stream()
                .filter(emp -> filterCriteria == null || 
                              emp.getDepartment().contains(filterCriteria) || 
                              emp.getName().contains(filterCriteria))
                .count();
        }
    }
}

// 组合迭代器 - 可以组合多个数据源
class CompositeDataIterator implements DataIterator<Employee> {
    private List<DataIterator<Employee>> iterators;
    private int currentIteratorIndex = 0;
    private int totalProcessed = 0;
    
    public CompositeDataIterator(List<DataIterator<Employee>> iterators) {
        this.iterators = new ArrayList<>(iterators);
    }
    
    @Override
    public boolean hasNext() {
        while (currentIteratorIndex < iterators.size()) {
            if (iterators.get(currentIteratorIndex).hasNext()) {
                return true;
            }
            currentIteratorIndex++;
        }
        return false;
    }
    
    @Override
    public Employee next() {
        if (!hasNext()) {
            throw new NoSuchElementException("没有更多数据");
        }
        
        Employee employee = iterators.get(currentIteratorIndex).next();
        totalProcessed++;
        return employee;
    }
    
    @Override
    public void remove() {
        if (currentIteratorIndex >= iterators.size()) {
            throw new IllegalStateException("无法删除");
        }
        iterators.get(currentIteratorIndex).remove();
    }
    
    @Override
    public void reset() {
        currentIteratorIndex = 0;
        totalProcessed = 0;
        for (DataIterator<Employee> iterator : iterators) {
            iterator.reset();
        }
    }
    
    @Override
    public int getCurrentPosition() {
        return totalProcessed;
    }
    
    @Override
    public int getTotalCount() {
        return iterators.stream()
            .mapToInt(DataIterator::getTotalCount)
            .sum();
    }
}

// 数据处理器
class DataProcessor {
    public void processData(DataIterator<Employee> iterator, String description) {
        System.out.println("=== " + description + " ===");
        System.out.println("总记录数: " + iterator.getTotalCount());
        
        int count = 0;
        long startTime = System.currentTimeMillis();
        
        while (iterator.hasNext()) {
            Employee employee = iterator.next();
            count++;
            System.out.println(count + ". " + employee);
            
            // 模拟处理时间
            try {
                Thread.sleep(50);
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                break;
            }
        }
        
        long endTime = System.currentTimeMillis();
        System.out.println("处理完成: 共处理 " + count + " 条记录，耗时 " + (endTime - startTime) + "ms");
        System.out.println();
    }
}

// 企业级数据访问演示
public class EnterpriseDataAccessDemo {
    public static void main(String[] args) {
        System.out.println("=== 企业级数据访问迭代器系统演示 ===\n");
        
        DataProcessor processor = new DataProcessor();
        
        // 1. 内存数据源迭代
        System.out.println("1. 内存数据源迭代:");
        MemoryDataSource memorySource = new MemoryDataSource();
        DataIterator<Employee> memoryIterator = memorySource.createIterator();
        processor.processData(memoryIterator, "内存数据源 - 所有员工");
        
        // 2. 内存数据源过滤迭代
        System.out.println("2. 内存数据源过滤迭代:");
        DataIterator<Employee> filteredMemoryIterator = memorySource.createIterator("技术部");
        processor.processData(filteredMemoryIterator, "内存数据源 - 技术部员工");
        
        // 3. 数据库数据源迭代（分页加载）
        System.out.println("3. 数据库数据源迭代（分页加载）:");
        DatabaseDataSource dbSource = new DatabaseDataSource();
        DataIterator<Employee> dbIterator = dbSource.createIterator();
        processor.processData(dbIterator, "数据库数据源 - 分页加载");
        
        // 4. 数据库数据源过滤迭代
        System.out.println("4. 数据库数据源过滤迭代:");
        DataIterator<Employee> filteredDbIterator = dbSource.createIterator("技术部");
        processor.processData(filteredDbIterator, "数据库数据源 - 技术部员工");
        
        // 5. 组合迭代器 - 合并多个数据源
        System.out.println("5. 组合迭代器 - 合并多个数据源:");
        List<DataIterator<Employee>> iterators = Arrays.asList(
            memorySource.createIterator("销售部"),
            dbSource.createIterator("人事部")
        );
        CompositeDataIterator compositeIterator = new CompositeDataIterator(iterators);
        processor.processData(compositeIterator, "组合数据源 - 销售部+人事部");
        
        System.out.println("=== 迭代器模式优势 ===");
        System.out.println("- 统一接口: 不同数据源提供统一的遍历接口");
        System.out.println("- 懒加载: 支持大数据集的分页和按需加载");
        System.out.println("- 封装性: 隐藏内部数据结构的实现细节");
        System.out.println("- 可组合: 支持多个迭代器的组合使用");
        System.out.println("- 并发安全: 每个迭代器维护独立的遍历状态");
    }
}
```

**模式优势**
- **统一接口**：为不同的聚合结构提供统一的遍历接口
- **封装性**：隐藏聚合对象的内部结构
- **支持多种遍历**：可以同时存在多个迭代器
- **简化聚合接口**：聚合对象不需要提供各种遍历操作

**适用场景**
- 需要访问聚合对象的内容而无需暴露其内部表示
- 需要支持对聚合对象的多种遍历
- 需要为不同的聚合结构提供统一的遍历接口
- 需要支持大数据集的分页或懒加载遍历

#### 核心概念
- **迭代器**：提供顺序访问聚合对象元素的方法
- **聚合对象**：包含多个元素的对象
- **遍历**：按某种顺序访问聚合对象的元素
- **封装遍历**：将遍历算法封装在迭代器中

#### 参与者概念
- **迭代器接口**：定义访问和遍历元素的接口
- **具体迭代器**：实现迭代器接口
- **聚合接口**：定义创建迭代器的接口
- **具体聚合**：实现创建迭代器的接口

#### 实现概念
- **内部迭代器**：由聚合对象控制迭代过程
- **外部迭代器**：由客户端控制迭代过程
- **健壮性迭代器**：在迭代过程中可以安全地修改聚合对象

### 5. 中介者模式 (Mediator)

**定义**：用一个中介对象来封装一系列的对象交互。中介者使各对象不需要显式地相互引用，从而使其耦合松散，而且可以独立地改变它们之间的交互。

**GoF原定义**："Define an object that encapsulates how a set of objects interact. Mediator promotes loose coupling by keeping objects from referring to each other explicitly, and it lets you vary their interaction independently."

**核心思想**
- 将对象间的交互封装在中介者对象中
- 各个对象不直接相互引用，而是通过中介者通信
- 降低对象间的耦合度，提高系统的可维护性
- 集中控制复杂的交互逻辑

**基础例子：聊天室系统**

```java
// 抽象中介者
abstract class ChatMediator {
    public abstract void sendMessage(String message, User user);
    public abstract void addUser(User user);
    public abstract void removeUser(User user);
}

// 抽象用户
abstract class User {
    protected ChatMediator mediator;
    protected String name;
    
    public User(ChatMediator mediator, String name) {
        this.mediator = mediator;
        this.name = name;
    }
    
    public abstract void send(String message);
    public abstract void receive(String message);
    
    public String getName() {
        return name;
    }
}

// 具体中介者 - 聊天室
class ChatRoom extends ChatMediator {
    private List<User> users;
    
    public ChatRoom() {
        this.users = new ArrayList<>();
    }
    
    @Override
    public void sendMessage(String message, User sender) {
        for (User user : users) {
            // 不发送给自己
            if (user != sender) {
                user.receive(message);
            }
        }
    }
    
    @Override
    public void addUser(User user) {
        users.add(user);
        System.out.println(user.getName() + " 加入了聊天室");
        
        // 通知其他用户
        for (User existingUser : users) {
            if (existingUser != user) {
                existingUser.receive("系统消息: " + user.getName() + " 加入了聊天室");
            }
        }
    }
    
    @Override
    public void removeUser(User user) {
        users.remove(user);
        System.out.println(user.getName() + " 离开了聊天室");
        
        // 通知其他用户
        for (User remainingUser : users) {
            remainingUser.receive("系统消息: " + user.getName() + " 离开了聊天室");
        }
    }
    
    public int getUserCount() {
        return users.size();
    }
}

// 具体用户
class ConcreteUser extends User {
    public ConcreteUser(ChatMediator mediator, String name) {
        super(mediator, name);
    }
    
    @Override
    public void send(String message) {
        System.out.println(name + " 发送: " + message);
        mediator.sendMessage(name + ": " + message, this);
    }
    
    @Override
    public void receive(String message) {
        System.out.println(name + " 收到: " + message);
    }
}

// 客户端使用
public class ChatRoomDemo {
    public static void main(String[] args) {
        System.out.println("=== 聊天室系统演示 ===\n");
        
        // 创建聊天室
        ChatRoom chatRoom = new ChatRoom();
        
        // 创建用户
        User alice = new ConcreteUser(chatRoom, "Alice");
        User bob = new ConcreteUser(chatRoom, "Bob");
        User charlie = new ConcreteUser(chatRoom, "Charlie");
        
        // 用户加入聊天室
        chatRoom.addUser(alice);
        System.out.println();
        
        chatRoom.addUser(bob);
        System.out.println();
        
        chatRoom.addUser(charlie);
        System.out.println();
        
        // 用户发送消息
        alice.send("大家好！");
        System.out.println();
        
        bob.send("你好 Alice！");
        System.out.println();
        
        charlie.send("很高兴认识大家！");
        System.out.println();
        
        // 用户离开
        chatRoom.removeUser(bob);
        System.out.println();
        
        alice.send("Bob 走了");
        System.out.println();
    }
}
```

**进阶例子：企业级工作流协调系统**

```java
// 工作流事件类型
enum WorkflowEventType {
    TASK_CREATED, TASK_ASSIGNED, TASK_STARTED, TASK_COMPLETED, 
    TASK_REJECTED, APPROVAL_REQUESTED, APPROVAL_GRANTED, APPROVAL_DENIED
}

// 工作流事件
class WorkflowEvent {
    private WorkflowEventType type;
    private String taskId;
    private String fromComponent;
    private String toComponent;
    private Map<String, Object> data;
    private long timestamp;
    
    public WorkflowEvent(WorkflowEventType type, String taskId, String fromComponent) {
        this.type = type;
        this.taskId = taskId;
        this.fromComponent = fromComponent;
        this.data = new HashMap<>();
        this.timestamp = System.currentTimeMillis();
    }
    
    // Getters and setters
    public WorkflowEventType getType() { return type; }
    public String getTaskId() { return taskId; }
    public String getFromComponent() { return fromComponent; }
    public String getToComponent() { return toComponent; }
    public void setToComponent(String toComponent) { this.toComponent = toComponent; }
    public Map<String, Object> getData() { return data; }
    public long getTimestamp() { return timestamp; }
    
    public void addData(String key, Object value) {
        data.put(key, value);
    }
    
    @Override
    public String toString() {
        return String.format("WorkflowEvent[%s] %s -> %s: %s (Task: %s)", 
                           type, fromComponent, toComponent, data, taskId);
    }
}

// 抽象工作流中介者
abstract class WorkflowMediator {
    public abstract void handleEvent(WorkflowEvent event);
    public abstract void registerComponent(WorkflowComponent component);
    public abstract void unregisterComponent(WorkflowComponent component);
}

// 抽象工作流组件
abstract class WorkflowComponent {
    protected WorkflowMediator mediator;
    protected String componentName;
    protected boolean isActive = true;
    
    public WorkflowComponent(WorkflowMediator mediator, String componentName) {
        this.mediator = mediator;
        this.componentName = componentName;
    }
    
    public abstract void handleEvent(WorkflowEvent event);
    
    protected void sendEvent(WorkflowEventType type, String taskId) {
        if (isActive && mediator != null) {
            WorkflowEvent event = new WorkflowEvent(type, taskId, componentName);
            mediator.handleEvent(event);
        }
    }
    
    protected void sendEvent(WorkflowEventType type, String taskId, String targetComponent, Map<String, Object> data) {
        if (isActive && mediator != null) {
            WorkflowEvent event = new WorkflowEvent(type, taskId, componentName);
            event.setToComponent(targetComponent);
            if (data != null) {
                event.getData().putAll(data);
            }
            mediator.handleEvent(event);
        }
    }
    
    public String getComponentName() { return componentName; }
    public void setActive(boolean active) { this.isActive = active; }
    public boolean isActive() { return isActive; }
}

// 具体中介者 - 工作流引擎
class WorkflowEngine extends WorkflowMediator {
    private Map<String, WorkflowComponent> components;
    private List<WorkflowEvent> eventHistory;
    private Map<String, String> taskAssignments; // taskId -> assignee
    
    public WorkflowEngine() {
        this.components = new HashMap<>();
        this.eventHistory = new ArrayList<>();
        this.taskAssignments = new HashMap<>();
    }
    
    @Override
    public void handleEvent(WorkflowEvent event) {
        // 记录事件历史
        eventHistory.add(event);
        System.out.println("工作流引擎处理事件: " + event);
        
        // 根据事件类型和目标组件路由事件
        if (event.getToComponent() != null) {
            // 定向发送给特定组件
            WorkflowComponent targetComponent = components.get(event.getToComponent());
            if (targetComponent != null && targetComponent.isActive()) {
                targetComponent.handleEvent(event);
            }
        } else {
            // 广播给所有相关组件
            routeEventToComponents(event);
        }
        
        // 执行工作流逻辑
        executeWorkflowLogic(event);
    }
    
    private void routeEventToComponents(WorkflowEvent event) {
        for (WorkflowComponent component : components.values()) {
            if (component.isActive() && !component.getComponentName().equals(event.getFromComponent())) {
                component.handleEvent(event);
            }
        }
    }
    
    private void executeWorkflowLogic(WorkflowEvent event) {
        switch (event.getType()) {
            case TASK_CREATED:
                // 自动分配任务
                autoAssignTask(event);
                break;
            case TASK_COMPLETED:
                // 检查是否需要审批
                checkApprovalRequired(event);
                break;
            case APPROVAL_GRANTED:
                // 任务完成流程
                completeTaskFlow(event);
                break;
            case APPROVAL_DENIED:
                // 任务被拒绝，重新分配
                reassignTask(event);
                break;
        }
    }
    
    private void autoAssignTask(WorkflowEvent event) {
        String taskId = event.getTaskId();
        String assignee = "DefaultAssignee"; // 简化的分配逻辑
        taskAssignments.put(taskId, assignee);
        
        Map<String, Object> assignmentData = new HashMap<>();
        assignmentData.put("assignee", assignee);
        
        WorkflowEvent assignEvent = new WorkflowEvent(WorkflowEventType.TASK_ASSIGNED, taskId, "WorkflowEngine");
        assignEvent.getData().putAll(assignmentData);
        handleEvent(assignEvent);
    }
    
    private void checkApprovalRequired(WorkflowEvent event) {
        // 简化逻辑：所有完成的任务都需要审批
        WorkflowEvent approvalEvent = new WorkflowEvent(WorkflowEventType.APPROVAL_REQUESTED, 
                                                       event.getTaskId(), "WorkflowEngine");
        approvalEvent.setToComponent("ApprovalService");
        handleEvent(approvalEvent);
    }
    
    private void completeTaskFlow(WorkflowEvent event) {
        String taskId = event.getTaskId();
        taskAssignments.remove(taskId);
        System.out.println("任务 " + taskId + " 已完成整个工作流程");
    }
    
    private void reassignTask(WorkflowEvent event) {
        String taskId = event.getTaskId();
        System.out.println("任务 " + taskId + " 被拒绝，重新分配");
        autoAssignTask(event);
    }
    
    @Override
    public void registerComponent(WorkflowComponent component) {
        components.put(component.getComponentName(), component);
        System.out.println("组件已注册: " + component.getComponentName());
    }
    
    @Override
    public void unregisterComponent(WorkflowComponent component) {
        components.remove(component.getComponentName());
        System.out.println("组件已注销: " + component.getComponentName());
    }
    
    public void printEventHistory() {
        System.out.println("\n=== 事件历史 ===");
        for (int i = 0; i < eventHistory.size(); i++) {
            System.out.println((i + 1) + ". " + eventHistory.get(i));
        }
    }
    
    public void printSystemStatus() {
        System.out.println("\n=== 系统状态 ===");
        System.out.println("注册组件数: " + components.size());
        System.out.println("活跃任务数: " + taskAssignments.size());
        System.out.println("事件历史数: " + eventHistory.size());
    }
}

// 任务管理组件
class TaskManager extends WorkflowComponent {
    private Map<String, String> tasks; // taskId -> taskDescription
    
    public TaskManager(WorkflowMediator mediator) {
        super(mediator, "TaskManager");
        this.tasks = new HashMap<>();
    }
    
    public void createTask(String taskId, String description) {
        tasks.put(taskId, description);
        System.out.println("TaskManager: 创建任务 " + taskId + " - " + description);
        
        Map<String, Object> taskData = new HashMap<>();
        taskData.put("description", description);
        sendEvent(WorkflowEventType.TASK_CREATED, taskId, null, taskData);
    }
    
    public void completeTask(String taskId) {
        if (tasks.containsKey(taskId)) {
            System.out.println("TaskManager: 完成任务 " + taskId);
            sendEvent(WorkflowEventType.TASK_COMPLETED, taskId);
        }
    }
    
    @Override
    public void handleEvent(WorkflowEvent event) {
        switch (event.getType()) {
            case TASK_ASSIGNED:
                String assignee = (String) event.getData().get("assignee");
                System.out.println("TaskManager: 任务 " + event.getTaskId() + " 已分配给 " + assignee);
                break;
            case APPROVAL_GRANTED:
                System.out.println("TaskManager: 任务 " + event.getTaskId() + " 审批通过");
                break;
            case APPROVAL_DENIED:
                System.out.println("TaskManager: 任务 " + event.getTaskId() + " 审批被拒绝");
                break;
        }
    }
}

// 通知服务组件
class NotificationService extends WorkflowComponent {
    public NotificationService(WorkflowMediator mediator) {
        super(mediator, "NotificationService");
    }
    
    @Override
    public void handleEvent(WorkflowEvent event) {
        switch (event.getType()) {
            case TASK_CREATED:
                sendNotification("新任务创建: " + event.getTaskId());
                break;
            case TASK_ASSIGNED:
                String assignee = (String) event.getData().get("assignee");
                sendNotification("任务分配通知: " + event.getTaskId() + " -> " + assignee);
                break;
            case TASK_COMPLETED:
                sendNotification("任务完成通知: " + event.getTaskId());
                break;
            case APPROVAL_GRANTED:
                sendNotification("审批通过通知: " + event.getTaskId());
                break;
            case APPROVAL_DENIED:
                sendNotification("审批拒绝通知: " + event.getTaskId());
                break;
        }
    }
    
    private void sendNotification(String message) {
        System.out.println("NotificationService: 发送通知 - " + message);
    }
}

// 审批服务组件
class ApprovalService extends WorkflowComponent {
    private Random random = new Random();
    
    public ApprovalService(WorkflowMediator mediator) {
        super(mediator, "ApprovalService");
    }
    
    @Override
    public void handleEvent(WorkflowEvent event) {
        if (event.getType() == WorkflowEventType.APPROVAL_REQUESTED) {
            processApproval(event.getTaskId());
        }
    }
    
    private void processApproval(String taskId) {
        System.out.println("ApprovalService: 处理审批请求 " + taskId);
        
        // 模拟审批处理时间
        try {
            Thread.sleep(100);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
        
        // 随机审批结果
        boolean approved = random.nextBoolean();
        WorkflowEventType resultType = approved ? WorkflowEventType.APPROVAL_GRANTED : WorkflowEventType.APPROVAL_DENIED;
        
        System.out.println("ApprovalService: 审批结果 " + taskId + " - " + (approved ? "通过" : "拒绝"));
        sendEvent(resultType, taskId);
    }
}

// 日志服务组件
class LoggingService extends WorkflowComponent {
    private List<String> logs;
    
    public LoggingService(WorkflowMediator mediator) {
        super(mediator, "LoggingService");
        this.logs = new ArrayList<>();
    }
    
    @Override
    public void handleEvent(WorkflowEvent event) {
        String logEntry = String.format("[%s] %s: %s", 
                                       new Date(event.getTimestamp()), 
                                       event.getType(), 
                                       event.getTaskId());
        logs.add(logEntry);
        System.out.println("LoggingService: 记录日志 - " + logEntry);
    }
    
    public void printLogs() {
        System.out.println("\n=== 系统日志 ===");
        for (int i = 0; i < logs.size(); i++) {
            System.out.println((i + 1) + ". " + logs.get(i));
        }
    }
}

// 企业级工作流系统演示
public class EnterpriseWorkflowDemo {
    public static void main(String[] args) {
        System.out.println("=== 企业级工作流协调系统演示 ===\n");
        
        // 创建工作流引擎（中介者）
        WorkflowEngine workflowEngine = new WorkflowEngine();
        
        // 创建并注册各个组件
        TaskManager taskManager = new TaskManager(workflowEngine);
        NotificationService notificationService = new NotificationService(workflowEngine);
        ApprovalService approvalService = new ApprovalService(workflowEngine);
        LoggingService loggingService = new LoggingService(workflowEngine);
        
        workflowEngine.registerComponent(taskManager);
        workflowEngine.registerComponent(notificationService);
        workflowEngine.registerComponent(approvalService);
        workflowEngine.registerComponent(loggingService);
        
        System.out.println();
        
        // 模拟工作流程
        System.out.println("=== 开始工作流程 ===");
        
        // 创建任务
        taskManager.createTask("TASK-001", "开发新功能模块");
        Thread.sleep(200);
        
        taskManager.createTask("TASK-002", "修复系统Bug");
        Thread.sleep(200);
        
        // 完成任务
        taskManager.completeTask("TASK-001");
        Thread.sleep(300);
        
        taskManager.completeTask("TASK-002");
        Thread.sleep(300);
        
        // 打印系统状态和历史
        workflowEngine.printSystemStatus();
        workflowEngine.printEventHistory();
        loggingService.printLogs();
        
        System.out.println("\n=== 中介者模式优势 ===");
        System.out.println("- 解耦: 组件间不直接依赖，通过中介者通信");
        System.out.println("- 集中控制: 复杂的交互逻辑集中在中介者中");
        System.out.println("- 可扩展: 容易添加新的组件和交互规则");
        System.out.println("- 可维护: 修改交互逻辑只需修改中介者");
        System.out.println("- 可重用: 组件可以在不同的中介者中重用");
    }
}
```

**模式优势**
- **降低耦合**：对象间不直接引用，通过中介者通信
- **集中控制**：将复杂的交互逻辑集中在中介者中
- **提高可维护性**：修改交互行为只需修改中介者
- **支持多对多通信**：简化复杂的对象间通信

**适用场景**
- 一组对象以定义良好但是复杂的方式进行通信
- 想要重用一个对象，但该对象与其他对象紧密耦合
- 想要定制一个分布在多个类中的行为，而又不想生成太多子类
- 对象间的交互虽然定义明确但非常复杂，导致相互依赖且难以理解

#### 核心概念
- **中介者**：定义对象间交互的封装
- **同事类**：相互交互的对象
- **松耦合**：对象间不直接引用，通过中介者交互
- **集中控制**：将交互逻辑集中在中介者中

#### 参与者概念
- **中介者接口**：定义同事对象交互的接口
- **具体中介者**：实现中介者接口，协调同事对象
- **同事类**：需要与其他对象交互的类

### 6. 备忘录模式 (Memento)

**定义**：在不破坏封装性的前提下，捕获一个对象的内部状态，并在该对象之外保存这个状态。这样以后就可将该对象恢复到原先保存的状态。

**GoF原定义**："Without violating encapsulation, capture and externalize an object's internal state so that the object can be restored to this state later."

**核心思想**
- 保存对象的内部状态快照，支持撤销操作
- 不破坏对象的封装性
- 将状态保存和恢复的责任分离
- 支持多级撤销和重做功能

**基础例子：文本编辑器撤销功能**

```java
// 备忘录类 - 保存编辑器状态
class EditorMemento {
    private final String content;
    private final int cursorPosition;
    private final long timestamp;
    
    public EditorMemento(String content, int cursorPosition) {
        this.content = content;
        this.cursorPosition = cursorPosition;
        this.timestamp = System.currentTimeMillis();
    }
    
    public String getContent() {
        return content;
    }
    
    public int getCursorPosition() {
        return cursorPosition;
    }
    
    public long getTimestamp() {
        return timestamp;
    }
    
    @Override
    public String toString() {
        return "EditorMemento{" +
               "content='" + content.substring(0, Math.min(content.length(), 20)) + 
               (content.length() > 20 ? "..." : "") + "', " +
               "cursorPosition=" + cursorPosition + ", " +
               "timestamp=" + new Date(timestamp) + '}';
    }
}

// 原发器 - 文本编辑器
class TextEditor {
    private StringBuilder content;
    private int cursorPosition;
    
    public TextEditor() {
        this.content = new StringBuilder();
        this.cursorPosition = 0;
    }
    
    public void type(String text) {
        content.insert(cursorPosition, text);
        cursorPosition += text.length();
        System.out.println("输入文本: \"" + text + "\"");
        System.out.println("当前内容: \"" + content + "\"");
    }
    
    public void delete(int length) {
        if (cursorPosition >= length) {
            String deletedText = content.substring(cursorPosition - length, cursorPosition);
            content.delete(cursorPosition - length, cursorPosition);
            cursorPosition -= length;
            System.out.println("删除文本: \"" + deletedText + "\"");
            System.out.println("当前内容: \"" + content + "\"");
        }
    }
    
    public void moveCursor(int position) {
        if (position >= 0 && position <= content.length()) {
            cursorPosition = position;
            System.out.println("光标移动到位置: " + position);
        }
    }
    
    // 创建备忘录
    public EditorMemento createMemento() {
        return new EditorMemento(content.toString(), cursorPosition);
    }
    
    // 恢复状态
    public void restoreFromMemento(EditorMemento memento) {
        this.content = new StringBuilder(memento.getContent());
        this.cursorPosition = memento.getCursorPosition();
        System.out.println("恢复到状态: \"" + content + "\", 光标位置: " + cursorPosition);
    }
    
    public String getContent() {
        return content.toString();
    }
    
    public int getCursorPosition() {
        return cursorPosition;
    }
    
    public void printStatus() {
        System.out.println("编辑器状态 - 内容: \"" + content + "\", 光标位置: " + cursorPosition);
    }
}

// 管理者 - 撤销管理器
class UndoManager {
    private Stack<EditorMemento> undoStack;
    private Stack<EditorMemento> redoStack;
    private int maxHistorySize;
    
    public UndoManager(int maxHistorySize) {
        this.undoStack = new Stack<>();
        this.redoStack = new Stack<>();
        this.maxHistorySize = maxHistorySize;
    }
    
    public void saveState(EditorMemento memento) {
        undoStack.push(memento);
        redoStack.clear(); // 保存新状态时清空重做栈
        
        // 限制历史记录大小
        if (undoStack.size() > maxHistorySize) {
            undoStack.remove(0);
        }
        
        System.out.println("状态已保存: " + memento);
    }
    
    public EditorMemento undo() {
        if (!undoStack.isEmpty()) {
            EditorMemento memento = undoStack.pop();
            redoStack.push(memento);
            System.out.println("撤销操作: " + memento);
            return memento;
        }
        System.out.println("没有可撤销的操作");
        return null;
    }
    
    public EditorMemento redo() {
        if (!redoStack.isEmpty()) {
            EditorMemento memento = redoStack.pop();
            undoStack.push(memento);
            System.out.println("重做操作: " + memento);
            return memento;
        }
        System.out.println("没有可重做的操作");
        return null;
    }
    
    public boolean canUndo() {
        return !undoStack.isEmpty();
    }
    
    public boolean canRedo() {
        return !redoStack.isEmpty();
    }
    
    public void printHistory() {
        System.out.println("\n=== 撤销历史 ===");
        System.out.println("撤销栈 (共 " + undoStack.size() + " 个状态):");
        for (int i = undoStack.size() - 1; i >= 0; i--) {
            System.out.println("  " + (undoStack.size() - i) + ". " + undoStack.get(i));
        }
        
        System.out.println("重做栈 (共 " + redoStack.size() + " 个状态):");
        for (int i = redoStack.size() - 1; i >= 0; i--) {
            System.out.println("  " + (redoStack.size() - i) + ". " + redoStack.get(i));
        }
    }
}

// 客户端使用
public class TextEditorDemo {
    public static void main(String[] args) {
        System.out.println("=== 文本编辑器撤销功能演示 ===\n");
        
        TextEditor editor = new TextEditor();
        UndoManager undoManager = new UndoManager(10);
        
        // 保存初始状态
        undoManager.saveState(editor.createMemento());
        
        // 编辑操作
        editor.type("Hello");
        undoManager.saveState(editor.createMemento());
        
        editor.type(" World");
        undoManager.saveState(editor.createMemento());
        
        editor.type("!");
        undoManager.saveState(editor.createMemento());
        
        editor.moveCursor(5);
        editor.type(" Beautiful");
        undoManager.saveState(editor.createMemento());
        
        System.out.println("\n当前编辑器状态:");
        editor.printStatus();
        
        // 撤销操作
        System.out.println("\n=== 撤销操作 ===");
        EditorMemento memento = undoManager.undo();
        if (memento != null) {
            editor.restoreFromMemento(memento);
        }
        
        memento = undoManager.undo();
        if (memento != null) {
            editor.restoreFromMemento(memento);
        }
        
        // 重做操作
        System.out.println("\n=== 重做操作 ===");
        memento = undoManager.redo();
        if (memento != null) {
            editor.restoreFromMemento(memento);
        }
        
        // 打印历史记录
        undoManager.printHistory();
    }
}
```

**进阶例子：企业级游戏存档系统**

```java
// 游戏状态数据类
class GameState {
    private int level;
    private int score;
    private int lives;
    private Map<String, Integer> inventory;
    private Position playerPosition;
    private List<String> achievements;
    private long playTime; // 游戏时间（毫秒）
    
    public GameState(int level, int score, int lives, Map<String, Integer> inventory, 
                    Position playerPosition, List<String> achievements, long playTime) {
        this.level = level;
        this.score = score;
        this.lives = lives;
        this.inventory = new HashMap<>(inventory);
        this.playerPosition = new Position(playerPosition.x, playerPosition.y);
        this.achievements = new ArrayList<>(achievements);
        this.playTime = playTime;
    }
    
    // Getters
    public int getLevel() { return level; }
    public int getScore() { return score; }
    public int getLives() { return lives; }
    public Map<String, Integer> getInventory() { return new HashMap<>(inventory); }
    public Position getPlayerPosition() { return new Position(playerPosition.x, playerPosition.y); }
    public List<String> getAchievements() { return new ArrayList<>(achievements); }
    public long getPlayTime() { return playTime; }
    
    @Override
    public String toString() {
        return String.format("GameState{level=%d, score=%d, lives=%d, pos=(%d,%d), items=%d, achievements=%d, time=%ds}", 
                           level, score, lives, playerPosition.x, playerPosition.y, 
                           inventory.size(), achievements.size(), playTime / 1000);
    }
}

// 位置类
class Position {
    int x, y;
    
    public Position(int x, int y) {
        this.x = x;
        this.y = y;
    }
    
    @Override
    public String toString() {
        return "(" + x + "," + y + ")";
    }
}

// 游戏存档备忘录
class GameMemento {
    private final GameState gameState;
    private final String saveSlotName;
    private final long saveTimestamp;
    private final String description;
    
    public GameMemento(GameState gameState, String saveSlotName, String description) {
        this.gameState = gameState;
        this.saveSlotName = saveSlotName;
        this.description = description;
        this.saveTimestamp = System.currentTimeMillis();
    }
    
    public GameState getGameState() {
        return gameState;
    }
    
    public String getSaveSlotName() {
        return saveSlotName;
    }
    
    public long getSaveTimestamp() {
        return saveTimestamp;
    }
    
    public String getDescription() {
        return description;
    }
    
    @Override
    public String toString() {
        return String.format("GameMemento{slot='%s', desc='%s', time=%s, state=%s}", 
                           saveSlotName, description, new Date(saveTimestamp), gameState);
    }
}

// 游戏原发器
class Game {
    private int level;
    private int score;
    private int lives;
    private Map<String, Integer> inventory;
    private Position playerPosition;
    private List<String> achievements;
    private long gameStartTime;
    private long totalPlayTime;
    
    public Game() {
        this.level = 1;
        this.score = 0;
        this.lives = 3;
        this.inventory = new HashMap<>();
        this.playerPosition = new Position(0, 0);
        this.achievements = new ArrayList<>();
        this.gameStartTime = System.currentTimeMillis();
        this.totalPlayTime = 0;
        
        // 初始化一些道具
        inventory.put("金币", 100);
        inventory.put("生命药水", 2);
    }
    
    // 游戏操作方法
    public void levelUp() {
        level++;
        score += 1000;
        System.out.println("升级到第 " + level + " 关！获得1000分奖励");
        
        if (level % 5 == 0) {
            achievements.add("达到第" + level + "关");
            System.out.println("获得成就: 达到第" + level + "关");
        }
    }
    
    public void collectItem(String itemName, int quantity) {
        inventory.put(itemName, inventory.getOrDefault(itemName, 0) + quantity);
        score += quantity * 10;
        System.out.println("收集道具: " + itemName + " x" + quantity);
    }
    
    public void movePlayer(int deltaX, int deltaY) {
        playerPosition.x += deltaX;
        playerPosition.y += deltaY;
        System.out.println("玩家移动到位置: " + playerPosition);
    }
    
    public void loseLife() {
        if (lives > 0) {
            lives--;
            System.out.println("失去一条生命，剩余生命: " + lives);
            if (lives == 0) {
                System.out.println("游戏结束！");
            }
        }
    }
    
    public void useItem(String itemName) {
        if (inventory.containsKey(itemName) && inventory.get(itemName) > 0) {
            inventory.put(itemName, inventory.get(itemName) - 1);
            if (itemName.equals("生命药水")) {
                lives++;
                System.out.println("使用生命药水，生命+1，当前生命: " + lives);
            }
        }
    }
    
    // 创建存档
    public GameMemento createSave(String saveSlotName, String description) {
        long currentPlayTime = totalPlayTime + (System.currentTimeMillis() - gameStartTime);
        GameState state = new GameState(level, score, lives, inventory, playerPosition, 
                                       achievements, currentPlayTime);
        return new GameMemento(state, saveSlotName, description);
    }
    
    // 加载存档
    public void loadSave(GameMemento memento) {
        GameState state = memento.getGameState();
        this.level = state.getLevel();
        this.score = state.getScore();
        this.lives = state.getLives();
        this.inventory = state.getInventory();
        this.playerPosition = state.getPlayerPosition();
        this.achievements = state.getAchievements();
        this.totalPlayTime = state.getPlayTime();
        this.gameStartTime = System.currentTimeMillis();
        
        System.out.println("加载存档: " + memento.getSaveSlotName() + " - " + memento.getDescription());
        System.out.println("游戏状态已恢复: " + state);
    }
    
    public void printGameStatus() {
        long currentPlayTime = totalPlayTime + (System.currentTimeMillis() - gameStartTime);
        System.out.println("\n=== 当前游戏状态 ===");
        System.out.println("关卡: " + level);
        System.out.println("分数: " + score);
        System.out.println("生命: " + lives);
        System.out.println("位置: " + playerPosition);
        System.out.println("道具: " + inventory);
        System.out.println("成就: " + achievements);
        System.out.println("游戏时间: " + (currentPlayTime / 1000) + "秒");
    }
}

// 存档管理器
class SaveManager {
    private Map<String, GameMemento> saveSlots;
    private List<GameMemento> autoSaves;
    private int maxAutoSaves;
    
    public SaveManager(int maxAutoSaves) {
        this.saveSlots = new HashMap<>();
        this.autoSaves = new ArrayList<>();
        this.maxAutoSaves = maxAutoSaves;
    }
    
    // 手动存档
    public void saveGame(GameMemento memento) {
        saveSlots.put(memento.getSaveSlotName(), memento);
        System.out.println("游戏已保存到存档槽: " + memento.getSaveSlotName());
    }
    
    // 自动存档
    public void autoSave(GameMemento memento) {
        autoSaves.add(memento);
        
        // 限制自动存档数量
        if (autoSaves.size() > maxAutoSaves) {
            GameMemento removed = autoSaves.remove(0);
            System.out.println("删除旧的自动存档: " + removed.getDescription());
        }
        
        System.out.println("自动存档完成: " + memento.getDescription());
    }
    
    // 加载存档
    public GameMemento loadGame(String saveSlotName) {
        GameMemento memento = saveSlots.get(saveSlotName);
        if (memento != null) {
            System.out.println("加载存档: " + saveSlotName);
            return memento;
        } else {
            System.out.println("存档槽 " + saveSlotName + " 不存在");
            return null;
        }
    }
    
    // 加载最近的自动存档
    public GameMemento loadLatestAutoSave() {
        if (!autoSaves.isEmpty()) {
            GameMemento latest = autoSaves.get(autoSaves.size() - 1);
            System.out.println("加载最新自动存档: " + latest.getDescription());
            return latest;
        } else {
            System.out.println("没有自动存档");
            return null;
        }
    }
    
    // 删除存档
    public void deleteSave(String saveSlotName) {
        GameMemento removed = saveSlots.remove(saveSlotName);
        if (removed != null) {
            System.out.println("删除存档: " + saveSlotName);
        } else {
            System.out.println("存档槽 " + saveSlotName + " 不存在");
        }
    }
    
    // 列出所有存档
    public void listAllSaves() {
        System.out.println("\n=== 存档列表 ===");
        
        System.out.println("手动存档 (共 " + saveSlots.size() + " 个):");
        saveSlots.forEach((slot, memento) -> {
            System.out.println("  " + slot + ": " + memento.getDescription() + 
                             " (保存时间: " + new Date(memento.getSaveTimestamp()) + ")");
        });
        
        System.out.println("自动存档 (共 " + autoSaves.size() + " 个):");
        for (int i = 0; i < autoSaves.size(); i++) {
            GameMemento memento = autoSaves.get(i);
            System.out.println("  自动存档" + (i + 1) + ": " + memento.getDescription() + 
                             " (保存时间: " + new Date(memento.getSaveTimestamp()) + ")");
        }
    }
    
    // 获取存档统计信息
    public void printSaveStats() {
        System.out.println("\n=== 存档统计 ===");
        System.out.println("手动存档数量: " + saveSlots.size());
        System.out.println("自动存档数量: " + autoSaves.size());
        System.out.println("最大自动存档数: " + maxAutoSaves);
        
        if (!saveSlots.isEmpty()) {
            GameMemento latest = saveSlots.values().stream()
                .max((m1, m2) -> Long.compare(m1.getSaveTimestamp(), m2.getSaveTimestamp()))
                .orElse(null);
            if (latest != null) {
                System.out.println("最新手动存档: " + latest.getSaveSlotName() + 
                                 " (" + new Date(latest.getSaveTimestamp()) + ")");
            }
        }
    }
}

// 企业级游戏存档系统演示
public class EnterpriseGameSaveDemo {
    public static void main(String[] args) throws InterruptedException {
        System.out.println("=== 企业级游戏存档系统演示 ===\n");
        
        Game game = new Game();
        SaveManager saveManager = new SaveManager(3); // 最多保存3个自动存档
        
        // 初始状态
        game.printGameStatus();
        
        // 游戏进程1
        System.out.println("\n=== 游戏进程1 ===");
        game.collectItem("金币", 50);
        game.movePlayer(10, 5);
        game.levelUp();
        
        // 手动存档
        GameMemento save1 = game.createSave("存档1", "第2关开始");
        saveManager.saveGame(save1);
        
        Thread.sleep(100); // 模拟时间流逝
        
        // 游戏进程2
        System.out.println("\n=== 游戏进程2 ===");
        game.collectItem("生命药水", 1);
        game.movePlayer(5, 10);
        game.levelUp();
        game.levelUp();
        
        // 自动存档
        GameMemento autoSave1 = game.createSave("auto_save_1", "第4关自动存档");
        saveManager.autoSave(autoSave1);
        
        Thread.sleep(100);
        
        // 游戏进程3
        System.out.println("\n=== 游戏进程3 ===");
        game.loseLife();
        game.useItem("生命药水");
        game.levelUp();
        game.levelUp();
        
        // 手动存档
        GameMemento save2 = game.createSave("存档2", "第6关BOSS前");
        saveManager.saveGame(save2);
        
        // 自动存档
        GameMemento autoSave2 = game.createSave("auto_save_2", "第6关自动存档");
        saveManager.autoSave(autoSave2);
        
        game.printGameStatus();
        
        // 模拟游戏失败，加载存档
        System.out.println("\n=== 游戏失败，加载存档 ===");
        game.loseLife();
        game.loseLife();
        game.loseLife();
        
        // 加载之前的存档
        GameMemento loadedSave = saveManager.loadGame("存档1");
        if (loadedSave != null) {
            game.loadSave(loadedSave);
            game.printGameStatus();
        }
        
        // 继续游戏
        System.out.println("\n=== 继续游戏 ===");
        game.collectItem("魔法卷轴", 3);
        game.levelUp();
        
        // 更多自动存档测试
        for (int i = 3; i <= 5; i++) {
            GameMemento autoSave = game.createSave("auto_save_" + i, "第" + (game.level + 1) + "关自动存档");
            saveManager.autoSave(autoSave);
            game.levelUp();
            Thread.sleep(50);
        }
        
        // 显示所有存档
        saveManager.listAllSaves();
        saveManager.printSaveStats();
        
        // 加载最新自动存档
        System.out.println("\n=== 加载最新自动存档 ===");
        GameMemento latestAutoSave = saveManager.loadLatestAutoSave();
        if (latestAutoSave != null) {
            game.loadSave(latestAutoSave);
            game.printGameStatus();
        }
        
        System.out.println("\n=== 备忘录模式优势 ===");
        System.out.println("- 封装性: 不破坏对象的封装性保存状态");
        System.out.println("- 简化原发器: 原发器不需要管理历史状态");
        System.out.println("- 状态独立: 备忘录状态独立于原发器");
        System.out.println("- 支持多级撤销: 可以保存多个历史状态");
        System.out.println("- 灵活恢复: 可以选择性地恢复到任意历史状态");
    }
}
```

**模式优势**
- **保持封装性**：不破坏对象的封装边界
- **简化原发器**：原发器不需要管理多个历史状态
- **状态独立性**：备忘录独立于原发器存在
- **支持撤销操作**：提供撤销和恢复功能

**适用场景**
- 需要保存对象状态快照以便后续恢复
- 需要实现撤销操作的系统
- 需要提供事务回滚功能
- 需要实现检查点和恢复机制的系统

**注意事项**
- 如果原发器状态复杂，备忘录可能消耗大量内存
- 需要考虑备忘录的生命周期管理
- 在某些情况下可能需要增量备忘录来优化性能

#### 核心概念
- **备忘录**：在不破坏封装的前提下捕获对象的内部状态
- **发起人**：创建备忘录的对象
- **管理者**：负责保存备忘录的对象
- **状态恢复**：从备忘录中恢复对象状态

#### 参与者概念
- **发起人**：创建备忘录来记录当前时刻的内部状态
- **备忘录**：存储发起人的内部状态
- **管理者**：负责保存备忘录，不能对备忘录的内容进行操作

#### 实现概念
- **白盒实现**：备忘录的接口提供宽接口
- **黑盒实现**：备忘录的接口不提供任何方法
- **多重检查点**：支持多个状态的保存和恢复

### 7. 观察者模式 (Observer)

**定义**：定义对象间的一种一对多的依赖关系，当一个对象的状态发生改变时，所有依赖于它的对象都得到通知并被自动更新。

**GoF原定义**："Define a one-to-many dependency between objects so that when one object changes state, all its dependents are notified and updated automatically."

**核心思想**
- 建立对象间的一对多依赖关系
- 当主题对象状态改变时，自动通知所有观察者
- 观察者和主题之间松耦合
- 支持广播通信机制

**基础例子：天气监测系统**

```java
// 观察者接口
interface Observer {
    void update(float temperature, float humidity, float pressure);
}

// 主题接口
interface Subject {
    void registerObserver(Observer observer);
    void removeObserver(Observer observer);
    void notifyObservers();
}

// 具体主题 - 天气数据
class WeatherData implements Subject {
    private List<Observer> observers;
    private float temperature;
    private float humidity;
    private float pressure;
    
    public WeatherData() {
        observers = new ArrayList<>();
    }
    
    @Override
    public void registerObserver(Observer observer) {
        observers.add(observer);
        System.out.println("观察者已注册: " + observer.getClass().getSimpleName());
    }
    
    @Override
    public void removeObserver(Observer observer) {
        observers.remove(observer);
        System.out.println("观察者已移除: " + observer.getClass().getSimpleName());
    }
    
    @Override
    public void notifyObservers() {
        for (Observer observer : observers) {
            observer.update(temperature, humidity, pressure);
        }
    }
    
    public void measurementsChanged() {
        notifyObservers();
    }
    
    public void setMeasurements(float temperature, float humidity, float pressure) {
        this.temperature = temperature;
        this.humidity = humidity;
        this.pressure = pressure;
        System.out.println("天气数据更新: 温度=" + temperature + "°C, 湿度=" + humidity + "%, 气压=" + pressure + "hPa");
        measurementsChanged();
    }
    
    // Getters
    public float getTemperature() { return temperature; }
    public float getHumidity() { return humidity; }
    public float getPressure() { return pressure; }
}

// 具体观察者 - 当前天气显示
class CurrentConditionsDisplay implements Observer {
    private float temperature;
    private float humidity;
    private Subject weatherData;
    
    public CurrentConditionsDisplay(Subject weatherData) {
        this.weatherData = weatherData;
        weatherData.registerObserver(this);
    }
    
    @Override
    public void update(float temperature, float humidity, float pressure) {
        this.temperature = temperature;
        this.humidity = humidity;
        display();
    }
    
    public void display() {
        System.out.println("当前天气: 温度 " + temperature + "°C, 湿度 " + humidity + "%");
    }
}

// 具体观察者 - 统计显示
class StatisticsDisplay implements Observer {
    private float maxTemp = 0.0f;
    private float minTemp = 200;
    private float tempSum = 0.0f;
    private int numReadings;
    private Subject weatherData;
    
    public StatisticsDisplay(Subject weatherData) {
        this.weatherData = weatherData;
        weatherData.registerObserver(this);
    }
    
    @Override
    public void update(float temperature, float humidity, float pressure) {
        tempSum += temperature;
        numReadings++;
        
        if (temperature > maxTemp) {
            maxTemp = temperature;
        }
        
        if (temperature < minTemp) {
            minTemp = temperature;
        }
        
        display();
    }
    
    public void display() {
        System.out.println("温度统计: 平均 " + (tempSum / numReadings) + "°C, 最高 " + maxTemp + "°C, 最低 " + minTemp + "°C");
    }
}

// 具体观察者 - 预报显示
class ForecastDisplay implements Observer {
    private float currentPressure = 29.92f;
    private float lastPressure;
    private Subject weatherData;
    
    public ForecastDisplay(Subject weatherData) {
        this.weatherData = weatherData;
        weatherData.registerObserver(this);
    }
    
    @Override
    public void update(float temperature, float humidity, float pressure) {
        lastPressure = currentPressure;
        currentPressure = pressure;
        display();
    }
    
    public void display() {
        String forecast;
        if (currentPressure > lastPressure) {
            forecast = "天气转好";
        } else if (currentPressure == lastPressure) {
            forecast = "天气稳定";
        } else {
            forecast = "天气转坏";
        }
        System.out.println("天气预报: " + forecast + " (气压变化: " + (currentPressure - lastPressure) + "hPa)");
    }
}

// 客户端使用
public class WeatherStationDemo {
    public static void main(String[] args) {
        System.out.println("=== 天气监测系统演示 ===\n");
        
        // 创建天气数据主题
        WeatherData weatherData = new WeatherData();
        
        // 创建观察者
        CurrentConditionsDisplay currentDisplay = new CurrentConditionsDisplay(weatherData);
        StatisticsDisplay statisticsDisplay = new StatisticsDisplay(weatherData);
        ForecastDisplay forecastDisplay = new ForecastDisplay(weatherData);
        
        System.out.println();
        
        // 模拟天气数据变化
        System.out.println("第一次天气数据更新:");
        weatherData.setMeasurements(25.0f, 65.0f, 1013.2f);
        
        System.out.println("\n第二次天气数据更新:");
        weatherData.setMeasurements(28.0f, 70.0f, 1012.8f);
        
        System.out.println("\n第三次天气数据更新:");
        weatherData.setMeasurements(22.0f, 80.0f, 1010.5f);
        
        // 移除一个观察者
        System.out.println("\n移除统计显示观察者:");
        weatherData.removeObserver(statisticsDisplay);
        
        System.out.println("\n第四次天气数据更新:");
        weatherData.setMeasurements(26.0f, 75.0f, 1014.1f);
    }
}
```

**进阶例子：企业级事件驱动系统**

```java
// 事件类型枚举
enum EventType {
    USER_REGISTERED, USER_LOGIN, USER_LOGOUT, ORDER_CREATED, ORDER_PAID, 
    ORDER_SHIPPED, ORDER_DELIVERED, INVENTORY_LOW, SYSTEM_ERROR
}

// 事件数据基类
abstract class EventData {
    private final String eventId;
    private final long timestamp;
    private final String source;
    
    public EventData(String source) {
        this.eventId = UUID.randomUUID().toString();
        this.timestamp = System.currentTimeMillis();
        this.source = source;
    }
    
    public String getEventId() { return eventId; }
    public long getTimestamp() { return timestamp; }
    public String getSource() { return source; }
    
    @Override
    public String toString() {
        return String.format("EventData{id='%s', source='%s', time=%s}", 
                           eventId.substring(0, 8), source, new Date(timestamp));
    }
}

// 用户事件数据
class UserEventData extends EventData {
    private final String userId;
    private final String username;
    private final String email;
    
    public UserEventData(String source, String userId, String username, String email) {
        super(source);
        this.userId = userId;
        this.username = username;
        this.email = email;
    }
    
    public String getUserId() { return userId; }
    public String getUsername() { return username; }
    public String getEmail() { return email; }
    
    @Override
    public String toString() {
        return super.toString() + String.format(" User{id='%s', name='%s', email='%s'}", 
                                              userId, username, email);
    }
}

// 订单事件数据
class OrderEventData extends EventData {
    private final String orderId;
    private final String userId;
    private final double amount;
    private final String status;
    
    public OrderEventData(String source, String orderId, String userId, double amount, String status) {
        super(source);
        this.orderId = orderId;
        this.userId = userId;
        this.amount = amount;
        this.status = status;
    }
    
    public String getOrderId() { return orderId; }
    public String getUserId() { return userId; }
    public double getAmount() { return amount; }
    public String getStatus() { return status; }
    
    @Override
    public String toString() {
        return super.toString() + String.format(" Order{id='%s', userId='%s', amount=%.2f, status='%s'}", 
                                              orderId, userId, amount, status);
    }
}

// 事件监听器接口
interface EventListener {
    void onEvent(EventType eventType, EventData eventData);
    String getListenerName();
    boolean isInterestedIn(EventType eventType);
}

// 事件发布器接口
interface EventPublisher {
    void subscribe(EventListener listener);
    void subscribe(EventListener listener, EventType... eventTypes);
    void unsubscribe(EventListener listener);
    void publishEvent(EventType eventType, EventData eventData);
}

// 具体事件发布器 - 事件总线
class EventBus implements EventPublisher {
    private final Map<EventType, List<EventListener>> listeners;
    private final List<EventListener> globalListeners;
    private final ExecutorService executorService;
    private final boolean asyncMode;
    
    public EventBus(boolean asyncMode) {
        this.listeners = new HashMap<>();
        this.globalListeners = new ArrayList<>();
        this.asyncMode = asyncMode;
        this.executorService = asyncMode ? Executors.newFixedThreadPool(5) : null;
        
        // 初始化所有事件类型的监听器列表
        for (EventType eventType : EventType.values()) {
            listeners.put(eventType, new ArrayList<>());
        }
    }
    
    @Override
    public void subscribe(EventListener listener) {
        globalListeners.add(listener);
        System.out.println("全局监听器已注册: " + listener.getListenerName());
    }
    
    @Override
    public void subscribe(EventListener listener, EventType... eventTypes) {
        for (EventType eventType : eventTypes) {
            listeners.get(eventType).add(listener);
            System.out.println("监听器已注册: " + listener.getListenerName() + " -> " + eventType);
        }
    }
    
    @Override
    public void unsubscribe(EventListener listener) {
        globalListeners.remove(listener);
        for (List<EventListener> listenerList : listeners.values()) {
            listenerList.remove(listener);
        }
        System.out.println("监听器已注销: " + listener.getListenerName());
    }
    
    @Override
    public void publishEvent(EventType eventType, EventData eventData) {
        System.out.println("发布事件: " + eventType + " - " + eventData);
        
        // 通知特定事件类型的监听器
        List<EventListener> specificListeners = listeners.get(eventType);
        notifyListeners(specificListeners, eventType, eventData);
        
        // 通知全局监听器
        List<EventListener> interestedGlobalListeners = globalListeners.stream()
            .filter(listener -> listener.isInterestedIn(eventType))
            .collect(Collectors.toList());
        notifyListeners(interestedGlobalListeners, eventType, eventData);
    }
    
    private void notifyListeners(List<EventListener> listenersToNotify, EventType eventType, EventData eventData) {
        for (EventListener listener : listenersToNotify) {
            if (asyncMode) {
                executorService.submit(() -> {
                    try {
                        listener.onEvent(eventType, eventData);
                    } catch (Exception e) {
                        System.err.println("监听器处理事件时发生异常: " + listener.getListenerName() + " - " + e.getMessage());
                    }
                });
            } else {
                try {
                    listener.onEvent(eventType, eventData);
                } catch (Exception e) {
                    System.err.println("监听器处理事件时发生异常: " + listener.getListenerName() + " - " + e.getMessage());
                }
            }
        }
    }
    
    public void shutdown() {
        if (executorService != null) {
            executorService.shutdown();
        }
    }
    
    public void printStatistics() {
        System.out.println("\n=== 事件总线统计 ===");
        System.out.println("全局监听器数量: " + globalListeners.size());
        System.out.println("特定事件监听器:");
        listeners.forEach((eventType, listenerList) -> {
            if (!listenerList.isEmpty()) {
                System.out.println("  " + eventType + ": " + listenerList.size() + " 个监听器");
            }
        });
        System.out.println("异步模式: " + (asyncMode ? "开启" : "关闭"));
    }
}

// 邮件通知监听器
class EmailNotificationListener implements EventListener {
    @Override
    public void onEvent(EventType eventType, EventData eventData) {
        switch (eventType) {
            case USER_REGISTERED:
                UserEventData userData = (UserEventData) eventData;
                sendWelcomeEmail(userData.getEmail(), userData.getUsername());
                break;
            case ORDER_CREATED:
                OrderEventData orderData = (OrderEventData) eventData;
                sendOrderConfirmationEmail(orderData);
                break;
            case ORDER_SHIPPED:
                OrderEventData shippedOrder = (OrderEventData) eventData;
                sendShippingNotificationEmail(shippedOrder);
                break;
        }
    }
    
    private void sendWelcomeEmail(String email, String username) {
        System.out.println("EmailService: 发送欢迎邮件到 " + email + " (用户: " + username + ")");
    }
    
    private void sendOrderConfirmationEmail(OrderEventData orderData) {
        System.out.println("EmailService: 发送订单确认邮件 - 订单号: " + orderData.getOrderId() + 
                          ", 金额: $" + orderData.getAmount());
    }
    
    private void sendShippingNotificationEmail(OrderEventData orderData) {
        System.out.println("EmailService: 发送发货通知邮件 - 订单号: " + orderData.getOrderId());
    }
    
    @Override
    public String getListenerName() {
        return "EmailNotificationListener";
    }
    
    @Override
    public boolean isInterestedIn(EventType eventType) {
        return eventType == EventType.USER_REGISTERED || 
               eventType == EventType.ORDER_CREATED || 
               eventType == EventType.ORDER_SHIPPED;
    }
}

// 数据分析监听器
class AnalyticsListener implements EventListener {
    private Map<EventType, Integer> eventCounts = new HashMap<>();
    
    @Override
    public void onEvent(EventType eventType, EventData eventData) {
        eventCounts.put(eventType, eventCounts.getOrDefault(eventType, 0) + 1);
        
        switch (eventType) {
            case USER_REGISTERED:
                trackUserRegistration((UserEventData) eventData);
                break;
            case ORDER_CREATED:
                trackOrderCreation((OrderEventData) eventData);
                break;
            case USER_LOGIN:
                trackUserLogin((UserEventData) eventData);
                break;
        }
    }
    
    private void trackUserRegistration(UserEventData userData) {
        System.out.println("Analytics: 记录用户注册事件 - 用户ID: " + userData.getUserId());
    }
    
    private void trackOrderCreation(OrderEventData orderData) {
        System.out.println("Analytics: 记录订单创建事件 - 订单金额: $" + orderData.getAmount());
    }
    
    private void trackUserLogin(UserEventData userData) {
        System.out.println("Analytics: 记录用户登录事件 - 用户: " + userData.getUsername());
    }
    
    @Override
    public String getListenerName() {
        return "AnalyticsListener";
    }
    
    @Override
    public boolean isInterestedIn(EventType eventType) {
        return true; // 对所有事件感兴趣
    }
    
    public void printStatistics() {
        System.out.println("\n=== 数据分析统计 ===");
        eventCounts.forEach((eventType, count) -> 
            System.out.println(eventType + ": " + count + " 次"));
    }
}

// 库存管理监听器
class InventoryListener implements EventListener {
    private Map<String, Integer> inventory = new HashMap<>();
    
    public InventoryListener() {
        // 初始化库存
        inventory.put("PROD-001", 100);
        inventory.put("PROD-002", 50);
        inventory.put("PROD-003", 25);
    }
    
    @Override
    public void onEvent(EventType eventType, EventData eventData) {
        if (eventType == EventType.ORDER_PAID) {
            OrderEventData orderData = (OrderEventData) eventData;
            updateInventory(orderData);
        }
    }
    
    private void updateInventory(OrderEventData orderData) {
        // 简化逻辑：假设每个订单消耗1个商品
        String productId = "PROD-001"; // 简化处理
        int currentStock = inventory.getOrDefault(productId, 0);
        
        if (currentStock > 0) {
            inventory.put(productId, currentStock - 1);
            System.out.println("Inventory: 更新库存 " + productId + " - 剩余: " + (currentStock - 1));
            
            // 检查低库存警告
            if (currentStock - 1 < 10) {
                System.out.println("Inventory: 库存警告 - " + productId + " 库存不足!");
            }
        }
    }
    
    @Override
    public String getListenerName() {
        return "InventoryListener";
    }
    
    @Override
    public boolean isInterestedIn(EventType eventType) {
        return eventType == EventType.ORDER_PAID;
    }
    
    public void printInventory() {
        System.out.println("\n=== 当前库存 ===");
        inventory.forEach((productId, stock) -> 
            System.out.println(productId + ": " + stock + " 件"));
    }
}

// 日志监听器
class LoggingListener implements EventListener {
    private List<String> logs = new ArrayList<>();
    
    @Override
    public void onEvent(EventType eventType, EventData eventData) {
        String logEntry = String.format("[%s] %s: %s", 
                                       new Date(eventData.getTimestamp()), 
                                       eventType, 
                                       eventData.toString());
        logs.add(logEntry);
        System.out.println("Logger: " + logEntry);
    }
    
    @Override
    public String getListenerName() {
        return "LoggingListener";
    }
    
    @Override
    public boolean isInterestedIn(EventType eventType) {
        return true; // 记录所有事件
    }
    
    public void printLogs() {
        System.out.println("\n=== 系统日志 ===");
        for (int i = 0; i < logs.size(); i++) {
            System.out.println((i + 1) + ". " + logs.get(i));
        }
    }
}

// 企业级事件驱动系统演示
public class EnterpriseEventSystemDemo {
    public static void main(String[] args) throws InterruptedException {
        System.out.println("=== 企业级事件驱动系统演示 ===\n");
        
        // 创建事件总线
        EventBus eventBus = new EventBus(false); // 同步模式
        
        // 创建监听器
        EmailNotificationListener emailListener = new EmailNotificationListener();
        AnalyticsListener analyticsListener = new AnalyticsListener();
        InventoryListener inventoryListener = new InventoryListener();
        LoggingListener loggingListener = new LoggingListener();
        
        // 注册监听器
        eventBus.subscribe(emailListener, EventType.USER_REGISTERED, EventType.ORDER_CREATED, EventType.ORDER_SHIPPED);
        eventBus.subscribe(analyticsListener); // 全局监听器
        eventBus.subscribe(inventoryListener, EventType.ORDER_PAID);
        eventBus.subscribe(loggingListener); // 全局监听器
        
        eventBus.printStatistics();
        System.out.println();
        
        // 模拟业务事件
        System.out.println("=== 模拟用户注册 ===");
        UserEventData userRegistered = new UserEventData("UserService", "USER-001", "张三", "zhangsan@example.com");
        eventBus.publishEvent(EventType.USER_REGISTERED, userRegistered);
        
        Thread.sleep(100);
        
        System.out.println("\n=== 模拟用户登录 ===");
        UserEventData userLogin = new UserEventData("AuthService", "USER-001", "张三", "zhangsan@example.com");
        eventBus.publishEvent(EventType.USER_LOGIN, userLogin);
        
        Thread.sleep(100);
        
        System.out.println("\n=== 模拟订单创建 ===");
        OrderEventData orderCreated = new OrderEventData("OrderService", "ORDER-001", "USER-001", 299.99, "CREATED");
        eventBus.publishEvent(EventType.ORDER_CREATED, orderCreated);
        
        Thread.sleep(100);
        
        System.out.println("\n=== 模拟订单支付 ===");
        OrderEventData orderPaid = new OrderEventData("PaymentService", "ORDER-001", "USER-001", 299.99, "PAID");
        eventBus.publishEvent(EventType.ORDER_PAID, orderPaid);
        
        Thread.sleep(100);
        
        System.out.println("\n=== 模拟订单发货 ===");
        OrderEventData orderShipped = new OrderEventData("ShippingService", "ORDER-001", "USER-001", 299.99, "SHIPPED");
        eventBus.publishEvent(EventType.ORDER_SHIPPED, orderShipped);
        
        // 打印统计信息
        analyticsListener.printStatistics();
        inventoryListener.printInventory();
        loggingListener.printLogs();
        
        // 测试监听器注销
        System.out.println("\n=== 注销邮件监听器 ===");
        eventBus.unsubscribe(emailListener);
        
        System.out.println("\n=== 再次创建订单（邮件监听器已注销）===");
        OrderEventData anotherOrder = new OrderEventData("OrderService", "ORDER-002", "USER-001", 199.99, "CREATED");
        eventBus.publishEvent(EventType.ORDER_CREATED, anotherOrder);
        
        eventBus.shutdown();
        
        System.out.println("\n=== 观察者模式优势 ===");
        System.out.println("- 松耦合: 主题和观察者之间松耦合");
        System.out.println("- 动态关系: 可以在运行时建立对象间的关系");
        System.out.println("- 广播通信: 支持一对多的通信机制");
        System.out.println("- 开放封闭: 符合开放-封闭原则");
        System.out.println("- 事件驱动: 支持事件驱动的架构模式");
    }
}
```

**模式优势**
- **松耦合**：主题和观察者之间松耦合，只通过接口交互
- **动态关系**：可以在运行时动态地建立和解除依赖关系
- **广播通信**：支持一对多的通信机制
- **开放封闭**：符合开放-封闭原则，易于扩展

**适用场景**
- 当一个抽象模型有两个方面，其中一个方面依赖于另一个方面
- 当对一个对象的改变需要同时改变其他对象，而不知道具体有多少对象需要改变
- 当一个对象必须通知其他对象，而又不能假定其他对象是谁
- 需要实现事件驱动架构的系统

#### 核心概念
- **观察者**：定义对象间一对多的依赖关系
- **主题**：被观察的对象
- **通知机制**：主题状态改变时通知所有观察者
- **发布-订阅**：观察者模式的另一种称呼

#### 参与者概念
- **主题接口**：定义注册、删除和通知观察者的接口
- **具体主题**：实现主题接口，维护观察者列表
- **观察者接口**：定义更新接口
- **具体观察者**：实现观察者接口

#### 实现概念
- **推模型**：主题主动推送信息给观察者
- **拉模型**：观察者主动从主题拉取信息
- **事件委托**：基于事件的观察者实现

### 8. 状态模式 (State)

**定义**：允许一个对象在其内部状态改变时改变它的行为。对象看起来似乎修改了它的类。

**GoF原定义**："Allow an object to alter its behavior when its internal state changes. The object will appear to change its class."

**核心思想**
- 将状态相关的行为封装在独立的状态类中
- 通过状态对象的切换来改变对象的行为
- 消除复杂的条件分支语句
- 使状态转换更加明确和可控

**基础例子：自动售货机状态管理**

```java
// 抽象状态类
abstract class VendingMachineState {
    protected VendingMachine vendingMachine;
    
    public VendingMachineState(VendingMachine vendingMachine) {
        this.vendingMachine = vendingMachine;
    }
    
    public abstract void insertCoin();
    public abstract void selectProduct();
    public abstract void dispenseProduct();
    public abstract void refund();
    
    public String getStateName() {
        return this.getClass().getSimpleName();
    }
}

// 具体状态 - 等待投币状态
class WaitingForCoinState extends VendingMachineState {
    public WaitingForCoinState(VendingMachine vendingMachine) {
        super(vendingMachine);
    }
    
    @Override
    public void insertCoin() {
        System.out.println("投币成功，请选择商品");
        vendingMachine.setState(vendingMachine.getWaitingForSelectionState());
    }
    
    @Override
    public void selectProduct() {
        System.out.println("请先投币");
    }
    
    @Override
    public void dispenseProduct() {
        System.out.println("请先投币并选择商品");
    }
    
    @Override
    public void refund() {
        System.out.println("没有可退还的硬币");
    }
}

// 具体状态 - 等待选择商品状态
class WaitingForSelectionState extends VendingMachineState {
    public WaitingForSelectionState(VendingMachine vendingMachine) {
        super(vendingMachine);
    }
    
    @Override
    public void insertCoin() {
        System.out.println("已经投币，请选择商品");
    }
    
    @Override
    public void selectProduct() {
        System.out.println("商品已选择，正在出货...");
        vendingMachine.setState(vendingMachine.getDispensingState());
        vendingMachine.dispenseProduct();
    }
    
    @Override
    public void dispenseProduct() {
        System.out.println("请先选择商品");
    }
    
    @Override
    public void refund() {
        System.out.println("退币成功");
        vendingMachine.setState(vendingMachine.getWaitingForCoinState());
    }
}

// 具体状态 - 出货状态
class DispensingState extends VendingMachineState {
    public DispensingState(VendingMachine vendingMachine) {
        super(vendingMachine);
    }
    
    @Override
    public void insertCoin() {
        System.out.println("正在出货，请稍候");
    }
    
    @Override
    public void selectProduct() {
        System.out.println("正在出货，请稍候");
    }
    
    @Override
    public void dispenseProduct() {
        System.out.println("商品已出货，交易完成");
        vendingMachine.setState(vendingMachine.getWaitingForCoinState());
    }
    
    @Override
    public void refund() {
        System.out.println("正在出货，无法退币");
    }
}

// 具体状态 - 售罄状态
class SoldOutState extends VendingMachineState {
    public SoldOutState(VendingMachine vendingMachine) {
        super(vendingMachine);
    }
    
    @Override
    public void insertCoin() {
        System.out.println("商品已售罄，无法投币");
    }
    
    @Override
    public void selectProduct() {
        System.out.println("商品已售罄");
    }
    
    @Override
    public void dispenseProduct() {
        System.out.println("商品已售罄");
    }
    
    @Override
    public void refund() {
        System.out.println("没有可退还的硬币");
    }
}

// 上下文类 - 自动售货机
class VendingMachine {
    private VendingMachineState waitingForCoinState;
    private VendingMachineState waitingForSelectionState;
    private VendingMachineState dispensingState;
    private VendingMachineState soldOutState;
    
    private VendingMachineState currentState;
    private int productCount;
    
    public VendingMachine(int productCount) {
        this.productCount = productCount;
        
        // 初始化所有状态
        waitingForCoinState = new WaitingForCoinState(this);
        waitingForSelectionState = new WaitingForSelectionState(this);
        dispensingState = new DispensingState(this);
        soldOutState = new SoldOutState(this);
        
        // 设置初始状态
        if (productCount > 0) {
            currentState = waitingForCoinState;
        } else {
            currentState = soldOutState;
        }
    }
    
    // 状态转换方法
    public void setState(VendingMachineState state) {
        System.out.println("状态转换: " + currentState.getStateName() + " -> " + state.getStateName());
        this.currentState = state;
    }
    
    // 委托给当前状态的方法
    public void insertCoin() {
        currentState.insertCoin();
    }
    
    public void selectProduct() {
        currentState.selectProduct();
    }
    
    public void dispenseProduct() {
        currentState.dispenseProduct();
        if (productCount > 0) {
            productCount--;
            if (productCount == 0) {
                setState(soldOutState);
            }
        }
    }
    
    public void refund() {
        currentState.refund();
    }
    
    // 状态获取方法
    public VendingMachineState getWaitingForCoinState() { return waitingForCoinState; }
    public VendingMachineState getWaitingForSelectionState() { return waitingForSelectionState; }
    public VendingMachineState getDispensingState() { return dispensingState; }
    public VendingMachineState getSoldOutState() { return soldOutState; }
    
    public void printStatus() {
        System.out.println("售货机状态: " + currentState.getStateName() + ", 剩余商品: " + productCount);
    }
}

// 客户端使用
public class VendingMachineDemo {
    public static void main(String[] args) {
        System.out.println("=== 自动售货机状态管理演示 ===\n");
        
        VendingMachine machine = new VendingMachine(2);
        machine.printStatus();
        
        System.out.println("\n=== 第一次购买 ===");
        machine.selectProduct(); // 未投币
        machine.insertCoin();    // 投币
        machine.insertCoin();    // 重复投币
        machine.selectProduct(); // 选择商品
        machine.printStatus();
        
        System.out.println("\n=== 第二次购买 ===");
        machine.insertCoin();    // 投币
        machine.refund();        // 退币
        machine.insertCoin();    // 重新投币
        machine.selectProduct(); // 选择商品
        machine.printStatus();
        
        System.out.println("\n=== 商品售罄后的操作 ===");
        machine.insertCoin();    // 尝试投币
        machine.selectProduct(); // 尝试选择商品
        machine.printStatus();
    }
}
```

**进阶例子：企业级订单状态管理系统**

```java
// 订单数据类
class OrderData {
    private String orderId;
    private String customerId;
    private double amount;
    private List<String> items;
    private Date createdTime;
    private Date lastModifiedTime;
    private String paymentMethod;
    private String shippingAddress;
    
    public OrderData(String orderId, String customerId, double amount, List<String> items) {
        this.orderId = orderId;
        this.customerId = customerId;
        this.amount = amount;
        this.items = new ArrayList<>(items);
        this.createdTime = new Date();
        this.lastModifiedTime = new Date();
    }
    
    // Getters and setters
    public String getOrderId() { return orderId; }
    public String getCustomerId() { return customerId; }
    public double getAmount() { return amount; }
    public List<String> getItems() { return new ArrayList<>(items); }
    public Date getCreatedTime() { return createdTime; }
    public Date getLastModifiedTime() { return lastModifiedTime; }
    public String getPaymentMethod() { return paymentMethod; }
    public void setPaymentMethod(String paymentMethod) { 
        this.paymentMethod = paymentMethod;
        updateLastModifiedTime();
    }
    public String getShippingAddress() { return shippingAddress; }
    public void setShippingAddress(String shippingAddress) { 
        this.shippingAddress = shippingAddress;
        updateLastModifiedTime();
    }
    
    private void updateLastModifiedTime() {
        this.lastModifiedTime = new Date();
    }
    
    @Override
    public String toString() {
        return String.format("Order{id='%s', customer='%s', amount=%.2f, items=%d}", 
                           orderId, customerId, amount, items.size());
    }
}

// 状态转换结果
class StateTransitionResult {
    private boolean success;
    private String message;
    private String newStateName;
    
    public StateTransitionResult(boolean success, String message, String newStateName) {
        this.success = success;
        this.message = message;
        this.newStateName = newStateName;
    }
    
    public boolean isSuccess() { return success; }
    public String getMessage() { return message; }
    public String getNewStateName() { return newStateName; }
    
    public static StateTransitionResult success(String message, String newStateName) {
        return new StateTransitionResult(true, message, newStateName);
    }
    
    public static StateTransitionResult failure(String message) {
        return new StateTransitionResult(false, message, null);
    }
}

// 抽象订单状态
abstract class OrderState {
    protected Order order;
    protected String stateName;
    
    public OrderState(Order order, String stateName) {
        this.order = order;
        this.stateName = stateName;
    }
    
    // 状态转换方法
    public abstract StateTransitionResult pay(String paymentMethod);
    public abstract StateTransitionResult cancel(String reason);
    public abstract StateTransitionResult ship(String trackingNumber);
    public abstract StateTransitionResult deliver();
    public abstract StateTransitionResult returnOrder(String reason);
    public abstract StateTransitionResult refund();
    
    // 状态查询方法
    public abstract boolean canModify();
    public abstract boolean canCancel();
    public abstract boolean canRefund();
    
    public String getStateName() { return stateName; }
    
    protected void logStateTransition(String action, String result) {
        System.out.println(String.format("[%s] %s: %s -> %s", 
                                        order.getOrderData().getOrderId(), 
                                        action, stateName, result));
    }
}

// 具体状态 - 待支付状态
class PendingPaymentState extends OrderState {
    public PendingPaymentState(Order order) {
        super(order, "待支付");
    }
    
    @Override
    public StateTransitionResult pay(String paymentMethod) {
        order.getOrderData().setPaymentMethod(paymentMethod);
        logStateTransition("支付", "已支付");
        order.setState(order.getPaidState());
        return StateTransitionResult.success("支付成功，订单已确认", "已支付");
    }
    
    @Override
    public StateTransitionResult cancel(String reason) {
        logStateTransition("取消", "已取消");
        order.setState(order.getCancelledState());
        return StateTransitionResult.success("订单已取消: " + reason, "已取消");
    }
    
    @Override
    public StateTransitionResult ship(String trackingNumber) {
        return StateTransitionResult.failure("订单未支付，无法发货");
    }
    
    @Override
    public StateTransitionResult deliver() {
        return StateTransitionResult.failure("订单未支付，无法确认收货");
    }
    
    @Override
    public StateTransitionResult returnOrder(String reason) {
        return StateTransitionResult.failure("订单未支付，无法退货");
    }
    
    @Override
    public StateTransitionResult refund() {
        return StateTransitionResult.failure("订单未支付，无需退款");
    }
    
    @Override
    public boolean canModify() { return true; }
    @Override
    public boolean canCancel() { return true; }
    @Override
    public boolean canRefund() { return false; }
}

// 具体状态 - 已支付状态
class PaidState extends OrderState {
    public PaidState(Order order) {
        super(order, "已支付");
    }
    
    @Override
    public StateTransitionResult pay(String paymentMethod) {
        return StateTransitionResult.failure("订单已支付");
    }
    
    @Override
    public StateTransitionResult cancel(String reason) {
        logStateTransition("取消", "已取消");
        order.setState(order.getCancelledState());
        return StateTransitionResult.success("订单已取消，将自动退款: " + reason, "已取消");
    }
    
    @Override
    public StateTransitionResult ship(String trackingNumber) {
        logStateTransition("发货", "已发货");
        order.setState(order.getShippedState());
        return StateTransitionResult.success("订单已发货，快递单号: " + trackingNumber, "已发货");
    }
    
    @Override
    public StateTransitionResult deliver() {
        return StateTransitionResult.failure("订单未发货，无法确认收货");
    }
    
    @Override
    public StateTransitionResult returnOrder(String reason) {
        return StateTransitionResult.failure("订单未发货，无法退货");
    }
    
    @Override
    public StateTransitionResult refund() {
        logStateTransition("退款", "已退款");
        order.setState(order.getRefundedState());
        return StateTransitionResult.success("退款成功", "已退款");
    }
    
    @Override
    public boolean canModify() { return false; }
    @Override
    public boolean canCancel() { return true; }
    @Override
    public boolean canRefund() { return true; }
}

// 具体状态 - 已发货状态
class ShippedState extends OrderState {
    public ShippedState(Order order) {
        super(order, "已发货");
    }
    
    @Override
    public StateTransitionResult pay(String paymentMethod) {
        return StateTransitionResult.failure("订单已支付");
    }
    
    @Override
    public StateTransitionResult cancel(String reason) {
        return StateTransitionResult.failure("订单已发货，无法取消");
    }
    
    @Override
    public StateTransitionResult ship(String trackingNumber) {
        return StateTransitionResult.failure("订单已发货");
    }
    
    @Override
    public StateTransitionResult deliver() {
        logStateTransition("确认收货", "已完成");
        order.setState(order.getDeliveredState());
        return StateTransitionResult.success("订单已完成", "已完成");
    }
    
    @Override
    public StateTransitionResult returnOrder(String reason) {
        logStateTransition("退货", "退货中");
        order.setState(order.getReturningState());
        return StateTransitionResult.success("退货申请已提交: " + reason, "退货中");
    }
    
    @Override
    public StateTransitionResult refund() {
        return StateTransitionResult.failure("订单已发货，请先申请退货");
    }
    
    @Override
    public boolean canModify() { return false; }
    @Override
    public boolean canCancel() { return false; }
    @Override
    public boolean canRefund() { return false; }
}

// 具体状态 - 已完成状态
class DeliveredState extends OrderState {
    public DeliveredState(Order order) {
        super(order, "已完成");
    }
    
    @Override
    public StateTransitionResult pay(String paymentMethod) {
        return StateTransitionResult.failure("订单已完成");
    }
    
    @Override
    public StateTransitionResult cancel(String reason) {
        return StateTransitionResult.failure("订单已完成，无法取消");
    }
    
    @Override
    public StateTransitionResult ship(String trackingNumber) {
        return StateTransitionResult.failure("订单已完成");
    }
    
    @Override
    public StateTransitionResult deliver() {
        return StateTransitionResult.failure("订单已完成");
    }
    
    @Override
    public StateTransitionResult returnOrder(String reason) {
        // 检查是否在退货期限内（简化逻辑：7天内可退货）
        long daysSinceDelivery = (System.currentTimeMillis() - order.getOrderData().getLastModifiedTime().getTime()) / (1000 * 60 * 60 * 24);
        if (daysSinceDelivery <= 7) {
            logStateTransition("退货", "退货中");
            order.setState(order.getReturningState());
            return StateTransitionResult.success("退货申请已提交: " + reason, "退货中");
        } else {
            return StateTransitionResult.failure("超过退货期限（7天）");
        }
    }
    
    @Override
    public StateTransitionResult refund() {
        return StateTransitionResult.failure("订单已完成，如需退款请先申请退货");
    }
    
    @Override
    public boolean canModify() { return false; }
    @Override
    public boolean canCancel() { return false; }
    @Override
    public boolean canRefund() { return false; }
}

// 具体状态 - 已取消状态
class CancelledState extends OrderState {
    public CancelledState(Order order) {
        super(order, "已取消");
    }
    
    @Override
    public StateTransitionResult pay(String paymentMethod) {
        return StateTransitionResult.failure("订单已取消");
    }
    
    @Override
    public StateTransitionResult cancel(String reason) {
        return StateTransitionResult.failure("订单已取消");
    }
    
    @Override
    public StateTransitionResult ship(String trackingNumber) {
        return StateTransitionResult.failure("订单已取消");
    }
    
    @Override
    public StateTransitionResult deliver() {
        return StateTransitionResult.failure("订单已取消");
    }
    
    @Override
    public StateTransitionResult returnOrder(String reason) {
        return StateTransitionResult.failure("订单已取消");
    }
    
    @Override
    public StateTransitionResult refund() {
        return StateTransitionResult.failure("订单已取消");
    }
    
    @Override
    public boolean canModify() { return false; }
    @Override
    public boolean canCancel() { return false; }
    @Override
    public boolean canRefund() { return false; }
}

// 具体状态 - 退货中状态
class ReturningState extends OrderState {
    public ReturningState(Order order) {
        super(order, "退货中");
    }
    
    @Override
    public StateTransitionResult pay(String paymentMethod) {
        return StateTransitionResult.failure("订单退货中");
    }
    
    @Override
    public StateTransitionResult cancel(String reason) {
        return StateTransitionResult.failure("订单退货中，无法取消");
    }
    
    @Override
    public StateTransitionResult ship(String trackingNumber) {
        return StateTransitionResult.failure("订单退货中");
    }
    
    @Override
    public StateTransitionResult deliver() {
        return StateTransitionResult.failure("订单退货中");
    }
    
    @Override
    public StateTransitionResult returnOrder(String reason) {
        return StateTransitionResult.failure("订单已在退货中");
    }
    
    @Override
    public StateTransitionResult refund() {
        logStateTransition("退款", "已退款");
        order.setState(order.getRefundedState());
        return StateTransitionResult.success("退货完成，退款成功", "已退款");
    }
    
    @Override
    public boolean canModify() { return false; }
    @Override
    public boolean canCancel() { return false; }
    @Override
    public boolean canRefund() { return true; }
}

// 具体状态 - 已退款状态
class RefundedState extends OrderState {
    public RefundedState(Order order) {
        super(order, "已退款");
    }
    
    @Override
    public StateTransitionResult pay(String paymentMethod) {
        return StateTransitionResult.failure("订单已退款");
    }
    
    @Override
    public StateTransitionResult cancel(String reason) {
        return StateTransitionResult.failure("订单已退款");
    }
    
    @Override
    public StateTransitionResult ship(String trackingNumber) {
        return StateTransitionResult.failure("订单已退款");
    }
    
    @Override
    public StateTransitionResult deliver() {
        return StateTransitionResult.failure("订单已退款");
    }
    
    @Override
    public StateTransitionResult returnOrder(String reason) {
        return StateTransitionResult.failure("订单已退款");
    }
    
    @Override
    public StateTransitionResult refund() {
        return StateTransitionResult.failure("订单已退款");
    }
    
    @Override
    public boolean canModify() { return false; }
    @Override
    public boolean canCancel() { return false; }
    @Override
    public boolean canRefund() { return false; }
}

// 上下文类 - 订单
class Order {
    private OrderData orderData;
    private OrderState currentState;
    
    // 所有可能的状态
    private OrderState pendingPaymentState;
    private OrderState paidState;
    private OrderState shippedState;
    private OrderState deliveredState;
    private OrderState cancelledState;
    private OrderState returningState;
    private OrderState refundedState;
    
    public Order(String orderId, String customerId, double amount, List<String> items) {
        this.orderData = new OrderData(orderId, customerId, amount, items);
        
        // 初始化所有状态
        this.pendingPaymentState = new PendingPaymentState(this);
        this.paidState = new PaidState(this);
        this.shippedState = new ShippedState(this);
        this.deliveredState = new DeliveredState(this);
        this.cancelledState = new CancelledState(this);
        this.returningState = new ReturningState(this);
        this.refundedState = new RefundedState(this);
        
        // 设置初始状态
        this.currentState = pendingPaymentState;
        System.out.println("订单创建: " + orderData + " - 状态: " + currentState.getStateName());
    }
    
    // 状态转换方法
    public void setState(OrderState state) {
        this.currentState = state;
    }
    
    // 委托给当前状态的方法
    public StateTransitionResult pay(String paymentMethod) {
        return currentState.pay(paymentMethod);
    }
    
    public StateTransitionResult cancel(String reason) {
        return currentState.cancel(reason);
    }
    
    public StateTransitionResult ship(String trackingNumber) {
        return currentState.ship(trackingNumber);
    }
    
    public StateTransitionResult deliver() {
        return currentState.deliver();
    }
    
    public StateTransitionResult returnOrder(String reason) {
        return currentState.returnOrder(reason);
    }
    
    public StateTransitionResult refund() {
        return currentState.refund();
    }
    
    // 状态查询方法
    public boolean canModify() { return currentState.canModify(); }
    public boolean canCancel() { return currentState.canCancel(); }
    public boolean canRefund() { return currentState.canRefund(); }
    
    // 状态获取方法
    public OrderState getPendingPaymentState() { return pendingPaymentState; }
    public OrderState getPaidState() { return paidState; }
    public OrderState getShippedState() { return shippedState; }
    public OrderState getDeliveredState() { return deliveredState; }
    public OrderState getCancelledState() { return cancelledState; }
    public OrderState getReturningState() { return returningState; }
    public OrderState getRefundedState() { return refundedState; }
    
    public OrderData getOrderData() { return orderData; }
    public String getCurrentStateName() { return currentState.getStateName(); }
    
    public void printOrderInfo() {
        System.out.println("\n=== 订单信息 ===");
        System.out.println("订单号: " + orderData.getOrderId());
        System.out.println("客户ID: " + orderData.getCustomerId());
        System.out.println("订单金额: $" + orderData.getAmount());
        System.out.println("商品数量: " + orderData.getItems().size());
        System.out.println("当前状态: " + currentState.getStateName());
        System.out.println("可修改: " + (canModify() ? "是" : "否"));
        System.out.println("可取消: " + (canCancel() ? "是" : "否"));
        System.out.println("可退款: " + (canRefund() ? "是" : "否"));
        System.out.println("创建时间: " + orderData.getCreatedTime());
        System.out.println("最后修改: " + orderData.getLastModifiedTime());
    }
}

// 订单管理服务
class OrderManagementService {
    private Map<String, Order> orders = new HashMap<>();
    
    public Order createOrder(String orderId, String customerId, double amount, List<String> items) {
        Order order = new Order(orderId, customerId, amount, items);
        orders.put(orderId, order);
        return order;
    }
    
    public Order getOrder(String orderId) {
        return orders.get(orderId);
    }
    
    public StateTransitionResult processPayment(String orderId, String paymentMethod) {
        Order order = orders.get(orderId);
        if (order != null) {
            return order.pay(paymentMethod);
        }
        return StateTransitionResult.failure("订单不存在");
    }
    
    public StateTransitionResult shipOrder(String orderId, String trackingNumber) {
        Order order = orders.get(orderId);
        if (order != null) {
            return order.ship(trackingNumber);
        }
        return StateTransitionResult.failure("订单不存在");
    }
    
    public StateTransitionResult deliverOrder(String orderId) {
        Order order = orders.get(orderId);
        if (order != null) {
            return order.deliver();
        }
        return StateTransitionResult.failure("订单不存在");
    }
    
    public StateTransitionResult cancelOrder(String orderId, String reason) {
        Order order = orders.get(orderId);
        if (order != null) {
            return order.cancel(reason);
        }
        return StateTransitionResult.failure("订单不存在");
    }
    
    public StateTransitionResult returnOrder(String orderId, String reason) {
        Order order = orders.get(orderId);
        if (order != null) {
            return order.returnOrder(reason);
        }
        return StateTransitionResult.failure("订单不存在");
    }
    
    public StateTransitionResult refundOrder(String orderId) {
        Order order = orders.get(orderId);
        if (order != null) {
            return order.refund();
        }
        return StateTransitionResult.failure("订单不存在");
    }
    
    public void printAllOrders() {
        System.out.println("\n=== 所有订单状态 ===");
        orders.forEach((orderId, order) -> {
            System.out.println(orderId + ": " + order.getCurrentStateName());
        });
    }
}

// 企业级订单状态管理演示
public class EnterpriseOrderStateDemo {
    public static void main(String[] args) throws InterruptedException {
        System.out.println("=== 企业级订单状态管理系统演示 ===\n");
        
        OrderManagementService orderService = new OrderManagementService();
        
        // 创建订单
        List<String> items = Arrays.asList("笔记本电脑", "鼠标", "键盘");
        Order order1 = orderService.createOrder("ORDER-001", "CUSTOMER-001", 1299.99, items);
        
        Order order2 = orderService.createOrder("ORDER-002", "CUSTOMER-002", 599.99, 
                                               Arrays.asList("手机", "手机壳"));
        
        // 正常订单流程
        System.out.println("\n=== 订单1正常流程 ===");
        executeAndPrint(orderService.processPayment("ORDER-001", "信用卡"));
        order1.printOrderInfo();
        
        Thread.sleep(100);
        executeAndPrint(orderService.shipOrder("ORDER-001", "SF123456789"));
        order1.printOrderInfo();
        
        Thread.sleep(100);
        executeAndPrint(orderService.deliverOrder("ORDER-001"));
        order1.printOrderInfo();
        
        // 订单2取消流程
        System.out.println("\n=== 订单2取消流程 ===");
        executeAndPrint(orderService.processPayment("ORDER-002", "支付宝"));
        executeAndPrint(orderService.cancelOrder("ORDER-002", "客户主动取消"));
        order2.printOrderInfo();
        
        // 创建订单3进行退货流程
        System.out.println("\n=== 订单3退货流程 ===");
        Order order3 = orderService.createOrder("ORDER-003", "CUSTOMER-003", 299.99, 
                                               Arrays.asList("耳机"));
        executeAndPrint(orderService.processPayment("ORDER-003", "微信支付"));
        executeAndPrint(orderService.shipOrder("ORDER-003", "YTO987654321"));
        executeAndPrint(orderService.deliverOrder("ORDER-003"));
        executeAndPrint(orderService.returnOrder("ORDER-003", "商品质量问题"));
        executeAndPrint(orderService.refundOrder("ORDER-003"));
        order3.printOrderInfo();
        
        // 测试无效操作
        System.out.println("\n=== 测试无效操作 ===");
        executeAndPrint(orderService.processPayment("ORDER-001", "现金")); // 已完成的订单
        executeAndPrint(orderService.shipOrder("ORDER-002", "TEST123")); // 已取消的订单
        executeAndPrint(orderService.returnOrder("ORDER-003", "再次退货")); // 已退款的订单
        
        orderService.printAllOrders();
        
        System.out.println("\n=== 状态模式优势 ===");
        System.out.println("- 消除条件分支: 避免复杂的if-else或switch语句");
        System.out.println("- 状态封装: 每个状态的行为被封装在独立的类中");
        System.out.println("- 易于扩展: 添加新状态不影响现有代码");
        System.out.println("- 状态转换清晰: 状态转换逻辑明确可控");
        System.out.println("- 符合开闭原则: 对扩展开放，对修改封闭");
    }
    
    private static void executeAndPrint(StateTransitionResult result) {
        if (result.isSuccess()) {
            System.out.println("✓ " + result.getMessage());
        } else {
            System.out.println("✗ " + result.getMessage());
        }
    }
}
```

**模式优势**
- **消除条件分支**：避免复杂的if-else或switch语句
- **状态封装**：每个状态的行为被封装在独立的类中
- **易于扩展**：添加新状态不影响现有代码
- **状态转换清晰**：状态转换逻辑明确可控

**适用场景**
- 对象的行为依赖于它的状态，并且必须在运行时根据状态改变行为
- 代码中包含大量与状态相关的条件语句
- 状态转换逻辑复杂，需要明确的状态管理
- 需要避免重复的状态检查代码
# 设计模式完整概念汇总

## 第一部分：基础理论概念

### 1. 设计模式基本概念

#### 1.1 核心定义

##### 设计模式 (Design Pattern)
- **GoF原定义**：*"设计模式是在特定环境下人们解决某类重复出现问题的一套成功或有效的解决方案。"*
- **扩展定义**：在特定环境下，为解决某一通用软件设计问题提供的一套定制的解决方案
- **本质**：可复用的面向对象软件设计经验

#### 基础例子：日常生活中的模式
```
建筑设计模式：
- 问题：如何设计一个既美观又实用的房屋入口？
- 解决方案：门廊模式 - 在主入口前设置一个有顶棚的过渡空间
- 效果：提供遮风挡雨的缓冲区，增加建筑美感

软件设计模式：
- 问题：如何确保一个类只有一个实例？
- 解决方案：单例模式 - 控制类的实例化过程
- 效果：节省内存，保证全局唯一性
```

#### 进阶例子：企业级应用中的模式思维
```java
// 传统方式 - 没有模式思维
public class OrderProcessor {
    public void processOrder(Order order) {
        // 验证订单
        if (order.getItems().isEmpty()) {
            throw new IllegalArgumentException("订单不能为空");
        }
        
        // 计算价格
        double total = 0;
        for (OrderItem item : order.getItems()) {
            total += item.getPrice() * item.getQuantity();
        }
        
        // 发送邮件
        EmailService emailService = new EmailService();
        emailService.sendOrderConfirmation(order.getCustomerEmail(), order);
        
        // 更新库存
        InventoryService inventoryService = new InventoryService();
        inventoryService.updateStock(order.getItems());
        
        // 记录日志
        System.out.println("订单处理完成: " + order.getId());
    }
}

// 使用模式思维重构
public class OrderProcessor {
    private List<OrderValidator> validators;
    private PricingStrategy pricingStrategy;
    private List<OrderEventListener> eventListeners;
    
    public OrderProcessor() {
        // 责任链模式 - 验证器链
        this.validators = Arrays.asList(
            new EmptyOrderValidator(),
            new CustomerValidator(),
            new InventoryValidator()
        );
        
        // 策略模式 - 定价策略
        this.pricingStrategy = new StandardPricingStrategy();
        
        // 观察者模式 - 事件监听器
        this.eventListeners = Arrays.asList(
            new EmailNotificationListener(),
            new InventoryUpdateListener(),
            new LoggingListener()
        );
    }
    
    public void processOrder(Order order) {
        // 使用责任链验证
        for (OrderValidator validator : validators) {
            validator.validate(order);
        }
        
        // 使用策略计算价格
        double total = pricingStrategy.calculateTotal(order);
        order.setTotal(total);
        
        // 使用观察者通知各个服务
        OrderProcessedEvent event = new OrderProcessedEvent(order);
        eventListeners.forEach(listener -> listener.onOrderProcessed(event));
    }
}
```

##### 模式语言 (Pattern Language)
- **Alexander原定义**：*"每个模式描述了一个在我们周围不断重复发生的问题，以及该问题的解决方案的核心。"*
- **软件领域定义**：描述设计问题、解决方案和效果的标准化语言
- **作用**：为设计者提供共同的词汇和交流方式

##### 可复用性 (Reusability)
- **定义**：模式可以在不同的软件系统中重复使用
- **层次**：设计复用比代码复用更高层次
- **价值**：避免重新发明轮子，提高开发效率

##### 最佳实践 (Best Practice)
- **定义**：经过验证的、优秀的设计经验总结
- **特征**：经过时间检验，被广泛认可和应用
- **来源**：专家经验的结晶和总结

#### 1.2 模式要素
- **模式名称**：简洁描述设计问题、解决方案和效果的词汇
- **问题**：描述何时使用该模式，包括设计问题和问题的前因后果
- **解决方案**：描述设计的组成成分、关系、职责和协作方式
- **效果**：使用模式的结果和权衡，包括对灵活性、扩展性的影响

#### 1.3 模式分类
- **创建型模式**：处理对象创建机制，将对象的创建和使用分离
- **结构型模式**：处理对象和类的组合，形成更大的结构
- **行为型模式**：处理对象间的通信和职责分配

### 2. UML建模概念

#### 2.1 类图概念
- **类**：具有相同属性和方法的对象集合的抽象
- **属性**：类的数据成员，描述对象的状态
- **方法**：类的函数成员，描述对象的行为
- **访问修饰符**：控制类成员的可见性（public、private、protected、package）
- **静态成员**：属于类而不是实例的成员
- **抽象类**：不能实例化的类，通常包含抽象方法
- **接口**：定义类必须实现的方法契约

#### 2.2 类间关系概念
- **继承/泛化**：子类继承父类的属性和方法，is-a关系
- **实现**：类实现接口定义的方法契约
- **依赖**：一个类使用另一个类，临时性的uses-a关系
- **关联**：类之间的结构化关系，长期性的has-a关系
- **聚合**：整体-部分关系，部分可以独立于整体存在
- **组合**：强整体-部分关系，部分不能独立于整体存在
- **多重性**：关系中对象的数量约束

#### 2.3 动态图概念
- **时序图**：按时间顺序显示对象间的交互
- **协作图**：强调对象间的组织结构和消息传递
- **状态图**：描述对象在生命周期内的状态变化
- **活动图**：描述系统的工作流程和业务过程

### 3. 面向对象设计原则概念

#### 3.1 SOLID原则
- **单一职责原则(SRP)**：一个类应该只有一个引起变化的原因
- **开放-封闭原则(OCP)**：对扩展开放，对修改封闭
- **里氏替换原则(LSP)**：子类对象应该能够替换父类对象
- **接口隔离原则(ISP)**：客户端不应该依赖不需要的接口
- **依赖倒置原则(DIP)**：依赖于抽象，而不是具体实现

#### 3.2 其他重要原则
- **迪米特法则(LoD)**：一个对象应该对其他对象有最少的了解
- **合成/聚合复用原则(CARP)**：优先使用组合而不是继承来实现复用

## 第二部分：创建型模式概念

### 1. 单例模式 (Singleton)

#### 核心概念
- **单例**：确保一个类只有一个实例，并提供全局访问点
- **实例控制**：控制类的实例化过程
- **全局访问**：提供访问唯一实例的全局方法
- **延迟初始化**：在需要时才创建实例

#### 基础例子：简单的配置管理器
```java
// 饿汉式单例 - 最简单的实现
public class ConfigManager {
    // 类加载时就创建实例
    private static final ConfigManager INSTANCE = new ConfigManager();
    private Properties config;
    
    // 私有构造函数，防止外部实例化
    private ConfigManager() {
        config = new Properties();
        loadConfig();
    }
    
    // 提供全局访问点
    public static ConfigManager getInstance() {
        return INSTANCE;
    }
    
    private void loadConfig() {
        // 加载配置文件
        config.setProperty("database.url", "jdbc:mysql://localhost:3306/mydb");
        config.setProperty("database.username", "root");
        config.setProperty("cache.size", "1000");
    }
    
    public String getProperty(String key) {
        return config.getProperty(key);
    }
    
    public void setProperty(String key, String value) {
        config.setProperty(key, value);
    }
}

// 使用示例
public class Application {
    public static void main(String[] args) {
        // 获取配置管理器实例
        ConfigManager config1 = ConfigManager.getInstance();
        ConfigManager config2 = ConfigManager.getInstance();
        
        // 验证是同一个实例
        System.out.println("是否为同一实例: " + (config1 == config2)); // true
        
        // 使用配置
        String dbUrl = config1.getProperty("database.url");
        System.out.println("数据库URL: " + dbUrl);
        
        // 修改配置
        config1.setProperty("app.name", "MyApplication");
        String appName = config2.getProperty("app.name");
        System.out.println("应用名称: " + appName); // MyApplication
    }
}
```

#### 进阶例子：线程安全的数据库连接池
```java
import java.sql.*;
import java.util.concurrent.BlockingQueue;
import java.util.concurrent.LinkedBlockingQueue;
import java.util.concurrent.atomic.AtomicInteger;

// 双重检查锁定的懒汉式单例
public class DatabaseConnectionPool {
    // 使用volatile确保多线程环境下的可见性
    private static volatile DatabaseConnectionPool instance;
    
    private final BlockingQueue<Connection> connectionPool;
    private final AtomicInteger currentConnections;
    private final int maxConnections;
    private final String jdbcUrl;
    private final String username;
    private final String password;
    
    // 私有构造函数
    private DatabaseConnectionPool() {
        this.maxConnections = 10;
        this.currentConnections = new AtomicInteger(0);
        this.connectionPool = new LinkedBlockingQueue<>(maxConnections);
        this.jdbcUrl = "jdbc:mysql://localhost:3306/mydb";
        this.username = "root";
        this.password = "password";
        
        // 初始化连接池
        initializePool();
    }
    
    // 双重检查锁定获取实例
    public static DatabaseConnectionPool getInstance() {
        if (instance == null) {
            synchronized (DatabaseConnectionPool.class) {
                if (instance == null) {
                    instance = new DatabaseConnectionPool();
                }
            }
        }
        return instance;
    }
    
    private void initializePool() {
        try {
            // 预创建一些连接
            for (int i = 0; i < 3; i++) {
                Connection conn = createConnection();
                if (conn != null) {
                    connectionPool.offer(conn);
                    currentConnections.incrementAndGet();
                }
            }
        } catch (SQLException e) {
            System.err.println("初始化连接池失败: " + e.getMessage());
        }
    }
    
    private Connection createConnection() throws SQLException {
        return DriverManager.getConnection(jdbcUrl, username, password);
    }
    
    // 获取连接
    public Connection getConnection() throws SQLException, InterruptedException {
        Connection conn = connectionPool.poll();
        
        if (conn == null && currentConnections.get() < maxConnections) {
            // 如果池中没有连接且未达到最大连接数，创建新连接
            synchronized (this) {
                if (currentConnections.get() < maxConnections) {
                    conn = createConnection();
                    currentConnections.incrementAndGet();
                }
            }
        }
        
        if (conn == null) {
            // 等待可用连接
            conn = connectionPool.take();
        }
        
        return conn;
    }
    
    // 归还连接
    public void returnConnection(Connection conn) {
        if (conn != null) {
            try {
                if (!conn.isClosed()) {
                    connectionPool.offer(conn);
                } else {
                    currentConnections.decrementAndGet();
                }
            } catch (SQLException e) {
                System.err.println("检查连接状态失败: " + e.getMessage());
                currentConnections.decrementAndGet();
            }
        }
    }
    
    // 关闭连接池
    public void shutdown() {
        while (!connectionPool.isEmpty()) {
            try {
                Connection conn = connectionPool.poll();
                if (conn != null && !conn.isClosed()) {
                    conn.close();
                }
            } catch (SQLException e) {
                System.err.println("关闭连接失败: " + e.getMessage());
            }
        }
        currentConnections.set(0);
    }
    
    // 获取连接池状态
    public String getPoolStatus() {
        return String.format("连接池状态 - 当前连接数: %d, 可用连接数: %d, 最大连接数: %d",
                currentConnections.get(), connectionPool.size(), maxConnections);
    }
    
    // 防止序列化破坏单例
    private Object readResolve() {
        return getInstance();
    }
}

// 静态内部类实现（推荐方式）
public class LogManager {
    // 静态内部类，只有在被引用时才会加载
    private static class LogManagerHolder {
        private static final LogManager INSTANCE = new LogManager();
    }
    
    private final String logLevel;
    private final String logFormat;
    
    private LogManager() {
        this.logLevel = "INFO";
        this.logFormat = "[%s] %s - %s";
    }
    
    public static LogManager getInstance() {
        return LogManagerHolder.INSTANCE;
    }
    
    public void log(String level, String message) {
        String timestamp = java.time.LocalDateTime.now().toString();
        String formattedMessage = String.format(logFormat, timestamp, level, message);
        System.out.println(formattedMessage);
    }
    
    public void info(String message) {
        log("INFO", message);
    }
    
    public void error(String message) {
        log("ERROR", message);
    }
    
    public void debug(String message) {
        if ("DEBUG".equals(logLevel)) {
            log("DEBUG", message);
        }
    }
}

// 枚举实现（最安全的方式）
public enum CacheManager {
    INSTANCE;
    
    private final Map<String, Object> cache;
    
    CacheManager() {
        this.cache = new ConcurrentHashMap<>();
    }
    
    public void put(String key, Object value) {
        cache.put(key, value);
    }
    
    public Object get(String key) {
        return cache.get(key);
    }
    
    public void remove(String key) {
        cache.remove(key);
    }
    
    public void clear() {
        cache.clear();
    }
    
    public int size() {
        return cache.size();
    }
}

// 多线程测试示例
public class SingletonTest {
    public static void main(String[] args) throws InterruptedException {
        // 测试数据库连接池单例
        testDatabaseConnectionPool();
        
        // 测试日志管理器单例
        testLogManager();
        
        // 测试缓存管理器单例
        testCacheManager();
    }
    
    private static void testDatabaseConnectionPool() throws InterruptedException {
        System.out.println("=== 测试数据库连接池单例 ===");
        
        // 创建多个线程同时获取实例
        Thread[] threads = new Thread[5];
        DatabaseConnectionPool[] instances = new DatabaseConnectionPool[5];
        
        for (int i = 0; i < 5; i++) {
            final int index = i;
            threads[i] = new Thread(() -> {
                instances[index] = DatabaseConnectionPool.getInstance();
                System.out.println("线程 " + index + " 获取实例: " + instances[index].hashCode());
            });
        }
        
        // 启动所有线程
        for (Thread thread : threads) {
            thread.start();
        }
        
        // 等待所有线程完成
        for (Thread thread : threads) {
            thread.join();
        }
        
        // 验证所有实例是否相同
        boolean allSame = true;
        for (int i = 1; i < instances.length; i++) {
            if (instances[i] != instances[0]) {
                allSame = false;
                break;
            }
        }
        
        System.out.println("所有实例是否相同: " + allSame);
        System.out.println(instances[0].getPoolStatus());
        System.out.println();
    }
    
    private static void testLogManager() {
        System.out.println("=== 测试日志管理器单例 ===");
        
        LogManager logger1 = LogManager.getInstance();
        LogManager logger2 = LogManager.getInstance();
        
        System.out.println("是否为同一实例: " + (logger1 == logger2));
        
        logger1.info("这是一条信息日志");
        logger2.error("这是一条错误日志");
        logger1.debug("这是一条调试日志");
        System.out.println();
    }
    
    private static void testCacheManager() {
        System.out.println("=== 测试缓存管理器单例 ===");
        
        CacheManager cache1 = CacheManager.INSTANCE;
        CacheManager cache2 = CacheManager.INSTANCE;
        
        System.out.println("是否为同一实例: " + (cache1 == cache2));
        
        cache1.put("user:1", "张三");
        cache1.put("user:2", "李四");
        
        System.out.println("缓存大小: " + cache2.size());
        System.out.println("用户1: " + cache2.get("user:1"));
        System.out.println("用户2: " + cache2.get("user:2"));
        System.out.println();
    }
}
```

#### 实现概念
- **饿汉式**：类加载时就创建实例
- **懒汉式**：第一次使用时才创建实例
- **双重检查锁定**：线程安全的懒汉式实现
- **静态内部类**：利用类加载机制保证线程安全
- **枚举实现**：最简洁的单例实现方式

#### 相关概念
- **线程安全**：多线程环境下的正确性
- **序列化安全**：序列化后不破坏单例特性
- **反射安全**：防止通过反射创建多个实例

### 2. 工厂方法模式 (Factory Method)

#### 核心概念
- **工厂方法**：定义创建对象的接口，让子类决定实例化哪个类
- **产品**：工厂创建的对象
- **创建者**：包含工厂方法的类
- **延迟实例化**：将对象创建延迟到子类

#### 基础例子：图形绘制工厂
```java
// 产品接口
interface Shape {
    void draw();
}

// 具体产品
class Circle implements Shape {
    @Override
    public void draw() {
        System.out.println("绘制圆形");
    }
}

class Rectangle implements Shape {
    @Override
    public void draw() {
        System.out.println("绘制矩形");
    }
}

// 抽象工厂
abstract class ShapeFactory {
    // 工厂方法
    public abstract Shape createShape();
    
    // 模板方法
    public void drawShape() {
        Shape shape = createShape();
        shape.draw();
    }
}

// 具体工厂
class CircleFactory extends ShapeFactory {
    @Override
    public Shape createShape() {
        return new Circle();
    }
}

class RectangleFactory extends ShapeFactory {
    @Override
    public Shape createShape() {
        return new Rectangle();
    }
}

// 使用示例
public class FactoryMethodExample {
    public static void main(String[] args) {
        ShapeFactory circleFactory = new CircleFactory();
        circleFactory.drawShape(); // 输出: 绘制圆形
        
        ShapeFactory rectangleFactory = new RectangleFactory();
        rectangleFactory.drawShape(); // 输出: 绘制矩形
    }
}
```

#### 进阶例子：数据库连接工厂系统
```java
// 数据库连接接口
interface DatabaseConnection {
    void connect();
    void executeQuery(String sql);
    void close();
    String getConnectionInfo();
}

// MySQL连接实现
class MySQLConnection implements DatabaseConnection {
    private String host;
    private int port;
    private String database;
    
    public MySQLConnection(String host, int port, String database) {
        this.host = host;
        this.port = port;
        this.database = database;
    }
    
    @Override
    public void connect() {
        System.out.println("连接到MySQL数据库: " + getConnectionInfo());
    }
    
    @Override
    public void executeQuery(String sql) {
        System.out.println("在MySQL中执行查询: " + sql);
    }
    
    @Override
    public void close() {
        System.out.println("关闭MySQL连接");
    }
    
    @Override
    public String getConnectionInfo() {
        return String.format("mysql://%s:%d/%s", host, port, database);
    }
}

// PostgreSQL连接实现
class PostgreSQLConnection implements DatabaseConnection {
    private String host;
    private int port;
    private String database;
    
    public PostgreSQLConnection(String host, int port, String database) {
        this.host = host;
        this.port = port;
        this.database = database;
    }
    
    @Override
    public void connect() {
        System.out.println("连接到PostgreSQL数据库: " + getConnectionInfo());
    }
    
    @Override
    public void executeQuery(String sql) {
        System.out.println("在PostgreSQL中执行查询: " + sql);
    }
    
    @Override
    public void close() {
        System.out.println("关闭PostgreSQL连接");
    }
    
    @Override
    public String getConnectionInfo() {
        return String.format("postgresql://%s:%d/%s", host, port, database);
    }
}

// 抽象数据库工厂
abstract class DatabaseFactory {
    // 工厂方法 - 由子类实现
    public abstract DatabaseConnection createConnection();
    
    // 模板方法 - 定义标准的数据库操作流程
    public void performDatabaseOperation(String sql) {
        DatabaseConnection connection = null;
        try {
            connection = createConnection();
            connection.connect();
            connection.executeQuery(sql);
        } catch (Exception e) {
            System.err.println("数据库操作失败: " + e.getMessage());
        } finally {
            if (connection != null) {
                connection.close();
            }
        }
    }
    
    // 批量操作
    public void performBatchOperations(String[] sqlStatements) {
        DatabaseConnection connection = null;
        try {
            connection = createConnection();
            connection.connect();
            System.out.println("开始批量操作...");
            for (String sql : sqlStatements) {
                connection.executeQuery(sql);
            }
            System.out.println("批量操作完成");
        } catch (Exception e) {
            System.err.println("批量操作失败: " + e.getMessage());
        } finally {
            if (connection != null) {
                connection.close();
            }
        }
    }
}

// MySQL工厂
class MySQLFactory extends DatabaseFactory {
    private String host;
    private int port;
    private String database;
    
    public MySQLFactory(String host, int port, String database) {
        this.host = host;
        this.port = port;
        this.database = database;
    }
    
    @Override
    public DatabaseConnection createConnection() {
        return new MySQLConnection(host, port, database);
    }
}

// PostgreSQL工厂
class PostgreSQLFactory extends DatabaseFactory {
    private String host;
    private int port;
    private String database;
    
    public PostgreSQLFactory(String host, int port, String database) {
        this.host = host;
        this.port = port;
        this.database = database;
    }
    
    @Override
    public DatabaseConnection createConnection() {
        return new PostgreSQLConnection(host, port, database);
    }
}

// 数据库工厂管理器
class DatabaseFactoryManager {
    private static final Map<String, DatabaseFactory> factories = new HashMap<>();
    
    public static void registerFactory(String type, DatabaseFactory factory) {
        factories.put(type.toLowerCase(), factory);
    }
    
    public static DatabaseFactory getFactory(String type) {
        DatabaseFactory factory = factories.get(type.toLowerCase());
        if (factory == null) {
            throw new IllegalArgumentException("不支持的数据库类型: " + type);
        }
        return factory;
    }
    
    public static Set<String> getSupportedTypes() {
        return factories.keySet();
    }
}

// 使用示例
public class DatabaseFactoryExample {
    public static void main(String[] args) {
        // 注册工厂
        DatabaseFactoryManager.registerFactory("mysql", 
            new MySQLFactory("localhost", 3306, "testdb"));
        DatabaseFactoryManager.registerFactory("postgresql", 
            new PostgreSQLFactory("localhost", 5432, "testdb"));
        
        // 使用MySQL
        DatabaseFactory mysqlFactory = DatabaseFactoryManager.getFactory("mysql");
        mysqlFactory.performDatabaseOperation("SELECT * FROM users");
        
        // 使用PostgreSQL
        DatabaseFactory postgresFactory = DatabaseFactoryManager.getFactory("postgresql");
        String[] batchSql = {
            "INSERT INTO users (name, email) VALUES ('张三', 'zhangsan@example.com')",
            "INSERT INTO users (name, email) VALUES ('李四', 'lisi@example.com')",
            "UPDATE users SET status = 'active' WHERE id > 0"
        };
        postgresFactory.performBatchOperations(batchSql);
        
        // 显示支持的数据库类型
        System.out.println("支持的数据库类型: " + 
            DatabaseFactoryManager.getSupportedTypes());
    }
}
```

**工厂方法模式的关键特点：**
1. **延迟决策**: 将对象创建的决策推迟到子类
2. **符合开放-封闭原则**: 新增产品类型只需添加新的工厂类
3. **消除耦合**: 客户端代码不依赖具体的产品类
4. **模板方法结合**: 工厂类可以定义创建对象后的标准操作流程

#### 参与者概念
- **抽象产品**：定义产品的接口
- **具体产品**：实现产品接口的具体类
- **抽象创建者**：声明工厂方法的抽象类
- **具体创建者**：实现工厂方法的具体类

#### 相关概念
- **简单工厂**：用一个类来创建所有产品
- **参数化工厂**：根据参数决定创建哪种产品
- **泛型工厂**：使用泛型的工厂实现

### 3. 抽象工厂模式 (Abstract Factory)

#### 核心概念
- **抽象工厂**：提供创建一系列相关对象的接口
- **产品族**：一组相关的产品对象
- **产品等级结构**：产品的继承层次
- **产品一致性**：确保创建的产品属于同一族

#### 基础例子：GUI组件工厂
```java
// 抽象产品 - 按钮
interface Button {
    void paint();
    void click();
}

// 抽象产品 - 文本框
interface TextField {
    void paint();
    void setText(String text);
    String getText();
}

// Windows风格的具体产品
class WindowsButton implements Button {
    @Override
    public void paint() {
        System.out.println("绘制Windows风格按钮");
    }
    
    @Override
    public void click() {
        System.out.println("Windows按钮被点击");
    }
}

class WindowsTextField implements TextField {
    private String text = "";
    
    @Override
    public void paint() {
        System.out.println("绘制Windows风格文本框");
    }
    
    @Override
    public void setText(String text) {
        this.text = text;
        System.out.println("Windows文本框设置文本: " + text);
    }
    
    @Override
    public String getText() {
        return text;
    }
}

// Mac风格的具体产品
class MacButton implements Button {
    @Override
    public void paint() {
        System.out.println("绘制Mac风格按钮");
    }
    
    @Override
    public void click() {
        System.out.println("Mac按钮被点击");
    }
}

class MacTextField implements TextField {
    private String text = "";
    
    @Override
    public void paint() {
        System.out.println("绘制Mac风格文本框");
    }
    
    @Override
    public void setText(String text) {
        this.text = text;
        System.out.println("Mac文本框设置文本: " + text);
    }
    
    @Override
    public String getText() {
        return text;
    }
}

// 抽象工厂
interface GUIFactory {
    Button createButton();
    TextField createTextField();
}

// 具体工厂
class WindowsFactory implements GUIFactory {
    @Override
    public Button createButton() {
        return new WindowsButton();
    }
    
    @Override
    public TextField createTextField() {
        return new WindowsTextField();
    }
}

class MacFactory implements GUIFactory {
    @Override
    public Button createButton() {
        return new MacButton();
    }
    
    @Override
    public TextField createTextField() {
        return new MacTextField();
    }
}

// 客户端代码
class Application {
    private Button button;
    private TextField textField;
    
    public Application(GUIFactory factory) {
        button = factory.createButton();
        textField = factory.createTextField();
    }
    
    public void paint() {
        button.paint();
        textField.paint();
    }
    
    public void interact() {
        textField.setText("Hello World");
        button.click();
        System.out.println("文本框内容: " + textField.getText());
    }
}

// 使用示例
public class AbstractFactoryExample {
    public static void main(String[] args) {
        // 根据操作系统选择工厂
        String osName = System.getProperty("os.name").toLowerCase();
        GUIFactory factory;
        
        if (osName.contains("windows")) {
            factory = new WindowsFactory();
            System.out.println("使用Windows风格界面");
        } else {
            factory = new MacFactory();
            System.out.println("使用Mac风格界面");
        }
        
        Application app = new Application(factory);
        app.paint();
        app.interact();
    }
}
```

#### 进阶例子：跨平台数据库访问工厂
```java
// 抽象产品 - 数据库连接
interface DatabaseConnection {
    void connect();
    void disconnect();
    boolean isConnected();
}

// 抽象产品 - 查询执行器
interface QueryExecutor {
    ResultSet executeQuery(String sql);
    int executeUpdate(String sql);
    void executeBatch(String[] sqls);
}

// 抽象产品 - 事务管理器
interface TransactionManager {
    void beginTransaction();
    void commit();
    void rollback();
    boolean isInTransaction();
}

// MySQL产品族
class MySQLConnection implements DatabaseConnection {
    private boolean connected = false;
    private String connectionString;
    
    public MySQLConnection(String host, int port, String database) {
        this.connectionString = String.format("mysql://%s:%d/%s", host, port, database);
    }
    
    @Override
    public void connect() {
        connected = true;
        System.out.println("连接到MySQL: " + connectionString);
    }
    
    @Override
    public void disconnect() {
        connected = false;
        System.out.println("断开MySQL连接");
    }
    
    @Override
    public boolean isConnected() {
        return connected;
    }
}

class MySQLQueryExecutor implements QueryExecutor {
    private DatabaseConnection connection;
    
    public MySQLQueryExecutor(DatabaseConnection connection) {
        this.connection = connection;
    }
    
    @Override
    public ResultSet executeQuery(String sql) {
        if (!connection.isConnected()) {
            throw new IllegalStateException("数据库未连接");
        }
        System.out.println("MySQL执行查询: " + sql);
        return new MockResultSet("MySQL查询结果");
    }
    
    @Override
    public int executeUpdate(String sql) {
        if (!connection.isConnected()) {
            throw new IllegalStateException("数据库未连接");
        }
        System.out.println("MySQL执行更新: " + sql);
        return 1; // 模拟影响行数
    }
    
    @Override
    public void executeBatch(String[] sqls) {
        if (!connection.isConnected()) {
            throw new IllegalStateException("数据库未连接");
        }
        System.out.println("MySQL执行批量操作:");
        for (String sql : sqls) {
            System.out.println("  - " + sql);
        }
    }
}

class MySQLTransactionManager implements TransactionManager {
    private boolean inTransaction = false;
    private DatabaseConnection connection;
    
    public MySQLTransactionManager(DatabaseConnection connection) {
        this.connection = connection;
    }
    
    @Override
    public void beginTransaction() {
        if (!connection.isConnected()) {
            throw new IllegalStateException("数据库未连接");
        }
        inTransaction = true;
        System.out.println("MySQL开始事务");
    }
    
    @Override
    public void commit() {
        if (!inTransaction) {
            throw new IllegalStateException("没有活动事务");
        }
        inTransaction = false;
        System.out.println("MySQL提交事务");
    }
    
    @Override
    public void rollback() {
        if (!inTransaction) {
            throw new IllegalStateException("没有活动事务");
        }
        inTransaction = false;
        System.out.println("MySQL回滚事务");
    }
    
    @Override
    public boolean isInTransaction() {
        return inTransaction;
    }
}

// PostgreSQL产品族
class PostgreSQLConnection implements DatabaseConnection {
    private boolean connected = false;
    private String connectionString;
    
    public PostgreSQLConnection(String host, int port, String database) {
        this.connectionString = String.format("postgresql://%s:%d/%s", host, port, database);
    }
    
    @Override
    public void connect() {
        connected = true;
        System.out.println("连接到PostgreSQL: " + connectionString);
    }
    
    @Override
    public void disconnect() {
        connected = false;
        System.out.println("断开PostgreSQL连接");
    }
    
    @Override
    public boolean isConnected() {
        return connected;
    }
}

class PostgreSQLQueryExecutor implements QueryExecutor {
    private DatabaseConnection connection;
    
    public PostgreSQLQueryExecutor(DatabaseConnection connection) {
        this.connection = connection;
    }
    
    @Override
    public ResultSet executeQuery(String sql) {
        if (!connection.isConnected()) {
            throw new IllegalStateException("数据库未连接");
        }
        System.out.println("PostgreSQL执行查询: " + sql);
        return new MockResultSet("PostgreSQL查询结果");
    }
    
    @Override
    public int executeUpdate(String sql) {
        if (!connection.isConnected()) {
            throw new IllegalStateException("数据库未连接");
        }
        System.out.println("PostgreSQL执行更新: " + sql);
        return 1;
    }
    
    @Override
    public void executeBatch(String[] sqls) {
        if (!connection.isConnected()) {
            throw new IllegalStateException("数据库未连接");
        }
        System.out.println("PostgreSQL执行批量操作:");
        for (String sql : sqls) {
            System.out.println("  - " + sql);
        }
    }
}

class PostgreSQLTransactionManager implements TransactionManager {
    private boolean inTransaction = false;
    private DatabaseConnection connection;
    
    public PostgreSQLTransactionManager(DatabaseConnection connection) {
        this.connection = connection;
    }
    
    @Override
    public void beginTransaction() {
        if (!connection.isConnected()) {
            throw new IllegalStateException("数据库未连接");
        }
        inTransaction = true;
        System.out.println("PostgreSQL开始事务");
    }
    
    @Override
    public void commit() {
        if (!inTransaction) {
            throw new IllegalStateException("没有活动事务");
        }
        inTransaction = false;
        System.out.println("PostgreSQL提交事务");
    }
    
    @Override
    public void rollback() {
        if (!inTransaction) {
            throw new IllegalStateException("没有活动事务");
        }
        inTransaction = false;
        System.out.println("PostgreSQL回滚事务");
    }
    
    @Override
    public boolean isInTransaction() {
        return inTransaction;
    }
}

// 抽象工厂
interface DatabaseFactory {
    DatabaseConnection createConnection();
    QueryExecutor createQueryExecutor(DatabaseConnection connection);
    TransactionManager createTransactionManager(DatabaseConnection connection);
}

// 具体工厂
class MySQLFactory implements DatabaseFactory {
    private String host;
    private int port;
    private String database;
    
    public MySQLFactory(String host, int port, String database) {
        this.host = host;
        this.port = port;
        this.database = database;
    }
    
    @Override
    public DatabaseConnection createConnection() {
        return new MySQLConnection(host, port, database);
    }
    
    @Override
    public QueryExecutor createQueryExecutor(DatabaseConnection connection) {
        return new MySQLQueryExecutor(connection);
    }
    
    @Override
    public TransactionManager createTransactionManager(DatabaseConnection connection) {
        return new MySQLTransactionManager(connection);
    }
}

class PostgreSQLFactory implements DatabaseFactory {
    private String host;
    private int port;
    private String database;
    
    public PostgreSQLFactory(String host, int port, String database) {
        this.host = host;
        this.port = port;
        this.database = database;
    }
    
    @Override
    public DatabaseConnection createConnection() {
        return new PostgreSQLConnection(host, port, database);
    }
    
    @Override
    public QueryExecutor createQueryExecutor(DatabaseConnection connection) {
        return new PostgreSQLQueryExecutor(connection);
    }
    
    @Override
    public TransactionManager createTransactionManager(DatabaseConnection connection) {
        return new PostgreSQLTransactionManager(connection);
    }
}

// 数据访问层
class DataAccessLayer {
    private DatabaseConnection connection;
    private QueryExecutor queryExecutor;
    private TransactionManager transactionManager;
    
    public DataAccessLayer(DatabaseFactory factory) {
        this.connection = factory.createConnection();
        this.queryExecutor = factory.createQueryExecutor(connection);
        this.transactionManager = factory.createTransactionManager(connection);
    }
    
    public void initialize() {
        connection.connect();
    }
    
    public void performComplexOperation() {
        try {
            transactionManager.beginTransaction();
            
            // 执行多个数据库操作
            queryExecutor.executeUpdate("INSERT INTO users (name, email) VALUES ('张三', 'zhangsan@example.com')");
            queryExecutor.executeUpdate("INSERT INTO orders (user_id, amount) VALUES (1, 100.00)");
            
            String[] batchSql = {
                "UPDATE users SET last_login = NOW() WHERE id = 1",
                "INSERT INTO user_logs (user_id, action) VALUES (1, 'login')"
            };
            queryExecutor.executeBatch(batchSql);
            
            transactionManager.commit();
            System.out.println("复杂操作执行成功");
            
        } catch (Exception e) {
            if (transactionManager.isInTransaction()) {
                transactionManager.rollback();
            }
            System.err.println("操作失败，已回滚: " + e.getMessage());
        }
    }
    
    public void queryData() {
        ResultSet result = queryExecutor.executeQuery("SELECT * FROM users WHERE active = 1");
        System.out.println("查询结果: " + result.getData());
    }
    
    public void cleanup() {
        if (connection.isConnected()) {
            connection.disconnect();
        }
    }
}

// 模拟结果集
class MockResultSet implements ResultSet {
    private String data;
    
    public MockResultSet(String data) {
        this.data = data;
    }
    
    public String getData() {
        return data;
    }
}

interface ResultSet {
    String getData();
}

// 使用示例
public class DatabaseAbstractFactoryExample {
    public static void main(String[] args) {
        // 根据配置选择数据库类型
        String dbType = "mysql"; // 可以从配置文件读取
        
        DatabaseFactory factory;
        if ("mysql".equals(dbType)) {
            factory = new MySQLFactory("localhost", 3306, "testdb");
            System.out.println("=== 使用MySQL数据库 ===");
        } else {
            factory = new PostgreSQLFactory("localhost", 5432, "testdb");
            System.out.println("=== 使用PostgreSQL数据库 ===");
        }
        
        DataAccessLayer dal = new DataAccessLayer(factory);
        
        try {
            dal.initialize();
            dal.queryData();
            dal.performComplexOperation();
        } finally {
            dal.cleanup();
        }
        
        System.out.println("\n=== 切换到另一个数据库 ===");
        
        // 切换到另一个数据库
        DatabaseFactory anotherFactory = new PostgreSQLFactory("localhost", 5432, "testdb");
        DataAccessLayer anotherDal = new DataAccessLayer(anotherFactory);
        
        try {
            anotherDal.initialize();
            anotherDal.queryData();
            anotherDal.performComplexOperation();
        } finally {
            anotherDal.cleanup();
        }
    }
}
```

**抽象工厂模式的关键特点：**
1. **产品族一致性**: 确保创建的产品属于同一个产品族
2. **易于切换产品族**: 只需要更换具体工厂就可以切换整个产品族
3. **符合开放-封闭原则**: 新增产品族只需添加新的具体工厂
4. **产品之间的约束**: 可以在工厂中定义产品之间的约束关系

#### 参与者概念
- **抽象工厂**：声明创建产品族的接口
- **具体工厂**：实现创建具体产品族的方法
- **抽象产品**：声明产品的接口
- **具体产品**：实现产品接口的具体类

### 4. 建造者模式 (Builder)

#### 核心概念
- **建造者**：负责构造复杂对象的各个部分
- **指挥者**：控制构造过程
- **产品**：被构造的复杂对象
- **分步构造**：逐步构建复杂对象

#### 基础例子：电脑组装建造者
```java
// 产品类 - 电脑
class Computer {
    private String cpu;
    private String memory;
    private String storage;
    private String graphics;
    private String motherboard;
    private String powerSupply;
    private boolean hasWifi;
    private boolean hasBluetooth;
    
    // 私有构造函数，只能通过建造者创建
    private Computer() {}
    
    // Getter方法
    public String getCpu() { return cpu; }
    public String getMemory() { return memory; }
    public String getStorage() { return storage; }
    public String getGraphics() { return graphics; }
    public String getMotherboard() { return motherboard; }
    public String getPowerSupply() { return powerSupply; }
    public boolean hasWifi() { return hasWifi; }
    public boolean hasBluetooth() { return hasBluetooth; }
    
    @Override
    public String toString() {
        return String.format(
            "电脑配置:\n" +
            "CPU: %s\n" +
            "内存: %s\n" +
            "存储: %s\n" +
            "显卡: %s\n" +
            "主板: %s\n" +
            "电源: %s\n" +
            "WiFi: %s\n" +
            "蓝牙: %s",
            cpu, memory, storage, graphics, motherboard, powerSupply,
            hasWifi ? "是" : "否", hasBluetooth ? "是" : "否"
        );
    }
    
    // 静态内部类建造者
    public static class Builder {
        private Computer computer;
        
        public Builder() {
            computer = new Computer();
        }
        
        public Builder cpu(String cpu) {
            computer.cpu = cpu;
            return this;
        }
        
        public Builder memory(String memory) {
            computer.memory = memory;
            return this;
        }
        
        public Builder storage(String storage) {
            computer.storage = storage;
            return this;
        }
        
        public Builder graphics(String graphics) {
            computer.graphics = graphics;
            return this;
        }
        
        public Builder motherboard(String motherboard) {
            computer.motherboard = motherboard;
            return this;
        }
        
        public Builder powerSupply(String powerSupply) {
            computer.powerSupply = powerSupply;
            return this;
        }
        
        public Builder wifi(boolean hasWifi) {
            computer.hasWifi = hasWifi;
            return this;
        }
        
        public Builder bluetooth(boolean hasBluetooth) {
            computer.hasBluetooth = hasBluetooth;
            return this;
        }
        
        public Computer build() {
            // 验证必需的组件
            if (computer.cpu == null || computer.memory == null || computer.storage == null) {
                throw new IllegalStateException("CPU、内存和存储是必需的组件");
            }
            
            // 设置默认值
            if (computer.graphics == null) {
                computer.graphics = "集成显卡";
            }
            if (computer.motherboard == null) {
                computer.motherboard = "标准主板";
            }
            if (computer.powerSupply == null) {
                computer.powerSupply = "500W电源";
            }
            
            return computer;
        }
    }
}

// 使用示例
public class ComputerBuilderExample {
    public static void main(String[] args) {
        // 构建游戏电脑
        Computer gamingComputer = new Computer.Builder()
            .cpu("Intel i7-12700K")
            .memory("32GB DDR4")
            .storage("1TB NVMe SSD")
            .graphics("RTX 4070")
            .motherboard("Z690 主板")
            .powerSupply("750W 80+ Gold")
            .wifi(true)
            .bluetooth(true)
            .build();
        
        System.out.println("=== 游戏电脑 ===");
        System.out.println(gamingComputer);
        
        // 构建办公电脑
        Computer officeComputer = new Computer.Builder()
            .cpu("Intel i5-12400")
            .memory("16GB DDR4")
            .storage("512GB SSD")
            .wifi(true)
            .build();
        
        System.out.println("\n=== 办公电脑 ===");
        System.out.println(officeComputer);
    }
}
```

#### 进阶例子：HTTP请求建造者系统
```java
import java.util.*;
import java.util.concurrent.TimeUnit;

// 复杂产品 - HTTP请求
class HttpRequest {
    private String url;
    private String method;
    private Map<String, String> headers;
    private Map<String, String> queryParams;
    private String body;
    private int timeout;
    private int retryCount;
    private boolean followRedirects;
    private String userAgent;
    private Map<String, String> cookies;
    private String contentType;
    private String authorization;
    
    // 私有构造函数
    private HttpRequest() {
        this.headers = new HashMap<>();
        this.queryParams = new HashMap<>();
        this.cookies = new HashMap<>();
    }
    
    // Getter方法
    public String getUrl() { return url; }
    public String getMethod() { return method; }
    public Map<String, String> getHeaders() { return new HashMap<>(headers); }
    public Map<String, String> getQueryParams() { return new HashMap<>(queryParams); }
    public String getBody() { return body; }
    public int getTimeout() { return timeout; }
    public int getRetryCount() { return retryCount; }
    public boolean isFollowRedirects() { return followRedirects; }
    public String getUserAgent() { return userAgent; }
    public Map<String, String> getCookies() { return new HashMap<>(cookies); }
    public String getContentType() { return contentType; }
    public String getAuthorization() { return authorization; }
    
    // 执行请求的模拟方法
    public HttpResponse execute() {
        System.out.println("执行HTTP请求:");
        System.out.println("URL: " + getFullUrl());
        System.out.println("方法: " + method);
        System.out.println("请求头: " + headers);
        if (body != null) {
            System.out.println("请求体: " + body);
        }
        System.out.println("超时时间: " + timeout + "ms");
        System.out.println("重试次数: " + retryCount);
        
        // 模拟响应
        return new HttpResponse(200, "请求成功", "响应内容");
    }
    
    private String getFullUrl() {
        if (queryParams.isEmpty()) {
            return url;
        }
        
        StringBuilder fullUrl = new StringBuilder(url);
        fullUrl.append("?");
        
        boolean first = true;
        for (Map.Entry<String, String> param : queryParams.entrySet()) {
            if (!first) {
                fullUrl.append("&");
            }
            fullUrl.append(param.getKey()).append("=").append(param.getValue());
            first = false;
        }
        
        return fullUrl.toString();
    }
    
    // 建造者类
    public static class Builder {
        private HttpRequest request;
        
        public Builder(String url) {
            request = new HttpRequest();
            request.url = url;
            request.method = "GET"; // 默认方法
            request.timeout = 5000; // 默认超时5秒
            request.retryCount = 0; // 默认不重试
            request.followRedirects = true; // 默认跟随重定向
            request.userAgent = "HttpClient/1.0"; // 默认User-Agent
        }
        
        public Builder method(String method) {
            request.method = method.toUpperCase();
            return this;
        }
        
        public Builder get() {
            return method("GET");
        }
        
        public Builder post() {
            return method("POST");
        }
        
        public Builder put() {
            return method("PUT");
        }
        
        public Builder delete() {
            return method("DELETE");
        }
        
        public Builder header(String name, String value) {
            request.headers.put(name, value);
            return this;
        }
        
        public Builder headers(Map<String, String> headers) {
            request.headers.putAll(headers);
            return this;
        }
        
        public Builder queryParam(String name, String value) {
            request.queryParams.put(name, value);
            return this;
        }
        
        public Builder queryParams(Map<String, String> params) {
            request.queryParams.putAll(params);
            return this;
        }
        
        public Builder body(String body) {
            request.body = body;
            return this;
        }
        
        public Builder jsonBody(String json) {
            request.body = json;
            request.contentType = "application/json";
            request.headers.put("Content-Type", "application/json");
            return this;
        }
        
        public Builder formBody(Map<String, String> formData) {
            StringBuilder body = new StringBuilder();
            boolean first = true;
            for (Map.Entry<String, String> entry : formData.entrySet()) {
                if (!first) {
                    body.append("&");
                }
                body.append(entry.getKey()).append("=").append(entry.getValue());
                first = false;
            }
            request.body = body.toString();
            request.contentType = "application/x-www-form-urlencoded";
            request.headers.put("Content-Type", "application/x-www-form-urlencoded");
            return this;
        }
        
        public Builder timeout(int timeout, TimeUnit unit) {
            request.timeout = (int) unit.toMillis(timeout);
            return this;
        }
        
        public Builder timeout(int timeoutMs) {
            request.timeout = timeoutMs;
            return this;
        }
        
        public Builder retry(int retryCount) {
            request.retryCount = retryCount;
            return this;
        }
        
        public Builder followRedirects(boolean follow) {
            request.followRedirects = follow;
            return this;
        }
        
        public Builder userAgent(String userAgent) {
            request.userAgent = userAgent;
            request.headers.put("User-Agent", userAgent);
            return this;
        }
        
        public Builder cookie(String name, String value) {
            request.cookies.put(name, value);
            return this;
        }
        
        public Builder cookies(Map<String, String> cookies) {
            request.cookies.putAll(cookies);
            return this;
        }
        
        public Builder basicAuth(String username, String password) {
            String credentials = username + ":" + password;
            String encoded = Base64.getEncoder().encodeToString(credentials.getBytes());
            request.authorization = "Basic " + encoded;
            request.headers.put("Authorization", request.authorization);
            return this;
        }
        
        public Builder bearerToken(String token) {
            request.authorization = "Bearer " + token;
            request.headers.put("Authorization", request.authorization);
            return this;
        }
        
        public HttpRequest build() {
            // 验证必需的字段
            if (request.url == null || request.url.trim().isEmpty()) {
                throw new IllegalStateException("URL不能为空");
            }
            
            // 设置Cookie头
            if (!request.cookies.isEmpty()) {
                StringBuilder cookieHeader = new StringBuilder();
                boolean first = true;
                for (Map.Entry<String, String> cookie : request.cookies.entrySet()) {
                    if (!first) {
                        cookieHeader.append("; ");
                    }
                    cookieHeader.append(cookie.getKey()).append("=").append(cookie.getValue());
                    first = false;
                }
                request.headers.put("Cookie", cookieHeader.toString());
            }
            
            return request;
        }
    }
}

// HTTP响应类
class HttpResponse {
    private int statusCode;
    private String statusMessage;
    private String body;
    
    public HttpResponse(int statusCode, String statusMessage, String body) {
        this.statusCode = statusCode;
        this.statusMessage = statusMessage;
        this.body = body;
    }
    
    public int getStatusCode() { return statusCode; }
    public String getStatusMessage() { return statusMessage; }
    public String getBody() { return body; }
    
    @Override
    public String toString() {
        return String.format("HTTP %d %s\n%s", statusCode, statusMessage, body);
    }
}

// 传统建造者模式实现（使用指挥者）
abstract class HttpRequestBuilder {
    protected HttpRequest request;
    
    public HttpRequestBuilder() {
        request = new HttpRequest();
    }
    
    public abstract void buildMethod();
    public abstract void buildHeaders();
    public abstract void buildBody();
    public abstract void buildTimeout();
    
    public HttpRequest getResult() {
        return request;
    }
}

class ApiRequestBuilder extends HttpRequestBuilder {
    private String apiKey;
    private String endpoint;
    
    public ApiRequestBuilder(String endpoint, String apiKey) {
        super();
        this.endpoint = endpoint;
        this.apiKey = apiKey;
    }
    
    @Override
    public void buildMethod() {
        // API请求通常使用POST
        request = new HttpRequest.Builder(endpoint).post().build();
    }
    
    @Override
    public void buildHeaders() {
        request = new HttpRequest.Builder(endpoint)
            .post()
            .header("X-API-Key", apiKey)
            .header("Accept", "application/json")
            .build();
    }
    
    @Override
    public void buildBody() {
        request = new HttpRequest.Builder(endpoint)
            .post()
            .header("X-API-Key", apiKey)
            .header("Accept", "application/json")
            .jsonBody("{\"action\": \"getData\"}")
            .build();
    }
    
    @Override
    public void buildTimeout() {
        request = new HttpRequest.Builder(endpoint)
            .post()
            .header("X-API-Key", apiKey)
            .header("Accept", "application/json")
            .jsonBody("{\"action\": \"getData\"}")
            .timeout(10, TimeUnit.SECONDS)
            .retry(3)
            .build();
    }
}

// 指挥者
class HttpRequestDirector {
    public HttpRequest constructApiRequest(HttpRequestBuilder builder) {
        builder.buildMethod();
        builder.buildHeaders();
        builder.buildBody();
        builder.buildTimeout();
        return builder.getResult();
    }
}

// 使用示例
public class HttpRequestBuilderExample {
    public static void main(String[] args) {
        System.out.println("=== 链式建造者示例 ===");
        
        // 构建GET请求
        HttpRequest getRequest = new HttpRequest.Builder("https://api.example.com/users")
            .get()
            .queryParam("page", "1")
            .queryParam("limit", "10")
            .header("Accept", "application/json")
            .userAgent("MyApp/1.0")
            .timeout(5, TimeUnit.SECONDS)
            .build();
        
        HttpResponse getResponse = getRequest.execute();
        System.out.println("GET响应: " + getResponse);
        
        System.out.println("\n=== POST请求示例 ===");
        
        // 构建POST请求
        Map<String, String> formData = new HashMap<>();
        formData.put("username", "john");
        formData.put("password", "secret");
        
        HttpRequest postRequest = new HttpRequest.Builder("https://api.example.com/login")
            .post()
            .formBody(formData)
            .timeout(10000)
            .retry(2)
            .build();
        
        HttpResponse postResponse = postRequest.execute();
        System.out.println("POST响应: " + postResponse);
        
        System.out.println("\n=== 复杂API请求示例 ===");
        
        // 构建复杂的API请求
        HttpRequest apiRequest = new HttpRequest.Builder("https://api.example.com/data")
            .post()
            .jsonBody("{\"query\": \"SELECT * FROM users\", \"limit\": 100}")
            .bearerToken("eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...")
            .header("X-Request-ID", UUID.randomUUID().toString())
            .cookie("session", "abc123")
            .cookie("preferences", "theme=dark")
            .timeout(30, TimeUnit.SECONDS)
            .retry(3)
            .followRedirects(false)
            .userAgent("DataAnalyzer/2.1")
            .build();
        
        HttpResponse apiResponse = apiRequest.execute();
        System.out.println("API响应: " + apiResponse);
        
        System.out.println("\n=== 传统建造者模式示例 ===");
        
        // 使用传统建造者模式
        HttpRequestDirector director = new HttpRequestDirector();
        ApiRequestBuilder builder = new ApiRequestBuilder("https://api.example.com/endpoint", "api-key-123");
        
        HttpRequest directorRequest = director.constructApiRequest(builder);
        HttpResponse directorResponse = directorRequest.execute();
        System.out.println("指挥者构建的请求响应: " + directorResponse);
    }
}
```

**建造者模式的关键特点：**
1. **分步构造**: 可以分步骤构造复杂对象
2. **参数验证**: 在build()方法中进行参数验证
3. **不可变对象**: 构造完成后对象通常是不可变的
4. **链式调用**: 支持流畅的链式调用语法
5. **默认值处理**: 可以为可选参数提供合理的默认值

#### 实现概念
- **传统建造者**：使用指挥者控制构造过程
- **链式建造者**：支持方法链式调用
- **静态内部类建造者**：常见的Java实现方式
- **注解驱动建造者**：通过注解自动生成建造者

### 5. 原型模式 (Prototype)

#### 核心概念
- **原型**：用于创建对象的样板
- **克隆**：通过复制现有对象创建新对象
- **原型管理器**：管理原型对象的注册表

#### 基础例子：图形对象克隆
```java
// 抽象原型
abstract class Shape implements Cloneable {
    protected String id;
    protected String type;
    protected int x, y;
    protected String color;
    
    public Shape() {}
    
    public Shape(Shape source) {
        if (source != null) {
            this.id = source.id;
            this.type = source.type;
            this.x = source.x;
            this.y = source.y;
            this.color = source.color;
        }
    }
    
    // 抽象克隆方法
    public abstract Shape clone();
    
    // 抽象绘制方法
    public abstract void draw();
    
    // Getter和Setter方法
    public String getId() { return id; }
    public void setId(String id) { this.id = id; }
    public String getType() { return type; }
    public void setType(String type) { this.type = type; }
    public int getX() { return x; }
    public void setX(int x) { this.x = x; }
    public int getY() { return y; }
    public void setY(int y) { this.y = y; }
    public String getColor() { return color; }
    public void setColor(String color) { this.color = color; }
    
    @Override
    public String toString() {
        return String.format("%s[id=%s, position=(%d,%d), color=%s]", 
                           type, id, x, y, color);
    }
}

// 具体原型 - 圆形
class Circle extends Shape {
    private int radius;
    
    public Circle() {
        this.type = "Circle";
    }
    
    public Circle(Circle source) {
        super(source);
        if (source != null) {
            this.radius = source.radius;
        }
    }
    
    @Override
    public Shape clone() {
        return new Circle(this);
    }
    
    @Override
    public void draw() {
        System.out.println("绘制圆形: " + this + ", 半径=" + radius);
    }
    
    public int getRadius() { return radius; }
    public void setRadius(int radius) { this.radius = radius; }
}

// 具体原型 - 矩形
class Rectangle extends Shape {
    private int width, height;
    
    public Rectangle() {
        this.type = "Rectangle";
    }
    
    public Rectangle(Rectangle source) {
        super(source);
        if (source != null) {
            this.width = source.width;
            this.height = source.height;
        }
    }
    
    @Override
    public Shape clone() {
        return new Rectangle(this);
    }
    
    @Override
    public void draw() {
        System.out.println("绘制矩形: " + this + ", 尺寸=" + width + "x" + height);
    }
    
    public int getWidth() { return width; }
    public void setWidth(int width) { this.width = width; }
    public int getHeight() { return height; }
    public void setHeight(int height) { this.height = height; }
}

// 原型管理器
class ShapeCache {
    private static Map<String, Shape> shapeMap = new HashMap<>();
    
    public static Shape getShape(String shapeId) {
        Shape cachedShape = shapeMap.get(shapeId);
        return cachedShape != null ? cachedShape.clone() : null;
    }
    
    public static void loadCache() {
        Circle circle = new Circle();
        circle.setId("1");
        circle.setX(10);
        circle.setY(20);
        circle.setColor("红色");
        circle.setRadius(5);
        shapeMap.put(circle.getId(), circle);
        
        Rectangle rectangle = new Rectangle();
        rectangle.setId("2");
        rectangle.setX(30);
        rectangle.setY(40);
        rectangle.setColor("蓝色");
        rectangle.setWidth(15);
        rectangle.setHeight(10);
        shapeMap.put(rectangle.getId(), rectangle);
        
        System.out.println("原型缓存已加载");
    }
    
    public static void addShape(String id, Shape shape) {
        shapeMap.put(id, shape);
    }
    
    public static Set<String> getAvailableShapes() {
        return shapeMap.keySet();
    }
}

// 使用示例
public class PrototypeExample {
    public static void main(String[] args) {
        // 加载原型缓存
        ShapeCache.loadCache();
        
        System.out.println("可用的原型: " + ShapeCache.getAvailableShapes());
        
        // 克隆圆形
        Shape clonedCircle1 = ShapeCache.getShape("1");
        clonedCircle1.draw();
        
        Shape clonedCircle2 = ShapeCache.getShape("1");
        clonedCircle2.setColor("绿色");
        clonedCircle2.setX(50);
        clonedCircle2.draw();
        
        // 克隆矩形
        Shape clonedRectangle = ShapeCache.getShape("2");
        clonedRectangle.draw();
        
        // 验证克隆的独立性
        System.out.println("\n验证克隆独立性:");
        System.out.println("原始圆形颜色: " + ShapeCache.getShape("1").getColor());
        System.out.println("修改后的圆形颜色: " + clonedCircle2.getColor());
    }
}
```

#### 进阶例子：文档模板克隆系统
```java
import java.io.*;
import java.util.*;
import java.util.concurrent.ConcurrentHashMap;

// 复杂对象 - 文档
class Document implements Cloneable, Serializable {
    private static final long serialVersionUID = 1L;
    
    private String title;
    private String content;
    private List<String> tags;
    private Map<String, Object> metadata;
    private List<Attachment> attachments;
    private DocumentStyle style;
    private Date createdDate;
    private Date modifiedDate;
    
    public Document() {
        this.tags = new ArrayList<>();
        this.metadata = new HashMap<>();
        this.attachments = new ArrayList<>();
        this.createdDate = new Date();
        this.modifiedDate = new Date();
    }
    
    // 拷贝构造函数 - 深拷贝
    public Document(Document source) {
        if (source != null) {
            this.title = source.title;
            this.content = source.content;
            
            // 深拷贝集合
            this.tags = new ArrayList<>(source.tags);
            this.metadata = new HashMap<>(source.metadata);
            
            // 深拷贝附件列表
            this.attachments = new ArrayList<>();
            for (Attachment attachment : source.attachments) {
                this.attachments.add(new Attachment(attachment));
            }
            
            // 深拷贝样式
            this.style = source.style != null ? new DocumentStyle(source.style) : null;
            
            // 拷贝日期
            this.createdDate = new Date(source.createdDate.getTime());
            this.modifiedDate = new Date();
        }
    }
    
    // 浅拷贝
    @Override
    public Document clone() {
        try {
            Document cloned = (Document) super.clone();
            cloned.modifiedDate = new Date();
            return cloned;
        } catch (CloneNotSupportedException e) {
            throw new RuntimeException("克隆失败", e);
        }
    }
    
    // 深拷贝
    public Document deepClone() {
        return new Document(this);
    }
    
    // 序列化深拷贝
    public Document serializationClone() {
        try {
            ByteArrayOutputStream bos = new ByteArrayOutputStream();
            ObjectOutputStream oos = new ObjectOutputStream(bos);
            oos.writeObject(this);
            oos.close();
            
            ByteArrayInputStream bis = new ByteArrayInputStream(bos.toByteArray());
            ObjectInputStream ois = new ObjectInputStream(bis);
            Document cloned = (Document) ois.readObject();
            ois.close();
            
            cloned.modifiedDate = new Date();
            return cloned;
        } catch (IOException | ClassNotFoundException e) {
            throw new RuntimeException("序列化克隆失败", e);
        }
    }
    
    // Getter和Setter方法
    public String getTitle() { return title; }
    public void setTitle(String title) { 
        this.title = title; 
        this.modifiedDate = new Date();
    }
    
    public String getContent() { return content; }
    public void setContent(String content) { 
        this.content = content; 
        this.modifiedDate = new Date();
    }
    
    public List<String> getTags() { return tags; }
    public void addTag(String tag) { 
        this.tags.add(tag); 
        this.modifiedDate = new Date();
    }
    
    public Map<String, Object> getMetadata() { return metadata; }
    public void setMetadata(String key, Object value) { 
        this.metadata.put(key, value); 
        this.modifiedDate = new Date();
    }
    
    public List<Attachment> getAttachments() { return attachments; }
    public void addAttachment(Attachment attachment) { 
        this.attachments.add(attachment); 
        this.modifiedDate = new Date();
    }
    
    public DocumentStyle getStyle() { return style; }
    public void setStyle(DocumentStyle style) { 
        this.style = style; 
        this.modifiedDate = new Date();
    }
    
    public Date getCreatedDate() { return createdDate; }
    public Date getModifiedDate() { return modifiedDate; }
    
    @Override
    public String toString() {
        return String.format("Document[title='%s', tags=%s, attachments=%d, created=%s, modified=%s]",
                           title, tags, attachments.size(), createdDate, modifiedDate);
    }
}

// 附件类
class Attachment implements Serializable {
    private static final long serialVersionUID = 1L;
    
    private String filename;
    private String contentType;
    private long size;
    private byte[] data;
    
    public Attachment(String filename, String contentType, byte[] data) {
        this.filename = filename;
        this.contentType = contentType;
        this.data = data != null ? data.clone() : null;
        this.size = data != null ? data.length : 0;
    }
    
    public Attachment(Attachment source) {
        if (source != null) {
            this.filename = source.filename;
            this.contentType = source.contentType;
            this.size = source.size;
            this.data = source.data != null ? source.data.clone() : null;
        }
    }
    
    // Getter方法
    public String getFilename() { return filename; }
    public String getContentType() { return contentType; }
    public long getSize() { return size; }
    public byte[] getData() { return data != null ? data.clone() : null; }
    
    @Override
    public String toString() {
        return String.format("Attachment[filename='%s', type='%s', size=%d]", 
                           filename, contentType, size);
    }
}

// 文档样式类
class DocumentStyle implements Serializable {
    private static final long serialVersionUID = 1L;
    
    private String fontFamily;
    private int fontSize;
    private String fontColor;
    private String backgroundColor;
    private int lineSpacing;
    private String alignment;
    
    public DocumentStyle() {
        this.fontFamily = "Arial";
        this.fontSize = 12;
        this.fontColor = "#000000";
        this.backgroundColor = "#FFFFFF";
        this.lineSpacing = 1;
        this.alignment = "left";
    }
    
    public DocumentStyle(DocumentStyle source) {
        if (source != null) {
            this.fontFamily = source.fontFamily;
            this.fontSize = source.fontSize;
            this.fontColor = source.fontColor;
            this.backgroundColor = source.backgroundColor;
            this.lineSpacing = source.lineSpacing;
            this.alignment = source.alignment;
        }
    }
    
    // Getter和Setter方法
    public String getFontFamily() { return fontFamily; }
    public void setFontFamily(String fontFamily) { this.fontFamily = fontFamily; }
    public int getFontSize() { return fontSize; }
    public void setFontSize(int fontSize) { this.fontSize = fontSize; }
    public String getFontColor() { return fontColor; }
    public void setFontColor(String fontColor) { this.fontColor = fontColor; }
    public String getBackgroundColor() { return backgroundColor; }
    public void setBackgroundColor(String backgroundColor) { this.backgroundColor = backgroundColor; }
    public int getLineSpacing() { return lineSpacing; }
    public void setLineSpacing(int lineSpacing) { this.lineSpacing = lineSpacing; }
    public String getAlignment() { return alignment; }
    public void setAlignment(String alignment) { this.alignment = alignment; }
    
    @Override
    public String toString() {
        return String.format("Style[font=%s %dpx, color=%s, bg=%s, align=%s]",
                           fontFamily, fontSize, fontColor, backgroundColor, alignment);
    }
}

// 文档模板管理器
class DocumentTemplateManager {
    private static final Map<String, Document> templates = new ConcurrentHashMap<>();
    private static final Map<String, Integer> usageCount = new ConcurrentHashMap<>();
    
    static {
        initializeTemplates();
    }
    
    private static void initializeTemplates() {
        // 创建报告模板
        Document reportTemplate = new Document();
        reportTemplate.setTitle("月度报告模板");
        reportTemplate.setContent("# 月度报告\n\n## 概述\n\n## 详细内容\n\n## 结论");
        reportTemplate.addTag("报告");
        reportTemplate.addTag("模板");
        reportTemplate.setMetadata("category", "business");
        reportTemplate.setMetadata("version", "1.0");
        
        DocumentStyle reportStyle = new DocumentStyle();
        reportStyle.setFontFamily("Times New Roman");
        reportStyle.setFontSize(14);
        reportStyle.setLineSpacing(2);
        reportTemplate.setStyle(reportStyle);
        
        templates.put("report", reportTemplate);
        
        // 创建邮件模板
        Document emailTemplate = new Document();
        emailTemplate.setTitle("邮件模板");
        emailTemplate.setContent("尊敬的 [客户姓名]，\n\n感谢您的咨询...\n\n此致\n敬礼");
        emailTemplate.addTag("邮件");
        emailTemplate.addTag("客服");
        emailTemplate.setMetadata("category", "communication");
        emailTemplate.setMetadata("priority", "normal");
        
        DocumentStyle emailStyle = new DocumentStyle();
        emailStyle.setFontFamily("Arial");
        emailStyle.setFontSize(12);
        emailTemplate.setStyle(emailStyle);
        
        templates.put("email", emailTemplate);
        
        // 创建合同模板
        Document contractTemplate = new Document();
        contractTemplate.setTitle("服务合同模板");
        contractTemplate.setContent("服务合同\n\n甲方：[公司名称]\n乙方：[客户名称]\n\n合同条款：\n1. ...\n2. ...");
        contractTemplate.addTag("合同");
        contractTemplate.addTag("法律");
        contractTemplate.setMetadata("category", "legal");
        contractTemplate.setMetadata("requires_review", true);
        
        // 添加附件
        byte[] sampleData = "合同附件示例内容".getBytes();
        contractTemplate.addAttachment(new Attachment("contract_terms.txt", "text/plain", sampleData));
        
        DocumentStyle contractStyle = new DocumentStyle();
        contractStyle.setFontFamily("SimSun");
        contractStyle.setFontSize(12);
        contractStyle.setLineSpacing(2);
        contractTemplate.setStyle(contractStyle);
        
        templates.put("contract", contractTemplate);
        
        System.out.println("文档模板已初始化: " + templates.keySet());
    }
    
    public static Document getTemplate(String templateName) {
        Document template = templates.get(templateName);
        if (template == null) {
            throw new IllegalArgumentException("模板不存在: " + templateName);
        }
        
        // 记录使用次数
        usageCount.merge(templateName, 1, Integer::sum);
        
        return template.deepClone();
    }
    
    public static Document getTemplateByClone(String templateName) {
        Document template = templates.get(templateName);
        if (template == null) {
            throw new IllegalArgumentException("模板不存在: " + templateName);
        }
        
        usageCount.merge(templateName, 1, Integer::sum);
        return template.clone(); // 浅拷贝
    }
    
    public static Document getTemplateBySerialization(String templateName) {
        Document template = templates.get(templateName);
        if (template == null) {
            throw new IllegalArgumentException("模板不存在: " + templateName);
        }
        
        usageCount.merge(templateName, 1, Integer::sum);
        return template.serializationClone(); // 序列化深拷贝
    }
    
    public static void addTemplate(String name, Document template) {
        templates.put(name, template);
        usageCount.put(name, 0);
    }
    
    public static Set<String> getAvailableTemplates() {
        return templates.keySet();
    }
    
    public static Map<String, Integer> getUsageStatistics() {
        return new HashMap<>(usageCount);
    }
    
    public static void printTemplateInfo(String templateName) {
        Document template = templates.get(templateName);
        if (template != null) {
            System.out.println("模板信息: " + template);
            System.out.println("样式: " + template.getStyle());
            System.out.println("附件: " + template.getAttachments());
            System.out.println("使用次数: " + usageCount.getOrDefault(templateName, 0));
        }
    }
}

// 使用示例
public class DocumentPrototypeExample {
    public static void main(String[] args) {
        System.out.println("=== 文档模板克隆系统 ===");
        System.out.println("可用模板: " + DocumentTemplateManager.getAvailableTemplates());
        
        // 使用深拷贝创建文档
        System.out.println("\n--- 深拷贝示例 ---");
        Document report1 = DocumentTemplateManager.getTemplate("report");
        report1.setTitle("2024年1月销售报告");
        report1.setContent(report1.getContent().replace("[月份]", "1月"));
        report1.addTag("销售");
        report1.setMetadata("month", "2024-01");
        
        Document report2 = DocumentTemplateManager.getTemplate("report");
        report2.setTitle("2024年2月销售报告");
        report2.setContent(report2.getContent().replace("[月份]", "2月"));
        report2.addTag("销售");
        report2.setMetadata("month", "2024-02");
        
        System.out.println("报告1: " + report1);
        System.out.println("报告2: " + report2);
        
        // 使用浅拷贝创建文档
        System.out.println("\n--- 浅拷贝示例 ---");
        Document email1 = DocumentTemplateManager.getTemplateByClone("email");
        email1.setTitle("客户咨询回复");
        email1.addTag("客服回复");
        
        Document email2 = DocumentTemplateManager.getTemplateByClone("email");
        email2.setTitle("产品介绍邮件");
        
        System.out.println("邮件1: " + email1);
        System.out.println("邮件2: " + email2);
        
        // 验证浅拷贝的共享问题
        System.out.println("邮件1标签: " + email1.getTags());
        System.out.println("邮件2标签: " + email2.getTags());
        
        // 使用序列化克隆
        System.out.println("\n--- 序列化克隆示例 ---");
        Document contract1 = DocumentTemplateManager.getTemplateBySerialization("contract");
        contract1.setTitle("软件开发服务合同");
        contract1.setContent(contract1.getContent().replace("[公司名称]", "科技有限公司"));
        contract1.setContent(contract1.getContent().replace("[客户名称]", "ABC公司"));
        
        System.out.println("合同1: " + contract1);
        System.out.println("合同1附件: " + contract1.getAttachments());
        
        // 性能测试
        System.out.println("\n--- 性能测试 ---");
        long startTime, endTime;
        int iterations = 1000;
        
        // 测试深拷贝性能
        startTime = System.currentTimeMillis();
        for (int i = 0; i < iterations; i++) {
            Document doc = DocumentTemplateManager.getTemplate("contract");
        }
        endTime = System.currentTimeMillis();
        System.out.println("深拷贝 " + iterations + " 次耗时: " + (endTime - startTime) + "ms");
        
        // 测试浅拷贝性能
        startTime = System.currentTimeMillis();
        for (int i = 0; i < iterations; i++) {
            Document doc = DocumentTemplateManager.getTemplateByClone("contract");
        }
        endTime = System.currentTimeMillis();
        System.out.println("浅拷贝 " + iterations + " 次耗时: " + (endTime - startTime) + "ms");
        
        // 测试序列化克隆性能
        startTime = System.currentTimeMillis();
        for (int i = 0; i < iterations; i++) {
            Document doc = DocumentTemplateManager.getTemplateBySerialization("contract");
        }
        endTime = System.currentTimeMillis();
        System.out.println("序列化克隆 " + iterations + " 次耗时: " + (endTime - startTime) + "ms");
        
        // 显示使用统计
        System.out.println("\n--- 使用统计 ---");
        Map<String, Integer> stats = DocumentTemplateManager.getUsageStatistics();
        stats.forEach((template, count) -> 
            System.out.println(template + ": " + count + " 次"));
        
        // 显示模板详细信息
        System.out.println("\n--- 模板详细信息 ---");
        DocumentTemplateManager.printTemplateInfo("contract");
    }
}
```

**原型模式的关键特点：**
1. **避免重复创建**: 通过克隆避免重复的初始化过程
2. **运行时配置**: 可以在运行时动态添加和删除原型
3. **减少子类**: 避免为每种产品创建工厂子类
4. **性能优化**: 克隆通常比new操作更快
5. **深浅拷贝选择**: 根据需要选择合适的拷贝方式

#### 克隆概念
- **浅拷贝**：只复制对象的基本类型字段
- **深拷贝**：递归复制对象的所有字段
- **序列化克隆**：通过序列化实现深拷贝
- **手动克隆**：自定义克隆逻辑

## 第三部分：结构型模式概念

### 1. 适配器模式 (Adapter)

#### 核心概念
- **适配器**：将一个接口转换成客户期望的另一个接口
- **目标接口**：客户端期望的接口
- **适配者**：需要被适配的现有类
- **接口转换**：不兼容接口的转换

#### 基础例子：音频播放器适配器
```java
// 目标接口 - 客户端期望的接口
interface MediaPlayer {
    void play(String audioType, String fileName);
}

// 适配者接口 - 高级媒体播放器
interface AdvancedMediaPlayer {
    void playVlc(String fileName);
    void playMp4(String fileName);
}

// 具体适配者 - VLC播放器
class VlcPlayer implements AdvancedMediaPlayer {
    @Override
    public void playVlc(String fileName) {
        System.out.println("播放VLC文件: " + fileName);
    }
    
    @Override
    public void playMp4(String fileName) {
        // VLC播放器不支持MP4
    }
}

// 具体适配者 - MP4播放器
class Mp4Player implements AdvancedMediaPlayer {
    @Override
    public void playVlc(String fileName) {
        // MP4播放器不支持VLC
    }
    
    @Override
    public void playMp4(String fileName) {
        System.out.println("播放MP4文件: " + fileName);
    }
}

// 适配器类 - 对象适配器
class MediaAdapter implements MediaPlayer {
    private AdvancedMediaPlayer advancedPlayer;
    
    public MediaAdapter(String audioType) {
        if ("vlc".equalsIgnoreCase(audioType)) {
            advancedPlayer = new VlcPlayer();
        } else if ("mp4".equalsIgnoreCase(audioType)) {
            advancedPlayer = new Mp4Player();
        }
    }
    
    @Override
    public void play(String audioType, String fileName) {
        if ("vlc".equalsIgnoreCase(audioType)) {
            advancedPlayer.playVlc(fileName);
        } else if ("mp4".equalsIgnoreCase(audioType)) {
            advancedPlayer.playMp4(fileName);
        }
    }
}

// 具体目标类 - 音频播放器
class AudioPlayer implements MediaPlayer {
    private MediaAdapter mediaAdapter;
    
    @Override
    public void play(String audioType, String fileName) {
        // 内置支持MP3格式
        if ("mp3".equalsIgnoreCase(audioType)) {
            System.out.println("播放MP3文件: " + fileName);
        }
        // 使用适配器支持其他格式
        else if ("vlc".equalsIgnoreCase(audioType) || "mp4".equalsIgnoreCase(audioType)) {
            mediaAdapter = new MediaAdapter(audioType);
            mediaAdapter.play(audioType, fileName);
        } else {
            System.out.println("不支持的音频格式: " + audioType);
        }
    }
}

// 使用示例
public class AdapterExample {
    public static void main(String[] args) {
        AudioPlayer audioPlayer = new AudioPlayer();
        
        audioPlayer.play("mp3", "beyond_the_horizon.mp3");
        audioPlayer.play("mp4", "alone.mp4");
        audioPlayer.play("vlc", "far_far_away.vlc");
        audioPlayer.play("avi", "mind_me.avi");
    }
}
```

#### 进阶例子：第三方支付系统适配器
```java
// 目标接口 - 统一支付接口
interface PaymentProcessor {
    PaymentResult processPayment(PaymentRequest request);
    PaymentResult refund(String transactionId, double amount);
    PaymentStatus queryPaymentStatus(String transactionId);
}

// 支付请求
class PaymentRequest {
    private String orderId;
    private double amount;
    private String currency;
    private String description;
    private Map<String, String> customerInfo;
    
    public PaymentRequest(String orderId, double amount, String currency, String description) {
        this.orderId = orderId;
        this.amount = amount;
        this.currency = currency;
        this.description = description;
        this.customerInfo = new HashMap<>();
    }
    
    // Getter和Setter方法
    public String getOrderId() { return orderId; }
    public double getAmount() { return amount; }
    public String getCurrency() { return currency; }
    public String getDescription() { return description; }
    public Map<String, String> getCustomerInfo() { return customerInfo; }
    public void setCustomerInfo(String key, String value) { customerInfo.put(key, value); }
}

// 支付结果
class PaymentResult {
    private boolean success;
    private String transactionId;
    private String message;
    private String errorCode;
    private Date timestamp;
    
    public PaymentResult(boolean success, String transactionId, String message) {
        this.success = success;
        this.transactionId = transactionId;
        this.message = message;
        this.timestamp = new Date();
    }
    
    // Getter方法
    public boolean isSuccess() { return success; }
    public String getTransactionId() { return transactionId; }
    public String getMessage() { return message; }
    public String getErrorCode() { return errorCode; }
    public void setErrorCode(String errorCode) { this.errorCode = errorCode; }
    public Date getTimestamp() { return timestamp; }
    
    @Override
    public String toString() {
        return String.format("PaymentResult[success=%s, transactionId=%s, message=%s, timestamp=%s]",
                           success, transactionId, message, timestamp);
    }
}

// 支付状态枚举
enum PaymentStatus {
    PENDING, SUCCESS, FAILED, CANCELLED, REFUNDED
}

// 第三方支付系统1 - 支付宝（适配者）
class AlipaySDK {
    public AlipayResponse pay(AlipayRequest request) {
        System.out.println("调用支付宝支付接口");
        System.out.println("订单号: " + request.getOutTradeNo());
        System.out.println("金额: " + request.getTotalAmount() + " " + request.getCurrency());
        
        // 模拟支付处理
        String tradeNo = "ALIPAY_" + System.currentTimeMillis();
        return new AlipayResponse("10000", "Success", tradeNo);
    }
    
    public AlipayRefundResponse refund(String tradeNo, double amount) {
        System.out.println("调用支付宝退款接口");
        System.out.println("交易号: " + tradeNo + ", 退款金额: " + amount);
        
        String refundNo = "REFUND_" + System.currentTimeMillis();
        return new AlipayRefundResponse("10000", "Success", refundNo);
    }
    
    public AlipayQueryResponse queryTrade(String tradeNo) {
        System.out.println("查询支付宝交易状态: " + tradeNo);
        return new AlipayQueryResponse("10000", "TRADE_SUCCESS", tradeNo);
    }
}

// 支付宝请求对象
class AlipayRequest {
    private String outTradeNo;
    private String totalAmount;
    private String currency;
    private String subject;
    
    public AlipayRequest(String outTradeNo, String totalAmount, String currency, String subject) {
        this.outTradeNo = outTradeNo;
        this.totalAmount = totalAmount;
        this.currency = currency;
        this.subject = subject;
    }
    
    public String getOutTradeNo() { return outTradeNo; }
    public String getTotalAmount() { return totalAmount; }
    public String getCurrency() { return currency; }
    public String getSubject() { return subject; }
}

// 支付宝响应对象
class AlipayResponse {
    private String code;
    private String msg;
    private String tradeNo;
    
    public AlipayResponse(String code, String msg, String tradeNo) {
        this.code = code;
        this.msg = msg;
        this.tradeNo = tradeNo;
    }
    
    public String getCode() { return code; }
    public String getMsg() { return msg; }
    public String getTradeNo() { return tradeNo; }
    public boolean isSuccess() { return "10000".equals(code); }
}

class AlipayRefundResponse {
    private String code;
    private String msg;
    private String refundNo;
    
    public AlipayRefundResponse(String code, String msg, String refundNo) {
        this.code = code;
        this.msg = msg;
        this.refundNo = refundNo;
    }
    
    public String getCode() { return code; }
    public String getMsg() { return msg; }
    public String getRefundNo() { return refundNo; }
    public boolean isSuccess() { return "10000".equals(code); }
}

class AlipayQueryResponse {
    private String code;
    private String tradeStatus;
    private String tradeNo;
    
    public AlipayQueryResponse(String code, String tradeStatus, String tradeNo) {
        this.code = code;
        this.tradeStatus = tradeStatus;
        this.tradeNo = tradeNo;
    }
    
    public String getCode() { return code; }
    public String getTradeStatus() { return tradeStatus; }
    public String getTradeNo() { return tradeNo; }
}

// 第三方支付系统2 - 微信支付（适配者）
class WechatPaySDK {
    public WechatPayResponse unifiedOrder(WechatPayRequest request) {
        System.out.println("调用微信支付统一下单接口");
        System.out.println("商户订单号: " + request.getOutTradeNo());
        System.out.println("金额: " + request.getTotalFee() + " 分");
        
        String prepayId = "WECHAT_" + System.currentTimeMillis();
        return new WechatPayResponse("SUCCESS", "OK", prepayId);
    }
    
    public WechatRefundResponse refund(String transactionId, int refundFee) {
        System.out.println("调用微信支付退款接口");
        System.out.println("交易号: " + transactionId + ", 退款金额: " + refundFee + " 分");
        
        String refundId = "WX_REFUND_" + System.currentTimeMillis();
        return new WechatRefundResponse("SUCCESS", "OK", refundId);
    }
    
    public WechatQueryResponse orderQuery(String transactionId) {
        System.out.println("查询微信支付订单状态: " + transactionId);
        return new WechatQueryResponse("SUCCESS", "SUCCESS", transactionId);
    }
}

// 微信支付请求对象
class WechatPayRequest {
    private String outTradeNo;
    private int totalFee; // 微信支付金额以分为单位
    private String body;
    
    public WechatPayRequest(String outTradeNo, int totalFee, String body) {
        this.outTradeNo = outTradeNo;
        this.totalFee = totalFee;
        this.body = body;
    }
    
    public String getOutTradeNo() { return outTradeNo; }
    public int getTotalFee() { return totalFee; }
    public String getBody() { return body; }
}

// 微信支付响应对象
class WechatPayResponse {
    private String returnCode;
    private String returnMsg;
    private String prepayId;
    
    public WechatPayResponse(String returnCode, String returnMsg, String prepayId) {
        this.returnCode = returnCode;
        this.returnMsg = returnMsg;
        this.prepayId = prepayId;
    }
    
    public String getReturnCode() { return returnCode; }
    public String getReturnMsg() { return returnMsg; }
    public String getPrepayId() { return prepayId; }
    public boolean isSuccess() { return "SUCCESS".equals(returnCode); }
}

class WechatRefundResponse {
    private String returnCode;
    private String returnMsg;
    private String refundId;
    
    public WechatRefundResponse(String returnCode, String returnMsg, String refundId) {
        this.returnCode = returnCode;
        this.returnMsg = returnMsg;
        this.refundId = refundId;
    }
    
    public String getReturnCode() { return returnCode; }
    public String getReturnMsg() { return returnMsg; }
    public String getRefundId() { return refundId; }
    public boolean isSuccess() { return "SUCCESS".equals(returnCode); }
}

class WechatQueryResponse {
    private String returnCode;
    private String tradeState;
    private String transactionId;
    
    public WechatQueryResponse(String returnCode, String tradeState, String transactionId) {
        this.returnCode = returnCode;
        this.tradeState = tradeState;
        this.transactionId = transactionId;
    }
    
    public String getReturnCode() { return returnCode; }
    public String getTradeState() { return tradeState; }
    public String getTransactionId() { return transactionId; }
}

// 支付宝适配器
class AlipayAdapter implements PaymentProcessor {
    private AlipaySDK alipaySDK;
    
    public AlipayAdapter() {
        this.alipaySDK = new AlipaySDK();
    }
    
    @Override
    public PaymentResult processPayment(PaymentRequest request) {
        try {
            // 转换请求格式
            AlipayRequest alipayRequest = new AlipayRequest(
                request.getOrderId(),
                String.valueOf(request.getAmount()),
                request.getCurrency(),
                request.getDescription()
            );
            
            // 调用支付宝接口
            AlipayResponse response = alipaySDK.pay(alipayRequest);
            
            // 转换响应格式
            if (response.isSuccess()) {
                return new PaymentResult(true, response.getTradeNo(), "支付成功");
            } else {
                PaymentResult result = new PaymentResult(false, null, response.getMsg());
                result.setErrorCode(response.getCode());
                return result;
            }
        } catch (Exception e) {
            return new PaymentResult(false, null, "支付失败: " + e.getMessage());
        }
    }
    
    @Override
    public PaymentResult refund(String transactionId, double amount) {
        try {
            AlipayRefundResponse response = alipaySDK.refund(transactionId, amount);
            
            if (response.isSuccess()) {
                return new PaymentResult(true, response.getRefundNo(), "退款成功");
            } else {
                PaymentResult result = new PaymentResult(false, null, response.getMsg());
                result.setErrorCode(response.getCode());
                return result;
            }
        } catch (Exception e) {
            return new PaymentResult(false, null, "退款失败: " + e.getMessage());
        }
    }
    
    @Override
    public PaymentStatus queryPaymentStatus(String transactionId) {
        try {
            AlipayQueryResponse response = alipaySDK.queryTrade(transactionId);
            
            switch (response.getTradeStatus()) {
                case "TRADE_SUCCESS":
                    return PaymentStatus.SUCCESS;
                case "TRADE_CLOSED":
                    return PaymentStatus.CANCELLED;
                case "WAIT_BUYER_PAY":
                    return PaymentStatus.PENDING;
                default:
                    return PaymentStatus.FAILED;
            }
        } catch (Exception e) {
            return PaymentStatus.FAILED;
        }
    }
}

// 微信支付适配器
class WechatPayAdapter implements PaymentProcessor {
    private WechatPaySDK wechatPaySDK;
    
    public WechatPayAdapter() {
        this.wechatPaySDK = new WechatPaySDK();
    }
    
    @Override
    public PaymentResult processPayment(PaymentRequest request) {
        try {
            // 转换请求格式（微信支付金额以分为单位）
            WechatPayRequest wechatRequest = new WechatPayRequest(
                request.getOrderId(),
                (int) (request.getAmount() * 100), // 转换为分
                request.getDescription()
            );
            
            // 调用微信支付接口
            WechatPayResponse response = wechatPaySDK.unifiedOrder(wechatRequest);
            
            // 转换响应格式
            if (response.isSuccess()) {
                return new PaymentResult(true, response.getPrepayId(), "支付成功");
            } else {
                return new PaymentResult(false, null, response.getReturnMsg());
            }
        } catch (Exception e) {
            return new PaymentResult(false, null, "支付失败: " + e.getMessage());
        }
    }
    
    @Override
    public PaymentResult refund(String transactionId, double amount) {
        try {
            // 微信退款金额以分为单位
            WechatRefundResponse response = wechatPaySDK.refund(transactionId, (int) (amount * 100));
            
            if (response.isSuccess()) {
                return new PaymentResult(true, response.getRefundId(), "退款成功");
            } else {
                return new PaymentResult(false, null, response.getReturnMsg());
            }
        } catch (Exception e) {
            return new PaymentResult(false, null, "退款失败: " + e.getMessage());
        }
    }
    
    @Override
    public PaymentStatus queryPaymentStatus(String transactionId) {
        try {
            WechatQueryResponse response = wechatPaySDK.orderQuery(transactionId);
            
            switch (response.getTradeState()) {
                case "SUCCESS":
                    return PaymentStatus.SUCCESS;
                case "CLOSED":
                    return PaymentStatus.CANCELLED;
                case "USERPAYING":
                    return PaymentStatus.PENDING;
                case "REFUND":
                    return PaymentStatus.REFUNDED;
                default:
                    return PaymentStatus.FAILED;
            }
        } catch (Exception e) {
            return PaymentStatus.FAILED;
        }
    }
}

// 支付处理器工厂
class PaymentProcessorFactory {
    public static PaymentProcessor createProcessor(String paymentType) {
        switch (paymentType.toLowerCase()) {
            case "alipay":
                return new AlipayAdapter();
            case "wechat":
                return new WechatPayAdapter();
            default:
                throw new IllegalArgumentException("不支持的支付类型: " + paymentType);
        }
    }
}

// 统一支付服务
class PaymentService {
    private Map<String, PaymentProcessor> processors;
    
    public PaymentService() {
        processors = new HashMap<>();
        processors.put("alipay", new AlipayAdapter());
        processors.put("wechat", new WechatPayAdapter());
    }
    
    public PaymentResult processPayment(String paymentType, PaymentRequest request) {
        PaymentProcessor processor = processors.get(paymentType.toLowerCase());
        if (processor == null) {
            return new PaymentResult(false, null, "不支持的支付方式: " + paymentType);
        }
        
        System.out.println("使用 " + paymentType + " 处理支付");
        return processor.processPayment(request);
    }
    
    public PaymentResult refund(String paymentType, String transactionId, double amount) {
        PaymentProcessor processor = processors.get(paymentType.toLowerCase());
        if (processor == null) {
            return new PaymentResult(false, null, "不支持的支付方式: " + paymentType);
        }
        
        System.out.println("使用 " + paymentType + " 处理退款");
        return processor.refund(transactionId, amount);
    }
    
    public PaymentStatus queryStatus(String paymentType, String transactionId) {
        PaymentProcessor processor = processors.get(paymentType.toLowerCase());
        if (processor == null) {
            return PaymentStatus.FAILED;
        }
        
        return processor.queryPaymentStatus(transactionId);
    }
}

// 使用示例
public class PaymentAdapterExample {
    public static void main(String[] args) {
        PaymentService paymentService = new PaymentService();
        
        // 创建支付请求
        PaymentRequest request = new PaymentRequest("ORDER_001", 99.99, "CNY", "购买商品");
        request.setCustomerInfo("userId", "12345");
        request.setCustomerInfo("email", "user@example.com");
        
        System.out.println("=== 支付宝支付测试 ===");
        PaymentResult alipayResult = paymentService.processPayment("alipay", request);
        System.out.println("支付结果: " + alipayResult);
        
        if (alipayResult.isSuccess()) {
            PaymentStatus status = paymentService.queryStatus("alipay", alipayResult.getTransactionId());
            System.out.println("支付状态: " + status);
            
            // 测试退款
            PaymentResult refundResult = paymentService.refund("alipay", alipayResult.getTransactionId(), 50.0);
            System.out.println("退款结果: " + refundResult);
        }
        
        System.out.println("\n=== 微信支付测试 ===");
        PaymentRequest wechatRequest = new PaymentRequest("ORDER_002", 199.99, "CNY", "购买VIP会员");
        PaymentResult wechatResult = paymentService.processPayment("wechat", wechatRequest);
        System.out.println("支付结果: " + wechatResult);
        
        if (wechatResult.isSuccess()) {
            PaymentStatus status = paymentService.queryStatus("wechat", wechatResult.getTransactionId());
            System.out.println("支付状态: " + status);
        }
        
        System.out.println("\n=== 不支持的支付方式测试 ===");
        PaymentResult unsupportedResult = paymentService.processPayment("paypal", request);
        System.out.println("支付结果: " + unsupportedResult);
    }
}
```

**适配器模式的关键特点：**
1. **接口转换**: 将不兼容的接口转换为客户端期望的接口
2. **代码复用**: 可以复用现有的类而不需要修改其源代码
3. **解耦**: 客户端与第三方库解耦，便于切换不同的实现
4. **统一接口**: 为不同的第三方服务提供统一的调用接口
5. **易于扩展**: 新增第三方服务只需要添加新的适配器

#### 实现概念
- **类适配器**：通过继承实现适配
- **对象适配器**：通过组合实现适配
- **双向适配器**：支持双向转换的适配器
- **缺省适配器**：提供接口默认实现的适配器

### 2. 桥接模式 (Bridge)

#### 核心概念
- **桥接**：将抽象与实现分离，使它们可以独立变化
- **抽象**：定义抽象接口
- **实现**：定义实现接口
- **分离变化**：将两个独立变化的维度分离

#### 基础例子：图形绘制系统
```java
// 实现接口 - 绘制API
interface DrawingAPI {
    void drawCircle(double x, double y, double radius);
    void drawRectangle(double x, double y, double width, double height);
    void setColor(String color);
}

// 具体实现 - Windows绘制API
class WindowsDrawingAPI implements DrawingAPI {
    @Override
    public void drawCircle(double x, double y, double radius) {
        System.out.printf("Windows API: 在坐标(%.1f, %.1f)绘制半径为%.1f的圆形%n", x, y, radius);
    }
    
    @Override
    public void drawRectangle(double x, double y, double width, double height) {
        System.out.printf("Windows API: 在坐标(%.1f, %.1f)绘制%.1fx%.1f的矩形%n", x, y, width, height);
    }
    
    @Override
    public void setColor(String color) {
        System.out.println("Windows API: 设置颜色为 " + color);
    }
}

// 具体实现 - Linux绘制API
class LinuxDrawingAPI implements DrawingAPI {
    @Override
    public void drawCircle(double x, double y, double radius) {
        System.out.printf("Linux API: 在坐标(%.1f, %.1f)绘制半径为%.1f的圆形%n", x, y, radius);
    }
    
    @Override
    public void drawRectangle(double x, double y, double width, double height) {
        System.out.printf("Linux API: 在坐标(%.1f, %.1f)绘制%.1fx%.1f的矩形%n", x, y, width, height);
    }
    
    @Override
    public void setColor(String color) {
        System.out.println("Linux API: 设置颜色为 " + color);
    }
}

// 抽象类 - 形状
abstract class Shape {
    protected DrawingAPI drawingAPI;
    protected String color = "黑色";
    
    protected Shape(DrawingAPI drawingAPI) {
        this.drawingAPI = drawingAPI;
    }
    
    public abstract void draw();
    public abstract void resize(double factor);
    
    public void setColor(String color) {
        this.color = color;
        drawingAPI.setColor(color);
    }
}

// 扩展抽象类 - 圆形
class Circle extends Shape {
    private double x, y, radius;
    
    public Circle(double x, double y, double radius, DrawingAPI drawingAPI) {
        super(drawingAPI);
        this.x = x;
        this.y = y;
        this.radius = radius;
    }
    
    @Override
    public void draw() {
        drawingAPI.setColor(color);
        drawingAPI.drawCircle(x, y, radius);
    }
    
    @Override
    public void resize(double factor) {
        radius *= factor;
        System.out.printf("圆形大小调整为原来的%.1f倍，新半径: %.1f%n", factor, radius);
    }
    
    public void move(double newX, double newY) {
        this.x = newX;
        this.y = newY;
        System.out.printf("圆形移动到新位置: (%.1f, %.1f)%n", x, y);
    }
}

// 扩展抽象类 - 矩形
class Rectangle extends Shape {
    private double x, y, width, height;
    
    public Rectangle(double x, double y, double width, double height, DrawingAPI drawingAPI) {
        super(drawingAPI);
        this.x = x;
        this.y = y;
        this.width = width;
        this.height = height;
    }
    
    @Override
    public void draw() {
        drawingAPI.setColor(color);
        drawingAPI.drawRectangle(x, y, width, height);
    }
    
    @Override
    public void resize(double factor) {
        width *= factor;
        height *= factor;
        System.out.printf("矩形大小调整为原来的%.1f倍，新尺寸: %.1fx%.1f%n", factor, width, height);
    }
    
    public void move(double newX, double newY) {
        this.x = newX;
        this.y = newY;
        System.out.printf("矩形移动到新位置: (%.1f, %.1f)%n", x, y);
    }
}

// 使用示例
public class BridgeExample {
    public static void main(String[] args) {
        // 使用Windows API绘制图形
        System.out.println("=== 使用Windows API ===");
        DrawingAPI windowsAPI = new WindowsDrawingAPI();
        
        Shape circle1 = new Circle(10, 10, 5, windowsAPI);
        circle1.setColor("红色");
        circle1.draw();
        circle1.resize(1.5);
        circle1.draw();
        
        Shape rectangle1 = new Rectangle(20, 20, 10, 8, windowsAPI);
        rectangle1.setColor("蓝色");
        rectangle1.draw();
        
        // 使用Linux API绘制图形
        System.out.println("\n=== 使用Linux API ===");
        DrawingAPI linuxAPI = new LinuxDrawingAPI();
        
        Shape circle2 = new Circle(15, 15, 7, linuxAPI);
        circle2.setColor("绿色");
        circle2.draw();
        
        Shape rectangle2 = new Rectangle(30, 30, 12, 6, linuxAPI);
        rectangle2.setColor("黄色");
        rectangle2.draw();
        rectangle2.resize(0.8);
        rectangle2.draw();
    }
}
```

#### 进阶例子：消息发送系统
```java
// 实现接口 - 消息发送器
interface MessageSender {
    void sendMessage(String message, String recipient);
    boolean isAvailable();
    void configure(Map<String, String> config);
    String getProviderName();
}

// 具体实现 - 邮件发送器
class EmailSender implements MessageSender {
    private String smtpServer;
    private int port;
    private String username;
    private String password;
    private boolean isConfigured = false;
    
    @Override
    public void sendMessage(String message, String recipient) {
        if (!isConfigured) {
            throw new IllegalStateException("邮件发送器未配置");
        }
        System.out.printf("通过邮件发送消息到 %s:%n", recipient);
        System.out.printf("SMTP服务器: %s:%d%n", smtpServer, port);
        System.out.printf("消息内容: %s%n", message);
        System.out.println("邮件发送成功");
    }
    
    @Override
    public boolean isAvailable() {
        return isConfigured && smtpServer != null && !smtpServer.isEmpty();
    }
    
    @Override
    public void configure(Map<String, String> config) {
        this.smtpServer = config.get("smtp.server");
        this.port = Integer.parseInt(config.getOrDefault("smtp.port", "587"));
        this.username = config.get("smtp.username");
        this.password = config.get("smtp.password");
        this.isConfigured = true;
        System.out.println("邮件发送器配置完成");
    }
    
    @Override
    public String getProviderName() {
        return "Email";
    }
}

// 具体实现 - 短信发送器
class SMSSender implements MessageSender {
    private String apiKey;
    private String apiSecret;
    private String serviceUrl;
    private boolean isConfigured = false;
    
    @Override
    public void sendMessage(String message, String recipient) {
        if (!isConfigured) {
            throw new IllegalStateException("短信发送器未配置");
        }
        System.out.printf("通过短信发送消息到 %s:%n", recipient);
        System.out.printf("服务URL: %s%n", serviceUrl);
        System.out.printf("消息内容: %s%n", message);
        System.out.println("短信发送成功");
    }
    
    @Override
    public boolean isAvailable() {
        return isConfigured && apiKey != null && !apiKey.isEmpty();
    }
    
    @Override
    public void configure(Map<String, String> config) {
        this.apiKey = config.get("sms.api.key");
        this.apiSecret = config.get("sms.api.secret");
        this.serviceUrl = config.get("sms.service.url");
        this.isConfigured = true;
        System.out.println("短信发送器配置完成");
    }
    
    @Override
    public String getProviderName() {
        return "SMS";
    }
}

// 具体实现 - 微信发送器
class WeChatSender implements MessageSender {
    private String appId;
    private String appSecret;
    private String accessToken;
    private boolean isConfigured = false;
    
    @Override
    public void sendMessage(String message, String recipient) {
        if (!isConfigured) {
            throw new IllegalStateException("微信发送器未配置");
        }
        System.out.printf("通过微信发送消息到 %s:%n", recipient);
        System.out.printf("AppId: %s%n", appId);
        System.out.printf("消息内容: %s%n", message);
        System.out.println("微信消息发送成功");
    }
    
    @Override
    public boolean isAvailable() {
        return isConfigured && appId != null && !appId.isEmpty();
    }
    
    @Override
    public void configure(Map<String, String> config) {
        this.appId = config.get("wechat.app.id");
        this.appSecret = config.get("wechat.app.secret");
        this.accessToken = config.get("wechat.access.token");
        this.isConfigured = true;
        System.out.println("微信发送器配置完成");
    }
    
    @Override
    public String getProviderName() {
        return "WeChat";
    }
}

// 抽象类 - 消息
abstract class Message {
    protected MessageSender messageSender;
    protected String content;
    protected String sender;
    protected Date timestamp;
    protected MessagePriority priority;
    
    public Message(MessageSender messageSender) {
        this.messageSender = messageSender;
        this.timestamp = new Date();
        this.priority = MessagePriority.NORMAL;
    }
    
    public abstract void send(String recipient);
    public abstract String formatMessage();
    
    // 通用方法
    public void setContent(String content) {
        this.content = content;
    }
    
    public void setSender(String sender) {
        this.sender = sender;
    }
    
    public void setPriority(MessagePriority priority) {
        this.priority = priority;
    }
    
    public String getProviderName() {
        return messageSender.getProviderName();
    }
    
    public boolean isProviderAvailable() {
        return messageSender.isAvailable();
    }
    
    protected String getPriorityPrefix() {
        switch (priority) {
            case HIGH: return "[紧急] ";
            case LOW: return "[普通] ";
            default: return "";
        }
    }
}

// 消息优先级枚举
enum MessagePriority {
    HIGH, NORMAL, LOW
}

// 扩展抽象类 - 通知消息
class NotificationMessage extends Message {
    private String title;
    private String category;
    
    public NotificationMessage(MessageSender messageSender) {
        super(messageSender);
        this.category = "系统通知";
    }
    
    @Override
    public void send(String recipient) {
        if (!messageSender.isAvailable()) {
            throw new IllegalStateException("消息发送器不可用: " + messageSender.getProviderName());
        }
        
        String formattedMessage = formatMessage();
        System.out.printf("发送通知消息 [%s]:%n", category);
        messageSender.sendMessage(formattedMessage, recipient);
    }
    
    @Override
    public String formatMessage() {
        StringBuilder sb = new StringBuilder();
        sb.append(getPriorityPrefix());
        if (title != null) {
            sb.append("标题: ").append(title).append("\n");
        }
        sb.append("内容: ").append(content).append("\n");
        sb.append("发送时间: ").append(timestamp).append("\n");
        if (sender != null) {
            sb.append("发送者: ").append(sender);
        }
        return sb.toString();
    }
    
    public void setTitle(String title) {
        this.title = title;
    }
    
    public void setCategory(String category) {
        this.category = category;
    }
}

// 扩展抽象类 - 营销消息
class MarketingMessage extends Message {
    private String campaignId;
    private String productName;
    private double discountRate;
    private Date expiryDate;
    
    public MarketingMessage(MessageSender messageSender) {
        super(messageSender);
    }
    
    @Override
    public void send(String recipient) {
        if (!messageSender.isAvailable()) {
            throw new IllegalStateException("消息发送器不可用: " + messageSender.getProviderName());
        }
        
        String formattedMessage = formatMessage();
        System.out.printf("发送营销消息 [活动ID: %s]:%n", campaignId);
        messageSender.sendMessage(formattedMessage, recipient);
    }
    
    @Override
    public String formatMessage() {
        StringBuilder sb = new StringBuilder();
        sb.append(getPriorityPrefix());
        sb.append("🎉 特惠活动通知 🎉\n");
        if (productName != null) {
            sb.append("产品: ").append(productName).append("\n");
        }
        if (discountRate > 0) {
            sb.append("折扣: ").append(String.format("%.0f%%", discountRate * 100)).append(" OFF\n");
        }
        sb.append("详情: ").append(content).append("\n");
        if (expiryDate != null) {
            sb.append("有效期至: ").append(expiryDate).append("\n");
        }
        sb.append("活动ID: ").append(campaignId);
        return sb.toString();
    }
    
    public void setCampaignId(String campaignId) {
        this.campaignId = campaignId;
    }
    
    public void setProductName(String productName) {
        this.productName = productName;
    }
    
    public void setDiscountRate(double discountRate) {
        this.discountRate = discountRate;
    }
    
    public void setExpiryDate(Date expiryDate) {
        this.expiryDate = expiryDate;
    }
}

// 扩展抽象类 - 警报消息
class AlertMessage extends Message {
    private AlertLevel alertLevel;
    private String systemName;
    private String errorCode;
    
    public AlertMessage(MessageSender messageSender) {
        super(messageSender);
        this.alertLevel = AlertLevel.WARNING;
        this.priority = MessagePriority.HIGH; // 警报消息默认高优先级
    }
    
    @Override
    public void send(String recipient) {
        if (!messageSender.isAvailable()) {
            throw new IllegalStateException("消息发送器不可用: " + messageSender.getProviderName());
        }
        
        String formattedMessage = formatMessage();
        System.out.printf("发送警报消息 [%s级别]:%n", alertLevel);
        messageSender.sendMessage(formattedMessage, recipient);
    }
    
    @Override
    public String formatMessage() {
        StringBuilder sb = new StringBuilder();
        sb.append(getAlertPrefix()).append(getPriorityPrefix());
        sb.append("系统警报\n");
        sb.append("级别: ").append(alertLevel).append("\n");
        if (systemName != null) {
            sb.append("系统: ").append(systemName).append("\n");
        }
        if (errorCode != null) {
            sb.append("错误代码: ").append(errorCode).append("\n");
        }
        sb.append("详情: ").append(content).append("\n");
        sb.append("时间: ").append(timestamp);
        return sb.toString();
    }
    
    private String getAlertPrefix() {
        switch (alertLevel) {
            case CRITICAL: return "🚨 [严重] ";
            case ERROR: return "❌ [错误] ";
            case WARNING: return "⚠️ [警告] ";
            default: return "ℹ️ [信息] ";
        }
    }
    
    public void setAlertLevel(AlertLevel alertLevel) {
        this.alertLevel = alertLevel;
    }
    
    public void setSystemName(String systemName) {
        this.systemName = systemName;
    }
    
    public void setErrorCode(String errorCode) {
        this.errorCode = errorCode;
    }
}

// 警报级别枚举
enum AlertLevel {
    INFO, WARNING, ERROR, CRITICAL
}

// 消息发送器工厂
class MessageSenderFactory {
    public static MessageSender createEmailSender() {
        EmailSender sender = new EmailSender();
        Map<String, String> config = new HashMap<>();
        config.put("smtp.server", "smtp.gmail.com");
        config.put("smtp.port", "587");
        config.put("smtp.username", "user@gmail.com");
        config.put("smtp.password", "password");
        sender.configure(config);
        return sender;
    }
    
    public static MessageSender createSMSSender() {
        SMSSender sender = new SMSSender();
        Map<String, String> config = new HashMap<>();
        config.put("sms.api.key", "your-api-key");
        config.put("sms.api.secret", "your-api-secret");
        config.put("sms.service.url", "https://api.sms-service.com");
        sender.configure(config);
        return sender;
    }
    
    public static MessageSender createWeChatSender() {
        WeChatSender sender = new WeChatSender();
        Map<String, String> config = new HashMap<>();
        config.put("wechat.app.id", "your-app-id");
        config.put("wechat.app.secret", "your-app-secret");
        config.put("wechat.access.token", "your-access-token");
        sender.configure(config);
        return sender;
    }
}

// 使用示例
public class MessageBridgeExample {
    public static void main(String[] args) {
        System.out.println("=== 桥接模式消息发送系统 ===");
        
        // 创建不同的消息发送器
        MessageSender emailSender = MessageSenderFactory.createEmailSender();
        MessageSender smsSender = MessageSenderFactory.createSMSSender();
        MessageSender wechatSender = MessageSenderFactory.createWeChatSender();
        
        // 发送通知消息
        System.out.println("\n--- 发送通知消息 ---");
        NotificationMessage notification = new NotificationMessage(emailSender);
        notification.setTitle("系统维护通知");
        notification.setContent("系统将于今晚22:00-24:00进行维护，期间服务可能中断。");
        notification.setSender("系统管理员");
        notification.setPriority(MessagePriority.HIGH);
        notification.send("user@example.com");
        
        // 使用不同发送器发送相同通知
        NotificationMessage smsNotification = new NotificationMessage(smsSender);
        smsNotification.setTitle("系统维护通知");
        smsNotification.setContent("系统维护中，请稍后访问。");
        smsNotification.setPriority(MessagePriority.HIGH);
        smsNotification.send("13800138000");
        
        // 发送营销消息
        System.out.println("\n--- 发送营销消息 ---");
        MarketingMessage marketing = new MarketingMessage(wechatSender);
        marketing.setCampaignId("SUMMER2024");
        marketing.setProductName("夏季新品");
        marketing.setDiscountRate(0.3);
        marketing.setExpiryDate(new Date(System.currentTimeMillis() + 7 * 24 * 60 * 60 * 1000L));
        marketing.setContent("夏季新品大促销，全场7折优惠，限时7天！");
        marketing.setPriority(MessagePriority.NORMAL);
        marketing.send("wechat_user_123");
        
        // 发送警报消息
        System.out.println("\n--- 发送警报消息 ---");
        AlertMessage alert = new AlertMessage(emailSender);
        alert.setAlertLevel(AlertLevel.CRITICAL);
        alert.setSystemName("订单处理系统");
        alert.setErrorCode("SYS_001");
        alert.setContent("数据库连接失败，订单处理服务已停止");
        alert.setSender("监控系统");
        alert.send("admin@example.com");
        
        // 演示桥接模式的灵活性 - 运行时切换实现
        System.out.println("\n--- 运行时切换发送器 ---");
        List<MessageSender> senders = Arrays.asList(emailSender, smsSender, wechatSender);
        
        NotificationMessage flexibleNotification = new NotificationMessage(emailSender);
        flexibleNotification.setTitle("多渠道通知测试");
        flexibleNotification.setContent("这是一条测试消息，将通过不同渠道发送");
        
        for (MessageSender sender : senders) {
            // 运行时切换实现
            flexibleNotification = new NotificationMessage(sender);
            flexibleNotification.setTitle("多渠道通知测试");
            flexibleNotification.setContent("通过 " + sender.getProviderName() + " 发送的测试消息");
            
            String recipient = getRecipientForSender(sender);
            flexibleNotification.send(recipient);
        }
    }
    
    private static String getRecipientForSender(MessageSender sender) {
        switch (sender.getProviderName()) {
            case "Email": return "test@example.com";
            case "SMS": return "13800138000";
            case "WeChat": return "wechat_test_user";
            default: return "unknown";
        }
    }
}
```

**桥接模式的关键特点：**
1. **分离抽象和实现**: 抽象和实现可以独立变化
2. **运行时绑定**: 可以在运行时选择具体的实现
3. **避免永久绑定**: 抽象和实现之间没有永久的绑定关系
4. **扩展性好**: 可以独立扩展抽象层次和实现层次
5. **隐藏实现细节**: 客户端代码不需要了解具体的实现细节

#### 参与者概念
- **抽象类**：定义抽象接口，维护实现对象的引用
- **扩展抽象类**：扩展抽象接口
- **实现接口**：定义实现类的接口
- **具体实现类**：实现具体的实现接口

### 3. 组合模式 (Composite)

#### 核心概念
- **组合**：将对象组合成树形结构表示部分-整体层次
- **组件**：组合中对象的统一接口
- **叶子**：组合中的叶子节点
- **容器**：组合中的容器节点
- **递归结构**：树形结构的递归特性

#### 基础例子：文件系统结构
```java
// 组件接口 - 文件系统组件
abstract class FileSystemComponent {
    protected String name;
    
    public FileSystemComponent(String name) {
        this.name = name;
    }
    
    public String getName() {
        return name;
    }
    
    // 公共操作
    public abstract void display(int depth);
    public abstract long getSize();
    
    // 容器操作 - 默认抛出异常，只有容器类重写
    public void add(FileSystemComponent component) {
        throw new UnsupportedOperationException("不支持添加操作");
    }
    
    public void remove(FileSystemComponent component) {
        throw new UnsupportedOperationException("不支持删除操作");
    }
    
    public FileSystemComponent getChild(int index) {
        throw new UnsupportedOperationException("不支持获取子组件操作");
    }
    
    protected String getIndent(int depth) {
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < depth; i++) {
            sb.append("  ");
        }
        return sb.toString();
    }
}

// 叶子组件 - 文件
class File extends FileSystemComponent {
    private long size;
    private String extension;
    
    public File(String name, long size) {
        super(name);
        this.size = size;
        this.extension = getFileExtension(name);
    }
    
    @Override
    public void display(int depth) {
        System.out.printf("%s📄 %s (%d bytes)%n", getIndent(depth), name, size);
    }
    
    @Override
    public long getSize() {
        return size;
    }
    
    public String getExtension() {
        return extension;
    }
    
    private String getFileExtension(String fileName) {
        int lastDot = fileName.lastIndexOf('.');
        return lastDot > 0 ? fileName.substring(lastDot + 1) : "";
    }
}

// 容器组件 - 目录
class Directory extends FileSystemComponent {
    private List<FileSystemComponent> children;
    
    public Directory(String name) {
        super(name);
        this.children = new ArrayList<>();
    }
    
    @Override
    public void add(FileSystemComponent component) {
        children.add(component);
    }
    
    @Override
    public void remove(FileSystemComponent component) {
        children.remove(component);
    }
    
    @Override
    public FileSystemComponent getChild(int index) {
        if (index >= 0 && index < children.size()) {
            return children.get(index);
        }
        throw new IndexOutOfBoundsException("索引超出范围: " + index);
    }
    
    @Override
    public void display(int depth) {
        System.out.printf("%s📁 %s/ (%d items, %d bytes total)%n", 
                         getIndent(depth), name, children.size(), getSize());
        
        // 递归显示子组件
        for (FileSystemComponent child : children) {
            child.display(depth + 1);
        }
    }
    
    @Override
    public long getSize() {
        long totalSize = 0;
        for (FileSystemComponent child : children) {
            totalSize += child.getSize();
        }
        return totalSize;
    }
    
    public int getChildCount() {
        return children.size();
    }
    
    public List<FileSystemComponent> getChildren() {
        return new ArrayList<>(children);
    }
    
    // 查找文件
    public List<File> findFiles(String extension) {
        List<File> result = new ArrayList<>();
        findFilesRecursive(extension, result);
        return result;
    }
    
    private void findFilesRecursive(String extension, List<File> result) {
        for (FileSystemComponent child : children) {
            if (child instanceof File) {
                File file = (File) child;
                if (extension == null || extension.equals(file.getExtension())) {
                    result.add(file);
                }
            } else if (child instanceof Directory) {
                ((Directory) child).findFilesRecursive(extension, result);
            }
        }
    }
}

// 使用示例
public class CompositeExample {
    public static void main(String[] args) {
        // 创建根目录
        Directory root = new Directory("root");
        
        // 创建子目录
        Directory documents = new Directory("Documents");
        Directory pictures = new Directory("Pictures");
        Directory music = new Directory("Music");
        
        // 创建文件
        File readme = new File("README.txt", 1024);
        File config = new File("config.json", 512);
        
        File photo1 = new File("vacation.jpg", 2048000);
        File photo2 = new File("family.png", 1536000);
        
        File song1 = new File("favorite.mp3", 4096000);
        File song2 = new File("classical.wav", 8192000);
        
        // 构建文件系统树
        root.add(readme);
        root.add(config);
        root.add(documents);
        root.add(pictures);
        root.add(music);
        
        documents.add(new File("report.docx", 256000));
        documents.add(new File("presentation.pptx", 512000));
        
        pictures.add(photo1);
        pictures.add(photo2);
        
        music.add(song1);
        music.add(song2);
        
        // 显示文件系统结构
        System.out.println("=== 文件系统结构 ===");
        root.display(0);
        
        // 查找特定类型的文件
        System.out.println("\n=== 查找图片文件 ===");
        List<File> imageFiles = root.findFiles("jpg");
        imageFiles.addAll(root.findFiles("png"));
        
        for (File file : imageFiles) {
            System.out.println("找到图片: " + file.getName() + " (" + file.getSize() + " bytes)");
        }
        
        // 统计信息
        System.out.println("\n=== 统计信息 ===");
        System.out.println("总大小: " + root.getSize() + " bytes");
        System.out.println("Documents目录大小: " + documents.getSize() + " bytes");
        System.out.println("Pictures目录大小: " + pictures.getSize() + " bytes");
        System.out.println("Music目录大小: " + music.getSize() + " bytes");
    }
}
```

#### 进阶例子：企业组织架构系统
```java
import java.util.*;
import java.util.stream.Collectors;

// 组件接口 - 组织单元
abstract class OrganizationUnit {
    protected String name;
    protected String code;
    protected String description;
    protected Date createdDate;
    protected boolean active;
    
    public OrganizationUnit(String name, String code, String description) {
        this.name = name;
        this.code = code;
        this.description = description;
        this.createdDate = new Date();
        this.active = true;
    }
    
    // 公共方法
    public abstract void display(int depth);
    public abstract int getEmployeeCount();
    public abstract double getTotalSalary();
    public abstract List<Employee> getAllEmployees();
    public abstract void accept(OrganizationVisitor visitor);
    
    // 容器方法 - 默认实现
    public void add(OrganizationUnit unit) {
        throw new UnsupportedOperationException("不支持添加子单元");
    }
    
    public void remove(OrganizationUnit unit) {
        throw new UnsupportedOperationException("不支持删除子单元");
    }
    
    public List<OrganizationUnit> getChildren() {
        return Collections.emptyList();
    }
    
    public OrganizationUnit findByCode(String code) {
        return this.code.equals(code) ? this : null;
    }
    
    // Getter方法
    public String getName() { return name; }
    public String getCode() { return code; }
    public String getDescription() { return description; }
    public Date getCreatedDate() { return createdDate; }
    public boolean isActive() { return active; }
    public void setActive(boolean active) { this.active = active; }
    
    protected String getIndent(int depth) {
        return "  ".repeat(depth);
    }
}

// 叶子组件 - 员工
class Employee extends OrganizationUnit {
    private String position;
    private double salary;
    private String email;
    private String phone;
    private EmployeeLevel level;
    private Date hireDate;
    private Employee manager;
    
    public Employee(String name, String code, String position, double salary) {
        super(name, code, "员工: " + name);
        this.position = position;
        this.salary = salary;
        this.level = EmployeeLevel.JUNIOR;
        this.hireDate = new Date();
    }
    
    @Override
    public void display(int depth) {
        String status = active ? "在职" : "离职";
        System.out.printf("%s👤 %s (%s) - %s - ¥%.2f - %s%n", 
                         getIndent(depth), name, code, position, salary, status);
    }
    
    @Override
    public int getEmployeeCount() {
        return active ? 1 : 0;
    }
    
    @Override
    public double getTotalSalary() {
        return active ? salary : 0;
    }
    
    @Override
    public List<Employee> getAllEmployees() {
        return active ? Arrays.asList(this) : Collections.emptyList();
    }
    
    @Override
    public void accept(OrganizationVisitor visitor) {
        visitor.visitEmployee(this);
    }
    
    // Getter和Setter方法
    public String getPosition() { return position; }
    public void setPosition(String position) { this.position = position; }
    public double getSalary() { return salary; }
    public void setSalary(double salary) { this.salary = salary; }
    public String getEmail() { return email; }
    public void setEmail(String email) { this.email = email; }
    public String getPhone() { return phone; }
    public void setPhone(String phone) { this.phone = phone; }
    public EmployeeLevel getLevel() { return level; }
    public void setLevel(EmployeeLevel level) { this.level = level; }
    public Date getHireDate() { return hireDate; }
    public Employee getManager() { return manager; }
    public void setManager(Employee manager) { this.manager = manager; }
}

// 员工级别枚举
enum EmployeeLevel {
    INTERN("实习生"), JUNIOR("初级"), SENIOR("高级"), LEAD("主管"), MANAGER("经理"), DIRECTOR("总监");
    
    private String displayName;
    
    EmployeeLevel(String displayName) {
        this.displayName = displayName;
    }
    
    public String getDisplayName() {
        return displayName;
    }
}

// 容器组件 - 部门
class Department extends OrganizationUnit {
    private List<OrganizationUnit> children;
    private Employee manager;
    private String location;
    private double budget;
    private DepartmentType type;
    
    public Department(String name, String code, String description, DepartmentType type) {
        super(name, code, description);
        this.children = new ArrayList<>();
        this.type = type;
        this.budget = 0.0;
    }
    
    @Override
    public void add(OrganizationUnit unit) {
        children.add(unit);
    }
    
    @Override
    public void remove(OrganizationUnit unit) {
        children.remove(unit);
    }
    
    @Override
    public List<OrganizationUnit> getChildren() {
        return new ArrayList<>(children);
    }
    
    @Override
    public OrganizationUnit findByCode(String code) {
        if (this.code.equals(code)) {
            return this;
        }
        
        for (OrganizationUnit child : children) {
            OrganizationUnit found = child.findByCode(code);
            if (found != null) {
                return found;
            }
        }
        return null;
    }
    
    @Override
    public void display(int depth) {
        String managerInfo = manager != null ? " (负责人: " + manager.getName() + ")" : "";
        System.out.printf("%s🏢 %s (%s) - %s - %d个子单元 - 预算: ¥%.2f%s%n", 
                         getIndent(depth), name, code, type.getDisplayName(), 
                         children.size(), budget, managerInfo);
        
        // 递归显示子单元
        for (OrganizationUnit child : children) {
            child.display(depth + 1);
        }
    }
    
    @Override
    public int getEmployeeCount() {
        if (!active) return 0;
        
        int count = 0;
        for (OrganizationUnit child : children) {
            count += child.getEmployeeCount();
        }
        return count;
    }
    
    @Override
    public double getTotalSalary() {
        if (!active) return 0;
        
        double total = 0;
        for (OrganizationUnit child : children) {
            total += child.getTotalSalary();
        }
        return total;
    }
    
    @Override
    public List<Employee> getAllEmployees() {
        if (!active) return Collections.emptyList();
        
        List<Employee> allEmployees = new ArrayList<>();
        for (OrganizationUnit child : children) {
            allEmployees.addAll(child.getAllEmployees());
        }
        return allEmployees;
    }
    
    @Override
    public void accept(OrganizationVisitor visitor) {
        visitor.visitDepartment(this);
        for (OrganizationUnit child : children) {
            child.accept(visitor);
        }
    }
    
    // 部门特有方法
    public List<Employee> getEmployeesByLevel(EmployeeLevel level) {
        return getAllEmployees().stream()
                .filter(emp -> emp.getLevel() == level)
                .collect(Collectors.toList());
    }
    
    public List<Employee> getEmployeesByPosition(String position) {
        return getAllEmployees().stream()
                .filter(emp -> emp.getPosition().contains(position))
                .collect(Collectors.toList());
    }
    
    public double getAverageSalary() {
        List<Employee> employees = getAllEmployees();
        if (employees.isEmpty()) return 0;
        
        return employees.stream()
                .mapToDouble(Employee::getSalary)
                .average()
                .orElse(0);
    }
    
    // Getter和Setter方法
    public Employee getManager() { return manager; }
    public void setManager(Employee manager) { this.manager = manager; }
    public String getLocation() { return location; }
    public void setLocation(String location) { this.location = location; }
    public double getBudget() { return budget; }
    public void setBudget(double budget) { this.budget = budget; }
    public DepartmentType getType() { return type; }
}

// 部门类型枚举
enum DepartmentType {
    HEADQUARTERS("总部"), BRANCH("分公司"), DIVISION("事业部"), 
    DEPARTMENT("部门"), TEAM("团队"), PROJECT_GROUP("项目组");
    
    private String displayName;
    
    DepartmentType(String displayName) {
        this.displayName = displayName;
    }
    
    public String getDisplayName() {
        return displayName;
    }
}

// 访问者接口 - 用于遍历组织结构
interface OrganizationVisitor {
    void visitEmployee(Employee employee);
    void visitDepartment(Department department);
}

// 具体访问者 - 统计访问者
class StatisticsVisitor implements OrganizationVisitor {
    private int totalEmployees = 0;
    private int totalDepartments = 0;
    private double totalSalary = 0;
    private Map<EmployeeLevel, Integer> levelCount = new HashMap<>();
    private Map<DepartmentType, Integer> departmentTypeCount = new HashMap<>();
    
    @Override
    public void visitEmployee(Employee employee) {
        if (employee.isActive()) {
            totalEmployees++;
            totalSalary += employee.getSalary();
            levelCount.merge(employee.getLevel(), 1, Integer::sum);
        }
    }
    
    @Override
    public void visitDepartment(Department department) {
        if (department.isActive()) {
            totalDepartments++;
            departmentTypeCount.merge(department.getType(), 1, Integer::sum);
        }
    }
    
    public void printStatistics() {
        System.out.println("=== 组织统计信息 ===");
        System.out.println("总员工数: " + totalEmployees);
        System.out.println("总部门数: " + totalDepartments);
        System.out.printf("总薪资: ¥%.2f%n", totalSalary);
        System.out.printf("平均薪资: ¥%.2f%n", totalEmployees > 0 ? totalSalary / totalEmployees : 0);
        
        System.out.println("\n员工级别分布:");
        levelCount.forEach((level, count) -> 
            System.out.println("  " + level.getDisplayName() + ": " + count + "人"));
        
        System.out.println("\n部门类型分布:");
        departmentTypeCount.forEach((type, count) -> 
            System.out.println("  " + type.getDisplayName() + ": " + count + "个"));
    }
}

// 具体访问者 - 报告生成器
class ReportVisitor implements OrganizationVisitor {
    private StringBuilder report = new StringBuilder();
    private int depth = 0;
    
    @Override
    public void visitEmployee(Employee employee) {
        report.append("  ".repeat(depth))
              .append("员工: ").append(employee.getName())
              .append(" (").append(employee.getPosition()).append(")")
              .append(" - ¥").append(employee.getSalary())
              .append("\n");
    }
    
    @Override
    public void visitDepartment(Department department) {
        report.append("  ".repeat(depth))
              .append("部门: ").append(department.getName())
              .append(" (").append(department.getCode()).append(")")
              .append(" - ").append(department.getType().getDisplayName())
              .append("\n");
        depth++;
        
        // 访问完子节点后恢复深度
        // 注意：这里简化处理，实际应该在访问完所有子节点后恢复
    }
    
    public String getReport() {
        return report.toString();
    }
}

// 使用示例
public class OrganizationCompositeExample {
    public static void main(String[] args) {
        // 创建公司组织架构
        Department company = new Department("科技有限公司", "COMP001", "一家创新的科技公司", DepartmentType.HEADQUARTERS);
        company.setBudget(10000000);
        
        // 创建一级部门
        Department techDept = new Department("技术部", "TECH001", "负责产品研发", DepartmentType.DEPARTMENT);
        Department salesDept = new Department("销售部", "SALES001", "负责市场销售", DepartmentType.DEPARTMENT);
        Department hrDept = new Department("人力资源部", "HR001", "负责人力资源管理", DepartmentType.DEPARTMENT);
        
        // 创建技术部子部门
        Department devTeam = new Department("开发团队", "DEV001", "软件开发团队", DepartmentType.TEAM);
        Department qaTeam = new Department("测试团队", "QA001", "质量保证团队", DepartmentType.TEAM);
        
        // 创建员工
        Employee ceo = new Employee("张总", "CEO001", "首席执行官", 50000);
        ceo.setLevel(EmployeeLevel.DIRECTOR);
        
        Employee techManager = new Employee("李经理", "TM001", "技术经理", 25000);
        techManager.setLevel(EmployeeLevel.MANAGER);
        
        Employee dev1 = new Employee("王开发", "DEV001", "高级开发工程师", 15000);
        dev1.setLevel(EmployeeLevel.SENIOR);
        
        Employee dev2 = new Employee("赵开发", "DEV002", "初级开发工程师", 8000);
        dev2.setLevel(EmployeeLevel.JUNIOR);
        
        Employee qa1 = new Employee("钱测试", "QA001", "测试工程师", 12000);
        qa1.setLevel(EmployeeLevel.SENIOR);
        
        Employee sales1 = new Employee("孙销售", "SALES001", "销售经理", 18000);
        sales1.setLevel(EmployeeLevel.MANAGER);
        
        Employee hr1 = new Employee("周人事", "HR001", "人事专员", 10000);
        hr1.setLevel(EmployeeLevel.JUNIOR);
        
        // 构建组织架构树
        company.add(ceo);
        company.add(techDept);
        company.add(salesDept);
        company.add(hrDept);
        
        techDept.add(techManager);
        techDept.add(devTeam);
        techDept.add(qaTeam);
        techDept.setManager(techManager);
        
        devTeam.add(dev1);
        devTeam.add(dev2);
        
        qaTeam.add(qa1);
        
        salesDept.add(sales1);
        salesDept.setManager(sales1);
        
        hrDept.add(hr1);
        
        // 显示组织架构
        System.out.println("=== 公司组织架构 ===");
        company.display(0);
        
        // 统计信息
        System.out.println("\n=== 基本统计 ===");
        System.out.println("总员工数: " + company.getEmployeeCount());
        System.out.printf("总薪资支出: ¥%.2f%n", company.getTotalSalary());
        System.out.printf("技术部员工数: %d%n", techDept.getEmployeeCount());
        System.out.printf("技术部平均薪资: ¥%.2f%n", techDept.getAverageSalary());
        
        // 查找功能
        System.out.println("\n=== 查找功能 ===");
        OrganizationUnit found = company.findByCode("DEV001");
        if (found != null) {
            System.out.println("找到单元: " + found.getName() + " (" + found.getCode() + ")");
        }
        
        // 按级别查找员工
        List<Employee> managers = techDept.getEmployeesByLevel(EmployeeLevel.MANAGER);
        System.out.println("技术部经理级别员工:");
        managers.forEach(emp -> System.out.println("  " + emp.getName() + " - " + emp.getPosition()));
        
        // 按职位查找员工
        List<Employee> developers = company.getAllEmployees().stream()
                .filter(emp -> emp.getPosition().contains("开发"))
                .collect(Collectors.toList());
        System.out.println("所有开发人员:");
        developers.forEach(emp -> System.out.println("  " + emp.getName() + " - " + emp.getPosition()));
        
        // 使用访问者模式进行统计
        System.out.println("\n=== 访问者模式统计 ===");
        StatisticsVisitor statsVisitor = new StatisticsVisitor();
        company.accept(statsVisitor);
        statsVisitor.printStatistics();
        
        // 生成报告
        System.out.println("\n=== 组织架构报告 ===");
        ReportVisitor reportVisitor = new ReportVisitor();
        company.accept(reportVisitor);
        System.out.println(reportVisitor.getReport());
        
        // 演示动态修改
        System.out.println("\n=== 动态修改演示 ===");
        
        // 添加新员工
        Employee newDev = new Employee("新开发", "DEV003", "中级开发工程师", 12000);
        newDev.setLevel(EmployeeLevel.SENIOR);
        devTeam.add(newDev);
        
        // 员工离职
        dev2.setActive(false);
        
        System.out.println("修改后的开发团队:");
        devTeam.display(0);
        
        System.out.println("修改后技术部统计:");
        System.out.println("员工数: " + techDept.getEmployeeCount());
        System.out.printf("总薪资: ¥%.2f%n", techDept.getTotalSalary());
    }
}
```

**组合模式的关键特点：**
1. **统一接口**: 叶子和容器对象实现相同的接口
2. **递归结构**: 支持任意深度的树形结构
3. **透明性**: 客户端可以一致地处理叶子和容器对象
4. **灵活性**: 可以动态地添加、删除和修改树形结构
5. **简化客户端**: 客户端不需要区分叶子和容器对象

#### 实现概念
- **透明方式**：组件接口包含所有子组件管理方法
- **安全方式**：组件接口只包含公共方法
- **树形遍历**：遍历组合结构的方法

### 4. 装饰器模式 (Decorator)

#### 核心概念
- **装饰器**：动态地给对象添加额外的职责
- **组件**：定义对象的接口
- **装饰**：在不改变接口的前提下扩展功能
- **装饰链**：多个装饰器的组合

#### 基础例子：咖啡订购系统
```java
// 组件接口 - 饮品
interface Beverage {
    String getDescription();
    double getCost();
}

// 具体组件 - 基础咖啡
class Espresso implements Beverage {
    @Override
    public String getDescription() {
        return "浓缩咖啡";
    }
    
    @Override
    public double getCost() {
        return 15.0;
    }
}

class HouseBlend implements Beverage {
    @Override
    public String getDescription() {
        return "综合咖啡";
    }
    
    @Override
    public double getCost() {
        return 12.0;
    }
}

class DarkRoast implements Beverage {
    @Override
    public String getDescription() {
        return "深度烘焙咖啡";
    }
    
    @Override
    public double getCost() {
        return 18.0;
    }
}

// 抽象装饰器
abstract class CondimentDecorator implements Beverage {
    protected Beverage beverage;
    
    public CondimentDecorator(Beverage beverage) {
        this.beverage = beverage;
    }
    
    @Override
    public abstract String getDescription();
}

// 具体装饰器 - 牛奶
class Milk extends CondimentDecorator {
    public Milk(Beverage beverage) {
        super(beverage);
    }
    
    @Override
    public String getDescription() {
        return beverage.getDescription() + " + 牛奶";
    }
    
    @Override
    public double getCost() {
        return beverage.getCost() + 3.0;
    }
}

// 具体装饰器 - 豆浆
class Soy extends CondimentDecorator {
    public Soy(Beverage beverage) {
        super(beverage);
    }
    
    @Override
    public String getDescription() {
        return beverage.getDescription() + " + 豆浆";
    }
    
    @Override
    public double getCost() {
        return beverage.getCost() + 4.0;
    }
}

// 具体装饰器 - 摩卡
class Mocha extends CondimentDecorator {
    public Mocha(Beverage beverage) {
        super(beverage);
    }
    
    @Override
    public String getDescription() {
        return beverage.getDescription() + " + 摩卡";
    }
    
    @Override
    public double getCost() {
        return beverage.getCost() + 5.0;
    }
}

// 具体装饰器 - 奶泡
class Whip extends CondimentDecorator {
    public Whip(Beverage beverage) {
        super(beverage);
    }
    
    @Override
    public String getDescription() {
        return beverage.getDescription() + " + 奶泡";
    }
    
    @Override
    public double getCost() {
        return beverage.getCost() + 2.0;
    }
}

// 使用示例
public class DecoratorExample {
    public static void main(String[] args) {
        // 订购一杯浓缩咖啡
        Beverage beverage1 = new Espresso();
        System.out.println(beverage1.getDescription() + " ¥" + beverage1.getCost());
        
        // 订购一杯深度烘焙咖啡，加牛奶和摩卡
        Beverage beverage2 = new DarkRoast();
        beverage2 = new Milk(beverage2);
        beverage2 = new Mocha(beverage2);
        System.out.println(beverage2.getDescription() + " ¥" + beverage2.getCost());
        
        // 订购一杯综合咖啡，加豆浆、摩卡和奶泡
        Beverage beverage3 = new HouseBlend();
        beverage3 = new Soy(beverage3);
        beverage3 = new Mocha(beverage3);
        beverage3 = new Whip(beverage3);
        System.out.println(beverage3.getDescription() + " ¥" + beverage3.getCost());
        
        // 订购一杯浓缩咖啡，加双份摩卡
        Beverage beverage4 = new Espresso();
        beverage4 = new Mocha(beverage4);
        beverage4 = new Mocha(beverage4); // 双份摩卡
        beverage4 = new Whip(beverage4);
        System.out.println(beverage4.getDescription() + " ¥" + beverage4.getCost());
    }
}
```

#### 进阶例子：数据处理管道系统
```java
import java.util.*;
import java.util.function.Function;
import java.util.stream.Collectors;

// 组件接口 - 数据处理器
interface DataProcessor<T> {
    T process(T data);
    String getProcessorName();
    Map<String, Object> getMetrics();
}

// 具体组件 - 基础数据处理器
class BaseDataProcessor implements DataProcessor<String> {
    private long processCount = 0;
    private long totalProcessTime = 0;
    
    @Override
    public String process(String data) {
        long startTime = System.nanoTime();
        processCount++;
        
        // 基础处理：去除首尾空格
        String result = data != null ? data.trim() : "";
        
        long endTime = System.nanoTime();
        totalProcessTime += (endTime - startTime);
        
        return result;
    }
    
    @Override
    public String getProcessorName() {
        return "基础数据处理器";
    }
    
    @Override
    public Map<String, Object> getMetrics() {
        Map<String, Object> metrics = new HashMap<>();
        metrics.put("processCount", processCount);
        metrics.put("averageProcessTime", processCount > 0 ? totalProcessTime / processCount : 0);
        return metrics;
    }
}

// 抽象装饰器
abstract class DataProcessorDecorator implements DataProcessor<String> {
    protected DataProcessor<String> processor;
    protected long processCount = 0;
    protected long totalProcessTime = 0;
    
    public DataProcessorDecorator(DataProcessor<String> processor) {
        this.processor = processor;
    }
    
    @Override
    public String process(String data) {
        long startTime = System.nanoTime();
        processCount++;
        
        // 先调用被装饰对象的处理方法
        String result = processor.process(data);
        
        // 然后进行装饰处理
        result = doDecorate(result);
        
        long endTime = System.nanoTime();
        totalProcessTime += (endTime - startTime);
        
        return result;
    }
    
    protected abstract String doDecorate(String data);
    
    @Override
    public Map<String, Object> getMetrics() {
        Map<String, Object> metrics = new HashMap<>(processor.getMetrics());
        metrics.put(getProcessorName() + "_processCount", processCount);
        metrics.put(getProcessorName() + "_averageProcessTime", 
                   processCount > 0 ? totalProcessTime / processCount : 0);
        return metrics;
    }
}

// 具体装饰器 - 大小写转换装饰器
class CaseConverterDecorator extends DataProcessorDecorator {
    private CaseType caseType;
    
    public enum CaseType {
        UPPER, LOWER, TITLE
    }
    
    public CaseConverterDecorator(DataProcessor<String> processor, CaseType caseType) {
        super(processor);
        this.caseType = caseType;
    }
    
    @Override
    protected String doDecorate(String data) {
        if (data == null || data.isEmpty()) {
            return data;
        }
        
        switch (caseType) {
            case UPPER:
                return data.toUpperCase();
            case LOWER:
                return data.toLowerCase();
            case TITLE:
                return Arrays.stream(data.split("\\s+"))
                        .map(word -> word.substring(0, 1).toUpperCase() + 
                                   word.substring(1).toLowerCase())
                        .collect(Collectors.joining(" "));
            default:
                return data;
        }
    }
    
    @Override
    public String getProcessorName() {
        return "大小写转换装饰器(" + caseType + ")";
    }
}

// 具体装饰器 - 数据验证装饰器
class ValidationDecorator extends DataProcessorDecorator {
    private List<Function<String, Boolean>> validators;
    private String defaultValue;
    
    public ValidationDecorator(DataProcessor<String> processor, String defaultValue) {
        super(processor);
        this.validators = new ArrayList<>();
        this.defaultValue = defaultValue;
    }
    
    public ValidationDecorator addValidator(Function<String, Boolean> validator) {
        validators.add(validator);
        return this;
    }
    
    @Override
    protected String doDecorate(String data) {
        // 验证数据
        for (Function<String, Boolean> validator : validators) {
            if (!validator.apply(data)) {
                System.out.println("数据验证失败，使用默认值: " + defaultValue);
                return defaultValue;
            }
        }
        return data;
    }
    
    @Override
    public String getProcessorName() {
        return "数据验证装饰器";
    }
}

// 具体装饰器 - 数据清洗装饰器
class DataCleaningDecorator extends DataProcessorDecorator {
    private boolean removeSpecialChars;
    private boolean removeNumbers;
    private boolean removeExtraSpaces;
    
    public DataCleaningDecorator(DataProcessor<String> processor) {
        super(processor);
        this.removeSpecialChars = false;
        this.removeNumbers = false;
        this.removeExtraSpaces = true;
    }
    
    public DataCleaningDecorator removeSpecialChars(boolean remove) {
        this.removeSpecialChars = remove;
        return this;
    }
    
    public DataCleaningDecorator removeNumbers(boolean remove) {
        this.removeNumbers = remove;
        return this;
    }
    
    public DataCleaningDecorator removeExtraSpaces(boolean remove) {
        this.removeExtraSpaces = remove;
        return this;
    }
    
    @Override
    protected String doDecorate(String data) {
        if (data == null || data.isEmpty()) {
            return data;
        }
        
        String result = data;
        
        if (removeSpecialChars) {
            result = result.replaceAll("[^a-zA-Z0-9\\s]", "");
        }
        
        if (removeNumbers) {
            result = result.replaceAll("\\d", "");
        }
        
        if (removeExtraSpaces) {
            result = result.replaceAll("\\s+", " ");
        }
        
        return result;
    }
    
    @Override
    public String getProcessorName() {
        return "数据清洗装饰器";
    }
}

// 具体装饰器 - 日志记录装饰器
class LoggingDecorator extends DataProcessorDecorator {
    private String logLevel;
    private boolean logInput;
    private boolean logOutput;
    private boolean logProcessTime;
    
    public LoggingDecorator(DataProcessor<String> processor, String logLevel) {
        super(processor);
        this.logLevel = logLevel;
        this.logInput = true;
        this.logOutput = true;
        this.logProcessTime = true;
    }
    
    public LoggingDecorator setLogInput(boolean logInput) {
        this.logInput = logInput;
        return this;
    }
    
    public LoggingDecorator setLogOutput(boolean logOutput) {
        this.logOutput = logOutput;
        return this;
    }
    
    public LoggingDecorator setLogProcessTime(boolean logProcessTime) {
        this.logProcessTime = logProcessTime;
        return this;
    }
    
    @Override
    public String process(String data) {
        long startTime = System.nanoTime();
        
        if (logInput) {
            System.out.printf("[%s] 输入数据: '%s'%n", logLevel, data);
        }
        
        String result = super.process(data);
        
        long endTime = System.nanoTime();
        long processTime = endTime - startTime;
        
        if (logOutput) {
            System.out.printf("[%s] 输出数据: '%s'%n", logLevel, result);
        }
        
        if (logProcessTime) {
            System.out.printf("[%s] 处理时间: %d ns%n", logLevel, processTime);
        }
        
        return result;
    }
    
    @Override
    protected String doDecorate(String data) {
        // 日志装饰器不修改数据，只记录日志
        return data;
    }
    
    @Override
    public String getProcessorName() {
        return "日志记录装饰器(" + logLevel + ")";
    }
}

// 具体装饰器 - 缓存装饰器
class CacheDecorator extends DataProcessorDecorator {
    private Map<String, String> cache;
    private int maxCacheSize;
    private long cacheHits = 0;
    private long cacheMisses = 0;
    
    public CacheDecorator(DataProcessor<String> processor, int maxCacheSize) {
        super(processor);
        this.cache = new LinkedHashMap<String, String>(maxCacheSize + 1, 0.75f, true) {
            @Override
            protected boolean removeEldestEntry(Map.Entry<String, String> eldest) {
                return size() > maxCacheSize;
            }
        };
        this.maxCacheSize = maxCacheSize;
    }
    
    @Override
    public String process(String data) {
        // 检查缓存
        if (cache.containsKey(data)) {
            cacheHits++;
            System.out.println("缓存命中: " + data);
            return cache.get(data);
        }
        
        // 缓存未命中，调用实际处理
        cacheMisses++;
        String result = super.process(data);
        
        // 将结果放入缓存
        cache.put(data, result);
        
        return result;
    }
    
    @Override
    protected String doDecorate(String data) {
        // 缓存装饰器不修改数据
        return data;
    }
    
    @Override
    public String getProcessorName() {
        return "缓存装饰器";
    }
    
    @Override
    public Map<String, Object> getMetrics() {
        Map<String, Object> metrics = super.getMetrics();
        metrics.put("cacheHits", cacheHits);
        metrics.put("cacheMisses", cacheMisses);
        metrics.put("cacheHitRate", (cacheHits + cacheMisses) > 0 ? 
                   (double) cacheHits / (cacheHits + cacheMisses) : 0);
        metrics.put("cacheSize", cache.size());
        return metrics;
    }
    
    public void clearCache() {
        cache.clear();
        cacheHits = 0;
        cacheMisses = 0;
    }
}

// 数据处理管道构建器
class DataProcessingPipelineBuilder {
    private DataProcessor<String> processor;
    
    public DataProcessingPipelineBuilder(DataProcessor<String> baseProcessor) {
        this.processor = baseProcessor;
    }
    
    public DataProcessingPipelineBuilder addValidation(String defaultValue) {
        processor = new ValidationDecorator(processor, defaultValue);
        return this;
    }
    
    public DataProcessingPipelineBuilder addValidation(String defaultValue, 
                                                      Function<String, Boolean> validator) {
        ValidationDecorator validationDecorator = new ValidationDecorator(processor, defaultValue);
        validationDecorator.addValidator(validator);
        processor = validationDecorator;
        return this;
    }
    
    public DataProcessingPipelineBuilder addCleaning() {
        processor = new DataCleaningDecorator(processor);
        return this;
    }
    
    public DataProcessingPipelineBuilder addCleaning(boolean removeSpecialChars, 
                                                    boolean removeNumbers, 
                                                    boolean removeExtraSpaces) {
        DataCleaningDecorator cleaningDecorator = new DataCleaningDecorator(processor);
        cleaningDecorator.removeSpecialChars(removeSpecialChars)
                        .removeNumbers(removeNumbers)
                        .removeExtraSpaces(removeExtraSpaces);
        processor = cleaningDecorator;
        return this;
    }
    
    public DataProcessingPipelineBuilder addCaseConversion(CaseConverterDecorator.CaseType caseType) {
        processor = new CaseConverterDecorator(processor, caseType);
        return this;
    }
    
    public DataProcessingPipelineBuilder addLogging(String logLevel) {
        processor = new LoggingDecorator(processor, logLevel);
        return this;
    }
    
    public DataProcessingPipelineBuilder addCache(int maxCacheSize) {
        processor = new CacheDecorator(processor, maxCacheSize);
        return this;
    }
    
    public DataProcessor<String> build() {
        return processor;
    }
}

// 使用示例
public class DataProcessorDecoratorExample {
    public static void main(String[] args) {
        System.out.println("=== 数据处理管道装饰器系统 ===");
        
        // 创建基础处理器
        DataProcessor<String> baseProcessor = new BaseDataProcessor();
        
        // 构建复杂的数据处理管道
        DataProcessor<String> pipeline = new DataProcessingPipelineBuilder(baseProcessor)
                .addValidation("默认值", data -> data != null && !data.isEmpty())
                .addCleaning(true, false, true) // 移除特殊字符，保留数字，移除多余空格
                .addCaseConversion(CaseConverterDecorator.CaseType.TITLE)
                .addCache(10)
                .addLogging("INFO")
                .build();
        
        // 测试数据
        String[] testData = {
            "  hello world!!!  ",
            "JAVA programming123",
            "  design   patterns  ",
            "",
            null,
            "hello world!!!", // 重复数据，测试缓存
            "python@#$%programming",
            "software   ENGINEERING"
        };
        
        System.out.println("\n--- 处理测试数据 ---");
        for (String data : testData) {
            try {
                String result = pipeline.process(data);
                System.out.printf("原始: '%s' -> 结果: '%s'%n", data, result);
                System.out.println();
            } catch (Exception e) {
                System.err.println("处理数据时出错: " + e.getMessage());
            }
        }
        
        // 显示处理器指标
        System.out.println("--- 处理器指标 ---");
        Map<String, Object> metrics = pipeline.getMetrics();
        metrics.forEach((key, value) -> 
            System.out.println(key + ": " + value));
        
        // 演示不同的装饰器组合
        System.out.println("\n=== 不同装饰器组合演示 ===");
        
        // 简单的大小写转换管道
        DataProcessor<String> simplePipeline = new DataProcessingPipelineBuilder(new BaseDataProcessor())
                .addCaseConversion(CaseConverterDecorator.CaseType.UPPER)
                .build();
        
        System.out.println("简单管道处理: " + simplePipeline.process("Hello World"));
        
        // 数据清洗管道
        DataProcessor<String> cleaningPipeline = new DataProcessingPipelineBuilder(new BaseDataProcessor())
                .addCleaning(true, true, true) // 移除特殊字符和数字
                .addCaseConversion(CaseConverterDecorator.CaseType.LOWER)
                .build();
        
        System.out.println("清洗管道处理: " + cleaningPipeline.process("Hello123 World!@#"));
        
        // 带验证的管道
        DataProcessor<String> validationPipeline = new DataProcessingPipelineBuilder(new BaseDataProcessor())
                .addValidation("无效数据", data -> data != null && data.length() > 3)
                .addCaseConversion(CaseConverterDecorator.CaseType.TITLE)
                .build();
        
        System.out.println("验证管道处理短数据: " + validationPipeline.process("Hi"));
        System.out.println("验证管道处理长数据: " + validationPipeline.process("Hello World"));
        
        // 演示装饰器的动态组合
        System.out.println("\n=== 动态装饰器组合 ===");
        DataProcessor<String> dynamicProcessor = new BaseDataProcessor();
        
        // 动态添加装饰器
        dynamicProcessor = new CaseConverterDecorator(dynamicProcessor, CaseConverterDecorator.CaseType.UPPER);
        System.out.println("添加大写转换: " + dynamicProcessor.process("hello"));
        
        dynamicProcessor = new DataCleaningDecorator(dynamicProcessor).removeSpecialChars(true);
        System.out.println("添加数据清洗: " + dynamicProcessor.process("hello@#$world"));
        
        dynamicProcessor = new LoggingDecorator(dynamicProcessor, "DEBUG");
        System.out.println("添加日志记录:");
        dynamicProcessor.process("final test");
    }
}
```

**装饰器模式的关键特点：**
1. **动态扩展**: 可以在运行时动态地给对象添加新功能
2. **组合优于继承**: 通过组合而不是继承来扩展功能
3. **透明性**: 装饰后的对象与原对象具有相同的接口
4. **灵活性**: 可以任意组合多个装饰器
5. **单一职责**: 每个装饰器只负责一种功能的扩展

#### 参与者概念
- **组件接口**：定义对象的接口
- **具体组件**：实现组件接口的基本对象
- **装饰器**：维护组件引用并实现组件接口
- **具体装饰器**：实现具体的装饰功能

### 5. 外观模式 (Facade)

#### 核心概念
- **外观**：为子系统提供统一的高层接口
- **子系统**：实现具体功能的类集合
- **简化接口**：隐藏子系统的复杂性
- **解耦**：客户端与子系统的解耦

#### 基础例子：家庭影院系统
```java
// 子系统类 - 音响设备
class Amplifier {
    private String description;
    
    public Amplifier(String description) {
        this.description = description;
    }
    
    public void on() {
        System.out.println(description + " 开启");
    }
    
    public void off() {
        System.out.println(description + " 关闭");
    }
    
    public void setVolume(int volume) {
        System.out.println(description + " 音量设置为 " + volume);
    }
    
    public void setStereoSound() {
        System.out.println(description + " 设置为立体声模式");
    }
}

// 子系统类 - DVD播放器
class DvdPlayer {
    private String description;
    
    public DvdPlayer(String description) {
        this.description = description;
    }
    
    public void on() {
        System.out.println(description + " 开启");
    }
    
    public void off() {
        System.out.println(description + " 关闭");
    }
    
    public void play(String movie) {
        System.out.println(description + " 播放电影: " + movie);
    }
    
    public void stop() {
        System.out.println(description + " 停止播放");
    }
    
    public void eject() {
        System.out.println(description + " 弹出光盘");
    }
}

// 子系统类 - 投影仪
class Projector {
    private String description;
    
    public Projector(String description) {
        this.description = description;
    }
    
    public void on() {
        System.out.println(description + " 开启");
    }
    
    public void off() {
        System.out.println(description + " 关闭");
    }
    
    public void wideScreenMode() {
        System.out.println(description + " 设置为宽屏模式");
    }
    
    public void tvMode() {
        System.out.println(description + " 设置为TV模式");
    }
}

// 子系统类 - 屏幕
class Screen {
    private String description;
    
    public Screen(String description) {
        this.description = description;
    }
    
    public void up() {
        System.out.println(description + " 升起");
    }
    
    public void down() {
        System.out.println(description + " 降下");
    }
}

// 子系统类 - 灯光
class TheaterLights {
    private String description;
    
    public TheaterLights(String description) {
        this.description = description;
    }
    
    public void on() {
        System.out.println(description + " 开启");
    }
    
    public void off() {
        System.out.println(description + " 关闭");
    }
    
    public void dim(int level) {
        System.out.println(description + " 调暗至 " + level + "%");
    }
}

// 子系统类 - 爆米花机
class PopcornPopper {
    private String description;
    
    public PopcornPopper(String description) {
        this.description = description;
    }
    
    public void on() {
        System.out.println(description + " 开启");
    }
    
    public void off() {
        System.out.println(description + " 关闭");
    }
    
    public void pop() {
        System.out.println(description + " 开始制作爆米花");
    }
}

// 外观类 - 家庭影院外观
class HomeTheaterFacade {
    private Amplifier amp;
    private DvdPlayer dvd;
    private Projector projector;
    private Screen screen;
    private TheaterLights lights;
    private PopcornPopper popper;
    
    public HomeTheaterFacade(Amplifier amp, DvdPlayer dvd, Projector projector,
                           Screen screen, TheaterLights lights, PopcornPopper popper) {
        this.amp = amp;
        this.dvd = dvd;
        this.projector = projector;
        this.screen = screen;
        this.lights = lights;
        this.popper = popper;
    }
    
    // 简化的接口 - 观看电影
    public void watchMovie(String movie) {
        System.out.println("准备观看电影...");
        
        popper.on();
        popper.pop();
        lights.dim(10);
        screen.down();
        projector.on();
        projector.wideScreenMode();
        amp.on();
        amp.setVolume(5);
        amp.setStereoSound();
        dvd.on();
        dvd.play(movie);
        
        System.out.println("电影开始，请享受观影时光！");
    }
    
    // 简化的接口 - 结束观影
    public void endMovie() {
        System.out.println("关闭影院系统...");
        
        popper.off();
        lights.on();
        screen.up();
        projector.off();
        amp.off();
        dvd.stop();
        dvd.eject();
        dvd.off();
        
        System.out.println("影院系统已关闭");
    }
    
    // 简化的接口 - 听音乐
    public void listenToMusic(String album) {
        System.out.println("准备播放音乐...");
        
        lights.on();
        amp.on();
        amp.setVolume(8);
        amp.setStereoSound();
        dvd.on();
        dvd.play(album);
        
        System.out.println("音乐开始播放！");
    }
    
    // 简化的接口 - 关闭音乐
    public void endMusic() {
        System.out.println("关闭音乐系统...");
        
        amp.off();
        dvd.stop();
        dvd.eject();
        dvd.off();
        
        System.out.println("音乐系统已关闭");
    }
}

// 使用示例
public class FacadeExample {
    public static void main(String[] args) {
        // 创建子系统组件
        Amplifier amp = new Amplifier("顶级功放");
        DvdPlayer dvd = new DvdPlayer("顶级DVD播放器");
        Projector projector = new Projector("顶级投影仪");
        Screen screen = new Screen("投影屏幕");
        TheaterLights lights = new TheaterLights("影院灯光");
        PopcornPopper popper = new PopcornPopper("爆米花机");
        
        // 创建外观
        HomeTheaterFacade homeTheater = new HomeTheaterFacade(
            amp, dvd, projector, screen, lights, popper);
        
        // 使用简化的接口
        System.out.println("=== 观看电影 ===");
        homeTheater.watchMovie("阿凡达");
        
        System.out.println("\n=== 结束观影 ===");
        homeTheater.endMovie();
        
        System.out.println("\n=== 听音乐 ===");
        homeTheater.listenToMusic("古典音乐精选");
        
        System.out.println("\n=== 关闭音乐 ===");
        homeTheater.endMusic();
    }
}
```

#### 进阶例子：企业级支付处理系统
```java
import java.math.BigDecimal;
import java.util.*;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.ExecutionException;

// 支付结果枚举
enum PaymentStatus {
    SUCCESS, FAILED, PENDING, CANCELLED, REFUNDED
}

// 支付方式枚举
enum PaymentMethod {
    CREDIT_CARD, DEBIT_CARD, PAYPAL, ALIPAY, WECHAT_PAY, BANK_TRANSFER
}

// 支付请求类
class PaymentRequest {
    private String orderId;
    private BigDecimal amount;
    private String currency;
    private PaymentMethod paymentMethod;
    private Map<String, String> customerInfo;
    private Map<String, String> metadata;
    
    public PaymentRequest(String orderId, BigDecimal amount, String currency, PaymentMethod paymentMethod) {
        this.orderId = orderId;
        this.amount = amount;
        this.currency = currency;
        this.paymentMethod = paymentMethod;
        this.customerInfo = new HashMap<>();
        this.metadata = new HashMap<>();
    }
    
    // Getter和Setter方法
    public String getOrderId() { return orderId; }
    public BigDecimal getAmount() { return amount; }
    public String getCurrency() { return currency; }
    public PaymentMethod getPaymentMethod() { return paymentMethod; }
    public Map<String, String> getCustomerInfo() { return customerInfo; }
    public Map<String, String> getMetadata() { return metadata; }
    
    public void addCustomerInfo(String key, String value) {
        customerInfo.put(key, value);
    }
    
    public void addMetadata(String key, String value) {
        metadata.put(key, value);
    }
}

// 支付响应类
class PaymentResponse {
    private String transactionId;
    private PaymentStatus status;
    private String message;
    private BigDecimal processedAmount;
    private Date processedTime;
    private Map<String, String> additionalInfo;
    
    public PaymentResponse(String transactionId, PaymentStatus status, String message) {
        this.transactionId = transactionId;
        this.status = status;
        this.message = message;
        this.processedTime = new Date();
        this.additionalInfo = new HashMap<>();
    }
    
    // Getter和Setter方法
    public String getTransactionId() { return transactionId; }
    public PaymentStatus getStatus() { return status; }
    public String getMessage() { return message; }
    public BigDecimal getProcessedAmount() { return processedAmount; }
    public void setProcessedAmount(BigDecimal processedAmount) { this.processedAmount = processedAmount; }
    public Date getProcessedTime() { return processedTime; }
    public Map<String, String> getAdditionalInfo() { return additionalInfo; }
    
    public void addAdditionalInfo(String key, String value) {
        additionalInfo.put(key, value);
    }
}

// 子系统 - 风险评估服务
class RiskAssessmentService {
    public boolean assessRisk(PaymentRequest request) {
        System.out.println("执行风险评估 - 订单: " + request.getOrderId());
        
        // 模拟风险评估逻辑
        BigDecimal amount = request.getAmount();
        if (amount.compareTo(new BigDecimal("10000")) > 0) {
            System.out.println("高风险交易 - 金额过大: " + amount);
            return false;
        }
        
        // 检查客户信息
        String customerEmail = request.getCustomerInfo().get("email");
        if (customerEmail == null || !customerEmail.contains("@")) {
            System.out.println("风险警告 - 客户邮箱无效");
            return false;
        }
        
        System.out.println("风险评估通过");
        return true;
    }
    
    public double calculateRiskScore(PaymentRequest request) {
        // 模拟风险评分计算
        double score = 0.1; // 基础风险分
        
        if (request.getAmount().compareTo(new BigDecimal("1000")) > 0) {
            score += 0.2;
        }
        
        if (request.getPaymentMethod() == PaymentMethod.CREDIT_CARD) {
            score += 0.1;
        }
        
        return Math.min(score, 1.0);
    }
}

// 子系统 - 支付网关服务
class PaymentGatewayService {
    private Map<PaymentMethod, String> gatewayUrls;
    
    public PaymentGatewayService() {
        gatewayUrls = new HashMap<>();
        gatewayUrls.put(PaymentMethod.CREDIT_CARD, "https://creditcard-gateway.com");
        gatewayUrls.put(PaymentMethod.PAYPAL, "https://paypal-gateway.com");
        gatewayUrls.put(PaymentMethod.ALIPAY, "https://alipay-gateway.com");
        gatewayUrls.put(PaymentMethod.WECHAT_PAY, "https://wechatpay-gateway.com");
    }
    
    public PaymentResponse processPayment(PaymentRequest request) {
        System.out.println("处理支付 - 网关: " + request.getPaymentMethod());
        
        String gatewayUrl = gatewayUrls.get(request.getPaymentMethod());
        if (gatewayUrl == null) {
            return new PaymentResponse(null, PaymentStatus.FAILED, "不支持的支付方式");
        }
        
        // 模拟网关处理
        try {
            Thread.sleep(1000); // 模拟网络延迟
            
            // 模拟支付处理结果
            String transactionId = "TXN_" + System.currentTimeMillis();
            PaymentResponse response = new PaymentResponse(transactionId, PaymentStatus.SUCCESS, "支付成功");
            response.setProcessedAmount(request.getAmount());
            response.addAdditionalInfo("gateway", gatewayUrl);
            response.addAdditionalInfo("paymentMethod", request.getPaymentMethod().toString());
            
            System.out.println("支付处理成功 - 交易ID: " + transactionId);
            return response;
            
        } catch (InterruptedException e) {
            return new PaymentResponse(null, PaymentStatus.FAILED, "支付处理超时");
        }
    }
    
    public PaymentResponse refundPayment(String transactionId, BigDecimal amount) {
        System.out.println("处理退款 - 交易ID: " + transactionId + ", 金额: " + amount);
        
        // 模拟退款处理
        String refundId = "REF_" + System.currentTimeMillis();
        PaymentResponse response = new PaymentResponse(refundId, PaymentStatus.REFUNDED, "退款成功");
        response.setProcessedAmount(amount);
        
        return response;
    }
}

// 子系统 - 通知服务
class NotificationService {
    public void sendPaymentNotification(PaymentRequest request, PaymentResponse response) {
        System.out.println("发送支付通知:");
        System.out.println("  收件人: " + request.getCustomerInfo().get("email"));
        System.out.println("  订单号: " + request.getOrderId());
        System.out.println("  交易状态: " + response.getStatus());
        System.out.println("  交易金额: " + response.getProcessedAmount());
        
        // 模拟发送邮件
        if (response.getStatus() == PaymentStatus.SUCCESS) {
            System.out.println("✅ 支付成功通知已发送");
        } else {
            System.out.println("❌ 支付失败通知已发送");
        }
    }
    
    public void sendSMSNotification(String phoneNumber, String message) {
        System.out.println("发送短信通知到 " + phoneNumber + ": " + message);
    }
    
    public void sendWebhookNotification(String webhookUrl, PaymentResponse response) {
        System.out.println("发送Webhook通知到 " + webhookUrl);
        System.out.println("通知内容: " + response.getTransactionId() + " - " + response.getStatus());
    }
}

// 子系统 - 审计日志服务
class AuditLogService {
    private List<String> auditLogs;
    
    public AuditLogService() {
        this.auditLogs = new ArrayList<>();
    }
    
    public void logPaymentAttempt(PaymentRequest request) {
        String logEntry = String.format("[%s] 支付尝试 - 订单: %s, 金额: %s, 支付方式: %s",
                new Date(), request.getOrderId(), request.getAmount(), request.getPaymentMethod());
        auditLogs.add(logEntry);
        System.out.println("审计日志: " + logEntry);
    }
    
    public void logPaymentResult(PaymentResponse response) {
        String logEntry = String.format("[%s] 支付结果 - 交易ID: %s, 状态: %s",
                new Date(), response.getTransactionId(), response.getStatus());
        auditLogs.add(logEntry);
        System.out.println("审计日志: " + logEntry);
    }
    
    public void logRiskAssessment(String orderId, boolean passed, double riskScore) {
        String logEntry = String.format("[%s] 风险评估 - 订单: %s, 通过: %s, 风险分: %.2f",
                new Date(), orderId, passed, riskScore);
        auditLogs.add(logEntry);
        System.out.println("审计日志: " + logEntry);
    }
    
    public List<String> getAuditLogs() {
        return new ArrayList<>(auditLogs);
    }
}

// 子系统 - 数据库服务
class DatabaseService {
    private Map<String, PaymentRequest> paymentRequests;
    private Map<String, PaymentResponse> paymentResponses;
    
    public DatabaseService() {
        this.paymentRequests = new HashMap<>();
        this.paymentResponses = new HashMap<>();
    }
    
    public void savePaymentRequest(PaymentRequest request) {
        paymentRequests.put(request.getOrderId(), request);
        System.out.println("支付请求已保存到数据库 - 订单: " + request.getOrderId());
    }
    
    public void savePaymentResponse(String orderId, PaymentResponse response) {
        paymentResponses.put(orderId, response);
        System.out.println("支付响应已保存到数据库 - 订单: " + orderId);
    }
    
    public PaymentRequest getPaymentRequest(String orderId) {
        return paymentRequests.get(orderId);
    }
    
    public PaymentResponse getPaymentResponse(String orderId) {
        return paymentResponses.get(orderId);
    }
    
    public void updatePaymentStatus(String orderId, PaymentStatus status) {
        PaymentResponse response = paymentResponses.get(orderId);
        if (response != null) {
            // 在实际实现中，这里会更新数据库记录
            System.out.println("更新支付状态 - 订单: " + orderId + ", 状态: " + status);
        }
    }
}

// 外观类 - 支付处理外观
class PaymentProcessingFacade {
    private RiskAssessmentService riskService;
    private PaymentGatewayService gatewayService;
    private NotificationService notificationService;
    private AuditLogService auditService;
    private DatabaseService databaseService;
    
    public PaymentProcessingFacade() {
        this.riskService = new RiskAssessmentService();
        this.gatewayService = new PaymentGatewayService();
        this.notificationService = new NotificationService();
        this.auditService = new AuditLogService();
        this.databaseService = new DatabaseService();
    }
    
    // 简化的接口 - 处理支付
    public PaymentResponse processPayment(PaymentRequest request) {
        System.out.println("=== 开始处理支付 ===");
        
        try {
            // 1. 记录审计日志
            auditService.logPaymentAttempt(request);
            
            // 2. 保存支付请求
            databaseService.savePaymentRequest(request);
            
            // 3. 风险评估
            boolean riskPassed = riskService.assessRisk(request);
            double riskScore = riskService.calculateRiskScore(request);
            auditService.logRiskAssessment(request.getOrderId(), riskPassed, riskScore);
            
            if (!riskPassed) {
                PaymentResponse failedResponse = new PaymentResponse(
                    null, PaymentStatus.FAILED, "风险评估未通过");
                
                // 保存失败响应
                databaseService.savePaymentResponse(request.getOrderId(), failedResponse);
                auditService.logPaymentResult(failedResponse);
                
                // 发送失败通知
                notificationService.sendPaymentNotification(request, failedResponse);
                
                return failedResponse;
            }
            
            // 4. 处理支付
            PaymentResponse response = gatewayService.processPayment(request);
            
            // 5. 保存支付响应
            databaseService.savePaymentResponse(request.getOrderId(), response);
            auditService.logPaymentResult(response);
            
            // 6. 发送通知
            notificationService.sendPaymentNotification(request, response);
            
            // 7. 如果有webhook URL，发送webhook通知
            String webhookUrl = request.getMetadata().get("webhookUrl");
            if (webhookUrl != null) {
                notificationService.sendWebhookNotification(webhookUrl, response);
            }
            
            // 8. 如果有手机号，发送短信通知
            String phoneNumber = request.getCustomerInfo().get("phone");
            if (phoneNumber != null && response.getStatus() == PaymentStatus.SUCCESS) {
                notificationService.sendSMSNotification(phoneNumber, 
                    "您的订单 " + request.getOrderId() + " 支付成功，金额: " + response.getProcessedAmount());
            }
            
            System.out.println("=== 支付处理完成 ===");
            return response;
            
        } catch (Exception e) {
            System.err.println("支付处理异常: " + e.getMessage());
            PaymentResponse errorResponse = new PaymentResponse(
                null, PaymentStatus.FAILED, "系统异常: " + e.getMessage());
            
            auditService.logPaymentResult(errorResponse);
            return errorResponse;
        }
    }
    
    // 简化的接口 - 处理退款
    public PaymentResponse processRefund(String orderId, BigDecimal refundAmount) {
        System.out.println("=== 开始处理退款 ===");
        
        try {
            // 1. 获取原始支付记录
            PaymentRequest originalRequest = databaseService.getPaymentRequest(orderId);
            PaymentResponse originalResponse = databaseService.getPaymentResponse(orderId);
            
            if (originalRequest == null || originalResponse == null) {
                return new PaymentResponse(null, PaymentStatus.FAILED, "找不到原始支付记录");
            }
            
            if (originalResponse.getStatus() != PaymentStatus.SUCCESS) {
                return new PaymentResponse(null, PaymentStatus.FAILED, "原始支付未成功，无法退款");
            }
            
            // 2. 验证退款金额
            if (refundAmount.compareTo(originalResponse.getProcessedAmount()) > 0) {
                return new PaymentResponse(null, PaymentStatus.FAILED, "退款金额超过原始支付金额");
            }
            
            // 3. 处理退款
            PaymentResponse refundResponse = gatewayService.refundPayment(
                originalResponse.getTransactionId(), refundAmount);
            
            // 4. 更新数据库状态
            databaseService.updatePaymentStatus(orderId, PaymentStatus.REFUNDED);
            
            // 5. 记录审计日志
            auditService.logPaymentResult(refundResponse);
            
            // 6. 发送退款通知
            notificationService.sendPaymentNotification(originalRequest, refundResponse);
            
            System.out.println("=== 退款处理完成 ===");
            return refundResponse;
            
        } catch (Exception e) {
            System.err.println("退款处理异常: " + e.getMessage());
            return new PaymentResponse(null, PaymentStatus.FAILED, "退款处理异常: " + e.getMessage());
        }
    }
    
    // 简化的接口 - 查询支付状态
    public PaymentResponse queryPaymentStatus(String orderId) {
        System.out.println("查询支付状态 - 订单: " + orderId);
        
        PaymentResponse response = databaseService.getPaymentResponse(orderId);
        if (response == null) {
            return new PaymentResponse(null, PaymentStatus.FAILED, "找不到支付记录");
        }
        
        return response;
    }
    
    // 简化的接口 - 获取审计日志
    public List<String> getAuditLogs() {
        return auditService.getAuditLogs();
    }
    
    // 简化的接口 - 批量处理支付
    public List<PaymentResponse> batchProcessPayments(List<PaymentRequest> requests) {
        System.out.println("=== 开始批量处理支付 ===");
        List<PaymentResponse> responses = new ArrayList<>();
        
        for (PaymentRequest request : requests) {
            try {
                PaymentResponse response = processPayment(request);
                responses.add(response);
                
                // 批量处理时添加短暂延迟，避免过快请求
                Thread.sleep(100);
                
            } catch (Exception e) {
                PaymentResponse errorResponse = new PaymentResponse(
                    null, PaymentStatus.FAILED, "批量处理异常: " + e.getMessage());
                responses.add(errorResponse);
            }
        }
        
        System.out.println("=== 批量处理完成 ===");
        return responses;
    }
}

// 使用示例
public class PaymentFacadeExample {
    public static void main(String[] args) {
        // 创建支付处理外观
        PaymentProcessingFacade paymentFacade = new PaymentProcessingFacade();
        
        // 创建支付请求
        PaymentRequest request1 = new PaymentRequest(
            "ORDER_001", new BigDecimal("299.99"), "CNY", PaymentMethod.ALIPAY);
        request1.addCustomerInfo("email", "customer@example.com");
        request1.addCustomerInfo("phone", "13800138000");
        request1.addMetadata("webhookUrl", "https://merchant.com/webhook");
        
        // 处理支付
        System.out.println("=== 处理单笔支付 ===");
        PaymentResponse response1 = paymentFacade.processPayment(request1);
        System.out.println("支付结果: " + response1.getStatus() + " - " + response1.getMessage());
        
        // 查询支付状态
        System.out.println("\n=== 查询支付状态 ===");
        PaymentResponse statusResponse = paymentFacade.queryPaymentStatus("ORDER_001");
        System.out.println("支付状态: " + statusResponse.getStatus());
        
        // 处理退款
        if (response1.getStatus() == PaymentStatus.SUCCESS) {
            System.out.println("\n=== 处理退款 ===");
            PaymentResponse refundResponse = paymentFacade.processRefund(
                "ORDER_001", new BigDecimal("100.00"));
            System.out.println("退款结果: " + refundResponse.getStatus() + " - " + refundResponse.getMessage());
        }
        
        // 批量处理支付
        System.out.println("\n=== 批量处理支付 ===");
        List<PaymentRequest> batchRequests = Arrays.asList(
            createPaymentRequest("ORDER_002", "199.99", PaymentMethod.WECHAT_PAY),
            createPaymentRequest("ORDER_003", "399.99", PaymentMethod.CREDIT_CARD),
            createPaymentRequest("ORDER_004", "99.99", PaymentMethod.PAYPAL)
        );
        
        List<PaymentResponse> batchResponses = paymentFacade.batchProcessPayments(batchRequests);
        
        System.out.println("批量处理结果:");
        for (int i = 0; i < batchResponses.size(); i++) {
            PaymentResponse response = batchResponses.get(i);
            System.out.printf("  订单 %d: %s - %s%n", 
                i + 1, response.getStatus(), response.getMessage());
        }
        
        // 显示审计日志
        System.out.println("\n=== 审计日志 ===");
        List<String> auditLogs = paymentFacade.getAuditLogs();
        auditLogs.forEach(System.out::println);
    }
    
    private static PaymentRequest createPaymentRequest(String orderId, String amount, PaymentMethod method) {
        PaymentRequest request = new PaymentRequest(
            orderId, new BigDecimal(amount), "CNY", method);
        request.addCustomerInfo("email", "batch@example.com");
        request.addCustomerInfo("phone", "13900139000");
        return request;
    }
}
```

**外观模式的关键特点：**
1. **简化接口**: 为复杂的子系统提供简单统一的接口
2. **降低耦合**: 客户端与子系统之间的耦合度降低
3. **更好的分层**: 定义了子系统中每层的入口点
4. **不限制功能**: 客户端仍可以直接访问子系统类
5. **易于使用**: 大多数客户端只需要使用外观接口

#### 实现概念
- **简单外观**：提供简单的统一接口
- **复杂外观**：提供多个层次的接口
- **抽象外观**：定义外观的抽象接口
# 设计模式完整概念汇总

## 第一部分：基础理论概念

### 1. 设计模式基本概念

#### 1.1 核心定义

##### 设计模式 (Design Pattern)
- **GoF原定义**：*"设计模式是在特定环境下人们解决某类重复出现问题的一套成功或有效的解决方案。"*
- **扩展定义**：在特定环境下，为解决某一通用软件设计问题提供的一套定制的解决方案
- **本质**：可复用的面向对象软件设计经验

#### 基础例子：日常生活中的模式
```
建筑设计模式：
- 问题：如何设计一个既美观又实用的房屋入口？
- 解决方案：门廊模式 - 在主入口前设置一个有顶棚的过渡空间
- 效果：提供遮风挡雨的缓冲区，增加建筑美感

软件设计模式：
- 问题：如何确保一个类只有一个实例？
- 解决方案：单例模式 - 控制类的实例化过程
- 效果：节省内存，保证全局唯一性
```

#### 进阶例子：企业级应用中的模式思维
```java
// 传统方式 - 没有模式思维
public class OrderProcessor {
    public void processOrder(Order order) {
        // 验证订单
        if (order.getItems().isEmpty()) {
            throw new IllegalArgumentException("订单不能为空");
        }
        
        // 计算价格
        double total = 0;
        for (OrderItem item : order.getItems()) {
            total += item.getPrice() * item.getQuantity();
        }
        
        // 发送邮件
        EmailService emailService = new EmailService();
        emailService.sendOrderConfirmation(order.getCustomerEmail(), order);
        
        // 更新库存
        InventoryService inventoryService = new InventoryService();
        inventoryService.updateStock(order.getItems());
        
        // 记录日志
        System.out.println("订单处理完成: " + order.getId());
    }
}

// 使用模式思维重构
public class OrderProcessor {
    private List<OrderValidator> validators;
    private PricingStrategy pricingStrategy;
    private List<OrderEventListener> eventListeners;
    
    public OrderProcessor() {
        // 责任链模式 - 验证器链
        this.validators = Arrays.asList(
            new EmptyOrderValidator(),
            new CustomerValidator(),
            new InventoryValidator()
        );
        
        // 策略模式 - 定价策略
        this.pricingStrategy = new StandardPricingStrategy();
        
        // 观察者模式 - 事件监听器
        this.eventListeners = Arrays.asList(
            new EmailNotificationListener(),
            new InventoryUpdateListener(),
            new LoggingListener()
        );
    }
    
    public void processOrder(Order order) {
        // 使用责任链验证
        for (OrderValidator validator : validators) {
            validator.validate(order);
        }
        
        // 使用策略计算价格
        double total = pricingStrategy.calculateTotal(order);
        order.setTotal(total);
        
        // 使用观察者通知各个服务
        OrderProcessedEvent event = new OrderProcessedEvent(order);
        eventListeners.forEach(listener -> listener.onOrderProcessed(event));
    }
}
```

##### 模式语言 (Pattern Language)
- **Alexander原定义**：*"每个模式描述了一个在我们周围不断重复发生的问题，以及该问题的解决方案的核心。"*
- **软件领域定义**：描述设计问题、解决方案和效果的标准化语言
- **作用**：为设计者提供共同的词汇和交流方式

##### 可复用性 (Reusability)
- **定义**：模式可以在不同的软件系统中重复使用
- **层次**：设计复用比代码复用更高层次
- **价值**：避免重新发明轮子，提高开发效率

##### 最佳实践 (Best Practice)
- **定义**：经过验证的、优秀的设计经验总结
- **特征**：经过时间检验，被广泛认可和应用
- **来源**：专家经验的结晶和总结

#### 1.2 模式要素
- **模式名称**：简洁描述设计问题、解决方案和效果的词汇
- **问题**：描述何时使用该模式，包括设计问题和问题的前因后果
- **解决方案**：描述设计的组成成分、关系、职责和协作方式
- **效果**：使用模式的结果和权衡，包括对灵活性、扩展性的影响

#### 1.3 模式分类
- **创建型模式**：处理对象创建机制，将对象的创建和使用分离
- **结构型模式**：处理对象和类的组合，形成更大的结构
- **行为型模式**：处理对象间的通信和职责分配

### 2. UML建模概念

#### 2.1 类图概念
- **类**：具有相同属性和方法的对象集合的抽象
- **属性**：类的数据成员，描述对象的状态
- **方法**：类的函数成员，描述对象的行为
- **访问修饰符**：控制类成员的可见性（public、private、protected、package）
- **静态成员**：属于类而不是实例的成员
- **抽象类**：不能实例化的类，通常包含抽象方法
- **接口**：定义类必须实现的方法契约

#### 2.2 类间关系概念
- **继承/泛化**：子类继承父类的属性和方法，is-a关系
- **实现**：类实现接口定义的方法契约
- **依赖**：一个类使用另一个类，临时性的uses-a关系
- **关联**：类之间的结构化关系，长期性的has-a关系
- **聚合**：整体-部分关系，部分可以独立于整体存在
- **组合**：强整体-部分关系，部分不能独立于整体存在
- **多重性**：关系中对象的数量约束

#### 2.3 动态图概念
- **时序图**：按时间顺序显示对象间的交互
- **协作图**：强调对象间的组织结构和消息传递
- **状态图**：描述对象在生命周期内的状态变化
- **活动图**：描述系统的工作流程和业务过程

### 3. 面向对象设计原则概念

#### 3.1 SOLID原则
- **单一职责原则(SRP)**：一个类应该只有一个引起变化的原因
- **开放-封闭原则(OCP)**：对扩展开放，对修改封闭
- **里氏替换原则(LSP)**：子类对象应该能够替换父类对象
- **接口隔离原则(ISP)**：客户端不应该依赖不需要的接口
- **依赖倒置原则(DIP)**：依赖于抽象，而不是具体实现

#### 3.2 其他重要原则
- **迪米特法则(LoD)**：一个对象应该对其他对象有最少的了解
- **合成/聚合复用原则(CARP)**：优先使用组合而不是继承来实现复用

## 第二部分：创建型模式概念

### 1. 单例模式 (Singleton)

#### 核心概念
- **单例**：确保一个类只有一个实例，并提供全局访问点
- **实例控制**：控制类的实例化过程
- **全局访问**：提供访问唯一实例的全局方法
- **延迟初始化**：在需要时才创建实例

#### 基础例子：简单的配置管理器
```java
// 饿汉式单例 - 最简单的实现
public class ConfigManager {
    // 类加载时就创建实例
    private static final ConfigManager INSTANCE = new ConfigManager();
    private Properties config;
    
    // 私有构造函数，防止外部实例化
    private ConfigManager() {
        config = new Properties();
        loadConfig();
    }
    
    // 提供全局访问点
    public static ConfigManager getInstance() {
        return INSTANCE;
    }
    
    private void loadConfig() {
        // 加载配置文件
        config.setProperty("database.url", "jdbc:mysql://localhost:3306/mydb");
        config.setProperty("database.username", "root");
        config.setProperty("cache.size", "1000");
    }
    
    public String getProperty(String key) {
        return config.getProperty(key);
    }
    
    public void setProperty(String key, String value) {
        config.setProperty(key, value);
    }
}

// 使用示例
public class Application {
    public static void main(String[] args) {
        // 获取配置管理器实例
        ConfigManager config1 = ConfigManager.getInstance();
        ConfigManager config2 = ConfigManager.getInstance();
        
        // 验证是同一个实例
        System.out.println("是否为同一实例: " + (config1 == config2)); // true
        
        // 使用配置
        String dbUrl = config1.getProperty("database.url");
        System.out.println("数据库URL: " + dbUrl);
        
        // 修改配置
        config1.setProperty("app.name", "MyApplication");
        String appName = config2.getProperty("app.name");
        System.out.println("应用名称: " + appName); // MyApplication
    }
}
```

#### 进阶例子：线程安全的数据库连接池
```java
import java.sql.*;
import java.util.concurrent.BlockingQueue;
import java.util.concurrent.LinkedBlockingQueue;
import java.util.concurrent.atomic.AtomicInteger;

// 双重检查锁定的懒汉式单例
public class DatabaseConnectionPool {
    // 使用volatile确保多线程环境下的可见性
    private static volatile DatabaseConnectionPool instance;
    
    private final BlockingQueue<Connection> connectionPool;
    private final AtomicInteger currentConnections;
    private final int maxConnections;
    private final String jdbcUrl;
    private final String username;
    private final String password;
    
    // 私有构造函数
    private DatabaseConnectionPool() {
        this.maxConnections = 10;
        this.currentConnections = new AtomicInteger(0);
        this.connectionPool = new LinkedBlockingQueue<>(maxConnections);
        this.jdbcUrl = "jdbc:mysql://localhost:3306/mydb";
        this.username = "root";
        this.password = "password";
        
        // 初始化连接池
        initializePool();
    }
    
    // 双重检查锁定获取实例
    public static DatabaseConnectionPool getInstance() {
        if (instance == null) {
            synchronized (DatabaseConnectionPool.class) {
                if (instance == null) {
                    instance = new DatabaseConnectionPool();
                }
            }
        }
        return instance;
    }
    
    private void initializePool() {
        try {
            // 预创建一些连接
            for (int i = 0; i < 3; i++) {
                Connection conn = createConnection();
                if (conn != null) {
                    connectionPool.offer(conn);
                    currentConnections.incrementAndGet();
                }
            }
        } catch (SQLException e) {
            System.err.println("初始化连接池失败: " + e.getMessage());
        }
    }
    
    private Connection createConnection() throws SQLException {
        return DriverManager.getConnection(jdbcUrl, username, password);
    }
    
    // 获取连接
    public Connection getConnection() throws SQLException, InterruptedException {
        Connection conn = connectionPool.poll();
        
        if (conn == null && currentConnections.get() < maxConnections) {
            // 如果池中没有连接且未达到最大连接数，创建新连接
            synchronized (this) {
                if (currentConnections.get() < maxConnections) {
                    conn = createConnection();
                    currentConnections.incrementAndGet();
                }
            }
        }
        
        if (conn == null) {
            // 等待可用连接
            conn = connectionPool.take();
        }
        
        return conn;
    }
    
    // 归还连接
    public void returnConnection(Connection conn) {
        if (conn != null) {
            try {
                if (!conn.isClosed()) {
                    connectionPool.offer(conn);
                } else {
                    currentConnections.decrementAndGet();
                }
            } catch (SQLException e) {
                System.err.println("检查连接状态失败: " + e.getMessage());
                currentConnections.decrementAndGet();
            }
        }
    }
    
    // 关闭连接池
    public void shutdown() {
        while (!connectionPool.isEmpty()) {
            try {
                Connection conn = connectionPool.poll();
                if (conn != null && !conn.isClosed()) {
                    conn.close();
                }
            } catch (SQLException e) {
                System.err.println("关闭连接失败: " + e.getMessage());
            }
        }
        currentConnections.set(0);
    }
    
    // 获取连接池状态
    public String getPoolStatus() {
        return String.format("连接池状态 - 当前连接数: %d, 可用连接数: %d, 最大连接数: %d",
                currentConnections.get(), connectionPool.size(), maxConnections);
    }
    
    // 防止序列化破坏单例
    private Object readResolve() {
        return getInstance();
    }
}

// 静态内部类实现（推荐方式）
public class LogManager {
    // 静态内部类，只有在被引用时才会加载
    private static class LogManagerHolder {
        private static final LogManager INSTANCE = new LogManager();
    }
    
    private final String logLevel;
    private final String logFormat;
    
    private LogManager() {
        this.logLevel = "INFO";
        this.logFormat = "[%s] %s - %s";
    }
    
    public static LogManager getInstance() {
        return LogManagerHolder.INSTANCE;
    }
    
    public void log(String level, String message) {
        String timestamp = java.time.LocalDateTime.now().toString();
        String formattedMessage = String.format(logFormat, timestamp, level, message);
        System.out.println(formattedMessage);
    }
    
    public void info(String message) {
        log("INFO", message);
    }
    
    public void error(String message) {
        log("ERROR", message);
    }
    
    public void debug(String message) {
        if ("DEBUG".equals(logLevel)) {
            log("DEBUG", message);
        }
    }
}

// 枚举实现（最安全的方式）
public enum CacheManager {
    INSTANCE;
    
    private final Map<String, Object> cache;
    
    CacheManager() {
        this.cache = new ConcurrentHashMap<>();
    }
    
    public void put(String key, Object value) {
        cache.put(key, value);
    }
    
    public Object get(String key) {
        return cache.get(key);
    }
    
    public void remove(String key) {
        cache.remove(key);
    }
    
    public void clear() {
        cache.clear();
    }
    
    public int size() {
        return cache.size();
    }
}

// 多线程测试示例
public class SingletonTest {
    public static void main(String[] args) throws InterruptedException {
        // 测试数据库连接池单例
        testDatabaseConnectionPool();
        
        // 测试日志管理器单例
        testLogManager();
        
        // 测试缓存管理器单例
        testCacheManager();
    }
    
    private static void testDatabaseConnectionPool() throws InterruptedException {
        System.out.println("=== 测试数据库连接池单例 ===");
        
        // 创建多个线程同时获取实例
        Thread[] threads = new Thread[5];
        DatabaseConnectionPool[] instances = new DatabaseConnectionPool[5];
        
        for (int i = 0; i < 5; i++) {
            final int index = i;
            threads[i] = new Thread(() -> {
                instances[index] = DatabaseConnectionPool.getInstance();
                System.out.println("线程 " + index + " 获取实例: " + instances[index].hashCode());
            });
        }
        
        // 启动所有线程
        for (Thread thread : threads) {
            thread.start();
        }
        
        // 等待所有线程完成
        for (Thread thread : threads) {
            thread.join();
        }
        
        // 验证所有实例是否相同
        boolean allSame = true;
        for (int i = 1; i < instances.length; i++) {
            if (instances[i] != instances[0]) {
                allSame = false;
                break;
            }
        }
        
        System.out.println("所有实例是否相同: " + allSame);
        System.out.println(instances[0].getPoolStatus());
        System.out.println();
    }
    
    private static void testLogManager() {
        System.out.println("=== 测试日志管理器单例 ===");
        
        LogManager logger1 = LogManager.getInstance();
        LogManager logger2 = LogManager.getInstance();
        
        System.out.println("是否为同一实例: " + (logger1 == logger2));
        
        logger1.info("这是一条信息日志");
        logger2.error("这是一条错误日志");
        logger1.debug("这是一条调试日志");
        System.out.println();
    }
    
    private static void testCacheManager() {
        System.out.println("=== 测试缓存管理器单例 ===");
        
        CacheManager cache1 = CacheManager.INSTANCE;
        CacheManager cache2 = CacheManager.INSTANCE;
        
        System.out.println("是否为同一实例: " + (cache1 == cache2));
        
        cache1.put("user:1", "张三");
        cache1.put("user:2", "李四");
        
        System.out.println("缓存大小: " + cache2.size());
        System.out.println("用户1: " + cache2.get("user:1"));
        System.out.println("用户2: " + cache2.get("user:2"));
        System.out.println();
    }
}
```

#### 实现概念
- **饿汉式**：类加载时就创建实例
- **懒汉式**：第一次使用时才创建实例
- **双重检查锁定**：线程安全的懒汉式实现
- **静态内部类**：利用类加载机制保证线程安全
- **枚举实现**：最简洁的单例实现方式

#### 相关概念
- **线程安全**：多线程环境下的正确性
- **序列化安全**：序列化后不破坏单例特性
- **反射安全**：防止通过反射创建多个实例

### 2. 工厂方法模式 (Factory Method)

#### 核心概念
- **工厂方法**：定义创建对象的接口，让子类决定实例化哪个类
- **产品**：工厂创建的对象
- **创建者**：包含工厂方法的类
- **延迟实例化**：将对象创建延迟到子类

#### 基础例子：图形绘制工厂
```java
// 产品接口
interface Shape {
    void draw();
}

// 具体产品
class Circle implements Shape {
    @Override
    public void draw() {
        System.out.println("绘制圆形");
    }
}

class Rectangle implements Shape {
    @Override
    public void draw() {
        System.out.println("绘制矩形");
    }
}

// 抽象工厂
abstract class ShapeFactory {
    // 工厂方法
    public abstract Shape createShape();
    
    // 模板方法
    public void drawShape() {
        Shape shape = createShape();
        shape.draw();
    }
}

// 具体工厂
class CircleFactory extends ShapeFactory {
    @Override
    public Shape createShape() {
        return new Circle();
    }
}

class RectangleFactory extends ShapeFactory {
    @Override
    public Shape createShape() {
        return new Rectangle();
    }
}

// 使用示例
public class FactoryMethodExample {
    public static void main(String[] args) {
        ShapeFactory circleFactory = new CircleFactory();
        circleFactory.drawShape(); // 输出: 绘制圆形
        
        ShapeFactory rectangleFactory = new RectangleFactory();
        rectangleFactory.drawShape(); // 输出: 绘制矩形
    }
}
```

#### 进阶例子：数据库连接工厂系统
```java
// 数据库连接接口
interface DatabaseConnection {
    void connect();
    void executeQuery(String sql);
    void close();
    String getConnectionInfo();
}

// MySQL连接实现
class MySQLConnection implements DatabaseConnection {
    private String host;
    private int port;
    private String database;
    
    public MySQLConnection(String host, int port, String database) {
        this.host = host;
        this.port = port;
        this.database = database;
    }
    
    @Override
    public void connect() {
        System.out.println("连接到MySQL数据库: " + getConnectionInfo());
    }
    
    @Override
    public void executeQuery(String sql) {
        System.out.println("在MySQL中执行查询: " + sql);
    }
    
    @Override
    public void close() {
        System.out.println("关闭MySQL连接");
    }
    
    @Override
    public String getConnectionInfo() {
        return String.format("mysql://%s:%d/%s", host, port, database);
    }
}

// PostgreSQL连接实现
class PostgreSQLConnection implements DatabaseConnection {
    private String host;
    private int port;
    private String database;
    
    public PostgreSQLConnection(String host, int port, String database) {
        this.host = host;
        this.port = port;
        this.database = database;
    }
    
    @Override
    public void connect() {
        System.out.println("连接到PostgreSQL数据库: " + getConnectionInfo());
    }
    
    @Override
    public void executeQuery(String sql) {
        System.out.println("在PostgreSQL中执行查询: " + sql);
    }
    
    @Override
    public void close() {
        System.out.println("关闭PostgreSQL连接");
    }
    
    @Override
    public String getConnectionInfo() {
        return String.format("postgresql://%s:%d/%s", host, port, database);
    }
}

// 抽象数据库工厂
abstract class DatabaseFactory {
    // 工厂方法 - 由子类实现
    public abstract DatabaseConnection createConnection();
    
    // 模板方法 - 定义标准的数据库操作流程
    public void performDatabaseOperation(String sql) {
        DatabaseConnection connection = null;
        try {
            connection = createConnection();
            connection.connect();
            connection.executeQuery(sql);
        } catch (Exception e) {
            System.err.println("数据库操作失败: " + e.getMessage());
        } finally {
            if (connection != null) {
                connection.close();
            }
        }
    }
    
    // 批量操作
    public void performBatchOperations(String[] sqlStatements) {
        DatabaseConnection connection = null;
        try {
            connection = createConnection();
            connection.connect();
            System.out.println("开始批量操作...");
            for (String sql : sqlStatements) {
                connection.executeQuery(sql);
            }
            System.out.println("批量操作完成");
        } catch (Exception e) {
            System.err.println("批量操作失败: " + e.getMessage());
        } finally {
            if (connection != null) {
                connection.close();
            }
        }
    }
}

// MySQL工厂
class MySQLFactory extends DatabaseFactory {
    private String host;
    private int port;
    private String database;
    
    public MySQLFactory(String host, int port, String database) {
        this.host = host;
        this.port = port;
        this.database = database;
    }
    
    @Override
    public DatabaseConnection createConnection() {
        return new MySQLConnection(host, port, database);
    }
}

// PostgreSQL工厂
class PostgreSQLFactory extends DatabaseFactory {
    private String host;
    private int port;
    private String database;
    
    public PostgreSQLFactory(String host, int port, String database) {
        this.host = host;
        this.port = port;
        this.database = database;
    }
    
    @Override
    public DatabaseConnection createConnection() {
        return new PostgreSQLConnection(host, port, database);
    }
}

// 数据库工厂管理器
class DatabaseFactoryManager {
    private static final Map<String, DatabaseFactory> factories = new HashMap<>();
    
    public static void registerFactory(String type, DatabaseFactory factory) {
        factories.put(type.toLowerCase(), factory);
    }
    
    public static DatabaseFactory getFactory(String type) {
        DatabaseFactory factory = factories.get(type.toLowerCase());
        if (factory == null) {
            throw new IllegalArgumentException("不支持的数据库类型: " + type);
        }
        return factory;
    }
    
    public static Set<String> getSupportedTypes() {
        return factories.keySet();
    }
}

// 使用示例
public class DatabaseFactoryExample {
    public static void main(String[] args) {
        // 注册工厂
        DatabaseFactoryManager.registerFactory("mysql", 
            new MySQLFactory("localhost", 3306, "testdb"));
        DatabaseFactoryManager.registerFactory("postgresql", 
            new PostgreSQLFactory("localhost", 5432, "testdb"));
        
        // 使用MySQL
        DatabaseFactory mysqlFactory = DatabaseFactoryManager.getFactory("mysql");
        mysqlFactory.performDatabaseOperation("SELECT * FROM users");
        
        // 使用PostgreSQL
        DatabaseFactory postgresFactory = DatabaseFactoryManager.getFactory("postgresql");
        String[] batchSql = {
            "INSERT INTO users (name, email) VALUES ('张三', 'zhangsan@example.com')",
            "INSERT INTO users (name, email) VALUES ('李四', 'lisi@example.com')",
            "UPDATE users SET status = 'active' WHERE id > 0"
        };
        postgresFactory.performBatchOperations(batchSql);
        
        // 显示支持的数据库类型
        System.out.println("支持的数据库类型: " + 
            DatabaseFactoryManager.getSupportedTypes());
    }
}
```

**工厂方法模式的关键特点：**
1. **延迟决策**: 将对象创建的决策推迟到子类
2. **符合开放-封闭原则**: 新增产品类型只需添加新的工厂类
3. **消除耦合**: 客户端代码不依赖具体的产品类
4. **模板方法结合**: 工厂类可以定义创建对象后的标准操作流程

#### 参与者概念
- **抽象产品**：定义产品的接口
- **具体产品**：实现产品接口的具体类
- **抽象创建者**：声明工厂方法的抽象类
- **具体创建者**：实现工厂方法的具体类

#### 相关概念
- **简单工厂**：用一个类来创建所有产品
- **参数化工厂**：根据参数决定创建哪种产品
- **泛型工厂**：使用泛型的工厂实现

### 3. 抽象工厂模式 (Abstract Factory)

#### 核心概念
- **抽象工厂**：提供创建一系列相关对象的接口
- **产品族**：一组相关的产品对象
- **产品等级结构**：产品的继承层次
- **产品一致性**：确保创建的产品属于同一族

#### 基础例子：GUI组件工厂
```java
// 抽象产品 - 按钮
interface Button {
    void paint();
    void click();
}

// 抽象产品 - 文本框
interface TextField {
    void paint();
    void setText(String text);
    String getText();
}

// Windows风格的具体产品
class WindowsButton implements Button {
    @Override
    public void paint() {
        System.out.println("绘制Windows风格按钮");
    }
    
    @Override
    public void click() {
        System.out.println("Windows按钮被点击");
    }
}

class WindowsTextField implements TextField {
    private String text = "";
    
    @Override
    public void paint() {
        System.out.println("绘制Windows风格文本框");
    }
    
    @Override
    public void setText(String text) {
        this.text = text;
        System.out.println("Windows文本框设置文本: " + text);
    }
    
    @Override
    public String getText() {
        return text;
    }
}

// Mac风格的具体产品
class MacButton implements Button {
    @Override
    public void paint() {
        System.out.println("绘制Mac风格按钮");
    }
    
    @Override
    public void click() {
        System.out.println("Mac按钮被点击");
    }
}

class MacTextField implements TextField {
    private String text = "";
    
    @Override
    public void paint() {
        System.out.println("绘制Mac风格文本框");
    }
    
    @Override
    public void setText(String text) {
        this.text = text;
        System.out.println("Mac文本框设置文本: " + text);
    }
    
    @Override
    public String getText() {
        return text;
    }
}

// 抽象工厂
interface GUIFactory {
    Button createButton();
    TextField createTextField();
}

// 具体工厂
class WindowsFactory implements GUIFactory {
    @Override
    public Button createButton() {
        return new WindowsButton();
    }
    
    @Override
    public TextField createTextField() {
        return new WindowsTextField();
    }
}

class MacFactory implements GUIFactory {
    @Override
    public Button createButton() {
        return new MacButton();
    }
    
    @Override
    public TextField createTextField() {
        return new MacTextField();
    }
}

// 客户端代码
class Application {
    private Button button;
    private TextField textField;
    
    public Application(GUIFactory factory) {
        button = factory.createButton();
        textField = factory.createTextField();
    }
    
    public void paint() {
        button.paint();
        textField.paint();
    }
    
    public void interact() {
        textField.setText("Hello World");
        button.click();
        System.out.println("文本框内容: " + textField.getText());
    }
}

// 使用示例
public class AbstractFactoryExample {
    public static void main(String[] args) {
        // 根据操作系统选择工厂
        String osName = System.getProperty("os.name").toLowerCase();
        GUIFactory factory;
        
        if (osName.contains("windows")) {
            factory = new WindowsFactory();
            System.out.println("使用Windows风格界面");
        } else {
            factory = new MacFactory();
            System.out.println("使用Mac风格界面");
        }
        
        Application app = new Application(factory);
        app.paint();
        app.interact();
    }
}
```

#### 进阶例子：跨平台数据库访问工厂
```java
// 抽象产品 - 数据库连接
interface DatabaseConnection {
    void connect();
    void disconnect();
    boolean isConnected();
}

// 抽象产品 - 查询执行器
interface QueryExecutor {
    ResultSet executeQuery(String sql);
    int executeUpdate(String sql);
    void executeBatch(String[] sqls);
}

// 抽象产品 - 事务管理器
interface TransactionManager {
    void beginTransaction();
    void commit();
    void rollback();
    boolean isInTransaction();
}

// MySQL产品族
class MySQLConnection implements DatabaseConnection {
    private boolean connected = false;
    private String connectionString;
    
    public MySQLConnection(String host, int port, String database) {
        this.connectionString = String.format("mysql://%s:%d/%s", host, port, database);
    }
    
    @Override
    public void connect() {
        connected = true;
        System.out.println("连接到MySQL: " + connectionString);
    }
    
    @Override
    public void disconnect() {
        connected = false;
        System.out.println("断开MySQL连接");
    }
    
    @Override
    public boolean isConnected() {
        return connected;
    }
}

class MySQLQueryExecutor implements QueryExecutor {
    private DatabaseConnection connection;
    
    public MySQLQueryExecutor(DatabaseConnection connection) {
        this.connection = connection;
    }
    
    @Override
    public ResultSet executeQuery(String sql) {
        if (!connection.isConnected()) {
            throw new IllegalStateException("数据库未连接");
        }
        System.out.println("MySQL执行查询: " + sql);
        return new MockResultSet("MySQL查询结果");
    }
    
    @Override
    public int executeUpdate(String sql) {
        if (!connection.isConnected()) {
            throw new IllegalStateException("数据库未连接");
        }
        System.out.println("MySQL执行更新: " + sql);
        return 1; // 模拟影响行数
    }
    
    @Override
    public void executeBatch(String[] sqls) {
        if (!connection.isConnected()) {
            throw new IllegalStateException("数据库未连接");
        }
        System.out.println("MySQL执行批量操作:");
        for (String sql : sqls) {
            System.out.println("  - " + sql);
        }
    }
}

class MySQLTransactionManager implements TransactionManager {
    private boolean inTransaction = false;
    private DatabaseConnection connection;
    
    public MySQLTransactionManager(DatabaseConnection connection) {
        this.connection = connection;
    }
    
    @Override
    public void beginTransaction() {
        if (!connection.isConnected()) {
            throw new IllegalStateException("数据库未连接");
        }
        inTransaction = true;
        System.out.println("MySQL开始事务");
    }
    
    @Override
    public void commit() {
        if (!inTransaction) {
            throw new IllegalStateException("没有活动事务");
        }
        inTransaction = false;
        System.out.println("MySQL提交事务");
    }
    
    @Override
    public void rollback() {
        if (!inTransaction) {
            throw new IllegalStateException("没有活动事务");
        }
        inTransaction = false;
        System.out.println("MySQL回滚事务");
    }
    
    @Override
    public boolean isInTransaction() {
        return inTransaction;
    }
}

// PostgreSQL产品族
class PostgreSQLConnection implements DatabaseConnection {
    private boolean connected = false;
    private String connectionString;
    
    public PostgreSQLConnection(String host, int port, String database) {
        this.connectionString = String.format("postgresql://%s:%d/%s", host, port, database);
    }
    
    @Override
    public void connect() {
        connected = true;
        System.out.println("连接到PostgreSQL: " + connectionString);
    }
    
    @Override
    public void disconnect() {
        connected = false;
        System.out.println("断开PostgreSQL连接");
    }
    
    @Override
    public boolean isConnected() {
        return connected;
    }
}

class PostgreSQLQueryExecutor implements QueryExecutor {
    private DatabaseConnection connection;
    
    public PostgreSQLQueryExecutor(DatabaseConnection connection) {
        this.connection = connection;
    }
    
    @Override
    public ResultSet executeQuery(String sql) {
        if (!connection.isConnected()) {
            throw new IllegalStateException("数据库未连接");
        }
        System.out.println("PostgreSQL执行查询: " + sql);
        return new MockResultSet("PostgreSQL查询结果");
    }
    
    @Override
    public int executeUpdate(String sql) {
        if (!connection.isConnected()) {
            throw new IllegalStateException("数据库未连接");
        }
        System.out.println("PostgreSQL执行更新: " + sql);
        return 1;
    }
    
    @Override
    public void executeBatch(String[] sqls) {
        if (!connection.isConnected()) {
            throw new IllegalStateException("数据库未连接");
        }
        System.out.println("PostgreSQL执行批量操作:");
        for (String sql : sqls) {
            System.out.println("  - " + sql);
        }
    }
}

class PostgreSQLTransactionManager implements TransactionManager {
    private boolean inTransaction = false;
    private DatabaseConnection connection;
    
    public PostgreSQLTransactionManager(DatabaseConnection connection) {
        this.connection = connection;
    }
    
    @Override
    public void beginTransaction() {
        if (!connection.isConnected()) {
            throw new IllegalStateException("数据库未连接");
        }
        inTransaction = true;
        System.out.println("PostgreSQL开始事务");
    }
    
    @Override
    public void commit() {
        if (!inTransaction) {
            throw new IllegalStateException("没有活动事务");
        }
        inTransaction = false;
        System.out.println("PostgreSQL提交事务");
    }
    
    @Override
    public void rollback() {
        if (!inTransaction) {
            throw new IllegalStateException("没有活动事务");
        }
        inTransaction = false;
        System.out.println("PostgreSQL回滚事务");
    }
    
    @Override
    public boolean isInTransaction() {
        return inTransaction;
    }
}

// 抽象工厂
interface DatabaseFactory {
    DatabaseConnection createConnection();
    QueryExecutor createQueryExecutor(DatabaseConnection connection);
    TransactionManager createTransactionManager(DatabaseConnection connection);
}

// 具体工厂
class MySQLFactory implements DatabaseFactory {
    private String host;
    private int port;
    private String database;
    
    public MySQLFactory(String host, int port, String database) {
        this.host = host;
        this.port = port;
        this.database = database;
    }
    
    @Override
    public DatabaseConnection createConnection() {
        return new MySQLConnection(host, port, database);
    }
    
    @Override
    public QueryExecutor createQueryExecutor(DatabaseConnection connection) {
        return new MySQLQueryExecutor(connection);
    }
    
    @Override
    public TransactionManager createTransactionManager(DatabaseConnection connection) {
        return new MySQLTransactionManager(connection);
    }
}

class PostgreSQLFactory implements DatabaseFactory {
    private String host;
    private int port;
    private String database;
    
    public PostgreSQLFactory(String host, int port, String database) {
        this.host = host;
        this.port = port;
        this.database = database;
    }
    
    @Override
    public DatabaseConnection createConnection() {
        return new PostgreSQLConnection(host, port, database);
    }
    
    @Override
    public QueryExecutor createQueryExecutor(DatabaseConnection connection) {
        return new PostgreSQLQueryExecutor(connection);
    }
    
    @Override
    public TransactionManager createTransactionManager(DatabaseConnection connection) {
        return new PostgreSQLTransactionManager(connection);
    }
}

// 数据访问层
class DataAccessLayer {
    private DatabaseConnection connection;
    private QueryExecutor queryExecutor;
    private TransactionManager transactionManager;
    
    public DataAccessLayer(DatabaseFactory factory) {
        this.connection = factory.createConnection();
        this.queryExecutor = factory.createQueryExecutor(connection);
        this.transactionManager = factory.createTransactionManager(connection);
    }
    
    public void initialize() {
        connection.connect();
    }
    
    public void performComplexOperation() {
        try {
            transactionManager.beginTransaction();
            
            // 执行多个数据库操作
            queryExecutor.executeUpdate("INSERT INTO users (name, email) VALUES ('张三', 'zhangsan@example.com')");
            queryExecutor.executeUpdate("INSERT INTO orders (user_id, amount) VALUES (1, 100.00)");
            
            String[] batchSql = {
                "UPDATE users SET last_login = NOW() WHERE id = 1",
                "INSERT INTO user_logs (user_id, action) VALUES (1, 'login')"
            };
            queryExecutor.executeBatch(batchSql);
            
            transactionManager.commit();
            System.out.println("复杂操作执行成功");
            
        } catch (Exception e) {
            if (transactionManager.isInTransaction()) {
                transactionManager.rollback();
            }
            System.err.println("操作失败，已回滚: " + e.getMessage());
        }
    }
    
    public void queryData() {
        ResultSet result = queryExecutor.executeQuery("SELECT * FROM users WHERE active = 1");
        System.out.println("查询结果: " + result.getData());
    }
    
    public void cleanup() {
        if (connection.isConnected()) {
            connection.disconnect();
        }
    }
}

// 模拟结果集
class MockResultSet implements ResultSet {
    private String data;
    
    public MockResultSet(String data) {
        this.data = data;
    }
    
    public String getData() {
        return data;
    }
}

interface ResultSet {
    String getData();
}

// 使用示例
public class DatabaseAbstractFactoryExample {
    public static void main(String[] args) {
        // 根据配置选择数据库类型
        String dbType = "mysql"; // 可以从配置文件读取
        
        DatabaseFactory factory;
        if ("mysql".equals(dbType)) {
            factory = new MySQLFactory("localhost", 3306, "testdb");
            System.out.println("=== 使用MySQL数据库 ===");
        } else {
            factory = new PostgreSQLFactory("localhost", 5432, "testdb");
            System.out.println("=== 使用PostgreSQL数据库 ===");
        }
        
        DataAccessLayer dal = new DataAccessLayer(factory);
        
        try {
            dal.initialize();
            dal.queryData();
            dal.performComplexOperation();
        } finally {
            dal.cleanup();
        }
        
        System.out.println("\n=== 切换到另一个数据库 ===");
        
        // 切换到另一个数据库
        DatabaseFactory anotherFactory = new PostgreSQLFactory("localhost", 5432, "testdb");
        DataAccessLayer anotherDal = new DataAccessLayer(anotherFactory);
        
        try {
            anotherDal.initialize();
            anotherDal.queryData();
            anotherDal.performComplexOperation();
        } finally {
            anotherDal.cleanup();
        }
    }
}
```

**抽象工厂模式的关键特点：**
1. **产品族一致性**: 确保创建的产品属于同一个产品族
2. **易于切换产品族**: 只需要更换具体工厂就可以切换整个产品族
3. **符合开放-封闭原则**: 新增产品族只需添加新的具体工厂
4. **产品之间的约束**: 可以在工厂中定义产品之间的约束关系

#### 参与者概念
- **抽象工厂**：声明创建产品族的接口
- **具体工厂**：实现创建具体产品族的方法
- **抽象产品**：声明产品的接口
- **具体产品**：实现产品接口的具体类

### 4. 建造者模式 (Builder)

#### 核心概念
- **建造者**：负责构造复杂对象的各个部分
- **指挥者**：控制构造过程
- **产品**：被构造的复杂对象
- **分步构造**：逐步构建复杂对象

#### 基础例子：电脑组装建造者
```java
// 产品类 - 电脑
class Computer {
    private String cpu;
    private String memory;
    private String storage;
    private String graphics;
    private String motherboard;
    private String powerSupply;
    private boolean hasWifi;
    private boolean hasBluetooth;
    
    // 私有构造函数，只能通过建造者创建
    private Computer() {}
    
    // Getter方法
    public String getCpu() { return cpu; }
    public String getMemory() { return memory; }
    public String getStorage() { return storage; }
    public String getGraphics() { return graphics; }
    public String getMotherboard() { return motherboard; }
    public String getPowerSupply() { return powerSupply; }
    public boolean hasWifi() { return hasWifi; }
    public boolean hasBluetooth() { return hasBluetooth; }
    
    @Override
    public String toString() {
        return String.format(
            "电脑配置:\n" +
            "CPU: %s\n" +
            "内存: %s\n" +
            "存储: %s\n" +
            "显卡: %s\n" +
            "主板: %s\n" +
            "电源: %s\n" +
            "WiFi: %s\n" +
            "蓝牙: %s",
            cpu, memory, storage, graphics, motherboard, powerSupply,
            hasWifi ? "是" : "否", hasBluetooth ? "是" : "否"
        );
    }
    
    // 静态内部类建造者
    public static class Builder {
        private Computer computer;
        
        public Builder() {
            computer = new Computer();
        }
        
        public Builder cpu(String cpu) {
            computer.cpu = cpu;
            return this;
        }
        
        public Builder memory(String memory) {
            computer.memory = memory;
            return this;
        }
        
        public Builder storage(String storage) {
            computer.storage = storage;
            return this;
        }
        
        public Builder graphics(String graphics) {
            computer.graphics = graphics;
            return this;
        }
        
        public Builder motherboard(String motherboard) {
            computer.motherboard = motherboard;
            return this;
        }
        
        public Builder powerSupply(String powerSupply) {
            computer.powerSupply = powerSupply;
            return this;
        }
        
        public Builder wifi(boolean hasWifi) {
            computer.hasWifi = hasWifi;
            return this;
        }
        
        public Builder bluetooth(boolean hasBluetooth) {
            computer.hasBluetooth = hasBluetooth;
            return this;
        }
        
        public Computer build() {
            // 验证必需的组件
            if (computer.cpu == null || computer.memory == null || computer.storage == null) {
                throw new IllegalStateException("CPU、内存和存储是必需的组件");
            }
            
            // 设置默认值
            if (computer.graphics == null) {
                computer.graphics = "集成显卡";
            }
            if (computer.motherboard == null) {
                computer.motherboard = "标准主板";
            }
            if (computer.powerSupply == null) {
                computer.powerSupply = "500W电源";
            }
            
            return computer;
        }
    }
}

// 使用示例
public class ComputerBuilderExample {
    public static void main(String[] args) {
        // 构建游戏电脑
        Computer gamingComputer = new Computer.Builder()
            .cpu("Intel i7-12700K")
            .memory("32GB DDR4")
            .storage("1TB NVMe SSD")
            .graphics("RTX 4070")
            .motherboard("Z690 主板")
            .powerSupply("750W 80+ Gold")
            .wifi(true)
            .bluetooth(true)
            .build();
        
        System.out.println("=== 游戏电脑 ===");
        System.out.println(gamingComputer);
        
        // 构建办公电脑
        Computer officeComputer = new Computer.Builder()
            .cpu("Intel i5-12400")
            .memory("16GB DDR4")
            .storage("512GB SSD")
            .wifi(true)
            .build();
        
        System.out.println("\n=== 办公电脑 ===");
        System.out.println(officeComputer);
    }
}
```

#### 进阶例子：HTTP请求建造者系统
```java
import java.util.*;
import java.util.concurrent.TimeUnit;

// 复杂产品 - HTTP请求
class HttpRequest {
    private String url;
    private String method;
    private Map<String, String> headers;
    private Map<String, String> queryParams;
    private String body;
    private int timeout;
    private int retryCount;
    private boolean followRedirects;
    private String userAgent;
    private Map<String, String> cookies;
    private String contentType;
    private String authorization;
    
    // 私有构造函数
    private HttpRequest() {
        this.headers = new HashMap<>();
        this.queryParams = new HashMap<>();
        this.cookies = new HashMap<>();
    }
    
    // Getter方法
    public String getUrl() { return url; }
    public String getMethod() { return method; }
    public Map<String, String> getHeaders() { return new HashMap<>(headers); }
    public Map<String, String> getQueryParams() { return new HashMap<>(queryParams); }
    public String getBody() { return body; }
    public int getTimeout() { return timeout; }
    public int getRetryCount() { return retryCount; }
    public boolean isFollowRedirects() { return followRedirects; }
    public String getUserAgent() { return userAgent; }
    public Map<String, String> getCookies() { return new HashMap<>(cookies); }
    public String getContentType() { return contentType; }
    public String getAuthorization() { return authorization; }
    
    // 执行请求的模拟方法
    public HttpResponse execute() {
        System.out.println("执行HTTP请求:");
        System.out.println("URL: " + getFullUrl());
        System.out.println("方法: " + method);
        System.out.println("请求头: " + headers);
        if (body != null) {
            System.out.println("请求体: " + body);
        }
        System.out.println("超时时间: " + timeout + "ms");
        System.out.println("重试次数: " + retryCount);
        
        // 模拟响应
        return new HttpResponse(200, "请求成功", "响应内容");
    }
    
    private String getFullUrl() {
        if (queryParams.isEmpty()) {
            return url;
        }
        
        StringBuilder fullUrl = new StringBuilder(url);
        fullUrl.append("?");
        
        boolean first = true;
        for (Map.Entry<String, String> param : queryParams.entrySet()) {
            if (!first) {
                fullUrl.append("&");
            }
            fullUrl.append(param.getKey()).append("=").append(param.getValue());
            first = false;
        }
        
        return fullUrl.toString();
    }
    
    // 建造者类
    public static class Builder {
        private HttpRequest request;
        
        public Builder(String url) {
            request = new HttpRequest();
            request.url = url;
            request.method = "GET"; // 默认方法
            request.timeout = 5000; // 默认超时5秒
            request.retryCount = 0; // 默认不重试
            request.followRedirects = true; // 默认跟随重定向
            request.userAgent = "HttpClient/1.0"; // 默认User-Agent
        }
        
        public Builder method(String method) {
            request.method = method.toUpperCase();
            return this;
        }
        
        public Builder get() {
            return method("GET");
        }
        
        public Builder post() {
            return method("POST");
        }
        
        public Builder put() {
            return method("PUT");
        }
        
        public Builder delete() {
            return method("DELETE");
        }
        
        public Builder header(String name, String value) {
            request.headers.put(name, value);
            return this;
        }
        
        public Builder headers(Map<String, String> headers) {
            request.headers.putAll(headers);
            return this;
        }
        
        public Builder queryParam(String name, String value) {
            request.queryParams.put(name, value);
            return this;
        }
        
        public Builder queryParams(Map<String, String> params) {
            request.queryParams.putAll(params);
            return this;
        }
        
        public Builder body(String body) {
            request.body = body;
            return this;
        }
        
        public Builder jsonBody(String json) {
            request.body = json;
            request.contentType = "application/json";
            request.headers.put("Content-Type", "application/json");
            return this;
        }
        
        public Builder formBody(Map<String, String> formData) {
            StringBuilder body = new StringBuilder();
            boolean first = true;
            for (Map.Entry<String, String> entry : formData.entrySet()) {
                if (!first) {
                    body.append("&");
                }
                body.append(entry.getKey()).append("=").append(entry.getValue());
                first = false;
            }
            request.body = body.toString();
            request.contentType = "application/x-www-form-urlencoded";
            request.headers.put("Content-Type", "application/x-www-form-urlencoded");
            return this;
        }
        
        public Builder timeout(int timeout, TimeUnit unit) {
            request.timeout = (int) unit.toMillis(timeout);
            return this;
        }
        
        public Builder timeout(int timeoutMs) {
            request.timeout = timeoutMs;
            return this;
        }
        
        public Builder retry(int retryCount) {
            request.retryCount = retryCount;
            return this;
        }
        
        public Builder followRedirects(boolean follow) {
            request.followRedirects = follow;
            return this;
        }
        
        public Builder userAgent(String userAgent) {
            request.userAgent = userAgent;
            request.headers.put("User-Agent", userAgent);
            return this;
        }
        
        public Builder cookie(String name, String value) {
            request.cookies.put(name, value);
            return this;
        }
        
        public Builder cookies(Map<String, String> cookies) {
            request.cookies.putAll(cookies);
            return this;
        }
        
        public Builder basicAuth(String username, String password) {
            String credentials = username + ":" + password;
            String encoded = Base64.getEncoder().encodeToString(credentials.getBytes());
            request.authorization = "Basic " + encoded;
            request.headers.put("Authorization", request.authorization);
            return this;
        }
        
        public Builder bearerToken(String token) {
            request.authorization = "Bearer " + token;
            request.headers.put("Authorization", request.authorization);
            return this;
        }
        
        public HttpRequest build() {
            // 验证必需的字段
            if (request.url == null || request.url.trim().isEmpty()) {
                throw new IllegalStateException("URL不能为空");
            }
            
            // 设置Cookie头
            if (!request.cookies.isEmpty()) {
                StringBuilder cookieHeader = new StringBuilder();
                boolean first = true;
                for (Map.Entry<String, String> cookie : request.cookies.entrySet()) {
                    if (!first) {
                        cookieHeader.append("; ");
                    }
                    cookieHeader.append(cookie.getKey()).append("=").append(cookie.getValue());
                    first = false;
                }
                request.headers.put("Cookie", cookieHeader.toString());
            }
            
            return request;
        }
    }
}

// HTTP响应类
class HttpResponse {
    private int statusCode;
    private String statusMessage;
    private String body;
    
    public HttpResponse(int statusCode, String statusMessage, String body) {
        this.statusCode = statusCode;
        this.statusMessage = statusMessage;
        this.body = body;
    }
    
    public int getStatusCode() { return statusCode; }
    public String getStatusMessage() { return statusMessage; }
    public String getBody() { return body; }
    
    @Override
    public String toString() {
        return String.format("HTTP %d %s\n%s", statusCode, statusMessage, body);
    }
}

// 传统建造者模式实现（使用指挥者）
abstract class HttpRequestBuilder {
    protected HttpRequest request;
    
    public HttpRequestBuilder() {
        request = new HttpRequest();
    }
    
    public abstract void buildMethod();
    public abstract void buildHeaders();
    public abstract void buildBody();
    public abstract void buildTimeout();
    
    public HttpRequest getResult() {
        return request;
    }
}

class ApiRequestBuilder extends HttpRequestBuilder {
    private String apiKey;
    private String endpoint;
    
    public ApiRequestBuilder(String endpoint, String apiKey) {
        super();
        this.endpoint = endpoint;
        this.apiKey = apiKey;
    }
    
    @Override
    public void buildMethod() {
        // API请求通常使用POST
        request = new HttpRequest.Builder(endpoint).post().build();
    }
    
    @Override
    public void buildHeaders() {
        request = new HttpRequest.Builder(endpoint)
            .post()
            .header("X-API-Key", apiKey)
            .header("Accept", "application/json")
            .build();
    }
    
    @Override
    public void buildBody() {
        request = new HttpRequest.Builder(endpoint)
            .post()
            .header("X-API-Key", apiKey)
            .header("Accept", "application/json")
            .jsonBody("{\"action\": \"getData\"}")
            .build();
    }
    
    @Override
    public void buildTimeout() {
        request = new HttpRequest.Builder(endpoint)
            .post()
            .header("X-API-Key", apiKey)
            .header("Accept", "application/json")
            .jsonBody("{\"action\": \"getData\"}")
            .timeout(10, TimeUnit.SECONDS)
            .retry(3)
            .build();
    }
}

// 指挥者
class HttpRequestDirector {
    public HttpRequest constructApiRequest(HttpRequestBuilder builder) {
        builder.buildMethod();
        builder.buildHeaders();
        builder.buildBody();
        builder.buildTimeout();
        return builder.getResult();
    }
}

// 使用示例
public class HttpRequestBuilderExample {
    public static void main(String[] args) {
        System.out.println("=== 链式建造者示例 ===");
        
        // 构建GET请求
        HttpRequest getRequest = new HttpRequest.Builder("https://api.example.com/users")
            .get()
            .queryParam("page", "1")
            .queryParam("limit", "10")
            .header("Accept", "application/json")
            .userAgent("MyApp/1.0")
            .timeout(5, TimeUnit.SECONDS)
            .build();
        
        HttpResponse getResponse = getRequest.execute();
        System.out.println("GET响应: " + getResponse);
        
        System.out.println("\n=== POST请求示例 ===");
        
        // 构建POST请求
        Map<String, String> formData = new HashMap<>();
        formData.put("username", "john");
        formData.put("password", "secret");
        
        HttpRequest postRequest = new HttpRequest.Builder("https://api.example.com/login")
            .post()
            .formBody(formData)
            .timeout(10000)
            .retry(2)
            .build();
        
        HttpResponse postResponse = postRequest.execute();
        System.out.println("POST响应: " + postResponse);
        
        System.out.println("\n=== 复杂API请求示例 ===");
        
        // 构建复杂的API请求
        HttpRequest apiRequest = new HttpRequest.Builder("https://api.example.com/data")
            .post()
            .jsonBody("{\"query\": \"SELECT * FROM users\", \"limit\": 100}")
            .bearerToken("eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...")
            .header("X-Request-ID", UUID.randomUUID().toString())
            .cookie("session", "abc123")
            .cookie("preferences", "theme=dark")
            .timeout(30, TimeUnit.SECONDS)
            .retry(3)
            .followRedirects(false)
            .userAgent("DataAnalyzer/2.1")
            .build();
        
        HttpResponse apiResponse = apiRequest.execute();
        System.out.println("API响应: " + apiResponse);
        
        System.out.println("\n=== 传统建造者模式示例 ===");
        
        // 使用传统建造者模式
        HttpRequestDirector director = new HttpRequestDirector();
        ApiRequestBuilder builder = new ApiRequestBuilder("https://api.example.com/endpoint", "api-key-123");
        
        HttpRequest directorRequest = director.constructApiRequest(builder);
        HttpResponse directorResponse = directorRequest.execute();
        System.out.println("指挥者构建的请求响应: " + directorResponse);
    }
}
```

**建造者模式的关键特点：**
1. **分步构造**: 可以分步骤构造复杂对象
2. **参数验证**: 在build()方法中进行参数验证
3. **不可变对象**: 构造完成后对象通常是不可变的
4. **链式调用**: 支持流畅的链式调用语法
5. **默认值处理**: 可以为可选参数提供合理的默认值

#### 实现概念
- **传统建造者**：使用指挥者控制构造过程
- **链式建造者**：支持方法链式调用
- **静态内部类建造者**：常见的Java实现方式
- **注解驱动建造者**：通过注解自动生成建造者

### 5. 原型模式 (Prototype)

#### 核心概念
- **原型**：用于创建对象的样板
- **克隆**：通过复制现有对象创建新对象
- **原型管理器**：管理原型对象的注册表

#### 基础例子：图形对象克隆
```java
// 抽象原型
abstract class Shape implements Cloneable {
    protected String id;
    protected String type;
    protected int x, y;
    protected String color;
    
    public Shape() {}
    
    public Shape(Shape source) {
        if (source != null) {
            this.id = source.id;
            this.type = source.type;
            this.x = source.x;
            this.y = source.y;
            this.color = source.color;
        }
    }
    
    // 抽象克隆方法
    public abstract Shape clone();
    
    // 抽象绘制方法
    public abstract void draw();
    
    // Getter和Setter方法
    public String getId() { return id; }
    public void setId(String id) { this.id = id; }
    public String getType() { return type; }
    public void setType(String type) { this.type = type; }
    public int getX() { return x; }
    public void setX(int x) { this.x = x; }
    public int getY() { return y; }
    public void setY(int y) { this.y = y; }
    public String getColor() { return color; }
    public void setColor(String color) { this.color = color; }
    
    @Override
    public String toString() {
        return String.format("%s[id=%s, position=(%d,%d), color=%s]", 
                           type, id, x, y, color);
    }
}

// 具体原型 - 圆形
class Circle extends Shape {
    private int radius;
    
    public Circle() {
        this.type = "Circle";
    }
    
    public Circle(Circle source) {
        super(source);
        if (source != null) {
            this.radius = source.radius;
        }
    }
    
    @Override
    public Shape clone() {
        return new Circle(this);
    }
    
    @Override
    public void draw() {
        System.out.println("绘制圆形: " + this + ", 半径=" + radius);
    }
    
    public int getRadius() { return radius; }
    public void setRadius(int radius) { this.radius = radius; }
}

// 具体原型 - 矩形
class Rectangle extends Shape {
    private int width, height;
    
    public Rectangle() {
        this.type = "Rectangle";
    }
    
    public Rectangle(Rectangle source) {
        super(source);
        if (source != null) {
            this.width = source.width;
            this.height = source.height;
        }
    }
    
    @Override
    public Shape clone() {
        return new Rectangle(this);
    }
    
    @Override
    public void draw() {
        System.out.println("绘制矩形: " + this + ", 尺寸=" + width + "x" + height);
    }
    
    public int getWidth() { return width; }
    public void setWidth(int width) { this.width = width; }
    public int getHeight() { return height; }
    public void setHeight(int height) { this.height = height; }
}

// 原型管理器
class ShapeCache {
    private static Map<String, Shape> shapeMap = new HashMap<>();
    
    public static Shape getShape(String shapeId) {
        Shape cachedShape = shapeMap.get(shapeId);
        return cachedShape != null ? cachedShape.clone() : null;
    }
    
    public static void loadCache() {
        Circle circle = new Circle();
        circle.setId("1");
        circle.setX(10);
        circle.setY(20);
        circle.setColor("红色");
        circle.setRadius(5);
        shapeMap.put(circle.getId(), circle);
        
        Rectangle rectangle = new Rectangle();
        rectangle.setId("2");
        rectangle.setX(30);
        rectangle.setY(40);
        rectangle.setColor("蓝色");
        rectangle.setWidth(15);
        rectangle.setHeight(10);
        shapeMap.put(rectangle.getId(), rectangle);
        
        System.out.println("原型缓存已加载");
    }
    
    public static void addShape(String id, Shape shape) {
        shapeMap.put(id, shape);
    }
    
    public static Set<String> getAvailableShapes() {
        return shapeMap.keySet();
    }
}

// 使用示例
public class PrototypeExample {
    public static void main(String[] args) {
        // 加载原型缓存
        ShapeCache.loadCache();
        
        System.out.println("可用的原型: " + ShapeCache.getAvailableShapes());
        
        // 克隆圆形
        Shape clonedCircle1 = ShapeCache.getShape("1");
        clonedCircle1.draw();
        
        Shape clonedCircle2 = ShapeCache.getShape("1");
        clonedCircle2.setColor("绿色");
        clonedCircle2.setX(50);
        clonedCircle2.draw();
        
        // 克隆矩形
        Shape clonedRectangle = ShapeCache.getShape("2");
        clonedRectangle.draw();
        
        // 验证克隆的独立性
        System.out.println("\n验证克隆独立性:");
        System.out.println("原始圆形颜色: " + ShapeCache.getShape("1").getColor());
        System.out.println("修改后的圆形颜色: " + clonedCircle2.getColor());
    }
}
```

#### 进阶例子：文档模板克隆系统
```java
import java.io.*;
import java.util.*;
import java.util.concurrent.ConcurrentHashMap;

// 复杂对象 - 文档
class Document implements Cloneable, Serializable {
    private static final long serialVersionUID = 1L;
    
    private String title;
    private String content;
    private List<String> tags;
    private Map<String, Object> metadata;
    private List<Attachment> attachments;
    private DocumentStyle style;
    private Date createdDate;
    private Date modifiedDate;
    
    public Document() {
        this.tags = new ArrayList<>();
        this.metadata = new HashMap<>();
        this.attachments = new ArrayList<>();
        this.createdDate = new Date();
        this.modifiedDate = new Date();
    }
    
    // 拷贝构造函数 - 深拷贝
    public Document(Document source) {
        if (source != null) {
            this.title = source.title;
            this.content = source.content;
            
            // 深拷贝集合
            this.tags = new ArrayList<>(source.tags);
            this.metadata = new HashMap<>(source.metadata);
            
            // 深拷贝附件列表
            this.attachments = new ArrayList<>();
            for (Attachment attachment : source.attachments) {
                this.attachments.add(new Attachment(attachment));
            }
            
            // 深拷贝样式
            this.style = source.style != null ? new DocumentStyle(source.style) : null;
            
            // 拷贝日期
            this.createdDate = new Date(source.createdDate.getTime());
            this.modifiedDate = new Date();
        }
    }
    
    // 浅拷贝
    @Override
    public Document clone() {
        try {
            Document cloned = (Document) super.clone();
            cloned.modifiedDate = new Date();
            return cloned;
        } catch (CloneNotSupportedException e) {
            throw new RuntimeException("克隆失败", e);
        }
    }
    
    // 深拷贝
    public Document deepClone() {
        return new Document(this);
    }
    
    // 序列化深拷贝
    public Document serializationClone() {
        try {
            ByteArrayOutputStream bos = new ByteArrayOutputStream();
            ObjectOutputStream oos = new ObjectOutputStream(bos);
            oos.writeObject(this);
            oos.close();
            
            ByteArrayInputStream bis = new ByteArrayInputStream(bos.toByteArray());
            ObjectInputStream ois = new ObjectInputStream(bis);
            Document cloned = (Document) ois.readObject();
            ois.close();
            
            cloned.modifiedDate = new Date();
            return cloned;
        } catch (IOException | ClassNotFoundException e) {
            throw new RuntimeException("序列化克隆失败", e);
        }
    }
    
    // Getter和Setter方法
    public String getTitle() { return title; }
    public void setTitle(String title) { 
        this.title = title; 
        this.modifiedDate = new Date();
    }
    
    public String getContent() { return content; }
    public void setContent(String content) { 
        this.content = content; 
        this.modifiedDate = new Date();
    }
    
    public List<String> getTags() { return tags; }
    public void addTag(String tag) { 
        this.tags.add(tag); 
        this.modifiedDate = new Date();
    }
    
    public Map<String, Object> getMetadata() { return metadata; }
    public void setMetadata(String key, Object value) { 
        this.metadata.put(key, value); 
        this.modifiedDate = new Date();
    }
    
    public List<Attachment> getAttachments() { return attachments; }
    public void addAttachment(Attachment attachment) { 
        this.attachments.add(attachment); 
        this.modifiedDate = new Date();
    }
    
    public DocumentStyle getStyle() { return style; }
    public void setStyle(DocumentStyle style) { 
        this.style = style; 
        this.modifiedDate = new Date();
    }
    
    public Date getCreatedDate() { return createdDate; }
    public Date getModifiedDate() { return modifiedDate; }
    
    @Override
    public String toString() {
        return String.format("Document[title='%s', tags=%s, attachments=%d, created=%s, modified=%s]",
                           title, tags, attachments.size(), createdDate, modifiedDate);
    }
}

// 附件类
class Attachment implements Serializable {
    private static final long serialVersionUID = 1L;
    
    private String filename;
    private String contentType;
    private long size;
    private byte[] data;
    
    public Attachment(String filename, String contentType, byte[] data) {
        this.filename = filename;
        this.contentType = contentType;
        this.data = data != null ? data.clone() : null;
        this.size = data != null ? data.length : 0;
    }
    
    public Attachment(Attachment source) {
        if (source != null) {
            this.filename = source.filename;
            this.contentType = source.contentType;
            this.size = source.size;
            this.data = source.data != null ? source.data.clone() : null;
        }
    }
    
    // Getter方法
    public String getFilename() { return filename; }
    public String getContentType() { return contentType; }
    public long getSize() { return size; }
    public byte[] getData() { return data != null ? data.clone() : null; }
    
    @Override
    public String toString() {
        return String.format("Attachment[filename='%s', type='%s', size=%d]", 
                           filename, contentType, size);
    }
}

// 文档样式类
class DocumentStyle implements Serializable {
    private static final long serialVersionUID = 1L;
    
    private String fontFamily;
    private int fontSize;
    private String fontColor;
    private String backgroundColor;
    private int lineSpacing;
    private String alignment;
    
    public DocumentStyle() {
        this.fontFamily = "Arial";
        this.fontSize = 12;
        this.fontColor = "#000000";
        this.backgroundColor = "#FFFFFF";
        this.lineSpacing = 1;
        this.alignment = "left";
    }
    
    public DocumentStyle(DocumentStyle source) {
        if (source != null) {
            this.fontFamily = source.fontFamily;
            this.fontSize = source.fontSize;
            this.fontColor = source.fontColor;
            this.backgroundColor = source.backgroundColor;
            this.lineSpacing = source.lineSpacing;
            this.alignment = source.alignment;
        }
    }
    
    // Getter和Setter方法
    public String getFontFamily() { return fontFamily; }
    public void setFontFamily(String fontFamily) { this.fontFamily = fontFamily; }
    public int getFontSize() { return fontSize; }
    public void setFontSize(int fontSize) { this.fontSize = fontSize; }
    public String getFontColor() { return fontColor; }
    public void setFontColor(String fontColor) { this.fontColor = fontColor; }
    public String getBackgroundColor() { return backgroundColor; }
    public void setBackgroundColor(String backgroundColor) { this.backgroundColor = backgroundColor; }
    public int getLineSpacing() { return lineSpacing; }
    public void setLineSpacing(int lineSpacing) { this.lineSpacing = lineSpacing; }
    public String getAlignment() { return alignment; }
    public void setAlignment(String alignment) { this.alignment = alignment; }
    
    @Override
    public String toString() {
        return String.format("Style[font=%s %dpx, color=%s, bg=%s, align=%s]",
                           fontFamily, fontSize, fontColor, backgroundColor, alignment);
    }
}

// 文档模板管理器
class DocumentTemplateManager {
    private static final Map<String, Document> templates = new ConcurrentHashMap<>();
    private static final Map<String, Integer> usageCount = new ConcurrentHashMap<>();
    
    static {
        initializeTemplates();
    }
    
    private static void initializeTemplates() {
        // 创建报告模板
        Document reportTemplate = new Document();
        reportTemplate.setTitle("月度报告模板");
        reportTemplate.setContent("# 月度报告\n\n## 概述\n\n## 详细内容\n\n## 结论");
        reportTemplate.addTag("报告");
        reportTemplate.addTag("模板");
        reportTemplate.setMetadata("category", "business");
        reportTemplate.setMetadata("version", "1.0");
        
        DocumentStyle reportStyle = new DocumentStyle();
        reportStyle.setFontFamily("Times New Roman");
        reportStyle.setFontSize(14);
        reportStyle.setLineSpacing(2);
        reportTemplate.setStyle(reportStyle);
        
        templates.put("report", reportTemplate);
        
        // 创建邮件模板
        Document emailTemplate = new Document();
        emailTemplate.setTitle("邮件模板");
        emailTemplate.setContent("尊敬的 [客户姓名]，\n\n感谢您的咨询...\n\n此致\n敬礼");
        emailTemplate.addTag("邮件");
        emailTemplate.addTag("客服");
        emailTemplate.setMetadata("category", "communication");
        emailTemplate.setMetadata("priority", "normal");
        
        DocumentStyle emailStyle = new DocumentStyle();
        emailStyle.setFontFamily("Arial");
        emailStyle.setFontSize(12);
        emailTemplate.setStyle(emailStyle);
        
        templates.put("email", emailTemplate);
        
        // 创建合同模板
        Document contractTemplate = new Document();
        contractTemplate.setTitle("服务合同模板");
        contractTemplate.setContent("服务合同\n\n甲方：[公司名称]\n乙方：[客户名称]\n\n合同条款：\n1. ...\n2. ...");
        contractTemplate.addTag("合同");
        contractTemplate.addTag("法律");
        contractTemplate.setMetadata("category", "legal");
        contractTemplate.setMetadata("requires_review", true);
        
        // 添加附件
        byte[] sampleData = "合同附件示例内容".getBytes();
        contractTemplate.addAttachment(new Attachment("contract_terms.txt", "text/plain", sampleData));
        
        DocumentStyle contractStyle = new DocumentStyle();
        contractStyle.setFontFamily("SimSun");
        contractStyle.setFontSize(12);
        contractStyle.setLineSpacing(2);
        contractTemplate.setStyle(contractStyle);
        
        templates.put("contract", contractTemplate);
        
        System.out.println("文档模板已初始化: " + templates.keySet());
    }
    
    public static Document getTemplate(String templateName) {
        Document template = templates.get(templateName);
        if (template == null) {
            throw new IllegalArgumentException("模板不存在: " + templateName);
        }
        
        // 记录使用次数
        usageCount.merge(templateName, 1, Integer::sum);
        
        return template.deepClone();
    }
    
    public static Document getTemplateByClone(String templateName) {
        Document template = templates.get(templateName);
        if (template == null) {
            throw new IllegalArgumentException("模板不存在: " + templateName);
        }
        
        usageCount.merge(templateName, 1, Integer::sum);
        return template.clone(); // 浅拷贝
    }
    
    public static Document getTemplateBySerialization(String templateName) {
        Document template = templates.get(templateName);
        if (template == null) {
            throw new IllegalArgumentException("模板不存在: " + templateName);
        }
        
        usageCount.merge(templateName, 1, Integer::sum);
        return template.serializationClone(); // 序列化深拷贝
    }
    
    public static void addTemplate(String name, Document template) {
        templates.put(name, template);
        usageCount.put(name, 0);
    }
    
    public static Set<String> getAvailableTemplates() {
        return templates.keySet();
    }
    
    public static Map<String, Integer> getUsageStatistics() {
        return new HashMap<>(usageCount);
    }
    
    public static void printTemplateInfo(String templateName) {
        Document template = templates.get(templateName);
        if (template != null) {
            System.out.println("模板信息: " + template);
            System.out.println("样式: " + template.getStyle());
            System.out.println("附件: " + template.getAttachments());
            System.out.println("使用次数: " + usageCount.getOrDefault(templateName, 0));
        }
    }
}

// 使用示例
public class DocumentPrototypeExample {
    public static void main(String[] args) {
        System.out.println("=== 文档模板克隆系统 ===");
        System.out.println("可用模板: " + DocumentTemplateManager.getAvailableTemplates());
        
        // 使用深拷贝创建文档
        System.out.println("\n--- 深拷贝示例 ---");
        Document report1 = DocumentTemplateManager.getTemplate("report");
        report1.setTitle("2024年1月销售报告");
        report1.setContent(report1.getContent().replace("[月份]", "1月"));
        report1.addTag("销售");
        report1.setMetadata("month", "2024-01");
        
        Document report2 = DocumentTemplateManager.getTemplate("report");
        report2.setTitle("2024年2月销售报告");
        report2.setContent(report2.getContent().replace("[月份]", "2月"));
        report2.addTag("销售");
        report2.setMetadata("month", "2024-02");
        
        System.out.println("报告1: " + report1);
        System.out.println("报告2: " + report2);
        
        // 使用浅拷贝创建文档
        System.out.println("\n--- 浅拷贝示例 ---");
        Document email1 = DocumentTemplateManager.getTemplateByClone("email");
        email1.setTitle("客户咨询回复");
        email1.addTag("客服回复");
        
        Document email2 = DocumentTemplateManager.getTemplateByClone("email");
        email2.setTitle("产品介绍邮件");
        
        System.out.println("邮件1: " + email1);
        System.out.println("邮件2: " + email2);
        
        // 验证浅拷贝的共享问题
        System.out.println("邮件1标签: " + email1.getTags());
        System.out.println("邮件2标签: " + email2.getTags());
        
        // 使用序列化克隆
        System.out.println("\n--- 序列化克隆示例 ---");
        Document contract1 = DocumentTemplateManager.getTemplateBySerialization("contract");
        contract1.setTitle("软件开发服务合同");
        contract1.setContent(contract1.getContent().replace("[公司名称]", "科技有限公司"));
        contract1.setContent(contract1.getContent().replace("[客户名称]", "ABC公司"));
        
        System.out.println("合同1: " + contract1);
        System.out.println("合同1附件: " + contract1.getAttachments());
        
        // 性能测试
        System.out.println("\n--- 性能测试 ---");
        long startTime, endTime;
        int iterations = 1000;
        
        // 测试深拷贝性能
        startTime = System.currentTimeMillis();
        for (int i = 0; i < iterations; i++) {
            Document doc = DocumentTemplateManager.getTemplate("contract");
        }
        endTime = System.currentTimeMillis();
        System.out.println("深拷贝 " + iterations + " 次耗时: " + (endTime - startTime) + "ms");
        
        // 测试浅拷贝性能
        startTime = System.currentTimeMillis();
        for (int i = 0; i < iterations; i++) {
            Document doc = DocumentTemplateManager.getTemplateByClone("contract");
        }
        endTime = System.currentTimeMillis();
        System.out.println("浅拷贝 " + iterations + " 次耗时: " + (endTime - startTime) + "ms");
        
        // 测试序列化克隆性能
        startTime = System.currentTimeMillis();
        for (int i = 0; i < iterations; i++) {
            Document doc = DocumentTemplateManager.getTemplateBySerialization("contract");
        }
        endTime = System.currentTimeMillis();
        System.out.println("序列化克隆 " + iterations + " 次耗时: " + (endTime - startTime) + "ms");
        
        // 显示使用统计
        System.out.println("\n--- 使用统计 ---");
        Map<String, Integer> stats = DocumentTemplateManager.getUsageStatistics();
        stats.forEach((template, count) -> 
            System.out.println(template + ": " + count + " 次"));
        
        // 显示模板详细信息
        System.out.println("\n--- 模板详细信息 ---");
        DocumentTemplateManager.printTemplateInfo("contract");
    }
}
```

**原型模式的关键特点：**
1. **避免重复创建**: 通过克隆避免重复的初始化过程
2. **运行时配置**: 可以在运行时动态添加和删除原型
3. **减少子类**: 避免为每种产品创建工厂子类
4. **性能优化**: 克隆通常比new操作更快
5. **深浅拷贝选择**: 根据需要选择合适的拷贝方式

#### 克隆概念
- **浅拷贝**：只复制对象的基本类型字段
- **深拷贝**：递归复制对象的所有字段
- **序列化克隆**：通过序列化实现深拷贝
- **手动克隆**：自定义克隆逻辑

## 第三部分：结构型模式概念

### 1. 适配器模式 (Adapter)

#### 核心概念
- **适配器**：将一个接口转换成客户期望的另一个接口
- **目标接口**：客户端期望的接口
- **适配者**：需要被适配的现有类
- **接口转换**：不兼容接口的转换

#### 基础例子：音频播放器适配器
```java
// 目标接口 - 客户端期望的接口
interface MediaPlayer {
    void play(String audioType, String fileName);
}

// 适配者接口 - 高级媒体播放器
interface AdvancedMediaPlayer {
    void playVlc(String fileName);
    void playMp4(String fileName);
}

// 具体适配者 - VLC播放器
class VlcPlayer implements AdvancedMediaPlayer {
    @Override
    public void playVlc(String fileName) {
        System.out.println("播放VLC文件: " + fileName);
    }
    
    @Override
    public void playMp4(String fileName) {
        // VLC播放器不支持MP4
    }
}

// 具体适配者 - MP4播放器
class Mp4Player implements AdvancedMediaPlayer {
    @Override
    public void playVlc(String fileName) {
        // MP4播放器不支持VLC
    }
    
    @Override
    public void playMp4(String fileName) {
        System.out.println("播放MP4文件: " + fileName);
    }
}

// 适配器类 - 对象适配器
class MediaAdapter implements MediaPlayer {
    private AdvancedMediaPlayer advancedPlayer;
    
    public MediaAdapter(String audioType) {
        if ("vlc".equalsIgnoreCase(audioType)) {
            advancedPlayer = new VlcPlayer();
        } else if ("mp4".equalsIgnoreCase(audioType)) {
            advancedPlayer = new Mp4Player();
        }
    }
    
    @Override
    public void play(String audioType, String fileName) {
        if ("vlc".equalsIgnoreCase(audioType)) {
            advancedPlayer.playVlc(fileName);
        } else if ("mp4".equalsIgnoreCase(audioType)) {
            advancedPlayer.playMp4(fileName);
        }
    }
}

// 具体目标类 - 音频播放器
class AudioPlayer implements MediaPlayer {
    private MediaAdapter mediaAdapter;
    
    @Override
    public void play(String audioType, String fileName) {
        // 内置支持MP3格式
        if ("mp3".equalsIgnoreCase(audioType)) {
            System.out.println("播放MP3文件: " + fileName);
        }
        // 使用适配器支持其他格式
        else if ("vlc".equalsIgnoreCase(audioType) || "mp4".equalsIgnoreCase(audioType)) {
            mediaAdapter = new MediaAdapter(audioType);
            mediaAdapter.play(audioType, fileName);
        } else {
            System.out.println("不支持的音频格式: " + audioType);
        }
    }
}

// 使用示例
public class AdapterExample {
    public static void main(String[] args) {
        AudioPlayer audioPlayer = new AudioPlayer();
        
        audioPlayer.play("mp3", "beyond_the_horizon.mp3");
        audioPlayer.play("mp4", "alone.mp4");
        audioPlayer.play("vlc", "far_far_away.vlc");
        audioPlayer.play("avi", "mind_me.avi");
    }
}
```

#### 进阶例子：第三方支付系统适配器
```java
// 目标接口 - 统一支付接口
interface PaymentProcessor {
    PaymentResult processPayment(PaymentRequest request);
    PaymentResult refund(String transactionId, double amount);
    PaymentStatus queryPaymentStatus(String transactionId);
}

// 支付请求
class PaymentRequest {
    private String orderId;
    private double amount;
    private String currency;
    private String description;
    private Map<String, String> customerInfo;
    
    public PaymentRequest(String orderId, double amount, String currency, String description) {
        this.orderId = orderId;
        this.amount = amount;
        this.currency = currency;
        this.description = description;
        this.customerInfo = new HashMap<>();
    }
    
    // Getter和Setter方法
    public String getOrderId() { return orderId; }
    public double getAmount() { return amount; }
    public String getCurrency() { return currency; }
    public String getDescription() { return description; }
    public Map<String, String> getCustomerInfo() { return customerInfo; }
    public void setCustomerInfo(String key, String value) { customerInfo.put(key, value); }
}

// 支付结果
class PaymentResult {
    private boolean success;
    private String transactionId;
    private String message;
    private String errorCode;
    private Date timestamp;
    
    public PaymentResult(boolean success, String transactionId, String message) {
        this.success = success;
        this.transactionId = transactionId;
        this.message = message;
        this.timestamp = new Date();
    }
    
    // Getter方法
    public boolean isSuccess() { return success; }
    public String getTransactionId() { return transactionId; }
    public String getMessage() { return message; }
    public String getErrorCode() { return errorCode; }
    public void setErrorCode(String errorCode) { this.errorCode = errorCode; }
    public Date getTimestamp() { return timestamp; }
    
    @Override
    public String toString() {
        return String.format("PaymentResult[success=%s, transactionId=%s, message=%s, timestamp=%s]",
                           success, transactionId, message, timestamp);
    }
}

// 支付状态枚举
enum PaymentStatus {
    PENDING, SUCCESS, FAILED, CANCELLED, REFUNDED
}

// 第三方支付系统1 - 支付宝（适配者）
class AlipaySDK {
    public AlipayResponse pay(AlipayRequest request) {
        System.out.println("调用支付宝支付接口");
        System.out.println("订单号: " + request.getOutTradeNo());
        System.out.println("金额: " + request.getTotalAmount() + " " + request.getCurrency());
        
        // 模拟支付处理
        String tradeNo = "ALIPAY_" + System.currentTimeMillis();
        return new AlipayResponse("10000", "Success", tradeNo);
    }
    
    public AlipayRefundResponse refund(String tradeNo, double amount) {
        System.out.println("调用支付宝退款接口");
        System.out.println("交易号: " + tradeNo + ", 退款金额: " + amount);
        
        String refundNo = "REFUND_" + System.currentTimeMillis();
        return new AlipayRefundResponse("10000", "Success", refundNo);
    }
    
    public AlipayQueryResponse queryTrade(String tradeNo) {
        System.out.println("查询支付宝交易状态: " + tradeNo);
        return new AlipayQueryResponse("10000", "TRADE_SUCCESS", tradeNo);
    }
}

// 支付宝请求对象
class AlipayRequest {
    private String outTradeNo;
    private String totalAmount;
    private String currency;
    private String subject;
    
    public AlipayRequest(String outTradeNo, String totalAmount, String currency, String subject) {
        this.outTradeNo = outTradeNo;
        this.totalAmount = totalAmount;
        this.currency = currency;
        this.subject = subject;
    }
    
    public String getOutTradeNo() { return outTradeNo; }
    public String getTotalAmount() { return totalAmount; }
    public String getCurrency() { return currency; }
    public String getSubject() { return subject; }
}

// 支付宝响应对象
class AlipayResponse {
    private String code;
    private String msg;
    private String tradeNo;
    
    public AlipayResponse(String code, String msg, String tradeNo) {
        this.code = code;
        this.msg = msg;
        this.tradeNo = tradeNo;
    }
    
    public String getCode() { return code; }
    public String getMsg() { return msg; }
    public String getTradeNo() { return tradeNo; }
    public boolean isSuccess() { return "10000".equals(code); }
}

class AlipayRefundResponse {
    private String code;
    private String msg;
    private String refundNo;
    
    public AlipayRefundResponse(String code, String msg, String refundNo) {
        this.code = code;
        this.msg = msg;
        this.refundNo = refundNo;
    }
    
    public String getCode() { return code; }
    public String getMsg() { return msg; }
    public String getRefundNo() { return refundNo; }
    public boolean isSuccess() { return "10000".equals(code); }
}

class AlipayQueryResponse {
    private String code;
    private String tradeStatus;
    private String tradeNo;
    
    public AlipayQueryResponse(String code, String tradeStatus, String tradeNo) {
        this.code = code;
        this.tradeStatus = tradeStatus;
        this.tradeNo = tradeNo;
    }
    
    public String getCode() { return code; }
    public String getTradeStatus() { return tradeStatus; }
    public String getTradeNo() { return tradeNo; }
}

// 第三方支付系统2 - 微信支付（适配者）
class WechatPaySDK {
    public WechatPayResponse unifiedOrder(WechatPayRequest request) {
        System.out.println("调用微信支付统一下单接口");
        System.out.println("商户订单号: " + request.getOutTradeNo());
        System.out.println("金额: " + request.getTotalFee() + " 分");
        
        String prepayId = "WECHAT_" + System.currentTimeMillis();
        return new WechatPayResponse("SUCCESS", "OK", prepayId);
    }
    
    public WechatRefundResponse refund(String transactionId, int refundFee) {
        System.out.println("调用微信支付退款接口");
        System.out.println("交易号: " + transactionId + ", 退款金额: " + refundFee + " 分");
        
        String refundId = "WX_REFUND_" + System.currentTimeMillis();
        return new WechatRefundResponse("SUCCESS", "OK", refundId);
    }
    
    public WechatQueryResponse orderQuery(String transactionId) {
        System.out.println("查询微信支付订单状态: " + transactionId);
        return new WechatQueryResponse("SUCCESS", "SUCCESS", transactionId);
    }
}

// 微信支付请求对象
class WechatPayRequest {
    private String outTradeNo;
    private int totalFee; // 微信支付金额以分为单位
    private String body;
    
    public WechatPayRequest(String outTradeNo, int totalFee, String body) {
        this.outTradeNo = outTradeNo;
        this.totalFee = totalFee;
        this.body = body;
    }
    
    public String getOutTradeNo() { return outTradeNo; }
    public int getTotalFee() { return totalFee; }
    public String getBody() { return body; }
}

// 微信支付响应对象
class WechatPayResponse {
    private String returnCode;
    private String returnMsg;
    private String prepayId;
    
    public WechatPayResponse(String returnCode, String returnMsg, String prepayId) {
        this.returnCode = returnCode;
        this.returnMsg = returnMsg;
        this.prepayId = prepayId;
    }
    
    public String getReturnCode() { return returnCode; }
    public String getReturnMsg() { return returnMsg; }
    public String getPrepayId() { return prepayId; }
    public boolean isSuccess() { return "SUCCESS".equals(returnCode); }
}

class WechatRefundResponse {
    private String returnCode;
    private String returnMsg;
    private String refundId;
    
    public WechatRefundResponse(String returnCode, String returnMsg, String refundId) {
        this.returnCode = returnCode;
        this.returnMsg = returnMsg;
        this.refundId = refundId;
    }
    
    public String getReturnCode() { return returnCode; }
    public String getReturnMsg() { return returnMsg; }
    public String getRefundId() { return refundId; }
    public boolean isSuccess() { return "SUCCESS".equals(returnCode); }
}

class WechatQueryResponse {
    private String returnCode;
    private String tradeState;
    private String transactionId;
    
    public WechatQueryResponse(String returnCode, String tradeState, String transactionId) {
        this.returnCode = returnCode;
        this.tradeState = tradeState;
        this.transactionId = transactionId;
    }
    
    public String getReturnCode() { return returnCode; }
    public String getTradeState() { return tradeState; }
    public String getTransactionId() { return transactionId; }
}

// 支付宝适配器
class AlipayAdapter implements PaymentProcessor {
    private AlipaySDK alipaySDK;
    
    public AlipayAdapter() {
        this.alipaySDK = new AlipaySDK();
    }
    
    @Override
    public PaymentResult processPayment(PaymentRequest request) {
        try {
            // 转换请求格式
            AlipayRequest alipayRequest = new AlipayRequest(
                request.getOrderId(),
                String.valueOf(request.getAmount()),
                request.getCurrency(),
                request.getDescription()
            );
            
            // 调用支付宝接口
            AlipayResponse response = alipaySDK.pay(alipayRequest);
            
            // 转换响应格式
            if (response.isSuccess()) {
                return new PaymentResult(true, response.getTradeNo(), "支付成功");
            } else {
                PaymentResult result = new PaymentResult(false, null, response.getMsg());
                result.setErrorCode(response.getCode());
                return result;
            }
        } catch (Exception e) {
            return new PaymentResult(false, null, "支付失败: " + e.getMessage());
        }
    }
    
    @Override
    public PaymentResult refund(String transactionId, double amount) {
        try {
            AlipayRefundResponse response = alipaySDK.refund(transactionId, amount);
            
            if (response.isSuccess()) {
                return new PaymentResult(true, response.getRefundNo(), "退款成功");
            } else {
                PaymentResult result = new PaymentResult(false, null, response.getMsg());
                result.setErrorCode(response.getCode());
                return result;
            }
        } catch (Exception e) {
            return new PaymentResult(false, null, "退款失败: " + e.getMessage());
        }
    }
    
    @Override
    public PaymentStatus queryPaymentStatus(String transactionId) {
        try {
            AlipayQueryResponse response = alipaySDK.queryTrade(transactionId);
            
            switch (response.getTradeStatus()) {
                case "TRADE_SUCCESS":
                    return PaymentStatus.SUCCESS;
                case "TRADE_CLOSED":
                    return PaymentStatus.CANCELLED;
                case "WAIT_BUYER_PAY":
                    return PaymentStatus.PENDING;
                default:
                    return PaymentStatus.FAILED;
            }
        } catch (Exception e) {
            return PaymentStatus.FAILED;
        }
    }
}

// 微信支付适配器
class WechatPayAdapter implements PaymentProcessor {
    private WechatPaySDK wechatPaySDK;
    
    public WechatPayAdapter() {
        this.wechatPaySDK = new WechatPaySDK();
    }
    
    @Override
    public PaymentResult processPayment(PaymentRequest request) {
        try {
            // 转换请求格式（微信支付金额以分为单位）
            WechatPayRequest wechatRequest = new WechatPayRequest(
                request.getOrderId(),
                (int) (request.getAmount() * 100), // 转换为分
                request.getDescription()
            );
            
            // 调用微信支付接口
            WechatPayResponse response = wechatPaySDK.unifiedOrder(wechatRequest);
            
            // 转换响应格式
            if (response.isSuccess()) {
                return new PaymentResult(true, response.getPrepayId(), "支付成功");
            } else {
                return new PaymentResult(false, null, response.getReturnMsg());
            }
        } catch (Exception e) {
            return new PaymentResult(false, null, "支付失败: " + e.getMessage());
        }
    }
    
    @Override
    public PaymentResult refund(String transactionId, double amount) {
        try {
            // 微信退款金额以分为单位
            WechatRefundResponse response = wechatPaySDK.refund(transactionId, (int) (amount * 100));
            
            if (response.isSuccess()) {
                return new PaymentResult(true, response.getRefundId(), "退款成功");
            } else {
                return new PaymentResult(false, null, response.getReturnMsg());
            }
        } catch (Exception e) {
            return new PaymentResult(false, null, "退款失败: " + e.getMessage());
        }
    }
    
    @Override
    public PaymentStatus queryPaymentStatus(String transactionId) {
        try {
            WechatQueryResponse response = wechatPaySDK.orderQuery(transactionId);
            
            switch (response.getTradeState()) {
                case "SUCCESS":
                    return PaymentStatus.SUCCESS;
                case "CLOSED":
                    return PaymentStatus.CANCELLED;
                case "USERPAYING":
                    return PaymentStatus.PENDING;
                case "REFUND":
                    return PaymentStatus.REFUNDED;
                default:
                    return PaymentStatus.FAILED;
            }
        } catch (Exception e) {
            return PaymentStatus.FAILED;
        }
    }
}

// 支付处理器工厂
class PaymentProcessorFactory {
    public static PaymentProcessor createProcessor(String paymentType) {
        switch (paymentType.toLowerCase()) {
            case "alipay":
                return new AlipayAdapter();
            case "wechat":
                return new WechatPayAdapter();
            default:
                throw new IllegalArgumentException("不支持的支付类型: " + paymentType);
        }
    }
}

// 统一支付服务
class PaymentService {
    private Map<String, PaymentProcessor> processors;
    
    public PaymentService() {
        processors = new HashMap<>();
        processors.put("alipay", new AlipayAdapter());
        processors.put("wechat", new WechatPayAdapter());
    }
    
    public PaymentResult processPayment(String paymentType, PaymentRequest request) {
        PaymentProcessor processor = processors.get(paymentType.toLowerCase());
        if (processor == null) {
            return new PaymentResult(false, null, "不支持的支付方式: " + paymentType);
        }
        
        System.out.println("使用 " + paymentType + " 处理支付");
        return processor.processPayment(request);
    }
    
    public PaymentResult refund(String paymentType, String transactionId, double amount) {
        PaymentProcessor processor = processors.get(paymentType.toLowerCase());
        if (processor == null) {
            return new PaymentResult(false, null, "不支持的支付方式: " + paymentType);
        }
        
        System.out.println("使用 " + paymentType + " 处理退款");
        return processor.refund(transactionId, amount);
    }
    
    public PaymentStatus queryStatus(String paymentType, String transactionId) {
        PaymentProcessor processor = processors.get(paymentType.toLowerCase());
        if (processor == null) {
            return PaymentStatus.FAILED;
        }
        
        return processor.queryPaymentStatus(transactionId);
    }
}

// 使用示例
public class PaymentAdapterExample {
    public static void main(String[] args) {
        PaymentService paymentService = new PaymentService();
        
        // 创建支付请求
        PaymentRequest request = new PaymentRequest("ORDER_001", 99.99, "CNY", "购买商品");
        request.setCustomerInfo("userId", "12345");
        request.setCustomerInfo("email", "user@example.com");
        
        System.out.println("=== 支付宝支付测试 ===");
        PaymentResult alipayResult = paymentService.processPayment("alipay", request);
        System.out.println("支付结果: " + alipayResult);
        
        if (alipayResult.isSuccess()) {
            PaymentStatus status = paymentService.queryStatus("alipay", alipayResult.getTransactionId());
            System.out.println("支付状态: " + status);
            
            // 测试退款
            PaymentResult refundResult = paymentService.refund("alipay", alipayResult.getTransactionId(), 50.0);
            System.out.println("退款结果: " + refundResult);
        }
        
        System.out.println("\n=== 微信支付测试 ===");
        PaymentRequest wechatRequest = new PaymentRequest("ORDER_002", 199.99, "CNY", "购买VIP会员");
        PaymentResult wechatResult = paymentService.processPayment("wechat", wechatRequest);
        System.out.println("支付结果: " + wechatResult);
        
        if (wechatResult.isSuccess()) {
            PaymentStatus status = paymentService.queryStatus("wechat", wechatResult.getTransactionId());
            System.out.println("支付状态: " + status);
        }
        
        System.out.println("\n=== 不支持的支付方式测试 ===");
        PaymentResult unsupportedResult = paymentService.processPayment("paypal", request);
        System.out.println("支付结果: " + unsupportedResult);
    }
}
```

**适配器模式的关键特点：**
1. **接口转换**: 将不兼容的接口转换为客户端期望的接口
2. **代码复用**: 可以复用现有的类而不需要修改其源代码
3. **解耦**: 客户端与第三方库解耦，便于切换不同的实现
4. **统一接口**: 为不同的第三方服务提供统一的调用接口
5. **易于扩展**: 新增第三方服务只需要添加新的适配器

#### 实现概念
- **类适配器**：通过继承实现适配
- **对象适配器**：通过组合实现适配
- **双向适配器**：支持双向转换的适配器
- **缺省适配器**：提供接口默认实现的适配器

### 2. 桥接模式 (Bridge)

#### 核心概念
- **桥接**：将抽象与实现分离，使它们可以独立变化
- **抽象**：定义抽象接口
- **实现**：定义实现接口
- **分离变化**：将两个独立变化的维度分离

#### 基础例子：图形绘制系统
```java
// 实现接口 - 绘制API
interface DrawingAPI {
    void drawCircle(double x, double y, double radius);
    void drawRectangle(double x, double y, double width, double height);
    void setColor(String color);
}

// 具体实现 - Windows绘制API
class WindowsDrawingAPI implements DrawingAPI {
    @Override
    public void drawCircle(double x, double y, double radius) {
        System.out.printf("Windows API: 在坐标(%.1f, %.1f)绘制半径为%.1f的圆形%n", x, y, radius);
    }
    
    @Override
    public void drawRectangle(double x, double y, double width, double height) {
        System.out.printf("Windows API: 在坐标(%.1f, %.1f)绘制%.1fx%.1f的矩形%n", x, y, width, height);
    }
    
    @Override
    public void setColor(String color) {
        System.out.println("Windows API: 设置颜色为 " + color);
    }
}

// 具体实现 - Linux绘制API
class LinuxDrawingAPI implements DrawingAPI {
    @Override
    public void drawCircle(double x, double y, double radius) {
        System.out.printf("Linux API: 在坐标(%.1f, %.1f)绘制半径为%.1f的圆形%n", x, y, radius);
    }
    
    @Override
    public void drawRectangle(double x, double y, double width, double height) {
        System.out.printf("Linux API: 在坐标(%.1f, %.1f)绘制%.1fx%.1f的矩形%n", x, y, width, height);
    }
    
    @Override
    public void setColor(String color) {
        System.out.println("Linux API: 设置颜色为 " + color);
    }
}

// 抽象类 - 形状
abstract class Shape {
    protected DrawingAPI drawingAPI;
    protected String color = "黑色";
    
    protected Shape(DrawingAPI drawingAPI) {
        this.drawingAPI = drawingAPI;
    }
    
    public abstract void draw();
    public abstract void resize(double factor);
    
    public void setColor(String color) {
        this.color = color;
        drawingAPI.setColor(color);
    }
}

// 扩展抽象类 - 圆形
class Circle extends Shape {
    private double x, y, radius;
    
    public Circle(double x, double y, double radius, DrawingAPI drawingAPI) {
        super(drawingAPI);
        this.x = x;
        this.y = y;
        this.radius = radius;
    }
    
    @Override
    public void draw() {
        drawingAPI.setColor(color);
        drawingAPI.drawCircle(x, y, radius);
    }
    
    @Override
    public void resize(double factor) {
        radius *= factor;
        System.out.printf("圆形大小调整为原来的%.1f倍，新半径: %.1f%n", factor, radius);
    }
    
    public void move(double newX, double newY) {
        this.x = newX;
        this.y = newY;
        System.out.printf("圆形移动到新位置: (%.1f, %.1f)%n", x, y);
    }
}

// 扩展抽象类 - 矩形
class Rectangle extends Shape {
    private double x, y, width, height;
    
    public Rectangle(double x, double y, double width, double height, DrawingAPI drawingAPI) {
        super(drawingAPI);
        this.x = x;
        this.y = y;
        this.width = width;
        this.height = height;
    }
    
    @Override
    public void draw() {
        drawingAPI.setColor(color);
        drawingAPI.drawRectangle(x, y, width, height);
    }
    
    @Override
    public void resize(double factor) {
        width *= factor;
        height *= factor;
        System.out.printf("矩形大小调整为原来的%.1f倍，新尺寸: %.1fx%.1f%n", factor, width, height);
    }
    
    public void move(double newX, double newY) {
        this.x = newX;
        this.y = newY;
        System.out.printf("矩形移动到新位置: (%.1f, %.1f)%n", x, y);
    }
}

// 使用示例
public class BridgeExample {
    public static void main(String[] args) {
        // 使用Windows API绘制图形
        System.out.println("=== 使用Windows API ===");
        DrawingAPI windowsAPI = new WindowsDrawingAPI();
        
        Shape circle1 = new Circle(10, 10, 5, windowsAPI);
        circle1.setColor("红色");
        circle1.draw();
        circle1.resize(1.5);
        circle1.draw();
        
        Shape rectangle1 = new Rectangle(20, 20, 10, 8, windowsAPI);
        rectangle1.setColor("蓝色");
        rectangle1.draw();
        
        // 使用Linux API绘制图形
        System.out.println("\n=== 使用Linux API ===");
        DrawingAPI linuxAPI = new LinuxDrawingAPI();
        
        Shape circle2 = new Circle(15, 15, 7, linuxAPI);
        circle2.setColor("绿色");
        circle2.draw();
        
        Shape rectangle2 = new Rectangle(30, 30, 12, 6, linuxAPI);
        rectangle2.setColor("黄色");
        rectangle2.draw();
        rectangle2.resize(0.8);
        rectangle2.draw();
    }
}
```

#### 进阶例子：消息发送系统
```java
// 实现接口 - 消息发送器
interface MessageSender {
    void sendMessage(String message, String recipient);
    boolean isAvailable();
    void configure(Map<String, String> config);
    String getProviderName();
}

// 具体实现 - 邮件发送器
class EmailSender implements MessageSender {
    private String smtpServer;
    private int port;
    private String username;
    private String password;
    private boolean isConfigured = false;
    
    @Override
    public void sendMessage(String message, String recipient) {
        if (!isConfigured) {
            throw new IllegalStateException("邮件发送器未配置");
        }
        System.out.printf("通过邮件发送消息到 %s:%n", recipient);
        System.out.printf("SMTP服务器: %s:%d%n", smtpServer, port);
        System.out.printf("消息内容: %s%n", message);
        System.out.println("邮件发送成功");
    }
    
    @Override
    public boolean isAvailable() {
        return isConfigured && smtpServer != null && !smtpServer.isEmpty();
    }
    
    @Override
    public void configure(Map<String, String> config) {
        this.smtpServer = config.get("smtp.server");
        this.port = Integer.parseInt(config.getOrDefault("smtp.port", "587"));
        this.username = config.get("smtp.username");
        this.password = config.get("smtp.password");
        this.isConfigured = true;
        System.out.println("邮件发送器配置完成");
    }
    
    @Override
    public String getProviderName() {
        return "Email";
    }
}

// 具体实现 - 短信发送器
class SMSSender implements MessageSender {
    private String apiKey;
    private String apiSecret;
    private String serviceUrl;
    private boolean isConfigured = false;
    
    @Override
    public void sendMessage(String message, String recipient) {
        if (!isConfigured) {
            throw new IllegalStateException("短信发送器未配置");
        }
        System.out.printf("通过短信发送消息到 %s:%n", recipient);
        System.out.printf("服务URL: %s%n", serviceUrl);
        System.out.printf("消息内容: %s%n", message);
        System.out.println("短信发送成功");
    }
    
    @Override
    public boolean isAvailable() {
        return isConfigured && apiKey != null && !apiKey.isEmpty();
    }
    
    @Override
    public void configure(Map<String, String> config) {
        this.apiKey = config.get("sms.api.key");
        this.apiSecret = config.get("sms.api.secret");
        this.serviceUrl = config.get("sms.service.url");
        this.isConfigured = true;
        System.out.println("短信发送器配置完成");
    }
    
    @Override
    public String getProviderName() {
        return "SMS";
    }
}

// 具体实现 - 微信发送器
class WeChatSender implements MessageSender {
    private String appId;
    private String appSecret;
    private String accessToken;
    private boolean isConfigured = false;
    
    @Override
    public void sendMessage(String message, String recipient) {
        if (!isConfigured) {
            throw new IllegalStateException("微信发送器未配置");
        }
        System.out.printf("通过微信发送消息到 %s:%n", recipient);
        System.out.printf("AppId: %s%n", appId);
        System.out.printf("消息内容: %s%n", message);
        System.out.println("微信消息发送成功");
    }
    
    @Override
    public boolean isAvailable() {
        return isConfigured && appId != null && !appId.isEmpty();
    }
    
    @Override
    public void configure(Map<String, String> config) {
        this.appId = config.get("wechat.app.id");
        this.appSecret = config.get("wechat.app.secret");
        this.accessToken = config.get("wechat.access.token");
        this.isConfigured = true;
        System.out.println("微信发送器配置完成");
    }
    
    @Override
    public String getProviderName() {
        return "WeChat";
    }
}

// 抽象类 - 消息
abstract class Message {
    protected MessageSender messageSender;
    protected String content;
    protected String sender;
    protected Date timestamp;
    protected MessagePriority priority;
    
    public Message(MessageSender messageSender) {
        this.messageSender = messageSender;
        this.timestamp = new Date();
        this.priority = MessagePriority.NORMAL;
    }
    
    public abstract void send(String recipient);
    public abstract String formatMessage();
    
    // 通用方法
    public void setContent(String content) {
        this.content = content;
    }
    
    public void setSender(String sender) {
        this.sender = sender;
    }
    
    public void setPriority(MessagePriority priority) {
        this.priority = priority;
    }
    
    public String getProviderName() {
        return messageSender.getProviderName();
    }
    
    public boolean isProviderAvailable() {
        return messageSender.isAvailable();
    }
    
    protected String getPriorityPrefix() {
        switch (priority) {
            case HIGH: return "[紧急] ";
            case LOW: return "[普通] ";
            default: return "";
        }
    }
}

// 消息优先级枚举
enum MessagePriority {
    HIGH, NORMAL, LOW
}

// 扩展抽象类 - 通知消息
class NotificationMessage extends Message {
    private String title;
    private String category;
    
    public NotificationMessage(MessageSender messageSender) {
        super(messageSender);
        this.category = "系统通知";
    }
    
    @Override
    public void send(String recipient) {
        if (!messageSender.isAvailable()) {
            throw new IllegalStateException("消息发送器不可用: " + messageSender.getProviderName());
        }
        
        String formattedMessage = formatMessage();
        System.out.printf("发送通知消息 [%s]:%n", category);
        messageSender.sendMessage(formattedMessage, recipient);
    }
    
    @Override
    public String formatMessage() {
        StringBuilder sb = new StringBuilder();
        sb.append(getPriorityPrefix());
        if (title != null) {
            sb.append("标题: ").append(title).append("\n");
        }
        sb.append("内容: ").append(content).append("\n");
        sb.append("发送时间: ").append(timestamp).append("\n");
        if (sender != null) {
            sb.append("发送者: ").append(sender);
        }
        return sb.toString();
    }
    
    public void setTitle(String title) {
        this.title = title;
    }
    
    public void setCategory(String category) {
        this.category = category;
    }
}

// 扩展抽象类 - 营销消息
class MarketingMessage extends Message {
    private String campaignId;
    private String productName;
    private double discountRate;
    private Date expiryDate;
    
    public MarketingMessage(MessageSender messageSender) {
        super(messageSender);
    }
    
    @Override
    public void send(String recipient) {
        if (!messageSender.isAvailable()) {
            throw new IllegalStateException("消息发送器不可用: " + messageSender.getProviderName());
        }
        
        String formattedMessage = formatMessage();
        System.out.printf("发送营销消息 [活动ID: %s]:%n", campaignId);
        messageSender.sendMessage(formattedMessage, recipient);
    }
    
    @Override
    public String formatMessage() {
        StringBuilder sb = new StringBuilder();
        sb.append(getPriorityPrefix());
        sb.append("🎉 特惠活动通知 🎉\n");
        if (productName != null) {
            sb.append("产品: ").append(productName).append("\n");
        }
        if (discountRate > 0) {
            sb.append("折扣: ").append(String.format("%.0f%%", discountRate * 100)).append(" OFF\n");
        }
        sb.append("详情: ").append(content).append("\n");
        if (expiryDate != null) {
            sb.append("有效期至: ").append(expiryDate).append("\n");
        }
        sb.append("活动ID: ").append(campaignId);
        return sb.toString();
    }
    
    public void setCampaignId(String campaignId) {
        this.campaignId = campaignId;
    }
    
    public void setProductName(String productName) {
        this.productName = productName;
    }
    
    public void setDiscountRate(double discountRate) {
        this.discountRate = discountRate;
    }
    
    public void setExpiryDate(Date expiryDate) {
        this.expiryDate = expiryDate;
    }
}

// 扩展抽象类 - 警报消息
class AlertMessage extends Message {
    private AlertLevel alertLevel;
    private String systemName;
    private String errorCode;
    
    public AlertMessage(MessageSender messageSender) {
        super(messageSender);
        this.alertLevel = AlertLevel.WARNING;
        this.priority = MessagePriority.HIGH; // 警报消息默认高优先级
    }
    
    @Override
    public void send(String recipient) {
        if (!messageSender.isAvailable()) {
            throw new IllegalStateException("消息发送器不可用: " + messageSender.getProviderName());
        }
        
        String formattedMessage = formatMessage();
        System.out.printf("发送警报消息 [%s级别]:%n", alertLevel);
        messageSender.sendMessage(formattedMessage, recipient);
    }
    
    @Override
    public String formatMessage() {
        StringBuilder sb = new StringBuilder();
        sb.append(getAlertPrefix()).append(getPriorityPrefix());
        sb.append("系统警报\n");
        sb.append("级别: ").append(alertLevel).append("\n");
        if (systemName != null) {
            sb.append("系统: ").append(systemName).append("\n");
        }
        if (errorCode != null) {
            sb.append("错误代码: ").append(errorCode).append("\n");
        }
        sb.append("详情: ").append(content).append("\n");
        sb.append("时间: ").append(timestamp);
        return sb.toString();
    }
    
    private String getAlertPrefix() {
        switch (alertLevel) {
            case CRITICAL: return "🚨 [严重] ";
            case ERROR: return "❌ [错误] ";
            case WARNING: return "⚠️ [警告] ";
            default: return "ℹ️ [信息] ";
        }
    }
    
    public void setAlertLevel(AlertLevel alertLevel) {
        this.alertLevel = alertLevel;
    }
    
    public void setSystemName(String systemName) {
        this.systemName = systemName;
    }
    
    public void setErrorCode(String errorCode) {
        this.errorCode = errorCode;
    }
}

// 警报级别枚举
enum AlertLevel {
    INFO, WARNING, ERROR, CRITICAL
}

// 消息发送器工厂
class MessageSenderFactory {
    public static MessageSender createEmailSender() {
        EmailSender sender = new EmailSender();
        Map<String, String> config = new HashMap<>();
        config.put("smtp.server", "smtp.gmail.com");
        config.put("smtp.port", "587");
        config.put("smtp.username", "user@gmail.com");
        config.put("smtp.password", "password");
        sender.configure(config);
        return sender;
    }
    
    public static MessageSender createSMSSender() {
        SMSSender sender = new SMSSender();
        Map<String, String> config = new HashMap<>();
        config.put("sms.api.key", "your-api-key");
        config.put("sms.api.secret", "your-api-secret");
        config.put("sms.service.url", "https://api.sms-service.com");
        sender.configure(config);
        return sender;
    }
    
    public static MessageSender createWeChatSender() {
        WeChatSender sender = new WeChatSender();
        Map<String, String> config = new HashMap<>();
        config.put("wechat.app.id", "your-app-id");
        config.put("wechat.app.secret", "your-app-secret");
        config.put("wechat.access.token", "your-access-token");
        sender.configure(config);
        return sender;
    }
}

// 使用示例
public class MessageBridgeExample {
    public static void main(String[] args) {
        System.out.println("=== 桥接模式消息发送系统 ===");
        
        // 创建不同的消息发送器
        MessageSender emailSender = MessageSenderFactory.createEmailSender();
        MessageSender smsSender = MessageSenderFactory.createSMSSender();
        MessageSender wechatSender = MessageSenderFactory.createWeChatSender();
        
        // 发送通知消息
        System.out.println("\n--- 发送通知消息 ---");
        NotificationMessage notification = new NotificationMessage(emailSender);
        notification.setTitle("系统维护通知");
        notification.setContent("系统将于今晚22:00-24:00进行维护，期间服务可能中断。");
        notification.setSender("系统管理员");
        notification.setPriority(MessagePriority.HIGH);
        notification.send("user@example.com");
        
        // 使用不同发送器发送相同通知
        NotificationMessage smsNotification = new NotificationMessage(smsSender);
        smsNotification.setTitle("系统维护通知");
        smsNotification.setContent("系统维护中，请稍后访问。");
        smsNotification.setPriority(MessagePriority.HIGH);
        smsNotification.send("13800138000");
        
        // 发送营销消息
        System.out.println("\n--- 发送营销消息 ---");
        MarketingMessage marketing = new MarketingMessage(wechatSender);
        marketing.setCampaignId("SUMMER2024");
        marketing.setProductName("夏季新品");
        marketing.setDiscountRate(0.3);
        marketing.setExpiryDate(new Date(System.currentTimeMillis() + 7 * 24 * 60 * 60 * 1000L));
        marketing.setContent("夏季新品大促销，全场7折优惠，限时7天！");
        marketing.setPriority(MessagePriority.NORMAL);
        marketing.send("wechat_user_123");
        
        // 发送警报消息
        System.out.println("\n--- 发送警报消息 ---");
        AlertMessage alert = new AlertMessage(emailSender);
        alert.setAlertLevel(AlertLevel.CRITICAL);
        alert.setSystemName("订单处理系统");
        alert.setErrorCode("SYS_001");
        alert.setContent("数据库连接失败，订单处理服务已停止");
        alert.setSender("监控系统");
        alert.send("admin@example.com");
        
        // 演示桥接模式的灵活性 - 运行时切换实现
        System.out.println("\n--- 运行时切换发送器 ---");
        List<MessageSender> senders = Arrays.asList(emailSender, smsSender, wechatSender);
        
        NotificationMessage flexibleNotification = new NotificationMessage(emailSender);
        flexibleNotification.setTitle("多渠道通知测试");
        flexibleNotification.setContent("这是一条测试消息，将通过不同渠道发送");
        
        for (MessageSender sender : senders) {
            // 运行时切换实现
            flexibleNotification = new NotificationMessage(sender);
            flexibleNotification.setTitle("多渠道通知测试");
            flexibleNotification.setContent("通过 " + sender.getProviderName() + " 发送的测试消息");
            
            String recipient = getRecipientForSender(sender);
            flexibleNotification.send(recipient);
        }
    }
    
    private static String getRecipientForSender(MessageSender sender) {
        switch (sender.getProviderName()) {
            case "Email": return "test@example.com";
            case "SMS": return "13800138000";
            case "WeChat": return "wechat_test_user";
            default: return "unknown";
        }
    }
}
```

**桥接模式的关键特点：**
1. **分离抽象和实现**: 抽象和实现可以独立变化
2. **运行时绑定**: 可以在运行时选择具体的实现
3. **避免永久绑定**: 抽象和实现之间没有永久的绑定关系
4. **扩展性好**: 可以独立扩展抽象层次和实现层次
5. **隐藏实现细节**: 客户端代码不需要了解具体的实现细节

#### 参与者概念
- **抽象类**：定义抽象接口，维护实现对象的引用
- **扩展抽象类**：扩展抽象接口
- **实现接口**：定义实现类的接口
- **具体实现类**：实现具体的实现接口

### 3. 组合模式 (Composite)

#### 核心概念
- **组合**：将对象组合成树形结构表示部分-整体层次
- **组件**：组合中对象的统一接口
- **叶子**：组合中的叶子节点
- **容器**：组合中的容器节点
- **递归结构**：树形结构的递归特性

#### 基础例子：文件系统结构
```java
// 组件接口 - 文件系统组件
abstract class FileSystemComponent {
    protected String name;
    
    public FileSystemComponent(String name) {
        this.name = name;
    }
    
    public String getName() {
        return name;
    }
    
    // 公共操作
    public abstract void display(int depth);
    public abstract long getSize();
    
    // 容器操作 - 默认抛出异常，只有容器类重写
    public void add(FileSystemComponent component) {
        throw new UnsupportedOperationException("不支持添加操作");
    }
    
    public void remove(FileSystemComponent component) {
        throw new UnsupportedOperationException("不支持删除操作");
    }
    
    public FileSystemComponent getChild(int index) {
        throw new UnsupportedOperationException("不支持获取子组件操作");
    }
    
    protected String getIndent(int depth) {
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < depth; i++) {
            sb.append("  ");
        }
        return sb.toString();
    }
}

// 叶子组件 - 文件
class File extends FileSystemComponent {
    private long size;
    private String extension;
    
    public File(String name, long size) {
        super(name);
        this.size = size;
        this.extension = getFileExtension(name);
    }
    
    @Override
    public void display(int depth) {
        System.out.printf("%s📄 %s (%d bytes)%n", getIndent(depth), name, size);
    }
    
    @Override
    public long getSize() {
        return size;
    }
    
    public String getExtension() {
        return extension;
    }
    
    private String getFileExtension(String fileName) {
        int lastDot = fileName.lastIndexOf('.');
        return lastDot > 0 ? fileName.substring(lastDot + 1) : "";
    }
}

// 容器组件 - 目录
class Directory extends FileSystemComponent {
    private List<FileSystemComponent> children;
    
    public Directory(String name) {
        super(name);
        this.children = new ArrayList<>();
    }
    
    @Override
    public void add(FileSystemComponent component) {
        children.add(component);
    }
    
    @Override
    public void remove(FileSystemComponent component) {
        children.remove(component);
    }
    
    @Override
    public FileSystemComponent getChild(int index) {
        if (index >= 0 && index < children.size()) {
            return children.get(index);
        }
        throw new IndexOutOfBoundsException("索引超出范围: " + index);
    }
    
    @Override
    public void display(int depth) {
        System.out.printf("%s📁 %s/ (%d items, %d bytes total)%n", 
                         getIndent(depth), name, children.size(), getSize());
        
        // 递归显示子组件
        for (FileSystemComponent child : children) {
            child.display(depth + 1);
        }
    }
    
    @Override
    public long getSize() {
        long totalSize = 0;
        for (FileSystemComponent child : children) {
            totalSize += child.getSize();
        }
        return totalSize;
    }
    
    public int getChildCount() {
        return children.size();
    }
    
    public List<FileSystemComponent> getChildren() {
        return new ArrayList<>(children);
    }
    
    // 查找文件
    public List<File> findFiles(String extension) {
        List<File> result = new ArrayList<>();
        findFilesRecursive(extension, result);
        return result;
    }
    
    private void findFilesRecursive(String extension, List<File> result) {
        for (FileSystemComponent child : children) {
            if (child instanceof File) {
                File file = (File) child;
                if (extension == null || extension.equals(file.getExtension())) {
                    result.add(file);
                }
            } else if (child instanceof Directory) {
                ((Directory) child).findFilesRecursive(extension, result);
            }
        }
    }
}

// 使用示例
public class CompositeExample {
    public static void main(String[] args) {
        // 创建根目录
        Directory root = new Directory("root");
        
        // 创建子目录
        Directory documents = new Directory("Documents");
        Directory pictures = new Directory("Pictures");
        Directory music = new Directory("Music");
        
        // 创建文件
        File readme = new File("README.txt", 1024);
        File config = new File("config.json", 512);
        
        File photo1 = new File("vacation.jpg", 2048000);
        File photo2 = new File("family.png", 1536000);
        
        File song1 = new File("favorite.mp3", 4096000);
        File song2 = new File("classical.wav", 8192000);
        
        // 构建文件系统树
        root.add(readme);
        root.add(config);
        root.add(documents);
        root.add(pictures);
        root.add(music);
        
        documents.add(new File("report.docx", 256000));
        documents.add(new File("presentation.pptx", 512000));
        
        pictures.add(photo1);
        pictures.add(photo2);
        
        music.add(song1);
        music.add(song2);
        
        // 显示文件系统结构
        System.out.println("=== 文件系统结构 ===");
        root.display(0);
        
        // 查找特定类型的文件
        System.out.println("\n=== 查找图片文件 ===");
        List<File> imageFiles = root.findFiles("jpg");
        imageFiles.addAll(root.findFiles("png"));
        
        for (File file : imageFiles) {
            System.out.println("找到图片: " + file.getName() + " (" + file.getSize() + " bytes)");
        }
        
        // 统计信息
        System.out.println("\n=== 统计信息 ===");
        System.out.println("总大小: " + root.getSize() + " bytes");
        System.out.println("Documents目录大小: " + documents.getSize() + " bytes");
        System.out.println("Pictures目录大小: " + pictures.getSize() + " bytes");
        System.out.println("Music目录大小: " + music.getSize() + " bytes");
    }
}
```

#### 进阶例子：企业组织架构系统
```java
import java.util.*;
import java.util.stream.Collectors;

// 组件接口 - 组织单元
abstract class OrganizationUnit {
    protected String name;
    protected String code;
    protected String description;
    protected Date createdDate;
    protected boolean active;
    
    public OrganizationUnit(String name, String code, String description) {
        this.name = name;
        this.code = code;
        this.description = description;
        this.createdDate = new Date();
        this.active = true;
    }
    
    // 公共方法
    public abstract void display(int depth);
    public abstract int getEmployeeCount();
    public abstract double getTotalSalary();
    public abstract List<Employee> getAllEmployees();
    public abstract void accept(OrganizationVisitor visitor);
    
    // 容器方法 - 默认实现
    public void add(OrganizationUnit unit) {
        throw new UnsupportedOperationException("不支持添加子单元");
    }
    
    public void remove(OrganizationUnit unit) {
        throw new UnsupportedOperationException("不支持删除子单元");
    }
    
    public List<OrganizationUnit> getChildren() {
        return Collections.emptyList();
    }
    
    public OrganizationUnit findByCode(String code) {
        return this.code.equals(code) ? this : null;
    }
    
    // Getter方法
    public String getName() { return name; }
    public String getCode() { return code; }
    public String getDescription() { return description; }
    public Date getCreatedDate() { return createdDate; }
    public boolean isActive() { return active; }
    public void setActive(boolean active) { this.active = active; }
    
    protected String getIndent(int depth) {
        return "  ".repeat(depth);
    }
}

// 叶子组件 - 员工
class Employee extends OrganizationUnit {
    private String position;
    private double salary;
    private String email;
    private String phone;
    private EmployeeLevel level;
    private Date hireDate;
    private Employee manager;
    
    public Employee(String name, String code, String position, double salary) {
        super(name, code, "员工: " + name);
        this.position = position;
        this.salary = salary;
        this.level = EmployeeLevel.JUNIOR;
        this.hireDate = new Date();
    }
    
    @Override
    public void display(int depth) {
        String status = active ? "在职" : "离职";
        System.out.printf("%s👤 %s (%s) - %s - ¥%.2f - %s%n", 
                         getIndent(depth), name, code, position, salary, status);
    }
    
    @Override
    public int getEmployeeCount() {
        return active ? 1 : 0;
    }
    
    @Override
    public double getTotalSalary() {
        return active ? salary : 0;
    }
    
    @Override
    public List<Employee> getAllEmployees() {
        return active ? Arrays.asList(this) : Collections.emptyList();
    }
    
    @Override
    public void accept(OrganizationVisitor visitor) {
        visitor.visitEmployee(this);
    }
    
    // Getter和Setter方法
    public String getPosition() { return position; }
    public void setPosition(String position) { this.position = position; }
    public double getSalary() { return salary; }
    public void setSalary(double salary) { this.salary = salary; }
    public String getEmail() { return email; }
    public void setEmail(String email) { this.email = email; }
    public String getPhone() { return phone; }
    public void setPhone(String phone) { this.phone = phone; }
    public EmployeeLevel getLevel() { return level; }
    public void setLevel(EmployeeLevel level) { this.level = level; }
    public Date getHireDate() { return hireDate; }
    public Employee getManager() { return manager; }
    public void setManager(Employee manager) { this.manager = manager; }
}

// 员工级别枚举
enum EmployeeLevel {
    INTERN("实习生"), JUNIOR("初级"), SENIOR("高级"), LEAD("主管"), MANAGER("经理"), DIRECTOR("总监");
    
    private String displayName;
    
    EmployeeLevel(String displayName) {
        this.displayName = displayName;
    }
    
    public String getDisplayName() {
        return displayName;
    }
}

// 容器组件 - 部门
class Department extends OrganizationUnit {
    private List<OrganizationUnit> children;
    private Employee manager;
    private String location;
    private double budget;
    private DepartmentType type;
    
    public Department(String name, String code, String description, DepartmentType type) {
        super(name, code, description);
        this.children = new ArrayList<>();
        this.type = type;
        this.budget = 0.0;
    }
    
    @Override
    public void add(OrganizationUnit unit) {
        children.add(unit);
    }
    
    @Override
    public void remove(OrganizationUnit unit) {
        children.remove(unit);
    }
    
    @Override
    public List<OrganizationUnit> getChildren() {
        return new ArrayList<>(children);
    }
    
    @Override
    public OrganizationUnit findByCode(String code) {
        if (this.code.equals(code)) {
            return this;
        }
        
        for (OrganizationUnit child : children) {
            OrganizationUnit found = child.findByCode(code);
            if (found != null) {
                return found;
            }
        }
        return null;
    }
    
    @Override
    public void display(int depth) {
        String managerInfo = manager != null ? " (负责人: " + manager.getName() + ")" : "";
        System.out.printf("%s🏢 %s (%s) - %s - %d个子单元 - 预算: ¥%.2f%s%n", 
                         getIndent(depth), name, code, type.getDisplayName(), 
                         children.size(), budget, managerInfo);
        
        // 递归显示子单元
        for (OrganizationUnit child : children) {
            child.display(depth + 1);
        }
    }
    
    @Override
    public int getEmployeeCount() {
        if (!active) return 0;
        
        int count = 0;
        for (OrganizationUnit child : children) {
            count += child.getEmployeeCount();
        }
        return count;
    }
    
    @Override
    public double getTotalSalary() {
        if (!active) return 0;
        
        double total = 0;
        for (OrganizationUnit child : children) {
            total += child.getTotalSalary();
        }
        return total;
    }
    
    @Override
    public List<Employee> getAllEmployees() {
        if (!active) return Collections.emptyList();
        
        List<Employee> allEmployees = new ArrayList<>();
        for (OrganizationUnit child : children) {
            allEmployees.addAll(child.getAllEmployees());
        }
        return allEmployees;
    }
    
    @Override
    public void accept(OrganizationVisitor visitor) {
        visitor.visitDepartment(this);
        for (OrganizationUnit child : children) {
            child.accept(visitor);
        }
    }
    
    // 部门特有方法
    public List<Employee> getEmployeesByLevel(EmployeeLevel level) {
        return getAllEmployees().stream()
                .filter(emp -> emp.getLevel() == level)
                .collect(Collectors.toList());
    }
    
    public List<Employee> getEmployeesByPosition(String position) {
        return getAllEmployees().stream()
                .filter(emp -> emp.getPosition().contains(position))
                .collect(Collectors.toList());
    }
    
    public double getAverageSalary() {
        List<Employee> employees = getAllEmployees();
        if (employees.isEmpty()) return 0;
        
        return employees.stream()
                .mapToDouble(Employee::getSalary)
                .average()
                .orElse(0);
    }
    
    // Getter和Setter方法
    public Employee getManager() { return manager; }
    public void setManager(Employee manager) { this.manager = manager; }
    public String getLocation() { return location; }
    public void setLocation(String location) { this.location = location; }
    public double getBudget() { return budget; }
    public void setBudget(double budget) { this.budget = budget; }
    public DepartmentType getType() { return type; }
}

// 部门类型枚举
enum DepartmentType {
    HEADQUARTERS("总部"), BRANCH("分公司"), DIVISION("事业部"), 
    DEPARTMENT("部门"), TEAM("团队"), PROJECT_GROUP("项目组");
    
    private String displayName;
    
    DepartmentType(String displayName) {
        this.displayName = displayName;
    }
    
    public String getDisplayName() {
        return displayName;
    }
}

// 访问者接口 - 用于遍历组织结构
interface OrganizationVisitor {
    void visitEmployee(Employee employee);
    void visitDepartment(Department department);
}

// 具体访问者 - 统计访问者
class StatisticsVisitor implements OrganizationVisitor {
    private int totalEmployees = 0;
    private int totalDepartments = 0;
    private double totalSalary = 0;
    private Map<EmployeeLevel, Integer> levelCount = new HashMap<>();
    private Map<DepartmentType, Integer> departmentTypeCount = new HashMap<>();
    
    @Override
    public void visitEmployee(Employee employee) {
        if (employee.isActive()) {
            totalEmployees++;
            totalSalary += employee.getSalary();
            levelCount.merge(employee.getLevel(), 1, Integer::sum);
        }
    }
    
    @Override
    public void visitDepartment(Department department) {
        if (department.isActive()) {
            totalDepartments++;
            departmentTypeCount.merge(department.getType(), 1, Integer::sum);
        }
    }
    
    public void printStatistics() {
        System.out.println("=== 组织统计信息 ===");
        System.out.println("总员工数: " + totalEmployees);
        System.out.println("总部门数: " + totalDepartments);
        System.out.printf("总薪资: ¥%.2f%n", totalSalary);
        System.out.printf("平均薪资: ¥%.2f%n", totalEmployees > 0 ? totalSalary / totalEmployees : 0);
        
        System.out.println("\n员工级别分布:");
        levelCount.forEach((level, count) -> 
            System.out.println("  " + level.getDisplayName() + ": " + count + "人"));
        
        System.out.println("\n部门类型分布:");
        departmentTypeCount.forEach((type, count) -> 
            System.out.println("  " + type.getDisplayName() + ": " + count + "个"));
    }
}

// 具体访问者 - 报告生成器
class ReportVisitor implements OrganizationVisitor {
    private StringBuilder report = new StringBuilder();
    private int depth = 0;
    
    @Override
    public void visitEmployee(Employee employee) {
        report.append("  ".repeat(depth))
              .append("员工: ").append(employee.getName())
              .append(" (").append(employee.getPosition()).append(")")
              .append(" - ¥").append(employee.getSalary())
              .append("\n");
    }
    
    @Override
    public void visitDepartment(Department department) {
        report.append("  ".repeat(depth))
              .append("部门: ").append(department.getName())
              .append(" (").append(department.getCode()).append(")")
              .append(" - ").append(department.getType().getDisplayName())
              .append("\n");
        depth++;
        
        // 访问完子节点后恢复深度
        // 注意：这里简化处理，实际应该在访问完所有子节点后恢复
    }
    
    public String getReport() {
        return report.toString();
    }
}

// 使用示例
public class OrganizationCompositeExample {
    public static void main(String[] args) {
        // 创建公司组织架构
        Department company = new Department("科技有限公司", "COMP001", "一家创新的科技公司", DepartmentType.HEADQUARTERS);
        company.setBudget(10000000);
        
        // 创建一级部门
        Department techDept = new Department("技术部", "TECH001", "负责产品研发", DepartmentType.DEPARTMENT);
        Department salesDept = new Department("销售部", "SALES001", "负责市场销售", DepartmentType.DEPARTMENT);
        Department hrDept = new Department("人力资源部", "HR001", "负责人力资源管理", DepartmentType.DEPARTMENT);
        
        // 创建技术部子部门
        Department devTeam = new Department("开发团队", "DEV001", "软件开发团队", DepartmentType.TEAM);
        Department qaTeam = new Department("测试团队", "QA001", "质量保证团队", DepartmentType.TEAM);
        
        // 创建员工
        Employee ceo = new Employee("张总", "CEO001", "首席执行官", 50000);
        ceo.setLevel(EmployeeLevel.DIRECTOR);
        
        Employee techManager = new Employee("李经理", "TM001", "技术经理", 25000);
        techManager.setLevel(EmployeeLevel.MANAGER);
        
        Employee dev1 = new Employee("王开发", "DEV001", "高级开发工程师", 15000);
        dev1.setLevel(EmployeeLevel.SENIOR);
        
        Employee dev2 = new Employee("赵开发", "DEV002", "初级开发工程师", 8000);
        dev2.setLevel(EmployeeLevel.JUNIOR);
        
        Employee qa1 = new Employee("钱测试", "QA001", "测试工程师", 12000);
        qa1.setLevel(EmployeeLevel.SENIOR);
        
        Employee sales1 = new Employee("孙销售", "SALES001", "销售经理", 18000);
        sales1.setLevel(EmployeeLevel.MANAGER);
        
        Employee hr1 = new Employee("周人事", "HR001", "人事专员", 10000);
        hr1.setLevel(EmployeeLevel.JUNIOR);
        
        // 构建组织架构树
        company.add(ceo);
        company.add(techDept);
        company.add(salesDept);
        company.add(hrDept);
        
        techDept.add(techManager);
        techDept.add(devTeam);
        techDept.add(qaTeam);
        techDept.setManager(techManager);
        
        devTeam.add(dev1);
        devTeam.add(dev2);
        
        qaTeam.add(qa1);
        
        salesDept.add(sales1);
        salesDept.setManager(sales1);
        
        hrDept.add(hr1);
        
        // 显示组织架构
        System.out.println("=== 公司组织架构 ===");
        company.display(0);
        
        // 统计信息
        System.out.println("\n=== 基本统计 ===");
        System.out.println("总员工数: " + company.getEmployeeCount());
        System.out.printf("总薪资支出: ¥%.2f%n", company.getTotalSalary());
        System.out.printf("技术部员工数: %d%n", techDept.getEmployeeCount());
        System.out.printf("技术部平均薪资: ¥%.2f%n", techDept.getAverageSalary());
        
        // 查找功能
        System.out.println("\n=== 查找功能 ===");
        OrganizationUnit found = company.findByCode("DEV001");
        if (found != null) {
            System.out.println("找到单元: " + found.getName() + " (" + found.getCode() + ")");
        }
        
        // 按级别查找员工
        List<Employee> managers = techDept.getEmployeesByLevel(EmployeeLevel.MANAGER);
        System.out.println("技术部经理级别员工:");
        managers.forEach(emp -> System.out.println("  " + emp.getName() + " - " + emp.getPosition()));
        
        // 按职位查找员工
        List<Employee> developers = company.getAllEmployees().stream()
                .filter(emp -> emp.getPosition().contains("开发"))
                .collect(Collectors.toList());
        System.out.println("所有开发人员:");
        developers.forEach(emp -> System.out.println("  " + emp.getName() + " - " + emp.getPosition()));
        
        // 使用访问者模式进行统计
        System.out.println("\n=== 访问者模式统计 ===");
        StatisticsVisitor statsVisitor = new StatisticsVisitor();
        company.accept(statsVisitor);
        statsVisitor.printStatistics();
        
        // 生成报告
        System.out.println("\n=== 组织架构报告 ===");
        ReportVisitor reportVisitor = new ReportVisitor();
        company.accept(reportVisitor);
        System.out.println(reportVisitor.getReport());
        
        // 演示动态修改
        System.out.println("\n=== 动态修改演示 ===");
        
        // 添加新员工
        Employee newDev = new Employee("新开发", "DEV003", "中级开发工程师", 12000);
        newDev.setLevel(EmployeeLevel.SENIOR);
        devTeam.add(newDev);
        
        // 员工离职
        dev2.setActive(false);
        
        System.out.println("修改后的开发团队:");
        devTeam.display(0);
        
        System.out.println("修改后技术部统计:");
        System.out.println("员工数: " + techDept.getEmployeeCount());
        System.out.printf("总薪资: ¥%.2f%n", techDept.getTotalSalary());
    }
}
```

**组合模式的关键特点：**
1. **统一接口**: 叶子和容器对象实现相同的接口
2. **递归结构**: 支持任意深度的树形结构
3. **透明性**: 客户端可以一致地处理叶子和容器对象
4. **灵活性**: 可以动态地添加、删除和修改树形结构
5. **简化客户端**: 客户端不需要区分叶子和容器对象

#### 实现概念
- **透明方式**：组件接口包含所有子组件管理方法
- **安全方式**：组件接口只包含公共方法
- **树形遍历**：遍历组合结构的方法

### 4. 装饰器模式 (Decorator)

#### 核心概念
- **装饰器**：动态地给对象添加额外的职责
- **组件**：定义对象的接口
- **装饰**：在不改变接口的前提下扩展功能
- **装饰链**：多个装饰器的组合

#### 基础例子：咖啡订购系统
```java
// 组件接口 - 饮品
interface Beverage {
    String getDescription();
    double getCost();
}

// 具体组件 - 基础咖啡
class Espresso implements Beverage {
    @Override
    public String getDescription() {
        return "浓缩咖啡";
    }
    
    @Override
    public double getCost() {
        return 15.0;
    }
}

class HouseBlend implements Beverage {
    @Override
    public String getDescription() {
        return "综合咖啡";
    }
    
    @Override
    public double getCost() {
        return 12.0;
    }
}

class DarkRoast implements Beverage {
    @Override
    public String getDescription() {
        return "深度烘焙咖啡";
    }
    
    @Override
    public double getCost() {
        return 18.0;
    }
}

// 抽象装饰器
abstract class CondimentDecorator implements Beverage {
    protected Beverage beverage;
    
    public CondimentDecorator(Beverage beverage) {
        this.beverage = beverage;
    }
    
    @Override
    public abstract String getDescription();
}

// 具体装饰器 - 牛奶
class Milk extends CondimentDecorator {
    public Milk(Beverage beverage) {
        super(beverage);
    }
    
    @Override
    public String getDescription() {
        return beverage.getDescription() + " + 牛奶";
    }
    
    @Override
    public double getCost() {
        return beverage.getCost() + 3.0;
    }
}

// 具体装饰器 - 豆浆
class Soy extends CondimentDecorator {
    public Soy(Beverage beverage) {
        super(beverage);
    }
    
    @Override
    public String getDescription() {
        return beverage.getDescription() + " + 豆浆";
    }
    
    @Override
    public double getCost() {
        return beverage.getCost() + 4.0;
    }
}

// 具体装饰器 - 摩卡
class Mocha extends CondimentDecorator {
    public Mocha(Beverage beverage) {
        super(beverage);
    }
    
    @Override
    public String getDescription() {
        return beverage.getDescription() + " + 摩卡";
    }
    
    @Override
    public double getCost() {
        return beverage.getCost() + 5.0;
    }
}

// 具体装饰器 - 奶泡
class Whip extends CondimentDecorator {
    public Whip(Beverage beverage) {
        super(beverage);
    }
    
    @Override
    public String getDescription() {
        return beverage.getDescription() + " + 奶泡";
    }
    
    @Override
    public double getCost() {
        return beverage.getCost() + 2.0;
    }
}

// 使用示例
public class DecoratorExample {
    public static void main(String[] args) {
        // 订购一杯浓缩咖啡
        Beverage beverage1 = new Espresso();
        System.out.println(beverage1.getDescription() + " ¥" + beverage1.getCost());
        
        // 订购一杯深度烘焙咖啡，加牛奶和摩卡
        Beverage beverage2 = new DarkRoast();
        beverage2 = new Milk(beverage2);
        beverage2 = new Mocha(beverage2);
        System.out.println(beverage2.getDescription() + " ¥" + beverage2.getCost());
        
        // 订购一杯综合咖啡，加豆浆、摩卡和奶泡
        Beverage beverage3 = new HouseBlend();
        beverage3 = new Soy(beverage3);
        beverage3 = new Mocha(beverage3);
        beverage3 = new Whip(beverage3);
        System.out.println(beverage3.getDescription() + " ¥" + beverage3.getCost());
        
        // 订购一杯浓缩咖啡，加双份摩卡
        Beverage beverage4 = new Espresso();
        beverage4 = new Mocha(beverage4);
        beverage4 = new Mocha(beverage4); // 双份摩卡
        beverage4 = new Whip(beverage4);
        System.out.println(beverage4.getDescription() + " ¥" + beverage4.getCost());
    }
}
```

#### 进阶例子：数据处理管道系统
```java
import java.util.*;
import java.util.function.Function;
import java.util.stream.Collectors;

// 组件接口 - 数据处理器
interface DataProcessor<T> {
    T process(T data);
    String getProcessorName();
    Map<String, Object> getMetrics();
}

// 具体组件 - 基础数据处理器
class BaseDataProcessor implements DataProcessor<String> {
    private long processCount = 0;
    private long totalProcessTime = 0;
    
    @Override
    public String process(String data) {
        long startTime = System.nanoTime();
        processCount++;
        
        // 基础处理：去除首尾空格
        String result = data != null ? data.trim() : "";
        
        long endTime = System.nanoTime();
        totalProcessTime += (endTime - startTime);
        
        return result;
    }
    
    @Override
    public String getProcessorName() {
        return "基础数据处理器";
    }
    
    @Override
    public Map<String, Object> getMetrics() {
        Map<String, Object> metrics = new HashMap<>();
        metrics.put("processCount", processCount);
        metrics.put("averageProcessTime", processCount > 0 ? totalProcessTime / processCount : 0);
        return metrics;
    }
}

// 抽象装饰器
abstract class DataProcessorDecorator implements DataProcessor<String> {
    protected DataProcessor<String> processor;
    protected long processCount = 0;
    protected long totalProcessTime = 0;
    
    public DataProcessorDecorator(DataProcessor<String> processor) {
        this.processor = processor;
    }
    
    @Override
    public String process(String data) {
        long startTime = System.nanoTime();
        processCount++;
        
        // 先调用被装饰对象的处理方法
        String result = processor.process(data);
        
        // 然后进行装饰处理
        result = doDecorate(result);
        
        long endTime = System.nanoTime();
        totalProcessTime += (endTime - startTime);
        
        return result;
    }
    
    protected abstract String doDecorate(String data);
    
    @Override
    public Map<String, Object> getMetrics() {
        Map<String, Object> metrics = new HashMap<>(processor.getMetrics());
        metrics.put(getProcessorName() + "_processCount", processCount);
        metrics.put(getProcessorName() + "_averageProcessTime", 
                   processCount > 0 ? totalProcessTime / processCount : 0);
        return metrics;
    }
}

// 具体装饰器 - 大小写转换装饰器
class CaseConverterDecorator extends DataProcessorDecorator {
    private CaseType caseType;
    
    public enum CaseType {
        UPPER, LOWER, TITLE
    }
    
    public CaseConverterDecorator(DataProcessor<String> processor, CaseType caseType) {
        super(processor);
        this.caseType = caseType;
    }
    
    @Override
    protected String doDecorate(String data) {
        if (data == null || data.isEmpty()) {
            return data;
        }
        
        switch (caseType) {
            case UPPER:
                return data.toUpperCase();
            case LOWER:
                return data.toLowerCase();
            case TITLE:
                return Arrays.stream(data.split("\\s+"))
                        .map(word -> word.substring(0, 1).toUpperCase() + 
                                   word.substring(1).toLowerCase())
                        .collect(Collectors.joining(" "));
            default:
                return data;
        }
    }
    
    @Override
    public String getProcessorName() {
        return "大小写转换装饰器(" + caseType + ")";
    }
}

// 具体装饰器 - 数据验证装饰器
class ValidationDecorator extends DataProcessorDecorator {
    private List<Function<String, Boolean>> validators;
    private String defaultValue;
    
    public ValidationDecorator(DataProcessor<String> processor, String defaultValue) {
        super(processor);
        this.validators = new ArrayList<>();
        this.defaultValue = defaultValue;
    }
    
    public ValidationDecorator addValidator(Function<String, Boolean> validator) {
        validators.add(validator);
        return this;
    }
    
    @Override
    protected String doDecorate(String data) {
        // 验证数据
        for (Function<String, Boolean> validator : validators) {
            if (!validator.apply(data)) {
                System.out.println("数据验证失败，使用默认值: " + defaultValue);
                return defaultValue;
            }
        }
        return data;
    }
    
    @Override
    public String getProcessorName() {
        return "数据验证装饰器";
    }
}

// 具体装饰器 - 数据清洗装饰器
class DataCleaningDecorator extends DataProcessorDecorator {
    private boolean removeSpecialChars;
    private boolean removeNumbers;
    private boolean removeExtraSpaces;
    
    public DataCleaningDecorator(DataProcessor<String> processor) {
        super(processor);
        this.removeSpecialChars = false;
        this.removeNumbers = false;
        this.removeExtraSpaces = true;
    }
    
    public DataCleaningDecorator removeSpecialChars(boolean remove) {
        this.removeSpecialChars = remove;
        return this;
    }
    
    public DataCleaningDecorator removeNumbers(boolean remove) {
        this.removeNumbers = remove;
        return this;
    }
    
    public DataCleaningDecorator removeExtraSpaces(boolean remove) {
        this.removeExtraSpaces = remove;
        return this;
    }
    
    @Override
    protected String doDecorate(String data) {
        if (data == null || data.isEmpty()) {
            return data;
        }
        
        String result = data;
        
        if (removeSpecialChars) {
            result = result.replaceAll("[^a-zA-Z0-9\\s]", "");
        }
        
        if (removeNumbers) {
            result = result.replaceAll("\\d", "");
        }
        
        if (removeExtraSpaces) {
            result = result.replaceAll("\\s+", " ");
        }
        
        return result;
    }
    
    @Override
    public String getProcessorName() {
        return "数据清洗装饰器";
    }
}

// 具体装饰器 - 日志记录装饰器
class LoggingDecorator extends DataProcessorDecorator {
    private String logLevel;
    private boolean logInput;
    private boolean logOutput;
    private boolean logProcessTime;
    
    public LoggingDecorator(DataProcessor<String> processor, String logLevel) {
        super(processor);
        this.logLevel = logLevel;
        this.logInput = true;
        this.logOutput = true;
        this.logProcessTime = true;
    }
    
    public LoggingDecorator setLogInput(boolean logInput) {
        this.logInput = logInput;
        return this;
    }
    
    public LoggingDecorator setLogOutput(boolean logOutput) {
        this.logOutput = logOutput;
        return this;
    }
    
    public LoggingDecorator setLogProcessTime(boolean logProcessTime) {
        this.logProcessTime = logProcessTime;
        return this;
    }
    
    @Override
    public String process(String data) {
        long startTime = System.nanoTime();
        
        if (logInput) {
            System.out.printf("[%s] 输入数据: '%s'%n", logLevel, data);
        }
        
        String result = super.process(data);
        
        long endTime = System.nanoTime();
        long processTime = endTime - startTime;
        
        if (logOutput) {
            System.out.printf("[%s] 输出数据: '%s'%n", logLevel, result);
        }
        
        if (logProcessTime) {
            System.out.printf("[%s] 处理时间: %d ns%n", logLevel, processTime);
        }
        
        return result;
    }
    
    @Override
    protected String doDecorate(String data) {
        // 日志装饰器不修改数据，只记录日志
        return data;
    }
    
    @Override
    public String getProcessorName() {
        return "日志记录装饰器(" + logLevel + ")";
    }
}

// 具体装饰器 - 缓存装饰器
class CacheDecorator extends DataProcessorDecorator {
    private Map<String, String> cache;
    private int maxCacheSize;
    private long cacheHits = 0;
    private long cacheMisses = 0;
    
    public CacheDecorator(DataProcessor<String> processor, int maxCacheSize) {
        super(processor);
        this.cache = new LinkedHashMap<String, String>(maxCacheSize + 1, 0.75f, true) {
            @Override
            protected boolean removeEldestEntry(Map.Entry<String, String> eldest) {
                return size() > maxCacheSize;
            }
        };
        this.maxCacheSize = maxCacheSize;
    }
    
    @Override
    public String process(String data) {
        // 检查缓存
        if (cache.containsKey(data)) {
            cacheHits++;
            System.out.println("缓存命中: " + data);
            return cache.get(data);
        }
        
        // 缓存未命中，调用实际处理
        cacheMisses++;
        String result = super.process(data);
        
        // 将结果放入缓存
        cache.put(data, result);
        
        return result;
    }
    
    @Override
    protected String doDecorate(String data) {
        // 缓存装饰器不修改数据
        return data;
    }
    
    @Override
    public String getProcessorName() {
        return "缓存装饰器";
    }
    
    @Override
    public Map<String, Object> getMetrics() {
        Map<String, Object> metrics = super.getMetrics();
        metrics.put("cacheHits", cacheHits);
        metrics.put("cacheMisses", cacheMisses);
        metrics.put("cacheHitRate", (cacheHits + cacheMisses) > 0 ? 
                   (double) cacheHits / (cacheHits + cacheMisses) : 0);
        metrics.put("cacheSize", cache.size());
        return metrics;
    }
    
    public void clearCache() {
        cache.clear();
        cacheHits = 0;
        cacheMisses = 0;
    }
}

// 数据处理管道构建器
class DataProcessingPipelineBuilder {
    private DataProcessor<String> processor;
    
    public DataProcessingPipelineBuilder(DataProcessor<String> baseProcessor) {
        this.processor = baseProcessor;
    }
    
    public DataProcessingPipelineBuilder addValidation(String defaultValue) {
        processor = new ValidationDecorator(processor, defaultValue);
        return this;
    }
    
    public DataProcessingPipelineBuilder addValidation(String defaultValue, 
                                                      Function<String, Boolean> validator) {
        ValidationDecorator validationDecorator = new ValidationDecorator(processor, defaultValue);
        validationDecorator.addValidator(validator);
        processor = validationDecorator;
        return this;
    }
    
    public DataProcessingPipelineBuilder addCleaning() {
        processor = new DataCleaningDecorator(processor);
        return this;
    }
    
    public DataProcessingPipelineBuilder addCleaning(boolean removeSpecialChars, 
                                                    boolean removeNumbers, 
                                                    boolean removeExtraSpaces) {
        DataCleaningDecorator cleaningDecorator = new DataCleaningDecorator(processor);
        cleaningDecorator.removeSpecialChars(removeSpecialChars)
                        .removeNumbers(removeNumbers)
                        .removeExtraSpaces(removeExtraSpaces);
        processor = cleaningDecorator;
        return this;
    }
    
    public DataProcessingPipelineBuilder addCaseConversion(CaseConverterDecorator.CaseType caseType) {
        processor = new CaseConverterDecorator(processor, caseType);
        return this;
    }
    
    public DataProcessingPipelineBuilder addLogging(String logLevel) {
        processor = new LoggingDecorator(processor, logLevel);
        return this;
    }
    
    public DataProcessingPipelineBuilder addCache(int maxCacheSize) {
        processor = new CacheDecorator(processor, maxCacheSize);
        return this;
    }
    
    public DataProcessor<String> build() {
        return processor;
    }
}

// 使用示例
public class DataProcessorDecoratorExample {
    public static void main(String[] args) {
        System.out.println("=== 数据处理管道装饰器系统 ===");
        
        // 创建基础处理器
        DataProcessor<String> baseProcessor = new BaseDataProcessor();
        
        // 构建复杂的数据处理管道
        DataProcessor<String> pipeline = new DataProcessingPipelineBuilder(baseProcessor)
                .addValidation("默认值", data -> data != null && !data.isEmpty())
                .addCleaning(true, false, true) // 移除特殊字符，保留数字，移除多余空格
                .addCaseConversion(CaseConverterDecorator.CaseType.TITLE)
                .addCache(10)
                .addLogging("INFO")
                .build();
        
        // 测试数据
        String[] testData = {
            "  hello world!!!  ",
            "JAVA programming123",
            "  design   patterns  ",
            "",
            null,
            "hello world!!!", // 重复数据，测试缓存
            "python@#$%programming",
            "software   ENGINEERING"
        };
        
        System.out.println("\n--- 处理测试数据 ---");
        for (String data : testData) {
            try {
                String result = pipeline.process(data);
                System.out.printf("原始: '%s' -> 结果: '%s'%n", data, result);
                System.out.println();
            } catch (Exception e) {
                System.err.println("处理数据时出错: " + e.getMessage());
            }
        }
        
        // 显示处理器指标
        System.out.println("--- 处理器指标 ---");
        Map<String, Object> metrics = pipeline.getMetrics();
        metrics.forEach((key, value) -> 
            System.out.println(key + ": " + value));
        
        // 演示不同的装饰器组合
        System.out.println("\n=== 不同装饰器组合演示 ===");
        
        // 简单的大小写转换管道
        DataProcessor<String> simplePipeline = new DataProcessingPipelineBuilder(new BaseDataProcessor())
                .addCaseConversion(CaseConverterDecorator.CaseType.UPPER)
                .build();
        
        System.out.println("简单管道处理: " + simplePipeline.process("Hello World"));
        
        // 数据清洗管道
        DataProcessor<String> cleaningPipeline = new DataProcessingPipelineBuilder(new BaseDataProcessor())
                .addCleaning(true, true, true) // 移除特殊字符和数字
                .addCaseConversion(CaseConverterDecorator.CaseType.LOWER)
                .build();
        
        System.out.println("清洗管道处理: " + cleaningPipeline.process("Hello123 World!@#"));
        
        // 带验证的管道
        DataProcessor<String> validationPipeline = new DataProcessingPipelineBuilder(new BaseDataProcessor())
                .addValidation("无效数据", data -> data != null && data.length() > 3)
                .addCaseConversion(CaseConverterDecorator.CaseType.TITLE)
                .build();
        
        System.out.println("验证管道处理短数据: " + validationPipeline.process("Hi"));
        System.out.println("验证管道处理长数据: " + validationPipeline.process("Hello World"));
        
        // 演示装饰器的动态组合
        System.out.println("\n=== 动态装饰器组合 ===");
        DataProcessor<String> dynamicProcessor = new BaseDataProcessor();
        
        // 动态添加装饰器
        dynamicProcessor = new CaseConverterDecorator(dynamicProcessor, CaseConverterDecorator.CaseType.UPPER);
        System.out.println("添加大写转换: " + dynamicProcessor.process("hello"));
        
        dynamicProcessor = new DataCleaningDecorator(dynamicProcessor).removeSpecialChars(true);
        System.out.println("添加数据清洗: " + dynamicProcessor.process("hello@#$world"));
        
        dynamicProcessor = new LoggingDecorator(dynamicProcessor, "DEBUG");
        System.out.println("添加日志记录:");
        dynamicProcessor.process("final test");
    }
}
```

**装饰器模式的关键特点：**
1. **动态扩展**: 可以在运行时动态地给对象添加新功能
2. **组合优于继承**: 通过组合而不是继承来扩展功能
3. **透明性**: 装饰后的对象与原对象具有相同的接口
4. **灵活性**: 可以任意组合多个装饰器
5. **单一职责**: 每个装饰器只负责一种功能的扩展

#### 参与者概念
- **组件接口**：定义对象的接口
- **具体组件**：实现组件接口的基本对象
- **装饰器**：维护组件引用并实现组件接口
- **具体装饰器**：实现具体的装饰功能

### 5. 外观模式 (Facade)

#### 核心概念
- **外观**：为子系统提供统一的高层接口
- **子系统**：实现具体功能的类集合
- **简化接口**：隐藏子系统的复杂性
- **解耦**：客户端与子系统的解耦

#### 实现概念
- **简单外观**：提供简单的统一接口
- **复杂外观**：提供多个层次的接口
- **抽象外观**：定义外观的抽象接口

### 6. 享元模式 (Flyweight)

**定义**：运用共享技术有效地支持大量细粒度的对象。

**GoF原定义**："Use sharing to support large numbers of fine-grained objects efficiently."

**核心思想**
- 将对象的状态分为内部状态（可共享）和外部状态（不可共享）
- 通过共享内部状态相同的对象来减少内存使用
- 外部状态由客户端维护并在需要时传递给享元对象

**基础例子：文本编辑器字符渲染系统**

```java
// 享元接口
interface CharacterFlyweight {
    void display(int row, int col, String color);
}

// 具体享元类 - 字符
class Character implements CharacterFlyweight {
    private char symbol; // 内部状态（可共享）
    
    public Character(char symbol) {
        this.symbol = symbol;
    }
    
    @Override
    public void display(int row, int col, String color) {
        // 外部状态：位置(row, col)和颜色(color)
        System.out.println("显示字符 '" + symbol + "' 在位置(" + 
                          row + "," + col + ") 颜色:" + color);
    }
}

// 享元工厂
class CharacterFactory {
    private static Map<java.lang.Character, CharacterFlyweight> characters = new HashMap<>();
    
    public static CharacterFlyweight getCharacter(char symbol) {
        CharacterFlyweight character = characters.get(symbol);
        if (character == null) {
            character = new Character(symbol);
            characters.put(symbol, character);
            System.out.println("创建新字符享元: " + symbol);
        }
        return character;
    }
    
    public static int getCreatedCharactersCount() {
        return characters.size();
    }
}

// 客户端使用
public class TextEditor {
    public static void main(String[] args) {
        String text = "HELLO WORLD";
        
        // 渲染文本
        for (int i = 0; i < text.length(); i++) {
            char c = text.charAt(i);
            if (c != ' ') {
                CharacterFlyweight character = CharacterFactory.getCharacter(c);
                character.display(0, i, "黑色");
            }
        }
        
        System.out.println("总共创建了 " + CharacterFactory.getCreatedCharactersCount() + 
                          " 个字符享元对象");
        // 输出：总共创建了 7 个字符享元对象（H,E,L,O,W,R,D）
        // 而不是 10 个（因为L重复了3次）
    }
}
```

**进阶例子：游戏粒子系统**

```java
// 粒子类型枚举
enum ParticleType {
    FIRE, WATER, EARTH, AIR
}

// 享元接口
interface ParticleFlyweight {
    void render(double x, double y, double velocity, String color);
    void move(double deltaTime);
}

// 具体享元类 - 粒子
class Particle implements ParticleFlyweight {
    private ParticleType type;        // 内部状态
    private String texture;           // 内部状态
    private double mass;              // 内部状态
    private double baseSpeed;         // 内部状态
    
    public Particle(ParticleType type) {
        this.type = type;
        // 根据类型设置内部状态
        switch (type) {
            case FIRE:
                this.texture = "fire_texture.png";
                this.mass = 0.1;
                this.baseSpeed = 5.0;
                break;
            case WATER:
                this.texture = "water_texture.png";
                this.mass = 1.0;
                this.baseSpeed = 3.0;
                break;
            case EARTH:
                this.texture = "earth_texture.png";
                this.mass = 2.0;
                this.baseSpeed = 1.0;
                break;
            case AIR:
                this.texture = "air_texture.png";
                this.mass = 0.05;
                this.baseSpeed = 8.0;
                break;
        }
    }
    
    @Override
    public void render(double x, double y, double velocity, String color) {
        // 外部状态：位置(x,y)、速度(velocity)、颜色(color)
        System.out.printf("渲染%s粒子 位置:(%.1f,%.1f) 速度:%.1f 颜色:%s 纹理:%s%n",
                         type, x, y, velocity, color, texture);
    }
    
    @Override
    public void move(double deltaTime) {
        // 基于内部状态的移动逻辑
        System.out.printf("%s粒子移动 质量:%.2f 基础速度:%.1f%n", 
                         type, mass, baseSpeed);
    }
}

// 享元工厂
class ParticleFactory {
    private static Map<ParticleType, ParticleFlyweight> particles = new HashMap<>();
    
    public static ParticleFlyweight getParticle(ParticleType type) {
        ParticleFlyweight particle = particles.get(type);
        if (particle == null) {
            particle = new Particle(type);
            particles.put(type, particle);
            System.out.println("创建新粒子享元: " + type);
        }
        return particle;
    }
    
    public static void printStats() {
        System.out.println("享元对象统计:");
        particles.forEach((type, particle) -> 
            System.out.println("- " + type + " 粒子享元"));
    }
}

// 粒子上下文 - 存储外部状态
class ParticleContext {
    private double x, y;              // 外部状态：位置
    private double velocityX, velocityY; // 外部状态：速度
    private String color;             // 外部状态：颜色
    private ParticleFlyweight particle; // 享元引用
    
    public ParticleContext(double x, double y, double vx, double vy, 
                          String color, ParticleType type) {
        this.x = x;
        this.y = y;
        this.velocityX = vx;
        this.velocityY = vy;
        this.color = color;
        this.particle = ParticleFactory.getParticle(type);
    }
    
    public void render() {
        double velocity = Math.sqrt(velocityX * velocityX + velocityY * velocityY);
        particle.render(x, y, velocity, color);
    }
    
    public void update(double deltaTime) {
        x += velocityX * deltaTime;
        y += velocityY * deltaTime;
        particle.move(deltaTime);
    }
}

// 粒子系统管理器
class ParticleSystem {
    private List<ParticleContext> particles = new ArrayList<>();
    
    public void addParticle(double x, double y, double vx, double vy, 
                           String color, ParticleType type) {
        particles.add(new ParticleContext(x, y, vx, vy, color, type));
    }
    
    public void update(double deltaTime) {
        for (ParticleContext particle : particles) {
            particle.update(deltaTime);
        }
    }
    
    public void render() {
        for (ParticleContext particle : particles) {
            particle.render();
        }
    }
    
    public int getParticleCount() {
        return particles.size();
    }
}

// 游戏演示
public class GameDemo {
    public static void main(String[] args) {
        ParticleSystem system = new ParticleSystem();
        
        // 创建大量粒子
        for (int i = 0; i < 1000; i++) {
            double x = Math.random() * 800;
            double y = Math.random() * 600;
            double vx = (Math.random() - 0.5) * 10;
            double vy = (Math.random() - 0.5) * 10;
            
            ParticleType type = ParticleType.values()[(int)(Math.random() * 4)];
            String color = "RGB(" + (int)(Math.random() * 255) + "," + 
                          (int)(Math.random() * 255) + "," + (int)(Math.random() * 255) + ")";
            
            system.addParticle(x, y, vx, vy, color, type);
        }
        
        System.out.println("创建了 " + system.getParticleCount() + " 个粒子实例");
        ParticleFactory.printStats();
        
        // 模拟游戏循环
        system.render();
        system.update(0.016); // 60 FPS
        
        System.out.println("\n享元模式优势:");
        System.out.println("- 1000个粒子实例只需要4个享元对象");
        System.out.println("- 大大减少了内存使用");
        System.out.println("- 提高了系统性能");
    }
}
```

**模式优势**
- **内存效率**：通过共享减少对象数量，节省内存
- **性能提升**：减少对象创建和垃圾回收的开销
- **可扩展性**：支持大量细粒度对象的高效管理

**适用场景**
- 需要创建大量相似对象的系统
- 对象的大部分状态可以外部化
- 可以用较少的共享对象替代大量对象
- 应用程序不依赖于对象标识（对象可以被共享）

#### 核心概念
- **享元**：通过共享技术支持大量细粒度对象
- **内部状态**：可以共享的状态信息
- **外部状态**：不可共享的状态信息
- **享元工厂**：管理享元对象的创建和共享

#### 参与者概念
- **享元接口**：定义享元对象的接口
- **具体享元**：实现享元接口的可共享对象
- **非共享享元**：不需要共享的享元对象
- **享元工厂**：创建和管理享元对象

### 7. 代理模式 (Proxy)

**定义**：为其他对象提供一种代理以控制对这个对象的访问。

**GoF原定义**："Provide a surrogate or placeholder for another object to control access to it."

**核心思想**
- 通过代理对象控制对目标对象的访问
- 代理对象与目标对象实现相同的接口
- 可以在访问前后添加额外的处理逻辑
- 支持延迟加载、访问控制、缓存等功能

**基础例子：图片加载代理**

```java
// 图片接口
interface Image {
    void display();
}

// 真实图片类
class RealImage implements Image {
    private String filename;
    
    public RealImage(String filename) {
        this.filename = filename;
        loadFromDisk();
    }
    
    private void loadFromDisk() {
        System.out.println("正在从磁盘加载图片: " + filename);
        // 模拟耗时的加载过程
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
    
    @Override
    public void display() {
        System.out.println("显示图片: " + filename);
    }
}

// 图片代理类
class ImageProxy implements Image {
    private String filename;
    private RealImage realImage;
    
    public ImageProxy(String filename) {
        this.filename = filename;
    }
    
    @Override
    public void display() {
        // 延迟加载：只有在真正需要显示时才创建真实对象
        if (realImage == null) {
            realImage = new RealImage(filename);
        }
        realImage.display();
    }
}

// 客户端使用
public class ImageViewer {
    public static void main(String[] args) {
        System.out.println("=== 创建图片代理（不会立即加载）===");
        Image image1 = new ImageProxy("photo1.jpg");
        Image image2 = new ImageProxy("photo2.jpg");
        
        System.out.println("\n=== 第一次显示图片（会触发加载）===");
        image1.display();
        
        System.out.println("\n=== 第二次显示同一图片（不会重新加载）===");
        image1.display();
        
        System.out.println("\n=== 显示另一张图片===");
        image2.display();
    }
}
```

**进阶例子：企业级缓存代理系统**

```java
// 数据访问接口
interface DataService {
    String getData(String key);
    void setData(String key, String value);
    boolean deleteData(String key);
}

// 真实数据服务（模拟数据库访问）
class DatabaseService implements DataService {
    private Map<String, String> database = new HashMap<>();
    
    @Override
    public String getData(String key) {
        // 模拟数据库查询延迟
        simulateDelay(100);
        String value = database.get(key);
        System.out.println("从数据库获取数据: " + key + " = " + value);
        return value;
    }
    
    @Override
    public void setData(String key, String value) {
        simulateDelay(150);
        database.put(key, value);
        System.out.println("数据已保存到数据库: " + key + " = " + value);
    }
    
    @Override
    public boolean deleteData(String key) {
        simulateDelay(120);
        boolean existed = database.containsKey(key);
        database.remove(key);
        System.out.println("从数据库删除数据: " + key + " (存在: " + existed + ")");
        return existed;
    }
    
    private void simulateDelay(int ms) {
        try {
            Thread.sleep(ms);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
}

// 缓存代理类
class CachedDataServiceProxy implements DataService {
    private DataService realService;
    private Map<String, String> cache = new HashMap<>();
    private Map<String, Long> cacheTimestamps = new HashMap<>();
    private final long CACHE_EXPIRY_TIME = 5000; // 5秒缓存过期时间
    private int cacheHits = 0;
    private int cacheMisses = 0;
    
    public CachedDataServiceProxy(DataService realService) {
        this.realService = realService;
    }
    
    @Override
    public String getData(String key) {
        // 检查缓存是否存在且未过期
        if (isCacheValid(key)) {
            cacheHits++;
            String cachedValue = cache.get(key);
            System.out.println("缓存命中: " + key + " = " + cachedValue);
            return cachedValue;
        }
        
        // 缓存未命中，从真实服务获取数据
        cacheMisses++;
        String value = realService.getData(key);
        
        // 将数据放入缓存
        if (value != null) {
            cache.put(key, value);
            cacheTimestamps.put(key, System.currentTimeMillis());
            System.out.println("数据已缓存: " + key);
        }
        
        return value;
    }
    
    @Override
    public void setData(String key, String value) {
        // 更新真实服务
        realService.setData(key, value);
        
        // 更新缓存
        cache.put(key, value);
        cacheTimestamps.put(key, System.currentTimeMillis());
        System.out.println("缓存已更新: " + key);
    }
    
    @Override
    public boolean deleteData(String key) {
        // 从真实服务删除
        boolean result = realService.deleteData(key);
        
        // 从缓存中移除
        cache.remove(key);
        cacheTimestamps.remove(key);
        System.out.println("缓存已清除: " + key);
        
        return result;
    }
    
    private boolean isCacheValid(String key) {
        if (!cache.containsKey(key)) {
            return false;
        }
        
        long timestamp = cacheTimestamps.get(key);
        long currentTime = System.currentTimeMillis();
        return (currentTime - timestamp) < CACHE_EXPIRY_TIME;
    }
    
    public void printCacheStats() {
        System.out.println("\n=== 缓存统计 ===");
        System.out.println("缓存命中: " + cacheHits);
        System.out.println("缓存未命中: " + cacheMisses);
        System.out.println("命中率: " + 
            (cacheHits + cacheMisses > 0 ? 
             String.format("%.2f%%", (double)cacheHits / (cacheHits + cacheMisses) * 100) : 
             "0%"));
        System.out.println("当前缓存大小: " + cache.size());
    }
    
    public void clearExpiredCache() {
        long currentTime = System.currentTimeMillis();
        List<String> expiredKeys = new ArrayList<>();
        
        for (Map.Entry<String, Long> entry : cacheTimestamps.entrySet()) {
            if (currentTime - entry.getValue() >= CACHE_EXPIRY_TIME) {
                expiredKeys.add(entry.getKey());
            }
        }
        
        for (String key : expiredKeys) {
            cache.remove(key);
            cacheTimestamps.remove(key);
        }
        
        if (!expiredKeys.isEmpty()) {
            System.out.println("清理过期缓存: " + expiredKeys);
        }
    }
}

// 访问控制代理
class SecureDataServiceProxy implements DataService {
    private DataService realService;
    private String currentUser;
    private Set<String> authorizedUsers;
    
    public SecureDataServiceProxy(DataService realService, String currentUser) {
        this.realService = realService;
        this.currentUser = currentUser;
        this.authorizedUsers = Set.of("admin", "user1", "user2");
    }
    
    @Override
    public String getData(String key) {
        if (!isAuthorized()) {
            throw new SecurityException("用户 " + currentUser + " 无权访问数据");
        }
        System.out.println("访问控制通过，用户: " + currentUser);
        return realService.getData(key);
    }
    
    @Override
    public void setData(String key, String value) {
        if (!isAuthorized()) {
            throw new SecurityException("用户 " + currentUser + " 无权修改数据");
        }
        if (!currentUser.equals("admin") && key.startsWith("system_")) {
            throw new SecurityException("普通用户无权修改系统数据");
        }
        System.out.println("写入权限检查通过，用户: " + currentUser);
        realService.setData(key, value);
    }
    
    @Override
    public boolean deleteData(String key) {
        if (!currentUser.equals("admin")) {
            throw new SecurityException("只有管理员可以删除数据");
        }
        System.out.println("删除权限检查通过，管理员: " + currentUser);
        return realService.deleteData(key);
    }
    
    private boolean isAuthorized() {
        return authorizedUsers.contains(currentUser);
    }
}

// 演示多层代理
public class EnterpriseDataSystemDemo {
    public static void main(String[] args) {
        // 创建真实服务
        DataService database = new DatabaseService();
        
        // 添加缓存代理
        CachedDataServiceProxy cachedService = new CachedDataServiceProxy(database);
        
        // 添加安全代理
        DataService secureService = new SecureDataServiceProxy(cachedService, "admin");
        
        System.out.println("=== 企业级数据访问系统演示 ===\n");
        
        // 第一次访问（缓存未命中）
        System.out.println("1. 首次访问数据:");
        secureService.setData("user_profile", "John Doe Profile");
        String data1 = secureService.getData("user_profile");
        
        System.out.println("\n2. 再次访问相同数据（缓存命中）:");
        String data2 = secureService.getData("user_profile");
        
        System.out.println("\n3. 访问不存在的数据:");
        String data3 = secureService.getData("non_existent");
        
        System.out.println("\n4. 删除数据:");
        secureService.deleteData("user_profile");
        
        // 显示缓存统计
        cachedService.printCacheStats();
        
        System.out.println("\n=== 测试访问控制 ===");
        try {
            DataService userService = new SecureDataServiceProxy(cachedService, "unauthorized_user");
            userService.getData("test");
        } catch (SecurityException e) {
            System.out.println("安全异常: " + e.getMessage());
        }
        
        System.out.println("\n=== 代理模式优势 ===");
        System.out.println("- 透明性: 客户端无需知道代理的存在");
        System.out.println("- 可组合: 多个代理可以链式组合");
        System.out.println("- 功能增强: 添加缓存、安全、日志等功能");
        System.out.println("- 延迟加载: 提高系统启动性能");
    }
}
```

**代理模式的类型**
1. **虚拟代理**：延迟创建开销大的对象
2. **保护代理**：控制对原始对象的访问权限
3. **远程代理**：为远程对象提供本地代表
4. **智能引用代理**：提供比普通指针更多的功能

**模式优势**
- **访问控制**：可以控制对目标对象的访问
- **延迟加载**：只在需要时才创建目标对象
- **缓存功能**：可以缓存目标对象的结果
- **透明性**：客户端无需知道代理的存在

**适用场景**
- 需要延迟加载重量级对象
- 需要控制对对象的访问权限
- 需要为对象访问添加额外功能（缓存、日志等）
- 需要在网络上访问远程对象

#### 核心概念
- **代理**：为其他对象提供代理以控制对这个对象的访问
- **真实主题**：代理所代表的真实对象
- **代理控制**：控制对真实对象的访问

#### 代理类型概念
- **远程代理**：为远程对象提供本地代表
- **虚拟代理**：延迟创建开销大的对象
- **保护代理**：控制对原始对象的访问权限
- **智能引用代理**：提供比简单指针更多的功能
- **缓存代理**：为开销大的运算结果提供暂时存储

#### 实现概念
- **静态代理**：编译时确定代理关系
- **动态代理**：运行时动态创建代理对象
- **JDK动态代理**：基于接口的动态代理
- **CGLIB代理**：基于继承的动态代理

## 第四部分：行为型模式概念

### 1. 责任链模式 (Chain of Responsibility)

**定义**：使多个对象都有机会处理请求，从而避免请求的发送者和接收者之间的耦合关系。将这些对象连成一条链，并沿着这条链传递该请求，直到有一个对象处理它为止。

**GoF原定义**："Avoid coupling the sender of a request to its receiver by giving more than one object a chance to handle the request. Chain the receiving objects and pass the request along the chain until an object handles it."

**核心思想**
- 将请求的发送者和接收者解耦
- 多个对象都有机会处理请求
- 请求沿着链传递直到被处理
- 动态组织和分配责任

**基础例子：请假审批系统**

```java
// 请假请求类
class LeaveRequest {
    private String employeeName;
    private int days;
    private String reason;
    
    public LeaveRequest(String employeeName, int days, String reason) {
        this.employeeName = employeeName;
        this.days = days;
        this.reason = reason;
    }
    
    // Getters
    public String getEmployeeName() { return employeeName; }
    public int getDays() { return days; }
    public String getReason() { return reason; }
}

// 抽象审批者
abstract class Approver {
    protected Approver nextApprover;
    protected String name;
    
    public Approver(String name) {
        this.name = name;
    }
    
    public void setNextApprover(Approver nextApprover) {
        this.nextApprover = nextApprover;
    }
    
    public abstract void handleRequest(LeaveRequest request);
}

// 主管 - 可以批准1-3天的请假
class Supervisor extends Approver {
    public Supervisor(String name) {
        super(name);
    }
    
    @Override
    public void handleRequest(LeaveRequest request) {
        if (request.getDays() <= 3) {
            System.out.println("主管 " + name + " 批准了 " + request.getEmployeeName() + 
                             " 的 " + request.getDays() + " 天请假申请");
        } else if (nextApprover != null) {
            System.out.println("主管 " + name + " 无权批准，转交上级处理");
            nextApprover.handleRequest(request);
        } else {
            System.out.println("没有合适的审批者处理此请求");
        }
    }
}

// 经理 - 可以批准1-7天的请假
class Manager extends Approver {
    public Manager(String name) {
        super(name);
    }
    
    @Override
    public void handleRequest(LeaveRequest request) {
        if (request.getDays() <= 7) {
            System.out.println("经理 " + name + " 批准了 " + request.getEmployeeName() + 
                             " 的 " + request.getDays() + " 天请假申请");
        } else if (nextApprover != null) {
            System.out.println("经理 " + name + " 无权批准，转交上级处理");
            nextApprover.handleRequest(request);
        } else {
            System.out.println("没有合适的审批者处理此请求");
        }
    }
}

// 总监 - 可以批准1-15天的请假
class Director extends Approver {
    public Director(String name) {
        super(name);
    }
    
    @Override
    public void handleRequest(LeaveRequest request) {
        if (request.getDays() <= 15) {
            System.out.println("总监 " + name + " 批准了 " + request.getEmployeeName() + 
                             " 的 " + request.getDays() + " 天请假申请");
        } else if (nextApprover != null) {
            System.out.println("总监 " + name + " 无权批准，转交上级处理");
            nextApprover.handleRequest(request);
        } else {
            System.out.println("请假天数过多，无法批准");
        }
    }
}

// 客户端使用
public class LeaveApprovalDemo {
    public static void main(String[] args) {
        // 创建审批链
        Approver supervisor = new Supervisor("张主管");
        Approver manager = new Manager("李经理");
        Approver director = new Director("王总监");
        
        // 设置责任链
        supervisor.setNextApprover(manager);
        manager.setNextApprover(director);
        
        // 测试不同的请假申请
        System.out.println("=== 请假审批系统演示 ===\n");
        
        LeaveRequest request1 = new LeaveRequest("小明", 2, "生病");
        System.out.println("处理请求: " + request1.getEmployeeName() + " 请假 " + request1.getDays() + " 天");
        supervisor.handleRequest(request1);
        
        System.out.println();
        LeaveRequest request2 = new LeaveRequest("小红", 5, "旅游");
        System.out.println("处理请求: " + request2.getEmployeeName() + " 请假 " + request2.getDays() + " 天");
        supervisor.handleRequest(request2);
        
        System.out.println();
        LeaveRequest request3 = new LeaveRequest("小李", 10, "家事");
        System.out.println("处理请求: " + request3.getEmployeeName() + " 请假 " + request3.getDays() + " 天");
        supervisor.handleRequest(request3);
        
        System.out.println();
        LeaveRequest request4 = new LeaveRequest("小王", 20, "长期休假");
        System.out.println("处理请求: " + request4.getEmployeeName() + " 请假 " + request4.getDays() + " 天");
        supervisor.handleRequest(request4);
    }
}
```

**进阶例子：企业级日志处理系统**

```java
// 日志级别枚举
enum LogLevel {
    DEBUG(1), INFO(2), WARN(3), ERROR(4), FATAL(5);
    
    private final int level;
    
    LogLevel(int level) {
        this.level = level;
    }
    
    public int getLevel() {
        return level;
    }
}

// 日志消息类
class LogMessage {
    private LogLevel level;
    private String message;
    private String timestamp;
    private String source;
    private Exception exception;
    
    public LogMessage(LogLevel level, String message, String source) {
        this.level = level;
        this.message = message;
        this.source = source;
        this.timestamp = java.time.LocalDateTime.now().toString();
    }
    
    public LogMessage(LogLevel level, String message, String source, Exception exception) {
        this(level, message, source);
        this.exception = exception;
    }
    
    // Getters
    public LogLevel getLevel() { return level; }
    public String getMessage() { return message; }
    public String getTimestamp() { return timestamp; }
    public String getSource() { return source; }
    public Exception getException() { return exception; }
    
    @Override
    public String toString() {
        return String.format("[%s] %s - %s: %s", 
                           timestamp, level, source, message);
    }
}

// 抽象日志处理器
abstract class LogHandler {
    protected LogHandler nextHandler;
    protected LogLevel handlerLevel;
    protected String handlerName;
    
    public LogHandler(LogLevel level, String name) {
        this.handlerLevel = level;
        this.handlerName = name;
    }
    
    public void setNextHandler(LogHandler nextHandler) {
        this.nextHandler = nextHandler;
    }
    
    public void handle(LogMessage message) {
        if (canHandle(message)) {
            writeLog(message);
        }
        
        // 继续传递给下一个处理器（可以有多个处理器同时处理）
        if (nextHandler != null) {
            nextHandler.handle(message);
        }
    }
    
    protected boolean canHandle(LogMessage message) {
        return message.getLevel().getLevel() >= handlerLevel.getLevel();
    }
    
    protected abstract void writeLog(LogMessage message);
}

// 控制台日志处理器
class ConsoleLogHandler extends LogHandler {
    public ConsoleLogHandler(LogLevel level) {
        super(level, "Console Handler");
    }
    
    @Override
    protected void writeLog(LogMessage message) {
        System.out.println("控制台输出: " + message);
        if (message.getException() != null) {
            System.out.println("异常信息: " + message.getException().getMessage());
        }
    }
}

// 文件日志处理器
class FileLogHandler extends LogHandler {
    private String filename;
    
    public FileLogHandler(LogLevel level, String filename) {
        super(level, "File Handler");
        this.filename = filename;
    }
    
    @Override
    protected void writeLog(LogMessage message) {
        System.out.println("写入文件 " + filename + ": " + message);
        // 实际实现中会写入文件
    }
}

// 邮件日志处理器
class EmailLogHandler extends LogHandler {
    private String emailAddress;
    
    public EmailLogHandler(LogLevel level, String emailAddress) {
        super(level, "Email Handler");
        this.emailAddress = emailAddress;
    }
    
    @Override
    protected void writeLog(LogMessage message) {
        System.out.println("发送邮件到 " + emailAddress + ": " + message);
        // 实际实现中会发送邮件
    }
}

// 数据库日志处理器
class DatabaseLogHandler extends LogHandler {
    private String tableName;
    
    public DatabaseLogHandler(LogLevel level, String tableName) {
        super(level, "Database Handler");
        this.tableName = tableName;
    }
    
    @Override
    protected void writeLog(LogMessage message) {
        System.out.println("保存到数据库表 " + tableName + ": " + message);
        // 实际实现中会保存到数据库
    }
}

// 短信通知处理器
class SMSLogHandler extends LogHandler {
    private String phoneNumber;
    
    public SMSLogHandler(LogLevel level, String phoneNumber) {
        super(level, "SMS Handler");
        this.phoneNumber = phoneNumber;
    }
    
    @Override
    protected void writeLog(LogMessage message) {
        System.out.println("发送短信到 " + phoneNumber + ": " + 
                          message.getLevel() + " - " + message.getMessage());
    }
}

// 日志管理器
class LogManager {
    private LogHandler handlerChain;
    
    public void setHandlerChain(LogHandler handlerChain) {
        this.handlerChain = handlerChain;
    }
    
    public void log(LogLevel level, String message, String source) {
        LogMessage logMessage = new LogMessage(level, message, source);
        if (handlerChain != null) {
            handlerChain.handle(logMessage);
        }
    }
    
    public void log(LogLevel level, String message, String source, Exception exception) {
        LogMessage logMessage = new LogMessage(level, message, source, exception);
        if (handlerChain != null) {
            handlerChain.handle(logMessage);
        }
    }
}

// 企业级日志系统演示
public class EnterpriseLogSystemDemo {
    public static void main(String[] args) {
        // 创建不同级别的日志处理器
        LogHandler consoleHandler = new ConsoleLogHandler(LogLevel.DEBUG);
        LogHandler fileHandler = new FileLogHandler(LogLevel.INFO, "application.log");
        LogHandler databaseHandler = new DatabaseLogHandler(LogLevel.WARN, "log_table");
        LogHandler emailHandler = new EmailLogHandler(LogLevel.ERROR, "admin@company.com");
        LogHandler smsHandler = new SMSLogHandler(LogLevel.FATAL, "13800138000");
        
        // 构建责任链
        consoleHandler.setNextHandler(fileHandler);
        fileHandler.setNextHandler(databaseHandler);
        databaseHandler.setNextHandler(emailHandler);
        emailHandler.setNextHandler(smsHandler);
        
        // 创建日志管理器
        LogManager logManager = new LogManager();
        logManager.setHandlerChain(consoleHandler);
        
        System.out.println("=== 企业级日志处理系统演示 ===\n");
        
        // 测试不同级别的日志
        System.out.println("1. DEBUG级别日志:");
        logManager.log(LogLevel.DEBUG, "调试信息：用户登录流程开始", "UserService");
        
        System.out.println("\n2. INFO级别日志:");
        logManager.log(LogLevel.INFO, "用户登录成功", "AuthService");
        
        System.out.println("\n3. WARN级别日志:");
        logManager.log(LogLevel.WARN, "数据库连接池使用率达到80%", "DatabasePool");
        
        System.out.println("\n4. ERROR级别日志:");
        logManager.log(LogLevel.ERROR, "支付处理失败", "PaymentService", 
                      new RuntimeException("网络连接超时"));
        
        System.out.println("\n5. FATAL级别日志:");
        logManager.log(LogLevel.FATAL, "系统内存不足，服务即将停止", "SystemMonitor");
        
        System.out.println("\n=== 责任链模式优势 ===");
        System.out.println("- 解耦: 发送者不需要知道具体的处理者");
        System.out.println("- 灵活性: 可以动态添加或删除处理器");
        System.out.println("- 可扩展: 容易添加新的处理器类型");
        System.out.println("- 多重处理: 一个请求可以被多个处理器处理");
    }
}
```

**模式优势**
- **降低耦合度**：请求发送者和接收者之间没有直接关系
- **增强灵活性**：可以动态地增加或删除责任链中的处理者
- **简化对象**：对象不需要知道链的结构
- **增强扩展性**：增加新的请求处理类很方便

**适用场景**
- 有多个对象可以处理同一个请求，具体哪个对象处理该请求在运行时确定
- 在不明确指定接收者的情况下，向多个对象中的一个提交一个请求
- 可动态指定一组对象处理请求

#### 核心概念
- **责任链**：将请求的发送者和接收者解耦
- **处理者**：处理请求的对象
- **请求传递**：沿着链传递请求直到有对象处理它
- **动态链**：可以动态改变链的结构

#### 实现概念
- **纯的责任链**：请求只能被一个处理者处理
- **不纯的责任链**：请求可以被多个处理者处理
- **链的构建**：如何构建和管理责任链

### 2. 命令模式 (Command)

**定义**：将一个请求封装为一个对象，从而使你可用不同的请求对客户进行参数化；对请求排队或记录请求日志，以及支持可撤销的操作。

**GoF原定义**："Encapsulate a request as an object, thereby letting you parameterize clients with different requests, queue or log requests, and support undoable operations."

**核心思想**
- 将请求封装成对象，使请求的调用者和接收者解耦
- 支持请求的排队、记录和撤销操作
- 可以组合命令来创建宏命令
- 支持事务性操作和日志记录

**基础例子：遥控器控制系统**

```java
// 命令接口
interface Command {
    void execute();
    void undo();
}

// 接收者 - 电灯
class Light {
    private String location;
    private boolean isOn = false;
    
    public Light(String location) {
        this.location = location;
    }
    
    public void on() {
        isOn = true;
        System.out.println(location + "的灯已打开");
    }
    
    public void off() {
        isOn = false;
        System.out.println(location + "的灯已关闭");
    }
    
    public boolean isOn() {
        return isOn;
    }
}

// 接收者 - 风扇
class Fan {
    private String location;
    private int speed = 0; // 0=关闭, 1=低速, 2=中速, 3=高速
    
    public Fan(String location) {
        this.location = location;
    }
    
    public void high() {
        speed = 3;
        System.out.println(location + "的风扇设置为高速");
    }
    
    public void medium() {
        speed = 2;
        System.out.println(location + "的风扇设置为中速");
    }
    
    public void low() {
        speed = 1;
        System.out.println(location + "的风扇设置为低速");
    }
    
    public void off() {
        speed = 0;
        System.out.println(location + "的风扇已关闭");
    }
    
    public int getSpeed() {
        return speed;
    }
}

// 具体命令 - 开灯命令
class LightOnCommand implements Command {
    private Light light;
    
    public LightOnCommand(Light light) {
        this.light = light;
    }
    
    @Override
    public void execute() {
        light.on();
    }
    
    @Override
    public void undo() {
        light.off();
    }
}

// 具体命令 - 关灯命令
class LightOffCommand implements Command {
    private Light light;
    
    public LightOffCommand(Light light) {
        this.light = light;
    }
    
    @Override
    public void execute() {
        light.off();
    }
    
    @Override
    public void undo() {
        light.on();
    }
}

// 具体命令 - 风扇高速命令
class FanHighCommand implements Command {
    private Fan fan;
    private int prevSpeed;
    
    public FanHighCommand(Fan fan) {
        this.fan = fan;
    }
    
    @Override
    public void execute() {
        prevSpeed = fan.getSpeed();
        fan.high();
    }
    
    @Override
    public void undo() {
        switch (prevSpeed) {
            case 0: fan.off(); break;
            case 1: fan.low(); break;
            case 2: fan.medium(); break;
            case 3: fan.high(); break;
        }
    }
}

// 空命令（空对象模式）
class NoCommand implements Command {
    @Override
    public void execute() {
        // 什么都不做
    }
    
    @Override
    public void undo() {
        // 什么都不做
    }
}

// 调用者 - 遥控器
class RemoteControl {
    private Command[] onCommands;
    private Command[] offCommands;
    private Command undoCommand;
    
    public RemoteControl() {
        onCommands = new Command[7];
        offCommands = new Command[7];
        
        Command noCommand = new NoCommand();
        for (int i = 0; i < 7; i++) {
            onCommands[i] = noCommand;
            offCommands[i] = noCommand;
        }
        undoCommand = noCommand;
    }
    
    public void setCommand(int slot, Command onCommand, Command offCommand) {
        onCommands[slot] = onCommand;
        offCommands[slot] = offCommand;
    }
    
    public void onButtonPressed(int slot) {
        onCommands[slot].execute();
        undoCommand = onCommands[slot];
    }
    
    public void offButtonPressed(int slot) {
        offCommands[slot].execute();
        undoCommand = offCommands[slot];
    }
    
    public void undoButtonPressed() {
        undoCommand.undo();
    }
    
    public String toString() {
        StringBuilder sb = new StringBuilder();
        sb.append("\n------ 遥控器 ------\n");
        for (int i = 0; i < onCommands.length; i++) {
            sb.append("[插槽 " + i + "] " + onCommands[i].getClass().getSimpleName() + 
                     "    " + offCommands[i].getClass().getSimpleName() + "\n");
        }
        return sb.toString();
    }
}

// 客户端使用
public class RemoteControlDemo {
    public static void main(String[] args) {
        RemoteControl remote = new RemoteControl();
        
        // 创建设备
        Light livingRoomLight = new Light("客厅");
        Light kitchenLight = new Light("厨房");
        Fan ceilingFan = new Fan("客厅");
        
        // 创建命令
        LightOnCommand livingRoomLightOn = new LightOnCommand(livingRoomLight);
        LightOffCommand livingRoomLightOff = new LightOffCommand(livingRoomLight);
        LightOnCommand kitchenLightOn = new LightOnCommand(kitchenLight);
        LightOffCommand kitchenLightOff = new LightOffCommand(kitchenLight);
        FanHighCommand ceilingFanHigh = new FanHighCommand(ceilingFan);
        
        // 设置遥控器
        remote.setCommand(0, livingRoomLightOn, livingRoomLightOff);
        remote.setCommand(1, kitchenLightOn, kitchenLightOff);
        remote.setCommand(2, ceilingFanHigh, new NoCommand());
        
        System.out.println(remote);
        
        System.out.println("=== 遥控器测试 ===");
        remote.onButtonPressed(0);
        remote.offButtonPressed(0);
        remote.undoButtonPressed();
        
        remote.onButtonPressed(1);
        remote.undoButtonPressed();
        
        remote.onButtonPressed(2);
        remote.undoButtonPressed();
    }
}
```

**进阶例子：企业级文档编辑器命令系统**

```java
// 文档类
class Document {
    private StringBuilder content;
    private String filename;
    
    public Document(String filename) {
        this.filename = filename;
        this.content = new StringBuilder();
    }
    
    public void insertText(int position, String text) {
        content.insert(position, text);
        System.out.println("在位置 " + position + " 插入文本: \"" + text + "\"");
    }
    
    public String deleteText(int position, int length) {
        String deletedText = content.substring(position, position + length);
        content.delete(position, position + length);
        System.out.println("从位置 " + position + " 删除 " + length + " 个字符: \"" + deletedText + "\"");
        return deletedText;
    }
    
    public void replaceText(int position, int length, String newText) {
        content.replace(position, position + length, newText);
        System.out.println("替换位置 " + position + " 的文本为: \"" + newText + "\"");
    }
    
    public String getContent() {
        return content.toString();
    }
    
    public int getLength() {
        return content.length();
    }
    
    public String getFilename() {
        return filename;
    }
    
    public void save() {
        System.out.println("文档 \"" + filename + "\" 已保存");
    }
    
    public void print() {
        System.out.println("打印文档 \"" + filename + "\"");
    }
}

// 抽象命令接口
interface DocumentCommand {
    void execute();
    void undo();
    String getDescription();
    long getTimestamp();
}

// 抽象文档命令基类
abstract class AbstractDocumentCommand implements DocumentCommand {
    protected Document document;
    protected long timestamp;
    
    public AbstractDocumentCommand(Document document) {
        this.document = document;
        this.timestamp = System.currentTimeMillis();
    }
    
    @Override
    public long getTimestamp() {
        return timestamp;
    }
}

// 插入文本命令
class InsertTextCommand extends AbstractDocumentCommand {
    private int position;
    private String text;
    
    public InsertTextCommand(Document document, int position, String text) {
        super(document);
        this.position = position;
        this.text = text;
    }
    
    @Override
    public void execute() {
        document.insertText(position, text);
    }
    
    @Override
    public void undo() {
        document.deleteText(position, text.length());
    }
    
    @Override
    public String getDescription() {
        return "插入文本: \"" + text + "\" 在位置 " + position;
    }
}

// 删除文本命令
class DeleteTextCommand extends AbstractDocumentCommand {
    private int position;
    private int length;
    private String deletedText;
    
    public DeleteTextCommand(Document document, int position, int length) {
        super(document);
        this.position = position;
        this.length = length;
    }
    
    @Override
    public void execute() {
        deletedText = document.deleteText(position, length);
    }
    
    @Override
    public void undo() {
        document.insertText(position, deletedText);
    }
    
    @Override
    public String getDescription() {
        return "删除 " + length + " 个字符从位置 " + position;
    }
}

// 替换文本命令
class ReplaceTextCommand extends AbstractDocumentCommand {
    private int position;
    private int length;
    private String newText;
    private String oldText;
    
    public ReplaceTextCommand(Document document, int position, int length, String newText) {
        super(document);
        this.position = position;
        this.length = length;
        this.newText = newText;
    }
    
    @Override
    public void execute() {
        oldText = document.getContent().substring(position, position + length);
        document.replaceText(position, length, newText);
    }
    
    @Override
    public void undo() {
        document.replaceText(position, newText.length(), oldText);
    }
    
    @Override
    public String getDescription() {
        return "替换文本: \"" + oldText + "\" -> \"" + newText + "\" 在位置 " + position;
    }
}

// 保存文档命令
class SaveDocumentCommand extends AbstractDocumentCommand {
    public SaveDocumentCommand(Document document) {
        super(document);
    }
    
    @Override
    public void execute() {
        document.save();
    }
    
    @Override
    public void undo() {
        System.out.println("无法撤销保存操作");
    }
    
    @Override
    public String getDescription() {
        return "保存文档";
    }
}

// 宏命令 - 组合多个命令
class MacroCommand implements DocumentCommand {
    private List<DocumentCommand> commands;
    private String description;
    private long timestamp;
    
    public MacroCommand(String description) {
        this.commands = new ArrayList<>();
        this.description = description;
        this.timestamp = System.currentTimeMillis();
    }
    
    public void addCommand(DocumentCommand command) {
        commands.add(command);
    }
    
    @Override
    public void execute() {
        System.out.println("执行宏命令: " + description);
        for (DocumentCommand command : commands) {
            command.execute();
        }
    }
    
    @Override
    public void undo() {
        System.out.println("撤销宏命令: " + description);
        // 逆序撤销
        for (int i = commands.size() - 1; i >= 0; i--) {
            commands.get(i).undo();
        }
    }
    
    @Override
    public String getDescription() {
        return "宏命令: " + description + " (包含 " + commands.size() + " 个子命令)";
    }
    
    @Override
    public long getTimestamp() {
        return timestamp;
    }
}

// 命令历史管理器
class CommandHistory {
    private Stack<DocumentCommand> undoStack;
    private Stack<DocumentCommand> redoStack;
    private int maxHistorySize;
    
    public CommandHistory(int maxHistorySize) {
        this.undoStack = new Stack<>();
        this.redoStack = new Stack<>();
        this.maxHistorySize = maxHistorySize;
    }
    
    public void executeCommand(DocumentCommand command) {
        command.execute();
        undoStack.push(command);
        redoStack.clear(); // 执行新命令后清空重做栈
        
        // 限制历史记录大小
        if (undoStack.size() > maxHistorySize) {
            undoStack.remove(0);
        }
        
        System.out.println("命令已执行: " + command.getDescription());
    }
    
    public void undo() {
        if (!undoStack.isEmpty()) {
            DocumentCommand command = undoStack.pop();
            command.undo();
            redoStack.push(command);
            System.out.println("已撤销: " + command.getDescription());
        } else {
            System.out.println("没有可撤销的操作");
        }
    }
    
    public void redo() {
        if (!redoStack.isEmpty()) {
            DocumentCommand command = redoStack.pop();
            command.execute();
            undoStack.push(command);
            System.out.println("已重做: " + command.getDescription());
        } else {
            System.out.println("没有可重做的操作");
        }
    }
    
    public void printHistory() {
        System.out.println("\n=== 命令历史 ===");
        System.out.println("撤销栈 (共 " + undoStack.size() + " 个命令):");
        for (int i = undoStack.size() - 1; i >= 0; i--) {
            DocumentCommand cmd = undoStack.get(i);
            System.out.println("  " + (i + 1) + ". " + cmd.getDescription());
        }
        
        System.out.println("重做栈 (共 " + redoStack.size() + " 个命令):");
        for (int i = redoStack.size() - 1; i >= 0; i--) {
            DocumentCommand cmd = redoStack.get(i);
            System.out.println("  " + (i + 1) + ". " + cmd.getDescription());
        }
    }
    
    public boolean canUndo() {
        return !undoStack.isEmpty();
    }
    
    public boolean canRedo() {
        return !redoStack.isEmpty();
    }
}

// 文档编辑器
class DocumentEditor {
    private Document document;
    private CommandHistory history;
    
    public DocumentEditor(String filename) {
        this.document = new Document(filename);
        this.history = new CommandHistory(50); // 最多保存50个命令
    }
    
    public void insertText(int position, String text) {
        DocumentCommand command = new InsertTextCommand(document, position, text);
        history.executeCommand(command);
    }
    
    public void deleteText(int position, int length) {
        DocumentCommand command = new DeleteTextCommand(document, position, length);
        history.executeCommand(command);
    }
    
    public void replaceText(int position, int length, String newText) {
        DocumentCommand command = new ReplaceTextCommand(document, position, length, newText);
        history.executeCommand(command);
    }
    
    public void save() {
        DocumentCommand command = new SaveDocumentCommand(document);
        history.executeCommand(command);
    }
    
    public void executeMacro(MacroCommand macro) {
        history.executeCommand(macro);
    }
    
    public void undo() {
        history.undo();
    }
    
    public void redo() {
        history.redo();
    }
    
    public void printDocument() {
        System.out.println("\n=== 文档内容 ===");
        System.out.println("文件名: " + document.getFilename());
        System.out.println("内容: \"" + document.getContent() + "\"");
        System.out.println("长度: " + document.getLength() + " 字符");
    }
    
    public void printHistory() {
        history.printHistory();
    }
    
    public Document getDocument() {
        return document;
    }
}

// 企业级文档编辑器演示
public class EnterpriseDocumentEditorDemo {
    public static void main(String[] args) {
        DocumentEditor editor = new DocumentEditor("企业报告.docx");
        
        System.out.println("=== 企业级文档编辑器演示 ===\n");
        
        // 基本编辑操作
        editor.insertText(0, "企业年度报告");
        editor.printDocument();
        
        editor.insertText(6, "\n\n第一章：概述\n");
        editor.insertText(editor.getDocument().getLength(), "本章介绍企业基本情况。");
        editor.printDocument();
        
        // 创建宏命令 - 添加新章节
        MacroCommand addChapterMacro = new MacroCommand("添加第二章");
        addChapterMacro.addCommand(new InsertTextCommand(editor.getDocument(), 
                                  editor.getDocument().getLength(), "\n\n第二章：财务状况\n"));
        addChapterMacro.addCommand(new InsertTextCommand(editor.getDocument(), 
                                  editor.getDocument().getLength(), "本章分析企业财务数据。"));
        addChapterMacro.addCommand(new InsertTextCommand(editor.getDocument(), 
                                  editor.getDocument().getLength(), "\n\n详细的财务分析如下："));
        
        System.out.println("\n执行宏命令:");
        editor.executeMacro(addChapterMacro);
        editor.printDocument();
        
        // 文本替换
        System.out.println("\n替换文本:");
        editor.replaceText(0, 6, "2023年度企业");
        editor.printDocument();
        
        // 撤销和重做操作
        System.out.println("\n=== 撤销重做测试 ===");
        editor.printHistory();
        
        System.out.println("\n撤销最后一个操作:");
        editor.undo();
        editor.printDocument();
        
        System.out.println("\n撤销宏命令:");
        editor.undo();
        editor.printDocument();
        
        System.out.println("\n重做宏命令:");
        editor.redo();
        editor.printDocument();
        
        // 保存文档
        System.out.println("\n保存文档:");
        editor.save();
        
        editor.printHistory();
        
        System.out.println("\n=== 命令模式优势 ===");
        System.out.println("- 解耦: 调用者和接收者完全解耦");
        System.out.println("- 可撤销: 支持撤销和重做操作");
        System.out.println("- 可组合: 支持宏命令和批处理");
        System.out.println("- 可记录: 支持命令日志和历史记录");
        System.out.println("- 可排队: 支持命令队列和延迟执行");
    }
}
```

**模式优势**
- **解耦合**：调用者和接收者之间没有直接依赖关系
- **可撤销**：支持撤销和重做操作
- **可扩展**：容易添加新的命令类型
- **可组合**：可以将简单命令组合成复杂的宏命令
- **可记录**：支持日志记录和事务处理

**适用场景**
- 需要将请求调用者和请求接收者解耦的场合
- 需要支持撤销操作的场合
- 需要支持事务处理的场合
- 需要将请求排队、记录日志或支持批处理的场合

#### 核心概念
- **命令**：将请求封装成对象
- **接收者**：执行命令的对象
- **调用者**：发出命令的对象
- **命令队列**：存储命令的队列

#### 参与者概念
- **命令接口**：定义执行命令的接口
- **具体命令**：实现命令接口的具体类
- **接收者**：知道如何实施与执行请求相关的操作
- **调用者**：要求命令执行请求

#### 高级概念
- **宏命令**：组合多个命令的复合命令
- **撤销操作**：支持命令的撤销和重做
- **命令日志**：记录命令执行历史

### 3. 解释器模式 (Interpreter)

**定义**：给定一个语言，定义它的文法的一种表示，并定义一个解释器，这个解释器使用该表示来解释语言中的句子。

**GoF原定义**："Given a language, define a representation for its grammar along with an interpreter that uses the representation to interpret sentences in the language."

**核心思想**
- 为特定类型的问题构建一个简单的语言解释器
- 将每个语法规则表示为一个类
- 使用组合模式构建抽象语法树
- 通过递归调用解释方法来执行解释

**基础例子：简单数学表达式解释器**

```java
// 抽象表达式
abstract class Expression {
    public abstract int interpret();
}

// 终结符表达式 - 数字
class NumberExpression extends Expression {
    private int number;
    
    public NumberExpression(int number) {
        this.number = number;
    }
    
    @Override
    public int interpret() {
        return number;
    }
    
    @Override
    public String toString() {
        return String.valueOf(number);
    }
}

// 非终结符表达式 - 加法
class AddExpression extends Expression {
    private Expression left;
    private Expression right;
    
    public AddExpression(Expression left, Expression right) {
        this.left = left;
        this.right = right;
    }
    
    @Override
    public int interpret() {
        return left.interpret() + right.interpret();
    }
    
    @Override
    public String toString() {
        return "(" + left + " + " + right + ")";
    }
}

// 非终结符表达式 - 减法
class SubtractExpression extends Expression {
    private Expression left;
    private Expression right;
    
    public SubtractExpression(Expression left, Expression right) {
        this.left = left;
        this.right = right;
    }
    
    @Override
    public int interpret() {
        return left.interpret() - right.interpret();
    }
    
    @Override
    public String toString() {
        return "(" + left + " - " + right + ")";
    }
}

// 非终结符表达式 - 乘法
class MultiplyExpression extends Expression {
    private Expression left;
    private Expression right;
    
    public MultiplyExpression(Expression left, Expression right) {
        this.left = left;
        this.right = right;
    }
    
    @Override
    public int interpret() {
        return left.interpret() * right.interpret();
    }
    
    @Override
    public String toString() {
        return "(" + left + " * " + right + ")";
    }
}

// 表达式解析器
class ExpressionParser {
    public Expression parse(String expression) {
        // 简化的解析逻辑，实际应用中需要更复杂的词法和语法分析
        String[] tokens = expression.split(" ");
        return parseTokens(tokens, 0).expression;
    }
    
    private ParseResult parseTokens(String[] tokens, int index) {
        if (index >= tokens.length) {
            throw new IllegalArgumentException("意外的表达式结束");
        }
        
        String token = tokens[index];
        
        // 解析数字
        if (isNumber(token)) {
            return new ParseResult(new NumberExpression(Integer.parseInt(token)), index + 1);
        }
        
        // 解析括号表达式
        if (token.equals("(")) {
            ParseResult leftResult = parseTokens(tokens, index + 1);
            
            if (leftResult.nextIndex >= tokens.length) {
                throw new IllegalArgumentException("缺少操作符");
            }
            
            String operator = tokens[leftResult.nextIndex];
            ParseResult rightResult = parseTokens(tokens, leftResult.nextIndex + 1);
            
            if (rightResult.nextIndex >= tokens.length || !tokens[rightResult.nextIndex].equals(")")) {
                throw new IllegalArgumentException("缺少右括号");
            }
            
            Expression result;
            switch (operator) {
                case "+":
                    result = new AddExpression(leftResult.expression, rightResult.expression);
                    break;
                case "-":
                    result = new SubtractExpression(leftResult.expression, rightResult.expression);
                    break;
                case "*":
                    result = new MultiplyExpression(leftResult.expression, rightResult.expression);
                    break;
                default:
                    throw new IllegalArgumentException("未知操作符: " + operator);
            }
            
            return new ParseResult(result, rightResult.nextIndex + 1);
        }
        
        throw new IllegalArgumentException("无法解析的标记: " + token);
    }
    
    private boolean isNumber(String token) {
        try {
            Integer.parseInt(token);
            return true;
        } catch (NumberFormatException e) {
            return false;
        }
    }
    
    private static class ParseResult {
        Expression expression;
        int nextIndex;
        
        ParseResult(Expression expression, int nextIndex) {
            this.expression = expression;
            this.nextIndex = nextIndex;
        }
    }
}

// 客户端使用
public class MathExpressionDemo {
    public static void main(String[] args) {
        ExpressionParser parser = new ExpressionParser();
        
        System.out.println("=== 简单数学表达式解释器演示 ===\n");
        
        // 测试表达式
        String[] expressions = {
            "( 3 + 5 )",
            "( 10 - 4 )",
            "( 6 * 7 )",
            "( ( 2 + 3 ) * 4 )",
            "( 10 - ( 3 + 2 ) )"
        };
        
        for (String expr : expressions) {
            try {
                Expression expression = parser.parse(expr);
                int result = expression.interpret();
                System.out.println("表达式: " + expr);
                System.out.println("解析为: " + expression);
                System.out.println("结果: " + result);
                System.out.println();
            } catch (Exception e) {
                System.out.println("解析错误: " + expr + " - " + e.getMessage());
            }
        }
    }
}
```

**进阶例子：企业级规则引擎解释器**

```java
// 上下文环境
class Context {
    private Map<String, Object> variables = new HashMap<>();
    
    public void setVariable(String name, Object value) {
        variables.put(name, value);
    }
    
    public Object getVariable(String name) {
        return variables.get(name);
    }
    
    public boolean hasVariable(String name) {
        return variables.containsKey(name);
    }
    
    public void printVariables() {
        System.out.println("上下文变量:");
        variables.forEach((key, value) -> 
            System.out.println("  " + key + " = " + value));
    }
}

// 抽象规则表达式
abstract class RuleExpression {
    public abstract boolean evaluate(Context context);
    public abstract String toString();
}

// 变量表达式
class VariableExpression extends RuleExpression {
    private String variableName;
    
    public VariableExpression(String variableName) {
        this.variableName = variableName;
    }
    
    @Override
    public boolean evaluate(Context context) {
        Object value = context.getVariable(variableName);
        if (value instanceof Boolean) {
            return (Boolean) value;
        }
        return value != null;
    }
    
    @Override
    public String toString() {
        return variableName;
    }
}

// 常量表达式
class ConstantExpression extends RuleExpression {
    private boolean value;
    
    public ConstantExpression(boolean value) {
        this.value = value;
    }
    
    @Override
    public boolean evaluate(Context context) {
        return value;
    }
    
    @Override
    public String toString() {
        return String.valueOf(value);
    }
}

// 比较表达式
class ComparisonExpression extends RuleExpression {
    private String variableName;
    private String operator;
    private Object expectedValue;
    
    public ComparisonExpression(String variableName, String operator, Object expectedValue) {
        this.variableName = variableName;
        this.operator = operator;
        this.expectedValue = expectedValue;
    }
    
    @Override
    public boolean evaluate(Context context) {
        Object actualValue = context.getVariable(variableName);
        if (actualValue == null) {
            return false;
        }
        
        switch (operator) {
            case "==":
                return actualValue.equals(expectedValue);
            case "!=":
                return !actualValue.equals(expectedValue);
            case ">":
                return compareNumbers(actualValue, expectedValue) > 0;
            case "<":
                return compareNumbers(actualValue, expectedValue) < 0;
            case ">=":
                return compareNumbers(actualValue, expectedValue) >= 0;
            case "<=":
                return compareNumbers(actualValue, expectedValue) <= 0;
            case "contains":
                return actualValue.toString().contains(expectedValue.toString());
            default:
                throw new IllegalArgumentException("不支持的操作符: " + operator);
        }
    }
    
    private int compareNumbers(Object actual, Object expected) {
        if (actual instanceof Number && expected instanceof Number) {
            double actualNum = ((Number) actual).doubleValue();
            double expectedNum = ((Number) expected).doubleValue();
            return Double.compare(actualNum, expectedNum);
        }
        throw new IllegalArgumentException("无法比较非数字类型");
    }
    
    @Override
    public String toString() {
        return variableName + " " + operator + " " + expectedValue;
    }
}

// AND表达式
class AndExpression extends RuleExpression {
    private RuleExpression left;
    private RuleExpression right;
    
    public AndExpression(RuleExpression left, RuleExpression right) {
        this.left = left;
        this.right = right;
    }
    
    @Override
    public boolean evaluate(Context context) {
        return left.evaluate(context) && right.evaluate(context);
    }
    
    @Override
    public String toString() {
        return "(" + left + " AND " + right + ")";
    }
}

// OR表达式
class OrExpression extends RuleExpression {
    private RuleExpression left;
    private RuleExpression right;
    
    public OrExpression(RuleExpression left, RuleExpression right) {
        this.left = left;
        this.right = right;
    }
    
    @Override
    public boolean evaluate(Context context) {
        return left.evaluate(context) || right.evaluate(context);
    }
    
    @Override
    public String toString() {
        return "(" + left + " OR " + right + ")";
    }
}

// NOT表达式
class NotExpression extends RuleExpression {
    private RuleExpression expression;
    
    public NotExpression(RuleExpression expression) {
        this.expression = expression;
    }
    
    @Override
    public boolean evaluate(Context context) {
        return !expression.evaluate(context);
    }
    
    @Override
    public String toString() {
        return "NOT(" + expression + ")";
    }
}

// 业务规则
class BusinessRule {
    private String name;
    private RuleExpression condition;
    private String action;
    private int priority;
    
    public BusinessRule(String name, RuleExpression condition, String action, int priority) {
        this.name = name;
        this.condition = condition;
        this.action = action;
        this.priority = priority;
    }
    
    public boolean evaluate(Context context) {
        return condition.evaluate(context);
    }
    
    public void execute() {
        System.out.println("执行规则: " + name + " -> " + action);
    }
    
    // Getters
    public String getName() { return name; }
    public String getAction() { return action; }
    public int getPriority() { return priority; }
    
    @Override
    public String toString() {
        return "规则[" + name + "]: IF " + condition + " THEN " + action + " (优先级:" + priority + ")";
    }
}

// 规则引擎
class RuleEngine {
    private List<BusinessRule> rules = new ArrayList<>();
    
    public void addRule(BusinessRule rule) {
        rules.add(rule);
        // 按优先级排序（优先级高的先执行）
        rules.sort((r1, r2) -> Integer.compare(r2.getPriority(), r1.getPriority()));
    }
    
    public void executeRules(Context context) {
        System.out.println("=== 规则引擎执行 ===");
        context.printVariables();
        System.out.println();
        
        List<BusinessRule> firedRules = new ArrayList<>();
        
        for (BusinessRule rule : rules) {
            System.out.println("评估规则: " + rule.getName());
            System.out.println("条件: " + rule.toString());
            
            if (rule.evaluate(context)) {
                System.out.println("✓ 规则匹配，执行动作");
                rule.execute();
                firedRules.add(rule);
            } else {
                System.out.println("✗ 规则不匹配");
            }
            System.out.println();
        }
        
        System.out.println("总共触发了 " + firedRules.size() + " 个规则");
    }
    
    public void printAllRules() {
        System.out.println("=== 所有业务规则 ===");
        for (int i = 0; i < rules.size(); i++) {
            System.out.println((i + 1) + ". " + rules.get(i));
        }
    }
}

// 规则构建器
class RuleBuilder {
    public static BusinessRule createCustomerDiscountRule() {
        // 规则: 如果客户是VIP且订单金额>1000，则给予10%折扣
        RuleExpression vipCondition = new ComparisonExpression("customerType", "==", "VIP");
        RuleExpression amountCondition = new ComparisonExpression("orderAmount", ">", 1000.0);
        RuleExpression condition = new AndExpression(vipCondition, amountCondition);
        
        return new BusinessRule("VIP客户折扣规则", condition, "给予10%折扣", 10);
    }
    
    public static BusinessRule createFreeShippingRule() {
        // 规则: 如果订单金额>500或客户是VIP，则免费配送
        RuleExpression amountCondition = new ComparisonExpression("orderAmount", ">", 500.0);
        RuleExpression vipCondition = new ComparisonExpression("customerType", "==", "VIP");
        RuleExpression condition = new OrExpression(amountCondition, vipCondition);
        
        return new BusinessRule("免费配送规则", condition, "免费配送", 8);
    }
    
    public static BusinessRule createLowStockAlertRule() {
        // 规则: 如果库存<10且不是预订商品，则发送库存警告
        RuleExpression stockCondition = new ComparisonExpression("stock", "<", 10);
        RuleExpression preorderCondition = new ComparisonExpression("isPreorder", "==", false);
        RuleExpression condition = new AndExpression(stockCondition, preorderCondition);
        
        return new BusinessRule("低库存警告规则", condition, "发送库存警告邮件", 15);
    }
    
    public static BusinessRule createNewCustomerWelcomeRule() {
        // 规则: 如果是新客户且不是企业客户，则发送欢迎邮件
        RuleExpression newCustomerCondition = new ComparisonExpression("isNewCustomer", "==", true);
        RuleExpression enterpriseCondition = new ComparisonExpression("customerType", "!=", "Enterprise");
        RuleExpression condition = new AndExpression(newCustomerCondition, enterpriseCondition);
        
        return new BusinessRule("新客户欢迎规则", condition, "发送欢迎邮件和优惠券", 5);
    }
}

// 企业级规则引擎演示
public class EnterpriseRuleEngineDemo {
    public static void main(String[] args) {
        // 创建规则引擎
        RuleEngine ruleEngine = new RuleEngine();
        
        // 添加业务规则
        ruleEngine.addRule(RuleBuilder.createCustomerDiscountRule());
        ruleEngine.addRule(RuleBuilder.createFreeShippingRule());
        ruleEngine.addRule(RuleBuilder.createLowStockAlertRule());
        ruleEngine.addRule(RuleBuilder.createNewCustomerWelcomeRule());
        
        System.out.println("=== 企业级规则引擎演示 ===\n");
        ruleEngine.printAllRules();
        System.out.println();
        
        // 测试场景1: VIP客户大额订单
        System.out.println("场景1: VIP客户大额订单");
        Context context1 = new Context();
        context1.setVariable("customerType", "VIP");
        context1.setVariable("orderAmount", 1500.0);
        context1.setVariable("stock", 50);
        context1.setVariable("isPreorder", false);
        context1.setVariable("isNewCustomer", false);
        
        ruleEngine.executeRules(context1);
        
        // 测试场景2: 新普通客户小额订单
        System.out.println("\n" + "=".repeat(50));
        System.out.println("场景2: 新普通客户小额订单");
        Context context2 = new Context();
        context2.setVariable("customerType", "Regular");
        context2.setVariable("orderAmount", 300.0);
        context2.setVariable("stock", 5);
        context2.setVariable("isPreorder", false);
        context2.setVariable("isNewCustomer", true);
        
        ruleEngine.executeRules(context2);
        
        // 测试场景3: 企业客户预订商品
        System.out.println("\n" + "=".repeat(50));
        System.out.println("场景3: 企业客户预订商品");
        Context context3 = new Context();
        context3.setVariable("customerType", "Enterprise");
        context3.setVariable("orderAmount", 800.0);
        context3.setVariable("stock", 3);
        context3.setVariable("isPreorder", true);
        context3.setVariable("isNewCustomer", true);
        
        ruleEngine.executeRules(context3);
        
        System.out.println("\n=== 解释器模式优势 ===");
        System.out.println("- 易于扩展: 容易添加新的语法规则");
        System.out.println("- 易于实现: 每个语法规则对应一个类");
        System.out.println("- 灵活性: 可以动态组合复杂的规则");
        System.out.println("- 可维护: 规则逻辑清晰分离");
    }
}
```

**模式优势**
- **易于扩展**：容易添加新的语法规则和表达式类型
- **易于实现**：每个语法规则对应一个类，实现简单
- **灵活组合**：可以通过组合模式构建复杂的表达式
- **职责分离**：语法分析和解释执行分离

**适用场景**
- 需要解释执行特定语言或表达式的场合
- 语法相对简单且稳定的领域特定语言
- 需要构建规则引擎或配置解析器
- 需要支持动态表达式计算的系统

**注意事项**
- 复杂语法会导致类层次结构庞大
- 性能可能不如直接编程实现
- 适合语法简单的场景，复杂语法建议使用专门的解析器生成工具

#### 核心概念
- **解释器**：为语言定义文法表示，并定义解释器解释语言中的句子
- **抽象语法树**：表示语言语法结构的树
- **文法规则**：定义语言的语法规则
- **上下文**：包含解释器之外的全局信息

#### 参与者概念
- **抽象表达式**：声明抽象的解释操作
- **终结符表达式**：实现文法中终结符相关的解释操作
- **非终结符表达式**：实现文法中非终结符相关的解释操作
- **环境**：包含解释器之外的全局信息

### 4. 迭代器模式 (Iterator)

**定义**：提供一种方法顺序访问一个聚合对象中各个元素，而又不需暴露该对象的内部表示。

**GoF原定义**："Provide a way to access the elements of an aggregate object sequentially without exposing its underlying representation."

**核心思想**
- 将遍历算法从聚合对象中分离出来
- 提供统一的遍历接口，隐藏内部实现细节
- 支持多种遍历方式和并发遍历
- 简化聚合对象的接口

**基础例子：书籍集合迭代器**

```java
// 迭代器接口
interface Iterator<T> {
    boolean hasNext();
    T next();
    void remove();
}

// 聚合接口
interface Aggregate<T> {
    Iterator<T> createIterator();
}

// 书籍类
class Book {
    private String title;
    private String author;
    private String isbn;
    
    public Book(String title, String author, String isbn) {
        this.title = title;
        this.author = author;
        this.isbn = isbn;
    }
    
    // Getters
    public String getTitle() { return title; }
    public String getAuthor() { return author; }
    public String getIsbn() { return isbn; }
    
    @Override
    public String toString() {
        return "《" + title + "》 - " + author + " (ISBN: " + isbn + ")";
    }
}

// 书籍集合
class BookCollection implements Aggregate<Book> {
    private List<Book> books;
    
    public BookCollection() {
        this.books = new ArrayList<>();
    }
    
    public void addBook(Book book) {
        books.add(book);
    }
    
    public void removeBook(Book book) {
        books.remove(book);
    }
    
    public int size() {
        return books.size();
    }
    
    @Override
    public Iterator<Book> createIterator() {
        return new BookIterator();
    }
    
    // 内部迭代器实现
    private class BookIterator implements Iterator<Book> {
        private int currentIndex = 0;
        
        @Override
        public boolean hasNext() {
            return currentIndex < books.size();
        }
        
        @Override
        public Book next() {
            if (!hasNext()) {
                throw new NoSuchElementException("没有更多书籍");
            }
            return books.get(currentIndex++);
        }
        
        @Override
        public void remove() {
            if (currentIndex <= 0) {
                throw new IllegalStateException("无法删除，请先调用next()");
            }
            books.remove(--currentIndex);
        }
    }
}

// 客户端使用
public class BookCollectionDemo {
    public static void main(String[] args) {
        // 创建书籍集合
        BookCollection library = new BookCollection();
        library.addBook(new Book("设计模式", "GoF", "978-0201633610"));
        library.addBook(new Book("重构", "Martin Fowler", "978-0201485677"));
        library.addBook(new Book("代码大全", "Steve McConnell", "978-0735619678"));
        library.addBook(new Book("程序员修炼之道", "Andrew Hunt", "978-0201616224"));
        
        System.out.println("=== 书籍集合迭代器演示 ===\n");
        System.out.println("图书馆共有 " + library.size() + " 本书:\n");
        
        // 使用迭代器遍历
        Iterator<Book> iterator = library.createIterator();
        int index = 1;
        while (iterator.hasNext()) {
            Book book = iterator.next();
            System.out.println(index++ + ". " + book);
        }
        
        System.out.println("\n删除第2本书后:");
        iterator = library.createIterator();
        iterator.next(); // 跳过第一本
        iterator.next(); // 到第二本
        iterator.remove(); // 删除第二本
        
        iterator = library.createIterator();
        index = 1;
        while (iterator.hasNext()) {
            Book book = iterator.next();
            System.out.println(index++ + ". " + book);
        }
    }
}
```

**进阶例子：企业级数据访问迭代器系统**

```java
// 通用迭代器接口
interface DataIterator<T> {
    boolean hasNext();
    T next();
    void remove();
    void reset();
    int getCurrentPosition();
    int getTotalCount();
}

// 员工实体类
class Employee {
    private int id;
    private String name;
    private String department;
    private double salary;
    private Date hireDate;
    
    public Employee(int id, String name, String department, double salary, Date hireDate) {
        this.id = id;
        this.name = name;
        this.department = department;
        this.salary = salary;
        this.hireDate = hireDate;
    }
    
    // Getters
    public int getId() { return id; }
    public String getName() { return name; }
    public String getDepartment() { return department; }
    public double getSalary() { return salary; }
    public Date getHireDate() { return hireDate; }
    
    @Override
    public String toString() {
        return String.format("Employee[%d] %s - %s (薪资: %.2f)", 
                           id, name, department, salary);
    }
}

// 抽象数据源
abstract class DataSource<T> {
    public abstract DataIterator<T> createIterator();
    public abstract DataIterator<T> createIterator(String filterCriteria);
    public abstract int getTotalCount();
}

// 内存数据源
class MemoryDataSource extends DataSource<Employee> {
    private List<Employee> employees;
    
    public MemoryDataSource() {
        this.employees = new ArrayList<>();
        initializeData();
    }
    
    private void initializeData() {
        employees.add(new Employee(1, "张三", "技术部", 8000, new Date()));
        employees.add(new Employee(2, "李四", "销售部", 6000, new Date()));
        employees.add(new Employee(3, "王五", "技术部", 9000, new Date()));
        employees.add(new Employee(4, "赵六", "人事部", 5500, new Date()));
        employees.add(new Employee(5, "钱七", "技术部", 7500, new Date()));
        employees.add(new Employee(6, "孙八", "销售部", 6500, new Date()));
    }
    
    @Override
    public DataIterator<Employee> createIterator() {
        return new MemoryIterator(employees);
    }
    
    @Override
    public DataIterator<Employee> createIterator(String filterCriteria) {
        List<Employee> filteredEmployees = employees.stream()
            .filter(emp -> emp.getDepartment().contains(filterCriteria) || 
                          emp.getName().contains(filterCriteria))
            .collect(Collectors.toList());
        return new MemoryIterator(filteredEmployees);
    }
    
    @Override
    public int getTotalCount() {
        return employees.size();
    }
    
    // 内存迭代器实现
    private class MemoryIterator implements DataIterator<Employee> {
        private List<Employee> data;
        private int currentIndex = 0;
        
        public MemoryIterator(List<Employee> data) {
            this.data = new ArrayList<>(data); // 创建副本避免并发修改
        }
        
        @Override
        public boolean hasNext() {
            return currentIndex < data.size();
        }
        
        @Override
        public Employee next() {
            if (!hasNext()) {
                throw new NoSuchElementException("没有更多数据");
            }
            return data.get(currentIndex++);
        }
        
        @Override
        public void remove() {
            if (currentIndex <= 0) {
                throw new IllegalStateException("无法删除，请先调用next()");
            }
            data.remove(--currentIndex);
        }
        
        @Override
        public void reset() {
            currentIndex = 0;
        }
        
        @Override
        public int getCurrentPosition() {
            return currentIndex;
        }
        
        @Override
        public int getTotalCount() {
            return data.size();
        }
    }
}

// 数据库数据源（模拟）
class DatabaseDataSource extends DataSource<Employee> {
    private int pageSize = 2; // 每页2条记录，模拟分页
    private List<Employee> allData; // 模拟数据库中的所有数据
    
    public DatabaseDataSource() {
        // 模拟数据库中的大量数据
        this.allData = new ArrayList<>();
        for (int i = 1; i <= 10; i++) {
            allData.add(new Employee(i, "员工" + i, 
                       i % 3 == 0 ? "技术部" : (i % 2 == 0 ? "销售部" : "人事部"), 
                       5000 + i * 500, new Date()));
        }
    }
    
    @Override
    public DataIterator<Employee> createIterator() {
        return new DatabaseIterator(null);
    }
    
    @Override
    public DataIterator<Employee> createIterator(String filterCriteria) {
        return new DatabaseIterator(filterCriteria);
    }
    
    @Override
    public int getTotalCount() {
        return allData.size();
    }
    
    // 模拟数据库查询
    private List<Employee> queryDatabase(int offset, int limit, String filter) {
        System.out.println("执行数据库查询: OFFSET=" + offset + ", LIMIT=" + limit + 
                          (filter != null ? ", FILTER=" + filter : ""));
        
        // 模拟网络延迟
        try {
            Thread.sleep(100);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
        
        Stream<Employee> stream = allData.stream();
        if (filter != null) {
            stream = stream.filter(emp -> emp.getDepartment().contains(filter) || 
                                         emp.getName().contains(filter));
        }
        
        return stream.skip(offset).limit(limit).collect(Collectors.toList());
    }
    
    // 数据库迭代器实现（支持懒加载）
    private class DatabaseIterator implements DataIterator<Employee> {
        private String filterCriteria;
        private List<Employee> currentPage;
        private int currentPageIndex = 0;
        private int currentItemIndex = 0;
        private int totalProcessed = 0;
        private boolean hasMorePages = true;
        
        public DatabaseIterator(String filterCriteria) {
            this.filterCriteria = filterCriteria;
            loadNextPage();
        }
        
        private void loadNextPage() {
            if (!hasMorePages) return;
            
            currentPage = queryDatabase(currentPageIndex * pageSize, pageSize, filterCriteria);
            currentItemIndex = 0;
            
            if (currentPage.size() < pageSize) {
                hasMorePages = false;
            }
            currentPageIndex++;
        }
        
        @Override
        public boolean hasNext() {
            if (currentPage == null || currentPage.isEmpty()) {
                return false;
            }
            
            if (currentItemIndex >= currentPage.size()) {
                if (hasMorePages) {
                    loadNextPage();
                    return hasNext();
                }
                return false;
            }
            
            return true;
        }
        
        @Override
        public Employee next() {
            if (!hasNext()) {
                throw new NoSuchElementException("没有更多数据");
            }
            
            Employee employee = currentPage.get(currentItemIndex++);
            totalProcessed++;
            return employee;
        }
        
        @Override
        public void remove() {
            throw new UnsupportedOperationException("数据库迭代器不支持删除操作");
        }
        
        @Override
        public void reset() {
            currentPageIndex = 0;
            currentItemIndex = 0;
            totalProcessed = 0;
            hasMorePages = true;
            loadNextPage();
        }
        
        @Override
        public int getCurrentPosition() {
            return totalProcessed;
        }
        
        @Override
        public int getTotalCount() {
            // 在实际应用中，这里会执行COUNT查询
            return (int) allData.stream()
                .filter(emp -> filterCriteria == null || 
                              emp.getDepartment().contains(filterCriteria) || 
                              emp.getName().contains(filterCriteria))
                .count();
        }
    }
}

// 组合迭代器 - 可以组合多个数据源
class CompositeDataIterator implements DataIterator<Employee> {
    private List<DataIterator<Employee>> iterators;
    private int currentIteratorIndex = 0;
    private int totalProcessed = 0;
    
    public CompositeDataIterator(List<DataIterator<Employee>> iterators) {
        this.iterators = new ArrayList<>(iterators);
    }
    
    @Override
    public boolean hasNext() {
        while (currentIteratorIndex < iterators.size()) {
            if (iterators.get(currentIteratorIndex).hasNext()) {
                return true;
            }
            currentIteratorIndex++;
        }
        return false;
    }
    
    @Override
    public Employee next() {
        if (!hasNext()) {
            throw new NoSuchElementException("没有更多数据");
        }
        
        Employee employee = iterators.get(currentIteratorIndex).next();
        totalProcessed++;
        return employee;
    }
    
    @Override
    public void remove() {
        if (currentIteratorIndex >= iterators.size()) {
            throw new IllegalStateException("无法删除");
        }
        iterators.get(currentIteratorIndex).remove();
    }
    
    @Override
    public void reset() {
        currentIteratorIndex = 0;
        totalProcessed = 0;
        for (DataIterator<Employee> iterator : iterators) {
            iterator.reset();
        }
    }
    
    @Override
    public int getCurrentPosition() {
        return totalProcessed;
    }
    
    @Override
    public int getTotalCount() {
        return iterators.stream()
            .mapToInt(DataIterator::getTotalCount)
            .sum();
    }
}

// 数据处理器
class DataProcessor {
    public void processData(DataIterator<Employee> iterator, String description) {
        System.out.println("=== " + description + " ===");
        System.out.println("总记录数: " + iterator.getTotalCount());
        
        int count = 0;
        long startTime = System.currentTimeMillis();
        
        while (iterator.hasNext()) {
            Employee employee = iterator.next();
            count++;
            System.out.println(count + ". " + employee);
            
            // 模拟处理时间
            try {
                Thread.sleep(50);
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                break;
            }
        }
        
        long endTime = System.currentTimeMillis();
        System.out.println("处理完成: 共处理 " + count + " 条记录，耗时 " + (endTime - startTime) + "ms");
        System.out.println();
    }
}

// 企业级数据访问演示
public class EnterpriseDataAccessDemo {
    public static void main(String[] args) {
        System.out.println("=== 企业级数据访问迭代器系统演示 ===\n");
        
        DataProcessor processor = new DataProcessor();
        
        // 1. 内存数据源迭代
        System.out.println("1. 内存数据源迭代:");
        MemoryDataSource memorySource = new MemoryDataSource();
        DataIterator<Employee> memoryIterator = memorySource.createIterator();
        processor.processData(memoryIterator, "内存数据源 - 所有员工");
        
        // 2. 内存数据源过滤迭代
        System.out.println("2. 内存数据源过滤迭代:");
        DataIterator<Employee> filteredMemoryIterator = memorySource.createIterator("技术部");
        processor.processData(filteredMemoryIterator, "内存数据源 - 技术部员工");
        
        // 3. 数据库数据源迭代（分页加载）
        System.out.println("3. 数据库数据源迭代（分页加载）:");
        DatabaseDataSource dbSource = new DatabaseDataSource();
        DataIterator<Employee> dbIterator = dbSource.createIterator();
        processor.processData(dbIterator, "数据库数据源 - 分页加载");
        
        // 4. 数据库数据源过滤迭代
        System.out.println("4. 数据库数据源过滤迭代:");
        DataIterator<Employee> filteredDbIterator = dbSource.createIterator("技术部");
        processor.processData(filteredDbIterator, "数据库数据源 - 技术部员工");
        
        // 5. 组合迭代器 - 合并多个数据源
        System.out.println("5. 组合迭代器 - 合并多个数据源:");
        List<DataIterator<Employee>> iterators = Arrays.asList(
            memorySource.createIterator("销售部"),
            dbSource.createIterator("人事部")
        );
        CompositeDataIterator compositeIterator = new CompositeDataIterator(iterators);
        processor.processData(compositeIterator, "组合数据源 - 销售部+人事部");
        
        System.out.println("=== 迭代器模式优势 ===");
        System.out.println("- 统一接口: 不同数据源提供统一的遍历接口");
        System.out.println("- 懒加载: 支持大数据集的分页和按需加载");
        System.out.println("- 封装性: 隐藏内部数据结构的实现细节");
        System.out.println("- 可组合: 支持多个迭代器的组合使用");
        System.out.println("- 并发安全: 每个迭代器维护独立的遍历状态");
    }
}
```

**模式优势**
- **统一接口**：为不同的聚合结构提供统一的遍历接口
- **封装性**：隐藏聚合对象的内部结构
- **支持多种遍历**：可以同时存在多个迭代器
- **简化聚合接口**：聚合对象不需要提供各种遍历操作

**适用场景**
- 需要访问聚合对象的内容而无需暴露其内部表示
- 需要支持对聚合对象的多种遍历
- 需要为不同的聚合结构提供统一的遍历接口
- 需要支持大数据集的分页或懒加载遍历

#### 核心概念
- **迭代器**：提供顺序访问聚合对象元素的方法
- **聚合对象**：包含多个元素的对象
- **遍历**：按某种顺序访问聚合对象的元素
- **封装遍历**：将遍历算法封装在迭代器中

#### 参与者概念
- **迭代器接口**：定义访问和遍历元素的接口
- **具体迭代器**：实现迭代器接口
- **聚合接口**：定义创建迭代器的接口
- **具体聚合**：实现创建迭代器的接口

#### 实现概念
- **内部迭代器**：由聚合对象控制迭代过程
- **外部迭代器**：由客户端控制迭代过程
- **健壮性迭代器**：在迭代过程中可以安全地修改聚合对象

### 5. 中介者模式 (Mediator)

**定义**：用一个中介对象来封装一系列的对象交互。中介者使各对象不需要显式地相互引用，从而使其耦合松散，而且可以独立地改变它们之间的交互。

**GoF原定义**："Define an object that encapsulates how a set of objects interact. Mediator promotes loose coupling by keeping objects from referring to each other explicitly, and it lets you vary their interaction independently."

**核心思想**
- 将对象间的交互封装在中介者对象中
- 各个对象不直接相互引用，而是通过中介者通信
- 降低对象间的耦合度，提高系统的可维护性
- 集中控制复杂的交互逻辑

**基础例子：聊天室系统**

```java
// 抽象中介者
abstract class ChatMediator {
    public abstract void sendMessage(String message, User user);
    public abstract void addUser(User user);
    public abstract void removeUser(User user);
}

// 抽象用户
abstract class User {
    protected ChatMediator mediator;
    protected String name;
    
    public User(ChatMediator mediator, String name) {
        this.mediator = mediator;
        this.name = name;
    }
    
    public abstract void send(String message);
    public abstract void receive(String message);
    
    public String getName() {
        return name;
    }
}

// 具体中介者 - 聊天室
class ChatRoom extends ChatMediator {
    private List<User> users;
    
    public ChatRoom() {
        this.users = new ArrayList<>();
    }
    
    @Override
    public void sendMessage(String message, User sender) {
        for (User user : users) {
            // 不发送给自己
            if (user != sender) {
                user.receive(message);
            }
        }
    }
    
    @Override
    public void addUser(User user) {
        users.add(user);
        System.out.println(user.getName() + " 加入了聊天室");
        
        // 通知其他用户
        for (User existingUser : users) {
            if (existingUser != user) {
                existingUser.receive("系统消息: " + user.getName() + " 加入了聊天室");
            }
        }
    }
    
    @Override
    public void removeUser(User user) {
        users.remove(user);
        System.out.println(user.getName() + " 离开了聊天室");
        
        // 通知其他用户
        for (User remainingUser : users) {
            remainingUser.receive("系统消息: " + user.getName() + " 离开了聊天室");
        }
    }
    
    public int getUserCount() {
        return users.size();
    }
}

// 具体用户
class ConcreteUser extends User {
    public ConcreteUser(ChatMediator mediator, String name) {
        super(mediator, name);
    }
    
    @Override
    public void send(String message) {
        System.out.println(name + " 发送: " + message);
        mediator.sendMessage(name + ": " + message, this);
    }
    
    @Override
    public void receive(String message) {
        System.out.println(name + " 收到: " + message);
    }
}

// 客户端使用
public class ChatRoomDemo {
    public static void main(String[] args) {
        System.out.println("=== 聊天室系统演示 ===\n");
        
        // 创建聊天室
        ChatRoom chatRoom = new ChatRoom();
        
        // 创建用户
        User alice = new ConcreteUser(chatRoom, "Alice");
        User bob = new ConcreteUser(chatRoom, "Bob");
        User charlie = new ConcreteUser(chatRoom, "Charlie");
        
        // 用户加入聊天室
        chatRoom.addUser(alice);
        System.out.println();
        
        chatRoom.addUser(bob);
        System.out.println();
        
        chatRoom.addUser(charlie);
        System.out.println();
        
        // 用户发送消息
        alice.send("大家好！");
        System.out.println();
        
        bob.send("你好 Alice！");
        System.out.println();
        
        charlie.send("很高兴认识大家！");
        System.out.println();
        
        // 用户离开
        chatRoom.removeUser(bob);
        System.out.println();
        
        alice.send("Bob 走了");
        System.out.println();
    }
}
```

**进阶例子：企业级工作流协调系统**

```java
// 工作流事件类型
enum WorkflowEventType {
    TASK_CREATED, TASK_ASSIGNED, TASK_STARTED, TASK_COMPLETED, 
    TASK_REJECTED, APPROVAL_REQUESTED, APPROVAL_GRANTED, APPROVAL_DENIED
}

// 工作流事件
class WorkflowEvent {
    private WorkflowEventType type;
    private String taskId;
    private String fromComponent;
    private String toComponent;
    private Map<String, Object> data;
    private long timestamp;
    
    public WorkflowEvent(WorkflowEventType type, String taskId, String fromComponent) {
        this.type = type;
        this.taskId = taskId;
        this.fromComponent = fromComponent;
        this.data = new HashMap<>();
        this.timestamp = System.currentTimeMillis();
    }
    
    // Getters and setters
    public WorkflowEventType getType() { return type; }
    public String getTaskId() { return taskId; }
    public String getFromComponent() { return fromComponent; }
    public String getToComponent() { return toComponent; }
    public void setToComponent(String toComponent) { this.toComponent = toComponent; }
    public Map<String, Object> getData() { return data; }
    public long getTimestamp() { return timestamp; }
    
    public void addData(String key, Object value) {
        data.put(key, value);
    }
    
    @Override
    public String toString() {
        return String.format("WorkflowEvent[%s] %s -> %s: %s (Task: %s)", 
                           type, fromComponent, toComponent, data, taskId);
    }
}

// 抽象工作流中介者
abstract class WorkflowMediator {
    public abstract void handleEvent(WorkflowEvent event);
    public abstract void registerComponent(WorkflowComponent component);
    public abstract void unregisterComponent(WorkflowComponent component);
}

// 抽象工作流组件
abstract class WorkflowComponent {
    protected WorkflowMediator mediator;
    protected String componentName;
    protected boolean isActive = true;
    
    public WorkflowComponent(WorkflowMediator mediator, String componentName) {
        this.mediator = mediator;
        this.componentName = componentName;
    }
    
    public abstract void handleEvent(WorkflowEvent event);
    
    protected void sendEvent(WorkflowEventType type, String taskId) {
        if (isActive && mediator != null) {
            WorkflowEvent event = new WorkflowEvent(type, taskId, componentName);
            mediator.handleEvent(event);
        }
    }
    
    protected void sendEvent(WorkflowEventType type, String taskId, String targetComponent, Map<String, Object> data) {
        if (isActive && mediator != null) {
            WorkflowEvent event = new WorkflowEvent(type, taskId, componentName);
            event.setToComponent(targetComponent);
            if (data != null) {
                event.getData().putAll(data);
            }
            mediator.handleEvent(event);
        }
    }
    
    public String getComponentName() { return componentName; }
    public void setActive(boolean active) { this.isActive = active; }
    public boolean isActive() { return isActive; }
}

// 具体中介者 - 工作流引擎
class WorkflowEngine extends WorkflowMediator {
    private Map<String, WorkflowComponent> components;
    private List<WorkflowEvent> eventHistory;
    private Map<String, String> taskAssignments; // taskId -> assignee
    
    public WorkflowEngine() {
        this.components = new HashMap<>();
        this.eventHistory = new ArrayList<>();
        this.taskAssignments = new HashMap<>();
    }
    
    @Override
    public void handleEvent(WorkflowEvent event) {
        // 记录事件历史
        eventHistory.add(event);
        System.out.println("工作流引擎处理事件: " + event);
        
        // 根据事件类型和目标组件路由事件
        if (event.getToComponent() != null) {
            // 定向发送给特定组件
            WorkflowComponent targetComponent = components.get(event.getToComponent());
            if (targetComponent != null && targetComponent.isActive()) {
                targetComponent.handleEvent(event);
            }
        } else {
            // 广播给所有相关组件
            routeEventToComponents(event);
        }
        
        // 执行工作流逻辑
        executeWorkflowLogic(event);
    }
    
    private void routeEventToComponents(WorkflowEvent event) {
        for (WorkflowComponent component : components.values()) {
            if (component.isActive() && !component.getComponentName().equals(event.getFromComponent())) {
                component.handleEvent(event);
            }
        }
    }
    
    private void executeWorkflowLogic(WorkflowEvent event) {
        switch (event.getType()) {
            case TASK_CREATED:
                // 自动分配任务
                autoAssignTask(event);
                break;
            case TASK_COMPLETED:
                // 检查是否需要审批
                checkApprovalRequired(event);
                break;
            case APPROVAL_GRANTED:
                // 任务完成流程
                completeTaskFlow(event);
                break;
            case APPROVAL_DENIED:
                // 任务被拒绝，重新分配
                reassignTask(event);
                break;
        }
    }
    
    private void autoAssignTask(WorkflowEvent event) {
        String taskId = event.getTaskId();
        String assignee = "DefaultAssignee"; // 简化的分配逻辑
        taskAssignments.put(taskId, assignee);
        
        Map<String, Object> assignmentData = new HashMap<>();
        assignmentData.put("assignee", assignee);
        
        WorkflowEvent assignEvent = new WorkflowEvent(WorkflowEventType.TASK_ASSIGNED, taskId, "WorkflowEngine");
        assignEvent.getData().putAll(assignmentData);
        handleEvent(assignEvent);
    }
    
    private void checkApprovalRequired(WorkflowEvent event) {
        // 简化逻辑：所有完成的任务都需要审批
        WorkflowEvent approvalEvent = new WorkflowEvent(WorkflowEventType.APPROVAL_REQUESTED, 
                                                       event.getTaskId(), "WorkflowEngine");
        approvalEvent.setToComponent("ApprovalService");
        handleEvent(approvalEvent);
    }
    
    private void completeTaskFlow(WorkflowEvent event) {
        String taskId = event.getTaskId();
        taskAssignments.remove(taskId);
        System.out.println("任务 " + taskId + " 已完成整个工作流程");
    }
    
    private void reassignTask(WorkflowEvent event) {
        String taskId = event.getTaskId();
        System.out.println("任务 " + taskId + " 被拒绝，重新分配");
        autoAssignTask(event);
    }
    
    @Override
    public void registerComponent(WorkflowComponent component) {
        components.put(component.getComponentName(), component);
        System.out.println("组件已注册: " + component.getComponentName());
    }
    
    @Override
    public void unregisterComponent(WorkflowComponent component) {
        components.remove(component.getComponentName());
        System.out.println("组件已注销: " + component.getComponentName());
    }
    
    public void printEventHistory() {
        System.out.println("\n=== 事件历史 ===");
        for (int i = 0; i < eventHistory.size(); i++) {
            System.out.println((i + 1) + ". " + eventHistory.get(i));
        }
    }
    
    public void printSystemStatus() {
        System.out.println("\n=== 系统状态 ===");
        System.out.println("注册组件数: " + components.size());
        System.out.println("活跃任务数: " + taskAssignments.size());
        System.out.println("事件历史数: " + eventHistory.size());
    }
}

// 任务管理组件
class TaskManager extends WorkflowComponent {
    private Map<String, String> tasks; // taskId -> taskDescription
    
    public TaskManager(WorkflowMediator mediator) {
        super(mediator, "TaskManager");
        this.tasks = new HashMap<>();
    }
    
    public void createTask(String taskId, String description) {
        tasks.put(taskId, description);
        System.out.println("TaskManager: 创建任务 " + taskId + " - " + description);
        
        Map<String, Object> taskData = new HashMap<>();
        taskData.put("description", description);
        sendEvent(WorkflowEventType.TASK_CREATED, taskId, null, taskData);
    }
    
    public void completeTask(String taskId) {
        if (tasks.containsKey(taskId)) {
            System.out.println("TaskManager: 完成任务 " + taskId);
            sendEvent(WorkflowEventType.TASK_COMPLETED, taskId);
        }
    }
    
    @Override
    public void handleEvent(WorkflowEvent event) {
        switch (event.getType()) {
            case TASK_ASSIGNED:
                String assignee = (String) event.getData().get("assignee");
                System.out.println("TaskManager: 任务 " + event.getTaskId() + " 已分配给 " + assignee);
                break;
            case APPROVAL_GRANTED:
                System.out.println("TaskManager: 任务 " + event.getTaskId() + " 审批通过");
                break;
            case APPROVAL_DENIED:
                System.out.println("TaskManager: 任务 " + event.getTaskId() + " 审批被拒绝");
                break;
        }
    }
}

// 通知服务组件
class NotificationService extends WorkflowComponent {
    public NotificationService(WorkflowMediator mediator) {
        super(mediator, "NotificationService");
    }
    
    @Override
    public void handleEvent(WorkflowEvent event) {
        switch (event.getType()) {
            case TASK_CREATED:
                sendNotification("新任务创建: " + event.getTaskId());
                break;
            case TASK_ASSIGNED:
                String assignee = (String) event.getData().get("assignee");
                sendNotification("任务分配通知: " + event.getTaskId() + " -> " + assignee);
                break;
            case TASK_COMPLETED:
                sendNotification("任务完成通知: " + event.getTaskId());
                break;
            case APPROVAL_GRANTED:
                sendNotification("审批通过通知: " + event.getTaskId());
                break;
            case APPROVAL_DENIED:
                sendNotification("审批拒绝通知: " + event.getTaskId());
                break;
        }
    }
    
    private void sendNotification(String message) {
        System.out.println("NotificationService: 发送通知 - " + message);
    }
}

// 审批服务组件
class ApprovalService extends WorkflowComponent {
    private Random random = new Random();
    
    public ApprovalService(WorkflowMediator mediator) {
        super(mediator, "ApprovalService");
    }
    
    @Override
    public void handleEvent(WorkflowEvent event) {
        if (event.getType() == WorkflowEventType.APPROVAL_REQUESTED) {
            processApproval(event.getTaskId());
        }
    }
    
    private void processApproval(String taskId) {
        System.out.println("ApprovalService: 处理审批请求 " + taskId);
        
        // 模拟审批处理时间
        try {
            Thread.sleep(100);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
        
        // 随机审批结果
        boolean approved = random.nextBoolean();
        WorkflowEventType resultType = approved ? WorkflowEventType.APPROVAL_GRANTED : WorkflowEventType.APPROVAL_DENIED;
        
        System.out.println("ApprovalService: 审批结果 " + taskId + " - " + (approved ? "通过" : "拒绝"));
        sendEvent(resultType, taskId);
    }
}

// 日志服务组件
class LoggingService extends WorkflowComponent {
    private List<String> logs;
    
    public LoggingService(WorkflowMediator mediator) {
        super(mediator, "LoggingService");
        this.logs = new ArrayList<>();
    }
    
    @Override
    public void handleEvent(WorkflowEvent event) {
        String logEntry = String.format("[%s] %s: %s", 
                                       new Date(event.getTimestamp()), 
                                       event.getType(), 
                                       event.getTaskId());
        logs.add(logEntry);
        System.out.println("LoggingService: 记录日志 - " + logEntry);
    }
    
    public void printLogs() {
        System.out.println("\n=== 系统日志 ===");
        for (int i = 0; i < logs.size(); i++) {
            System.out.println((i + 1) + ". " + logs.get(i));
        }
    }
}

// 企业级工作流系统演示
public class EnterpriseWorkflowDemo {
    public static void main(String[] args) {
        System.out.println("=== 企业级工作流协调系统演示 ===\n");
        
        // 创建工作流引擎（中介者）
        WorkflowEngine workflowEngine = new WorkflowEngine();
        
        // 创建并注册各个组件
        TaskManager taskManager = new TaskManager(workflowEngine);
        NotificationService notificationService = new NotificationService(workflowEngine);
        ApprovalService approvalService = new ApprovalService(workflowEngine);
        LoggingService loggingService = new LoggingService(workflowEngine);
        
        workflowEngine.registerComponent(taskManager);
        workflowEngine.registerComponent(notificationService);
        workflowEngine.registerComponent(approvalService);
        workflowEngine.registerComponent(loggingService);
        
        System.out.println();
        
        // 模拟工作流程
        System.out.println("=== 开始工作流程 ===");
        
        // 创建任务
        taskManager.createTask("TASK-001", "开发新功能模块");
        Thread.sleep(200);
        
        taskManager.createTask("TASK-002", "修复系统Bug");
        Thread.sleep(200);
        
        // 完成任务
        taskManager.completeTask("TASK-001");
        Thread.sleep(300);
        
        taskManager.completeTask("TASK-002");
        Thread.sleep(300);
        
        // 打印系统状态和历史
        workflowEngine.printSystemStatus();
        workflowEngine.printEventHistory();
        loggingService.printLogs();
        
        System.out.println("\n=== 中介者模式优势 ===");
        System.out.println("- 解耦: 组件间不直接依赖，通过中介者通信");
        System.out.println("- 集中控制: 复杂的交互逻辑集中在中介者中");
        System.out.println("- 可扩展: 容易添加新的组件和交互规则");
        System.out.println("- 可维护: 修改交互逻辑只需修改中介者");
        System.out.println("- 可重用: 组件可以在不同的中介者中重用");
    }
}
```

**模式优势**
- **降低耦合**：对象间不直接引用，通过中介者通信
- **集中控制**：将复杂的交互逻辑集中在中介者中
- **提高可维护性**：修改交互行为只需修改中介者
- **支持多对多通信**：简化复杂的对象间通信

**适用场景**
- 一组对象以定义良好但是复杂的方式进行通信
- 想要重用一个对象，但该对象与其他对象紧密耦合
- 想要定制一个分布在多个类中的行为，而又不想生成太多子类
- 对象间的交互虽然定义明确但非常复杂，导致相互依赖且难以理解

#### 核心概念
- **中介者**：定义对象间交互的封装
- **同事类**：相互交互的对象
- **松耦合**：对象间不直接引用，通过中介者交互
- **集中控制**：将交互逻辑集中在中介者中

#### 参与者概念
- **中介者接口**：定义同事对象交互的接口
- **具体中介者**：实现中介者接口，协调同事对象
- **同事类**：需要与其他对象交互的类

### 6. 备忘录模式 (Memento)

**定义**：在不破坏封装性的前提下，捕获一个对象的内部状态，并在该对象之外保存这个状态。这样以后就可将该对象恢复到原先保存的状态。

**GoF原定义**："Without violating encapsulation, capture and externalize an object's internal state so that the object can be restored to this state later."

**核心思想**
- 保存对象的内部状态快照，支持撤销操作
- 不破坏对象的封装性
- 将状态保存和恢复的责任分离
- 支持多级撤销和重做功能

**基础例子：文本编辑器撤销功能**

```java
// 备忘录类 - 保存编辑器状态
class EditorMemento {
    private final String content;
    private final int cursorPosition;
    private final long timestamp;
    
    public EditorMemento(String content, int cursorPosition) {
        this.content = content;
        this.cursorPosition = cursorPosition;
        this.timestamp = System.currentTimeMillis();
    }
    
    public String getContent() {
        return content;
    }
    
    public int getCursorPosition() {
        return cursorPosition;
    }
    
    public long getTimestamp() {
        return timestamp;
    }
    
    @Override
    public String toString() {
        return "EditorMemento{" +
               "content='" + content.substring(0, Math.min(content.length(), 20)) + 
               (content.length() > 20 ? "..." : "") + "', " +
               "cursorPosition=" + cursorPosition + ", " +
               "timestamp=" + new Date(timestamp) + '}';
    }
}

// 原发器 - 文本编辑器
class TextEditor {
    private StringBuilder content;
    private int cursorPosition;
    
    public TextEditor() {
        this.content = new StringBuilder();
        this.cursorPosition = 0;
    }
    
    public void type(String text) {
        content.insert(cursorPosition, text);
        cursorPosition += text.length();
        System.out.println("输入文本: \"" + text + "\"");
        System.out.println("当前内容: \"" + content + "\"");
    }
    
    public void delete(int length) {
        if (cursorPosition >= length) {
            String deletedText = content.substring(cursorPosition - length, cursorPosition);
            content.delete(cursorPosition - length, cursorPosition);
            cursorPosition -= length;
            System.out.println("删除文本: \"" + deletedText + "\"");
            System.out.println("当前内容: \"" + content + "\"");
        }
    }
    
    public void moveCursor(int position) {
        if (position >= 0 && position <= content.length()) {
            cursorPosition = position;
            System.out.println("光标移动到位置: " + position);
        }
    }
    
    // 创建备忘录
    public EditorMemento createMemento() {
        return new EditorMemento(content.toString(), cursorPosition);
    }
    
    // 恢复状态
    public void restoreFromMemento(EditorMemento memento) {
        this.content = new StringBuilder(memento.getContent());
        this.cursorPosition = memento.getCursorPosition();
        System.out.println("恢复到状态: \"" + content + "\", 光标位置: " + cursorPosition);
    }
    
    public String getContent() {
        return content.toString();
    }
    
    public int getCursorPosition() {
        return cursorPosition;
    }
    
    public void printStatus() {
        System.out.println("编辑器状态 - 内容: \"" + content + "\", 光标位置: " + cursorPosition);
    }
}

// 管理者 - 撤销管理器
class UndoManager {
    private Stack<EditorMemento> undoStack;
    private Stack<EditorMemento> redoStack;
    private int maxHistorySize;
    
    public UndoManager(int maxHistorySize) {
        this.undoStack = new Stack<>();
        this.redoStack = new Stack<>();
        this.maxHistorySize = maxHistorySize;
    }
    
    public void saveState(EditorMemento memento) {
        undoStack.push(memento);
        redoStack.clear(); // 保存新状态时清空重做栈
        
        // 限制历史记录大小
        if (undoStack.size() > maxHistorySize) {
            undoStack.remove(0);
        }
        
        System.out.println("状态已保存: " + memento);
    }
    
    public EditorMemento undo() {
        if (!undoStack.isEmpty()) {
            EditorMemento memento = undoStack.pop();
            redoStack.push(memento);
            System.out.println("撤销操作: " + memento);
            return memento;
        }
        System.out.println("没有可撤销的操作");
        return null;
    }
    
    public EditorMemento redo() {
        if (!redoStack.isEmpty()) {
            EditorMemento memento = redoStack.pop();
            undoStack.push(memento);
            System.out.println("重做操作: " + memento);
            return memento;
        }
        System.out.println("没有可重做的操作");
        return null;
    }
    
    public boolean canUndo() {
        return !undoStack.isEmpty();
    }
    
    public boolean canRedo() {
        return !redoStack.isEmpty();
    }
    
    public void printHistory() {
        System.out.println("\n=== 撤销历史 ===");
        System.out.println("撤销栈 (共 " + undoStack.size() + " 个状态):");
        for (int i = undoStack.size() - 1; i >= 0; i--) {
            System.out.println("  " + (undoStack.size() - i) + ". " + undoStack.get(i));
        }
        
        System.out.println("重做栈 (共 " + redoStack.size() + " 个状态):");
        for (int i = redoStack.size() - 1; i >= 0; i--) {
            System.out.println("  " + (redoStack.size() - i) + ". " + redoStack.get(i));
        }
    }
}

// 客户端使用
public class TextEditorDemo {
    public static void main(String[] args) {
        System.out.println("=== 文本编辑器撤销功能演示 ===\n");
        
        TextEditor editor = new TextEditor();
        UndoManager undoManager = new UndoManager(10);
        
        // 保存初始状态
        undoManager.saveState(editor.createMemento());
        
        // 编辑操作
        editor.type("Hello");
        undoManager.saveState(editor.createMemento());
        
        editor.type(" World");
        undoManager.saveState(editor.createMemento());
        
        editor.type("!");
        undoManager.saveState(editor.createMemento());
        
        editor.moveCursor(5);
        editor.type(" Beautiful");
        undoManager.saveState(editor.createMemento());
        
        System.out.println("\n当前编辑器状态:");
        editor.printStatus();
        
        // 撤销操作
        System.out.println("\n=== 撤销操作 ===");
        EditorMemento memento = undoManager.undo();
        if (memento != null) {
            editor.restoreFromMemento(memento);
        }
        
        memento = undoManager.undo();
        if (memento != null) {
            editor.restoreFromMemento(memento);
        }
        
        // 重做操作
        System.out.println("\n=== 重做操作 ===");
        memento = undoManager.redo();
        if (memento != null) {
            editor.restoreFromMemento(memento);
        }
        
        // 打印历史记录
        undoManager.printHistory();
    }
}
```

**进阶例子：企业级游戏存档系统**

```java
// 游戏状态数据类
class GameState {
    private int level;
    private int score;
    private int lives;
    private Map<String, Integer> inventory;
    private Position playerPosition;
    private List<String> achievements;
    private long playTime; // 游戏时间（毫秒）
    
    public GameState(int level, int score, int lives, Map<String, Integer> inventory, 
                    Position playerPosition, List<String> achievements, long playTime) {
        this.level = level;
        this.score = score;
        this.lives = lives;
        this.inventory = new HashMap<>(inventory);
        this.playerPosition = new Position(playerPosition.x, playerPosition.y);
        this.achievements = new ArrayList<>(achievements);
        this.playTime = playTime;
    }
    
    // Getters
    public int getLevel() { return level; }
    public int getScore() { return score; }
    public int getLives() { return lives; }
    public Map<String, Integer> getInventory() { return new HashMap<>(inventory); }
    public Position getPlayerPosition() { return new Position(playerPosition.x, playerPosition.y); }
    public List<String> getAchievements() { return new ArrayList<>(achievements); }
    public long getPlayTime() { return playTime; }
    
    @Override
    public String toString() {
        return String.format("GameState{level=%d, score=%d, lives=%d, pos=(%d,%d), items=%d, achievements=%d, time=%ds}", 
                           level, score, lives, playerPosition.x, playerPosition.y, 
                           inventory.size(), achievements.size(), playTime / 1000);
    }
}

// 位置类
class Position {
    int x, y;
    
    public Position(int x, int y) {
        this.x = x;
        this.y = y;
    }
    
    @Override
    public String toString() {
        return "(" + x + "," + y + ")";
    }
}

// 游戏存档备忘录
class GameMemento {
    private final GameState gameState;
    private final String saveSlotName;
    private final long saveTimestamp;
    private final String description;
    
    public GameMemento(GameState gameState, String saveSlotName, String description) {
        this.gameState = gameState;
        this.saveSlotName = saveSlotName;
        this.description = description;
        this.saveTimestamp = System.currentTimeMillis();
    }
    
    public GameState getGameState() {
        return gameState;
    }
    
    public String getSaveSlotName() {
        return saveSlotName;
    }
    
    public long getSaveTimestamp() {
        return saveTimestamp;
    }
    
    public String getDescription() {
        return description;
    }
    
    @Override
    public String toString() {
        return String.format("GameMemento{slot='%s', desc='%s', time=%s, state=%s}", 
                           saveSlotName, description, new Date(saveTimestamp), gameState);
    }
}

// 游戏原发器
class Game {
    private int level;
    private int score;
    private int lives;
    private Map<String, Integer> inventory;
    private Position playerPosition;
    private List<String> achievements;
    private long gameStartTime;
    private long totalPlayTime;
    
    public Game() {
        this.level = 1;
        this.score = 0;
        this.lives = 3;
        this.inventory = new HashMap<>();
        this.playerPosition = new Position(0, 0);
        this.achievements = new ArrayList<>();
        this.gameStartTime = System.currentTimeMillis();
        this.totalPlayTime = 0;
        
        // 初始化一些道具
        inventory.put("金币", 100);
        inventory.put("生命药水", 2);
    }
    
    // 游戏操作方法
    public void levelUp() {
        level++;
        score += 1000;
        System.out.println("升级到第 " + level + " 关！获得1000分奖励");
        
        if (level % 5 == 0) {
            achievements.add("达到第" + level + "关");
            System.out.println("获得成就: 达到第" + level + "关");
        }
    }
    
    public void collectItem(String itemName, int quantity) {
        inventory.put(itemName, inventory.getOrDefault(itemName, 0) + quantity);
        score += quantity * 10;
        System.out.println("收集道具: " + itemName + " x" + quantity);
    }
    
    public void movePlayer(int deltaX, int deltaY) {
        playerPosition.x += deltaX;
        playerPosition.y += deltaY;
        System.out.println("玩家移动到位置: " + playerPosition);
    }
    
    public void loseLife() {
        if (lives > 0) {
            lives--;
            System.out.println("失去一条生命，剩余生命: " + lives);
            if (lives == 0) {
                System.out.println("游戏结束！");
            }
        }
    }
    
    public void useItem(String itemName) {
        if (inventory.containsKey(itemName) && inventory.get(itemName) > 0) {
            inventory.put(itemName, inventory.get(itemName) - 1);
            if (itemName.equals("生命药水")) {
                lives++;
                System.out.println("使用生命药水，生命+1，当前生命: " + lives);
            }
        }
    }
    
    // 创建存档
    public GameMemento createSave(String saveSlotName, String description) {
        long currentPlayTime = totalPlayTime + (System.currentTimeMillis() - gameStartTime);
        GameState state = new GameState(level, score, lives, inventory, playerPosition, 
                                       achievements, currentPlayTime);
        return new GameMemento(state, saveSlotName, description);
    }
    
    // 加载存档
    public void loadSave(GameMemento memento) {
        GameState state = memento.getGameState();
        this.level = state.getLevel();
        this.score = state.getScore();
        this.lives = state.getLives();
        this.inventory = state.getInventory();
        this.playerPosition = state.getPlayerPosition();
        this.achievements = state.getAchievements();
        this.totalPlayTime = state.getPlayTime();
        this.gameStartTime = System.currentTimeMillis();
        
        System.out.println("加载存档: " + memento.getSaveSlotName() + " - " + memento.getDescription());
        System.out.println("游戏状态已恢复: " + state);
    }
    
    public void printGameStatus() {
        long currentPlayTime = totalPlayTime + (System.currentTimeMillis() - gameStartTime);
        System.out.println("\n=== 当前游戏状态 ===");
        System.out.println("关卡: " + level);
        System.out.println("分数: " + score);
        System.out.println("生命: " + lives);
        System.out.println("位置: " + playerPosition);
        System.out.println("道具: " + inventory);
        System.out.println("成就: " + achievements);
        System.out.println("游戏时间: " + (currentPlayTime / 1000) + "秒");
    }
}

// 存档管理器
class SaveManager {
    private Map<String, GameMemento> saveSlots;
    private List<GameMemento> autoSaves;
    private int maxAutoSaves;
    
    public SaveManager(int maxAutoSaves) {
        this.saveSlots = new HashMap<>();
        this.autoSaves = new ArrayList<>();
        this.maxAutoSaves = maxAutoSaves;
    }
    
    // 手动存档
    public void saveGame(GameMemento memento) {
        saveSlots.put(memento.getSaveSlotName(), memento);
        System.out.println("游戏已保存到存档槽: " + memento.getSaveSlotName());
    }
    
    // 自动存档
    public void autoSave(GameMemento memento) {
        autoSaves.add(memento);
        
        // 限制自动存档数量
        if (autoSaves.size() > maxAutoSaves) {
            GameMemento removed = autoSaves.remove(0);
            System.out.println("删除旧的自动存档: " + removed.getDescription());
        }
        
        System.out.println("自动存档完成: " + memento.getDescription());
    }
    
    // 加载存档
    public GameMemento loadGame(String saveSlotName) {
        GameMemento memento = saveSlots.get(saveSlotName);
        if (memento != null) {
            System.out.println("加载存档: " + saveSlotName);
            return memento;
        } else {
            System.out.println("存档槽 " + saveSlotName + " 不存在");
            return null;
        }
    }
    
    // 加载最近的自动存档
    public GameMemento loadLatestAutoSave() {
        if (!autoSaves.isEmpty()) {
            GameMemento latest = autoSaves.get(autoSaves.size() - 1);
            System.out.println("加载最新自动存档: " + latest.getDescription());
            return latest;
        } else {
            System.out.println("没有自动存档");
            return null;
        }
    }
    
    // 删除存档
    public void deleteSave(String saveSlotName) {
        GameMemento removed = saveSlots.remove(saveSlotName);
        if (removed != null) {
            System.out.println("删除存档: " + saveSlotName);
        } else {
            System.out.println("存档槽 " + saveSlotName + " 不存在");
        }
    }
    
    // 列出所有存档
    public void listAllSaves() {
        System.out.println("\n=== 存档列表 ===");
        
        System.out.println("手动存档 (共 " + saveSlots.size() + " 个):");
        saveSlots.forEach((slot, memento) -> {
            System.out.println("  " + slot + ": " + memento.getDescription() + 
                             " (保存时间: " + new Date(memento.getSaveTimestamp()) + ")");
        });
        
        System.out.println("自动存档 (共 " + autoSaves.size() + " 个):");
        for (int i = 0; i < autoSaves.size(); i++) {
            GameMemento memento = autoSaves.get(i);
            System.out.println("  自动存档" + (i + 1) + ": " + memento.getDescription() + 
                             " (保存时间: " + new Date(memento.getSaveTimestamp()) + ")");
        }
    }
    
    // 获取存档统计信息
    public void printSaveStats() {
        System.out.println("\n=== 存档统计 ===");
        System.out.println("手动存档数量: " + saveSlots.size());
        System.out.println("自动存档数量: " + autoSaves.size());
        System.out.println("最大自动存档数: " + maxAutoSaves);
        
        if (!saveSlots.isEmpty()) {
            GameMemento latest = saveSlots.values().stream()
                .max((m1, m2) -> Long.compare(m1.getSaveTimestamp(), m2.getSaveTimestamp()))
                .orElse(null);
            if (latest != null) {
                System.out.println("最新手动存档: " + latest.getSaveSlotName() + 
                                 " (" + new Date(latest.getSaveTimestamp()) + ")");
            }
        }
    }
}

// 企业级游戏存档系统演示
public class EnterpriseGameSaveDemo {
    public static void main(String[] args) throws InterruptedException {
        System.out.println("=== 企业级游戏存档系统演示 ===\n");
        
        Game game = new Game();
        SaveManager saveManager = new SaveManager(3); // 最多保存3个自动存档
        
        // 初始状态
        game.printGameStatus();
        
        // 游戏进程1
        System.out.println("\n=== 游戏进程1 ===");
        game.collectItem("金币", 50);
        game.movePlayer(10, 5);
        game.levelUp();
        
        // 手动存档
        GameMemento save1 = game.createSave("存档1", "第2关开始");
        saveManager.saveGame(save1);
        
        Thread.sleep(100); // 模拟时间流逝
        
        // 游戏进程2
        System.out.println("\n=== 游戏进程2 ===");
        game.collectItem("生命药水", 1);
        game.movePlayer(5, 10);
        game.levelUp();
        game.levelUp();
        
        // 自动存档
        GameMemento autoSave1 = game.createSave("auto_save_1", "第4关自动存档");
        saveManager.autoSave(autoSave1);
        
        Thread.sleep(100);
        
        // 游戏进程3
        System.out.println("\n=== 游戏进程3 ===");
        game.loseLife();
        game.useItem("生命药水");
        game.levelUp();
        game.levelUp();
        
        // 手动存档
        GameMemento save2 = game.createSave("存档2", "第6关BOSS前");
        saveManager.saveGame(save2);
        
        // 自动存档
        GameMemento autoSave2 = game.createSave("auto_save_2", "第6关自动存档");
        saveManager.autoSave(autoSave2);
        
        game.printGameStatus();
        
        // 模拟游戏失败，加载存档
        System.out.println("\n=== 游戏失败，加载存档 ===");
        game.loseLife();
        game.loseLife();
        game.loseLife();
        
        // 加载之前的存档
        GameMemento loadedSave = saveManager.loadGame("存档1");
        if (loadedSave != null) {
            game.loadSave(loadedSave);
            game.printGameStatus();
        }
        
        // 继续游戏
        System.out.println("\n=== 继续游戏 ===");
        game.collectItem("魔法卷轴", 3);
        game.levelUp();
        
        // 更多自动存档测试
        for (int i = 3; i <= 5; i++) {
            GameMemento autoSave = game.createSave("auto_save_" + i, "第" + (game.level + 1) + "关自动存档");
            saveManager.autoSave(autoSave);
            game.levelUp();
            Thread.sleep(50);
        }
        
        // 显示所有存档
        saveManager.listAllSaves();
        saveManager.printSaveStats();
        
        // 加载最新自动存档
        System.out.println("\n=== 加载最新自动存档 ===");
        GameMemento latestAutoSave = saveManager.loadLatestAutoSave();
        if (latestAutoSave != null) {
            game.loadSave(latestAutoSave);
            game.printGameStatus();
        }
        
        System.out.println("\n=== 备忘录模式优势 ===");
        System.out.println("- 封装性: 不破坏对象的封装性保存状态");
        System.out.println("- 简化原发器: 原发器不需要管理历史状态");
        System.out.println("- 状态独立: 备忘录状态独立于原发器");
        System.out.println("- 支持多级撤销: 可以保存多个历史状态");
        System.out.println("- 灵活恢复: 可以选择性地恢复到任意历史状态");
    }
}
```

**模式优势**
- **保持封装性**：不破坏对象的封装边界
- **简化原发器**：原发器不需要管理多个历史状态
- **状态独立性**：备忘录独立于原发器存在
- **支持撤销操作**：提供撤销和恢复功能

**适用场景**
- 需要保存对象状态快照以便后续恢复
- 需要实现撤销操作的系统
- 需要提供事务回滚功能
- 需要实现检查点和恢复机制的系统

**注意事项**
- 如果原发器状态复杂，备忘录可能消耗大量内存
- 需要考虑备忘录的生命周期管理
- 在某些情况下可能需要增量备忘录来优化性能

#### 核心概念
- **备忘录**：在不破坏封装的前提下捕获对象的内部状态
- **发起人**：创建备忘录的对象
- **管理者**：负责保存备忘录的对象
- **状态恢复**：从备忘录中恢复对象状态

#### 参与者概念
- **发起人**：创建备忘录来记录当前时刻的内部状态
- **备忘录**：存储发起人的内部状态
- **管理者**：负责保存备忘录，不能对备忘录的内容进行操作

#### 实现概念
- **白盒实现**：备忘录的接口提供宽接口
- **黑盒实现**：备忘录的接口不提供任何方法
- **多重检查点**：支持多个状态的保存和恢复

### 7. 观察者模式 (Observer)

**定义**：定义对象间的一种一对多的依赖关系，当一个对象的状态发生改变时，所有依赖于它的对象都得到通知并被自动更新。

**GoF原定义**："Define a one-to-many dependency between objects so that when one object changes state, all its dependents are notified and updated automatically."

**核心思想**
- 建立对象间的一对多依赖关系
- 当主题对象状态改变时，自动通知所有观察者
- 观察者和主题之间松耦合
- 支持广播通信机制

**基础例子：天气监测系统**

```java
// 观察者接口
interface Observer {
    void update(float temperature, float humidity, float pressure);
}

// 主题接口
interface Subject {
    void registerObserver(Observer observer);
    void removeObserver(Observer observer);
    void notifyObservers();
}

// 具体主题 - 天气数据
class WeatherData implements Subject {
    private List<Observer> observers;
    private float temperature;
    private float humidity;
    private float pressure;
    
    public WeatherData() {
        observers = new ArrayList<>();
    }
    
    @Override
    public void registerObserver(Observer observer) {
        observers.add(observer);
        System.out.println("观察者已注册: " + observer.getClass().getSimpleName());
    }
    
    @Override
    public void removeObserver(Observer observer) {
        observers.remove(observer);
        System.out.println("观察者已移除: " + observer.getClass().getSimpleName());
    }
    
    @Override
    public void notifyObservers() {
        for (Observer observer : observers) {
            observer.update(temperature, humidity, pressure);
        }
    }
    
    public void measurementsChanged() {
        notifyObservers();
    }
    
    public void setMeasurements(float temperature, float humidity, float pressure) {
        this.temperature = temperature;
        this.humidity = humidity;
        this.pressure = pressure;
        System.out.println("天气数据更新: 温度=" + temperature + "°C, 湿度=" + humidity + "%, 气压=" + pressure + "hPa");
        measurementsChanged();
    }
    
    // Getters
    public float getTemperature() { return temperature; }
    public float getHumidity() { return humidity; }
    public float getPressure() { return pressure; }
}

// 具体观察者 - 当前天气显示
class CurrentConditionsDisplay implements Observer {
    private float temperature;
    private float humidity;
    private Subject weatherData;
    
    public CurrentConditionsDisplay(Subject weatherData) {
        this.weatherData = weatherData;
        weatherData.registerObserver(this);
    }
    
    @Override
    public void update(float temperature, float humidity, float pressure) {
        this.temperature = temperature;
        this.humidity = humidity;
        display();
    }
    
    public void display() {
        System.out.println("当前天气: 温度 " + temperature + "°C, 湿度 " + humidity + "%");
    }
}

// 具体观察者 - 统计显示
class StatisticsDisplay implements Observer {
    private float maxTemp = 0.0f;
    private float minTemp = 200;
    private float tempSum = 0.0f;
    private int numReadings;
    private Subject weatherData;
    
    public StatisticsDisplay(Subject weatherData) {
        this.weatherData = weatherData;
        weatherData.registerObserver(this);
    }
    
    @Override
    public void update(float temperature, float humidity, float pressure) {
        tempSum += temperature;
        numReadings++;
        
        if (temperature > maxTemp) {
            maxTemp = temperature;
        }
        
        if (temperature < minTemp) {
            minTemp = temperature;
        }
        
        display();
    }
    
    public void display() {
        System.out.println("温度统计: 平均 " + (tempSum / numReadings) + "°C, 最高 " + maxTemp + "°C, 最低 " + minTemp + "°C");
    }
}

// 具体观察者 - 预报显示
class ForecastDisplay implements Observer {
    private float currentPressure = 29.92f;
    private float lastPressure;
    private Subject weatherData;
    
    public ForecastDisplay(Subject weatherData) {
        this.weatherData = weatherData;
        weatherData.registerObserver(this);
    }
    
    @Override
    public void update(float temperature, float humidity, float pressure) {
        lastPressure = currentPressure;
        currentPressure = pressure;
        display();
    }
    
    public void display() {
        String forecast;
        if (currentPressure > lastPressure) {
            forecast = "天气转好";
        } else if (currentPressure == lastPressure) {
            forecast = "天气稳定";
        } else {
            forecast = "天气转坏";
        }
        System.out.println("天气预报: " + forecast + " (气压变化: " + (currentPressure - lastPressure) + "hPa)");
    }
}

// 客户端使用
public class WeatherStationDemo {
    public static void main(String[] args) {
        System.out.println("=== 天气监测系统演示 ===\n");
        
        // 创建天气数据主题
        WeatherData weatherData = new WeatherData();
        
        // 创建观察者
        CurrentConditionsDisplay currentDisplay = new CurrentConditionsDisplay(weatherData);
        StatisticsDisplay statisticsDisplay = new StatisticsDisplay(weatherData);
        ForecastDisplay forecastDisplay = new ForecastDisplay(weatherData);
        
        System.out.println();
        
        // 模拟天气数据变化
        System.out.println("第一次天气数据更新:");
        weatherData.setMeasurements(25.0f, 65.0f, 1013.2f);
        
        System.out.println("\n第二次天气数据更新:");
        weatherData.setMeasurements(28.0f, 70.0f, 1012.8f);
        
        System.out.println("\n第三次天气数据更新:");
        weatherData.setMeasurements(22.0f, 80.0f, 1010.5f);
        
        // 移除一个观察者
        System.out.println("\n移除统计显示观察者:");
        weatherData.removeObserver(statisticsDisplay);
        
        System.out.println("\n第四次天气数据更新:");
        weatherData.setMeasurements(26.0f, 75.0f, 1014.1f);
    }
}
```

**进阶例子：企业级事件驱动系统**

```java
// 事件类型枚举
enum EventType {
    USER_REGISTERED, USER_LOGIN, USER_LOGOUT, ORDER_CREATED, ORDER_PAID, 
    ORDER_SHIPPED, ORDER_DELIVERED, INVENTORY_LOW, SYSTEM_ERROR
}

// 事件数据基类
abstract class EventData {
    private final String eventId;
    private final long timestamp;
    private final String source;
    
    public EventData(String source) {
        this.eventId = UUID.randomUUID().toString();
        this.timestamp = System.currentTimeMillis();
        this.source = source;
    }
    
    public String getEventId() { return eventId; }
    public long getTimestamp() { return timestamp; }
    public String getSource() { return source; }
    
    @Override
    public String toString() {
        return String.format("EventData{id='%s', source='%s', time=%s}", 
                           eventId.substring(0, 8), source, new Date(timestamp));
    }
}

// 用户事件数据
class UserEventData extends EventData {
    private final String userId;
    private final String username;
    private final String email;
    
    public UserEventData(String source, String userId, String username, String email) {
        super(source);
        this.userId = userId;
        this.username = username;
        this.email = email;
    }
    
    public String getUserId() { return userId; }
    public String getUsername() { return username; }
    public String getEmail() { return email; }
    
    @Override
    public String toString() {
        return super.toString() + String.format(" User{id='%s', name='%s', email='%s'}", 
                                              userId, username, email);
    }
}

// 订单事件数据
class OrderEventData extends EventData {
    private final String orderId;
    private final String userId;
    private final double amount;
    private final String status;
    
    public OrderEventData(String source, String orderId, String userId, double amount, String status) {
        super(source);
        this.orderId = orderId;
        this.userId = userId;
        this.amount = amount;
        this.status = status;
    }
    
    public String getOrderId() { return orderId; }
    public String getUserId() { return userId; }
    public double getAmount() { return amount; }
    public String getStatus() { return status; }
    
    @Override
    public String toString() {
        return super.toString() + String.format(" Order{id='%s', userId='%s', amount=%.2f, status='%s'}", 
                                              orderId, userId, amount, status);
    }
}

// 事件监听器接口
interface EventListener {
    void onEvent(EventType eventType, EventData eventData);
    String getListenerName();
    boolean isInterestedIn(EventType eventType);
}

// 事件发布器接口
interface EventPublisher {
    void subscribe(EventListener listener);
    void subscribe(EventListener listener, EventType... eventTypes);
    void unsubscribe(EventListener listener);
    void publishEvent(EventType eventType, EventData eventData);
}

// 具体事件发布器 - 事件总线
class EventBus implements EventPublisher {
    private final Map<EventType, List<EventListener>> listeners;
    private final List<EventListener> globalListeners;
    private final ExecutorService executorService;
    private final boolean asyncMode;
    
    public EventBus(boolean asyncMode) {
        this.listeners = new HashMap<>();
        this.globalListeners = new ArrayList<>();
        this.asyncMode = asyncMode;
        this.executorService = asyncMode ? Executors.newFixedThreadPool(5) : null;
        
        // 初始化所有事件类型的监听器列表
        for (EventType eventType : EventType.values()) {
            listeners.put(eventType, new ArrayList<>());
        }
    }
    
    @Override
    public void subscribe(EventListener listener) {
        globalListeners.add(listener);
        System.out.println("全局监听器已注册: " + listener.getListenerName());
    }
    
    @Override
    public void subscribe(EventListener listener, EventType... eventTypes) {
        for (EventType eventType : eventTypes) {
            listeners.get(eventType).add(listener);
            System.out.println("监听器已注册: " + listener.getListenerName() + " -> " + eventType);
        }
    }
    
    @Override
    public void unsubscribe(EventListener listener) {
        globalListeners.remove(listener);
        for (List<EventListener> listenerList : listeners.values()) {
            listenerList.remove(listener);
        }
        System.out.println("监听器已注销: " + listener.getListenerName());
    }
    
    @Override
    public void publishEvent(EventType eventType, EventData eventData) {
        System.out.println("发布事件: " + eventType + " - " + eventData);
        
        // 通知特定事件类型的监听器
        List<EventListener> specificListeners = listeners.get(eventType);
        notifyListeners(specificListeners, eventType, eventData);
        
        // 通知全局监听器
        List<EventListener> interestedGlobalListeners = globalListeners.stream()
            .filter(listener -> listener.isInterestedIn(eventType))
            .collect(Collectors.toList());
        notifyListeners(interestedGlobalListeners, eventType, eventData);
    }
    
    private void notifyListeners(List<EventListener> listenersToNotify, EventType eventType, EventData eventData) {
        for (EventListener listener : listenersToNotify) {
            if (asyncMode) {
                executorService.submit(() -> {
                    try {
                        listener.onEvent(eventType, eventData);
                    } catch (Exception e) {
                        System.err.println("监听器处理事件时发生异常: " + listener.getListenerName() + " - " + e.getMessage());
                    }
                });
            } else {
                try {
                    listener.onEvent(eventType, eventData);
                } catch (Exception e) {
                    System.err.println("监听器处理事件时发生异常: " + listener.getListenerName() + " - " + e.getMessage());
                }
            }
        }
    }
    
    public void shutdown() {
        if (executorService != null) {
            executorService.shutdown();
        }
    }
    
    public void printStatistics() {
        System.out.println("\n=== 事件总线统计 ===");
        System.out.println("全局监听器数量: " + globalListeners.size());
        System.out.println("特定事件监听器:");
        listeners.forEach((eventType, listenerList) -> {
            if (!listenerList.isEmpty()) {
                System.out.println("  " + eventType + ": " + listenerList.size() + " 个监听器");
            }
        });
        System.out.println("异步模式: " + (asyncMode ? "开启" : "关闭"));
    }
}

// 邮件通知监听器
class EmailNotificationListener implements EventListener {
    @Override
    public void onEvent(EventType eventType, EventData eventData) {
        switch (eventType) {
            case USER_REGISTERED:
                UserEventData userData = (UserEventData) eventData;
                sendWelcomeEmail(userData.getEmail(), userData.getUsername());
                break;
            case ORDER_CREATED:
                OrderEventData orderData = (OrderEventData) eventData;
                sendOrderConfirmationEmail(orderData);
                break;
            case ORDER_SHIPPED:
                OrderEventData shippedOrder = (OrderEventData) eventData;
                sendShippingNotificationEmail(shippedOrder);
                break;
        }
    }
    
    private void sendWelcomeEmail(String email, String username) {
        System.out.println("EmailService: 发送欢迎邮件到 " + email + " (用户: " + username + ")");
    }
    
    private void sendOrderConfirmationEmail(OrderEventData orderData) {
        System.out.println("EmailService: 发送订单确认邮件 - 订单号: " + orderData.getOrderId() + 
                          ", 金额: $" + orderData.getAmount());
    }
    
    private void sendShippingNotificationEmail(OrderEventData orderData) {
        System.out.println("EmailService: 发送发货通知邮件 - 订单号: " + orderData.getOrderId());
    }
    
    @Override
    public String getListenerName() {
        return "EmailNotificationListener";
    }
    
    @Override
    public boolean isInterestedIn(EventType eventType) {
        return eventType == EventType.USER_REGISTERED || 
               eventType == EventType.ORDER_CREATED || 
               eventType == EventType.ORDER_SHIPPED;
    }
}

// 数据分析监听器
class AnalyticsListener implements EventListener {
    private Map<EventType, Integer> eventCounts = new HashMap<>();
    
    @Override
    public void onEvent(EventType eventType, EventData eventData) {
        eventCounts.put(eventType, eventCounts.getOrDefault(eventType, 0) + 1);
        
        switch (eventType) {
            case USER_REGISTERED:
                trackUserRegistration((UserEventData) eventData);
                break;
            case ORDER_CREATED:
                trackOrderCreation((OrderEventData) eventData);
                break;
            case USER_LOGIN:
                trackUserLogin((UserEventData) eventData);
                break;
        }
    }
    
    private void trackUserRegistration(UserEventData userData) {
        System.out.println("Analytics: 记录用户注册事件 - 用户ID: " + userData.getUserId());
    }
    
    private void trackOrderCreation(OrderEventData orderData) {
        System.out.println("Analytics: 记录订单创建事件 - 订单金额: $" + orderData.getAmount());
    }
    
    private void trackUserLogin(UserEventData userData) {
        System.out.println("Analytics: 记录用户登录事件 - 用户: " + userData.getUsername());
    }
    
    @Override
    public String getListenerName() {
        return "AnalyticsListener";
    }
    
    @Override
    public boolean isInterestedIn(EventType eventType) {
        return true; // 对所有事件感兴趣
    }
    
    public void printStatistics() {
        System.out.println("\n=== 数据分析统计 ===");
        eventCounts.forEach((eventType, count) -> 
            System.out.println(eventType + ": " + count + " 次"));
    }
}

// 库存管理监听器
class InventoryListener implements EventListener {
    private Map<String, Integer> inventory = new HashMap<>();
    
    public InventoryListener() {
        // 初始化库存
        inventory.put("PROD-001", 100);
        inventory.put("PROD-002", 50);
        inventory.put("PROD-003", 25);
    }
    
    @Override
    public void onEvent(EventType eventType, EventData eventData) {
        if (eventType == EventType.ORDER_PAID) {
            OrderEventData orderData = (OrderEventData) eventData;
            updateInventory(orderData);
        }
    }
    
    private void updateInventory(OrderEventData orderData) {
        // 简化逻辑：假设每个订单消耗1个商品
        String productId = "PROD-001"; // 简化处理
        int currentStock = inventory.getOrDefault(productId, 0);
        
        if (currentStock > 0) {
            inventory.put(productId, currentStock - 1);
            System.out.println("Inventory: 更新库存 " + productId + " - 剩余: " + (currentStock - 1));
            
            // 检查低库存警告
            if (currentStock - 1 < 10) {
                System.out.println("Inventory: 库存警告 - " + productId + " 库存不足!");
            }
        }
    }
    
    @Override
    public String getListenerName() {
        return "InventoryListener";
    }
    
    @Override
    public boolean isInterestedIn(EventType eventType) {
        return eventType == EventType.ORDER_PAID;
    }
    
    public void printInventory() {
        System.out.println("\n=== 当前库存 ===");
        inventory.forEach((productId, stock) -> 
            System.out.println(productId + ": " + stock + " 件"));
    }
}

// 日志监听器
class LoggingListener implements EventListener {
    private List<String> logs = new ArrayList<>();
    
    @Override
    public void onEvent(EventType eventType, EventData eventData) {
        String logEntry = String.format("[%s] %s: %s", 
                                       new Date(eventData.getTimestamp()), 
                                       eventType, 
                                       eventData.toString());
        logs.add(logEntry);
        System.out.println("Logger: " + logEntry);
    }
    
    @Override
    public String getListenerName() {
        return "LoggingListener";
    }
    
    @Override
    public boolean isInterestedIn(EventType eventType) {
        return true; // 记录所有事件
    }
    
    public void printLogs() {
        System.out.println("\n=== 系统日志 ===");
        for (int i = 0; i < logs.size(); i++) {
            System.out.println((i + 1) + ". " + logs.get(i));
        }
    }
}

// 企业级事件驱动系统演示
public class EnterpriseEventSystemDemo {
    public static void main(String[] args) throws InterruptedException {
        System.out.println("=== 企业级事件驱动系统演示 ===\n");
        
        // 创建事件总线
        EventBus eventBus = new EventBus(false); // 同步模式
        
        // 创建监听器
        EmailNotificationListener emailListener = new EmailNotificationListener();
        AnalyticsListener analyticsListener = new AnalyticsListener();
        InventoryListener inventoryListener = new InventoryListener();
        LoggingListener loggingListener = new LoggingListener();
        
        // 注册监听器
        eventBus.subscribe(emailListener, EventType.USER_REGISTERED, EventType.ORDER_CREATED, EventType.ORDER_SHIPPED);
        eventBus.subscribe(analyticsListener); // 全局监听器
        eventBus.subscribe(inventoryListener, EventType.ORDER_PAID);
        eventBus.subscribe(loggingListener); // 全局监听器
        
        eventBus.printStatistics();
        System.out.println();
        
        // 模拟业务事件
        System.out.println("=== 模拟用户注册 ===");
        UserEventData userRegistered = new UserEventData("UserService", "USER-001", "张三", "zhangsan@example.com");
        eventBus.publishEvent(EventType.USER_REGISTERED, userRegistered);
        
        Thread.sleep(100);
        
        System.out.println("\n=== 模拟用户登录 ===");
        UserEventData userLogin = new UserEventData("AuthService", "USER-001", "张三", "zhangsan@example.com");
        eventBus.publishEvent(EventType.USER_LOGIN, userLogin);
        
        Thread.sleep(100);
        
        System.out.println("\n=== 模拟订单创建 ===");
        OrderEventData orderCreated = new OrderEventData("OrderService", "ORDER-001", "USER-001", 299.99, "CREATED");
        eventBus.publishEvent(EventType.ORDER_CREATED, orderCreated);
        
        Thread.sleep(100);
        
        System.out.println("\n=== 模拟订单支付 ===");
        OrderEventData orderPaid = new OrderEventData("PaymentService", "ORDER-001", "USER-001", 299.99, "PAID");
        eventBus.publishEvent(EventType.ORDER_PAID, orderPaid);
        
        Thread.sleep(100);
        
        System.out.println("\n=== 模拟订单发货 ===");
        OrderEventData orderShipped = new OrderEventData("ShippingService", "ORDER-001", "USER-001", 299.99, "SHIPPED");
        eventBus.publishEvent(EventType.ORDER_SHIPPED, orderShipped);
        
        // 打印统计信息
        analyticsListener.printStatistics();
        inventoryListener.printInventory();
        loggingListener.printLogs();
        
        // 测试监听器注销
        System.out.println("\n=== 注销邮件监听器 ===");
        eventBus.unsubscribe(emailListener);
        
        System.out.println("\n=== 再次创建订单（邮件监听器已注销）===");
        OrderEventData anotherOrder = new OrderEventData("OrderService", "ORDER-002", "USER-001", 199.99, "CREATED");
        eventBus.publishEvent(EventType.ORDER_CREATED, anotherOrder);
        
        eventBus.shutdown();
        
        System.out.println("\n=== 观察者模式优势 ===");
        System.out.println("- 松耦合: 主题和观察者之间松耦合");
        System.out.println("- 动态关系: 可以在运行时建立对象间的关系");
        System.out.println("- 广播通信: 支持一对多的通信机制");
        System.out.println("- 开放封闭: 符合开放-封闭原则");
        System.out.println("- 事件驱动: 支持事件驱动的架构模式");
    }
}
```

**模式优势**
- **松耦合**：主题和观察者之间松耦合，只通过接口交互
- **动态关系**：可以在运行时动态地建立和解除依赖关系
- **广播通信**：支持一对多的通信机制
- **开放封闭**：符合开放-封闭原则，易于扩展

**适用场景**
- 当一个抽象模型有两个方面，其中一个方面依赖于另一个方面
- 当对一个对象的改变需要同时改变其他对象，而不知道具体有多少对象需要改变
- 当一个对象必须通知其他对象，而又不能假定其他对象是谁
- 需要实现事件驱动架构的系统

#### 核心概念
- **观察者**：定义对象间一对多的依赖关系
- **主题**：被观察的对象
- **通知机制**：主题状态改变时通知所有观察者
- **发布-订阅**：观察者模式的另一种称呼

#### 参与者概念
- **主题接口**：定义注册、删除和通知观察者的接口
- **具体主题**：实现主题接口，维护观察者列表
- **观察者接口**：定义更新接口
- **具体观察者**：实现观察者接口

#### 实现概念
- **推模型**：主题主动推送信息给观察者
- **拉模型**：观察者主动从主题拉取信息
- **事件委托**：基于事件的观察者实现

### 8. 状态模式 (State)

#### 核心概念
- **状态**：允许对象在内部状态改变时改变行为
- **状态转换**：从一个状态转换到另一个状态
- **状态封装**：将状态相关的行为封装在状态类中
- **状态机**：状态模式实现的状态机

#### 参与者概念
- **环境**：维护当前状态的引用
- **状态接口**：定义状态的接口
- **具体状态**：实现特定状态的行为

#### 相关概念
- **状态转换表**：描述状态转换规则的表格
- **状态机实现**：基于状态模式的状态机实现

### 9. 策略模式 (Strategy)

#### 核心概念
- **策略**：定义算法族，封装每个算法，使它们可以互相替换
- **算法封装**：将算法封装在独立的类中
- **算法切换**：可以在运行时切换算法
- **算法独立**：算法的变化独立于使用算法的客户

#### 参与者概念
- **策略接口**：定义所有具体策略的公共接口
- **具体策略**：实现策略接口的具体算法
- **环境**：维护策略对象的引用

#### 实现概念
- **简单策略**：基本的策略模式实现
- **策略工厂**：结合工厂模式创建策略
- **策略枚举**：使用枚举实现策略模式

### 10. 模板方法模式 (Template Method)

**定义**：定义一个操作中的算法的骨架，而将一些步骤延迟到子类中。模板方法使得子类可以不改变一个算法的结构即可重定义该算法的某些特定步骤。

**GoF原定义**："Define the skeleton of an algorithm in an operation, deferring some steps to subclasses. Template Method lets subclasses redefine certain steps of an algorithm without changing the algorithm's structure."

**核心思想**
- 在抽象类中定义算法的骨架，具体步骤由子类实现
- 通过钩子方法提供扩展点
- 遵循"好莱坞原则"：不要调用我们，我们会调用你
- 实现代码复用和算法结构的统一

**基础例子：饮料制作流程**

```java
// 抽象模板类
abstract class Beverage {
    
    // 模板方法 - 定义算法骨架
    public final void prepareBeverage() {
        System.out.println("=== 开始制作 " + getBeverageName() + " ===");
        
        boilWater();
        brew();
        pourInCup();
        
        if (customerWantsCondiments()) {
            addCondiments();
        }
        
        System.out.println("=== " + getBeverageName() + " 制作完成 ===\n");
    }
    
    // 具体方法 - 所有子类共用
    private void boilWater() {
        System.out.println("1. 烧开水");
    }
    
    private void pourInCup() {
        System.out.println("3. 倒入杯中");
    }
    
    // 抽象方法 - 子类必须实现
    protected abstract void brew();
    protected abstract void addCondiments();
    protected abstract String getBeverageName();
    
    // 钩子方法 - 子类可以选择性重写
    protected boolean customerWantsCondiments() {
        return true;
    }
}

// 具体子类 - 咖啡
class Coffee extends Beverage {
    
    @Override
    protected void brew() {
        System.out.println("2. 用沸水冲泡咖啡");
    }
    
    @Override
    protected void addCondiments() {
        System.out.println("4. 加糖和牛奶");
    }
    
    @Override
    protected String getBeverageName() {
        return "咖啡";
    }
}

// 具体子类 - 茶
class Tea extends Beverage {
    
    @Override
    protected void brew() {
        System.out.println("2. 用沸水浸泡茶叶");
    }
    
    @Override
    protected void addCondiments() {
        System.out.println("4. 加柠檬");
    }
    
    @Override
    protected String getBeverageName() {
        return "茶";
    }
}

// 具体子类 - 黑咖啡（使用钩子方法）
class BlackCoffee extends Beverage {
    
    @Override
    protected void brew() {
        System.out.println("2. 用沸水冲泡咖啡豆");
    }
    
    @Override
    protected void addCondiments() {
        System.out.println("4. 不添加任何调料");
    }
    
    @Override
    protected String getBeverageName() {
        return "黑咖啡";
    }
    
    // 重写钩子方法
    @Override
    protected boolean customerWantsCondiments() {
        return false; // 黑咖啡不需要调料
    }
}

// 客户端使用
public class BeverageDemo {
    public static void main(String[] args) {
        System.out.println("=== 饮料制作流程演示 ===\n");
        
        Beverage coffee = new Coffee();
        coffee.prepareBeverage();
        
        Beverage tea = new Tea();
        tea.prepareBeverage();
        
        Beverage blackCoffee = new BlackCoffee();
        blackCoffee.prepareBeverage();
    }
}
```

**进阶例子：企业级数据处理框架**

```java
// 数据处理结果类
class ProcessingResult {
    private boolean success;
    private String message;
    private Map<String, Object> data;
    private long processingTime;
    private int processedRecords;
    
    public ProcessingResult(boolean success, String message) {
        this.success = success;
        this.message = message;
        this.data = new HashMap<>();
        this.processingTime = 0;
        this.processedRecords = 0;
    }
    
    // Getters and setters
    public boolean isSuccess() { return success; }
    public void setSuccess(boolean success) { this.success = success; }
    public String getMessage() { return message; }
    public void setMessage(String message) { this.message = message; }
    public Map<String, Object> getData() { return data; }
    public void addData(String key, Object value) { this.data.put(key, value); }
    public long getProcessingTime() { return processingTime; }
    public void setProcessingTime(long processingTime) { this.processingTime = processingTime; }
    public int getProcessedRecords() { return processedRecords; }
    public void setProcessedRecords(int processedRecords) { this.processedRecords = processedRecords; }
    
    @Override
    public String toString() {
        return String.format("ProcessingResult{success=%s, message='%s', records=%d, time=%dms}", 
                           success, message, processedRecords, processingTime);
    }
}

// 抽象数据处理器模板
abstract class DataProcessor {
    
    // 模板方法 - 定义数据处理的完整流程
    public final ProcessingResult processData(String dataSource) {
        long startTime = System.currentTimeMillis();
        ProcessingResult result = new ProcessingResult(true, "处理成功");
        
        try {
            System.out.println("=== 开始数据处理流程 ===");
            System.out.println("处理器: " + getProcessorName());
            System.out.println("数据源: " + dataSource);
            
            // 1. 预处理检查
            if (!preProcessCheck(dataSource)) {
                result.setSuccess(false);
                result.setMessage("预处理检查失败");
                return result;
            }
            
            // 2. 初始化资源
            initializeResources();
            
            // 3. 读取数据
            List<String> rawData = readData(dataSource);
            System.out.println("读取到 " + rawData.size() + " 条原始数据");
            
            // 4. 验证数据
            List<String> validData = validateData(rawData);
            System.out.println("验证通过 " + validData.size() + " 条数据");
            
            // 5. 转换数据
            List<String> transformedData = transformData(validData);
            System.out.println("转换完成 " + transformedData.size() + " 条数据");
            
            // 6. 处理业务逻辑
            Map<String, Object> processedResult = processBusinessLogic(transformedData);
            result.getData().putAll(processedResult);
            
            // 7. 保存结果（如果需要）
            if (shouldSaveResult()) {
                saveResult(processedResult);
            }
            
            // 8. 生成报告（如果需要）
            if (shouldGenerateReport()) {
                String report = generateReport(processedResult);
                result.addData("report", report);
            }
            
            result.setProcessedRecords(transformedData.size());
            
        } catch (Exception e) {
            result.setSuccess(false);
            result.setMessage("处理过程中发生异常: " + e.getMessage());
            System.err.println("处理异常: " + e.getMessage());
        } finally {
            // 9. 清理资源
            cleanupResources();
            
            long endTime = System.currentTimeMillis();
            result.setProcessingTime(endTime - startTime);
            
            System.out.println("=== 数据处理流程完成 ===");
            System.out.println("结果: " + result);
            System.out.println();
        }
        
        return result;
    }
    
    // 抽象方法 - 子类必须实现
    protected abstract String getProcessorName();
    protected abstract List<String> readData(String dataSource);
    protected abstract List<String> validateData(List<String> rawData);
    protected abstract List<String> transformData(List<String> validData);
    protected abstract Map<String, Object> processBusinessLogic(List<String> data);
    
    // 具体方法 - 通用实现
    protected void initializeResources() {
        System.out.println("初始化处理资源");
    }
    
    protected void cleanupResources() {
        System.out.println("清理处理资源");
    }
    
    // 钩子方法 - 子类可以选择性重写
    protected boolean preProcessCheck(String dataSource) {
        System.out.println("执行预处理检查");
        return dataSource != null && !dataSource.trim().isEmpty();
    }
    
    protected boolean shouldSaveResult() {
        return true;
    }
    
    protected boolean shouldGenerateReport() {
        return false;
    }
    
    protected void saveResult(Map<String, Object> result) {
        System.out.println("保存处理结果: " + result.size() + " 项数据");
    }
    
    protected String generateReport(Map<String, Object> result) {
        return "处理报告: 共处理 " + result.size() + " 项数据";
    }
}

// 具体处理器 - 用户数据处理器
class UserDataProcessor extends DataProcessor {
    
    @Override
    protected String getProcessorName() {
        return "用户数据处理器";
    }
    
    @Override
    protected List<String> readData(String dataSource) {
        System.out.println("从用户数据库读取数据");
        // 模拟读取用户数据
        return Arrays.asList(
            "user1,张三,25,北京",
            "user2,李四,30,上海",
            "user3,,28,广州", // 无效数据
            "user4,王五,35,深圳",
            "user5,赵六,22,杭州"
        );
    }
    
    @Override
    protected List<String> validateData(List<String> rawData) {
        System.out.println("验证用户数据格式");
        List<String> validData = new ArrayList<>();
        
        for (String data : rawData) {
            String[] fields = data.split(",");
            if (fields.length == 4 && !fields[1].trim().isEmpty()) {
                validData.add(data);
            } else {
                System.out.println("无效数据: " + data);
            }
        }
        
        return validData;
    }
    
    @Override
    protected List<String> transformData(List<String> validData) {
        System.out.println("转换用户数据格式");
        List<String> transformedData = new ArrayList<>();
        
        for (String data : validData) {
            String[] fields = data.split(",");
            String transformed = String.format("ID:%s,姓名:%s,年龄:%s,城市:%s", 
                                             fields[0], fields[1], fields[2], fields[3]);
            transformedData.add(transformed);
        }
        
        return transformedData;
    }
    
    @Override
    protected Map<String, Object> processBusinessLogic(List<String> data) {
        System.out.println("执行用户数据业务逻辑");
        Map<String, Object> result = new HashMap<>();
        
        // 统计各城市用户数量
        Map<String, Integer> cityCount = new HashMap<>();
        int totalAge = 0;
        
        for (String userData : data) {
            String[] parts = userData.split(",");
            String city = parts[3].split(":")[1];
            String ageStr = parts[2].split(":")[1];
            
            cityCount.put(city, cityCount.getOrDefault(city, 0) + 1);
            totalAge += Integer.parseInt(ageStr);
        }
        
        result.put("cityStatistics", cityCount);
        result.put("averageAge", totalAge / data.size());
        result.put("totalUsers", data.size());
        
        return result;
    }
    
    @Override
    protected boolean shouldGenerateReport() {
        return true;
    }
    
    @Override
    protected String generateReport(Map<String, Object> result) {
        StringBuilder report = new StringBuilder();
        report.append("=== 用户数据处理报告 ===\n");
        report.append("总用户数: ").append(result.get("totalUsers")).append("\n");
        report.append("平均年龄: ").append(result.get("averageAge")).append("\n");
        report.append("城市分布: ").append(result.get("cityStatistics")).append("\n");
        return report.toString();
    }
}

// 企业级数据处理框架演示
public class EnterpriseDataProcessingDemo {
    public static void main(String[] args) {
        System.out.println("=== 企业级数据处理框架演示 ===\n");
        
        // 处理用户数据
        DataProcessor userProcessor = new UserDataProcessor();
        ProcessingResult userResult = userProcessor.processData("user_database");
        System.out.println("用户数据处理结果:");
        System.out.println(userResult.getData().get("report"));
        
        System.out.println("\n=== 模板方法模式优势 ===");
        System.out.println("- 代码复用: 算法骨架在父类中定义，避免重复代码");
        System.out.println("- 控制反转: 父类控制算法流程，子类实现具体步骤");
        System.out.println("- 扩展性好: 通过钩子方法提供扩展点");
        System.out.println("- 结构统一: 所有子类遵循相同的算法结构");
        System.out.println("- 符合开闭原则: 对扩展开放，对修改封闭");
    }
}
```

**模式优势**
- **代码复用**：算法骨架在父类中定义，避免重复代码
- **控制反转**：父类控制算法流程，子类实现具体步骤
- **扩展性好**：通过钩子方法提供扩展点
- **结构统一**：所有子类遵循相同的算法结构

**适用场景**
- 多个类有相似的算法结构，但具体实现步骤不同
- 需要控制子类的扩展，只允许在特定点进行扩展
- 有公共行为需要提取到父类以避免代码重复
- 需要通过钩子方法让子类决定算法中某些步骤的执行

#### 核心概念
- **模板方法**：定义算法骨架，延迟部分步骤到子类
- **算法骨架**：算法的基本结构和流程
- **步骤延迟**：将可变的步骤延迟到子类实现
- **控制反转**：父类控制算法流程，子类实现具体步骤

#### 方法类型概念
- **模板方法**：定义算法骨架的方法
- **基本方法**：实现算法步骤的方法
- **钩子方法**：提供默认行为或空实现的方法
- **抽象方法**：必须由子类实现的方法

### 11. 访问者模式 (Visitor)

**基础例子：文件系统遍历**
```java
// 文件系统元素接口
interface FileSystemElement {
    void accept(FileVisitor visitor);
}

// 文件类
class File implements FileSystemElement {
    private String name;
    private long size;
    
    public File(String name, long size) {
        this.name = name;
        this.size = size;
    }
    
    @Override
    public void accept(FileVisitor visitor) {
        visitor.visit(this);
    }
    
    public String getName() { return name; }
    public long getSize() { return size; }
}

// 目录类
class Directory implements FileSystemElement {
    private String name;
    private List<FileSystemElement> children = new ArrayList<>();
    
    public Directory(String name) {
        this.name = name;
    }
    
    public void add(FileSystemElement element) {
        children.add(element);
    }
    
    @Override
    public void accept(FileVisitor visitor) {
        visitor.visit(this);
        for (FileSystemElement child : children) {
            child.accept(visitor);
        }
    }
    
    public String getName() { return name; }
    public List<FileSystemElement> getChildren() { return children; }
}

// 访问者接口
interface FileVisitor {
    void visit(File file);
    void visit(Directory directory);
}

// 具体访问者：文件大小统计
class SizeCalculatorVisitor implements FileVisitor {
    private long totalSize = 0;
    private int fileCount = 0;
    private int dirCount = 0;
    
    @Override
    public void visit(File file) {
        totalSize += file.getSize();
        fileCount++;
        System.out.println("文件: " + file.getName() + " (" + file.getSize() + " bytes)");
    }
    
    @Override
    public void visit(Directory directory) {
        dirCount++;
        System.out.println("目录: " + directory.getName());
    }
    
    public long getTotalSize() { return totalSize; }
    public int getFileCount() { return fileCount; }
    public int getDirCount() { return dirCount; }
}

// 使用示例
public class VisitorBasicExample {
    public static void main(String[] args) {
        // 构建文件系统结构
        Directory root = new Directory("root");
        Directory docs = new Directory("documents");
        Directory pics = new Directory("pictures");
        
        root.add(docs);
        root.add(pics);
        root.add(new File("readme.txt", 1024));
        
        docs.add(new File("report.doc", 5120));
        docs.add(new File("data.xlsx", 2048));
        
        pics.add(new File("photo1.jpg", 10240));
        pics.add(new File("photo2.png", 8192));
        
        // 使用访问者统计文件信息
        SizeCalculatorVisitor sizeVisitor = new SizeCalculatorVisitor();
        root.accept(sizeVisitor);
        
        System.out.println("\n统计结果:");
        System.out.println("总大小: " + sizeVisitor.getTotalSize() + " bytes");
        System.out.println("文件数: " + sizeVisitor.getFileCount());
        System.out.println("目录数: " + sizeVisitor.getDirCount());
    }
}
```

**进阶例子：企业级报表生成系统**
```java
// 业务数据元素接口
interface BusinessElement {
    void accept(ReportVisitor visitor);
}

// 员工数据
class Employee implements BusinessElement {
    private String id;
    private String name;
    private String department;
    private double salary;
    private Date hireDate;
    
    public Employee(String id, String name, String department, double salary, Date hireDate) {
        this.id = id;
        this.name = name;
        this.department = department;
        this.salary = salary;
        this.hireDate = hireDate;
    }
    
    @Override
    public void accept(ReportVisitor visitor) {
        visitor.visit(this);
    }
    
    // getters
    public String getId() { return id; }
    public String getName() { return name; }
    public String getDepartment() { return department; }
    public double getSalary() { return salary; }
    public Date getHireDate() { return hireDate; }
}

// 部门数据
class Department implements BusinessElement {
    private String code;
    private String name;
    private String manager;
    private double budget;
    private List<Employee> employees = new ArrayList<>();
    
    public Department(String code, String name, String manager, double budget) {
        this.code = code;
        this.name = name;
        this.manager = manager;
        this.budget = budget;
    }
    
    public void addEmployee(Employee employee) {
        employees.add(employee);
    }
    
    @Override
    public void accept(ReportVisitor visitor) {
        visitor.visit(this);
        for (Employee employee : employees) {
            employee.accept(visitor);
        }
    }
    
    // getters
    public String getCode() { return code; }
    public String getName() { return name; }
    public String getManager() { return manager; }
    public double getBudget() { return budget; }
    public List<Employee> getEmployees() { return employees; }
}

// 项目数据
class Project implements BusinessElement {
    private String id;
    private String name;
    private String status;
    private double budget;
    private List<Employee> team = new ArrayList<>();
    
    public Project(String id, String name, String status, double budget) {
        this.id = id;
        this.name = name;
        this.status = status;
        this.budget = budget;
    }
    
    public void addTeamMember(Employee employee) {
        team.add(employee);
    }
    
    @Override
    public void accept(ReportVisitor visitor) {
        visitor.visit(this);
        for (Employee member : team) {
            member.accept(visitor);
        }
    }
    
    // getters
    public String getId() { return id; }
    public String getName() { return name; }
    public String getStatus() { return status; }
    public double getBudget() { return budget; }
    public List<Employee> getTeam() { return team; }
}

// 报表访问者接口
interface ReportVisitor {
    void visit(Employee employee);
    void visit(Department department);
    void visit(Project project);
    String generateReport();
}

// 具体访问者：财务报表生成器
class FinancialReportVisitor implements ReportVisitor {
    private StringBuilder report = new StringBuilder();
    private double totalSalary = 0;
    private double totalBudget = 0;
    private int employeeCount = 0;
    private Map<String, Double> departmentCosts = new HashMap<>();
    
    @Override
    public void visit(Employee employee) {
        totalSalary += employee.getSalary();
        employeeCount++;
        
        String dept = employee.getDepartment();
        departmentCosts.put(dept, 
            departmentCosts.getOrDefault(dept, 0.0) + employee.getSalary());
    }
    
    @Override
    public void visit(Department department) {
        totalBudget += department.getBudget();
        report.append("部门: ").append(department.getName())
              .append(" | 预算: $").append(String.format("%.2f", department.getBudget()))
              .append(" | 负责人: ").append(department.getManager()).append("\n");
    }
    
    @Override
    public void visit(Project project) {
        totalBudget += project.getBudget();
        report.append("项目: ").append(project.getName())
              .append(" | 预算: $").append(String.format("%.2f", project.getBudget()))
              .append(" | 状态: ").append(project.getStatus())
              .append(" | 团队规模: ").append(project.getTeam().size()).append("\n");
    }
    
    @Override
    public String generateReport() {
        StringBuilder finalReport = new StringBuilder();
        finalReport.append("=== 财务报表 ===\n");
        finalReport.append(report.toString());
        finalReport.append("\n=== 汇总信息 ===\n");
        finalReport.append("员工总数: ").append(employeeCount).append("\n");
        finalReport.append("薪资总额: $").append(String.format("%.2f", totalSalary)).append("\n");
        finalReport.append("预算总额: $").append(String.format("%.2f", totalBudget)).append("\n");
        finalReport.append("预算利用率: ").append(String.format("%.1f%%", 
            (totalSalary / totalBudget) * 100)).append("\n");
        
        finalReport.append("\n=== 部门成本分析 ===\n");
        for (Map.Entry<String, Double> entry : departmentCosts.entrySet()) {
            finalReport.append(entry.getKey()).append(": $")
                      .append(String.format("%.2f", entry.getValue())).append("\n");
        }
        
        return finalReport.toString();
    }
}

// 具体访问者：人力资源报表生成器
class HRReportVisitor implements ReportVisitor {
    private StringBuilder report = new StringBuilder();
    private Map<String, Integer> departmentHeadcount = new HashMap<>();
    private Map<String, Double> departmentAvgSalary = new HashMap<>();
    private Map<String, List<Employee>> departmentEmployees = new HashMap<>();
    
    @Override
    public void visit(Employee employee) {
        String dept = employee.getDepartment();
        departmentHeadcount.put(dept, 
            departmentHeadcount.getOrDefault(dept, 0) + 1);
        
        departmentEmployees.computeIfAbsent(dept, k -> new ArrayList<>()).add(employee);
    }
    
    @Override
    public void visit(Department department) {
        // 计算部门平均薪资
        List<Employee> employees = departmentEmployees.get(department.getName());
        if (employees != null && !employees.isEmpty()) {
            double avgSalary = employees.stream()
                .mapToDouble(Employee::getSalary)
                .average()
                .orElse(0.0);
            departmentAvgSalary.put(department.getName(), avgSalary);
        }
        
        report.append("部门: ").append(department.getName())
              .append(" | 人数: ").append(departmentHeadcount.getOrDefault(department.getName(), 0))
              .append(" | 平均薪资: $").append(String.format("%.2f", 
                  departmentAvgSalary.getOrDefault(department.getName(), 0.0)))
              .append("\n");
    }
    
    @Override
    public void visit(Project project) {
        report.append("项目: ").append(project.getName())
              .append(" | 团队规模: ").append(project.getTeam().size())
              .append(" | 状态: ").append(project.getStatus()).append("\n");
    }
    
    @Override
    public String generateReport() {
        StringBuilder finalReport = new StringBuilder();
        finalReport.append("=== 人力资源报表 ===\n");
        finalReport.append(report.toString());
        
        int totalEmployees = departmentHeadcount.values().stream()
            .mapToInt(Integer::intValue).sum();
        finalReport.append("\n=== 人力资源汇总 ===\n");
        finalReport.append("员工总数: ").append(totalEmployees).append("\n");
        finalReport.append("部门数量: ").append(departmentHeadcount.size()).append("\n");
        
        return finalReport.toString();
    }
}

// 企业数据结构
class Company {
    private List<BusinessElement> elements = new ArrayList<>();
    
    public void addElement(BusinessElement element) {
        elements.add(element);
    }
    
    public void generateReports() {
        // 生成财务报表
        FinancialReportVisitor financialVisitor = new FinancialReportVisitor();
        for (BusinessElement element : elements) {
            element.accept(financialVisitor);
        }
        System.out.println(financialVisitor.generateReport());
        
        // 生成人力资源报表
        HRReportVisitor hrVisitor = new HRReportVisitor();
        for (BusinessElement element : elements) {
            element.accept(hrVisitor);
        }
        System.out.println(hrVisitor.generateReport());
    }
}

// 使用示例
public class VisitorAdvancedExample {
    public static void main(String[] args) {
        Company company = new Company();
        
        // 创建部门
        Department itDept = new Department("IT", "技术部", "张经理", 500000);
        Department salesDept = new Department("SALES", "销售部", "李经理", 300000);
        
        // 创建员工
        Employee emp1 = new Employee("001", "王开发", "技术部", 8000, new Date());
        Employee emp2 = new Employee("002", "李测试", "技术部", 7000, new Date());
        Employee emp3 = new Employee("003", "赵销售", "销售部", 6000, new Date());
        Employee emp4 = new Employee("004", "钱客服", "销售部", 5000, new Date());
        
        itDept.addEmployee(emp1);
        itDept.addEmployee(emp2);
        salesDept.addEmployee(emp3);
        salesDept.addEmployee(emp4);
        
        // 创建项目
        Project project1 = new Project("P001", "电商平台开发", "进行中", 200000);
        project1.addTeamMember(emp1);
        project1.addTeamMember(emp2);
        
        Project project2 = new Project("P002", "客户管理系统", "已完成", 150000);
        project2.addTeamMember(emp3);
        project2.addTeamMember(emp4);
        
        // 添加到公司结构
        company.addElement(itDept);
        company.addElement(salesDept);
        company.addElement(project1);
        company.addElement(project2);
        
        // 生成报表
        company.generateReports();
    }
}
```

**访问者模式核心概念：**
- **双分派机制**：操作的执行取决于访问者类型和被访问元素类型
- **操作与数据分离**：将算法从数据结构中分离出来
- **易于扩展操作**：添加新操作只需新增访问者，无需修改元素类
- **类型安全**：编译时确定方法调用，避免类型转换错误
- **集中化处理**：相关操作集中在访问者中，便于维护和理解

#### 核心概念
- **访问者**：表示作用于对象结构中元素的操作
- **元素**：被访问的对象
- **双分派**：根据访问者和元素的类型确定执行的操作
- **操作分离**：将操作从对象结构中分离出来

#### 参与者概念
- **访问者接口**：声明访问具体元素的方法
- **具体访问者**：实现访问者接口
- **元素接口**：定义接受访问者的接口
- **具体元素**：实现元素接口
- **对象结构**：包含元素的容器

## 第五部分：高级主题概念

### 1. 模式组合概念

#### 组合原则
- **模式协作**：多个模式协同工作解决复杂问题
- **模式冲突**：不同模式之间可能存在的冲突
- **模式选择**：在多个可选模式中选择最合适的

#### 常见组合
- **工厂+单例**：确保工厂类的唯一性
- **观察者+中介者**：复杂的对象间通信
- **策略+工厂**：动态选择和创建策略
- **装饰器+组合**：灵活的对象结构扩展

### 2. 架构模式概念

#### MVC架构概念
- **模型(Model)**：数据和业务逻辑
- **视图(View)**：用户界面
- **控制器(Controller)**：处理用户输入
- **分离关注点**：将不同职责分离到不同组件

#### 分层架构概念
- **表示层**：用户界面层
- **业务层**：业务逻辑层
- **数据层**：数据访问层
- **层间依赖**：上层依赖下层，下层不依赖上层

### 3. 企业级模式概念

#### 领域驱动设计概念
- **实体(Entity)**：有唯一标识的对象
- **值对象(Value Object)**：没有唯一标识的对象
- **聚合(Aggregate)**：相关对象的集合
- **仓储(Repository)**：封装数据访问的接口
- **领域服务(Domain Service)**：不属于任何实体的业务逻辑

#### 数据访问模式概念
- **活动记录(Active Record)**：对象包含数据和行为
- **数据映射器(Data Mapper)**：分离对象和数据库
- **表数据网关(Table Data Gateway)**：封装表访问逻辑
- **行数据网关(Row Data Gateway)**：封装行访问逻辑

### 4. 并发模式概念

#### 线程安全概念
- **不可变对象**：状态不可改变的对象
- **线程特定存储**：每个线程独有的存储空间
- **双重检查锁定**：线程安全的延迟初始化

#### 异步模式概念
- **Future/Promise**：异步操作的结果占位符
- **回调模式**：异步操作完成时的回调机制
- **反应式模式**：基于数据流的异步编程模式

### 5. 分布式模式概念

#### 微服务模式概念
- **服务发现**：动态发现服务位置的机制
- **断路器**：防止级联故障的保护机制
- **舱壁隔离**：隔离不同资源避免相互影响
- **超时模式**：设置操作超时避免无限等待

#### 消息模式概念
- **发布-订阅**：消息的发布和订阅机制
- **请求-响应**：同步的消息交互模式
- **消息路由**：根据规则路由消息的机制

### 6. 函数式编程模式概念

#### 高阶函数概念
- **函数作为参数**：将函数作为参数传递
- **函数作为返回值**：函数返回另一个函数
- **函数组合**：将多个函数组合成新函数

#### Monad概念
- **Maybe/Optional**：处理可能为空的值
- **Either**：处理可能失败的操作
- **IO Monad**：处理副作用的操作

### 7. 反模式概念

#### 常见反模式
- **God Object**：承担过多职责的巨大对象
- **Spaghetti Code**：结构混乱难以维护的代码
- **Copy and Paste Programming**：通过复制粘贴编程
- **Golden Hammer**：过度使用熟悉的技术

#### 代码异味概念
- **长方法**：过长的方法
- **大类**：过大的类
- **重复代码**：相同或相似的代码片段
- **数据泥团**：总是一起出现的数据项

### 8. 实践指导概念

#### 设计决策概念
- **问题识别**：识别设计问题的能力
- **模式选择**：选择合适模式的标准
- **权衡分析**：分析不同方案的优缺点
- **重构时机**：何时进行设计重构

#### 质量属性概念
- **可维护性**：代码易于理解和修改
- **可扩展性**：系统易于扩展新功能
- **可复用性**：代码可以在不同场景复用
- **可测试性**：代码易于编写测试

#### 开发实践概念
- **渐进式设计**：逐步改进设计
- **重构到模式**：通过重构应用模式
- **测试驱动设计**：通过测试驱动设计
- **代码审查**：通过审查提高代码质量

## 总结

这份概念汇总涵盖了设计模式学习的所有重要概念，从基础理论到高级应用，从经典模式到现代实践。每个概念都是理解和应用设计模式的重要基石。

学习建议：
1. **循序渐进**：从基础概念开始，逐步深入
2. **理论实践结合**：理解概念的同时动手实践
3. **对比分析**：比较相似概念的异同
4. **场景应用**：在实际项目中应用这些概念
5. **持续学习**：设计模式是不断发展的领域